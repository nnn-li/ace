import { FUNCTION_KEYS, KEY_MODS, MODIFIER_KEYS, PRINTABLE_KEYS } from './keys';
import { isChromeOS, isIE, isMac, isOldGecko, isOldIE, isOpera } from './useragent';
export function addListener(target, type, callback, useCapture) {
    if (target.addEventListener) {
        return target.addEventListener(type, callback, false);
    }
}
export function removeListener(target, type, callback, useCapture) {
    if (target.removeEventListener) {
        return target.removeEventListener(type, callback, false);
    }
}
export function stopEvent(e) {
    stopPropagation(e);
    preventDefault(e);
    return false;
}
export function stopPropagation(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    else {
        e.cancelBubble = true;
    }
}
export function preventDefault(e) {
    var RETURN_VALUE_DEPRECATED = 'returnValue';
    if (e.preventDefault) {
        e.preventDefault();
    }
    else if (e[RETURN_VALUE_DEPRECATED]) {
        e[RETURN_VALUE_DEPRECATED] = false;
    }
}
export function getButton(e) {
    if (e.type == "dblclick")
        return 0;
    if (e.type == "contextmenu" || (isMac && (e.ctrlKey && !e.altKey && !e.shiftKey)))
        return 2;
    if (e.preventDefault) {
        return e.button;
    }
    else {
        return { 1: 0, 2: 2, 4: 1 }[e.button];
    }
}
export function capture(unused, acquireCaptureHandler, releaseCaptureHandler) {
    var element = document;
    function releaseMouse(e) {
        acquireCaptureHandler && acquireCaptureHandler(e);
        releaseCaptureHandler && releaseCaptureHandler(e);
        removeListener(element, "mousemove", acquireCaptureHandler, true);
        removeListener(element, "mouseup", releaseMouse, true);
        removeListener(element, "dragstart", releaseMouse, true);
    }
    addListener(element, "mousemove", acquireCaptureHandler, true);
    addListener(element, "mouseup", releaseMouse, true);
    addListener(element, "dragstart", releaseMouse, true);
    return releaseMouse;
}
export function addMouseWheelListener(element, callback) {
    if ("onmousewheel" in element) {
        addListener(element, "mousewheel", function (e) {
            var factor = 8;
            if (e['wheelDeltaX'] !== undefined) {
                e['wheelX'] = -e['wheelDeltaX'] / factor;
                e['wheelY'] = -e['wheelDeltaY'] / factor;
            }
            else {
                e['wheelX'] = 0;
                e['wheelY'] = -e.wheelDelta / factor;
            }
            callback(e);
        });
    }
    else if ("onwheel" in element) {
        addListener(element, "wheel", function (e) {
            var factor = 0.35;
            switch (e.deltaMode) {
                case e.DOM_DELTA_PIXEL:
                    e.wheelX = e.deltaX * factor || 0;
                    e.wheelY = e.deltaY * factor || 0;
                    break;
                case e.DOM_DELTA_LINE:
                case e.DOM_DELTA_PAGE:
                    e.wheelX = (e.deltaX || 0) * 5;
                    e.wheelY = (e.deltaY || 0) * 5;
                    break;
            }
            callback(e);
        });
    }
    else {
        addListener(element, "DOMMouseScroll", function (e) {
            if (e.axis && e.axis == e.HORIZONTAL_AXIS) {
                e.wheelX = (e.detail || 0) * 5;
                e.wheelY = 0;
            }
            else {
                e.wheelX = 0;
                e.wheelY = (e.detail || 0) * 5;
            }
            callback(e);
        });
    }
}
export function addMultiMouseDownListener(el, timeouts, eventHandler, callbackName) {
    var clicks = 0;
    var startX, startY, timer;
    var eventNames = {
        2: "dblclick",
        3: "tripleclick",
        4: "quadclick"
    };
    addListener(el, "mousedown", function (e) {
        if (getButton(e) !== 0) {
            clicks = 0;
        }
        else if (e.detail > 1) {
            clicks++;
            if (clicks > 4)
                clicks = 1;
        }
        else {
            clicks = 1;
        }
        if (isIE) {
            var isNewClick = Math.abs(e.clientX - startX) > 5 || Math.abs(e.clientY - startY) > 5;
            if (!timer || isNewClick)
                clicks = 1;
            if (timer)
                clearTimeout(timer);
            timer = setTimeout(function () { timer = null; }, timeouts[clicks - 1] || 600);
            if (clicks == 1) {
                startX = e.clientX;
                startY = e.clientY;
            }
        }
        e['_clicks'] = clicks;
        eventHandler[callbackName]("mousedown", e);
        if (clicks > 4)
            clicks = 0;
        else if (clicks > 1)
            return eventHandler[callbackName](eventNames[clicks], e);
    });
    if (isOldIE) {
        addListener(el, "dblclick", function (e) {
            clicks = 2;
            if (timer)
                clearTimeout(timer);
            timer = setTimeout(function () { timer = null; }, timeouts[clicks - 1] || 600);
            eventHandler[callbackName]("mousedown", e);
            eventHandler[callbackName](eventNames[clicks], e);
        });
    }
}
var getModifierHash = isMac && isOpera && !("KeyboardEvent" in window)
    ? function (e) {
        return 0 | (e.metaKey ? 1 : 0) | (e.altKey ? 2 : 0) | (e.shiftKey ? 4 : 0) | (e.ctrlKey ? 8 : 0);
    }
    : function (e) {
        return 0 | (e.ctrlKey ? 1 : 0) | (e.altKey ? 2 : 0) | (e.shiftKey ? 4 : 0) | (e.metaKey ? 8 : 0);
    };
export function getModifierString(e) {
    return KEY_MODS[getModifierHash(e)];
}
function normalizeCommandKeys(callback, e, keyCode) {
    var hashId = getModifierHash(e);
    if (!isMac && pressedKeys) {
        if (pressedKeys[91] || pressedKeys[92])
            hashId |= 8;
        if (pressedKeys.altGr) {
            if ((3 & hashId) != 3)
                pressedKeys.altGr = 0;
            else
                return;
        }
        if (keyCode === 18 || keyCode === 17) {
            if (keyCode === 17 && e.location === 1) {
                ts = e.timeStamp;
            }
            else if (keyCode === 18 && hashId === 3 && e.location === 2) {
                var dt = -ts;
                ts = e.timeStamp;
                dt += ts;
                if (dt < 3)
                    pressedKeys.altGr = true;
            }
        }
    }
    if (keyCode in MODIFIER_KEYS) {
        switch (MODIFIER_KEYS[keyCode]) {
            case "Alt":
                hashId = 2;
                break;
            case "Shift":
                hashId = 4;
                break;
            case "Ctrl":
                hashId = 1;
                break;
            default:
                hashId = 8;
                break;
        }
        keyCode = -1;
    }
    if (hashId & 8 && (keyCode === 91 || keyCode === 93)) {
        keyCode = -1;
    }
    if (!hashId && keyCode === 13) {
        if (e.location === 3) {
            callback(e, hashId, -keyCode);
            if (e.defaultPrevented)
                return;
        }
    }
    if (isChromeOS && hashId & 8) {
        callback(e, hashId, keyCode);
        if (e.defaultPrevented)
            return;
        else
            hashId &= ~8;
    }
    if (!hashId && !(keyCode in FUNCTION_KEYS) && !(keyCode in PRINTABLE_KEYS)) {
        return false;
    }
    return callback(e, hashId, keyCode);
}
var pressedKeys = null;
function resetPressedKeys(e) {
    pressedKeys = Object.create(null);
}
var ts = 0;
export function addCommandKeyListener(el, callback) {
    if (isOldGecko || (isOpera && !("KeyboardEvent" in window))) {
        var lastKeyDownKeyCode = null;
        addListener(el, "keydown", function (e) {
            lastKeyDownKeyCode = e.keyCode;
        });
        addListener(el, "keypress", function (e) {
            return normalizeCommandKeys(callback, e, lastKeyDownKeyCode);
        });
    }
    else {
        var lastDefaultPrevented = null;
        addListener(el, "keydown", function (e) {
            pressedKeys[e.keyCode] = true;
            var result = normalizeCommandKeys(callback, e, e.keyCode);
            lastDefaultPrevented = e.defaultPrevented;
            return result;
        });
        addListener(el, 'keypress', function (e) {
            if (lastDefaultPrevented && (e.ctrlKey || e.altKey || e.shiftKey || e.metaKey)) {
                stopEvent(e);
                lastDefaultPrevented = null;
            }
        });
        addListener(el, 'keyup', function (e) {
            pressedKeys[e.keyCode] = null;
        });
        if (!pressedKeys) {
            pressedKeys = Object.create(null);
            addListener(window, 'focus', resetPressedKeys);
        }
    }
}
var nextFrameCandidate = window.requestAnimationFrame ||
    window['mozRequestAnimationFrame'] ||
    window['webkitRequestAnimationFrame'] ||
    window.msRequestAnimationFrame ||
    window['oRequestAnimationFrame'];
if (nextFrameCandidate) {
    nextFrameCandidate = nextFrameCandidate.bind(window);
}
else {
    nextFrameCandidate = function (callback) {
        setTimeout(callback, 17);
    };
}
export var requestAnimationFrame = nextFrameCandidate;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJldmVudC50cyJdLCJuYW1lcyI6WyJhZGRMaXN0ZW5lciIsInJlbW92ZUxpc3RlbmVyIiwic3RvcEV2ZW50Iiwic3RvcFByb3BhZ2F0aW9uIiwicHJldmVudERlZmF1bHQiLCJnZXRCdXR0b24iLCJjYXB0dXJlIiwiY2FwdHVyZS5yZWxlYXNlTW91c2UiLCJhZGRNb3VzZVdoZWVsTGlzdGVuZXIiLCJhZGRNdWx0aU1vdXNlRG93bkxpc3RlbmVyIiwiZ2V0TW9kaWZpZXJTdHJpbmciLCJub3JtYWxpemVDb21tYW5kS2V5cyIsInJlc2V0UHJlc3NlZEtleXMiLCJhZGRDb21tYW5kS2V5TGlzdGVuZXIiXSwibWFwcGluZ3MiOiJPQTZCTyxFQUFFLGFBQWEsRUFBRSxRQUFRLEVBQUUsYUFBYSxFQUFFLGNBQWMsRUFBRSxNQUFNLFFBQVE7T0FDeEUsRUFBRSxVQUFVLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLE9BQU8sRUFBRSxNQUFNLGFBQWE7QUFLbkYsNEJBQTRCLE1BQXNCLEVBQUUsSUFBWSxFQUFFLFFBQVEsRUFBRSxVQUFvQjtJQUM1RkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUMxQkEsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxJQUFJQSxFQUFFQSxRQUFRQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQTtJQUMxREEsQ0FBQ0E7QUFDTEEsQ0FBQ0E7QUFFRCwrQkFBK0IsTUFBc0IsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLFVBQW9CO0lBQ3ZGQyxFQUFFQSxDQUFDQSxDQUFDQSxNQUFNQSxDQUFDQSxtQkFBbUJBLENBQUNBLENBQUNBLENBQUNBO1FBQzdCQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQSxtQkFBbUJBLENBQUNBLElBQUlBLEVBQUVBLFFBQVFBLEVBQUVB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Q0FBQ0E7Z0JBQ3JDQSxFQUFFQSxHQUFHQSxDQUFDQSxDQUFDQSxTQUFTQSxDQUFDQTtZQUNyQkEsQ0FBQ0E7WUFBQ0EsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsT0FBT0EsS0FBS0EsRUFBRUEsSUFBSUEsTUFBTUEsS0FBS0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsUUFBUUEsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQzVEQSxJQUFJQSxFQUFFQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQTtnQkFDYkEsRUFBRUEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsU0FBU0EsQ0FBQ0E7Z0JBQ2pCQSxFQUFFQSxJQUFJQSxFQUFFQSxDQUFDQTtnQkFDVEEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsRUFBRUEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7b0JBQ1BBLFdBQVdBLENBQUNBLEtBQUtBLEdBQUdBLElBQUlBLENBQUNBO1lBQ2pDQSxDQUFDQTtRQUNMQSxDQUFDQTtJQUNMQSxDQUFDQTtJQUVEQSxFQUFFQSxDQUFDQSxDQUFDQSxPQUFPQSxJQUFJQSxhQUFhQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUMzQkEsTUFBTUEsQ0FBQ0EsQ0FBQ0EsYUFBYUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDN0JBLEtBQUtBLEtBQUtBO2dCQUNOQSxNQUFNQSxHQUFHQSxDQUFDQSxDQUFDQTtnQkFDWEEsS0FBS0EsQ0FBQ0E7WUFDVkEsS0FBS0EsT0FBT0E7Z0JBQ1JBLE1BQU1BLEdBQUdBLENBQUNBLENBQUNBO2dCQUNYQSxLQUFLQSxDQUFDQTtZQUNWQSxLQUFLQSxNQUFNQTtnQkFDUEEsTUFBTUEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ1hBLEtBQUtBLENBQUNBO1lBQ1ZBO2dCQUNJQSxNQUFNQSxHQUFHQSxDQUFDQSxDQUFDQTtnQkFDWEEsS0FBS0EsQ0FBQ0E7UUFDZEEsQ0FBQ0E7UUFDREEsT0FBT0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7SUFDakJBLENBQUNBO0lBRURBLEVB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TSxDQUFDLHdCQUF3QixDQUFDLENBQUM7QUFFckMsRUFBRSxDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDO0lBQ3JCLGtCQUFrQixHQUFHLGtCQUFrQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUN6RCxDQUFDO0FBQ0QsSUFBSSxDQUFDLENBQUM7SUFDRixrQkFBa0IsR0FBRyxVQUFTLFFBQVE7UUFDbEMsVUFBVSxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUM3QixDQUFDLENBQUM7QUFDTixDQUFDO0FBS0QsV0FBVyxxQkFBcUIsR0FBb0Qsa0JBQWtCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiAqKioqKiBCRUdJTiBMSUNFTlNFIEJMT0NLICoqKioqXG4gKiBEaXN0cmlidXRlZCB1bmRlciB0aGUgQlNEIGxpY2Vuc2U6XG4gKlxuICogQ29weXJpZ2h0IChjKSAyMDEwLCBBamF4Lm9yZyBCLlYuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dFxuICogbW9kaWZpY2F0aW9uLCBhcmUgcGVybWl0dGVkIHByb3ZpZGVkIHRoYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zIGFyZSBtZXQ6XG4gKiAgICAgKiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodFxuICogICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLlxuICogICAgICogUmVkaXN0cmlidXRpb25zIGluIGJpbmFyeSBmb3JtIG11c3QgcmVwcm9kdWNlIHRoZSBhYm92ZSBjb3B5cmlnaHRcbiAqICAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGVcbiAqICAgICAgIGRvY3VtZW50YXRpb24gYW5kL29yIG90aGVyIG1hdGVyaWFscyBwcm92aWRlZCB3aXRoIHRoZSBkaXN0cmlidXRpb24uXG4gKiAgICAgKiBOZWl0aGVyIHRoZSBuYW1lIG9mIEFqYXgub3JnIEIuVi4gbm9yIHRoZVxuICogICAgICAgbmFtZXMgb2YgaXRzIGNvbnRyaWJ1dG9ycyBtYXkgYmUgdXNlZCB0byBlbmRvcnNlIG9yIHByb21vdGUgcHJvZHVjdHNcbiAqICAgICAgIGRlcml2ZWQgZnJvbSB0aGlzIHNvZnR3YXJlIHdpdGhvdXQgc3BlY2lmaWMgcHJpb3Igd3JpdHRlbiBwZXJtaXNzaW9uLlxuICpcbiAqIFRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgVEhFIENPUFlSSUdIVCBIT0xERVJTIEFORCBDT05UUklCVVRPUlMgXCJBUyBJU1wiIEFORFxuICogQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhFIElNUExJRURcbiAqIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkVcbiAqIERJU0NMQUlNRUQuIElOIE5PIEVWRU5UIFNIQUxMIEFKQVguT1JHIEIuVi4gQkUgTElBQkxFIEZPUiBBTllcbiAqIERJUkVDVCwgSU5ESVJFQ1QsIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTXG4gKiAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVM7XG4gKiBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVTSU5FU1MgSU5URVJSVVBUSU9OKSBIT1dFVkVSIENBVVNFRCBBTkRcbiAqIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QgTElBQklMSVRZLCBPUiBUT1JUXG4gKiAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRSBVU0UgT0YgVEhJU1xuICogU09GVFdBUkUsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuXG4gKlxuICogKioqKiogRU5EIExJQ0VOU0UgQkxPQ0sgKioqKiogKi9cbmltcG9ydCB7IEZVTkNUSU9OX0tFWVMsIEtFWV9NT0RTLCBNT0RJRklFUl9LRVlTLCBQUklOVEFCTEVfS0VZUyB9IGZyb20gJy4va2V5cyc7XG5pbXBvcnQgeyBpc0Nocm9tZU9TLCBpc0lFLCBpc01hYywgaXNPbGRHZWNrbywgaXNPbGRJRSwgaXNPcGVyYSB9IGZyb20gJy4vdXNlcmFnZW50JztcblxuZXhwb3J0IGludGVyZmFjZSBMaXN0ZW5lclRhcmdldCBleHRlbmRzIEV2ZW50VGFyZ2V0IHtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFkZExpc3RlbmVyKHRhcmdldDogTGlzdGVuZXJUYXJnZXQsIHR5cGU6IHN0cmluZywgY2FsbGJhY2ssIHVzZUNhcHR1cmU/OiBib29sZWFuKSB7XG4gICAgaWYgKHRhcmdldC5hZGRFdmVudExpc3RlbmVyKSB7XG4gICAgICAgIHJldHVybiB0YXJnZXQuYWRkRXZlbnRMaXN0ZW5lcih0eXBlLCBjYWxsYmFjaywgZmFsc2UpO1xuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlbW92ZUxpc3RlbmVyKHRhcmdldDogTGlzdGVuZXJUYXJnZXQsIHR5cGUsIGNhbGxiYWNrLCB1c2VDYXB0dXJlPzogYm9vbGVhbikge1xuICAgIGlmICh0YXJnZXQucmVtb3ZlRXZlbnRMaXN0ZW5lcikge1xuICAgICAgICByZXR1cm4gdGFyZ2V0LnJlbW92ZUV2ZW50TGlzdGVuZXIodHlwZSwgY2FsbGJhY2ssIGZhbHNlKTtcbiAgICB9XG59XG5cbi8qXG4qIFByZXZlbnRzIHByb3BhZ2F0aW9uIGFuZCBjbG9iYmVycyB0aGUgZGVmYXVsdCBhY3Rpb24gb2YgdGhlIHBhc3NlZCBldmVudFxuKi9cbmV4cG9ydCBmdW5jdGlvbiBzdG9wRXZlbnQoZTogRXZlbnQpOiBib29sZWFuIHtcbiAgICBzdG9wUHJvcGFnYXRpb24oZSk7XG4gICAgcHJldmVudERlZmF1bHQoZSk7XG4gICAgcmV0dXJuIGZhbHNlO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc3RvcFByb3BhZ2F0aW9uKGU6IEV2ZW50KTogdm9pZCB7XG4gICAgaWYgKGUuc3RvcFByb3BhZ2F0aW9uKSB7XG4gICAgICAgIGUuc3RvcFByb3BhZ2F0aW9uKCk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICBlLmNhbmNlbEJ1YmJsZSA9IHRydWU7XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJldmVudERlZmF1bHQoZTogRXZlbnQpOiB2b2lkIHtcbiAgICAvLyByZXR1cm5WYWx1ZSBpcyBubyBsb25nZXIgZG9jdW1lbnRlZCBpbiB0eXBpbmdzLlxuICAgIHZhciBSRVRVUk5fVkFMVUVfREVQUkVDQVRFRCA9ICdyZXR1cm5WYWx1ZSc7XG4gICAgaWYgKGUucHJldmVudERlZmF1bHQpIHtcbiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIH1cbiAgICBlbHNlIGlmIChlW1JFVFVSTl9WQUxVRV9ERVBSRUNBVEVEXSkge1xuICAgICAgICBlW1JFVFVSTl9WQUxVRV9ERVBSRUNBVEVEXSA9IGZhbHNlO1xuICAgIH1cbn1cblxuLypcbiAqIEByZXR1cm4ge051bWJlcn0gMCBmb3IgbGVmdCBidXR0b24sIDEgZm9yIG1pZGRsZSBidXR0b24sIDIgZm9yIHJpZ2h0IGJ1dHRvblxuICovXG5leHBvcnQgZnVuY3Rpb24gZ2V0QnV0dG9uKGU6IE1vdXNlRXZlbnQpOiBudW1iZXIge1xuICAgIGlmIChlLnR5cGUgPT0gXCJkYmxjbGlja1wiKVxuICAgICAgICByZXR1cm4gMDtcbiAgICBpZiAoZS50eXBlID09IFwiY29udGV4dG1lbnVcIiB8fCAoaXNNYWMgJiYgKGUuY3RybEtleSAmJiAhZS5hbHRLZXkgJiYgIWUuc2hpZnRLZXkpKSlcbiAgICAgICAgcmV0dXJuIDI7XG5cbiAgICAvLyBET00gRXZlbnRcbiAgICBpZiAoZS5wcmV2ZW50RGVmYXVsdCkge1xuICAgICAgICByZXR1cm4gZS5idXR0b247XG4gICAgfVxuICAgIC8vIG9sZCBJRVxuICAgIGVsc2Uge1xuICAgICAgICByZXR1cm4geyAxOiAwLCAyOiAyLCA0OiAxIH1bZS5idXR0b25dO1xuICAgIH1cbn1cblxuLy8gRklYTUU6IFdlIHNob3VsZCBub3QgYmUgYXNzdW1pbmcgdGhlIGRvY3VtZW50IGFzIHdpbmRvdy5kb2N1bWVudCFcbi8qKlxuICogUmV0dXJucyBhIGZ1bmN0aW9uIHdoaWNoIG1heSBiZSB1c2VkIHRvIG1hbnVhbGx5IHJlbGVhc2UgdGhlIG1vdXNlLlxuICovXG5leHBvcnQgZnVuY3Rpb24gY2FwdHVyZSh1bnVzZWQ6IEhUTUxFbGVtZW50LCBhY3F1aXJlQ2FwdHVyZUhhbmRsZXI6IChldmVudDogTW91c2VFdmVudCkgPT4gdm9pZCwgcmVsZWFzZUNhcHR1cmVIYW5kbGVyOiAoZXZlbnQ6IE1vdXNlRXZlbnQpID0+IHZvaWQpOiAoZXZlbnQ6IE1vdXNlRXZlbnQpID0+IHZvaWQge1xuICAgIC8vIEZJWE1FOiAnRG9jdW1lbnQnIGlzIG1pc3NpbmcgcHJvcGVydHkgJ29ubW91c2VsZWF2ZScgZnJvbSAnSFRNTEVsZW1lbnQnLlxuICAgIHZhciBlbGVtZW50OiBhbnkgPSBkb2N1bWVudDtcblxuICAgIGZ1bmN0aW9uIHJlbGVhc2VNb3VzZShlOiBNb3VzZUV2ZW50KSB7XG5cbiAgICAgICAgLy8gSXQgc2VlbXMgcmVkdW5kYW50IGFuZCBjdW1iZXJzb21lIHRvIHByb3ZpZGUgdGhpcyBldmVudCB0byBib3RoIGhhbmRsZXJzP1xuICAgICAgICBhY3F1aXJlQ2FwdHVyZUhhbmRsZXIgJiYgYWNxdWlyZUNhcHR1cmVIYW5kbGVyKGUpO1xuXG4gICAgICAgIHJlbGVhc2VDYXB0dXJlSGFuZGxlciAmJiByZWxlYXNlQ2FwdHVyZUhhbmRsZXIoZSk7XG5cbiAgICAgICAgcmVtb3ZlTGlzdGVuZXIoZWxlbWVudCwgXCJtb3VzZW1vdmVcIiwgYWNxdWlyZUNhcHR1cmVIYW5kbGVyLCB0cnVlKTtcbiAgICAgICAgcmVtb3ZlTGlzdGVuZXIoZWxlbWVudCwgXCJtb3VzZXVwXCIsIHJlbGVhc2VNb3VzZSwgdHJ1ZSk7XG4gICAgICAgIHJlbW92ZUxpc3RlbmVyKGVsZW1lbnQsIFwiZHJhZ3N0YXJ0XCIsIHJlbGVhc2VNb3VzZSwgdHJ1ZSk7XG4gICAgfVxuXG4gICAgYWRkTGlzdGVuZXIoZWxlbWVudCwgXCJtb3VzZW1vdmVcIiwgYWNxdWlyZUNhcHR1cmVIYW5kbGVyLCB0cnVlKTtcbiAgICBhZGRMaXN0ZW5lcihlbGVtZW50LCBcIm1vdXNldXBcIiwgcmVsZWFzZU1vdXNlLCB0cnVlKTtcbiAgICBhZGRMaXN0ZW5lcihlbGVtZW50LCBcImRyYWdzdGFydFwiLCByZWxlYXNlTW91c2UsIHRydWUpO1xuXG4gICAgcmV0dXJuIHJlbGVhc2VNb3VzZTtcbn1cblxuLyoqXG4gKiBBZGRzIGEgcG9ydGFibGUgJ21vdXNld2hlZWwnIFsnd2hlZWwnLCdET00gTW91c2VTY3JvbGwnXSBsaXN0ZW5lciB0byBhbiBlbGVtZW50LlxuICovXG5leHBvcnQgZnVuY3Rpb24gYWRkTW91c2VXaGVlbExpc3RlbmVyKGVsZW1lbnQ6IEhUTUxFbGVtZW50LCBjYWxsYmFjazogKGV2ZW50OiBNb3VzZVdoZWVsRXZlbnQpID0+IHZvaWQpOiB2b2lkIHtcbiAgICBpZiAoXCJvbm1vdXNld2hlZWxcIiBpbiBlbGVtZW50KSB7XG4gICAgICAgIGFkZExpc3RlbmVyKGVsZW1lbnQsIFwibW91c2V3aGVlbFwiLCBmdW5jdGlvbihlOiBNb3VzZVdoZWVsRXZlbnQpIHtcbiAgICAgICAgICAgIHZhciBmYWN0b3IgPSA4O1xuICAgICAgICAgICAgaWYgKGVbJ3doZWVsRGVsdGFYJ10gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIGVbJ3doZWVsWCddID0gLWVbJ3doZWVsRGVsdGFYJ10gLyBmYWN0b3I7XG4gICAgICAgICAgICAgICAgZVsnd2hlZWxZJ10gPSAtZVsnd2hlZWxEZWx0YVknXSAvIGZhY3RvcjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGVbJ3doZWVsWCddID0gMDtcbiAgICAgICAgICAgICAgICBlWyd3aGVlbFknXSA9IC1lLndoZWVsRGVsdGEgLyBmYWN0b3I7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYWxsYmFjayhlKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKFwib253aGVlbFwiIGluIGVsZW1lbnQpIHtcbiAgICAgICAgYWRkTGlzdGVuZXIoZWxlbWVudCwgXCJ3aGVlbFwiLCBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICB2YXIgZmFjdG9yID0gMC4zNTtcbiAgICAgICAgICAgIHN3aXRjaCAoZS5kZWx0YU1vZGUpIHtcbiAgICAgICAgICAgICAgICBjYXNlIGUuRE9NX0RFTFRBX1BJWEVMOlxuICAgICAgICAgICAgICAgICAgICBlLndoZWVsWCA9IGUuZGVsdGFYICogZmFjdG9yIHx8IDA7XG4gICAgICAgICAgICAgICAgICAgIGUud2hlZWxZID0gZS5kZWx0YVkgKiBmYWN0b3IgfHwgMDtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSBlLkRPTV9ERUxUQV9MSU5FOlxuICAgICAgICAgICAgICAgIGNhc2UgZS5ET01fREVMVEFfUEFHRTpcbiAgICAgICAgICAgICAgICAgICAgZS53aGVlbFggPSAoZS5kZWx0YVggfHwgMCkgKiA1O1xuICAgICAgICAgICAgICAgICAgICBlLndoZWVsWSA9IChlLmRlbHRhWSB8fCAwKSAqIDU7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2FsbGJhY2soZSk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgLy8gVE9ETzogRGVmaW5lIGludGVyZmFjZSBmb3IgRE9NTW91c2VTY3JvbGwuXG4gICAgICAgIGFkZExpc3RlbmVyKGVsZW1lbnQsIFwiRE9NTW91c2VTY3JvbGxcIiwgZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgaWYgKGUuYXhpcyAmJiBlLmF4aXMgPT0gZS5IT1JJWk9OVEFMX0FYSVMpIHtcbiAgICAgICAgICAgICAgICBlLndoZWVsWCA9IChlLmRldGFpbCB8fCAwKSAqIDU7XG4gICAgICAgICAgICAgICAgZS53aGVlbFkgPSAwO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgZS53aGVlbFggPSAwO1xuICAgICAgICAgICAgICAgIGUud2hlZWxZID0gKGUuZGV0YWlsIHx8IDApICogNTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhbGxiYWNrKGUpO1xuICAgICAgICB9KTtcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhZGRNdWx0aU1vdXNlRG93bkxpc3RlbmVyKGVsLCB0aW1lb3V0cywgZXZlbnRIYW5kbGVyLCBjYWxsYmFja05hbWUpIHtcbiAgICB2YXIgY2xpY2tzID0gMDtcbiAgICB2YXIgc3RhcnRYLCBzdGFydFksIHRpbWVyO1xuICAgIHZhciBldmVudE5hbWVzID0ge1xuICAgICAgICAyOiBcImRibGNsaWNrXCIsXG4gICAgICAgIDM6IFwidHJpcGxlY2xpY2tcIixcbiAgICAgICAgNDogXCJxdWFkY2xpY2tcIlxuICAgIH07XG5cbiAgICBhZGRMaXN0ZW5lcihlbCwgXCJtb3VzZWRvd25cIiwgZnVuY3Rpb24oZTogTW91c2VFdmVudCkge1xuICAgICAgICBpZiAoZ2V0QnV0dG9uKGUpICE9PSAwKSB7XG4gICAgICAgICAgICBjbGlja3MgPSAwO1xuICAgICAgICB9IGVsc2UgaWYgKGUuZGV0YWlsID4gMSkge1xuICAgICAgICAgICAgY2xpY2tzKys7XG4gICAgICAgICAgICBpZiAoY2xpY2tzID4gNClcbiAgICAgICAgICAgICAgICBjbGlja3MgPSAxO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY2xpY2tzID0gMTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoaXNJRSkge1xuICAgICAgICAgICAgdmFyIGlzTmV3Q2xpY2sgPSBNYXRoLmFicyhlLmNsaWVudFggLSBzdGFydFgpID4gNSB8fCBNYXRoLmFicyhlLmNsaWVudFkgLSBzdGFydFkpID4gNTtcbiAgICAgICAgICAgIGlmICghdGltZXIgfHwgaXNOZXdDbGljaylcbiAgICAgICAgICAgICAgICBjbGlja3MgPSAxO1xuICAgICAgICAgICAgaWYgKHRpbWVyKVxuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XG4gICAgICAgICAgICB0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IHRpbWVyID0gbnVsbCB9LCB0aW1lb3V0c1tjbGlja3MgLSAxXSB8fCA2MDApO1xuXG4gICAgICAgICAgICBpZiAoY2xpY2tzID09IDEpIHtcbiAgICAgICAgICAgICAgICBzdGFydFggPSBlLmNsaWVudFg7XG4gICAgICAgICAgICAgICAgc3RhcnRZID0gZS5jbGllbnRZO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gVE9ETy4gVGhpcyBjdXN0b20gcHJvcGVydHkgaXMgbm90IHBhcnQgb2YgTW91c2VFdmVudC5cbiAgICAgICAgZVsnX2NsaWNrcyddID0gY2xpY2tzO1xuXG4gICAgICAgIGV2ZW50SGFuZGxlcltjYWxsYmFja05hbWVdKFwibW91c2Vkb3duXCIsIGUpO1xuXG4gICAgICAgIGlmIChjbGlja3MgPiA0KVxuICAgICAgICAgICAgY2xpY2tzID0gMDtcbiAgICAgICAgZWxzZSBpZiAoY2xpY2tzID4gMSlcbiAgICAgICAgICAgIHJldHVybiBldmVudEhhbmRsZXJbY2FsbGJhY2tOYW1lXShldmVudE5hbWVzW2NsaWNrc10sIGUpO1xuICAgIH0pO1xuXG4gICAgaWYgKGlzT2xkSUUpIHtcbiAgICAgICAgYWRkTGlzdGVuZXIoZWwsIFwiZGJsY2xpY2tcIiwgZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgY2xpY2tzID0gMjtcbiAgICAgICAgICAgIGlmICh0aW1lcilcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xuICAgICAgICAgICAgdGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyB0aW1lciA9IG51bGwgfSwgdGltZW91dHNbY2xpY2tzIC0gMV0gfHwgNjAwKTtcbiAgICAgICAgICAgIGV2ZW50SGFuZGxlcltjYWxsYmFja05hbWVdKFwibW91c2Vkb3duXCIsIGUpO1xuICAgICAgICAgICAgZXZlbnRIYW5kbGVyW2NhbGxiYWNrTmFtZV0oZXZlbnROYW1lc1tjbGlja3NdLCBlKTtcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG52YXIgZ2V0TW9kaWZpZXJIYXNoID0gaXNNYWMgJiYgaXNPcGVyYSAmJiAhKFwiS2V5Ym9hcmRFdmVudFwiIGluIHdpbmRvdylcbiAgICA/IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgcmV0dXJuIDAgfCAoZS5tZXRhS2V5ID8gMSA6IDApIHwgKGUuYWx0S2V5ID8gMiA6IDApIHwgKGUuc2hpZnRLZXkgPyA0IDogMCkgfCAoZS5jdHJsS2V5ID8gOCA6IDApO1xuICAgIH1cbiAgICA6IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgcmV0dXJuIDAgfCAoZS5jdHJsS2V5ID8gMSA6IDApIHwgKGUuYWx0S2V5ID8gMiA6IDApIHwgKGUuc2hpZnRLZXkgPyA0IDogMCkgfCAoZS5tZXRhS2V5ID8gOCA6IDApO1xuICAgIH07XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRNb2RpZmllclN0cmluZyhlKSB7XG4gICAgcmV0dXJuIEtFWV9NT0RTW2dldE1vZGlmaWVySGFzaChlKV07XG59XG5cbmZ1bmN0aW9uIG5vcm1hbGl6ZUNvbW1hbmRLZXlzKGNhbGxiYWNrLCBlOiBLZXlib2FyZEV2ZW50LCBrZXlDb2RlOiBudW1iZXIpIHtcbiAgICB2YXIgaGFzaElkID0gZ2V0TW9kaWZpZXJIYXNoKGUpO1xuXG4gICAgaWYgKCFpc01hYyAmJiBwcmVzc2VkS2V5cykge1xuICAgICAgICBpZiAocHJlc3NlZEtleXNbOTFdIHx8IHByZXNzZWRLZXlzWzkyXSlcbiAgICAgICAgICAgIGhhc2hJZCB8PSA4O1xuICAgICAgICBpZiAocHJlc3NlZEtleXMuYWx0R3IpIHtcbiAgICAgICAgICAgIGlmICgoMyAmIGhhc2hJZCkgIT0gMylcbiAgICAgICAgICAgICAgICBwcmVzc2VkS2V5cy5hbHRHciA9IDA7XG4gICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChrZXlDb2RlID09PSAxOCB8fCBrZXlDb2RlID09PSAxNykge1xuICAgICAgICAgICAgaWYgKGtleUNvZGUgPT09IDE3ICYmIGUubG9jYXRpb24gPT09IDEpIHtcbiAgICAgICAgICAgICAgICB0cyA9IGUudGltZVN0YW1wO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChrZXlDb2RlID09PSAxOCAmJiBoYXNoSWQgPT09IDMgJiYgZS5sb2NhdGlvbiA9PT0gMikge1xuICAgICAgICAgICAgICAgIHZhciBkdCA9IC10cztcbiAgICAgICAgICAgICAgICB0cyA9IGUudGltZVN0YW1wO1xuICAgICAgICAgICAgICAgIGR0ICs9IHRzO1xuICAgICAgICAgICAgICAgIGlmIChkdCA8IDMpXG4gICAgICAgICAgICAgICAgICAgIHByZXNzZWRLZXlzLmFsdEdyID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1cblxuICAgIGlmIChrZXlDb2RlIGluIE1PRElGSUVSX0tFWVMpIHtcbiAgICAgICAgc3dpdGNoIChNT0RJRklFUl9LRVlTW2tleUNvZGVdKSB7XG4gICAgICAgICAgICBjYXNlIFwiQWx0XCI6XG4gICAgICAgICAgICAgICAgaGFzaElkID0gMjtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgXCJTaGlmdFwiOlxuICAgICAgICAgICAgICAgIGhhc2hJZCA9IDQ7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFwiQ3RybFwiOlxuICAgICAgICAgICAgICAgIGhhc2hJZCA9IDE7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICAgIGhhc2hJZCA9IDg7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAga2V5Q29kZSA9IC0xO1xuICAgIH1cblxuICAgIGlmIChoYXNoSWQgJiA4ICYmIChrZXlDb2RlID09PSA5MSB8fCBrZXlDb2RlID09PSA5MykpIHtcbiAgICAgICAga2V5Q29kZSA9IC0xO1xuICAgIH1cblxuICAgIGlmICghaGFzaElkICYmIGtleUNvZGUgPT09IDEzKSB7XG4gICAgICAgIGlmIChlLmxvY2F0aW9uID09PSAzKSB7XG4gICAgICAgICAgICBjYWxsYmFjayhlLCBoYXNoSWQsIC1rZXlDb2RlKTtcbiAgICAgICAgICAgIGlmIChlLmRlZmF1bHRQcmV2ZW50ZWQpXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGlzQ2hyb21lT1MgJiYgaGFzaElkICYgOCkge1xuICAgICAgICBjYWxsYmFjayhlLCBoYXNoSWQsIGtleUNvZGUpO1xuICAgICAgICBpZiAoZS5kZWZhdWx0UHJldmVudGVkKVxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICBlbHNlXG4gICAgICAgICAgICBoYXNoSWQgJj0gfjg7XG4gICAgfVxuXG4gICAgLy8gSWYgdGhlcmUgaXMgbm8gaGFzaElkIGFuZCB0aGUga2V5Q29kZSBpcyBub3QgYSBmdW5jdGlvbiBrZXksIHRoZW5cbiAgICAvLyB3ZSBkb24ndCBjYWxsIHRoZSBjYWxsYmFjayBhcyB3ZSBkb24ndCBoYW5kbGUgYSBjb21tYW5kIGtleSBoZXJlXG4gICAgLy8gKGl0J3MgYSBub3JtYWwga2V5L2NoYXJhY3RlciBpbnB1dCkuXG4gICAgaWYgKCFoYXNoSWQgJiYgIShrZXlDb2RlIGluIEZVTkNUSU9OX0tFWVMpICYmICEoa2V5Q29kZSBpbiBQUklOVEFCTEVfS0VZUykpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIHJldHVybiBjYWxsYmFjayhlLCBoYXNoSWQsIGtleUNvZGUpO1xufVxuXG52YXIgcHJlc3NlZEtleXMgPSBudWxsO1xuXG5mdW5jdGlvbiByZXNldFByZXNzZWRLZXlzKGUpIHtcbiAgICBwcmVzc2VkS2V5cyA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG59XG5cbnZhciB0cyA9IDA7XG5leHBvcnQgZnVuY3Rpb24gYWRkQ29tbWFuZEtleUxpc3RlbmVyKGVsLCBjYWxsYmFjaykge1xuICAgIGlmIChpc09sZEdlY2tvIHx8IChpc09wZXJhICYmICEoXCJLZXlib2FyZEV2ZW50XCIgaW4gd2luZG93KSkpIHtcbiAgICAgICAgLy8gT2xkIHZlcnNpb25zIG9mIEdlY2tvIGFrYS4gRmlyZWZveCA8IDQuMCBkaWRuJ3QgcmVwZWF0IHRoZSBrZXlkb3duXG4gICAgICAgIC8vIGV2ZW50IGlmIHRoZSB1c2VyIHByZXNzZWQgdGhlIGtleSBmb3IgYSBsb25nZXIgdGltZS4gSW5zdGVhZCwgdGhlXG4gICAgICAgIC8vIGtleWRvd24gZXZlbnQgd2FzIGZpcmVkIG9uY2UgYW5kIGxhdGVyIG9uIG9ubHkgdGhlIGtleXByZXNzIGV2ZW50LlxuICAgICAgICAvLyBUbyBlbXVsYXRlIHRoZSAncmlnaHQnIGtleWRvd24gYmVoYXZpb3IsIHRoZSBrZXlDb2RlIG9mIHRoZSBpbml0aWFsXG4gICAgICAgIC8vIGtleURvd24gZXZlbnQgaXMgc3RvcmVkIGFuZCBpbiB0aGUgZm9sbG93aW5nIGtleXByZXNzIGV2ZW50cyB0aGVcbiAgICAgICAgLy8gc3RvcmVzIGtleUNvZGUgaXMgdXNlZCB0byBlbXVsYXRlIGEga2V5RG93biBldmVudC5cbiAgICAgICAgdmFyIGxhc3RLZXlEb3duS2V5Q29kZSA9IG51bGw7XG4gICAgICAgIGFkZExpc3RlbmVyKGVsLCBcImtleWRvd25cIiwgZnVuY3Rpb24oZTogS2V5Ym9hcmRFdmVudCkge1xuICAgICAgICAgICAgbGFzdEtleURvd25LZXlDb2RlID0gZS5rZXlDb2RlO1xuICAgICAgICB9KTtcbiAgICAgICAgYWRkTGlzdGVuZXIoZWwsIFwia2V5cHJlc3NcIiwgZnVuY3Rpb24oZTogS2V5Ym9hcmRFdmVudCkge1xuICAgICAgICAgICAgcmV0dXJuIG5vcm1hbGl6ZUNvbW1hbmRLZXlzKGNhbGxiYWNrLCBlLCBsYXN0S2V5RG93bktleUNvZGUpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIHZhciBsYXN0RGVmYXVsdFByZXZlbnRlZCA9IG51bGw7XG5cbiAgICAgICAgYWRkTGlzdGVuZXIoZWwsIFwia2V5ZG93blwiLCBmdW5jdGlvbihlOiBLZXlib2FyZEV2ZW50KSB7XG4gICAgICAgICAgICBwcmVzc2VkS2V5c1tlLmtleUNvZGVdID0gdHJ1ZTtcbiAgICAgICAgICAgIHZhciByZXN1bHQgPSBub3JtYWxpemVDb21tYW5kS2V5cyhjYWxsYmFjaywgZSwgZS5rZXlDb2RlKTtcbiAgICAgICAgICAgIGxhc3REZWZhdWx0UHJldmVudGVkID0gZS5kZWZhdWx0UHJldmVudGVkO1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgYWRkTGlzdGVuZXIoZWwsICdrZXlwcmVzcycsIGZ1bmN0aW9uKGU6IEtleWJvYXJkRXZlbnQpIHtcbiAgICAgICAgICAgIGlmIChsYXN0RGVmYXVsdFByZXZlbnRlZCAmJiAoZS5jdHJsS2V5IHx8IGUuYWx0S2V5IHx8IGUuc2hpZnRLZXkgfHwgZS5tZXRhS2V5KSkge1xuICAgICAgICAgICAgICAgIHN0b3BFdmVudChlKTtcbiAgICAgICAgICAgICAgICBsYXN0RGVmYXVsdFByZXZlbnRlZCA9IG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGFkZExpc3RlbmVyKGVsLCAna2V5dXAnLCBmdW5jdGlvbihlOiBLZXlib2FyZEV2ZW50KSB7XG4gICAgICAgICAgICBwcmVzc2VkS2V5c1tlLmtleUNvZGVdID0gbnVsbDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKCFwcmVzc2VkS2V5cykge1xuICAgICAgICAgICAgcHJlc3NlZEtleXMgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuICAgICAgICAgICAgYWRkTGlzdGVuZXIod2luZG93LCAnZm9jdXMnLCByZXNldFByZXNzZWRLZXlzKTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuLy8gRklYTUU6IENvbmRpdGlvbmFsIGV4cG9ydHMgbm90IHN1cHBvcnRlZCBieSBUeXBlU2NyaXB0IG9yIEhhcm1vbnkvRVM2LlxuLy8gZGVjbGFyZSB2YXIgZXhwb3J0czogYW55O1xuLypcbmlmICh3aW5kb3cucG9zdE1lc3NhZ2UgJiYgIWlzT2xkSUUpIHtcbiAgICB2YXIgcG9zdE1lc3NhZ2VJZCA9IDE7XG4gICAgZXhwb3J0cy5uZXh0VGljayA9IGZ1bmN0aW9uKGNhbGxiYWNrLCB3aW4pIHtcbiAgICAgICAgd2luID0gd2luIHx8IHdpbmRvdztcbiAgICAgICAgdmFyIG1lc3NhZ2VOYW1lID0gXCJ6ZXJvLXRpbWVvdXQtbWVzc2FnZS1cIiArIHBvc3RNZXNzYWdlSWQ7XG4gICAgICAgIGFkZExpc3RlbmVyKHdpbiwgXCJtZXNzYWdlXCIsIGZ1bmN0aW9uIGxpc3RlbmVyKGUpIHtcbiAgICAgICAgICAgIGlmIChlLmRhdGEgPT0gbWVzc2FnZU5hbWUpIHtcbiAgICAgICAgICAgICAgICBzdG9wUHJvcGFnYXRpb24oZSk7XG4gICAgICAgICAgICAgICAgcmVtb3ZlTGlzdGVuZXIod2luLCBcIm1lc3NhZ2VcIiwgbGlzdGVuZXIpO1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB3aW4ucG9zdE1lc3NhZ2UobWVzc2FnZU5hbWUsIFwiKlwiKTtcbiAgICB9O1xufVxuKi9cblxudmFyIG5leHRGcmFtZUNhbmRpZGF0ZTogKGNhbGxiYWNrOiAoKSA9PiB2b2lkLCAkd2luZG93OiBXaW5kb3cpID0+IHZvaWQgPSB3aW5kb3cucmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8XG4gICAgd2luZG93Wydtb3pSZXF1ZXN0QW5pbWF0aW9uRnJhbWUnXSB8fFxuICAgIHdpbmRvd1snd2Via2l0UmVxdWVzdEFuaW1hdGlvbkZyYW1lJ10gfHxcbiAgICB3aW5kb3cubXNSZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHxcbiAgICB3aW5kb3dbJ29SZXF1ZXN0QW5pbWF0aW9uRnJhbWUnXTtcblxuaWYgKG5leHRGcmFtZUNhbmRpZGF0ZSkge1xuICAgIG5leHRGcmFtZUNhbmRpZGF0ZSA9IG5leHRGcmFtZUNhbmRpZGF0ZS5iaW5kKHdpbmRvdyk7XG59XG5lbHNlIHtcbiAgICBuZXh0RnJhbWVDYW5kaWRhdGUgPSBmdW5jdGlvbihjYWxsYmFjaykge1xuICAgICAgICBzZXRUaW1lb3V0KGNhbGxiYWNrLCAxNyk7XG4gICAgfTtcbn1cblxuLyoqXG4gKiBBIGJhY2t3YXJkcy1jb21wYXRpYmxlLCBicm93c2VyLW5ldXRyYWwsIHJlcXVlc3RBbmltYXRpb25GcmFtZS5cbiAqL1xuZXhwb3J0IHZhciByZXF1ZXN0QW5pbWF0aW9uRnJhbWU6IChjYWxsYmFjazogKCkgPT4gdm9pZCwgJHdpbmRvdzogV2luZG93KSA9PiB2b2lkID0gbmV4dEZyYW1lQ2FuZGlkYXRlO1xuIl19