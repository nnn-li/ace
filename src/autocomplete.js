import HashHandler from "./keyboard/HashHandler";
import ListViewPopup from "./autocomplete/ListViewPopup";
import { retrievePrecedingIdentifier } from "./autocomplete/util";
import { delayedCall } from "./lib/lang";
import { snippetManager } from "./snippets";
import Anchor from './Anchor';
import Range from './Range';
import CompletionList from "./CompletionList";
var EDITOR_EXT_COMPLETER = 'completer';
export function getCompleter(editor) {
    return editor[EDITOR_EXT_COMPLETER];
}
export function setCompleter(editor, completer) {
    editor[EDITOR_EXT_COMPLETER] = completer;
}
export class CompleterAggregate {
    constructor(editor) {
        this.keyboardHandler = new HashHandler();
        this.gatherCompletionsId = 0;
        this.autoSelect = true;
        this.autoInsert = true;
        this.showPopup = function (editor) {
            if (this.editor) {
                this.detach();
            }
            this.activated = true;
            this.editor = editor;
            if (getCompleter(editor) != this) {
                if (getCompleter(editor)) {
                    getCompleter(editor).detach();
                }
                setCompleter(editor, this);
            }
            editor.keyBinding.addKeyboardHandler(this.keyboardHandler);
            editor.on("changeSelection", this.changeListener);
            editor.on("blur", this.blurListener);
            editor.on("mousedown", this.mousedownListener);
            editor.on("mousewheel", this.mousewheelListener);
            this.updateCompletions();
        };
        this.editor = editor;
        this.commands = {
            "Up": function (editor) { getCompleter(editor).goTo("up"); },
            "Down": function (editor) { getCompleter(editor).goTo("down"); },
            "Ctrl-Up|Ctrl-Home": function (editor) { getCompleter(editor).goTo("start"); },
            "Ctrl-Down|Ctrl-End": function (editor) { getCompleter(editor).goTo("end"); },
            "Esc": function (editor) { getCompleter(editor).detach(); },
            "Space": function (editor) { getCompleter(editor).detach(); editor.insert(" ", false); },
            "Return": function (editor) { return getCompleter(editor).insertMatch(); },
            "Shift-Return": function (editor) { getCompleter(editor).insertMatch(true); },
            "Tab": function (editor) {
                var result = getCompleter(editor).insertMatch();
                if (!result && !editor['tabstopManager']) {
                    getCompleter(editor).goTo("down");
                }
                else
                    return result;
            },
            "PageUp": function (editor) { getCompleter(editor).goTo('pageUp'); },
            "PageDown": function (editor) { getCompleter(editor).goTo('pageDown'); }
        };
        this.keyboardHandler.bindKeys(this.commands);
        this.blurListener = this.blurListener.bind(this);
        this.changeListener = this.changeListener.bind(this);
        this.mousedownListener = this.mousedownListener.bind(this);
        this.mousewheelListener = this.mousewheelListener.bind(this);
        this.changeTimer = delayedCall(function () { this.updateCompletions(true); }.bind(this));
    }
    insertMatch(data) {
        if (!data) {
            data = this.popup.getData(this.popup.getRow());
        }
        if (!data) {
            return;
        }
        if (data.completer && data.completer.insertMatch) {
            data.completer.insertMatch(this.editor);
        }
        else {
            if (this.completions.filterText) {
                var ranges = this.editor.selection['getAllRanges']();
                for (var i = 0, range; range = ranges[i]; i++) {
                    range.start.column -= this.completions.filterText.length;
                    this.editor.getSession().remove(range);
                }
            }
            if (data.snippet) {
                snippetManager.insertSnippet(this.editor, data.snippet);
            }
            else {
                this.editor.execCommand("insertstring", data.value || data);
            }
        }
        this.detach();
    }
    detach() {
        this.editor.keyBinding.removeKeyboardHandler(this.keyboardHandler);
        this.editor.off("changeSelection", this.changeListener);
        this.editor.off("blur", this.blurListener);
        this.editor.off("mousedown", this.mousedownListener);
        this.editor.off("mousewheel", this.mousewheelListener);
        this.changeTimer.cancel();
        if (this.popup && this.popup.isOpen) {
            this.gatherCompletionsId += 1;
            this.popup.hide();
        }
        if (this.base)
            this.base.detach();
        this.activated = false;
        this.completions = this.base = null;
    }
    goTo(where) {
        var row = this.popup.getRow();
        var max = this.popup.getLength() - 1;
        switch (where) {
            case "up":
                row = row <= 0 ? max : row - 1;
                break;
            case "down":
                row = row >= max ? -1 : row + 1;
                break;
            case "start":
                row = 0;
                break;
            case "end":
                row = max;
                break;
        }
        this.popup.setRow(row);
    }
    getCompletions(editor, session, pos, prefix, callback) {
        this.base = new Anchor(session.doc, pos.row, pos.column - prefix.length);
        var matches = [];
        var total = editor.completers.length;
        editor.completers.forEach(function (completer, index) {
            completer.getCompletions(editor, session, pos, prefix, function (err, results) {
                if (!err)
                    matches = matches.concat(results);
                var pos = editor.getCursorPosition();
                var line = session.getLine(pos.row);
                callback(null, {
                    prefix: retrievePrecedingIdentifier(line, pos.column, results[0] && results[0].identifierRegex),
                    matches: matches,
                    finished: (--total === 0)
                });
            });
        });
        return true;
    }
    updateCompletions(keepPopupPosition) {
        var pos = this.editor.getCursorPosition();
        var prefix;
        if (keepPopupPosition && this.base && this.completions) {
            var range = new Range(this.base.row, this.base.column, pos.row, pos.column);
            prefix = this.editor.getSession().getTextRange(range);
            if (prefix == this.completions.filterText)
                return;
            this.completions.setFilter(prefix);
            if (!this.completions.filtered.length)
                return this.detach();
            if (this.completions.filtered.length == 1 && this.completions.filtered[0].value == prefix && !this.completions.filtered[0].snippet) {
                return this.detach();
            }
            this.openPopup(this.editor, prefix, keepPopupPosition);
        }
        else {
            var _id = this.gatherCompletionsId;
            var editor = this.editor;
            var session = editor.getSession();
            var line = session.getLine(pos.row);
            prefix = retrievePrecedingIdentifier(line, pos.column);
            this.getCompletions(this.editor, session, this.editor.getCursorPosition(), prefix, function (err, results) {
                var detachIfFinished = function () {
                    if (!results.finished)
                        return;
                    return this.detach();
                }.bind(this);
                var prefix = results.prefix;
                var matches = results && results.matches;
                if (!matches || !matches.length)
                    return detachIfFinished();
                if (prefix.indexOf(results.prefix) !== 0 || _id != this.gatherCompletionsId)
                    return;
                this.completions = new CompletionList(matches);
                this.completions.setFilter(prefix);
                var filtered = this.completions.filtered;
                if (!filtered.length)
                    return detachIfFinished();
                if (filtered.length == 1 && filtered[0].value == prefix && !filtered[0].snippet)
                    return detachIfFinished();
                if (this.autoInsert && filtered.length == 1)
                    return this.insertMatch(filtered[0]);
                this.openPopup(this.editor, prefix, keepPopupPosition);
            }.bind(this));
        }
    }
    openPopup(editor, prefix, keepPopupPosition) {
        if (!this.popup) {
            this.popup = new ListViewPopup(document.body || document.documentElement);
            this.popup.on("click", function (e) { this.insertMatch(); e.stop(); }.bind(this));
            this.popup.focus = this.editor.focus.bind(this.editor);
        }
        this.popup.setData(this.completions.filtered);
        this.popup.setRow(this.autoSelect ? 0 : -1);
        if (!keepPopupPosition) {
            this.popup.setFontSize(editor.getFontSize());
            var lineHeight = editor.renderer.layerConfig.lineHeight;
            var pos = editor.renderer.$cursorLayer.getPixelPosition(this.base, true);
            pos.left -= this.popup.getTextLeftOffset();
            var rect = editor.container.getBoundingClientRect();
            pos.top += rect.top - editor.renderer.layerConfig.offset;
            pos.left += rect.left - editor.renderer.scrollLeft;
            pos.left += editor.renderer.$gutterLayer.gutterWidth;
            this.popup.show(pos, lineHeight);
        }
    }
    changeListener(e) {
        var cursor = this.editor.selection.lead;
        if (cursor.row != this.base.row || cursor.column < this.base.column) {
            this.detach();
        }
        if (this.activated)
            this.changeTimer.schedule();
        else
            this.detach();
    }
    blurListener() {
        var el = document.activeElement;
        if (el != this.editor.textInput.getElement() && el.parentNode != this.popup.container) {
            this.detach();
        }
    }
    mousedownListener(e) {
        this.detach();
    }
    mousewheelListener(e) {
        this.detach();
    }
    cancelContextMenu() {
        this.editor.cancelMouseContextMenu();
    }
}
export class Autocomplete {
}
Autocomplete.startCommand = {
    name: "startAutocomplete",
    exec: function (editor) {
        var aggregate = getCompleter(editor);
        if (!aggregate) {
            aggregate = new CompleterAggregate(editor);
            setCompleter(editor, aggregate);
        }
        aggregate.autoInsert = true;
        aggregate.autoSelect = true;
        aggregate.showPopup(editor);
        aggregate.cancelContextMenu();
    },
    bindKey: "Ctrl-Space|Ctrl-Shift-Space|Alt-Space"
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0b2NvbXBsZXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXV0b2NvbXBsZXRlLnRzIl0sIm5hbWVzIjpbImdldENvbXBsZXRlciIsInNldENvbXBsZXRlciIsIkNvbXBsZXRlckFnZ3JlZ2F0ZSIsIkNvbXBsZXRlckFnZ3JlZ2F0ZS5jb25zdHJ1Y3RvciIsIkNvbXBsZXRlckFnZ3JlZ2F0ZS5pbnNlcnRNYXRjaCIsIkNvbXBsZXRlckFnZ3JlZ2F0ZS5kZXRhY2giLCJDb21wbGV0ZXJBZ2dyZWdhdGUuZ29UbyIsIkNvbXBsZXRlckFnZ3JlZ2F0ZS5nZXRDb21wbGV0aW9ucyIsIkNvbXBsZXRlckFnZ3JlZ2F0ZS51cGRhdGVDb21wbGV0aW9ucyIsIkNvbXBsZXRlckFnZ3JlZ2F0ZS5vcGVuUG9wdXAiLCJDb21wbGV0ZXJBZ2dyZWdhdGUuY2hhbmdlTGlzdGVuZXIiLCJDb21wbGV0ZXJBZ2dyZWdhdGUuYmx1ckxpc3RlbmVyIiwiQ29tcGxldGVyQWdncmVnYXRlLm1vdXNlZG93bkxpc3RlbmVyIiwiQ29tcGxldGVyQWdncmVnYXRlLm1vdXNld2hlZWxMaXN0ZW5lciIsIkNvbXBsZXRlckFnZ3JlZ2F0ZS5jYW5jZWxDb250ZXh0TWVudSIsIkF1dG9jb21wbGV0ZSJdLCJtYXBwaW5ncyI6Ik9BcURPLFdBQVcsTUFBTSx3QkFBd0I7T0FDekMsYUFBYSxNQUFNLDhCQUE4QjtPQUNqRCxFQUFDLDJCQUEyQixFQUFDLE1BQU0scUJBQXFCO09BRXhELEVBQUMsV0FBVyxFQUFDLE1BQU0sWUFBWTtPQUMvQixFQUFDLGNBQWMsRUFBQyxNQUFNLFlBQVk7T0FHbEMsTUFBTSxNQUFNLFVBQVU7T0FFdEIsS0FBSyxNQUFNLFNBQVM7T0FHcEIsY0FBYyxNQUFNLGtCQUFrQjtBQUU3QyxJQUFJLG9CQUFvQixHQUFHLFdBQVcsQ0FBQztBQU12Qyw2QkFBNkIsTUFBYztJQUN2Q0EsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0Esb0JBQW9CQSxDQUFDQSxDQUFDQTtBQUN4Q0EsQ0FBQ0E7QUFFRCw2QkFBNkIsTUFBYyxFQUFFLFNBQTZCO0lBQ3RFQyxNQUFNQSxDQUFDQSxvQkFBb0JBLENBQUNBLEdBQUdBLFNBQVNBLENBQUNBO0FBQzdDQSxDQUFDQTtBQUVEO0lBV0lDLFlBQVlBLE1BQWNBO1FBVGxCQyxvQkFBZUEsR0FBR0EsSUFBSUEsV0FBV0EsRUFBRUEsQ0FBQ0E7UUFHcENBLHdCQUFtQkEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFJekJBLGVBQVVBLEdBQUdBLElBQUlBLENBQUNBO1FBQ2xCQSxlQUFVQSxHQUFHQSxJQUFJQSxDQUFDQTtRQTRRbEJBLGNBQVNBLEdBQUdBLFVBQVNBLE1BQWNBO1lBRXRDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUNkLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNsQixDQUFDO1lBRUQsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7WUFFdEIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7WUFFckIsRUFBRSxDQUFDLENBQUMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUM7Z0JBQy9CLEVBQUUsQ0FBQyxDQUFDLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3ZCLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQztnQkFDbEMsQ0FBQztnQkFDRCxZQUFZLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDO1lBQy9CLENBQUM7WUFFRCxNQUFNLENBQUMsVUFBVSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztZQUMzRCxNQUFNLENBQUMsRUFBRSxDQUFDLGlCQUFpQixFQUFFLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUNsRCxNQUFNLENBQUMsRUFBRSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7WUFDckMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUM7WUFDL0MsTUFBTSxDQUFDLEVBQUUsQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7WUFFakQsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7UUFDN0IsQ0FBQyxDQUFBQTtRQWxTR0EsSUFBSUEsQ0FBQ0EsTUFBTUEsR0FBR0EsTUFBTUEsQ0FBQ0E7UUFDckJBLElBQUlBLENBQUNBLFFBQVFBLEdBQUdBO1lBQ1pBLElBQUlBLEVBQUVBLFVBQVNBLE1BQWNBLElBQUksWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkVBLE1BQU1BLEVBQUVBLFVBQVNBLE1BQWNBLElBQUksWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdkVBLG1CQUFtQkEsRUFBRUEsVUFBU0EsTUFBY0EsSUFBSSxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNyRkEsb0JBQW9CQSxFQUFFQSxVQUFTQSxNQUFjQSxJQUFJLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBRXBGQSxLQUFLQSxFQUFFQSxVQUFTQSxNQUFjQSxJQUFJLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDbEVBLE9BQU9BLEVBQUVBLFVBQVNBLE1BQWNBLElBQUksWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQy9GQSxRQUFRQSxFQUFFQSxVQUFTQSxNQUFjQSxJQUFJLE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ2pGQSxjQUFjQSxFQUFFQSxVQUFTQSxNQUFjQSxJQUFJLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BGQSxLQUFLQSxFQUFFQSxVQUFTQSxNQUFjQTtnQkFDMUIsSUFBSSxNQUFNLEdBQUcsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDO2dCQUNoRCxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDdkMsWUFBWSxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztnQkFDdEMsQ0FBQztnQkFDRCxJQUFJO29CQUNBLE1BQU0sQ0FBQyxNQUFNLENBQUM7WUFDdEIsQ0FBQztZQUVEQSxRQUFRQSxFQUFFQSxVQUFTQSxNQUFjQSxJQUFJLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzNFQSxVQUFVQSxFQUFFQSxVQUFTQSxNQUFjQSxJQUFJLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ2xGQSxDQUFDQTtRQUVGQSxJQUFJQSxDQUFDQSxlQUFlQSxDQUFDQSxRQUFRQSxDQUFDQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQTtRQUU3Q0EsSUFBSUEsQ0FBQ0EsWUFBWUEsR0FBR0EsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDakRBLElBQUlBLENBQUNBLGNBQWNBLEdBQUdBLElBQUlBLENBQUNBLGNBQWNBLENBQUNBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO1FBQ3JEQSxJQUFJQSxDQUFDQSxpQkFBaUJBLEdBQUdBLElBQUlBLENBQUNBLGlCQUFpQkEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDM0RBLElBQUlBLENBQUNBLGtCQUFrQkEsR0FBR0EsSUFBSUEsQ0FBQ0Esa0JBQWtCQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUU3REEsSUFBSUEsQ0FBQ0EsV0FBV0EsR0FBR0EsV0FBV0EsQ0FBQ0EsY0FBYSxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUNBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLENBQUNBO0lBQzVGQSxDQUFDQTtJQU1NRCxXQUFXQSxDQUFDQSxJQUFLQTtRQUNwQkUsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDUkEsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsTUFBTUEsRUFBRUEsQ0FBQ0EsQ0FBQ0E7UUFDbkRBLENBQUNBO1FBRURBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLENBQUNBO1lBQ1JBLE1BQU1BLENBQUNBO1FBQ1hBLENBQUNBO1FBRURBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFNBQVNBLElBQUlBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLFdBQVdBLENBQUNBLENBQUNBLENBQUNBO1lBQy9DQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxXQUFXQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQTtRQUM1Q0EsQ0FBQ0E7UUFDREEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDRkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBRTlCQSxJQUFJQSxNQUFNQSxHQUFZQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxTQUFTQSxDQUFDQSxjQUFjQSxDQUFDQSxFQUFFQSxDQUFDQTtnQkFNOURBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLEtBQUtBLEVBQUVBLEtBQUtBLEdBQUdBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO29CQUM1Q0EsS0FBS0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsTUFBTUEsSUFBSUEsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsVUFBVUEsQ0FBQ0EsTUFBTUEsQ0FBQ0E7b0JBQ3pEQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxVQUFVQSxFQUFFQSxDQUFDQSxNQUFNQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQTtnQkFDM0NBLENBQUNBO1lBQ0xBLENBQUNBO1lBQ0RBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBO2dCQUNmQSxjQUFjQSxDQUFDQSxhQUFhQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxFQUFFQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQTtZQUM1REEsQ0FBQ0E7WUFDREEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7Z0JBQ0ZBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLFdBQVdBLENBQUNBLGNBQWNBLEVBQUVBLElBQUlBLENBQUNBLEtBQUtBLElBQUlBLElBQUlBLENBQUNBLENBQUNBO1lBQ2hFQSxDQUFDQTtRQUNMQSxDQUFDQTtRQUNEQSxJQUFJQSxDQUFDQSxNQUFNQSxFQUFFQSxDQUFDQTtJQUNsQkEsQ0FBQ0E7SUFLTUYsTUFBTUE7UUFDVEcsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EscUJBQXFCQSxDQUFDQSxJQUFJQSxDQUFDQSxlQUFlQSxDQUFDQSxDQUFDQTtRQUNuRUEsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsaUJBQWlCQSxFQUFFQSxJQUFJQSxDQUFDQSxjQUFjQSxDQUFDQSxDQUFDQTtRQUN4REEsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsTUFBTUEsRUFBRUEsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsQ0FBQ0E7UUFDM0NBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLEdBQUdBLENBQUNBLFdBQVdBLEVBQUVBLElBQUlBLENBQUNBLGlCQUFpQkEsQ0FBQ0EsQ0FBQ0E7UUFDckRBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLEdBQUdBLENBQUNBLFlBQVlBLEVBQUVBLElBQUlBLENBQUNBLGtCQUFrQkEsQ0FBQ0EsQ0FBQ0E7UUFDdkRBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBO1FBRTFCQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxLQUFLQSxJQUFJQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNsQ0EsSUFBSUEsQ0FBQ0EsbUJBQW1CQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUM5QkEsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsSUFBSUEsRUFBRUEsQ0FBQ0E7UUFDdEJBLENBQUNBO1FBRURBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLElBQUlBLENBQUNBO1lBQ1ZBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBO1FBQ3ZCQSxJQUFJQSxDQUFDQSxTQUFTQSxHQUFHQSxLQUFLQSxDQUFDQTtRQUN2QkEsSUFBSUEsQ0FBQ0EsV0FBV0EsR0FBR0EsSUFBSUEsQ0FBQ0EsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0E7SUFDeENBLENBQUNBO0lBS01ILElBQUlBLENBQUNBLEtBQWFBO1FBQ3JCSSxJQUFJQSxHQUFHQSxHQUFHQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxNQUFNQSxFQUFFQSxDQUFDQTtRQUM5QkEsSUFBSUEsR0FBR0EsR0FBR0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsU0FBU0EsRUFBRUEsR0FBR0Es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QUlBLENBQUNBLEdBQUdBLEVBQUVBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLEVBQUVBLEdBQUdBLENBQUNBLEdBQUdBLEVBQUVBLEdBQUdBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBO1lBQzVFQSxNQUFNQSxHQUFHQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxVQUFVQSxFQUFFQSxDQUFDQSxZQUFZQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQTtZQUN0REEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsSUFBSUEsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsVUFBVUEsQ0FBQ0E7Z0JBQ3RDQSxNQUFNQSxDQUFDQTtZQUNYQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxTQUFTQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQTtZQUNuQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsTUFBTUEsQ0FBQ0E7Z0JBQ2xDQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxFQUFFQSxDQUFDQTtZQUV6QkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsTUFBTUEsSUFBSUEsQ0FBQ0EsSUFBSUEsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsS0FBS0EsSUFBSUEsTUFBTUEsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ2pJQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxFQUFFQSxDQUFDQTtZQUN6QkEsQ0FBQ0E7WUFFREEsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsRUFBRUEsTUFBTUEsRUFBRUEsaUJBQWlCQSxDQUFDQSxDQUFDQTtRQUMzREEsQ0FBQ0E7UUFDREEs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QUtBLEdBQUdBLElBQUlBLGFBQWFBLENBQUNBLFFBQVFBLENBQUNBLElBQUlBLElBQUlBLFFBQVFBLENBQUNBLGVBQWVBLENBQUNBLENBQUNBO1lBQzFFQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxFQUFFQSxDQUFDQSxPQUFPQSxFQUFFQSxVQUFTQSxDQUFDQSxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDakZBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLEtBQUtBLEdBQUdBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLEtBQUtBLENBQUNBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBO1FBQzNEQSxDQUFDQTtRQUVEQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxPQUFPQSxDQUFDQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQTtRQUU5Q0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsVUFBVUEsR0FBR0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFFNUNBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLGlCQUFpQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFTckJBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLFdBQVdBLENBQUNBLE1BQU1BLENBQUNBLFdBQVdBLEVBQUVBLENBQUNBLENBQUNBO1lBRTdDQSxJQUFJQSxVQUFVQSxHQUFHQSxNQUFNQSxDQUFDQSxRQUFRQSxDQUFDQSxXQUFXQSxDQUFDQSxVQUFVQSxDQUFDQTtZQUV4REEsSUFBSUEsR0FBR0EsR0FBa0NBLE1BQU1BLENBQUNBLFFBQVFBLENBQUNBLFlBQVlBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDeEdBLEdBQUdBLENBQUNBLElBQUlBLElBQUlBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLGlCQUFpQkEsRUFBRUEsQ0FBQ0E7WUFFM0NBLElBQUlBLElBQUlBLEdBQUdBLE1BQU1BLENBQUNBLFNBQVNBLENBQUNBLHFCQUFxQkEsRUFBRUEsQ0FBQ0E7WUFDcERBLEdBQUdBLENBQUNBLEdBQUdBLElBQUlBLElBQUlBLENBQUNBLEdBQUdBLEdBQUdBLE1BQU1BLENBQUNBLFFBQVFBLENBQUNBLFdBQVdBLENBQUNBLE1BQU1BLENBQUNBO1lBQ3pEQSxHQUFHQSxDQUFDQSxJQUFJQSxJQUFJQSxJQUFJQSxDQUFDQSxJQUFJQSxHQUFHQSxNQUFNQSxDQUFDQSxRQUFRQSxDQUFDQSxVQUFVQSxDQUFDQTtZQUNuREEsR0FBR0EsQ0FBQ0EsSUFBSUEsSUFBSUEsTUFBTUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsV0FBV0EsQ0FBQ0E7WUFFckRBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLElBQUlBLENBQUNBLEdBQUdBLEVBQUVBLFVBQVVBLENBQUNBLENBQUNBO1FBQ3JDQSxDQUFDQTtJQUNMQSxDQUFDQTtJQUVPUCxjQUFjQSxDQUFDQSxDQUFDQTtRQUNwQlEsSUFBSUEsTUFBTUEsR0FBR0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsSUFBSUEsQ0FBQ0E7UUFDeENBLEVBQUVBLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLEdBQUdBLElBQUlBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLEdBQUdBLElBQUlBLE1BQU1BLENBQUNBLE1BQU1BLEdBQUdBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBO1lBQ2xFQSxJQUFJQSxDQUFDQSxNQUFNQSxFQUFFQSxDQUFDQTtRQUNsQkEsQ0FBQ0E7UUFDREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0E7WUFDZkEsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsUUFBUUEsRUFBRUEsQ0FBQ0E7UUFDaENBLElBQUlBO1lBQ0FBLElBQUlBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBO0lBQ3RCQSxDQUFDQTtJQUVPUixZQUFZQTtRQUdoQlMsSUFBSUEsRUFBRUEsR0FBR0EsUUFBUUEsQ0FBQ0EsYUFBYUEsQ0FBQ0E7UUFDaENBLEVBQUVBLENBQUNBLENBQUNBLEVBQUVBLElBQUlBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLFNBQVNBLENBQUNBLFVBQVVBLEVBQUVBLElBQUlBLEVBQUVBLENBQUNBLFVBQVVBLElBQUlBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBO1lBQ3BGQSxJQUFJQSxDQUFDQSxNQUFNQSxFQUFFQSxDQUFDQTtRQUNsQkEsQ0FBQ0E7SUFDTEEsQ0FBQ0E7SUFFT1QsaUJBQWlCQSxDQUFDQSxDQUFDQTtRQUN2QlUsSUFBSUEsQ0FBQ0EsTUFBTUEsRUFBRUEsQ0FBQ0E7SUFDbEJBLENBQUNBO0lBRU9WLGtCQUFrQkEsQ0FBQ0EsQ0FBQ0E7UUFDeEJXLElBQUlBLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBO0lBQ2xCQSxDQUFDQTtJQTJCTVgsaUJBQWlCQTtRQUNwQlksSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0Esc0JBQXNCQSxFQUFFQSxDQUFDQTtJQUN6Q0EsQ0FBQ0E7QUFDTFosQ0FBQ0E7QUFHRDtBQWlCQWEsQ0FBQ0E7QUFoQlUseUJBQVksR0FBRztJQUNsQixJQUFJLEVBQUUsbUJBQW1CO0lBQ3pCLElBQUksRUFBRSxVQUFTLE1BQWM7UUFDekIsSUFBSSxTQUFTLEdBQXVCLFlBQVksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN6RCxFQUFFLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDYixTQUFTLEdBQUcsSUFBSSxrQkFBa0IsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUMzQyxZQUFZLENBQUMsTUFBTSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ3BDLENBQUM7UUFDRCxTQUFTLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztRQUM1QixTQUFTLENBQUMsVUFBVSxHQUFHLElBQUksQ0FBQztRQUM1QixTQUFTLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRTVCLFNBQVMsQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO0lBQ2xDLENBQUM7SUFDRCxPQUFPLEVBQUUsdUNBQXVDO0NBQ25ELENBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyIvKiAqKioqKiBCRUdJTiBMSUNFTlNFIEJMT0NLICoqKioqXG4gKiBUaGUgTUlUIExpY2Vuc2UgKE1JVClcbiAqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTQtMjAxNiBEYXZpZCBHZW8gSG9sbWVzIDxkYXZpZC5nZW8uaG9sbWVzQGdtYWlsLmNvbT5cbiAqXG4gKiBQZXJtaXNzaW9uIGlzIGhlcmVieSBncmFudGVkLCBmcmVlIG9mIGNoYXJnZSwgdG8gYW55IHBlcnNvbiBvYnRhaW5pbmcgYSBjb3B5XG4gKiBvZiB0aGlzIHNvZnR3YXJlIGFuZCBhc3NvY2lhdGVkIGRvY3VtZW50YXRpb24gZmlsZXMgKHRoZSBcIlNvZnR3YXJlXCIpLCB0byBkZWFsXG4gKiBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzXG4gKiB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsIGRpc3RyaWJ1dGUsIHN1YmxpY2Vuc2UsIGFuZC9vciBzZWxsXG4gKiBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0IHBlcnNvbnMgdG8gd2hvbSB0aGUgU29mdHdhcmUgaXNcbiAqIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnM6XG4gKlxuICogVGhlIGFib3ZlIGNvcHlyaWdodCBub3RpY2UgYW5kIHRoaXMgcGVybWlzc2lvbiBub3RpY2Ugc2hhbGwgYmUgaW5jbHVkZWQgaW4gYWxsXG4gKiBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLlxuICpcbiAqIFRIRSBTT0ZUV0FSRSBJUyBQUk9WSURFRCBcIkFTIElTXCIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MgT1JcbiAqIElNUExJRUQsIElOQ0xVRElORyBCVVQgTk9UIExJTUlURUQgVE8gVEhFIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZLFxuICogRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQU5EIE5PTklORlJJTkdFTUVOVC4gSU4gTk8gRVZFTlQgU0hBTEwgVEhFXG4gKiBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLCBEQU1BR0VTIE9SIE9USEVSXG4gKiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQU4gQUNUSU9OIE9GIENPTlRSQUNULCBUT1JUIE9SIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLFxuICogT1VUIE9GIE9SIElOIENPTk5FQ1RJT04gV0lUSCBUSEUgU09GVFdBUkUgT1IgVEhFIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEVcbiAqIFNPRlRXQVJFLlxuICogKioqKiogRU5EIExJQ0VOU0UgQkxPQ0sgKioqKiogKi9cbi8qICoqKioqIEJFR0lOIExJQ0VOU0UgQkxPQ0sgKioqKipcbiAqIERpc3RyaWJ1dGVkIHVuZGVyIHRoZSBCU0QgbGljZW5zZTpcbiAqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTIsIEFqYXgub3JnIEIuVi5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0XG4gKiBtb2RpZmljYXRpb24sIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMgYXJlIG1ldDpcbiAqICAgICAqIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0XG4gKiAgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuXG4gKiAgICAgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodFxuICogICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZVxuICogICAgICAgZG9jdW1lbnRhdGlvbiBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi5cbiAqICAgICAqIE5laXRoZXIgdGhlIG5hbWUgb2YgQWpheC5vcmcgQi5WLiBub3IgdGhlXG4gKiAgICAgICBuYW1lcyBvZiBpdHMgY29udHJpYnV0b3JzIG1heSBiZSB1c2VkIHRvIGVuZG9yc2Ugb3IgcHJvbW90ZSBwcm9kdWN0c1xuICogICAgICAgZGVyaXZlZCBmcm9tIHRoaXMgc29mdHdhcmUgd2l0aG91dCBzcGVjaWZpYyBwcmlvciB3cml0dGVuIHBlcm1pc3Npb24uXG4gKlxuICogVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQ09QWVJJR0hUIEhPTERFUlMgQU5EIENPTlRSSUJVVE9SUyBcIkFTIElTXCIgQU5EXG4gKiBBTlkgRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUgSU1QTElFRFxuICogV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkgQU5EIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFSRVxuICogRElTQ0xBSU1FRC4gSU4gTk8gRVZFTlQgU0hBTEwgQUpBWC5PUkcgQi5WLiBCRSBMSUFCTEUgRk9SIEFOWVxuICogRElSRUNULCBJTkRJUkVDVCwgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVNcbiAqIChJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUztcbiAqIExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORFxuICogT04gQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVCBMSUFCSUxJVFksIE9SIFRPUlRcbiAqIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFIFVTRSBPRiBUSElTXG4gKiBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS5cbiAqXG4gKiAqKioqKiBFTkQgTElDRU5TRSBCTE9DSyAqKioqKiAqL1xuXG5pbXBvcnQgSGFzaEhhbmRsZXIgZnJvbSBcIi4va2V5Ym9hcmQvSGFzaEhhbmRsZXJcIjtcbmltcG9ydCBMaXN0Vmlld1BvcHVwIGZyb20gXCIuL2F1dG9jb21wbGV0ZS9MaXN0Vmlld1BvcHVwXCI7XG5pbXBvcnQge3JldHJpZXZlUHJlY2VkaW5nSWRlbnRpZmllcn0gZnJvbSBcIi4vYXV0b2NvbXBsZXRlL3V0aWxcIjtcbmltcG9ydCB7fSBmcm9tIFwiLi9saWIvZXZlbnRcIjtcbmltcG9ydCB7ZGVsYXllZENhbGx9IGZyb20gXCIuL2xpYi9sYW5nXCI7XG5pbXBvcnQge3NuaXBwZXRNYW5hZ2VyfSBmcm9tIFwiLi9zbmlwcGV0c1wiO1xuaW1wb3J0IEVkaXRvciBmcm9tICcuL0VkaXRvcic7XG5pbXBvcnQgRWRpdFNlc3Npb24gZnJvbSAnLi9FZGl0U2Vzc2lvbic7XG5pbXBvcnQgQW5jaG9yIGZyb20gJy4vQW5jaG9yJztcbmltcG9ydCBQb3NpdGlvbiBmcm9tICcuL1Bvc2l0aW9uJztcbmltcG9ydCBSYW5nZSBmcm9tICcuL1JhbmdlJztcbmltcG9ydCBUaGVtZUxpbmsgZnJvbSAnLi9UaGVtZUxpbmsnO1xuaW1wb3J0IENvbXBsZXRpb24gZnJvbSBcIi4vQ29tcGxldGlvblwiO1xuaW1wb3J0IENvbXBsZXRpb25MaXN0IGZyb20gXCIuL0NvbXBsZXRpb25MaXN0XCI7XG5cbnZhciBFRElUT1JfRVhUX0NPTVBMRVRFUiA9ICdjb21wbGV0ZXInO1xuXG5leHBvcnQgaW50ZXJmYWNlIENvbXBsZXRlciB7XG4gICAgZ2V0Q29tcGxldGlvbnMoZWRpdG9yOiBFZGl0b3IsIHNlc3Npb246IEVkaXRTZXNzaW9uLCBwb3M6IFBvc2l0aW9uLCBwcmVmaXg6IHN0cmluZywgY2FsbGJhY2s6IChlcnIsIHJlc3VsdHM6IENvbXBsZXRpb25bXSkgPT4gYW55KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldENvbXBsZXRlcihlZGl0b3I6IEVkaXRvcik6IENvbXBsZXRlckFnZ3JlZ2F0ZSB7XG4gICAgcmV0dXJuIGVkaXRvcltFRElUT1JfRVhUX0NPTVBMRVRFUl07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXRDb21wbGV0ZXIoZWRpdG9yOiBFZGl0b3IsIGNvbXBsZXRlcjogQ29tcGxldGVyQWdncmVnYXRlKSB7XG4gICAgZWRpdG9yW0VESVRPUl9FWFRfQ09NUExFVEVSXSA9IGNvbXBsZXRlcjtcbn1cblxuZXhwb3J0IGNsYXNzIENvbXBsZXRlckFnZ3JlZ2F0ZSBpbXBsZW1lbnRzIENvbXBsZXRlciB7XG4gICAgcHJpdmF0ZSBlZGl0b3I6IEVkaXRvcjtcbiAgICBwcml2YXRlIGtleWJvYXJkSGFuZGxlciA9IG5ldyBIYXNoSGFuZGxlcigpO1xuICAgIHB1YmxpYyBhY3RpdmF0ZWQ6IGJvb2xlYW47XG4gICAgcHJpdmF0ZSBjaGFuZ2VUaW1lcjtcbiAgICBwcml2YXRlIGdhdGhlckNvbXBsZXRpb25zSWQgPSAwO1xuICAgIHByaXZhdGUgYmFzZTogQW5jaG9yO1xuICAgIHByaXZhdGUgY29tcGxldGlvbnM6IENvbXBsZXRpb25MaXN0O1xuICAgIHByaXZhdGUgY29tbWFuZHM6IHsgW25hbWU6IHN0cmluZ106IChlZGl0b3I6IEVkaXRvcikgPT4gdm9pZCB9O1xuICAgIHB1YmxpYyBhdXRvU2VsZWN0ID0gdHJ1ZTtcbiAgICBwdWJsaWMgYXV0b0luc2VydCA9IHRydWU7XG4gICAgY29uc3RydWN0b3IoZWRpdG9yOiBFZGl0b3IpIHtcbiAgICAgICAgdGhpcy5lZGl0b3IgPSBlZGl0b3I7XG4gICAgICAgIHRoaXMuY29tbWFuZHMgPSB7XG4gICAgICAgICAgICBcIlVwXCI6IGZ1bmN0aW9uKGVkaXRvcjogRWRpdG9yKSB7IGdldENvbXBsZXRlcihlZGl0b3IpLmdvVG8oXCJ1cFwiKTsgfSxcbiAgICAgICAgICAgIFwiRG93blwiOiBmdW5jdGlvbihlZGl0b3I6IEVkaXRvcikgeyBnZXRDb21wbGV0ZXIoZWRpdG9yKS5nb1RvKFwiZG93blwiKTsgfSxcbiAgICAgICAgICAgIFwiQ3RybC1VcHxDdHJsLUhvbWVcIjogZnVuY3Rpb24oZWRpdG9yOiBFZGl0b3IpIHsgZ2V0Q29tcGxldGVyKGVkaXRvcikuZ29UbyhcInN0YXJ0XCIpOyB9LFxuICAgICAgICAgICAgXCJDdHJsLURvd258Q3RybC1FbmRcIjogZnVuY3Rpb24oZWRpdG9yOiBFZGl0b3IpIHsgZ2V0Q29tcGxldGVyKGVkaXRvcikuZ29UbyhcImVuZFwiKTsgfSxcblxuICAgICAgICAgICAgXCJFc2NcIjogZnVuY3Rpb24oZWRpdG9yOiBFZGl0b3IpIHsgZ2V0Q29tcGxldGVyKGVkaXRvcikuZGV0YWNoKCk7IH0sXG4gICAgICAgICAgICBcIlNwYWNlXCI6IGZ1bmN0aW9uKGVkaXRvcjogRWRpdG9yKSB7IGdldENvbXBsZXRlcihlZGl0b3IpLmRldGFjaCgpOyBlZGl0b3IuaW5zZXJ0KFwiIFwiLCBmYWxzZSk7IH0sXG4gICAgICAgICAgICBcIlJldHVyblwiOiBmdW5jdGlvbihlZGl0b3I6IEVkaXRvcikgeyByZXR1cm4gZ2V0Q29tcGxldGVyKGVkaXRvcikuaW5zZXJ0TWF0Y2goKTsgfSxcbiAgICAgICAgICAgIFwiU2hpZnQtUmV0dXJuXCI6IGZ1bmN0aW9uKGVkaXRvcjogRWRpdG9yKSB7IGdldENvbXBsZXRlcihlZGl0b3IpLmluc2VydE1hdGNoKHRydWUpOyB9LFxuICAgICAgICAgICAgXCJUYWJcIjogZnVuY3Rpb24oZWRpdG9yOiBFZGl0b3IpIHtcbiAgICAgICAgICAgICAgICB2YXIgcmVzdWx0ID0gZ2V0Q29tcGxldGVyKGVkaXRvcikuaW5zZXJ0TWF0Y2goKTtcbiAgICAgICAgICAgICAgICBpZiAoIXJlc3VsdCAmJiAhZWRpdG9yWyd0YWJzdG9wTWFuYWdlciddKSB7XG4gICAgICAgICAgICAgICAgICAgIGdldENvbXBsZXRlcihlZGl0b3IpLmdvVG8oXCJkb3duXCIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICAgICAgICB9LFxuXG4gICAgICAgICAgICBcIlBhZ2VVcFwiOiBmdW5jdGlvbihlZGl0b3I6IEVkaXRvcikgeyBnZXRDb21wbGV0ZXIoZWRpdG9yKS5nb1RvKCdwYWdlVXAnKTsgfSxcbiAgICAgICAgICAgIFwiUGFnZURvd25cIjogZnVuY3Rpb24oZWRpdG9yOiBFZGl0b3IpIHsgZ2V0Q29tcGxldGVyKGVkaXRvcikuZ29UbygncGFnZURvd24nKTsgfVxuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMua2V5Ym9hcmRIYW5kbGVyLmJpbmRLZXlzKHRoaXMuY29tbWFuZHMpO1xuXG4gICAgICAgIHRoaXMuYmx1ckxpc3RlbmVyID0gdGhpcy5ibHVyTGlzdGVuZXIuYmluZCh0aGlzKTtcbiAgICAgICAgdGhpcy5jaGFuZ2VMaXN0ZW5lciA9IHRoaXMuY2hhbmdlTGlzdGVuZXIuYmluZCh0aGlzKTtcbiAgICAgICAgdGhpcy5tb3VzZWRvd25MaXN0ZW5lciA9IHRoaXMubW91c2Vkb3duTGlzdGVuZXIuYmluZCh0aGlzKTtcbiAgICAgICAgdGhpcy5tb3VzZXdoZWVsTGlzdGVuZXIgPSB0aGlzLm1vdXNld2hlZWxMaXN0ZW5lci5iaW5kKHRoaXMpO1xuXG4gICAgICAgIHRoaXMuY2hhbmdlVGltZXIgPSBkZWxheWVkQ2FsbChmdW5jdGlvbigpIHsgdGhpcy51cGRhdGVDb21wbGV0aW9ucyh0cnVlKTsgfS5iaW5kKHRoaXMpKTtcbiAgICB9XG4gICAgcHVibGljIHBvcHVwOiBMaXN0Vmlld1BvcHVwO1xuXG4gICAgLyoqXG4gICAgICogSW1wbGVtZW50YXRpb24gb2YgdGhlIENvbXBsZXRlciBpbnRlcmZhY2UuXG4gICAgICovXG4gICAgcHVibGljIGluc2VydE1hdGNoKGRhdGE/KSB7XG4gICAgICAgIGlmICghZGF0YSkge1xuICAgICAgICAgICAgZGF0YSA9IHRoaXMucG9wdXAuZ2V0RGF0YSh0aGlzLnBvcHVwLmdldFJvdygpKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghZGF0YSkge1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGRhdGEuY29tcGxldGVyICYmIGRhdGEuY29tcGxldGVyLmluc2VydE1hdGNoKSB7XG4gICAgICAgICAgICBkYXRhLmNvbXBsZXRlci5pbnNlcnRNYXRjaCh0aGlzLmVkaXRvcik7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBpZiAodGhpcy5jb21wbGV0aW9ucy5maWx0ZXJUZXh0KSB7XG4gICAgICAgICAgICAgICAgLy8gRklYTUU6IGdldEFsbFJhbmdlcyBvbiBTZWxlY3Rpb24/XG4gICAgICAgICAgICAgICAgdmFyIHJhbmdlczogUmFuZ2VbXSA9IHRoaXMuZWRpdG9yLnNlbGVjdGlvblsnZ2V0QWxsUmFuZ2VzJ10oKTtcbiAgICAgICAgICAgICAgICAvLyBUT0RPOiBBc3NpZ25tZW50IGluIGNvbmRpdGlvbmFsIGV4cHJlc3Npb24uXG4gICAgICAgICAgICAgICAgLy8gVE9ETzogQXNzaWdubWVudCBpbiBjb25kaXRpb25hbCBleHByZXNzaW9uLlxuICAgICAgICAgICAgICAgIC8vIEl0J3MgY3V0ZSBidXQgYWxzbyBtYXkgaGFsdCBwcmVtYXR1cmVseSBhbmQgc28gaGlkZSBidWdzLlxuICAgICAgICAgICAgICAgIC8vIFJlcGxhY2UgYnkgbGVuZ3RoIHZhcmlhYmxlIGFuZCB0ZXN0P1xuICAgICAgICAgICAgICAgIC8vIFVzZSBhc3NlcnRpb24gd2l0aGluIHRoZSBsb29wIHRvIGxvb2sgZm9yIGZhbHNleSB2YWx1ZXMuXG4gICAgICAgICAgICAgICAgZm9yICh2YXIgaSA9IDAsIHJhbmdlOyByYW5nZSA9IHJhbmdlc1tpXTsgaSsrKSB7XG4gICAgICAgICAgICAgICAgICAgIHJhbmdlLnN0YXJ0LmNvbHVtbiAtPSB0aGlzLmNvbXBsZXRpb25zLmZpbHRlclRleHQubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmVkaXRvci5nZXRTZXNzaW9uKCkucmVtb3ZlKHJhbmdlKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoZGF0YS5zbmlwcGV0KSB7XG4gICAgICAgICAgICAgICAgc25pcHBldE1hbmFnZXIuaW5zZXJ0U25pcHBldCh0aGlzLmVkaXRvciwgZGF0YS5zbmlwcGV0KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuZWRpdG9yLmV4ZWNDb21tYW5kKFwiaW5zZXJ0c3RyaW5nXCIsIGRhdGEudmFsdWUgfHwgZGF0YSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kZXRhY2goKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBJbXBsZW1lbnRhdGlvbiBvZiB0aGUgQ29tcGxldGVyIGludGVyZmFjZS5cbiAgICAgKi9cbiAgICBwdWJsaWMgZGV0YWNoKCkge1xuICAgICAgICB0aGlzLmVkaXRvci5rZXlCaW5kaW5nLnJlbW92ZUtleWJvYXJkSGFuZGxlcih0aGlzLmtleWJvYXJkSGFuZGxlcik7XG4gICAgICAgIHRoaXMuZWRpdG9yLm9mZihcImNoYW5nZVNlbGVjdGlvblwiLCB0aGlzLmNoYW5nZUxpc3RlbmVyKTtcbiAgICAgICAgdGhpcy5lZGl0b3Iub2ZmKFwiYmx1clwiLCB0aGlzLmJsdXJMaXN0ZW5lcik7XG4gICAgICAgIHRoaXMuZWRpdG9yLm9mZihcIm1vdXNlZG93blwiLCB0aGlzLm1vdXNlZG93bkxpc3RlbmVyKTtcbiAgICAgICAgdGhpcy5lZGl0b3Iub2ZmKFwibW91c2V3aGVlbFwiLCB0aGlzLm1vdXNld2hlZWxMaXN0ZW5lcik7XG4gICAgICAgIHRoaXMuY2hhbmdlVGltZXIuY2FuY2VsKCk7XG5cbiAgICAgICAgaWYgKHRoaXMucG9wdXAgJiYgdGhpcy5wb3B1cC5pc09wZW4pIHtcbiAgICAgICAgICAgIHRoaXMuZ2F0aGVyQ29tcGxldGlvbnNJZCArPSAxO1xuICAgICAgICAgICAgdGhpcy5wb3B1cC5oaWRlKCk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5iYXNlKVxuICAgICAgICAgICAgdGhpcy5iYXNlLmRldGFjaCgpO1xuICAgICAgICB0aGlzLmFjdGl2YXRlZCA9IGZhbHNlO1xuICAgICAgICB0aGlzLmNvbXBsZXRpb25zID0gdGhpcy5iYXNlID0gbnVsbDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBJbXBsZW1lbnRhdGlvbiBvZiB0aGUgQ29tcGxldGVyIGludGVyZmFjZS5cbiAgICAgKi9cbiAgICBwdWJsaWMgZ29Ubyh3aGVyZTogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIHZhciByb3cgPSB0aGlzLnBvcHVwLmdldFJvdygpO1xuICAgICAgICB2YXIgbWF4ID0gdGhpcy5wb3B1cC5nZXRMZW5ndGgoKSAtIDE7XG5cbiAgICAgICAgc3dpdGNoICh3aGVyZSkge1xuICAgICAgICAgICAgY2FzZSBcInVwXCI6IHJvdyA9IHJvdyA8PSAwID8gbWF4IDogcm93IC0gMTsgYnJlYWs7XG4gICAgICAgICAgICBjYXNlIFwiZG93blwiOiByb3cgPSByb3cgPj0gbWF4ID8gLTEgOiByb3cgKyAxOyBicmVhaztcbiAgICAgICAgICAgIGNhc2UgXCJzdGFydFwiOiByb3cgPSAwOyBicmVhaztcbiAgICAgICAgICAgIGNhc2UgXCJlbmRcIjogcm93ID0gbWF4OyBicmVhaztcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMucG9wdXAuc2V0Um93KHJvdyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogSW1wbGVtZW50YXRpb24gb2YgdGhlIENvbXBsZXRlciBpbnRlcmZhY2UuXG4gICAgICovXG4gICAgcHVibGljIGdldENvbXBsZXRpb25zKGVkaXRvcjogRWRpdG9yLCBzZXNzaW9uOiBFZGl0U2Vzc2lvbiwgcG9zOiBQb3NpdGlvbiwgcHJlZml4OiBzdHJpbmcsIGNhbGxiYWNrKSB7XG5cbiAgICAgICAgdGhpcy5iYXNlID0gbmV3IEFuY2hvcihzZXNzaW9uLmRvYywgcG9zLnJvdywgcG9zLmNvbHVtbiAtIHByZWZpeC5sZW5ndGgpO1xuXG4gICAgICAgIHZhciBtYXRjaGVzOiBDb21wbGV0aW9uW10gPSBbXTtcbiAgICAgICAgdmFyIHRvdGFsID0gZWRpdG9yLmNvbXBsZXRlcnMubGVuZ3RoO1xuICAgICAgICBlZGl0b3IuY29tcGxldGVycy5mb3JFYWNoKGZ1bmN0aW9uKGNvbXBsZXRlcjogQ29tcGxldGVyLCBpbmRleDogbnVtYmVyKSB7XG4gICAgICAgICAgICBjb21wbGV0ZXIuZ2V0Q29tcGxldGlvbnMoZWRpdG9yLCBzZXNzaW9uLCBwb3MsIHByZWZpeCwgZnVuY3Rpb24oZXJyLCByZXN1bHRzOiBDb21wbGV0aW9uW10pIHtcbiAgICAgICAgICAgICAgICBpZiAoIWVycilcbiAgICAgICAgICAgICAgICAgICAgbWF0Y2hlcyA9IG1hdGNoZXMuY29uY2F0KHJlc3VsdHMpO1xuICAgICAgICAgICAgICAgIC8vIEZldGNoIHByZWZpeCBhZ2FpbiwgYmVjYXVzZSB0aGV5IG1heSBoYXZlIGNoYW5nZWQgYnkgbm93XG4gICAgICAgICAgICAgICAgdmFyIHBvczogUG9zaXRpb24gPSBlZGl0b3IuZ2V0Q3Vyc29yUG9zaXRpb24oKTtcbiAgICAgICAgICAgICAgICB2YXIgbGluZSA9IHNlc3Npb24uZ2V0TGluZShwb3Mucm93KTtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCB7XG4gICAgICAgICAgICAgICAgICAgIHByZWZpeDogcmV0cmlldmVQcmVjZWRpbmdJZGVudGlmaWVyKGxpbmUsIHBvcy5jb2x1bW4sIHJlc3VsdHNbMF0gJiYgcmVzdWx0c1swXS5pZGVudGlmaWVyUmVnZXgpLFxuICAgICAgICAgICAgICAgICAgICBtYXRjaGVzOiBtYXRjaGVzLFxuICAgICAgICAgICAgICAgICAgICBmaW5pc2hlZDogKC0tdG90YWwgPT09IDApXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIHByaXZhdGUgdXBkYXRlQ29tcGxldGlvbnMoa2VlcFBvcHVwUG9zaXRpb246IGJvb2xlYW4pOiB2b2lkIHtcbiAgICAgICAgdmFyIHBvcyA9IHRoaXMuZWRpdG9yLmdldEN1cnNvclBvc2l0aW9uKCk7XG4gICAgICAgIHZhciBwcmVmaXg6IHN0cmluZztcbiAgICAgICAgaWYgKGtlZXBQb3B1cFBvc2l0aW9uICYmIHRoaXMuYmFzZSAmJiB0aGlzLmNvbXBsZXRpb25zKSB7XG4gICAgICAgICAgICB2YXIgcmFuZ2UgPSBuZXcgUmFuZ2UodGhpcy5iYXNlLnJvdywgdGhpcy5iYXNlLmNvbHVtbiwgcG9zLnJvdywgcG9zLmNvbHVtbik7XG4gICAgICAgICAgICBwcmVmaXggPSB0aGlzLmVkaXRvci5nZXRTZXNzaW9uKCkuZ2V0VGV4dFJhbmdlKHJhbmdlKTtcbiAgICAgICAgICAgIGlmIChwcmVmaXggPT0gdGhpcy5jb21wbGV0aW9ucy5maWx0ZXJUZXh0KVxuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIHRoaXMuY29tcGxldGlvbnMuc2V0RmlsdGVyKHByZWZpeCk7XG4gICAgICAgICAgICBpZiAoIXRoaXMuY29tcGxldGlvbnMuZmlsdGVyZWQubGVuZ3RoKVxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRldGFjaCgpO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5jb21wbGV0aW9ucy5maWx0ZXJlZC5sZW5ndGggPT0gMSAmJiB0aGlzLmNvbXBsZXRpb25zLmZpbHRlcmVkWzBdLnZhbHVlID09IHByZWZpeCAmJiAhdGhpcy5jb21wbGV0aW9ucy5maWx0ZXJlZFswXS5zbmlwcGV0KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGV0YWNoKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMub3BlblBvcHVwKHRoaXMuZWRpdG9yLCBwcmVmaXgsIGtlZXBQb3B1cFBvc2l0aW9uKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIC8vIFNhdmUgY3VycmVudCBnYXRoZXJDb21wbGV0aW9ucyBzZXNzaW9uLCBzZXNzaW9uIGlzIGNsb3NlIHdoZW4gYSBtYXRjaCBpcyBpbnNlcnRcbiAgICAgICAgICAgIHZhciBfaWQgPSB0aGlzLmdhdGhlckNvbXBsZXRpb25zSWQ7XG4gICAgICAgICAgICB2YXIgZWRpdG9yID0gdGhpcy5lZGl0b3I7XG4gICAgICAgICAgICB2YXIgc2Vzc2lvbiA9IGVkaXRvci5nZXRTZXNzaW9uKCk7XG4gICAgICAgICAgICB2YXIgbGluZSA9IHNlc3Npb24uZ2V0TGluZShwb3Mucm93KTtcbiAgICAgICAgICAgIHByZWZpeCA9IHJldHJpZXZlUHJlY2VkaW5nSWRlbnRpZmllcihsaW5lLCBwb3MuY29sdW1uKTtcbiAgICAgICAgICAgIHRoaXMuZ2V0Q29tcGxldGlvbnModGhpcy5lZGl0b3IsIHNlc3Npb24sIHRoaXMuZWRpdG9yLmdldEN1cnNvclBvc2l0aW9uKCksIHByZWZpeCwgZnVuY3Rpb24oZXJyLCByZXN1bHRzOiB7IHByZWZpeDogc3RyaW5nOyBtYXRjaGVzOiBDb21wbGV0aW9uW107IGZpbmlzaGVkOiBib29sZWFuIH0pIHtcbiAgICAgICAgICAgICAgICAvLyBPbmx5IGRldGFjaCBpZiByZXN1bHQgZ2F0aGVyaW5nIGlzIGZpbmlzaGVkXG4gICAgICAgICAgICAgICAgdmFyIGRldGFjaElmRmluaXNoZWQgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXN1bHRzLmZpbmlzaGVkKSByZXR1cm47XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRldGFjaCgpO1xuICAgICAgICAgICAgICAgIH0uYmluZCh0aGlzKTtcblxuICAgICAgICAgICAgICAgIHZhciBwcmVmaXggPSByZXN1bHRzLnByZWZpeDtcbiAgICAgICAgICAgICAgICB2YXIgbWF0Y2hlcyA9IHJlc3VsdHMgJiYgcmVzdWx0cy5tYXRjaGVzO1xuXG4gICAgICAgICAgICAgICAgaWYgKCFtYXRjaGVzIHx8ICFtYXRjaGVzLmxlbmd0aClcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRldGFjaElmRmluaXNoZWQoKTtcbiAgICBcbiAgICAgICAgICAgICAgICAvLyBXcm9uZyBwcmVmaXggb3Igd3Jvbmcgc2Vzc2lvbiAtPiBpZ25vcmVcbiAgICAgICAgICAgICAgICBpZiAocHJlZml4LmluZGV4T2YocmVzdWx0cy5wcmVmaXgpICE9PSAwIHx8IF9pZCAhPSB0aGlzLmdhdGhlckNvbXBsZXRpb25zSWQpXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICAgICAgICAgIHRoaXMuY29tcGxldGlvbnMgPSBuZXcgQ29tcGxldGlvbkxpc3QobWF0Y2hlcyk7XG4gICAgICAgICAgICAgICAgdGhpcy5jb21wbGV0aW9ucy5zZXRGaWx0ZXIocHJlZml4KTtcbiAgICAgICAgICAgICAgICB2YXIgZmlsdGVyZWQgPSB0aGlzLmNvbXBsZXRpb25zLmZpbHRlcmVkO1xuICAgIFxuICAgICAgICAgICAgICAgIC8vIE5vIHJlc3VsdHNcbiAgICAgICAgICAgICAgICBpZiAoIWZpbHRlcmVkLmxlbmd0aClcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRldGFjaElmRmluaXNoZWQoKTtcbiAgICBcbiAgICAgICAgICAgICAgICAvLyBPbmUgcmVzdWx0IGVxdWFscyB0byB0aGUgcHJlZml4XG4gICAgICAgICAgICAgICAgaWYgKGZpbHRlcmVkLmxlbmd0aCA9PSAxICYmIGZpbHRlcmVkWzBdLnZhbHVlID09IHByZWZpeCAmJiAhZmlsdGVyZWRbMF0uc25pcHBldClcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRldGFjaElmRmluaXNoZWQoKTtcbiAgICBcbiAgICAgICAgICAgICAgICAvLyBBdXRvaW5zZXJ0IGlmIG9uZSByZXN1bHRcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5hdXRvSW5zZXJ0ICYmIGZpbHRlcmVkLmxlbmd0aCA9PSAxKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5pbnNlcnRNYXRjaChmaWx0ZXJlZFswXSk7XG5cbiAgICAgICAgICAgICAgICB0aGlzLm9wZW5Qb3B1cCh0aGlzLmVkaXRvciwgcHJlZml4LCBrZWVwUG9wdXBQb3NpdGlvbik7XG4gICAgICAgICAgICB9LmJpbmQodGhpcykpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSBvcGVuUG9wdXAoZWRpdG9yOiBFZGl0b3IsIHByZWZpeDogc3RyaW5nLCBrZWVwUG9wdXBQb3NpdGlvbjogYm9vbGVhbikge1xuICAgICAgICBpZiAoIXRoaXMucG9wdXApIHtcbiAgICAgICAgICAgIHRoaXMucG9wdXAgPSBuZXcgTGlzdFZpZXdQb3B1cChkb2N1bWVudC5ib2R5IHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudCk7XG4gICAgICAgICAgICB0aGlzLnBvcHVwLm9uKFwiY2xpY2tcIiwgZnVuY3Rpb24oZSkgeyB0aGlzLmluc2VydE1hdGNoKCk7IGUuc3RvcCgpOyB9LmJpbmQodGhpcykpO1xuICAgICAgICAgICAgdGhpcy5wb3B1cC5mb2N1cyA9IHRoaXMuZWRpdG9yLmZvY3VzLmJpbmQodGhpcy5lZGl0b3IpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5wb3B1cC5zZXREYXRhKHRoaXMuY29tcGxldGlvbnMuZmlsdGVyZWQpO1xuXG4gICAgICAgIHRoaXMucG9wdXAuc2V0Um93KHRoaXMuYXV0b1NlbGVjdCA/IDAgOiAtMSk7XG5cbiAgICAgICAgaWYgKCFrZWVwUG9wdXBQb3NpdGlvbikge1xuICAgICAgICAgICAgLy8gRklYTUU6IFNlZW1zIGxpa2Ugd2UgY2FuIGRvIGJldHRlciBieSB1c2luZyBhIGNhY2hlZCB0aGVtZT9cbiAgICAgICAgICAgIC8vdGhpcy5wb3B1cC5pbXBvcnRUaGVtZUxpbmsoZWRpdG9yLmdldFRoZW1lKCkpXG4gICAgICAgICAgICAvLyAgICAudGhlbihmdW5jdGlvbih0aGVtZTogVGhlbWVMaW5rKSB7XG4gICAgICAgICAgICAvLyAgICAgICAgY29uc29sZS53YXJuKFwiVE9ETzogSGFuZGxlIHRoZW1lIGluIHBvcG9wLlwiKVxuICAgICAgICAgICAgLy8gICAgfSlcbiAgICAgICAgICAgIC8vICAgIC5jYXRjaChmdW5jdGlvbihyZWFzb24pIHtcbiAgICAgICAgICAgIC8vICAgICAgICBjb25zb2xlLndhcm4oYHBvcHVwLmltcG9ydFRoZW1lTGluayBmYWlsZWQuIFJlYXNvbjogJHtyZWFzb259YCk7XG4gICAgICAgICAgICAvLyAgICB9KTtcbiAgICAgICAgICAgIHRoaXMucG9wdXAuc2V0Rm9udFNpemUoZWRpdG9yLmdldEZvbnRTaXplKCkpO1xuXG4gICAgICAgICAgICB2YXIgbGluZUhlaWdodCA9IGVkaXRvci5yZW5kZXJlci5sYXllckNvbmZpZy5saW5lSGVpZ2h0O1xuXG4gICAgICAgICAgICB2YXIgcG9zOiB7IGxlZnQ6IG51bWJlcjsgdG9wOiBudW1iZXIgfSA9IGVkaXRvci5yZW5kZXJlci4kY3Vyc29yTGF5ZXIuZ2V0UGl4ZWxQb3NpdGlvbih0aGlzLmJhc2UsIHRydWUpO1xuICAgICAgICAgICAgcG9zLmxlZnQgLT0gdGhpcy5wb3B1cC5nZXRUZXh0TGVmdE9mZnNldCgpO1xuXG4gICAgICAgICAgICB2YXIgcmVjdCA9IGVkaXRvci5jb250YWluZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgICAgICAgICBwb3MudG9wICs9IHJlY3QudG9wIC0gZWRpdG9yLnJlbmRlcmVyLmxheWVyQ29uZmlnLm9mZnNldDtcbiAgICAgICAgICAgIHBvcy5sZWZ0ICs9IHJlY3QubGVmdCAtIGVkaXRvci5yZW5kZXJlci5zY3JvbGxMZWZ0O1xuICAgICAgICAgICAgcG9zLmxlZnQgKz0gZWRpdG9yLnJlbmRlcmVyLiRndXR0ZXJMYXllci5ndXR0ZXJXaWR0aDtcblxuICAgICAgICAgICAgdGhpcy5wb3B1cC5zaG93KHBvcywgbGluZUhlaWdodCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGNoYW5nZUxpc3RlbmVyKGUpIHtcbiAgICAgICAgdmFyIGN1cnNvciA9IHRoaXMuZWRpdG9yLnNlbGVjdGlvbi5sZWFkO1xuICAgICAgICBpZiAoY3Vyc29yLnJvdyAhPSB0aGlzLmJhc2Uucm93IHx8IGN1cnNvci5jb2x1bW4gPCB0aGlzLmJhc2UuY29sdW1uKSB7XG4gICAgICAgICAgICB0aGlzLmRldGFjaCgpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmFjdGl2YXRlZClcbiAgICAgICAgICAgIHRoaXMuY2hhbmdlVGltZXIuc2NoZWR1bGUoKTtcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgdGhpcy5kZXRhY2goKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGJsdXJMaXN0ZW5lcigpIHtcbiAgICAgICAgLy8gd2UgaGF2ZSB0byBjaGVjayBpZiBhY3RpdmVFbGVtZW50IGlzIGEgY2hpbGQgb2YgcG9wdXAgYmVjYXVzZVxuICAgICAgICAvLyBvbiBJRSBwcmV2ZW50RGVmYXVsdCBkb2Vzbid0IHN0b3Agc2Nyb2xsYmFyIGZyb20gYmVpbmcgZm9jdXNzZWRcbiAgICAgICAgdmFyIGVsID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDtcbiAgICAgICAgaWYgKGVsICE9IHRoaXMuZWRpdG9yLnRleHRJbnB1dC5nZXRFbGVtZW50KCkgJiYgZWwucGFyZW50Tm9kZSAhPSB0aGlzLnBvcHVwLmNvbnRhaW5lcikge1xuICAgICAgICAgICAgdGhpcy5kZXRhY2goKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgbW91c2Vkb3duTGlzdGVuZXIoZSkge1xuICAgICAgICB0aGlzLmRldGFjaCgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgbW91c2V3aGVlbExpc3RlbmVyKGUpIHtcbiAgICAgICAgdGhpcy5kZXRhY2goKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2hvd1BvcHVwID0gZnVuY3Rpb24oZWRpdG9yOiBFZGl0b3IpIHtcblxuICAgICAgICBpZiAodGhpcy5lZGl0b3IpIHtcbiAgICAgICAgICAgIHRoaXMuZGV0YWNoKCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmFjdGl2YXRlZCA9IHRydWU7XG5cbiAgICAgICAgdGhpcy5lZGl0b3IgPSBlZGl0b3I7XG5cbiAgICAgICAgaWYgKGdldENvbXBsZXRlcihlZGl0b3IpICE9IHRoaXMpIHtcbiAgICAgICAgICAgIGlmIChnZXRDb21wbGV0ZXIoZWRpdG9yKSkge1xuICAgICAgICAgICAgICAgIGdldENvbXBsZXRlcihlZGl0b3IpLmRldGFjaCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc2V0Q29tcGxldGVyKGVkaXRvciwgdGhpcyk7XG4gICAgICAgIH1cblxuICAgICAgICBlZGl0b3Iua2V5QmluZGluZy5hZGRLZXlib2FyZEhhbmRsZXIodGhpcy5rZXlib2FyZEhhbmRsZXIpO1xuICAgICAgICBlZGl0b3Iub24oXCJjaGFuZ2VTZWxlY3Rpb25cIiwgdGhpcy5jaGFuZ2VMaXN0ZW5lcik7XG4gICAgICAgIGVkaXRvci5vbihcImJsdXJcIiwgdGhpcy5ibHVyTGlzdGVuZXIpO1xuICAgICAgICBlZGl0b3Iub24oXCJtb3VzZWRvd25cIiwgdGhpcy5tb3VzZWRvd25MaXN0ZW5lcik7XG4gICAgICAgIGVkaXRvci5vbihcIm1vdXNld2hlZWxcIiwgdGhpcy5tb3VzZXdoZWVsTGlzdGVuZXIpO1xuXG4gICAgICAgIHRoaXMudXBkYXRlQ29tcGxldGlvbnMoKTtcbiAgICB9XG4gICAgcHVibGljIGNhbmNlbENvbnRleHRNZW51KCkge1xuICAgICAgICB0aGlzLmVkaXRvci5jYW5jZWxNb3VzZUNvbnRleHRNZW51KCk7XG4gICAgfVxufVxuXG4vLyBUT0RPOiBTaG91bGQgd2UgaW1wbGVtZW50IENvbXBsZXRlciBvciBpcyBpdCByZWFsbHkganVzdCBpbXBsZW1lbnRhdGlvbj9cbmV4cG9ydCBjbGFzcyBBdXRvY29tcGxldGUge1xuICAgIHN0YXRpYyBzdGFydENvbW1hbmQgPSB7XG4gICAgICAgIG5hbWU6IFwic3RhcnRBdXRvY29tcGxldGVcIixcbiAgICAgICAgZXhlYzogZnVuY3Rpb24oZWRpdG9yOiBFZGl0b3IpIHtcbiAgICAgICAgICAgIHZhciBhZ2dyZWdhdGU6IENvbXBsZXRlckFnZ3JlZ2F0ZSA9IGdldENvbXBsZXRlcihlZGl0b3IpO1xuICAgICAgICAgICAgaWYgKCFhZ2dyZWdhdGUpIHtcbiAgICAgICAgICAgICAgICBhZ2dyZWdhdGUgPSBuZXcgQ29tcGxldGVyQWdncmVnYXRlKGVkaXRvcik7XG4gICAgICAgICAgICAgICAgc2V0Q29tcGxldGVyKGVkaXRvciwgYWdncmVnYXRlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGFnZ3JlZ2F0ZS5hdXRvSW5zZXJ0ID0gdHJ1ZTtcbiAgICAgICAgICAgIGFnZ3JlZ2F0ZS5hdXRvU2VsZWN0ID0gdHJ1ZTtcbiAgICAgICAgICAgIGFnZ3JlZ2F0ZS5zaG93UG9wdXAoZWRpdG9yKTtcbiAgICAgICAgICAgIC8vIG5lZWRlZCBmb3IgZmlyZWZveCBvbiBtYWNcbiAgICAgICAgICAgIGFnZ3JlZ2F0ZS5jYW5jZWxDb250ZXh0TWVudSgpO1xuICAgICAgICB9LFxuICAgICAgICBiaW5kS2V5OiBcIkN0cmwtU3BhY2V8Q3RybC1TaGlmdC1TcGFjZXxBbHQtU3BhY2VcIlxuICAgIH07XG59XG4iXX0=