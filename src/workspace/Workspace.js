import EditorPosition from './EditorPosition';
export default class Workspace {
    constructor() {
        this.editors = {};
        this.refMarkers = [];
        this.errorMarkers = [];
        console.log("Workspace constructor");
    }
    putEditor(fileName, editor) {
        this.editors[fileName] = editor;
    }
    editScript(fileName, start, end, text) {
        console.log(`Workspace.editScript(${fileName}) (TODO)`);
    }
    getCompletionsAtPosition(fileName, position, memberMode) {
        throw new Error("TODO");
    }
    updateWorkspaceFile(fileName, delta) {
        var editor = this.editors[fileName];
        var action = delta.action;
        var range = delta.range;
        var end;
        var start = EditorPosition.getPositionChars(editor, range.start);
        if (action === "insertText") {
            this.editScript(fileName, start, start, delta.text);
        }
        else if (action === "removeText") {
            end = start + delta.text.length;
            this.editScript(fileName, start, end, "");
        }
        else if (action === "insertLines") {
            var text = delta.lines.map(function (line) { return line + '\n'; }).join('');
            this.editScript(fileName, start, start, text);
        }
        else if (action === "removeLines") {
            var len = EditorPosition.getLinesChars(delta.lines);
            end = start + len;
            this.editScript(fileName, start, end, "");
        }
        else {
            console.warn(`updateWorkspaceFile(${fileName}, ${JSON.stringify(delta)})`);
        }
    }
    updateMarkerModels(fileName, delta) {
        var editor = this.editors[fileName];
        var action = delta.action;
        var range = delta.range;
        var markers = editor.getSession().getMarkers(true);
        var line_count = 0;
        var isNewLine = editor.getSession().getDocument().isNewLine;
        if (action === "insertText") {
            if (isNewLine(delta.text)) {
                line_count = 1;
            }
        }
        else if (action === "insertLines") {
            line_count = delta.lines.length;
        }
        else if (action === "removeText") {
            if (isNewLine(delta.text)) {
                line_count = -1;
            }
        }
        else if (action === "removeLines") {
            line_count = -delta.lines.length;
        }
        else {
            console.warn(`updateMarkerModels(${fileName}, ${JSON.stringify(delta)})`);
        }
        if (line_count !== 0) {
            var markerUpdate = function (id) {
                var marker = markers[id];
                var row = range.start.row;
                if (line_count > 0) {
                    row = +1;
                }
                if (marker && marker.range.start.row > row) {
                    marker.range.start.row += line_count;
                    marker.range.end.row += line_count;
                }
            };
            this.errorMarkers.forEach(markerUpdate);
            this.refMarkers.forEach(markerUpdate);
            editor.updateFrontMarkers();
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV29ya3NwYWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiV29ya3NwYWNlLnRzIl0sIm5hbWVzIjpbIldvcmtzcGFjZSIsIldvcmtzcGFjZS5jb25zdHJ1Y3RvciIsIldvcmtzcGFjZS5wdXRFZGl0b3IiLCJXb3Jrc3BhY2UuZWRpdFNjcmlwdCIsIldvcmtzcGFjZS5nZXRDb21wbGV0aW9uc0F0UG9zaXRpb24iLCJXb3Jrc3BhY2UudXBkYXRlV29ya3NwYWNlRmlsZSIsIldvcmtzcGFjZS51cGRhdGVNYXJrZXJNb2RlbHMiXSwibWFwcGluZ3MiOiJPQUdPLGNBQWMsTUFBTSxrQkFBa0I7QUFFN0M7SUFNSUE7UUFKUUMsWUFBT0EsR0FBbUNBLEVBQUVBLENBQUNBO1FBQzdDQSxlQUFVQSxHQUFhQSxFQUFFQSxDQUFDQTtRQUMxQkEsaUJBQVlBLEdBQWFBLEVBQUVBLENBQUNBO1FBR2hDQSxPQUFPQSxDQUFDQSxHQUFHQSxDQUFDQSx1QkFBdUJBLENBQUNBLENBQUNBO0lBQ3pDQSxDQUFDQTtJQUVERCxTQUFTQSxDQUFDQSxRQUFnQkEsRUFBRUEsTUFBY0E7UUFDdENFLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLFFBQVFBLENBQUNBLEdBQUdBLE1BQU1BLENBQUNBO0lBQ3BDQSxDQUFDQTtJQUVERixVQUFVQSxDQUFDQSxRQUFnQkEsRUFBRUEsS0FBYUEsRUFBRUEsR0FBV0EsRUFBRUEsSUFBWUE7UUFDakVHLE9BQU9BLENBQUNBLEdBQUdBLENBQUNBLHdCQUF3QkEsUUFBUUEsVUFBVUEsQ0FBQ0EsQ0FBQ0E7SUFDNURBLENBQUNBO0lBRURILHdCQUF3QkEsQ0FBQ0EsUUFBZ0JBLEVBQUVBLFFBQWdCQSxFQUFFQSxVQUFtQkE7UUFDNUVJLE1BQU1BLElBQUlBLEtBQUtBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBO0lBQzVCQSxDQUFDQTtJQUtESixtQkFBbUJBLENBQUNBLFFBQWdCQSxFQUFFQSxLQUFZQTtRQUM5Q0ssSUFBSUEsTUFBTUEsR0FBR0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0E7UUFDcENBLElBQUlBLE1BQU1BLEdBQUdBLEtBQUtBLENBQUNBLE1BQU1BLENBQUNBO1FBQzFCQSxJQUFJQSxLQUFLQSxHQUFHQSxLQUFLQSxDQUFDQSxLQUFLQSxDQUFDQTtRQUN4QkEsSUFBSUEsR0FBV0EsQ0FBQ0E7UUFDaEJBLElBQUlBLEtBQUtBLEdBQVdBLGNBQWNBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsTUFBTUEsRUFBRUEsS0FBS0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0E7UUFDekVBLEVBQUVBLENBQUNBLENBQUNBLE1BQU1BLEtBQUtBLFlBQVlBLENBQUNBLENBQUNBLENBQUNBO1lBQzFCQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxRQUFRQSxFQUFFQSxLQUFLQSxFQUFFQSxLQUFLQSxFQUFFQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUN4REEsQ0FBQ0E7UUFDREEsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsS0FBS0EsWUFBWUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDL0JBLEdBQUdBLEdBQUdBLEtBQUtBLEdBQUdBLEtBQUtBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBO1lBQ2hDQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxRQUFRQSxFQUFFQSxLQUFLQSxFQUFFQSxHQUFHQSxFQUFFQSxFQUFFQSxDQUFDQSxDQUFDQTtRQUM5Q0EsQ0FBQ0E7UUFDREEsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsS0FBS0EsYUFBYUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDaENBLElBQUlBLElBQUlBLEdBQUdBLEtBQUtBLENBQUNBLEtBQUtBLENBQUNBLEdBQUdBLENBQUNBLFVBQVNBLElBQUlBLElBQUksTUFBTSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUNBLENBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBO1lBQzVFQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxRQUFRQSxFQUFFQSxLQUFLQSxFQUFFQSxLQUFLQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUNsREEsQ0FBQ0E7UUFDREEsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsS0FBS0EsYUFBYUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDaENBLElBQUlBLEdBQUdBLEdBQUdBLGNBQWNBLENBQUNBLGFBQWFBLENBQUNBLEtBQUtBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBO1lBQ3BEQSxHQUFHQSxHQUFHQSxLQUFLQSxHQUFHQSxHQUFHQSxDQUFDQTtZQUNsQkEsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsUUFBUUEsRUFBRUEsS0FBS0EsRUFBRUEsR0FBR0EsRUFBRUEsRUFBRUEsQ0FBQ0EsQ0FBQ0E7UUFDOUNBLENBQUNBO1FBQ0RBLElBQUlBLENBQUNBLENBQUNBO1lBQ0ZBLE9BQU9BLENBQUNBLElBQUlBLENBQUNBLHVCQUF1QkEsUUFBUUEsS0FBS0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDL0VBLENBQUNBO0lBQ0xBLENBQUNBO0lBRURMLGtCQUFrQkEsQ0FBQ0EsUUFBZ0JBLEVBQUVBLEtBQVlBO1FBQzdDTSxJQUFJQSxNQUFNQSxHQUFHQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQTtRQUNwQ0EsSUFBSUEsTUFBTUEsR0FBR0EsS0FBS0EsQ0FBQ0EsTUFBTUEsQ0FBQ0E7UUFDMUJBLElBQUlBLEtBQUtBLEdBQUdBLEtBQUtBLENBQUNBLEtBQUtBLENBQUNBO1FBQ3hCQSxJQUFJQSxPQUFPQSxHQUFHQSxNQUFNQSxDQUFDQSxVQUFVQSxFQUFFQSxDQUFDQSxVQUFVQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUNuREEsSUFBSUEsVUFBVUEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDbkJBLElBQUlBLFNBQVNBLEdBQUdBLE1BQU1BLENBQUNBLFVBQVVBLEVBQUVBLENBQUNBLFdBQVdBLEVBQUVBLENBQUNBLFNBQVNBLENBQUNBO1FBQzVEQSxFQUFFQSxDQUFDQSxDQUFDQSxNQUFNQSxLQUFLQSxZQUFZQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUMxQkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ3hCQSxVQUFVQSxHQUFHQSxDQUFDQSxDQUFDQTtZQUNuQkEsQ0FBQ0E7UUFDTEEsQ0FBQ0E7UUFDREEsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsS0FBS0EsYUFBYUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDaENBLFVBQVVBLEdBQUdBLEtBQUtBLENBQUNBLEtBQUtBLENBQUNBLE1BQU1BLENBQUNBO1FBQ3BDQSxDQUFDQTtRQUNEQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxNQUFNQSxLQUFLQSxZQUFZQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUMvQkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ3hCQSxVQUFVQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNwQkEsQ0FBQ0E7UUFDTEEsQ0FBQ0E7UUFDREEsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsS0FBS0EsYUFBYUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDaENBLFVBQVVBLEdBQUdBLENBQUNBLEtBQUtBLENBQUNBLEtBQUtBLENBQUNBLE1BQU1BLENBQUNBO1FBQ3JDQSxDQUFDQTtRQUNEQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUNGQSxPQUFPQSxDQUFDQSxJQUFJQSxDQUFDQSxzQkFBc0JBLFFBQVFBLEtBQUtBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLEtBQUtBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO1FBQzlFQSxDQUFDQTtRQUNEQSxFQUFFQSxDQUFDQSxDQUFDQSxVQUFVQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNuQkEsSUFBSUEsWUFBWUEsR0FBR0EsVUFBU0EsRUFBVUE7Z0JBQ2xDLElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDekIsSUFBSSxHQUFHLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUM7Z0JBQzFCLEVBQUUsQ0FBQyxDQUFDLFVBQVUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUNqQixHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBQ2IsQ0FBQztnQkFDRCxFQUFFLENBQUMsQ0FBQyxNQUFNLElBQUksTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUM7b0JBQ3pDLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsSUFBSSxVQUFVLENBQUM7b0JBQ3JDLE1BQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxVQUFVLENBQUM7Z0JBQ3ZDLENBQUM7WUFDTCxDQUFDLENBQUNBO1lBQ0ZBLElBQUlBLENBQUNBLFlBQVlBLENBQUNBLE9BQU9BLENBQUNBLFlBQVlBLENBQUNBLENBQUNBO1lBQ3hDQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxPQUFPQSxDQUFDQSxZQUFZQSxDQUFDQSxDQUFDQTtZQUN0Q0EsTUFBTUEsQ0FBQ0Esa0JBQWtCQSxFQUFFQSxDQUFDQTtRQUNoQ0EsQ0FBQ0E7SUFDTEEsQ0FBQ0E7QUFDTE4sQ0FBQ0E7QUFBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBDb21wbGV0aW9uIGZyb20gJy4uL0NvbXBsZXRpb24nO1xuaW1wb3J0IERlbHRhIGZyb20gJy4uL0RlbHRhJztcbmltcG9ydCBFZGl0b3IgZnJvbSAnLi4vRWRpdG9yJztcbmltcG9ydCBFZGl0b3JQb3NpdGlvbiBmcm9tICcuL0VkaXRvclBvc2l0aW9uJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgV29ya3NwYWNlIHtcblxuICAgIHByaXZhdGUgZWRpdG9yczogeyBbZmlsZU5hbWU6IHN0cmluZ106IEVkaXRvciB9ID0ge307XG4gICAgcHJpdmF0ZSByZWZNYXJrZXJzOiBudW1iZXJbXSA9IFtdO1xuICAgIHByaXZhdGUgZXJyb3JNYXJrZXJzOiBudW1iZXJbXSA9IFtdO1xuXG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiV29ya3NwYWNlIGNvbnN0cnVjdG9yXCIpO1xuICAgIH1cblxuICAgIHB1dEVkaXRvcihmaWxlTmFtZTogc3RyaW5nLCBlZGl0b3I6IEVkaXRvcik6IHZvaWQge1xuICAgICAgICB0aGlzLmVkaXRvcnNbZmlsZU5hbWVdID0gZWRpdG9yO1xuICAgIH1cblxuICAgIGVkaXRTY3JpcHQoZmlsZU5hbWU6IHN0cmluZywgc3RhcnQ6IG51bWJlciwgZW5kOiBudW1iZXIsIHRleHQ6IHN0cmluZykge1xuICAgICAgICBjb25zb2xlLmxvZyhgV29ya3NwYWNlLmVkaXRTY3JpcHQoJHtmaWxlTmFtZX0pIChUT0RPKWApO1xuICAgIH1cblxuICAgIGdldENvbXBsZXRpb25zQXRQb3NpdGlvbihmaWxlTmFtZTogc3RyaW5nLCBwb3NpdGlvbjogbnVtYmVyLCBtZW1iZXJNb2RlOiBib29sZWFuKTogUHJvbWlzZTxDb21wbGV0aW9uW10+IHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiVE9ET1wiKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBVcGRhdGVzIHRoZSBmaWxlIGluIHRoZSB3b3Jrc3BhY2UgdXNpbmcgdGhlIChjYXB0dXJlZCkgZmlsZU5hbWUgYW5kIGNoYW5nZSBldmVudC5cbiAgICAgKi9cbiAgICB1cGRhdGVXb3Jrc3BhY2VGaWxlKGZpbGVOYW1lOiBzdHJpbmcsIGRlbHRhOiBEZWx0YSk6IHZvaWQge1xuICAgICAgICB2YXIgZWRpdG9yID0gdGhpcy5lZGl0b3JzW2ZpbGVOYW1lXTtcbiAgICAgICAgdmFyIGFjdGlvbiA9IGRlbHRhLmFjdGlvbjtcbiAgICAgICAgdmFyIHJhbmdlID0gZGVsdGEucmFuZ2U7XG4gICAgICAgIHZhciBlbmQ6IG51bWJlcjtcbiAgICAgICAgdmFyIHN0YXJ0OiBudW1iZXIgPSBFZGl0b3JQb3NpdGlvbi5nZXRQb3NpdGlvbkNoYXJzKGVkaXRvciwgcmFuZ2Uuc3RhcnQpO1xuICAgICAgICBpZiAoYWN0aW9uID09PSBcImluc2VydFRleHRcIikge1xuICAgICAgICAgICAgdGhpcy5lZGl0U2NyaXB0KGZpbGVOYW1lLCBzdGFydCwgc3RhcnQsIGRlbHRhLnRleHQpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGFjdGlvbiA9PT0gXCJyZW1vdmVUZXh0XCIpIHtcbiAgICAgICAgICAgIGVuZCA9IHN0YXJ0ICsgZGVsdGEudGV4dC5sZW5ndGg7XG4gICAgICAgICAgICB0aGlzLmVkaXRTY3JpcHQoZmlsZU5hbWUsIHN0YXJ0LCBlbmQsIFwiXCIpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGFjdGlvbiA9PT0gXCJpbnNlcnRMaW5lc1wiKSB7XG4gICAgICAgICAgICB2YXIgdGV4dCA9IGRlbHRhLmxpbmVzLm1hcChmdW5jdGlvbihsaW5lKSB7IHJldHVybiBsaW5lICsgJ1xcbic7IH0pLmpvaW4oJycpO1xuICAgICAgICAgICAgdGhpcy5lZGl0U2NyaXB0KGZpbGVOYW1lLCBzdGFydCwgc3RhcnQsIHRleHQpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGFjdGlvbiA9PT0gXCJyZW1vdmVMaW5lc1wiKSB7XG4gICAgICAgICAgICB2YXIgbGVuID0gRWRpdG9yUG9zaXRpb24uZ2V0TGluZXNDaGFycyhkZWx0YS5saW5lcyk7XG4gICAgICAgICAgICBlbmQgPSBzdGFydCArIGxlbjtcbiAgICAgICAgICAgIHRoaXMuZWRpdFNjcmlwdChmaWxlTmFtZSwgc3RhcnQsIGVuZCwgXCJcIik7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oYHVwZGF0ZVdvcmtzcGFjZUZpbGUoJHtmaWxlTmFtZX0sICR7SlNPTi5zdHJpbmdpZnkoZGVsdGEpfSlgKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHVwZGF0ZU1hcmtlck1vZGVscyhmaWxlTmFtZTogc3RyaW5nLCBkZWx0YTogRGVsdGEpOiB2b2lkIHtcbiAgICAgICAgdmFyIGVkaXRvciA9IHRoaXMuZWRpdG9yc1tmaWxlTmFtZV07XG4gICAgICAgIHZhciBhY3Rpb24gPSBkZWx0YS5hY3Rpb247XG4gICAgICAgIHZhciByYW5nZSA9IGRlbHRhLnJhbmdlO1xuICAgICAgICB2YXIgbWFya2VycyA9IGVkaXRvci5nZXRTZXNzaW9uKCkuZ2V0TWFya2Vycyh0cnVlKTtcbiAgICAgICAgdmFyIGxpbmVfY291bnQgPSAwO1xuICAgICAgICB2YXIgaXNOZXdMaW5lID0gZWRpdG9yLmdldFNlc3Npb24oKS5nZXREb2N1bWVudCgpLmlzTmV3TGluZTtcbiAgICAgICAgaWYgKGFjdGlvbiA9PT0gXCJpbnNlcnRUZXh0XCIpIHtcbiAgICAgICAgICAgIGlmIChpc05ld0xpbmUoZGVsdGEudGV4dCkpIHtcbiAgICAgICAgICAgICAgICBsaW5lX2NvdW50ID0gMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChhY3Rpb24gPT09IFwiaW5zZXJ0TGluZXNcIikge1xuICAgICAgICAgICAgbGluZV9jb3VudCA9IGRlbHRhLmxpbmVzLmxlbmd0aDtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChhY3Rpb24gPT09IFwicmVtb3ZlVGV4dFwiKSB7XG4gICAgICAgICAgICBpZiAoaXNOZXdMaW5lKGRlbHRhLnRleHQpKSB7XG4gICAgICAgICAgICAgICAgbGluZV9jb3VudCA9IC0xO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGFjdGlvbiA9PT0gXCJyZW1vdmVMaW5lc1wiKSB7XG4gICAgICAgICAgICBsaW5lX2NvdW50ID0gLWRlbHRhLmxpbmVzLmxlbmd0aDtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihgdXBkYXRlTWFya2VyTW9kZWxzKCR7ZmlsZU5hbWV9LCAke0pTT04uc3RyaW5naWZ5KGRlbHRhKX0pYCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGxpbmVfY291bnQgIT09IDApIHtcbiAgICAgICAgICAgIHZhciBtYXJrZXJVcGRhdGUgPSBmdW5jdGlvbihpZDogbnVtYmVyKSB7XG4gICAgICAgICAgICAgICAgdmFyIG1hcmtlciA9IG1hcmtlcnNbaWRdO1xuICAgICAgICAgICAgICAgIHZhciByb3cgPSByYW5nZS5zdGFydC5yb3c7XG4gICAgICAgICAgICAgICAgaWYgKGxpbmVfY291bnQgPiAwKSB7XG4gICAgICAgICAgICAgICAgICAgIHJvdyA9ICsxO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAobWFya2VyICYmIG1hcmtlci5yYW5nZS5zdGFydC5yb3cgPiByb3cpIHtcbiAgICAgICAgICAgICAgICAgICAgbWFya2VyLnJhbmdlLnN0YXJ0LnJvdyArPSBsaW5lX2NvdW50O1xuICAgICAgICAgICAgICAgICAgICBtYXJrZXIucmFuZ2UuZW5kLnJvdyArPSBsaW5lX2NvdW50O1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgICAgICB0aGlzLmVycm9yTWFya2Vycy5mb3JFYWNoKG1hcmtlclVwZGF0ZSk7XG4gICAgICAgICAgICB0aGlzLnJlZk1hcmtlcnMuZm9yRWFjaChtYXJrZXJVcGRhdGUpO1xuICAgICAgICAgICAgZWRpdG9yLnVwZGF0ZUZyb250TWFya2VycygpO1xuICAgICAgICB9XG4gICAgfVxufSJdfQ==