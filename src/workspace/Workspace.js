import EditorPosition from './EditorPosition';
export default class Workspace {
    constructor() {
        this.editors = {};
        this.refMarkers = [];
        this.errorMarkers = [];
        console.log("Workspace constructor");
    }
    putEditor(fileName, editor) {
        this.editors[fileName] = editor;
    }
    editScript(fileName, start, end, text) {
        console.log(`Workspace.editScript(${fileName}) (TODO)`);
    }
    getCompletionsAtPosition(fileName, position, memberMode) {
        throw new Error("TODO");
    }
    updateWorkspaceFile(fileName, delta) {
        var editor = this.editors[fileName];
        var action = delta.action;
        var range = delta.range;
        var end;
        var start = EditorPosition.getPositionChars(editor, range.start);
        if (action === "insertText") {
            this.editScript(fileName, start, start, delta.text);
        }
        else if (action === "removeText") {
            end = start + delta.text.length;
            this.editScript(fileName, start, end, "");
        }
        else if (action === "insertLines") {
            var text = delta.lines.map(function (line) { return line + '\n'; }).join('');
            this.editScript(fileName, start, start, text);
        }
        else if (action === "removeLines") {
            var len = EditorPosition.getLinesChars(delta.lines);
            end = start + len;
            this.editScript(fileName, start, end, "");
        }
        else {
            console.warn(`updateWorkspaceFile(${fileName}, ${JSON.stringify(delta)})`);
        }
    }
    updateMarkerModels(fileName, delta) {
        var editor = this.editors[fileName];
        var action = delta.action;
        var range = delta.range;
        var markers = editor.getSession().getMarkers(true);
        var line_count = 0;
        var isNewLine = editor.getSession().getDocument().isNewLine;
        if (action === "insertText") {
            if (isNewLine(delta.text)) {
                line_count = 1;
            }
        }
        else if (action === "insertLines") {
            line_count = delta.lines.length;
        }
        else if (action === "removeText") {
            if (isNewLine(delta.text)) {
                line_count = -1;
            }
        }
        else if (action === "removeLines") {
            line_count = -delta.lines.length;
        }
        else {
            console.warn(`updateMarkerModels(${fileName}, ${JSON.stringify(delta)})`);
        }
        if (line_count !== 0) {
            var markerUpdate = function (id) {
                var marker = markers[id];
                var row = range.start.row;
                if (line_count > 0) {
                    row = +1;
                }
                if (marker && marker.range.start.row > row) {
                    marker.range.start.row += line_count;
                    marker.range.end.row += line_count;
                }
            };
            this.errorMarkers.forEach(markerUpdate);
            this.refMarkers.forEach(markerUpdate);
            editor.updateFrontMarkers();
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV29ya3NwYWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiV29ya3NwYWNlLnRzIl0sIm5hbWVzIjpbIldvcmtzcGFjZSIsIldvcmtzcGFjZS5jb25zdHJ1Y3RvciIsIldvcmtzcGFjZS5wdXRFZGl0b3IiLCJXb3Jrc3BhY2UuZWRpdFNjcmlwdCIsIldvcmtzcGFjZS5nZXRDb21wbGV0aW9uc0F0UG9zaXRpb24iLCJXb3Jrc3BhY2UudXBkYXRlV29ya3NwYWNlRmlsZSIsIldvcmtzcGFjZS51cGRhdGVNYXJrZXJNb2RlbHMiXSwibWFwcGluZ3MiOiJPQUlPLGNBQWMsTUFBTSxrQkFBa0I7QUFFN0M7SUFNSUE7UUFKUUMsWUFBT0EsR0FBbUNBLEVBQUVBLENBQUNBO1FBQzdDQSxlQUFVQSxHQUFhQSxFQUFFQSxDQUFDQTtRQUMxQkEsaUJBQVlBLEdBQWFBLEVBQUVBLENBQUNBO1FBR2hDQSxPQUFPQSxDQUFDQSxHQUFHQSxDQUFDQSx1QkFBdUJBLENBQUNBLENBQUNBO0lBQ3pDQSxDQUFDQTtJQUVERCxTQUFTQSxDQUFDQSxRQUFnQkEsRUFBRUEsTUFBY0E7UUFDdENFLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLFFBQVFBLENBQUNBLEdBQUdBLE1BQU1BLENBQUNBO0lBQ3BDQSxDQUFDQTtJQUVERixVQUFVQSxDQUFDQSxRQUFnQkEsRUFBRUEsS0FBYUEsRUFBRUEsR0FBV0EsRUFBRUEsSUFBWUE7UUFDakVHLE9BQU9BLENBQUNBLEdBQUdBLENBQUNBLHdCQUF3QkEsUUFBUUEsVUFBVUEsQ0FBQ0EsQ0FBQ0E7SUFDNURBLENBQUNBO0lBRURILHdCQUF3QkEsQ0FBQ0EsUUFBZ0JBLEVBQUVBLFFBQWdCQSxFQUFFQSxVQUFtQkE7UUFDNUVJLE1BQU1BLElBQUlBLEtBQUtBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBO0lBQzVCQSxDQUFDQTtJQUtESixtQkFBbUJBLENBQUNBLFFBQWdCQSxFQUFFQSxLQUFZQTtRQUM5Q0ssSUFBSUEsTUFBTUEsR0FBR0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0E7UUFDcENBLElBQUlBLE1BQU1BLEdBQUdBLEtBQUtBLENBQUNBLE1BQU1BLENBQUNBO1FBQzFCQSxJQUFJQSxLQUFLQSxHQUFHQSxLQUFLQSxDQUFDQSxLQUFLQSxDQUFDQTtRQUN4QkEsSUFBSUEsR0FBV0EsQ0FBQ0E7UUFDaEJBLElBQUlBLEtBQUtBLEdBQVdBLGNBQWNBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsTUFBTUEsRUFBRUEsS0FBS0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0E7UUFDekVBLEVBQUVBLENBQUNBLENBQUNBLE1BQU1BLEtBQUtBLFlBQVlBLENBQUNBLENBQUNBLENBQUNBO1lBQzFCQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxRQUFRQSxFQUFFQSxLQUFLQSxFQUFFQSxLQUFLQSxFQUFFQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUN4REEsQ0FBQ0E7UUFDREEsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsS0FBS0EsWUFBWUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDL0JBLEdBQUdBLEdBQUdBLEtBQUtBLEdBQUdBLEtBQUtBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBO1lBQ2hDQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxRQUFRQSxFQUFFQSxLQUFLQSxFQUFFQSxHQUFHQSxFQUFFQSxFQUFFQSxDQUFDQSxDQUFDQTtRQUM5Q0EsQ0FBQ0E7UUFDREEsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsS0FBS0EsYUFBYUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDaENBLElBQUlBLElBQUlBLEdBQUdBLEtBQUtBLENBQUNBLEtBQUtBLENBQUNBLEdBQUdBLENBQUNBLFVBQVNBLElBQUlBLElBQUksTUFBTSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUNBLENBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBO1lBQzVFQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxRQUFRQSxFQUFFQSxLQUFLQSxFQUFFQSxLQUFLQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUNsREEsQ0FBQ0E7UUFDREEsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsS0FBS0EsYUFBYUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDaENBLElBQUlBLEdBQUdBLEdBQUdBLGNBQWNBLENBQUNBLGFBQWFBLENBQUNBLEtBQUtBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBO1lBQ3BEQSxHQUFHQSxHQUFHQSxLQUFLQSxHQUFHQSxHQUFHQSxDQUFDQTtZQUNsQkEsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsUUFBUUEsRUFBRUEsS0FBS0EsRUFBRUEsR0FBR0EsRUFBRUEsRUFBRUEsQ0FBQ0EsQ0FBQ0E7UUFDOUNBLENBQUNBO1FBQ0RBLElBQUlBLENBQUNBLENBQUNBO1lBQ0ZBLE9BQU9BLENBQUNBLElBQUlBLENBQUNBLHVCQUF1QkEsUUFBUUEsS0FBS0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDL0VBLENBQUNBO0lBQ0xBLENBQUNBO0lBRURMLGtCQUFrQkEsQ0FBQ0EsUUFBZ0JBLEVBQUVBLEtBQVlBO1FBQzdDTSxJQUFJQSxNQUFNQSxHQUFHQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQTtRQUNwQ0EsSUFBSUEsTUFBTUEsR0FBR0EsS0FBS0EsQ0FBQ0EsTUFBTUEsQ0FBQ0E7UUFDMUJBLElBQUlBLEtBQUtBLEdBQUdBLEtBQUtBLENBQUNBLEtBQUtBLENBQUNBO1FBQ3hCQSxJQUFJQSxPQUFPQSxHQUE2QkEsTUFBTUEsQ0FBQ0EsVUFBVUEsRUFBRUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDN0VBLElBQUlBLFVBQVVBLEdBQUdBLENBQUNBLENBQUNBO1FBQ25CQSxJQUFJQSxTQUFTQSxHQUFHQSxNQUFNQSxDQUFDQSxVQUFVQSxFQUFFQSxDQUFDQSxXQUFXQSxFQUFFQSxDQUFDQSxTQUFTQSxDQUFDQTtRQUM1REEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsS0FBS0EsWUFBWUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDMUJBLEVBQUVBLENBQUNBLENBQUNBLFNBQVNBLENBQUNBLEtBQUtBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO2dCQUN4QkEsVUFBVUEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7WUFDbkJBLENBQUNBO1FBQ0xBLENBQUNBO1FBQ0RBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLE1BQU1BLEtBQUtBLGFBQWFBLENBQUNBLENBQUNBLENBQUNBO1lBQ2hDQSxVQUFVQSxHQUFHQSxLQUFLQSxDQUFDQSxLQUFLQSxDQUFDQSxNQUFNQSxDQUFDQTtRQUNwQ0EsQ0FBQ0E7UUFDREEsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsS0FBS0EsWUFBWUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDL0JBLEVBQUVBLENBQUNBLENBQUNBLFNBQVNBLENBQUNBLEtBQUtBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO2dCQUN4QkEsVUFBVUEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDcEJBLENBQUNBO1FBQ0xBLENBQUNBO1FBQ0RBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLE1BQU1BLEtBQUtBLGFBQWFBLENBQUNBLENBQUNBLENBQUNBO1lBQ2hDQSxVQUFVQSxHQUFHQSxDQUFDQSxLQUFLQSxDQUFDQSxLQUFLQSxDQUFDQSxNQUFNQSxDQUFDQTtRQUNyQ0EsQ0FBQ0E7UUFDREEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDRkEsT0FBT0EsQ0FBQ0EsSUFBSUEsQ0FBQ0Esc0JBQXNCQSxRQUFRQSxLQUFLQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxLQUFLQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQTtRQUM5RUEsQ0FBQ0E7UUFDREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsVUFBVUEsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDbkJBLElBQUlBLFlBQVlBLEdBQUdBLFVBQVNBLEVBQVVBO2dCQUNsQyxJQUFJLE1BQU0sR0FBVyxPQUFPLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ2pDLElBQUksR0FBRyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDO2dCQUMxQixFQUFFLENBQUMsQ0FBQyxVQUFVLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDakIsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUNiLENBQUM7Z0JBQ0QsRUFBRSxDQUFDLENBQUMsTUFBTSxJQUFJLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDO29CQUN6QyxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLElBQUksVUFBVSxDQUFDO29CQUNyQyxNQUFNLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLElBQUksVUFBVSxDQUFDO2dCQUN2QyxDQUFDO1lBQ0wsQ0FBQyxDQUFDQTtZQUNGQSxJQUFJQSxDQUFDQSxZQUFZQSxDQUFDQSxPQUFPQSxDQUFDQSxZQUFZQSxDQUFDQSxDQUFDQTtZQUN4Q0EsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsWUFBWUEsQ0FBQ0EsQ0FBQ0E7WUFDdENBLE1BQU1BLENBQUNBLGtCQUFrQkEsRUFBRUEsQ0FBQ0E7UUFDaENBLENBQUNBO0lBQ0xBLENBQUNBO0FBQ0xOLENBQUNBO0FBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgQ29tcGxldGlvbiBmcm9tICcuLi9Db21wbGV0aW9uJztcbmltcG9ydCBEZWx0YSBmcm9tICcuLi9EZWx0YSc7XG5pbXBvcnQgTWFya2VyIGZyb20gJy4uL01hcmtlcic7XG5pbXBvcnQgRWRpdG9yIGZyb20gJy4uL0VkaXRvcic7XG5pbXBvcnQgRWRpdG9yUG9zaXRpb24gZnJvbSAnLi9FZGl0b3JQb3NpdGlvbic7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFdvcmtzcGFjZSB7XG5cbiAgICBwcml2YXRlIGVkaXRvcnM6IHsgW2ZpbGVOYW1lOiBzdHJpbmddOiBFZGl0b3IgfSA9IHt9O1xuICAgIHByaXZhdGUgcmVmTWFya2VyczogbnVtYmVyW10gPSBbXTtcbiAgICBwcml2YXRlIGVycm9yTWFya2VyczogbnVtYmVyW10gPSBbXTtcblxuICAgIGNvbnN0cnVjdG9yKCkge1xuICAgICAgICBjb25zb2xlLmxvZyhcIldvcmtzcGFjZSBjb25zdHJ1Y3RvclwiKTtcbiAgICB9XG5cbiAgICBwdXRFZGl0b3IoZmlsZU5hbWU6IHN0cmluZywgZWRpdG9yOiBFZGl0b3IpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5lZGl0b3JzW2ZpbGVOYW1lXSA9IGVkaXRvcjtcbiAgICB9XG5cbiAgICBlZGl0U2NyaXB0KGZpbGVOYW1lOiBzdHJpbmcsIHN0YXJ0OiBudW1iZXIsIGVuZDogbnVtYmVyLCB0ZXh0OiBzdHJpbmcpIHtcbiAgICAgICAgY29uc29sZS5sb2coYFdvcmtzcGFjZS5lZGl0U2NyaXB0KCR7ZmlsZU5hbWV9KSAoVE9ETylgKTtcbiAgICB9XG5cbiAgICBnZXRDb21wbGV0aW9uc0F0UG9zaXRpb24oZmlsZU5hbWU6IHN0cmluZywgcG9zaXRpb246IG51bWJlciwgbWVtYmVyTW9kZTogYm9vbGVhbik6IFByb21pc2U8Q29tcGxldGlvbltdPiB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcIlRPRE9cIik7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVXBkYXRlcyB0aGUgZmlsZSBpbiB0aGUgd29ya3NwYWNlIHVzaW5nIHRoZSAoY2FwdHVyZWQpIGZpbGVOYW1lIGFuZCBjaGFuZ2UgZXZlbnQuXG4gICAgICovXG4gICAgdXBkYXRlV29ya3NwYWNlRmlsZShmaWxlTmFtZTogc3RyaW5nLCBkZWx0YTogRGVsdGEpOiB2b2lkIHtcbiAgICAgICAgdmFyIGVkaXRvciA9IHRoaXMuZWRpdG9yc1tmaWxlTmFtZV07XG4gICAgICAgIHZhciBhY3Rpb24gPSBkZWx0YS5hY3Rpb247XG4gICAgICAgIHZhciByYW5nZSA9IGRlbHRhLnJhbmdlO1xuICAgICAgICB2YXIgZW5kOiBudW1iZXI7XG4gICAgICAgIHZhciBzdGFydDogbnVtYmVyID0gRWRpdG9yUG9zaXRpb24uZ2V0UG9zaXRpb25DaGFycyhlZGl0b3IsIHJhbmdlLnN0YXJ0KTtcbiAgICAgICAgaWYgKGFjdGlvbiA9PT0gXCJpbnNlcnRUZXh0XCIpIHtcbiAgICAgICAgICAgIHRoaXMuZWRpdFNjcmlwdChmaWxlTmFtZSwgc3RhcnQsIHN0YXJ0LCBkZWx0YS50ZXh0KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChhY3Rpb24gPT09IFwicmVtb3ZlVGV4dFwiKSB7XG4gICAgICAgICAgICBlbmQgPSBzdGFydCArIGRlbHRhLnRleHQubGVuZ3RoO1xuICAgICAgICAgICAgdGhpcy5lZGl0U2NyaXB0KGZpbGVOYW1lLCBzdGFydCwgZW5kLCBcIlwiKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChhY3Rpb24gPT09IFwiaW5zZXJ0TGluZXNcIikge1xuICAgICAgICAgICAgdmFyIHRleHQgPSBkZWx0YS5saW5lcy5tYXAoZnVuY3Rpb24obGluZSkgeyByZXR1cm4gbGluZSArICdcXG4nOyB9KS5qb2luKCcnKTtcbiAgICAgICAgICAgIHRoaXMuZWRpdFNjcmlwdChmaWxlTmFtZSwgc3RhcnQsIHN0YXJ0LCB0ZXh0KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChhY3Rpb24gPT09IFwicmVtb3ZlTGluZXNcIikge1xuICAgICAgICAgICAgdmFyIGxlbiA9IEVkaXRvclBvc2l0aW9uLmdldExpbmVzQ2hhcnMoZGVsdGEubGluZXMpO1xuICAgICAgICAgICAgZW5kID0gc3RhcnQgKyBsZW47XG4gICAgICAgICAgICB0aGlzLmVkaXRTY3JpcHQoZmlsZU5hbWUsIHN0YXJ0LCBlbmQsIFwiXCIpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgY29uc29sZS53YXJuKGB1cGRhdGVXb3Jrc3BhY2VGaWxlKCR7ZmlsZU5hbWV9LCAke0pTT04uc3RyaW5naWZ5KGRlbHRhKX0pYCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICB1cGRhdGVNYXJrZXJNb2RlbHMoZmlsZU5hbWU6IHN0cmluZywgZGVsdGE6IERlbHRhKTogdm9pZCB7XG4gICAgICAgIHZhciBlZGl0b3IgPSB0aGlzLmVkaXRvcnNbZmlsZU5hbWVdO1xuICAgICAgICB2YXIgYWN0aW9uID0gZGVsdGEuYWN0aW9uO1xuICAgICAgICB2YXIgcmFuZ2UgPSBkZWx0YS5yYW5nZTtcbiAgICAgICAgdmFyIG1hcmtlcnM6IHsgW2lkOiBudW1iZXJdOiBNYXJrZXIgfSA9IGVkaXRvci5nZXRTZXNzaW9uKCkuZ2V0TWFya2Vycyh0cnVlKTtcbiAgICAgICAgdmFyIGxpbmVfY291bnQgPSAwO1xuICAgICAgICB2YXIgaXNOZXdMaW5lID0gZWRpdG9yLmdldFNlc3Npb24oKS5nZXREb2N1bWVudCgpLmlzTmV3TGluZTtcbiAgICAgICAgaWYgKGFjdGlvbiA9PT0gXCJpbnNlcnRUZXh0XCIpIHtcbiAgICAgICAgICAgIGlmIChpc05ld0xpbmUoZGVsdGEudGV4dCkpIHtcbiAgICAgICAgICAgICAgICBsaW5lX2NvdW50ID0gMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChhY3Rpb24gPT09IFwiaW5zZXJ0TGluZXNcIikge1xuICAgICAgICAgICAgbGluZV9jb3VudCA9IGRlbHRhLmxpbmVzLmxlbmd0aDtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChhY3Rpb24gPT09IFwicmVtb3ZlVGV4dFwiKSB7XG4gICAgICAgICAgICBpZiAoaXNOZXdMaW5lKGRlbHRhLnRleHQpKSB7XG4gICAgICAgICAgICAgICAgbGluZV9jb3VudCA9IC0xO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGFjdGlvbiA9PT0gXCJyZW1vdmVMaW5lc1wiKSB7XG4gICAgICAgICAgICBsaW5lX2NvdW50ID0gLWRlbHRhLmxpbmVzLmxlbmd0aDtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihgdXBkYXRlTWFya2VyTW9kZWxzKCR7ZmlsZU5hbWV9LCAke0pTT04uc3RyaW5naWZ5KGRlbHRhKX0pYCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGxpbmVfY291bnQgIT09IDApIHtcbiAgICAgICAgICAgIHZhciBtYXJrZXJVcGRhdGUgPSBmdW5jdGlvbihpZDogbnVtYmVyKSB7XG4gICAgICAgICAgICAgICAgdmFyIG1hcmtlcjogTWFya2VyID0gbWFya2Vyc1tpZF07XG4gICAgICAgICAgICAgICAgdmFyIHJvdyA9IHJhbmdlLnN0YXJ0LnJvdztcbiAgICAgICAgICAgICAgICBpZiAobGluZV9jb3VudCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgcm93ID0gKzE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGlmIChtYXJrZXIgJiYgbWFya2VyLnJhbmdlLnN0YXJ0LnJvdyA+IHJvdykge1xuICAgICAgICAgICAgICAgICAgICBtYXJrZXIucmFuZ2Uuc3RhcnQucm93ICs9IGxpbmVfY291bnQ7XG4gICAgICAgICAgICAgICAgICAgIG1hcmtlci5yYW5nZS5lbmQucm93ICs9IGxpbmVfY291bnQ7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHRoaXMuZXJyb3JNYXJrZXJzLmZvckVhY2gobWFya2VyVXBkYXRlKTtcbiAgICAgICAgICAgIHRoaXMucmVmTWFya2Vycy5mb3JFYWNoKG1hcmtlclVwZGF0ZSk7XG4gICAgICAgICAgICBlZGl0b3IudXBkYXRlRnJvbnRNYXJrZXJzKCk7XG4gICAgICAgIH1cbiAgICB9XG59Il19