"use strict";
import { qualifyURL } from '../lib/net';
import EventEmitterClass from '../lib/EventEmitterClass';
export default class WorkerClient {
    constructor(workerUrl) {
        this.callbacks = {};
        this.callbackId = 1;
        this.eventBus = new EventEmitterClass(this);
        this.sendDeltaQueue = this.sendDeltaQueue.bind(this);
        this.changeListener = this.changeListener.bind(this);
        this.onMessage = this.onMessage.bind(this);
        var workerUrl = qualifyURL(workerUrl);
        try {
            this.$worker = new Worker(workerUrl);
        }
        catch (e) {
            if (e instanceof window['DOMException']) {
                var blob = this.$workerBlob(workerUrl);
                var URL = window['URL'] || window['webkitURL'];
                var blobURL = URL.createObjectURL(blob);
                this.$worker = new Worker(blobURL);
                URL.revokeObjectURL(blobURL);
            }
            else {
                throw e;
            }
        }
        this.$worker.onmessage = this.onMessage;
    }
    init(scriptImports, moduleName, className) {
        this.$worker.postMessage({
            init: true,
            scriptImports: scriptImports,
            moduleName: moduleName,
            className: className
        });
    }
    onMessage(event) {
        var origin = event.origin;
        var source = event.source;
        var msg = event.data;
        switch (msg.type) {
            case "log":
                window.console && console.log && console.log.apply(console, msg.data);
                break;
            case "event":
                this.eventBus._signal(msg.name, { data: msg.data });
                break;
            case "call":
                var callback = this.callbacks[msg.id];
                if (callback) {
                    callback(msg.data);
                    delete this.callbacks[msg.id];
                }
                break;
        }
    }
    $normalizePath(path) {
        return qualifyURL(path);
    }
    terminate() {
        this.eventBus._signal("terminate", {});
        this.deltaQueue = void 0;
        this.$worker.terminate();
        this.$worker = void 0;
    }
    send(cmd, args) {
        this.$worker.postMessage({ command: cmd, args: args });
    }
    call(cmd, args, callback) {
        if (callback) {
            var id = this.callbackId++;
            this.callbacks[id] = callback;
            args.push(id);
        }
        this.send(cmd, args);
    }
    invoke(cmd, args) {
        var workerClient = this;
        return new Promise(function (resolve, reject) {
            workerClient.call(cmd, args, function (retval) {
                if (retval.err) {
                    reject(retval.err);
                }
                else {
                    resolve(retval.data);
                }
            });
        });
    }
    emit(event, data) {
        try {
            this.$worker.postMessage({ event: event, data: { data: data.data } });
        }
        catch (e) {
            console.error(e.stack);
        }
    }
    attachToDocument(doc) {
        if (this.$doc) {
            if (this.$doc === doc) {
                return;
            }
            else {
                this.$doc.off('change', this.changeListener);
            }
        }
        this.$doc = doc;
        this.call("setValue", [doc.getValue()]);
        doc.on('change', this.changeListener);
    }
    detachFromDocument() {
        if (this.$doc) {
            this.$doc.off('change', this.changeListener);
            this.$doc = null;
        }
    }
    changeListener(e, doc) {
        if (!this.deltaQueue) {
            this.deltaQueue = [e.data];
            setTimeout(this.sendDeltaQueue, 0);
        }
        else {
            this.deltaQueue.push(e.data);
        }
    }
    on(eventName, callback) {
        this.eventBus.on(eventName, callback, false);
    }
    off(eventName, callback) {
        this.eventBus.off(eventName, callback);
    }
    sendDeltaQueue() {
        var doc = this.$doc;
        var queue = this.deltaQueue;
        if (!queue)
            return;
        this.deltaQueue = void 0;
        if (queue.length > 20 && queue.length > doc.getLength() >> 1) {
            this.call("setValue", [doc.getValue()]);
        }
        else {
            this.emit("change", { data: queue });
        }
    }
    $workerBlob(workerUrl) {
        var script = "importScripts('" + qualifyURL(workerUrl) + "');";
        try {
            return new Blob([script], { "type": "application/javascript" });
        }
        catch (e) {
            var BlobBuilder = window['BlobBuilder'] || window['WebKitBlobBuilder'] || window['MozBlobBuilder'];
            var blobBuilder = new BlobBuilder();
            blobBuilder.append(script);
            return blobBuilder.getBlob("application/javascript");
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV29ya2VyQ2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiV29ya2VyQ2xpZW50LnRzIl0sIm5hbWVzIjpbIldvcmtlckNsaWVudCIsIldvcmtlckNsaWVudC5jb25zdHJ1Y3RvciIsIldvcmtlckNsaWVudC5pbml0IiwiV29ya2VyQ2xpZW50Lm9uTWVzc2FnZSIsIldvcmtlckNsaWVudC4kbm9ybWFsaXplUGF0aCIsIldvcmtlckNsaWVudC50ZXJtaW5hdGUiLCJXb3JrZXJDbGllbnQuc2VuZCIsIldvcmtlckNsaWVudC5jYWxsIiwiV29ya2VyQ2xpZW50Lmludm9rZSIsIldvcmtlckNsaWVudC5lbWl0IiwiV29ya2VyQ2xpZW50LmF0dGFjaFRvRG9jdW1lbnQiLCJXb3JrZXJDbGllbnQuZGV0YWNoRnJvbURvY3VtZW50IiwiV29ya2VyQ2xpZW50LmNoYW5nZUxpc3RlbmVyIiwiV29ya2VyQ2xpZW50Lm9uIiwiV29ya2VyQ2xpZW50Lm9mZiIsIldvcmtlckNsaWVudC5zZW5kRGVsdGFRdWV1ZSIsIldvcmtlckNsaWVudC4kd29ya2VyQmxvYiJdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDO09BRU4sRUFBQyxVQUFVLEVBQUMsTUFBTSxZQUFZO09BSTlCLGlCQUFpQixNQUFNLDBCQUEwQjtBQWlDeEQ7SUEwQ0lBLFlBQVlBLFNBQWlCQTtRQWxCckJDLGNBQVNBLEdBQXlDQSxFQUFFQSxDQUFDQTtRQUNyREEsZUFBVUEsR0FBV0EsQ0FBQ0EsQ0FBQ0E7UUFrQjNCQSxJQUFJQSxDQUFDQSxRQUFRQSxHQUFHQSxJQUFJQSxpQkFBaUJBLENBQWVBLElBQUlBLENBQUNBLENBQUNBO1FBQzFEQSxJQUFJQSxDQUFDQSxjQUFjQSxHQUFHQSxJQUFJQSxDQUFDQSxjQUFjQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUNyREEsSUFBSUEsQ0FBQ0EsY0FBY0EsR0FBR0EsSUFBSUEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsSUFBSUEsQ0FB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QUVBLENBQUNBLEdBQUdBLENBQUNBLFFBQVFBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1FBQzVDQSxDQUFDQTtRQUNEQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUlGQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxRQUFRQSxFQUFFQSxFQUFFQSxJQUFJQSxFQUFFQSxLQUFLQSxFQUFFQSxDQUFDQSxDQUFDQTtRQUN6Q0EsQ0FBQ0E7SUFDTEEsQ0FBQ0E7SUFRT2YsV0FBV0EsQ0FBQ0EsU0FBaUJBO1FBR2pDZ0IsSUFBSUEsTUFBTUEsR0FBR0EsaUJBQWlCQSxHQUFHQSxVQUFVQSxDQUFDQSxTQUFTQSxDQUFDQSxHQUFHQSxLQUFLQSxDQUFDQTtRQUMvREEsSUFBSUEsQ0FBQ0E7WUFDREEsTUFBTUEsQ0FBQ0EsSUFBSUEsSUFBSUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsRUFBRUEsRUFBRUEsTUFBTUEsRUFBRUEsd0JBQXdCQSxFQUFFQSxDQUFDQSxDQUFDQTtRQUNwRUEsQ0FDQUE7UUFBQUEsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDUEEsSUFBSUEsV0FBV0EsR0FBR0EsTUFBTUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsSUFBSUEsTUFBTUEsQ0FBQ0EsbUJBQW1CQSxDQUFDQSxJQUFJQSxNQUFNQSxDQUFDQSxnQkFBZ0JBLENBQUNBLENBQUNBO1lBQ25HQSxJQUFJQSxXQUFXQSxHQUFHQSxJQUFJQSxXQUFXQSxFQUFFQSxDQUFDQTtZQUNwQ0EsV0FBV0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7WUFDM0JBLE1BQU1BLENBQUNBLFdBQVdBLENBQUNBLE9BQU9BLENBQUNBLHdCQUF3QkEsQ0FBQ0EsQ0FBQ0E7UUFDekRBLENBQUNBO0lBQ0xBLENBQUNBO0FBQ0xoQixDQUFDQTtBQUFBIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCB7cXVhbGlmeVVSTH0gZnJvbSAnLi4vbGliL25ldCc7XG5pbXBvcnQgRGVsdGEgZnJvbSBcIi4uL0RlbHRhXCI7XG5pbXBvcnQgRG9jdW1lbnQgZnJvbSBcIi4uL0RvY3VtZW50XCI7XG5pbXBvcnQgRXZlbnRCdXMgZnJvbSBcIi4uL0V2ZW50QnVzXCI7XG5pbXBvcnQgRXZlbnRFbWl0dGVyQ2xhc3MgZnJvbSAnLi4vbGliL0V2ZW50RW1pdHRlckNsYXNzJztcbmltcG9ydCB7Z2V0fSBmcm9tIFwiLi4vY29uZmlnXCI7XG5cbi8vIEZJWE1FOiBUaGlzIGNsYXNzIGlzIGJlZ2dpbmcgdG8gYmUgd3JpdHRlbiB1c2luZyB0aGUgZnVuY3Rpb25hbCBjb25zdHJ1Y3RvclxuLy8gcGF0dGVybiBpbiBvcmRlciB0byBwcm92aWRlIGJldHRlciBlbmNhcHN1bGF0aW9uIGFuZCBhdm9pZCB0aGUgYHRoaXNgIGJpbmRpbmdcbi8vIGlzc3VlcyBhc3NvY2lhdGVkIHdpdGggdGhlIGNsYXNzIHBhdHRlcm4gb3IgY2xhc3Mgc3ludGFjdGljIHN1Z2FyLlxuXG4vKipcbiAqIDxwPlxuICogV29ya2VyQ2xpZW50IGNvbnRyb2xzIHRoZSBpbnRlcmFjdGlvbiBiZXR3ZWVuIGFuIGVkaXRvciBkb2N1bWVudFxuICogYW5kIGEgV2ViIFdvcmtlci5cbiAqIDwvcD5cbiAqIEl0IHByb3ZpZGVzIGFkZGl0aW9uYWwgY2FwYWJpbGl0aWVzIGJ5IGJlaW5nIGEgd3JhcHBlciBhcm91bmRcbiAqIGFuIHVuZGVybHlpbmcgV2ViIFdvcmtlcjpcbiAqIDx1bD5cbiAqIDxsaT5cbiAqIEl0IGlzIGEgY29udHJvbGxlciBiZXR3ZWVuIHRoZSBlZGl0b3JcbiAqIDxjb2RlPkRvY3VtZW50PC9jb2RlPiBhbmQgdGhlIDxjb2RlPldvcmtlcjwvY29kZT4gdGhyZWFkLlxuICogPC9saT5cbiAqIDxsaT5cbiAqIEl0IGlzIGEgcHJveHkgdG8gdGhlIHVuZGVybHlpbmcgd29ya2VyIHRocmVhZCBieSBwcm92aWRpbmdcbiAqIGNvbnZlbmllbmNlIGZ1bmN0aW9ucyBmb3IgYm90aCBhbnN5Y2hyb25vdXMgcG9zdE1lc3NhZ2UgYXNcbiAqIHdlbGwgYXMgYXluY2hyb25vdXMgcmVxdWVzdC9yZXNwb25zZSBwYXR0ZXJucy5cbiAqIDwvbGk+XG4gKiA8bGk+XG4gKiBJdCBpcyBhIG1lc3NhZ2UgaHViLCBhbGxvd2luZyBsaXN0ZW5lcnMgdG8gY29ubmVjdCB0byBpdFxuICogYW5kIHJlY2VpdmUgZXZlbnRzIHRoYXQgb3JpZ2luYXRlZCBpbiB0aGUgd29ya2VyIHRocmVhZC5cbiAqIDwvbGk+XG4gKiA8L3VsPlxuICpcbiAqIEBjbGFzcyBXb3JrZXJDbGllbnRcbiAqIEBleHRlbmRzIEV2ZW50RW1pdHRlclxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBXb3JrZXJDbGllbnQgaW1wbGVtZW50cyBFdmVudEJ1czxXb3JrZXJDbGllbnQ+IHtcblxuICAgIC8qKlxuICAgICAqIFRoZSB1bmRlcmx5aW5nIFdlYiBXb3JrZXIuXG4gICAgICogQHByb3BlcnR5ICR3b3JrZXJcbiAgICAgKiBAdHlwZSBXb3JrZXJcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIHByaXZhdGUgJHdvcmtlcjogV29ya2VyO1xuXG4gICAgLyoqXG4gICAgICogQ2hhbmdlcyBpbiB0aGUgRG9jdW1lbnQgYXJlIHF1ZXVlZCBoZXJlIHNvIHRoYXQgdGhleSBjYW5cbiAgICAgKiBsYXRlciBiZSBwb3N0ZWQgdG8gdGhlIHdvcmtlciB0aHJlYWQuXG4gICAgICpcbiAgICAgKiBAcHJvcGVydHkgZGVsdGFRdWV1ZVxuICAgICAqIEB0eXBlIERlbHRhW11cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIHByaXZhdGUgZGVsdGFRdWV1ZTogRGVsdGFbXTtcblxuICAgIC8vIFRoZSBmb2xsb3dpbmcgaW1wbGVtZW50YXRpb24gcHJvdmlkZXMgYSBnZW5lcmljIGFwcHJvYWNoXG4gICAgLy8gZm9yIG1ha2luZyBhc3luY2hyb25vdXMgcmVxdWVzdC9yZXNwb25zZSBjYWxscy5cbiAgICAvLyBUT0RPOiBNYWtlIHRoaXMgcmV1c2FibGU/XG4gICAgLy8gVE9ETzogUHJvdmlkZSBhIFByb21pc2UtbGlrZSBjYXBhYmlsaXR5P1xuICAgIHByaXZhdGUgY2FsbGJhY2tzOiB7IFtpZDogbnVtYmVyXTogKGRhdGE6IGFueSkgPT4gYW55IH0gPSB7fTtcbiAgICBwcml2YXRlIGNhbGxiYWNrSWQ6IG51bWJlciA9IDE7XG5cbiAgICAvKipcbiAgICAgKiBcbiAgICAgKiBAcHJvcGVydHkgZWRpdG9yRG9jdW1lbnRcbiAgICAgKiBAdHlwZSBEb2N1bWVudFxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgcHJpdmF0ZSAkZG9jOiBEb2N1bWVudDtcblxuICAgIHByaXZhdGUgZXZlbnRCdXM6IEV2ZW50RW1pdHRlckNsYXNzPFdvcmtlckNsaWVudD47XG5cbiAgICAvKipcbiAgICAgKiBAY2xhc3MgV29ya2VyQ2xpZW50XG4gICAgICogQGNvbnN0cnVjdG9yXG4gICAgICogQHBhcmFtIHdvcmtlclVybCB7c3RyaW5nfVxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKHdvcmtlclVybDogc3RyaW5nKSB7XG4gICAgICAgIHRoaXMuZXZlbnRCdXMgPSBuZXcgRXZlbnRFbWl0dGVyQ2xhc3M8V29ya2VyQ2xpZW50Pih0aGlzKTtcbiAgICAgICAgdGhpcy5zZW5kRGVsdGFRdWV1ZSA9IHRoaXMuc2VuZERlbHRhUXVldWUuYmluZCh0aGlzKTtcbiAgICAgICAgdGhpcy5jaGFuZ2VMaXN0ZW5lciA9IHRoaXMuY2hhbmdlTGlzdGVuZXIuYmluZCh0aGlzKTtcbiAgICAgICAgdGhpcy5vbk1lc3NhZ2UgPSB0aGlzLm9uTWVzc2FnZS5iaW5kKHRoaXMpO1xuXG4gICAgICAgIHZhciB3b3JrZXJVcmwgPSBxdWFsaWZ5VVJMKHdvcmtlclVybCk7XG5cbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHRoaXMuJHdvcmtlciA9IG5ldyBXb3JrZXIod29ya2VyVXJsKTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZSkge1xuICAgICAgICAgICAgaWYgKGUgaW5zdGFuY2VvZiB3aW5kb3dbJ0RPTUV4Y2VwdGlvbiddKSB7XG4gICAgICAgICAgICAgICAgLy8gTGlrZWx5IHNhbWUgb3JpZ2luIHByb2JsZW0uIFVzZSBpbXBvcnRTY3JpcHRzIGZyb20gYSBzaGltIFdvcmtlci5cbiAgICAgICAgICAgICAgICB2YXIgYmxvYjogQmxvYiA9IHRoaXMuJHdvcmtlckJsb2Iod29ya2VyVXJsKTtcbiAgICAgICAgICAgICAgICB2YXIgVVJMOiBVUkwgPSB3aW5kb3dbJ1VSTCddIHx8IHdpbmRvd1snd2Via2l0VVJMJ107XG4gICAgICAgICAgICAgICAgdmFyIGJsb2JVUkw6IHN0cmluZyA9IFVSTC5jcmVhdGVPYmplY3RVUkwoYmxvYik7XG5cbiAgICAgICAgICAgICAgICB0aGlzLiR3b3JrZXIgPSBuZXcgV29ya2VyKGJsb2JVUkwpO1xuICAgICAgICAgICAgICAgIFVSTC5yZXZva2VPYmplY3RVUkwoYmxvYlVSTCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgLy8gQWRkIGFuIEV2ZW50TGlzdGVuZXIgZm9yIGRhdGEgdGhlIHdvcmtlciByZXR1cm5zLlxuICAgICAgICB0aGlzLiR3b3JrZXIub25tZXNzYWdlID0gdGhpcy5vbk1lc3NhZ2U7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUG9zdHMgYSBtZXNzYWdlIHRvIHRoZSB3b3JrZXIgdGhyZWFkIGNhdXNpbmcgdGhlIHRocmVhZCB0byBiZSBzdGFydGVkLlxuICAgICAqXG4gICAgICogQG1ldGhvZCBpbml0XG4gICAgICogQHBhcmFtIHNjcmlwdEltcG9ydHMge3N0cmluZ1tdfVxuICAgICAqIEBwYXJhbSBtb2R1bGVOYW1lIHtzdHJpbmd9XG4gICAgICogQHBhcmFtIGNsYXNzTmFtZSB7c3RyaW5nfVxuICAgICAqIEByZXR1cm4ge3ZvaWR9XG4gICAgICovXG4gICAgaW5pdChzY3JpcHRJbXBvcnRzOiBzdHJpbmdbXSwgbW9kdWxlTmFtZTogc3RyaW5nLCBjbGFzc05hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICAvLyBTZW5kaW5nIGEgcG9zdE1lc3NhZ2Ugc3RhcnRzIHRoZSB3b3JrZXIuXG4gICAgICAgIHRoaXMuJHdvcmtlci5wb3N0TWVzc2FnZSh7XG4gICAgICAgICAgICBpbml0OiB0cnVlLFxuICAgICAgICAgICAgc2NyaXB0SW1wb3J0czogc2NyaXB0SW1wb3J0cyxcbiAgICAgICAgICAgIG1vZHVsZU5hbWU6IG1vZHVsZU5hbWUsXG4gICAgICAgICAgICBjbGFzc05hbWU6IGNsYXNzTmFtZVxuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIG1ldGhvZCBpcyBpcyB1c2VkIGFzIHRoZSBjYWxsYmFjayBmdW5jdGlvbiBmb3IgdGhlIFdvcmtlciB0aHJlYWRcbiAgICAgKiBhbmQgc28gaXQgcmVjZWl2ZXMgYWxsIG1lc3NhZ2VzIHBvc3RlZCBiYWNrIGZyb20gdGhhdCB0aHJlYWQuXG4gICAgICogQG1ldGhvZCBvbk1lc3NhZ2VcbiAgICAgKiBAcGFyYW0gZXZlbnQge01lc3NhZ2VFdmVudH1cbiAgICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgICAqL1xuICAgIG9uTWVzc2FnZShldmVudDogTWVzc2FnZUV2ZW50KTogdm9pZCB7XG4gICAgICAgIHZhciBvcmlnaW46IHN0cmluZyA9IGV2ZW50Lm9yaWdpbjtcbiAgICAgICAgdmFyIHNvdXJjZTogV2luZG93ID0gZXZlbnQuc291cmNlO1xuICAgICAgICB2YXIgbXNnID0gZXZlbnQuZGF0YTtcbiAgICAgICAgc3dpdGNoIChtc2cudHlwZSkge1xuICAgICAgICAgICAgY2FzZSBcImxvZ1wiOlxuICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlICYmIGNvbnNvbGUubG9nICYmIGNvbnNvbGUubG9nLmFwcGx5KGNvbnNvbGUsIG1zZy5kYXRhKTtcbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgY2FzZSBcImV2ZW50XCI6XG4gICAgICAgICAgICAgICAgLy8gVE9ETzogRW51bWVyYXRlIHRoZSBldmVudCBuYW1lcyBmb3IgZG9jdW1lbnRhdGlvbiBwdXJwb3Nlcy5cbiAgICAgICAgICAgICAgICAvLyBTb21lIHdpbGwgYmUgc3RhbmRhcmQgYmVjdWFzZSB0aGV5IGFyZSBhc3NvY2lhdGVkIHdpdGggdGhlXG4gICAgICAgICAgICAgICAgLy8gV29ya2VyQ2xpZW50IHByb3RvY29sLiBPdGhlcnMgd2lsbCBiZSB1bmRvY3VtZW50ZWQgYW5kIGN1c3RvbVxuICAgICAgICAgICAgICAgIC8vIGJlY2F1c2UgdGhleSBhcmUgc3BlY2lmaWMgdG8gdGhlIHBhcnRpY3VsYXIgaW1wbGVtZW50YXRpb24uXG4gICAgICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgICAgICogQGV2ZW50IFRPRE9cbiAgICAgICAgICAgICAgICAgKi9cbiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50QnVzLl9zaWduYWwobXNnLm5hbWUsIHsgZGF0YTogbXNnLmRhdGEgfSk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgXCJjYWxsXCI6XG4gICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gdGhpcy5jYWxsYmFja3NbbXNnLmlkXTtcbiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIHtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobXNnLmRhdGEpO1xuICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5jYWxsYmFja3NbbXNnLmlkXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAbWV0aG9kICRub3JtYWxpemVQYXRoXG4gICAgICogQHBhcmFtIHBhdGgge3N0cmluZ31cbiAgICAgKiBAcmV0dXJuIHtzdHJpbmd9XG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBwcml2YXRlICRub3JtYWxpemVQYXRoKHBhdGg6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBxdWFsaWZ5VVJMKHBhdGgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBtZXRob2QgdGVybWluYXRlXG4gICAgICogQHJldHVybiB7dm9pZH1cbiAgICAgKi9cbiAgICB0ZXJtaW5hdGUoKTogdm9pZCB7XG4gICAgICAgIC8qKlxuICAgICAgICAgKiBAZXZlbnQgdGVybWluYXRlXG4gICAgICAgICAqL1xuICAgICAgICB0aGlzLmV2ZW50QnVzLl9zaWduYWwoXCJ0ZXJtaW5hdGVcIiwge30pO1xuICAgICAgICB0aGlzLmRlbHRhUXVldWUgPSB2b2lkIDA7XG4gICAgICAgIHRoaXMuJHdvcmtlci50ZXJtaW5hdGUoKTtcbiAgICAgICAgdGhpcy4kd29ya2VyID0gdm9pZCAwO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBvc3RzIGEgbWVzc2FnZSB0byB0aGUgd29ya2VyIHRocmVhZCB3aXRoIGEgc3BlY2lmaWMgY29tbWFuZCBkYXRhIHN0cnVjdHVyZS5cbiAgICAgKlxuICAgICAqIEBtZXRob2Qgc2VuZFxuICAgICAqIEBwYXJhbSBjbWQge3N0cmluZ31cbiAgICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgICAqL1xuICAgIC8vIEZJWE1FOiBSZW5hbWUgdGhpcyBwb3N0Q29tbWFuZCBpbiBvcmRlciB0byBiZSBtb3JlIG9idmlvdXMgdGhhdFxuICAgIC8vIHdlIGFyZSBhY3RpbmcgYXMgYSBjb25kdWl0IHRvIHRoZSB3b3JrZXIgdGhyZWFkLlxuICAgIC8vIEZJWE1FOiBDYXB0dXJlIHRoZSBzdHJ1Y3R1cmUgdXNpbmcgYSBkLnRzIGZpbGUuXG4gICAgc2VuZChjbWQ6IHN0cmluZywgYXJncyk6IHZvaWQge1xuICAgICAgICB0aGlzLiR3b3JrZXIucG9zdE1lc3NhZ2UoeyBjb21tYW5kOiBjbWQsIGFyZ3M6IGFyZ3MgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGhpcyBpcyBhIHdyYXBwZXIgYXJvdW5kIHRoZSB0aGUgYXN5bmNocm9ub3VzIHBvc3QgdG8gdGhlIHdvcmtlciB0aHJlYWRcbiAgICAgKiB0aGF0IGFsbG93cyB1cyB0byBwcm92aWRlIGEgY2FsbGJhY2sgZnVuY3Rpb24gZm9yIGFuIGFudGljaXBhdGVkIHBvc3RcbiAgICAgKiByZXNwb25zZS5cbiAgICAgKlxuICAgICAqIEBtZXRob2QgY2FsbFxuICAgICAqIEBwYXJhbSBjbWQge3N0cmluZ31cbiAgICAgKiBAcGFyYW0gYXJnc1xuICAgICAqIEBwYXJhbSBjYWxsYmFja1xuICAgICAqIEByZXR1cm4ge3ZvaWR9XG4gICAgICovXG4gICAgLy8gVE9ETzogUHJvdmlkZSBhIFByb21pc2UtYmFzZWQgdmVyc2lvbiBvZiB0aGlzIG1ldGhvZCBhbmQgc2VlIGlmIGl0IG1ha2VzIHRoZSBjb2RlXG4gICAgLy8gbW9yZSBtYWludGFpbmFibGUuXG4gICAgY2FsbChjbWQ6IHN0cmluZywgYXJncywgY2FsbGJhY2s/OiAoZGF0YTogYW55KSA9PiBhbnkpOiB2b2lkIHtcbiAgICAgICAgaWYgKGNhbGxiYWNrKSB7XG4gICAgICAgICAgICB2YXIgaWQgPSB0aGlzLmNhbGxiYWNrSWQrKztcbiAgICAgICAgICAgIHRoaXMuY2FsbGJhY2tzW2lkXSA9IGNhbGxiYWNrO1xuICAgICAgICAgICAgYXJncy5wdXNoKGlkKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNlbmQoY21kLCBhcmdzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBXLkkuUC4gZXhwZXJpbWVudCBhdCB1c2luZyBwcm9taXNlcyBmb3IgdGhlIEFQSS5cbiAgICAgKiBUaGlzIGhpZ2hsaWdodHMgdGhlIG5lZWQgZm9yIGEgcHJvdG9jb2wgYmV0d2VlblxuICAgICAqIHRoZSBXb3JrZXIgdGhyZWFkIGltcGxlbWVudGF0aW9uIGFuZCB0aGlzIFdvcmtlckNsaWVudC5cbiAgICAgKiBUT0RPOiBDb21wbGV0ZS5cbiAgICAgKiBUT0RPOiBDYW4gd2UgZ2V0IHR5cGUtc2FmZXR5IGluIHRoZSBQcm9taXNlP1xuICAgICAqIFdlIG1pZ2h0IG5lZWQgYW4gYXJndW1lbnQgb2YgdHlwZSBUIHRvIG1ha2UgdGhpcyBoYXBwZW4uXG4gICAgICpcbiAgICAgKiBAbWV0aG9kIGludm9rZVxuICAgICAqIEBwYXJhbSBjbWRcbiAgICAgKiBAcGFyYW0gYXJnc1xuICAgICAqIEByZXR1cm4ge1Byb21pc2V9XG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBwcml2YXRlIGludm9rZTxUPihjbWQ6IHN0cmluZywgYXJncyk6IFByb21pc2U8VD4ge1xuICAgICAgICB2YXIgd29ya2VyQ2xpZW50ID0gdGhpcztcbiAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlPGFueT4oZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XG4gICAgICAgICAgICB3b3JrZXJDbGllbnQuY2FsbChjbWQsIGFyZ3MsIGZ1bmN0aW9uKHJldHZhbDogeyBlcnI6IGFueTsgZGF0YTogVCB9KSB7XG4gICAgICAgICAgICAgICAgLy8gSXQncyBjbGVhciBub3cgdGhhdCB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gb3IgZGF0YVxuICAgICAgICAgICAgICAgIC8vIHNob3VsZCBwcm92aWRlIHNvbWUgbWVhbnMgdG8gZGlzdGluZ3Vpc2ggYmV0d2VlblxuICAgICAgICAgICAgICAgIC8vIGFuIGVycm9yIGFuZCBhIG5vcm1hbCBleGVjdXRpb24uIFRoaXMgd291bGQgcmVxdWlyZVxuICAgICAgICAgICAgICAgIC8vIGEgcHJvdG9jYWwgYmV0d2VlbiB0aGUgdGhlIFdvcmtlckNsaWVudCBhbmQgdGhlXG4gICAgICAgICAgICAgICAgLy8gaW1wbGVtZW50YXRpb24gb2YgdGhlIFdvcmtlciB0aHJlYWQuXG4gICAgICAgICAgICAgICAgaWYgKHJldHZhbC5lcnIpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KHJldHZhbC5lcnIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShyZXR2YWwuZGF0YSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUG9zdHMgYSBtZXNzYWdlIHRvIHRoZSB3b3JrZXIgdGhyZWFkIHdpdGggYSBzcGVjaWZpYyBldmVudCBkYXRhIHN0cnVjdHVyZS5cbiAgICAgKlxuICAgICAqIEBtZXRob2QgZW1pdFxuICAgICAqIEBwYXJhbSBldmVudCB7c3RyaW5nfSBUaGUgbmFtZSBvZiB0aGUgZXZlbnQuXG4gICAgICogQHBhcmFtIGRhdGFcbiAgICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgICAqL1xuICAgIC8vIEZJWE1FXG4gICAgZW1pdChldmVudDogc3RyaW5nLCBkYXRhKTogdm9pZCB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvLyBmaXJlZm94IHJlZnVzZXMgdG8gY2xvbmUgb2JqZWN0cyB3aGljaCBoYXZlIGZ1bmN0aW9uIHByb3BlcnRpZXNcbiAgICAgICAgICAgIC8vIFRPRE86IGNsZWFudXAgZXZlbnRcbiAgICAgICAgICAgIHRoaXMuJHdvcmtlci5wb3N0TWVzc2FnZSh7IGV2ZW50OiBldmVudCwgZGF0YTogeyBkYXRhOiBkYXRhLmRhdGEgfSB9KTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlLnN0YWNrKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBtZXRob2QgYXR0YWNoVG9Eb2N1bWVudFxuICAgICAqIEBwYXJhbSBkb2Mge0RvY3VtZW50fVxuICAgICAqIEByZXR1cm4ge3ZvaWR9XG4gICAgICovXG4gICAgYXR0YWNoVG9Eb2N1bWVudChkb2M6IERvY3VtZW50KTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLiRkb2MpIHtcbiAgICAgICAgICAgIGlmICh0aGlzLiRkb2MgPT09IGRvYykge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHRoaXMuJGRvYy5vZmYoJ2NoYW5nZScsIHRoaXMuY2hhbmdlTGlzdGVuZXIpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIHRoaXMuJGRvYyA9IGRvYztcbiAgICAgICAgdGhpcy5jYWxsKFwic2V0VmFsdWVcIiwgW2RvYy5nZXRWYWx1ZSgpXSk7XG4gICAgICAgIGRvYy5vbignY2hhbmdlJywgdGhpcy5jaGFuZ2VMaXN0ZW5lcik7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG1ldGhvZCBkZXRhY2hGcm9tRG9jdW1lbnRcbiAgICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgcHVibGljIGRldGFjaEZyb21Eb2N1bWVudCgpOiB2b2lkIHtcbiAgICAgICAgaWYgKHRoaXMuJGRvYykge1xuICAgICAgICAgICAgdGhpcy4kZG9jLm9mZignY2hhbmdlJywgdGhpcy5jaGFuZ2VMaXN0ZW5lcik7XG4gICAgICAgICAgICB0aGlzLiRkb2MgPSBudWxsO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGhpcyBtZXRob2QgaXMgdXNlZCB0byBoYW5kbGUgJ2NoYW5nZScgZXZlbnRzIGluIHRoZSBkb2N1bWVudC5cbiAgICAgKiBXaGVuIHRoZSBkb2N1bWVudCBjaGFuZ2VzIChyZXBvcnRlZCBhcyBhIERlbHRhKSwgdGhlIGRlbHRhIGlzIGFkZGVkIHRvXG4gICAgICogdGhlIGRlbHRhUXVldWUgbWVtYmVyIG9mIHRoaXMgV29ya2VyQ2xpZW50LiBBcyBpcyBnb29kIHByYWN0aWNlLCB0aGVcbiAgICAgKiBjaGFuZSBpcyBub3QgYWN0ZWQgdXBvbiBpbW1lZGlhdGVseS5cbiAgICAgKlxuICAgICAqIFRoaXMgbWV0aG9kIGlzIHJlcGxhY2VkIGluIHRoZSBjb25zdHJ1Y3RvciBieSBhIGZ1bmN0aW9uIHRoYXQgaXMgYm91bmQgdG8gYHRoaXNgLlxuICAgICAqXG4gICAgICogQG1ldGhvZCBjaGFuZ2VMaXN0ZW5lclxuICAgICAqIEBwYXJhbSBlIHt7ZGF0YTogRGVsdGF9fVxuICAgICAqIEBwYXJhbSBkb2Mge0RvY3VtZW50fVxuICAgICAqIEByZXR1cm4ge3ZvaWR9XG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICAvLyBUT0RPOiBJdCB3b3VsZCBiZSBiZXR0ZXIgaWYgdGhpcyB3YXMgYXdheSBmcm9tIHRoZSBXb3JrZXJDbGllbnQgQVBJLlxuICAgIHByaXZhdGUgY2hhbmdlTGlzdGVuZXIoZTogeyBkYXRhOiBEZWx0YSB9LCBkb2M6IERvY3VtZW50KTogdm9pZCB7XG4gICAgICAgIGlmICghdGhpcy5kZWx0YVF1ZXVlKSB7XG4gICAgICAgICAgICB0aGlzLmRlbHRhUXVldWUgPSBbZS5kYXRhXTtcbiAgICAgICAgICAgIHNldFRpbWVvdXQodGhpcy5zZW5kRGVsdGFRdWV1ZSwgMCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmRlbHRhUXVldWUucHVzaChlLmRhdGEpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG1ldGhvZCBvblxuICAgICAqIEBwYXJhbSBldmVudE5hbWUge3N0cmluZ31cbiAgICAgKiBAcGFyYW0gY2FsbGJhY2sgeyhldmVudCwgc291cmNlOiBXb3JrZXJDbGllbnQpID0+IGFueX1cbiAgICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgICAqL1xuICAgIG9uKGV2ZW50TmFtZTogc3RyaW5nLCBjYWxsYmFjazogKGV2ZW50OiBhbnksIHNvdXJjZTogV29ya2VyQ2xpZW50KSA9PiBhbnkpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5ldmVudEJ1cy5vbihldmVudE5hbWUsIGNhbGxiYWNrLCBmYWxzZSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG1ldGhvZCBvZmZcbiAgICAgKiBAcGFyYW0gZXZlbnROYW1lIHtzdHJpbmd9XG4gICAgICogQHBhcmFtIGNhbGxiYWNrIHsoZXZlbnQsIHNvdXJjZTogV29ya2VyQ2xpZW50KSA9PiBhbnl9XG4gICAgICogQHJldHVybiB7dm9pZH1cbiAgICAgKi9cbiAgICBvZmYoZXZlbnROYW1lOiBzdHJpbmcsIGNhbGxiYWNrOiAoZXZlbnQ6IGFueSwgc291cmNlOiBXb3JrZXJDbGllbnQpID0+IGFueSk6IHZvaWQge1xuICAgICAgICB0aGlzLmV2ZW50QnVzLm9mZihldmVudE5hbWUsIGNhbGxiYWNrKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIG1ldGhvZCBpcyBpbnRlbmRlZCB0byBiZSB1c2VkIGFzIGEgY2FsbGJhY2sgZm9yIHNldFRpbWVvdXQuXG4gICAgICogSXQgaXMgcmVwbGFjZWQgYnkgYSB2ZXJzaW9uIHRoYXQgaXMgYm91bmQgdG8gYHRoaXNgLlxuICAgICAqIFxuICAgICAqIEBtZXRob2Qgc2VuZERlbHRhUXVldWVcbiAgICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgcHJpdmF0ZSBzZW5kRGVsdGFRdWV1ZSgpOiB2b2lkIHtcbiAgICAgICAgdmFyIGRvYyA9IHRoaXMuJGRvYztcbiAgICAgICAgdmFyIHF1ZXVlID0gdGhpcy5kZWx0YVF1ZXVlO1xuICAgICAgICBpZiAoIXF1ZXVlKSByZXR1cm47XG4gICAgICAgIHRoaXMuZGVsdGFRdWV1ZSA9IHZvaWQgMDtcblxuICAgICAgICAvLyBXZSdyZSBnb2luZyB0byBwb3N0IGFsbCB0aGUgY2hhbmdlcyBpbiBvbmUgbWVzc2FnZSwgYnV0IHdlIGFwcGx5IGFcbiAgICAgICAgLy8gaGV1cmlzdGljIHRvIGp1c3Qgc2VuZCB0aGUgYWN0dWFsIGRvY3VtZW50IGlmIHRoZXJlIGFyZSBlbm91Z2ggY2hhbmdlcy5cbiAgICAgICAgaWYgKHF1ZXVlLmxlbmd0aCA+IDIwICYmIHF1ZXVlLmxlbmd0aCA+IGRvYy5nZXRMZW5ndGgoKSA+PiAxKSB7XG4gICAgICAgICAgICAvLyBUT0RPOiBJZiB0aGVyZSBpcyBubyBjYWxsYmFjayB0aGVuIGNhbGwgaXMgdGhlIHNhbWUgYXMgc2VuZCxcbiAgICAgICAgICAgIC8vIHdoaWNoIGlzIGEgcG9zdENvbW1hbmQuXG4gICAgICAgICAgICB0aGlzLmNhbGwoXCJzZXRWYWx1ZVwiLCBbZG9jLmdldFZhbHVlKCldKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIC8vIFRPRE86IFRoaXMgbWV0aG9kIHNob3VsZCBwcm9iYWJseSBiZSBjYWxsZWQgJ2NoYW5nZXMnLCBzaW5jZSB0aGVcbiAgICAgICAgICAgIC8vIGRhdGEgd2FzIGFjY3VtdWxhdGVkIGZyb20gb25lIG9yIG1vcmUgY2hhbmdlIGV2ZW50cy5cbiAgICAgICAgICAgIC8vIFRPRE86IGVtb3QgY291bmQgYmUgcmVuYW1lZCBwb3N0RXZlbnQsIHdoaWNoIGlzIG1vcmUgZGVzY3JpcHRpdmUuXG4gICAgICAgICAgICB0aGlzLmVtaXQoXCJjaGFuZ2VcIiwgeyBkYXRhOiBxdWV1ZSB9KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBtZXRob2QgJHdvcmtlckJsb2JcbiAgICAgKiBAcGFyYW0gd29ya2VyVXJsIHtzdHJpbmd9XG4gICAgICogQHJldHVybiB7QmxvYn1cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIHByaXZhdGUgJHdvcmtlckJsb2Iod29ya2VyVXJsOiBzdHJpbmcpOiBCbG9iIHtcbiAgICAgICAgLy8gd29ya2VyVXJsIGNhbiBiZSBwcm90b2NvbCByZWxhdGl2ZVxuICAgICAgICAvLyBpbXBvcnRTY3JpcHRzIG9ubHkgdGFrZXMgZnVsbHkgcXVhbGlmaWVkIHVybHNcbiAgICAgICAgdmFyIHNjcmlwdCA9IFwiaW1wb3J0U2NyaXB0cygnXCIgKyBxdWFsaWZ5VVJMKHdvcmtlclVybCkgKyBcIicpO1wiO1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBCbG9iKFtzY3JpcHRdLCB7IFwidHlwZVwiOiBcImFwcGxpY2F0aW9uL2phdmFzY3JpcHRcIiB9KTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZSkgeyAvLyBCYWNrd2FyZHMtY29tcGF0aWJpbGl0eVxuICAgICAgICAgICAgdmFyIEJsb2JCdWlsZGVyID0gd2luZG93WydCbG9iQnVpbGRlciddIHx8IHdpbmRvd1snV2ViS2l0QmxvYkJ1aWxkZXInXSB8fCB3aW5kb3dbJ01vekJsb2JCdWlsZGVyJ107XG4gICAgICAgICAgICB2YXIgYmxvYkJ1aWxkZXIgPSBuZXcgQmxvYkJ1aWxkZXIoKTtcbiAgICAgICAgICAgIGJsb2JCdWlsZGVyLmFwcGVuZChzY3JpcHQpO1xuICAgICAgICAgICAgcmV0dXJuIGJsb2JCdWlsZGVyLmdldEJsb2IoXCJhcHBsaWNhdGlvbi9qYXZhc2NyaXB0XCIpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG4vKiAqKioqKiBCRUdJTiBMSUNFTlNFIEJMT0NLICoqKioqXG4gKiBEaXN0cmlidXRlZCB1bmRlciB0aGUgQlNEIGxpY2Vuc2U6XG4gKlxuICogQ29weXJpZ2h0IChjKSAyMDEwLCBBamF4Lm9yZyBCLlYuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dFxuICogbW9kaWZpY2F0aW9uLCBhcmUgcGVybWl0dGVkIHByb3ZpZGVkIHRoYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zIGFyZSBtZXQ6XG4gKiAgICAgKiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodFxuICogICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLlxuICogICAgICogUmVkaXN0cmlidXRpb25zIGluIGJpbmFyeSBmb3JtIG11c3QgcmVwcm9kdWNlIHRoZSBhYm92ZSBjb3B5cmlnaHRcbiAqICAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGVcbiAqICAgICAgIGRvY3VtZW50YXRpb24gYW5kL29yIG90aGVyIG1hdGVyaWFscyBwcm92aWRlZCB3aXRoIHRoZSBkaXN0cmlidXRpb24uXG4gKiAgICAgKiBOZWl0aGVyIHRoZSBuYW1lIG9mIEFqYXgub3JnIEIuVi4gbm9yIHRoZVxuICogICAgICAgbmFtZXMgb2YgaXRzIGNvbnRyaWJ1dG9ycyBtYXkgYmUgdXNlZCB0byBlbmRvcnNlIG9yIHByb21vdGUgcHJvZHVjdHNcbiAqICAgICAgIGRlcml2ZWQgZnJvbSB0aGlzIHNvZnR3YXJlIHdpdGhvdXQgc3BlY2lmaWMgcHJpb3Igd3JpdHRlbiBwZXJtaXNzaW9uLlxuICpcbiAqIFRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgVEhFIENPUFlSSUdIVCBIT0xERVJTIEFORCBDT05UUklCVVRPUlMgXCJBUyBJU1wiIEFORFxuICogQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhFIElNUExJRURcbiAqIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkVcbiAqIERJU0NMQUlNRUQuIElOIE5PIEVWRU5UIFNIQUxMIEFKQVguT1JHIEIuVi4gQkUgTElBQkxFIEZPUiBBTllcbiAqIERJUkVDVCwgSU5ESVJFQ1QsIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTXG4gKiAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVM7XG4gKiBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVTSU5FU1MgSU5URVJSVVBUSU9OKSBIT1dFVkVSIENBVVNFRCBBTkRcbiAqIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QgTElBQklMSVRZLCBPUiBUT1JUXG4gKiAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRSBVU0UgT0YgVEhJU1xuICogU09GVFdBUkUsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuXG4gKlxuICogKioqKiogRU5EIExJQ0VOU0UgQkxPQ0sgKioqKiogKi9cbiJdfQ==