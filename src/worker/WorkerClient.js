"use strict";
import { qualifyURL } from '../lib/net';
import EventEmitterClass from '../lib/EventEmitterClass';
export default class WorkerClient {
    constructor(workerUrl) {
        this.callbacks = {};
        this.callbackId = 1;
        this.eventBus = new EventEmitterClass(this);
        this.sendDeltaQueue = this.sendDeltaQueue.bind(this);
        this.changeListener = this.changeListener.bind(this);
        this.onMessage = this.onMessage.bind(this);
        var workerUrl = qualifyURL(workerUrl);
        try {
            this.$worker = new Worker(workerUrl);
        }
        catch (e) {
            if (e instanceof window['DOMException']) {
                var blob = this.$workerBlob(workerUrl);
                var URL = window['URL'] || window['webkitURL'];
                var blobURL = URL.createObjectURL(blob);
                this.$worker = new Worker(blobURL);
                URL.revokeObjectURL(blobURL);
            }
            else {
                throw e;
            }
        }
        this.$worker.onmessage = this.onMessage;
    }
    init(scriptImports, moduleName, className) {
        this.$worker.postMessage({
            init: true,
            scriptImports: scriptImports,
            moduleName: moduleName,
            className: className
        });
    }
    onMessage(event) {
        var origin = event.origin;
        var source = event.source;
        var msg = event.data;
        switch (msg.type) {
            case "log":
                window.console && console.log && console.log.apply(console, msg.data);
                break;
            case "event":
                this.eventBus._signal(msg.name, { data: msg.data });
                break;
            case "call":
                var callback = this.callbacks[msg.id];
                if (callback) {
                    callback(msg.data);
                    delete this.callbacks[msg.id];
                }
                break;
        }
    }
    $normalizePath(path) {
        return qualifyURL(path);
    }
    terminate() {
        this.eventBus._signal("terminate", {});
        this.deltaQueue = void 0;
        this.$worker.terminate();
        this.$worker = void 0;
    }
    send(cmd, args) {
        this.$worker.postMessage({ command: cmd, args: args });
    }
    call(cmd, args, callback) {
        if (callback) {
            var id = this.callbackId++;
            this.callbacks[id] = callback;
            args.push(id);
        }
        this.send(cmd, args);
    }
    invoke(cmd, args) {
        var workerClient = this;
        return new Promise(function (resolve, reject) {
            workerClient.call(cmd, args, function (retval) {
                if (retval.err) {
                    reject(retval.err);
                }
                else {
                    resolve(retval.data);
                }
            });
        });
    }
    emit(event, data) {
        try {
            this.$worker.postMessage({ event: event, data: { data: data.data } });
        }
        catch (e) {
            console.error(e.stack);
        }
    }
    attachToDocument(doc) {
        if (this.$doc) {
            if (this.$doc === doc) {
                return;
            }
            else {
                this.$doc.off('change', this.changeListener);
            }
        }
        this.$doc = doc;
        this.call("setValue", [doc.getValue()]);
        doc.on('change', this.changeListener);
    }
    detachFromDocument() {
        if (this.$doc) {
            this.$doc.off('change', this.changeListener);
            this.$doc = null;
        }
    }
    changeListener(e, doc) {
        if (!this.deltaQueue) {
            this.deltaQueue = [e.data];
            setTimeout(this.sendDeltaQueue, 0);
        }
        else {
            this.deltaQueue.push(e.data);
        }
    }
    on(eventName, callback) {
        this.eventBus.on(eventName, callback, false);
    }
    off(eventName, callback) {
        this.eventBus.off(eventName, callback);
    }
    sendDeltaQueue() {
        var doc = this.$doc;
        var queue = this.deltaQueue;
        if (!queue)
            return;
        this.deltaQueue = void 0;
        if (queue.length > 20 && queue.length > doc.getLength() >> 1) {
            this.call("setValue", [doc.getValue()]);
        }
        else {
            this.emit("change", { data: queue });
        }
    }
    $workerBlob(workerUrl) {
        var script = "importScripts('" + qualifyURL(workerUrl) + "');";
        try {
            return new Blob([script], { "type": "application/javascript" });
        }
        catch (e) {
            var BlobBuilder = window['BlobBuilder'] || window['WebKitBlobBuilder'] || window['MozBlobBuilder'];
            var blobBuilder = new BlobBuilder();
            blobBuilder.append(script);
            return blobBuilder.getBlob("application/javascript");
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV29ya2VyQ2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiV29ya2VyQ2xpZW50LnRzIl0sIm5hbWVzIjpbIldvcmtlckNsaWVudCIsIldvcmtlckNsaWVudC5jb25zdHJ1Y3RvciIsIldvcmtlckNsaWVudC5pbml0IiwiV29ya2VyQ2xpZW50Lm9uTWVzc2FnZSIsIldvcmtlckNsaWVudC4kbm9ybWFsaXplUGF0aCIsIldvcmtlckNsaWVudC50ZXJtaW5hdGUiLCJXb3JrZXJDbGllbnQuc2VuZCIsIldvcmtlckNsaWVudC5jYWxsIiwiV29ya2VyQ2xpZW50Lmludm9rZSIsIldvcmtlckNsaWVudC5lbWl0IiwiV29ya2VyQ2xpZW50LmF0dGFjaFRvRG9jdW1lbnQiLCJXb3JrZXJDbGllbnQuZGV0YWNoRnJvbURvY3VtZW50IiwiV29ya2VyQ2xpZW50LmNoYW5nZUxpc3RlbmVyIiwiV29ya2VyQ2xpZW50Lm9uIiwiV29ya2VyQ2xpZW50Lm9mZiIsIldvcmtlckNsaWVudC5zZW5kRGVsdGFRdWV1ZSIsIldvcmtlckNsaWVudC4kd29ya2VyQmxvYiJdLCJtYXBwaW5ncyI6IkFBQUEsWUFBWSxDQUFDO09BRU4sRUFBQyxVQUFVLEVBQUMsTUFBTSxZQUFZO09BSTlCLGlCQUFpQixNQUFNLDBCQUEwQjtBQWdDeEQ7SUE4Q0lBLFlBQVlBLFNBQWlCQTtRQXRCckJDLGNBQVNBLEdBQXlDQSxFQUFFQSxDQUFDQTtRQUNyREEsZUFBVUEsR0FBV0EsQ0FBQ0EsQ0FBQ0E7UUFzQjNCQSxJQUFJQSxDQUFDQSxRQUFRQSxHQUFHQSxJQUFJQSxpQkFBaUJBLENBQWVBLElBQUlBLENBQUNBLENBQUNBO1FBQzFEQSxJQUFJQSxDQUFDQSxjQUFjQSxHQUFHQSxJQUFJQSxDQUFDQSxjQUFjQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUNyREEsSUFBSUEsQ0FBQ0EsY0FBY0EsR0FBR0EsSUFBSUEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsSUFBSUEsQ0FB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QUVBLENBQUNBLEdBQUdBLENBQUNBLFFBQVFBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1FBQzVDQSxDQUFDQTtRQUNEQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUlGQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxRQUFRQSxFQUFFQSxFQUFFQSxJQUFJQSxFQUFFQSxLQUFLQSxFQUFFQSxDQUFDQSxDQUFDQTtRQUN6Q0EsQ0FBQ0E7SUFDTEEsQ0FBQ0E7SUFRT2YsV0FBV0EsQ0FBQ0EsU0FBaUJBO1FBR2pDZ0IsSUFBSUEsTUFBTUEsR0FBR0EsaUJBQWlCQSxHQUFHQSxVQUFVQSxDQUFDQSxTQUFTQSxDQUFDQSxHQUFHQSxLQUFLQSxDQUFDQTtRQUMvREEsSUFBSUEsQ0FBQ0E7WUFDREEsTUFBTUEsQ0FBQ0EsSUFBSUEsSUFBSUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsRUFBRUEsRUFBRUEsTUFBTUEsRUFBRUEsd0JBQXdCQSxFQUFFQSxDQUFDQSxDQUFDQTtRQUNwRUEsQ0FDQUE7UUFBQUEsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDUEEsSUFBSUEsV0FBV0EsR0FBR0EsTUFBTUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsSUFBSUEsTUFBTUEsQ0FBQ0EsbUJBQW1CQSxDQUFDQSxJQUFJQSxNQUFNQSxDQUFDQSxnQkFBZ0JBLENBQUNBLENBQUNBO1lBQ25HQSxJQUFJQSxXQUFXQSxHQUFHQSxJQUFJQSxXQUFXQSxFQUFFQSxDQUFDQTtZQUNwQ0EsV0FBV0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7WUFDM0JBLE1BQU1BLENBQUNBLFdBQVdBLENBQUNBLE9BQU9BLENBQUNBLHdCQUF3QkEsQ0FBQ0EsQ0FBQ0E7UUFDekRBLENBQUNBO0lBQ0xBLENBQUNBO0FBQ0xoQixDQUFDQTtBQUFBIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCB7cXVhbGlmeVVSTH0gZnJvbSAnLi4vbGliL25ldCc7XG5pbXBvcnQgRGVsdGEgZnJvbSBcIi4uL0RlbHRhXCI7XG5pbXBvcnQgRG9jdW1lbnQgZnJvbSBcIi4uL0RvY3VtZW50XCI7XG5pbXBvcnQgRXZlbnRCdXMgZnJvbSBcIi4uL0V2ZW50QnVzXCI7XG5pbXBvcnQgRXZlbnRFbWl0dGVyQ2xhc3MgZnJvbSAnLi4vbGliL0V2ZW50RW1pdHRlckNsYXNzJztcbmltcG9ydCB7Z2V0fSBmcm9tIFwiLi4vY29uZmlnXCI7XG5cbi8vIEZJWE1FOiBUaGlzIGNsYXNzIGlzIGJlZ2dpbmcgdG8gYmUgd3JpdHRlbiB1c2luZyB0aGUgZnVuY3Rpb25hbCBjb25zdHJ1Y3RvclxuLy8gcGF0dGVybiBpbiBvcmRlciB0byBwcm92aWRlIGJldHRlciBlbmNhcHN1bGF0aW9uIGFuZCBhdm9pZCB0aGUgYHRoaXNgIGJpbmRpbmdcbi8vIGlzc3VlcyBhc3NvY2lhdGVkIHdpdGggdGhlIGNsYXNzIHBhdHRlcm4gb3IgY2xhc3Mgc3ludGFjdGljIHN1Z2FyLlxuXG4vKipcbiAqIDxwPlxuICogV29ya2VyQ2xpZW50IGNvbnRyb2xzIHRoZSBpbnRlcmFjdGlvbiBiZXR3ZWVuIGFuIGVkaXRvciBkb2N1bWVudFxuICogYW5kIGEgV2ViIFdvcmtlci5cbiAqIDwvcD5cbiAqIEl0IHByb3ZpZGVzIGFkZGl0aW9uYWwgY2FwYWJpbGl0aWVzIGJ5IGJlaW5nIGEgd3JhcHBlciBhcm91bmRcbiAqIGFuIHVuZGVybHlpbmcgV2ViIFdvcmtlcjpcbiAqIDx1bD5cbiAqIDxsaT5cbiAqIEl0IGlzIGEgY29udHJvbGxlciBiZXR3ZWVuIHRoZSBlZGl0b3JcbiAqIDxjb2RlPkRvY3VtZW50PC9jb2RlPiBhbmQgdGhlIDxjb2RlPldvcmtlcjwvY29kZT4gdGhyZWFkLlxuICogPC9saT5cbiAqIDxsaT5cbiAqIEl0IGlzIGEgcHJveHkgdG8gdGhlIHVuZGVybHlpbmcgd29ya2VyIHRocmVhZCBieSBwcm92aWRpbmdcbiAqIGNvbnZlbmllbmNlIGZ1bmN0aW9ucyBmb3IgYm90aCBhbnN5Y2hyb25vdXMgcG9zdE1lc3NhZ2UgYXNcbiAqIHdlbGwgYXMgYXluY2hyb25vdXMgcmVxdWVzdC9yZXNwb25zZSBwYXR0ZXJucy5cbiAqIDwvbGk+XG4gKiA8bGk+XG4gKiBJdCBpcyBhIG1lc3NhZ2UgaHViLCBhbGxvd2luZyBsaXN0ZW5lcnMgdG8gY29ubmVjdCB0byBpdFxuICogYW5kIHJlY2VpdmUgZXZlbnRzIHRoYXQgb3JpZ2luYXRlZCBpbiB0aGUgd29ya2VyIHRocmVhZC5cbiAqIDwvbGk+XG4gKiA8L3VsPlxuICpcbiAqIEBjbGFzcyBXb3JrZXJDbGllbnRcbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgV29ya2VyQ2xpZW50IGltcGxlbWVudHMgRXZlbnRCdXM8V29ya2VyQ2xpZW50PiB7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgdW5kZXJseWluZyBXZWIgV29ya2VyLlxuICAgICAqIEBwcm9wZXJ0eSAkd29ya2VyXG4gICAgICogQHR5cGUgV29ya2VyXG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBwcml2YXRlICR3b3JrZXI6IFdvcmtlcjtcblxuICAgIC8qKlxuICAgICAqIENoYW5nZXMgaW4gdGhlIERvY3VtZW50IGFyZSBxdWV1ZWQgaGVyZSBzbyB0aGF0IHRoZXkgY2FuXG4gICAgICogbGF0ZXIgYmUgcG9zdGVkIHRvIHRoZSB3b3JrZXIgdGhyZWFkLlxuICAgICAqXG4gICAgICogQHByb3BlcnR5IGRlbHRhUXVldWVcbiAgICAgKiBAdHlwZSBEZWx0YVtdXG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBwcml2YXRlIGRlbHRhUXVldWU6IERlbHRhW107XG5cbiAgICAvLyBUaGUgZm9sbG93aW5nIGltcGxlbWVudGF0aW9uIHByb3ZpZGVzIGEgZ2VuZXJpYyBhcHByb2FjaFxuICAgIC8vIGZvciBtYWtpbmcgYXN5bmNocm9ub3VzIHJlcXVlc3QvcmVzcG9uc2UgY2FsbHMuXG4gICAgLy8gVE9ETzogTWFrZSB0aGlzIHJldXNhYmxlP1xuICAgIC8vIFRPRE86IFByb3ZpZGUgYSBQcm9taXNlLWxpa2UgY2FwYWJpbGl0eT9cbiAgICBwcml2YXRlIGNhbGxiYWNrczogeyBbaWQ6IG51bWJlcl06IChkYXRhOiBhbnkpID0+IGFueSB9ID0ge307XG4gICAgcHJpdmF0ZSBjYWxsYmFja0lkOiBudW1iZXIgPSAxO1xuXG4gICAgLyoqXG4gICAgICogQHByb3BlcnR5IGVkaXRvckRvY3VtZW50XG4gICAgICogQHR5cGUgRG9jdW1lbnRcbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIHByaXZhdGUgJGRvYzogRG9jdW1lbnQ7XG5cbiAgICAvKipcbiAgICAgKiBAcHJvcGVydHkgZXZlbnRCdXNcbiAgICAgKiBAdHlwZSBFdmVudEVtaXR0ZXJDbGFzczxXb3JrZXJDbGllbnQ+XG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBwcml2YXRlIGV2ZW50QnVzOiBFdmVudEVtaXR0ZXJDbGFzczxXb3JrZXJDbGllbnQ+O1xuXG4gICAgLyoqXG4gICAgICogQGNsYXNzIFdvcmtlckNsaWVudFxuICAgICAqIEBjb25zdHJ1Y3RvclxuICAgICAqIEBwYXJhbSB3b3JrZXJVcmwge3N0cmluZ31cbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcih3b3JrZXJVcmw6IHN0cmluZykge1xuICAgICAgICB0aGlzLmV2ZW50QnVzID0gbmV3IEV2ZW50RW1pdHRlckNsYXNzPFdvcmtlckNsaWVudD4odGhpcyk7XG4gICAgICAgIHRoaXMuc2VuZERlbHRhUXVldWUgPSB0aGlzLnNlbmREZWx0YVF1ZXVlLmJpbmQodGhpcyk7XG4gICAgICAgIHRoaXMuY2hhbmdlTGlzdGVuZXIgPSB0aGlzLmNoYW5nZUxpc3RlbmVyLmJpbmQodGhpcyk7XG4gICAgICAgIHRoaXMub25NZXNzYWdlID0gdGhpcy5vbk1lc3NhZ2UuYmluZCh0aGlzKTtcblxuICAgICAgICB2YXIgd29ya2VyVXJsID0gcXVhbGlmeVVSTCh3b3JrZXJVcmwpO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB0aGlzLiR3b3JrZXIgPSBuZXcgV29ya2VyKHdvcmtlclVybCk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGlmIChlIGluc3RhbmNlb2Ygd2luZG93WydET01FeGNlcHRpb24nXSkge1xuICAgICAgICAgICAgICAgIC8vIExpa2VseSBzYW1lIG9yaWdpbiBwcm9ibGVtLiBVc2UgaW1wb3J0U2NyaXB0cyBmcm9tIGEgc2hpbSBXb3JrZXIuXG4gICAgICAgICAgICAgICAgdmFyIGJsb2I6IEJsb2IgPSB0aGlzLiR3b3JrZXJCbG9iKHdvcmtlclVybCk7XG4gICAgICAgICAgICAgICAgdmFyIFVSTDogVVJMID0gd2luZG93WydVUkwnXSB8fCB3aW5kb3dbJ3dlYmtpdFVSTCddO1xuICAgICAgICAgICAgICAgIHZhciBibG9iVVJMOiBzdHJpbmcgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpO1xuXG4gICAgICAgICAgICAgICAgdGhpcy4kd29ya2VyID0gbmV3IFdvcmtlcihibG9iVVJMKTtcbiAgICAgICAgICAgICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKGJsb2JVUkwpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIEFkZCBhbiBFdmVudExpc3RlbmVyIGZvciBkYXRhIHRoZSB3b3JrZXIgcmV0dXJucy5cbiAgICAgICAgdGhpcy4kd29ya2VyLm9ubWVzc2FnZSA9IHRoaXMub25NZXNzYWdlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBvc3RzIGEgbWVzc2FnZSB0byB0aGUgd29ya2VyIHRocmVhZCBjYXVzaW5nIHRoZSB0aHJlYWQgdG8gYmUgc3RhcnRlZC5cbiAgICAgKlxuICAgICAqIEBtZXRob2QgaW5pdFxuICAgICAqIEBwYXJhbSBzY3JpcHRJbXBvcnRzIHtzdHJpbmdbXX1cbiAgICAgKiBAcGFyYW0gbW9kdWxlTmFtZSB7c3RyaW5nfVxuICAgICAqIEBwYXJhbSBjbGFzc05hbWUge3N0cmluZ31cbiAgICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgICAqL1xuICAgIGluaXQoc2NyaXB0SW1wb3J0czogc3RyaW5nW10sIG1vZHVsZU5hbWU6IHN0cmluZywgY2xhc3NOYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgLy8gU2VuZGluZyBhIHBvc3RNZXNzYWdlIHN0YXJ0cyB0aGUgd29ya2VyLlxuICAgICAgICB0aGlzLiR3b3JrZXIucG9zdE1lc3NhZ2Uoe1xuICAgICAgICAgICAgaW5pdDogdHJ1ZSxcbiAgICAgICAgICAgIHNjcmlwdEltcG9ydHM6IHNjcmlwdEltcG9ydHMsXG4gICAgICAgICAgICBtb2R1bGVOYW1lOiBtb2R1bGVOYW1lLFxuICAgICAgICAgICAgY2xhc3NOYW1lOiBjbGFzc05hbWVcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGhpcyBtZXRob2QgaXMgaXMgdXNlZCBhcyB0aGUgY2FsbGJhY2sgZnVuY3Rpb24gZm9yIHRoZSBXb3JrZXIgdGhyZWFkXG4gICAgICogYW5kIHNvIGl0IHJlY2VpdmVzIGFsbCBtZXNzYWdlcyBwb3N0ZWQgYmFjayBmcm9tIHRoYXQgdGhyZWFkLlxuICAgICAqXG4gICAgICogQG1ldGhvZCBvbk1lc3NhZ2VcbiAgICAgKiBAcGFyYW0gZXZlbnQge01lc3NhZ2VFdmVudH1cbiAgICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgcHJpdmF0ZSBvbk1lc3NhZ2UoZXZlbnQ6IE1lc3NhZ2VFdmVudCk6IHZvaWQge1xuICAgICAgICB2YXIgb3JpZ2luOiBzdHJpbmcgPSBldmVudC5vcmlnaW47XG4gICAgICAgIHZhciBzb3VyY2U6IFdpbmRvdyA9IGV2ZW50LnNvdXJjZTtcbiAgICAgICAgdmFyIG1zZyA9IGV2ZW50LmRhdGE7XG4gICAgICAgIC8vIFRPRE86IEludGVyZmFjZXMgZm9yIGRhdGEgZXhjaGFuZ2VkLlxuICAgICAgICBzd2l0Y2ggKG1zZy50eXBlKSB7XG5cbiAgICAgICAgICAgIGNhc2UgXCJsb2dcIjpcbiAgICAgICAgICAgICAgICB3aW5kb3cuY29uc29sZSAmJiBjb25zb2xlLmxvZyAmJiBjb25zb2xlLmxvZy5hcHBseShjb25zb2xlLCBtc2cuZGF0YSk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgXCJldmVudFwiOlxuICAgICAgICAgICAgICAgIC8vIFRPRE86IEVudW1lcmF0ZSB0aGUgZXZlbnQgbmFtZXMgZm9yIGRvY3VtZW50YXRpb24gcHVycG9zZXMuXG4gICAgICAgICAgICAgICAgLy8gU29tZSB3aWxsIGJlIHN0YW5kYXJkIGJlY3Vhc2UgdGhleSBhcmUgYXNzb2NpYXRlZCB3aXRoIHRoZVxuICAgICAgICAgICAgICAgIC8vIFdvcmtlckNsaWVudCBwcm90b2NvbC4gT3RoZXJzIHdpbGwgYmUgdW5kb2N1bWVudGVkIGFuZCBjdXN0b21cbiAgICAgICAgICAgICAgICAvLyBiZWNhdXNlIHRoZXkgYXJlIHNwZWNpZmljIHRvIHRoZSBwYXJ0aWN1bGFyIGltcGxlbWVudGF0aW9uLlxuICAgICAgICAgICAgICAgIC8qKlxuICAgICAgICAgICAgICAgICAqIEBldmVudCBUT0RPXG4gICAgICAgICAgICAgICAgICovXG4gICAgICAgICAgICAgICAgdGhpcy5ldmVudEJ1cy5fc2lnbmFsKG1zZy5uYW1lLCB7IGRhdGE6IG1zZy5kYXRhIH0pO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlIFwiY2FsbFwiOlxuICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IHRoaXMuY2FsbGJhY2tzW21zZy5pZF07XG4gICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKG1zZy5kYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuY2FsbGJhY2tzW21zZy5pZF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG1ldGhvZCAkbm9ybWFsaXplUGF0aFxuICAgICAqIEBwYXJhbSBwYXRoIHtzdHJpbmd9XG4gICAgICogQHJldHVybiB7c3RyaW5nfVxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgcHJpdmF0ZSAkbm9ybWFsaXplUGF0aChwYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gcXVhbGlmeVVSTChwYXRoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAbWV0aG9kIHRlcm1pbmF0ZVxuICAgICAqIEByZXR1cm4ge3ZvaWR9XG4gICAgICovXG4gICAgdGVybWluYXRlKCk6IHZvaWQge1xuICAgICAgICAvKipcbiAgICAgICAgICogQGV2ZW50IHRlcm1pbmF0ZVxuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5ldmVudEJ1cy5fc2lnbmFsKFwidGVybWluYXRlXCIsIHt9KTtcbiAgICAgICAgdGhpcy5kZWx0YVF1ZXVlID0gdm9pZCAwO1xuICAgICAgICB0aGlzLiR3b3JrZXIudGVybWluYXRlKCk7XG4gICAgICAgIHRoaXMuJHdvcmtlciA9IHZvaWQgMDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBQb3N0cyBhIG1lc3NhZ2UgdG8gdGhlIHdvcmtlciB0aHJlYWQgd2l0aCBhIHNwZWNpZmljIGNvbW1hbmQgZGF0YSBzdHJ1Y3R1cmUuXG4gICAgICpcbiAgICAgKiBAbWV0aG9kIHNlbmRcbiAgICAgKiBAcGFyYW0gY21kIHtzdHJpbmd9XG4gICAgICogQHJldHVybiB7dm9pZH1cbiAgICAgKi9cbiAgICAvLyBGSVhNRTogUmVuYW1lIHRoaXMgcG9zdENvbW1hbmQgaW4gb3JkZXIgdG8gYmUgbW9yZSBvYnZpb3VzIHRoYXRcbiAgICAvLyB3ZSBhcmUgYWN0aW5nIGFzIGEgY29uZHVpdCB0byB0aGUgd29ya2VyIHRocmVhZC5cbiAgICAvLyBGSVhNRTogQ2FwdHVyZSB0aGUgc3RydWN0dXJlIHVzaW5nIGEgZC50cyBmaWxlLlxuICAgIHNlbmQoY21kOiBzdHJpbmcsIGFyZ3MpOiB2b2lkIHtcbiAgICAgICAgdGhpcy4kd29ya2VyLnBvc3RNZXNzYWdlKHsgY29tbWFuZDogY21kLCBhcmdzOiBhcmdzIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRoaXMgaXMgYSB3cmFwcGVyIGFyb3VuZCB0aGUgdGhlIGFzeW5jaHJvbm91cyBwb3N0IHRvIHRoZSB3b3JrZXIgdGhyZWFkXG4gICAgICogdGhhdCBhbGxvd3MgdXMgdG8gcHJvdmlkZSBhIGNhbGxiYWNrIGZ1bmN0aW9uIGZvciBhbiBhbnRpY2lwYXRlZCBwb3N0XG4gICAgICogcmVzcG9uc2UuXG4gICAgICpcbiAgICAgKiBAbWV0aG9kIGNhbGxcbiAgICAgKiBAcGFyYW0gY21kIHtzdHJpbmd9XG4gICAgICogQHBhcmFtIGFyZ3NcbiAgICAgKiBAcGFyYW0gY2FsbGJhY2tcbiAgICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgICAqL1xuICAgIC8vIFRPRE86IFByb3ZpZGUgYSBQcm9taXNlLWJhc2VkIHZlcnNpb24gb2YgdGhpcyBtZXRob2QgYW5kIHNlZSBpZiBpdCBtYWtlcyB0aGUgY29kZVxuICAgIC8vIG1vcmUgbWFpbnRhaW5hYmxlLlxuICAgIGNhbGwoY21kOiBzdHJpbmcsIGFyZ3MsIGNhbGxiYWNrPzogKGRhdGE6IGFueSkgPT4gYW55KTogdm9pZCB7XG4gICAgICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgICAgICAgdmFyIGlkID0gdGhpcy5jYWxsYmFja0lkKys7XG4gICAgICAgICAgICB0aGlzLmNhbGxiYWNrc1tpZF0gPSBjYWxsYmFjaztcbiAgICAgICAgICAgIGFyZ3MucHVzaChpZCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZW5kKGNtZCwgYXJncyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVy5JLlAuIGV4cGVyaW1lbnQgYXQgdXNpbmcgcHJvbWlzZXMgZm9yIHRoZSBBUEkuXG4gICAgICogVGhpcyBoaWdobGlnaHRzIHRoZSBuZWVkIGZvciBhIHByb3RvY29sIGJldHdlZW5cbiAgICAgKiB0aGUgV29ya2VyIHRocmVhZCBpbXBsZW1lbnRhdGlvbiBhbmQgdGhpcyBXb3JrZXJDbGllbnQuXG4gICAgICogVE9ETzogQ29tcGxldGUuXG4gICAgICogVE9ETzogQ2FuIHdlIGdldCB0eXBlLXNhZmV0eSBpbiB0aGUgUHJvbWlzZT9cbiAgICAgKiBXZSBtaWdodCBuZWVkIGFuIGFyZ3VtZW50IG9mIHR5cGUgVCB0byBtYWtlIHRoaXMgaGFwcGVuLlxuICAgICAqXG4gICAgICogQG1ldGhvZCBpbnZva2VcbiAgICAgKiBAcGFyYW0gY21kXG4gICAgICogQHBhcmFtIGFyZ3NcbiAgICAgKiBAcmV0dXJuIHtQcm9taXNlfVxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgcHJpdmF0ZSBpbnZva2U8VD4oY21kOiBzdHJpbmcsIGFyZ3MpOiBQcm9taXNlPFQ+IHtcbiAgICAgICAgdmFyIHdvcmtlckNsaWVudCA9IHRoaXM7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxhbnk+KGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICAgICAgd29ya2VyQ2xpZW50LmNhbGwoY21kLCBhcmdzLCBmdW5jdGlvbihyZXR2YWw6IHsgZXJyOiBhbnk7IGRhdGE6IFQgfSkge1xuICAgICAgICAgICAgICAgIC8vIEl0J3MgY2xlYXIgbm93IHRoYXQgdGhlIGNhbGxiYWNrIGZ1bmN0aW9uIG9yIGRhdGFcbiAgICAgICAgICAgICAgICAvLyBzaG91bGQgcHJvdmlkZSBzb21lIG1lYW5zIHRvIGRpc3Rpbmd1aXNoIGJldHdlZW5cbiAgICAgICAgICAgICAgICAvLyBhbiBlcnJvciBhbmQgYSBub3JtYWwgZXhlY3V0aW9uLiBUaGlzIHdvdWxkIHJlcXVpcmVcbiAgICAgICAgICAgICAgICAvLyBhIHByb3RvY2FsIGJldHdlZW4gdGhlIHRoZSBXb3JrZXJDbGllbnQgYW5kIHRoZVxuICAgICAgICAgICAgICAgIC8vIGltcGxlbWVudGF0aW9uIG9mIHRoZSBXb3JrZXIgdGhyZWFkLlxuICAgICAgICAgICAgICAgIGlmIChyZXR2YWwuZXJyKSB7XG4gICAgICAgICAgICAgICAgICAgIHJlamVjdChyZXR2YWwuZXJyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgIHJlc29sdmUocmV0dmFsLmRhdGEpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pXG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFBvc3RzIGEgbWVzc2FnZSB0byB0aGUgd29ya2VyIHRocmVhZCB3aXRoIGEgc3BlY2lmaWMgZXZlbnQgZGF0YSBzdHJ1Y3R1cmUuXG4gICAgICpcbiAgICAgKiBAbWV0aG9kIGVtaXRcbiAgICAgKiBAcGFyYW0gZXZlbnQge3N0cmluZ30gVGhlIG5hbWUgb2YgdGhlIGV2ZW50LlxuICAgICAqIEBwYXJhbSBkYXRhXG4gICAgICogQHJldHVybiB7dm9pZH1cbiAgICAgKi9cbiAgICAvLyBGSVhNRVxuICAgIGVtaXQoZXZlbnQ6IHN0cmluZywgZGF0YSk6IHZvaWQge1xuICAgICAgICB0cnkge1xuICAgICAgICAgICAgLy8gZmlyZWZveCByZWZ1c2VzIHRvIGNsb25lIG9iamVjdHMgd2hpY2ggaGF2ZSBmdW5jdGlvbiBwcm9wZXJ0aWVzXG4gICAgICAgICAgICAvLyBUT0RPOiBjbGVhbnVwIGV2ZW50XG4gICAgICAgICAgICB0aGlzLiR3b3JrZXIucG9zdE1lc3NhZ2UoeyBldmVudDogZXZlbnQsIGRhdGE6IHsgZGF0YTogZGF0YS5kYXRhIH0gfSk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZS5zdGFjayk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAbWV0aG9kIGF0dGFjaFRvRG9jdW1lbnRcbiAgICAgKiBAcGFyYW0gZG9jIHtEb2N1bWVudH1cbiAgICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgICAqL1xuICAgIGF0dGFjaFRvRG9jdW1lbnQoZG9jOiBEb2N1bWVudCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy4kZG9jKSB7XG4gICAgICAgICAgICBpZiAodGhpcy4kZG9jID09PSBkb2MpIHtcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICB0aGlzLiRkb2Mub2ZmKCdjaGFuZ2UnLCB0aGlzLmNoYW5nZUxpc3RlbmVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLiRkb2MgPSBkb2M7XG4gICAgICAgIHRoaXMuY2FsbChcInNldFZhbHVlXCIsIFtkb2MuZ2V0VmFsdWUoKV0pO1xuICAgICAgICBkb2Mub24oJ2NoYW5nZScsIHRoaXMuY2hhbmdlTGlzdGVuZXIpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBtZXRob2QgZGV0YWNoRnJvbURvY3VtZW50XG4gICAgICogQHJldHVybiB7dm9pZH1cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIHB1YmxpYyBkZXRhY2hGcm9tRG9jdW1lbnQoKTogdm9pZCB7XG4gICAgICAgIGlmICh0aGlzLiRkb2MpIHtcbiAgICAgICAgICAgIHRoaXMuJGRvYy5vZmYoJ2NoYW5nZScsIHRoaXMuY2hhbmdlTGlzdGVuZXIpO1xuICAgICAgICAgICAgdGhpcy4kZG9jID0gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRoaXMgbWV0aG9kIGlzIHVzZWQgdG8gaGFuZGxlICdjaGFuZ2UnIGV2ZW50cyBpbiB0aGUgZG9jdW1lbnQuXG4gICAgICogV2hlbiB0aGUgZG9jdW1lbnQgY2hhbmdlcyAocmVwb3J0ZWQgYXMgYSBEZWx0YSksIHRoZSBkZWx0YSBpcyBhZGRlZCB0b1xuICAgICAqIHRoZSBkZWx0YVF1ZXVlIG1lbWJlciBvZiB0aGlzIFdvcmtlckNsaWVudC4gQXMgaXMgZ29vZCBwcmFjdGljZSwgdGhlXG4gICAgICogY2hhbmUgaXMgbm90IGFjdGVkIHVwb24gaW1tZWRpYXRlbHkuXG4gICAgICpcbiAgICAgKiBUaGlzIG1ldGhvZCBpcyByZXBsYWNlZCBpbiB0aGUgY29uc3RydWN0b3IgYnkgYSBmdW5jdGlvbiB0aGF0IGlzIGJvdW5kIHRvIGB0aGlzYC5cbiAgICAgKlxuICAgICAqIEBtZXRob2QgY2hhbmdlTGlzdGVuZXJcbiAgICAgKiBAcGFyYW0gZSB7e2RhdGE6IERlbHRhfX1cbiAgICAgKiBAcGFyYW0gZG9jIHtEb2N1bWVudH1cbiAgICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgLy8gVE9ETzogSXQgd291bGQgYmUgYmV0dGVyIGlmIHRoaXMgd2FzIGF3YXkgZnJvbSB0aGUgV29ya2VyQ2xpZW50IEFQSS5cbiAgICBwcml2YXRlIGNoYW5nZUxpc3RlbmVyKGU6IHsgZGF0YTogRGVsdGEgfSwgZG9jOiBEb2N1bWVudCk6IHZvaWQge1xuICAgICAgICBpZiAoIXRoaXMuZGVsdGFRdWV1ZSkge1xuICAgICAgICAgICAgdGhpcy5kZWx0YVF1ZXVlID0gW2UuZGF0YV07XG4gICAgICAgICAgICBzZXRUaW1lb3V0KHRoaXMuc2VuZERlbHRhUXVldWUsIDApO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5kZWx0YVF1ZXVlLnB1c2goZS5kYXRhKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBtZXRob2Qgb25cbiAgICAgKiBAcGFyYW0gZXZlbnROYW1lIHtzdHJpbmd9XG4gICAgICogQHBhcmFtIGNhbGxiYWNrIHsoZXZlbnQsIHNvdXJjZTogV29ya2VyQ2xpZW50KSA9PiBhbnl9XG4gICAgICogQHJldHVybiB7dm9pZH1cbiAgICAgKi9cbiAgICBvbihldmVudE5hbWU6IHN0cmluZywgY2FsbGJhY2s6IChldmVudDogYW55LCBzb3VyY2U6IFdvcmtlckNsaWVudCkgPT4gYW55KTogdm9pZCB7XG4gICAgICAgIHRoaXMuZXZlbnRCdXMub24oZXZlbnROYW1lLCBjYWxsYmFjaywgZmFsc2UpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBtZXRob2Qgb2ZmXG4gICAgICogQHBhcmFtIGV2ZW50TmFtZSB7c3RyaW5nfVxuICAgICAqIEBwYXJhbSBjYWxsYmFjayB7KGV2ZW50LCBzb3VyY2U6IFdvcmtlckNsaWVudCkgPT4gYW55fVxuICAgICAqIEByZXR1cm4ge3ZvaWR9XG4gICAgICovXG4gICAgb2ZmKGV2ZW50TmFtZTogc3RyaW5nLCBjYWxsYmFjazogKGV2ZW50OiBhbnksIHNvdXJjZTogV29ya2VyQ2xpZW50KSA9PiBhbnkpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5ldmVudEJ1cy5vZmYoZXZlbnROYW1lLCBjYWxsYmFjayk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogVGhpcyBtZXRob2QgaXMgaW50ZW5kZWQgdG8gYmUgdXNlZCBhcyBhIGNhbGxiYWNrIGZvciBzZXRUaW1lb3V0LlxuICAgICAqIEl0IGlzIHJlcGxhY2VkIGJ5IGEgdmVyc2lvbiB0aGF0IGlzIGJvdW5kIHRvIGB0aGlzYC5cbiAgICAgKiBcbiAgICAgKiBAbWV0aG9kIHNlbmREZWx0YVF1ZXVlXG4gICAgICogQHJldHVybiB7dm9pZH1cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIHByaXZhdGUgc2VuZERlbHRhUXVldWUoKTogdm9pZCB7XG4gICAgICAgIHZhciBkb2MgPSB0aGlzLiRkb2M7XG4gICAgICAgIHZhciBxdWV1ZSA9IHRoaXMuZGVsdGFRdWV1ZTtcbiAgICAgICAgaWYgKCFxdWV1ZSkgcmV0dXJuO1xuICAgICAgICB0aGlzLmRlbHRhUXVldWUgPSB2b2lkIDA7XG5cbiAgICAgICAgLy8gV2UncmUgZ29pbmcgdG8gcG9zdCBhbGwgdGhlIGNoYW5nZXMgaW4gb25lIG1lc3NhZ2UsIGJ1dCB3ZSBhcHBseSBhXG4gICAgICAgIC8vIGhldXJpc3RpYyB0byBqdXN0IHNlbmQgdGhlIGFjdHVhbCBkb2N1bWVudCBpZiB0aGVyZSBhcmUgZW5vdWdoIGNoYW5nZXMuXG4gICAgICAgIGlmIChxdWV1ZS5sZW5ndGggPiAyMCAmJiBxdWV1ZS5sZW5ndGggPiBkb2MuZ2V0TGVuZ3RoKCkgPj4gMSkge1xuICAgICAgICAgICAgLy8gVE9ETzogSWYgdGhlcmUgaXMgbm8gY2FsbGJhY2sgdGhlbiBjYWxsIGlzIHRoZSBzYW1lIGFzIHNlbmQsXG4gICAgICAgICAgICAvLyB3aGljaCBpcyBhIHBvc3RDb21tYW5kLlxuICAgICAgICAgICAgdGhpcy5jYWxsKFwic2V0VmFsdWVcIiwgW2RvYy5nZXRWYWx1ZSgpXSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAvLyBUT0RPOiBUaGlzIG1ldGhvZCBzaG91bGQgcHJvYmFibHkgYmUgY2FsbGVkICdjaGFuZ2VzJywgc2luY2UgdGhlXG4gICAgICAgICAgICAvLyBkYXRhIHdhcyBhY2N1bXVsYXRlZCBmcm9tIG9uZSBvciBtb3JlIGNoYW5nZSBldmVudHMuXG4gICAgICAgICAgICAvLyBUT0RPOiBlbW90IGNvdW5kIGJlIHJlbmFtZWQgcG9zdEV2ZW50LCB3aGljaCBpcyBtb3JlIGRlc2NyaXB0aXZlLlxuICAgICAgICAgICAgdGhpcy5lbWl0KFwiY2hhbmdlXCIsIHsgZGF0YTogcXVldWUgfSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAbWV0aG9kICR3b3JrZXJCbG9iXG4gICAgICogQHBhcmFtIHdvcmtlclVybCB7c3RyaW5nfVxuICAgICAqIEByZXR1cm4ge0Jsb2J9XG4gICAgICogQHByaXZhdGVcbiAgICAgKi9cbiAgICBwcml2YXRlICR3b3JrZXJCbG9iKHdvcmtlclVybDogc3RyaW5nKTogQmxvYiB7XG4gICAgICAgIC8vIHdvcmtlclVybCBjYW4gYmUgcHJvdG9jb2wgcmVsYXRpdmVcbiAgICAgICAgLy8gaW1wb3J0U2NyaXB0cyBvbmx5IHRha2VzIGZ1bGx5IHF1YWxpZmllZCB1cmxzXG4gICAgICAgIHZhciBzY3JpcHQgPSBcImltcG9ydFNjcmlwdHMoJ1wiICsgcXVhbGlmeVVSTCh3b3JrZXJVcmwpICsgXCInKTtcIjtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgQmxvYihbc2NyaXB0XSwgeyBcInR5cGVcIjogXCJhcHBsaWNhdGlvbi9qYXZhc2NyaXB0XCIgfSk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGUpIHsgLy8gQmFja3dhcmRzLWNvbXBhdGliaWxpdHlcbiAgICAgICAgICAgIHZhciBCbG9iQnVpbGRlciA9IHdpbmRvd1snQmxvYkJ1aWxkZXInXSB8fCB3aW5kb3dbJ1dlYktpdEJsb2JCdWlsZGVyJ10gfHwgd2luZG93WydNb3pCbG9iQnVpbGRlciddO1xuICAgICAgICAgICAgdmFyIGJsb2JCdWlsZGVyID0gbmV3IEJsb2JCdWlsZGVyKCk7XG4gICAgICAgICAgICBibG9iQnVpbGRlci5hcHBlbmQoc2NyaXB0KTtcbiAgICAgICAgICAgIHJldHVybiBibG9iQnVpbGRlci5nZXRCbG9iKFwiYXBwbGljYXRpb24vamF2YXNjcmlwdFwiKTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuLyogKioqKiogQkVHSU4gTElDRU5TRSBCTE9DSyAqKioqKlxuICogRGlzdHJpYnV0ZWQgdW5kZXIgdGhlIEJTRCBsaWNlbnNlOlxuICpcbiAqIENvcHlyaWdodCAoYykgMjAxMCwgQWpheC5vcmcgQi5WLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBSZWRpc3RyaWJ1dGlvbiBhbmQgdXNlIGluIHNvdXJjZSBhbmQgYmluYXJ5IGZvcm1zLCB3aXRoIG9yIHdpdGhvdXRcbiAqIG1vZGlmaWNhdGlvbiwgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OlxuICogICAgICogUmVkaXN0cmlidXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHRcbiAqICAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci5cbiAqICAgICAqIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0XG4gKiAgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIgaW4gdGhlXG4gKiAgICAgICBkb2N1bWVudGF0aW9uIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLlxuICogICAgICogTmVpdGhlciB0aGUgbmFtZSBvZiBBamF4Lm9yZyBCLlYuIG5vciB0aGVcbiAqICAgICAgIG5hbWVzIG9mIGl0cyBjb250cmlidXRvcnMgbWF5IGJlIHVzZWQgdG8gZW5kb3JzZSBvciBwcm9tb3RlIHByb2R1Y3RzXG4gKiAgICAgICBkZXJpdmVkIGZyb20gdGhpcyBzb2Z0d2FyZSB3aXRob3V0IHNwZWNpZmljIHByaW9yIHdyaXR0ZW4gcGVybWlzc2lvbi5cbiAqXG4gKiBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIFRIRSBDT1BZUklHSFQgSE9MREVSUyBBTkQgQ09OVFJJQlVUT1JTIFwiQVMgSVNcIiBBTkRcbiAqIEFOWSBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRSBJTVBMSUVEXG4gKiBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFXG4gKiBESVNDTEFJTUVELiBJTiBOTyBFVkVOVCBTSEFMTCBBSkFYLk9SRyBCLlYuIEJFIExJQUJMRSBGT1IgQU5ZXG4gKiBESVJFQ1QsIElORElSRUNULCBJTkNJREVOVEFMLCBTUEVDSUFMLCBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFU1xuICogKElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRFIEdPT0RTIE9SIFNFUlZJQ0VTO1xuICogTE9TUyBPRiBVU0UsIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTIElOVEVSUlVQVElPTikgSE9XRVZFUiBDQVVTRUQgQU5EXG4gKiBPTiBBTlkgVEhFT1JZIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUIExJQUJJTElUWSwgT1IgVE9SVFxuICogKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZIE9VVCBPRiBUSEUgVVNFIE9GIFRISVNcbiAqIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLlxuICpcbiAqICoqKioqIEVORCBMSUNFTlNFIEJMT0NLICoqKioqICovXG4iXX0=