"use strict";
import { applyMixins } from "../lib/mix";
import HashHandler from "../keyboard/HashHandler";
import EventEmitterClass from "../lib/EventEmitterClass";
export default class CommandManager {
    constructor(platform, commands) {
        this.eventBus = new EventEmitterClass(this);
        this.hashHandler = new HashHandler(commands, platform);
        this.eventBus.setDefaultHandler("exec", function (e) {
            return e.command.exec(e.editor, e.args || {});
        });
    }
    get platform() {
        return this.hashHandler.platform;
    }
    get commands() {
        return this.hashHandler.commands;
    }
    get commandKeyBinding() {
        return this.hashHandler.commandKeyBinding;
    }
    bindKey(key, command) {
        return this.hashHandler.bindKey(key, command);
    }
    bindKeys(keyList) {
        return this.hashHandler.bindKeys(keyList);
    }
    addCommand(command) {
        this.hashHandler.addCommand(command);
    }
    removeCommand(commandName) {
        this.hashHandler.removeCommand(commandName);
    }
    findKeyCommand(hashId, keyString) {
        return this.hashHandler.findKeyCommand(hashId, keyString);
    }
    parseKeys(keys) {
        return this.hashHandler.parseKeys(keys);
    }
    addCommands(commands) {
        this.hashHandler.addCommands(commands);
    }
    removeCommands(commands) {
        this.hashHandler.removeCommands(commands);
    }
    handleKeyboard(data, hashId, keyString, keyCode) {
        return this.hashHandler.handleKeyboard(data, hashId, keyString, keyCode);
    }
    exec(command, editor, args) {
        if (typeof command === 'string') {
            command = this.hashHandler.commands[command];
        }
        if (!command) {
            return false;
        }
        if (editor && editor.$readOnly && !command.readOnly) {
            return false;
        }
        var e = { editor: editor, command: command, args: args };
        var retvalue = this.eventBus._emit("exec", e);
        this.eventBus._signal("afterExec", e);
        return retvalue === false ? false : true;
    }
    toggleRecording(editor) {
        if (this.$inReplay)
            return;
        editor && editor._emit("changeStatus");
        if (this.recording) {
            this.macro.pop();
            this.eventBus.off("exec", this.$addCommandToMacro);
            if (!this.macro.length)
                this.macro = this.oldMacro;
            return this.recording = false;
        }
        if (!this.$addCommandToMacro) {
            this.$addCommandToMacro = function (e) {
                this.macro.push([e.command, e.args]);
            }.bind(this);
        }
        this.oldMacro = this.macro;
        this.macro = [];
        this.eventBus.on("exec", this.$addCommandToMacro);
        return this.recording = true;
    }
    replay(editor) {
        if (this.$inReplay || !this.macro)
            return;
        if (this.recording)
            return this.toggleRecording(editor);
        try {
            this.$inReplay = true;
            this.macro.forEach(function (x) {
                if (typeof x == "string")
                    this.exec(x, editor);
                else
                    this.exec(x[0], editor, x[1]);
            }, this);
        }
        finally {
            this.$inReplay = false;
        }
    }
    trimMacro(m) {
        return m.map(function (x) {
            if (typeof x[0] != "string")
                x[0] = x[0].name;
            if (!x[1])
                x = x[0];
            return x;
        });
    }
    on(eventName, callback, capturing) {
        this.eventBus.on(eventName, callback, capturing);
    }
    off(eventName, callback) {
        this.eventBus.off(eventName, callback);
    }
}
applyMixins(CommandManager, [HashHandler]);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29tbWFuZE1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJDb21tYW5kTWFuYWdlci50cyJdLCJuYW1lcyI6WyJDb21tYW5kTWFuYWdlciIsIkNvbW1hbmRNYW5hZ2VyLmNvbnN0cnVjdG9yIiwiQ29tbWFuZE1hbmFnZXIucGxhdGZvcm0iLCJDb21tYW5kTWFuYWdlci5jb21tYW5kcyIsIkNvbW1hbmRNYW5hZ2VyLmNvbW1hbmRLZXlCaW5kaW5nIiwiQ29tbWFuZE1hbmFnZXIuYmluZEtleSIsIkNvbW1hbmRNYW5hZ2VyLmJpbmRLZXlzIiwiQ29tbWFuZE1hbmFnZXIuYWRkQ29tbWFuZCIsIkNvbW1hbmRNYW5hZ2VyLnJlbW92ZUNvbW1hbmQiLCJDb21tYW5kTWFuYWdlci5maW5kS2V5Q29tbWFuZCIsIkNvbW1hbmRNYW5hZ2VyLnBhcnNlS2V5cyIsIkNvbW1hbmRNYW5hZ2VyLmFkZENvbW1hbmRzIiwiQ29tbWFuZE1hbmFnZXIucmVtb3ZlQ29tbWFuZHMiLCJDb21tYW5kTWFuYWdlci5oYW5kbGVLZXlib2FyZCIsIkNvbW1hbmRNYW5hZ2VyLmV4ZWMiLCJDb21tYW5kTWFuYWdlci50b2dnbGVSZWNvcmRpbmciLCJDb21tYW5kTWFuYWdlci5yZXBsYXkiLCJDb21tYW5kTWFuYWdlci50cmltTWFjcm8iLCJDb21tYW5kTWFuYWdlci5vbiIsIkNvbW1hbmRNYW5hZ2VyLm9mZiJdLCJtYXBwaW5ncyI6IkFBdUJBLFlBQVksQ0FBQztPQUVOLEVBQUMsV0FBVyxFQUFDLE1BQU0sWUFBWTtPQUMvQixXQUFXLE1BQU0seUJBQXlCO09BQzFDLGlCQUFpQixNQUFNLDBCQUEwQjtBQVF4RDtJQWlCSUEsWUFBWUEsUUFBZ0JBLEVBQUVBLFFBQW1CQTtRQUM3Q0MsSUFBSUEsQ0FBQ0EsUUFBUUEsR0FBR0EsSUFBSUEsaUJBQWlCQSxDQUFpQkEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDNURBLElBQUlBLENBQUNBLFdBQVdBLEdBQUdBLElBQUlBLFdBQVdBLENBQUNBLFFBQVFBLEVBQUVBLFFBQVFBLENBQUNBLENBQUFBO1FBQ3REQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxpQkFBaUJBLENBQUNBLE1BQU1BLEVBQUVBLFVBQVNBLENBQTZDQTtZQUMxRixNQUFNLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQ2xELENBQUMsQ0FBQ0EsQ0FBQ0E7SUFDUEEsQ0FBQ0E7SUFFREQsSUFBSUEsUUFBUUE7UUFDUkUsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsUUFBUUEsQ0FBQ0E7SUFDckNBLENBQUNBO0lBRURGLElBQUlBLFFBQVFBO1FBQ1JHLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLFFBQVFBLENBQUNBO0lBQ3JDQSxDQUFDQTtJQUVESCxJQUFJQSxpQkFBaUJBO1FBQ2pCSSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxpQkFBaUJBLENBQUNBO0lBQzlDQSxDQUFDQTtJQUVESixPQUFPQSxDQUFDQSxHQUFXQSxFQUFFQSxPQUFZQTtRQUM3QkssTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsR0FBR0EsRUFBRUEsT0FBT0EsQ0FBQ0EsQ0FBQ0E7SUFDbERBLENBQUNBO0lBRURMLFFBQVFBLENBQUNBLE9BQU9BO1FBQ1pNLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLFFBQVFBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBO0lBQzlDQSxDQUFDQTtJQUVETixVQUFVQSxDQUFDQSxPQUFnQkE7UUFDdkJPLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLFVBQVVBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBO0lBQ3pDQSxDQUFDQTtJQUVEUCxhQUFhQSxDQUFDQSxXQUFtQkE7UUFDN0JRLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLGFBQWFBLENBQUNBLFdBQVdBLENBQUNBLENBQUNBO0lBQ2hEQSxDQUFDQTtJQUVEUixjQUFjQSxDQUFDQSxNQUFjQSxFQUFFQSxTQUFpQkE7UUFDNUNTLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLGNBQWNBLENBQUNBLE1BQU1BLEVBQUVBLFNBQVNBLENBQUNBLENBQUNBO0lBQzlEQSxDQUFDQTtJQUVEVCxTQUFTQSxDQUFDQSxJQUFZQTtRQUNsQlUsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7SUFDNUNBLENBQUNBO0lBRURWLFdBQVdBLENBQUNBLFFBQVFBO1FBQ2hCVyxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxXQUFXQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQTtJQUMzQ0EsQ0FBQ0E7SUFFRFgsY0FBY0EsQ0FBQ0EsUUFBUUE7UUFDbkJZLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLGNBQWNBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBO0lBQzlDQSxDQUFDQTtJQUVEWixjQUFjQSxDQUFDQSxJQUFJQSxFQUFFQSxNQUFjQSxFQUFFQSxTQUFpQkEsRUFBRUEsT0FBT0E7UUFDM0RhLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLGNBQWNBLENBQUNBLElBQUlBLEVBQUVBLE1BQU1BLEVBQUVBLFNBQVNBLEVBQUVBLE9BQU9BLENBQUNBLENBQUNBO0lBQzdFQSxDQUFDQTtJQUVEYixJQUFJQSxDQUFDQSxPQUFZQSxFQUFFQSxNQUFlQSxFQUFFQSxJQUFLQTtRQUNyQ2MsRUFBRUEsQ0FBQ0EsQ0FBQ0EsT0FBT0EsT0FBT0EsS0FBS0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDOUJBLE9BQU9BLEdBQUdBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLFFBQVFBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBO1FBQ2pEQSxDQUFDQTtRQUVEQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNYQSxNQUFNQSxDQUFDQSxLQUFLQSxDQUFDQTtRQUNqQkEsQ0FBQ0E7UUFFREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsSUFBSUEsTUFBTUEsQ0FBQ0EsU0FBU0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDbERBLE1BQU1BLENBQUNBLEtBQUtBLENBQUNBO1FBQ2pCQSxDQUFDQTtRQUVEQSxJQUFJQSxDQUFDQSxHQUFHQSxFQUFFQSxNQUFNQSxFQUFFQSxNQUFNQSxFQUFFQSxPQUFPQSxFQUFFQSxPQUFPQSxFQUFFQSxJQUFJQSxFQUFFQSxJQUFJQSxFQUFFQSxDQUFDQTtRQUl6REEsSUFBSUEsUUFBUUEsR0FBR0EsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsTUFBTUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFJOUNBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLE9BQU9BLENBQUNBLFdBQVdBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1FBRXRDQSxNQUFNQSxDQUFDQSxRQUFRQSxLQUFLQSxLQUFLQSxHQUFHQSxLQUFLQSxHQUFHQSxJQUFJQSxDQUFDQTtJQUM3Q0EsQ0FBQ0E7SUFFRGQsZUFBZUEsQ0FBQ0EsTUFBY0E7UUFDMUJlLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBO1lBQ2ZBLE1BQU1BLENBQUNBO1FBRVhBLE1BQU1BLElBQUlBLE1BQU1BLENBQUNBLEtBQUtBLENBQUNBLGNBQWNBLENBQUNBLENBQUNBO1FBQ3ZDQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNqQkEsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsR0FBR0EsRUFBRUEsQ0FBQ0E7WUFDakJBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLEdBQUdBLENBQUNBLE1BQU1BLEVBQUVBLElBQUlBLENBQUNBLGtCQUFrQkEsQ0FBQ0EsQ0FBQ0E7WUFFbkRBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLE1BQU1BLENBQUNBO2dCQUNuQkEsSUFBSUEsQ0FBQ0EsS0FBS0EsR0FBR0EsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0E7WUFFL0JBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFNBQVNBLEdBQUdBLEtBQUtBLENBQUNBO1FBQ2xDQSxDQUFDQTtRQUNEQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxrQkFBa0JBLENBQUNBLENBQUNBLENBQUNBO1lBQzNCQSxJQUFJQSxDQUFDQSxrQkFBa0JBLEdBQUdBLFVBQVNBLENBQUNBO2dCQUNoQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDekMsQ0FBQyxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUNqQkEsQ0FBQ0E7UUFFREEsSUFBSUEsQ0FBQ0EsUUFBUUEsR0FBR0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0E7UUFDM0JBLElBQUlBLENBQUNBLEtBQUtBLEdBQUdBLEVBQUVBLENBQUNBO1FBQ2hCQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxFQUFFQSxDQUFDQSxNQUFNQSxFQUFFQSxJQUFJQSxDQUFDQSxrQkFBa0JBLENBQUNBLENBQUNBO1FBQ2xEQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxTQUFTQSxHQUFHQSxJQUFJQSxDQUFDQTtJQUNqQ0EsQ0FBQ0E7SUFFRGYsTUFBTUEsQ0FBQ0EsTUFBY0E7UUFDakJnQixFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxTQUFTQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQTtZQUM5QkEsTUFBTUEsQ0FBQ0E7UUFFWEEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0E7WUFDZkEsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7UUFFeENBLElBQUlBLENBQUNBO1lBQ0RBLElBQUlBLENBQUNBLFNBQVNBLEdBQUdBLElBQUlBLENBQUNBO1lBQ3RCQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxPQUFPQSxDQUFDQSxVQUFTQSxDQUFDQTtnQkFDekIsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksUUFBUSxDQUFDO29CQUNyQixJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztnQkFDekIsSUFBSTtvQkFDQSxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdEMsQ0FBQyxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUNiQSxDQUFDQTtnQkFBU0EsQ0FBQ0E7WUFDUEEsSUFBSUEsQ0FBQ0EsU0FBU0EsR0FBR0EsS0FBS0EsQ0FBQ0E7UUFDM0JBLENBQUNBO0lBQ0xBLENBQUNBO0lBRURoQixTQUFTQSxDQUFDQSxDQUFDQTtRQUNQaUIsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsVUFBU0EsQ0FBQ0E7WUFDbkIsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksUUFBUSxDQUFDO2dCQUN4QixDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUNyQixFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDTixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2IsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUNiLENBQUMsQ0FBQ0EsQ0FBQ0E7SUFDUEEsQ0FBQ0E7SUFRRGpCLEVBQUVBLENBQUNBLFNBQWlCQSxFQUFFQSxRQUFxREEsRUFBRUEsU0FBbUJBO1FBQzVGa0IsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsU0FBU0EsRUFBRUEsUUFBUUEsRUFBRUEsU0FBU0EsQ0FBQ0EsQ0FBQ0E7SUFDckRBLENBQUNBO0lBUURsQixHQUFHQSxDQUFDQSxTQUFpQkEsRUFBRUEsUUFBcURBO1FBQ3hFbUIsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsU0FBU0EsRUFBRUEsUUFBUUEsQ0FBQ0EsQ0FBQ0E7SUFDM0NBLENBQUNBO0FBQ0xuQixDQUFDQTtBQUVELFdBQVcsQ0FBQyxjQUFjLEVBQUUsQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyogKioqKiogQkVHSU4gTElDRU5TRSBCTE9DSyAqKioqKlxuICogVGhlIE1JVCBMaWNlbnNlIChNSVQpXG4gKlxuICogQ29weXJpZ2h0IChjKSAyMDE0LTIwMTYgRGF2aWQgR2VvIEhvbG1lcyA8ZGF2aWQuZ2VvLmhvbG1lc0BnbWFpbC5jb20+XG4gKlxuICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4gKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuICpcbiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluIGFsbFxuICogY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbiAqXG4gKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4gKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFXG4gKiBTT0ZUV0FSRS5cbiAqICoqKioqIEVORCBMSUNFTlNFIEJMT0NLICoqKioqICovXG5cInVzZSBzdHJpY3RcIjtcblxuaW1wb3J0IHthcHBseU1peGluc30gZnJvbSBcIi4uL2xpYi9taXhcIjtcbmltcG9ydCBIYXNoSGFuZGxlciBmcm9tIFwiLi4va2V5Ym9hcmQvSGFzaEhhbmRsZXJcIjtcbmltcG9ydCBFdmVudEVtaXR0ZXJDbGFzcyBmcm9tIFwiLi4vbGliL0V2ZW50RW1pdHRlckNsYXNzXCI7XG5pbXBvcnQgQ29tbWFuZCBmcm9tICcuL0NvbW1hbmQnO1xuaW1wb3J0IEVkaXRvciBmcm9tICcuLi9FZGl0b3InO1xuaW1wb3J0IEV2ZW50QnVzIGZyb20gJy4uL0V2ZW50QnVzJztcblxuLyoqXG4gKiBAY2xhc3MgQ29tbWFuZE1hbmFnZXJcbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ29tbWFuZE1hbmFnZXIgaW1wbGVtZW50cyBFdmVudEJ1czxDb21tYW5kTWFuYWdlcj4sIEhhc2hIYW5kbGVyIHtcbiAgICAvLyBXZSBhY3R1YWxseSBjb250YWluIGEgSGFzaEhhbmRsZXIgYnV0IGltcGxlbWVudCBpdCBsaWtlIGFuIGludGVyZmFjZS5cbiAgICBwcml2YXRlIGhhc2hIYW5kbGVyOiBIYXNoSGFuZGxlcjtcbiAgICBwcml2YXRlICRpblJlcGxheTogYm9vbGVhbjtcbiAgICBwcml2YXRlIHJlY29yZGluZzogYm9vbGVhbjtcbiAgICBwcml2YXRlIG1hY3JvOiBhbnlbXVtdO1xuICAgIHByaXZhdGUgb2xkTWFjcm87XG4gICAgcHJpdmF0ZSAkYWRkQ29tbWFuZFRvTWFjcm86IChldmVudCwgY206IENvbW1hbmRNYW5hZ2VyKSA9PiBhbnk7XG4gICAgcHJpdmF0ZSBldmVudEJ1czogRXZlbnRFbWl0dGVyQ2xhc3M8Q29tbWFuZE1hbmFnZXI+O1xuICAgIF9idWlsZEtleUhhc2hcblxuICAgIC8qKlxuICAgICAqIEBjbGFzcyBDb21tYW5kTWFuYWdlclxuICAgICAqIEBjb25zdHJ1Y3RvclxuICAgICAqIEBwYXJhbSBwbGF0Zm9ybSB7c3RyaW5nfSBJZGVudGlmaWVyIGZvciB0aGUgcGxhdGZvcm07IG11c3QgYmUgZWl0aGVyIGAnbWFjJ2Agb3IgYCd3aW4nYFxuICAgICAqIEBwYXJhbSBjb21tYW5kcyB7Q29tbWFuZFtdfSBBIGxpc3Qgb2YgY29tbWFuZHNcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihwbGF0Zm9ybTogc3RyaW5nLCBjb21tYW5kczogQ29tbWFuZFtdKSB7XG4gICAgICAgIHRoaXMuZXZlbnRCdXMgPSBuZXcgRXZlbnRFbWl0dGVyQ2xhc3M8Q29tbWFuZE1hbmFnZXI+KHRoaXMpO1xuICAgICAgICB0aGlzLmhhc2hIYW5kbGVyID0gbmV3IEhhc2hIYW5kbGVyKGNvbW1hbmRzLCBwbGF0Zm9ybSlcbiAgICAgICAgdGhpcy5ldmVudEJ1cy5zZXREZWZhdWx0SGFuZGxlcihcImV4ZWNcIiwgZnVuY3Rpb24oZTogeyBjb21tYW5kOiBDb21tYW5kOyBlZGl0b3I6IEVkaXRvcjsgYXJncyB9KSB7XG4gICAgICAgICAgICByZXR1cm4gZS5jb21tYW5kLmV4ZWMoZS5lZGl0b3IsIGUuYXJncyB8fCB7fSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGdldCBwbGF0Zm9ybSgpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNoSGFuZGxlci5wbGF0Zm9ybTtcbiAgICB9XG5cbiAgICBnZXQgY29tbWFuZHMoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmhhc2hIYW5kbGVyLmNvbW1hbmRzO1xuICAgIH1cblxuICAgIGdldCBjb21tYW5kS2V5QmluZGluZygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaGFzaEhhbmRsZXIuY29tbWFuZEtleUJpbmRpbmc7XG4gICAgfVxuXG4gICAgYmluZEtleShrZXk6IHN0cmluZywgY29tbWFuZDogYW55KSB7XG4gICAgICAgIHJldHVybiB0aGlzLmhhc2hIYW5kbGVyLmJpbmRLZXkoa2V5LCBjb21tYW5kKTtcbiAgICB9XG5cbiAgICBiaW5kS2V5cyhrZXlMaXN0KSB7XG4gICAgICAgIHJldHVybiB0aGlzLmhhc2hIYW5kbGVyLmJpbmRLZXlzKGtleUxpc3QpO1xuICAgIH1cblxuICAgIGFkZENvbW1hbmQoY29tbWFuZDogQ29tbWFuZCk6IHZvaWQge1xuICAgICAgICB0aGlzLmhhc2hIYW5kbGVyLmFkZENvbW1hbmQoY29tbWFuZCk7XG4gICAgfVxuXG4gICAgcmVtb3ZlQ29tbWFuZChjb21tYW5kTmFtZTogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIHRoaXMuaGFzaEhhbmRsZXIucmVtb3ZlQ29tbWFuZChjb21tYW5kTmFtZSk7XG4gICAgfVxuXG4gICAgZmluZEtleUNvbW1hbmQoaGFzaElkOiBudW1iZXIsIGtleVN0cmluZzogc3RyaW5nKTogQ29tbWFuZCB7XG4gICAgICAgIHJldHVybiB0aGlzLmhhc2hIYW5kbGVyLmZpbmRLZXlDb21tYW5kKGhhc2hJZCwga2V5U3RyaW5nKTtcbiAgICB9XG5cbiAgICBwYXJzZUtleXMoa2V5czogc3RyaW5nKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmhhc2hIYW5kbGVyLnBhcnNlS2V5cyhrZXlzKTtcbiAgICB9XG5cbiAgICBhZGRDb21tYW5kcyhjb21tYW5kcyk6IHZvaWQge1xuICAgICAgICB0aGlzLmhhc2hIYW5kbGVyLmFkZENvbW1hbmRzKGNvbW1hbmRzKTtcbiAgICB9XG5cbiAgICByZW1vdmVDb21tYW5kcyhjb21tYW5kcyk6IHZvaWQge1xuICAgICAgICB0aGlzLmhhc2hIYW5kbGVyLnJlbW92ZUNvbW1hbmRzKGNvbW1hbmRzKTtcbiAgICB9XG5cbiAgICBoYW5kbGVLZXlib2FyZChkYXRhLCBoYXNoSWQ6IG51bWJlciwga2V5U3RyaW5nOiBzdHJpbmcsIGtleUNvZGUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaGFzaEhhbmRsZXIuaGFuZGxlS2V5Ym9hcmQoZGF0YSwgaGFzaElkLCBrZXlTdHJpbmcsIGtleUNvZGUpO1xuICAgIH1cblxuICAgIGV4ZWMoY29tbWFuZDogYW55LCBlZGl0b3I/OiBFZGl0b3IsIGFyZ3M/KTogYm9vbGVhbiB7XG4gICAgICAgIGlmICh0eXBlb2YgY29tbWFuZCA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgIGNvbW1hbmQgPSB0aGlzLmhhc2hIYW5kbGVyLmNvbW1hbmRzW2NvbW1hbmRdO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFjb21tYW5kKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZWRpdG9yICYmIGVkaXRvci4kcmVhZE9ubHkgJiYgIWNvbW1hbmQucmVhZE9ubHkpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIHZhciBlID0geyBlZGl0b3I6IGVkaXRvciwgY29tbWFuZDogY29tbWFuZCwgYXJnczogYXJncyB9O1xuICAgICAgICAvKipcbiAgICAgICAgICogQGV2ZW50IGV4ZWNcbiAgICAgICAgICovXG4gICAgICAgIHZhciByZXR2YWx1ZSA9IHRoaXMuZXZlbnRCdXMuX2VtaXQoXCJleGVjXCIsIGUpO1xuICAgICAgICAvKipcbiAgICAgICAgICogQGV2ZW50IGFmdGVyRXhlY1xuICAgICAgICAgKi9cbiAgICAgICAgdGhpcy5ldmVudEJ1cy5fc2lnbmFsKFwiYWZ0ZXJFeGVjXCIsIGUpO1xuXG4gICAgICAgIHJldHVybiByZXR2YWx1ZSA9PT0gZmFsc2UgPyBmYWxzZSA6IHRydWU7XG4gICAgfVxuXG4gICAgdG9nZ2xlUmVjb3JkaW5nKGVkaXRvcjogRWRpdG9yKTogYm9vbGVhbiB7XG4gICAgICAgIGlmICh0aGlzLiRpblJlcGxheSlcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBlZGl0b3IgJiYgZWRpdG9yLl9lbWl0KFwiY2hhbmdlU3RhdHVzXCIpO1xuICAgICAgICBpZiAodGhpcy5yZWNvcmRpbmcpIHtcbiAgICAgICAgICAgIHRoaXMubWFjcm8ucG9wKCk7XG4gICAgICAgICAgICB0aGlzLmV2ZW50QnVzLm9mZihcImV4ZWNcIiwgdGhpcy4kYWRkQ29tbWFuZFRvTWFjcm8pO1xuXG4gICAgICAgICAgICBpZiAoIXRoaXMubWFjcm8ubGVuZ3RoKVxuICAgICAgICAgICAgICAgIHRoaXMubWFjcm8gPSB0aGlzLm9sZE1hY3JvO1xuXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZWNvcmRpbmcgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMuJGFkZENvbW1hbmRUb01hY3JvKSB7XG4gICAgICAgICAgICB0aGlzLiRhZGRDb21tYW5kVG9NYWNybyA9IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm1hY3JvLnB1c2goW2UuY29tbWFuZCwgZS5hcmdzXSk7XG4gICAgICAgICAgICB9LmJpbmQodGhpcyk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLm9sZE1hY3JvID0gdGhpcy5tYWNybztcbiAgICAgICAgdGhpcy5tYWNybyA9IFtdO1xuICAgICAgICB0aGlzLmV2ZW50QnVzLm9uKFwiZXhlY1wiLCB0aGlzLiRhZGRDb21tYW5kVG9NYWNybyk7XG4gICAgICAgIHJldHVybiB0aGlzLnJlY29yZGluZyA9IHRydWU7XG4gICAgfVxuXG4gICAgcmVwbGF5KGVkaXRvcjogRWRpdG9yKSB7XG4gICAgICAgIGlmICh0aGlzLiRpblJlcGxheSB8fCAhdGhpcy5tYWNybylcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBpZiAodGhpcy5yZWNvcmRpbmcpXG4gICAgICAgICAgICByZXR1cm4gdGhpcy50b2dnbGVSZWNvcmRpbmcoZWRpdG9yKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdGhpcy4kaW5SZXBsYXkgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5tYWNyby5mb3JFYWNoKGZ1bmN0aW9uKHgpIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHggPT0gXCJzdHJpbmdcIilcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5leGVjKHgsIGVkaXRvcik7XG4gICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmV4ZWMoeFswXSwgZWRpdG9yLCB4WzFdKTtcbiAgICAgICAgICAgIH0sIHRoaXMpO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgdGhpcy4kaW5SZXBsYXkgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHRyaW1NYWNybyhtKSB7XG4gICAgICAgIHJldHVybiBtLm1hcChmdW5jdGlvbih4KSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHhbMF0gIT0gXCJzdHJpbmdcIilcbiAgICAgICAgICAgICAgICB4WzBdID0geFswXS5uYW1lO1xuICAgICAgICAgICAgaWYgKCF4WzFdKVxuICAgICAgICAgICAgICAgIHggPSB4WzBdO1xuICAgICAgICAgICAgcmV0dXJuIHg7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBtZXRob2Qgb25cbiAgICAgKiBAcGFyYW0gZXZlbnROYW1lIHtzdHJpbmd9XG4gICAgICogQHBhcmFtIGNhbGxiYWNrIHsoZXZlbnQsIHNvdXJjZTogQ29tbWFuZE1hbmFnZXIpID0+IGFueX1cbiAgICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgICAqL1xuICAgIG9uKGV2ZW50TmFtZTogc3RyaW5nLCBjYWxsYmFjazogKGV2ZW50OiBhbnksIHNvdXJjZTogQ29tbWFuZE1hbmFnZXIpID0+IGFueSwgY2FwdHVyaW5nPzogYm9vbGVhbik6IHZvaWQge1xuICAgICAgICB0aGlzLmV2ZW50QnVzLm9uKGV2ZW50TmFtZSwgY2FsbGJhY2ssIGNhcHR1cmluZyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG1ldGhvZCBvZmZcbiAgICAgKiBAcGFyYW0gZXZlbnROYW1lIHtzdHJpbmd9XG4gICAgICogQHBhcmFtIGNhbGxiYWNrIHsoZXZlbnQsIHNvdXJjZTogQ29tbWFuZE1hbmFnZXIpID0+IGFueX1cbiAgICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgICAqL1xuICAgIG9mZihldmVudE5hbWU6IHN0cmluZywgY2FsbGJhY2s6IChldmVudDogYW55LCBzb3VyY2U6IENvbW1hbmRNYW5hZ2VyKSA9PiBhbnkpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5ldmVudEJ1cy5vZmYoZXZlbnROYW1lLCBjYWxsYmFjayk7XG4gICAgfVxufVxuXG5hcHBseU1peGlucyhDb21tYW5kTWFuYWdlciwgW0hhc2hIYW5kbGVyXSk7XG4iXX0=