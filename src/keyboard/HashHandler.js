"use strict";
import { FUNCTION_KEYS, KEY_MODS } from "../lib/keys";
import keyCodes from "../lib/keys";
import { isMac } from "../lib/useragent";
export default class HashHandler {
    constructor(config, platform) {
        this.platform = platform || (isMac ? "mac" : "win");
        this.commands = {};
        this.commandKeyBinding = {};
        this.addCommands(config);
    }
    addCommand(command) {
        if (this.commands[command.name]) {
            this.removeCommand(command);
        }
        this.commands[command.name] = command;
        if (command.bindKey)
            this._buildKeyHash(command);
    }
    removeCommand(command) {
        var name = (typeof command === 'string' ? command : command.name);
        command = this.commands[name];
        delete this.commands[name];
        var ckb = this.commandKeyBinding;
        for (var hashId in ckb) {
            for (var key in ckb[hashId]) {
                if (ckb[hashId][key] == command)
                    delete ckb[hashId][key];
            }
        }
    }
    bindKey(key, command) {
        var self = this;
        if (!key)
            return;
        if (typeof command === "function") {
            this.addCommand({ exec: command, bindKey: key, name: command.name || key });
            return;
        }
        var ckb = this.commandKeyBinding;
        key.split("|").forEach(function (keyPart) {
            var binding = self.parseKeys(keyPart);
            var hashId = binding.hashId;
            (ckb[hashId] || (ckb[hashId] = {}))[binding.key] = command;
        }, self);
    }
    addCommands(commands) {
        commands && Object.keys(commands).forEach(function (name) {
            var command = commands[name];
            if (!command) {
                return;
            }
            if (typeof command === "string") {
                return this.bindKey(command, name);
            }
            if (typeof command === "function") {
                command = { exec: command };
            }
            if (typeof command !== "object") {
                return;
            }
            if (!command.name) {
                command.name = name;
            }
            this.addCommand(command);
        }, this);
    }
    removeCommands(commands) {
        Object.keys(commands).forEach(function (name) {
            this.removeCommand(commands[name]);
        }, this);
    }
    bindKeys(keyList) {
        var self = this;
        Object.keys(keyList).forEach(function (key) {
            self.bindKey(key, keyList[key]);
        }, self);
    }
    _buildKeyHash(command) {
        var binding = command.bindKey;
        if (!binding)
            return;
        var key = typeof binding == "string" ? binding : binding[this.platform];
        this.bindKey(key, command);
    }
    parseKeys(keys) {
        if (keys.indexOf(" ") != -1)
            keys = keys.split(/\s+/).pop();
        var parts = keys.toLowerCase().split(/[\-\+]([\-\+])?/).filter(function (x) { return x; });
        var key = parts.pop();
        var keyCode = keyCodes[key];
        if (FUNCTION_KEYS[keyCode])
            key = FUNCTION_KEYS[keyCode].toLowerCase();
        else if (!parts.length)
            return { key: key, hashId: -1 };
        else if (parts.length == 1 && parts[0] == "shift")
            return { key: key.toUpperCase(), hashId: -1 };
        var hashId = 0;
        for (var i = parts.length; i--;) {
            var modifier = KEY_MODS[parts[i]];
            if (modifier === null) {
                throw new Error("invalid modifier " + parts[i] + " in " + keys);
            }
            hashId |= modifier;
        }
        return { key: key, hashId: hashId };
    }
    findKeyCommand(hashId, keyString) {
        var ckbr = this.commandKeyBinding;
        return ckbr[hashId] && ckbr[hashId][keyString];
    }
    handleKeyboard(dataUnused, hashId, keyString, keyCodeUnused, e) {
        var response = {
            command: this.findKeyCommand(hashId, keyString)
        };
        return response;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSGFzaEhhbmRsZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJIYXNoSGFuZGxlci50cyJdLCJuYW1lcyI6WyJIYXNoSGFuZGxlciIsIkhhc2hIYW5kbGVyLmNvbnN0cnVjdG9yIiwiSGFzaEhhbmRsZXIuYWRkQ29tbWFuZCIsIkhhc2hIYW5kbGVyLnJlbW92ZUNvbW1hbmQiLCJIYXNoSGFuZGxlci5iaW5kS2V5IiwiSGFzaEhhbmRsZXIuYWRkQ29tbWFuZHMiLCJIYXNoSGFuZGxlci5yZW1vdmVDb21tYW5kcyIsIkhhc2hIYW5kbGVyLmJpbmRLZXlzIiwiSGFzaEhhbmRsZXIuX2J1aWxkS2V5SGFzaCIsIkhhc2hIYW5kbGVyLnBhcnNlS2V5cyIsIkhhc2hIYW5kbGVyLmZpbmRLZXlDb21tYW5kIiwiSGFzaEhhbmRsZXIuaGFuZGxlS2V5Ym9hcmQiXSwibWFwcGluZ3MiOiJBQTZCQSxZQUFZLENBQUM7T0FFTixFQUFDLGFBQWEsRUFBRSxRQUFRLEVBQUMsTUFBTSxhQUFhO09BQzVDLFFBQVEsTUFBTSxhQUFhO09BQzNCLEVBQUMsS0FBSyxFQUFDLE1BQU0sa0JBQWtCO0FBUXRDO0lBY0lBLFlBQVlBLE1BQU9BLEVBQUVBLFFBQWlCQTtRQUVsQ0MsSUFBSUEsQ0FBQ0EsUUFBUUEsR0FBR0EsUUFBUUEsSUFBSUEsQ0FBQ0EsS0FBS0EsR0FBR0EsS0FBS0EsR0FBR0EsS0FBS0EsQ0FBQ0EsQ0FBQ0E7UUFDcERBLElBQUlBLENBQUNBLFFBQVFBLEdBQUdBLEVBQUVBLENBQUNBO1FBQ25CQSxJQUFJQSxDQUFDQSxpQkFBaUJBLEdBQUdBLEVBQUVBLENBQUNBO1FBRTVCQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQTtJQUM3QkEsQ0FBQ0E7SUFPREQsVUFBVUEsQ0FBQ0EsT0FBZ0JBO1FBQ3ZCRSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxPQUFPQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUM5QkEsSUFBSUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0E7UUFDaENBLENBQUNBO1FBRURBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLE9BQU9BLENBQUNBLElBQUlBLENBQUNBLEdBQUdBLE9BQU9BLENBQUNBO1FBRXRDQSxFQUFFQSxDQUFDQSxDQUFDQSxPQUFPQSxDQUFDQSxPQUFPQSxDQUFDQTtZQUNoQkEsSUFBSUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0E7SUFDcENBLENBQUNBO0lBT0RGLGFBQWFBLENBQUNBLE9BQXlCQTtRQUNuQ0csSUFBSUEsSUFBSUEsR0FBR0EsQ0FBQ0EsT0FBT0EsT0FBT0EsS0FBS0EsUUFBUUEsR0FBR0EsT0FBT0EsR0FBR0EsT0FBT0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDbEVBLE9BQU9BLEdBQUdBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO1FBQzlCQSxPQUFPQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUkzQkEsSUFBSUEsR0FBR0EsR0FBR0EsSUFBSUEsQ0FBQ0EsaUJBQWlCQSxDQUFDQTtRQUNqQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsTUFBTUEsSUFBSUEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDckJBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEdBQUdBLElBQUlBLEdBQUdBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBLENBQUNBO2dCQUMxQkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsSUFBSUEsT0FBT0EsQ0FBQ0E7b0JBQzVCQSxPQUFPQSxHQUFHQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQTtZQUNoQ0EsQ0FBQ0E7UUFDTEEsQ0FBQ0E7SUFDTEEsQ0FBQ0E7SUFRREgsT0FBT0EsQ0FBQ0EsR0FBV0EsRUFBRUEsT0FBMENBO1FBQzNESSxJQUFJQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUVoQkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0E7WUFDTEEsTUFBTUEsQ0FBQ0E7UUFDWEEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsT0FBT0EsT0FBT0EsS0FBS0EsVUFBVUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDaENBLElBQUlBLENBQUNBLFVBQVVBLENBQUNBLEVBQUVBLElBQUlBLEVBQUVBLE9BQU9BLEVBQUVBLE9BQU9BLEVBQUVBLEdBQUdBLEVBQUVBLElBQUlBLEVBQUVBLE9BQU9BLENBQUNBLElBQUlBLElBQUlBLEdBQUdBLEVBQUVBLENBQUNBLENBQUNBO1lBQzVFQSxNQUFNQSxDQUFDQTtRQUNYQSxDQUFDQTtRQUVEQSxJQUFJQSxHQUFHQSxHQUFHQSxJQUFJQSxDQUFDQSxpQkFBaUJBLENBQUNBO1FBQ2pDQSxHQUFHQSxDQUFDQSxLQUFLQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxPQUFPQSxDQUFDQSxVQUFTQSxPQUFPQTtZQUNuQyxJQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBYyxDQUFDO1lBQ25ELElBQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUM7WUFDNUIsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsT0FBTyxDQUFDO1FBQy9ELENBQUMsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7SUFDYkEsQ0FBQ0E7SUFPREosV0FBV0EsQ0FBQ0EsUUFBaUNBO1FBRXpDSyxRQUFRQSxJQUFJQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQSxPQUFPQSxDQUFDQSxVQUFTQSxJQUFJQTtZQUVuRCxJQUFJLE9BQU8sR0FBRyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDN0IsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO2dCQUNYLE1BQU0sQ0FBQztZQUNYLENBQUM7WUFFRCxFQUFFLENBQUMsQ0FBQyxPQUFPLE9BQU8sS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDO2dCQUM5QixNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7WUFDdkMsQ0FBQztZQUVELEVBQUUsQ0FBQyxDQUFDLE9BQU8sT0FBTyxLQUFLLFVBQVUsQ0FBQyxDQUFDLENBQUM7Z0JBQ2hDLE9BQU8sR0FBRyxFQUFFLElBQUksRUFBRSxPQUFPLEVBQUUsQ0FBQztZQUNoQyxDQUFDO1lBRUQsRUFBRSxDQUFDLENBQUMsT0FBTyxPQUFPLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQztnQkFDOUIsTUFBTSxDQUFDO1lBQ1gsQ0FBQztZQUVELEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7Z0JBQ2hCLE9BQU8sQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1lBQ3hCLENBQUM7WUFFRCxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQzdCLENBQUMsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7SUFDYkEsQ0FBQ0E7SUFPREwsY0FBY0EsQ0FBQ0EsUUFBaUNBO1FBQzVDTSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQSxPQUFPQSxDQUFDQSxVQUFTQSxJQUFJQTtZQUN2QyxJQUFJLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3ZDLENBQUMsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7SUFDYkEsQ0FBQ0E7SUFPRE4sUUFBUUEsQ0FBQ0EsT0FBcURBO1FBQzFETyxJQUFJQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUNoQkEsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsVUFBU0EsR0FBR0E7WUFDckMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDcEMsQ0FBQyxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtJQUNiQSxDQUFDQTtJQUVNUCxhQUFhQSxDQUFDQSxPQUFnQkE7UUFDakNRLElBQUlBLE9BQU9BLEdBQUdBLE9BQU9BLENBQUNBLE9BQU9BLENBQUNBO1FBQzlCQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxPQUFPQSxDQUFDQTtZQUNUQSxNQUFNQSxDQUFDQTtRQUVYQSxJQUFJQSxHQUFHQSxHQUFHQSxPQUFPQSxPQUFPQSxJQUFJQSxRQUFRQSxHQUFHQSxPQUFPQSxHQUFHQSxPQUFPQSxDQUFDQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQTtRQUN4RUEsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsR0FBR0EsRUFBRUEsT0FBT0EsQ0FBQ0EsQ0FBQ0E7SUFDL0JBLENBQUNBO0lBVURSLFNBQVNBLENBQUNBLElBQVlBO1FBRWxCUyxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxHQUFHQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUN4QkEsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsRUFBRUEsQ0FBQ0E7UUFFbkNBLElBQUlBLEtBQUtBLEdBQUdBLElBQUlBLENBQUNBLFdBQVdBLEVBQUVBLENBQUNBLEtBQUtBLENBQUNBLGlCQUFpQkEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsVUFBU0EsQ0FBTUEsSUFBSSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDQSxDQUFDQTtRQUMvRkEsSUFBSUEsR0FBR0EsR0FBR0EsS0FBS0EsQ0FBQ0EsR0FBR0EsRUFBRUEsQ0FBQ0E7UUFFdEJBLElBQUlBLE9BQU9BLEdBQUdBLFFBQVFBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO1FBQzVCQSxFQUFFQSxDQUFDQSxDQUFDQSxhQUFhQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQTtZQUN2QkEsR0FBR0EsR0FBR0EsYUFBYUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsV0FBV0EsRUFBRUEsQ0FBQ0E7UUFDL0NBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLEtBQUtBLENBQUNBLE1BQU1BLENBQUNBO1lBQ25CQSxNQUFNQSxDQUFDQSxFQUFFQSxHQUFHQSxFQUFFQSxHQUFHQSxFQUFFQSxNQUFNQSxFQUFFQSxDQUFDQSxDQUFDQSxFQUFFQSxDQUFDQTtRQUNwQ0EsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsTUFBTUEsSUFBSUEsQ0FBQ0EsSUFBSUEsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsT0FBT0EsQ0FBQ0E7WUFDOUNBLE1BQU1BLENBQUNBLEVBQUVBLEdBQUdBLEVBQUVBLEdBQUdBLENBQUNBLFdBQVdBLEVBQUVBLEVBQUVBLE1BQU1BLEVBQUVBLENBQUNBLENBQUNBLEVBQUVBLENBQUNBO1FBRWxEQSxJQUFJQSxNQUFNQSxHQUFXQSxDQUFDQSxDQUFDQTtRQUN2QkEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsS0FBS0EsQ0FBQ0EsTUFBTUEsRUFBRUEsQ0FBQ0EsRUFBRUEsR0FBR0EsQ0FBQ0E7WUFDOUJBLElBQUlBLFFBQVFBLEdBQUdBLFFBQVFBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBQ2xDQSxFQUFFQSxDQUFDQSxDQUFDQSxRQUFRQSxLQUFLQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDcEJBLE1BQU1BLElBQUlBLEtBQUtBLENBQUNBLG1CQUFtQkEsR0FBR0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsTUFBTUEsR0FBR0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDcEVBLENBQUNBO1lBQ0RBLE1BQU1BLElBQUlBLFFBQVFBLENBQUNBO1FBQ3ZCQSxDQUFDQTtRQUNEQSxNQUFNQSxDQUFDQSxFQUFFQSxHQUFHQSxFQUFFQSxHQUFHQSxFQUFFQSxNQUFNQSxFQUFFQSxNQUFNQSxFQUFFQSxDQUFDQTtJQUN4Q0EsQ0FBQ0E7SUFRRFQsY0FBY0EsQ0FBQ0EsTUFBY0EsRUFBRUEsU0FBaUJBO1FBQzVDVSxJQUFJQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQSxpQkFBaUJBLENBQUNBO1FBQ2xDQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxJQUFJQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQSxTQUFTQSxDQUFDQSxDQUFDQTtJQUNuREEsQ0FBQ0E7SUFFRFYsY0FBY0EsQ0FBQ0EsVUFBVUEsRUFBRUEsTUFBY0EsRUFBRUEsU0FBaUJBLEVBQUVBLGFBQWNBLEVBQUVBLENBQUVBO1FBQzVFVyxJQUFJQSxRQUFRQSxHQUFHQTtZQUNYQSxPQUFPQSxFQUFFQSxJQUFJQSxDQUFDQSxjQUFjQSxDQUFDQSxNQUFNQSxFQUFFQSxTQUFTQSxDQUFDQTtTQUNsREEsQ0FBQ0E7UUFDRkEsTUFBTUEsQ0FBQ0EsUUFBUUEsQ0FBQ0E7SUFDcEJBLENBQUNBO0FBQ0xYLENBQUNBO0FBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKiAqKioqKiBCRUdJTiBMSUNFTlNFIEJMT0NLICoqKioqXG4gKiBEaXN0cmlidXRlZCB1bmRlciB0aGUgQlNEIGxpY2Vuc2U6XG4gKlxuICogQ29weXJpZ2h0IChjKSAyMDEwLCBBamF4Lm9yZyBCLlYuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICogXG4gKiBSZWRpc3RyaWJ1dGlvbiBhbmQgdXNlIGluIHNvdXJjZSBhbmQgYmluYXJ5IGZvcm1zLCB3aXRoIG9yIHdpdGhvdXRcbiAqIG1vZGlmaWNhdGlvbiwgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OlxuICogICAgICogUmVkaXN0cmlidXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHRcbiAqICAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci5cbiAqICAgICAqIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0XG4gKiAgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIgaW4gdGhlXG4gKiAgICAgICBkb2N1bWVudGF0aW9uIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLlxuICogICAgICogTmVpdGhlciB0aGUgbmFtZSBvZiBBamF4Lm9yZyBCLlYuIG5vciB0aGVcbiAqICAgICAgIG5hbWVzIG9mIGl0cyBjb250cmlidXRvcnMgbWF5IGJlIHVzZWQgdG8gZW5kb3JzZSBvciBwcm9tb3RlIHByb2R1Y3RzXG4gKiAgICAgICBkZXJpdmVkIGZyb20gdGhpcyBzb2Z0d2FyZSB3aXRob3V0IHNwZWNpZmljIHByaW9yIHdyaXR0ZW4gcGVybWlzc2lvbi5cbiAqIFxuICogVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQ09QWVJJR0hUIEhPTERFUlMgQU5EIENPTlRSSUJVVE9SUyBcIkFTIElTXCIgQU5EXG4gKiBBTlkgRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUgSU1QTElFRFxuICogV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkgQU5EIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFSRVxuICogRElTQ0xBSU1FRC4gSU4gTk8gRVZFTlQgU0hBTEwgQUpBWC5PUkcgQi5WLiBCRSBMSUFCTEUgRk9SIEFOWVxuICogRElSRUNULCBJTkRJUkVDVCwgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVNcbiAqIChJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUztcbiAqIExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORFxuICogT04gQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVCBMSUFCSUxJVFksIE9SIFRPUlRcbiAqIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFIFVTRSBPRiBUSElTXG4gKiBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS5cbiAqXG4gKiAqKioqKiBFTkQgTElDRU5TRSBCTE9DSyAqKioqKiAqL1xuXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCB7RlVOQ1RJT05fS0VZUywgS0VZX01PRFN9IGZyb20gXCIuLi9saWIva2V5c1wiO1xuaW1wb3J0IGtleUNvZGVzIGZyb20gXCIuLi9saWIva2V5c1wiO1xuaW1wb3J0IHtpc01hY30gZnJvbSBcIi4uL2xpYi91c2VyYWdlbnRcIjtcbmltcG9ydCBFZGl0b3IgZnJvbSAnLi4vRWRpdG9yJztcbmltcG9ydCBCaW5kS2V5RnVuY3Rpb24gZnJvbSBcIi4vQmluZEtleUZ1bmN0aW9uXCI7XG5pbXBvcnQgQ29tbWFuZCBmcm9tICcuLi9jb21tYW5kcy9Db21tYW5kJztcblxuLyoqXG4gKiBAY2xhc3MgSGFzaEhhbmRsZXJcbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSGFzaEhhbmRsZXIge1xuICAgIHB1YmxpYyBwbGF0Zm9ybTogc3RyaW5nO1xuICAgIHB1YmxpYyBjb21tYW5kczogeyBbbmFtZTogc3RyaW5nXTogQ29tbWFuZCB9O1xuICAgIHB1YmxpYyBjb21tYW5kS2V5QmluZGluZzogeyBbaGFzaElkOiBudW1iZXJdOiB7IFtuYW1lOiBzdHJpbmddOiBDb21tYW5kIH0gfTtcbiAgICAvLyBUT0RPOiBXaGF0IGRvIHRoZXNlIGRvPyBTZWUgS2V5QmluZGluZy5cbiAgICAvLyBwdWJsaWMgYXR0YWNoOiAoZWRpdG9yOiBFZGl0b3IpID0+IGFueTtcbiAgICAvLyBwdWJsaWMgZGV0YWNoOiAoZWRpdG9yOiBFZGl0b3IpID0+IGFueTtcblxuICAgIC8qKlxuICAgICAqIEBjbGFzcyBIYXNoSGFuZGxlclxuICAgICAqIEBjb25zdHJ1Y3RvclxuICAgICAqIEBwYXJhbXMgW2NvbmZpZ11cbiAgICAgKiBAcGFyYW1zIFtwbGF0Zm9ybV0ge3N0cmluZ31cbiAgICAgKi9cbiAgICBjb25zdHJ1Y3Rvcihjb25maWc/LCBwbGF0Zm9ybT86IHN0cmluZykge1xuXG4gICAgICAgIHRoaXMucGxhdGZvcm0gPSBwbGF0Zm9ybSB8fCAoaXNNYWMgPyBcIm1hY1wiIDogXCJ3aW5cIik7XG4gICAgICAgIHRoaXMuY29tbWFuZHMgPSB7fTtcbiAgICAgICAgdGhpcy5jb21tYW5kS2V5QmluZGluZyA9IHt9O1xuXG4gICAgICAgIHRoaXMuYWRkQ29tbWFuZHMoY29uZmlnKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAbWV0aG9kIGFkZENvbW1hbmRcbiAgICAgKiBAcGFyYW0gY29tbWFuZCB7Q29tbWFuZH1cbiAgICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgICAqL1xuICAgIGFkZENvbW1hbmQoY29tbWFuZDogQ29tbWFuZCk6IHZvaWQge1xuICAgICAgICBpZiAodGhpcy5jb21tYW5kc1tjb21tYW5kLm5hbWVdKSB7XG4gICAgICAgICAgICB0aGlzLnJlbW92ZUNvbW1hbmQoY29tbWFuZCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmNvbW1hbmRzW2NvbW1hbmQubmFtZV0gPSBjb21tYW5kO1xuXG4gICAgICAgIGlmIChjb21tYW5kLmJpbmRLZXkpXG4gICAgICAgICAgICB0aGlzLl9idWlsZEtleUhhc2goY29tbWFuZCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG1ldGhvZCByZW1vdmVDb21tYW5kXG4gICAgICogQHBhcmFtIGNvbW1hbmQge3N0cmluZyB8IENvbW1hbmR9XG4gICAgICogQHJldHVybiB7dm9pZH1cbiAgICAgKi9cbiAgICByZW1vdmVDb21tYW5kKGNvbW1hbmQ6IHN0cmluZyB8IENvbW1hbmQpOiB2b2lkIHtcbiAgICAgICAgdmFyIG5hbWUgPSAodHlwZW9mIGNvbW1hbmQgPT09ICdzdHJpbmcnID8gY29tbWFuZCA6IGNvbW1hbmQubmFtZSk7XG4gICAgICAgIGNvbW1hbmQgPSB0aGlzLmNvbW1hbmRzW25hbWVdO1xuICAgICAgICBkZWxldGUgdGhpcy5jb21tYW5kc1tuYW1lXTtcblxuICAgICAgICAvLyBleGhhdXN0aXZlIHNlYXJjaCBpcyBicnV0ZSBmb3JjZSBidXQgc2luY2UgcmVtb3ZlQ29tbWFuZCBpc1xuICAgICAgICAvLyBub3QgYSBwZXJmb3JtYW5jZSBjcml0aWNhbCBvcGVyYXRpb24gdGhpcyBzaG91bGQgYmUgT0tcbiAgICAgICAgdmFyIGNrYiA9IHRoaXMuY29tbWFuZEtleUJpbmRpbmc7XG4gICAgICAgIGZvciAodmFyIGhhc2hJZCBpbiBja2IpIHtcbiAgICAgICAgICAgIGZvciAodmFyIGtleSBpbiBja2JbaGFzaElkXSkge1xuICAgICAgICAgICAgICAgIGlmIChja2JbaGFzaElkXVtrZXldID09IGNvbW1hbmQpXG4gICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBja2JbaGFzaElkXVtrZXldO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQG1ldGhvZCBiaW5kS2V5XG4gICAgICogQHBhcmFtIGtleSB7c3RyaW5nfVxuICAgICAqIEBwYXJhbSBjb21tYW5kXG4gICAgICogQHJldHVybiB7dm9pZH1cbiAgICAgKi9cbiAgICBiaW5kS2V5KGtleTogc3RyaW5nLCBjb21tYW5kOi8qOiBCaW5kS2V5RnVuY3Rpb24gfCBDb21tYW5kKi9hbnkpOiB2b2lkIHtcbiAgICAgICAgdmFyIHNlbGYgPSB0aGlzO1xuXG4gICAgICAgIGlmICgha2V5KVxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICBpZiAodHlwZW9mIGNvbW1hbmQgPT09IFwiZnVuY3Rpb25cIikge1xuICAgICAgICAgICAgdGhpcy5hZGRDb21tYW5kKHsgZXhlYzogY29tbWFuZCwgYmluZEtleToga2V5LCBuYW1lOiBjb21tYW5kLm5hbWUgfHwga2V5IH0pO1xuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFyIGNrYiA9IHRoaXMuY29tbWFuZEtleUJpbmRpbmc7XG4gICAgICAgIGtleS5zcGxpdChcInxcIikuZm9yRWFjaChmdW5jdGlvbihrZXlQYXJ0KSB7XG4gICAgICAgICAgICB2YXIgYmluZGluZyA9IHNlbGYucGFyc2VLZXlzKGtleVBhcnQvKiwgY29tbWFuZCovKTtcbiAgICAgICAgICAgIHZhciBoYXNoSWQgPSBiaW5kaW5nLmhhc2hJZDtcbiAgICAgICAgICAgIChja2JbaGFzaElkXSB8fCAoY2tiW2hhc2hJZF0gPSB7fSkpW2JpbmRpbmcua2V5XSA9IGNvbW1hbmQ7XG4gICAgICAgIH0sIHNlbGYpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBtZXRob2QgYWRkQ29tbWFuZHNcbiAgICAgKiBAcGFyYW0gY29tbWFuZHNcbiAgICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgICAqL1xuICAgIGFkZENvbW1hbmRzKGNvbW1hbmRzOiB7IFtuYW1lOiBzdHJpbmddOiBhbnkgfSk6IHZvaWQge1xuXG4gICAgICAgIGNvbW1hbmRzICYmIE9iamVjdC5rZXlzKGNvbW1hbmRzKS5mb3JFYWNoKGZ1bmN0aW9uKG5hbWUpIHtcblxuICAgICAgICAgICAgdmFyIGNvbW1hbmQgPSBjb21tYW5kc1tuYW1lXTtcbiAgICAgICAgICAgIGlmICghY29tbWFuZCkge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHR5cGVvZiBjb21tYW5kID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuYmluZEtleShjb21tYW5kLCBuYW1lKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKHR5cGVvZiBjb21tYW5kID09PSBcImZ1bmN0aW9uXCIpIHtcbiAgICAgICAgICAgICAgICBjb21tYW5kID0geyBleGVjOiBjb21tYW5kIH07XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmICh0eXBlb2YgY29tbWFuZCAhPT0gXCJvYmplY3RcIikge1xuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgaWYgKCFjb21tYW5kLm5hbWUpIHtcbiAgICAgICAgICAgICAgICBjb21tYW5kLm5hbWUgPSBuYW1lO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICB0aGlzLmFkZENvbW1hbmQoY29tbWFuZCk7XG4gICAgICAgIH0sIHRoaXMpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBtZXRob2QgcmVtb3ZlQ29tbWFuZHNcbiAgICAgKiBAcGFyYW0gY29tbWFuZHNcbiAgICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgICAqL1xuICAgIHJlbW92ZUNvbW1hbmRzKGNvbW1hbmRzOiB7IFtuYW1lOiBzdHJpbmddOiBhbnkgfSk6IHZvaWQge1xuICAgICAgICBPYmplY3Qua2V5cyhjb21tYW5kcykuZm9yRWFjaChmdW5jdGlvbihuYW1lKSB7XG4gICAgICAgICAgICB0aGlzLnJlbW92ZUNvbW1hbmQoY29tbWFuZHNbbmFtZV0pO1xuICAgICAgICB9LCB0aGlzKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAbWV0aG9kIGJpbmRLZXlzXG4gICAgICogQHBhcmFtIGtleUxpc3RcbiAgICAgKiBAcmV0dXJuIHt2b2lkfVxuICAgICAqL1xuICAgIGJpbmRLZXlzKGtleUxpc3Q6IHsgW25hbWU6IHN0cmluZ106IChlZGl0b3I6IEVkaXRvcikgPT4gdm9pZCB9KTogdm9pZCB7XG4gICAgICAgIHZhciBzZWxmID0gdGhpcztcbiAgICAgICAgT2JqZWN0LmtleXMoa2V5TGlzdCkuZm9yRWFjaChmdW5jdGlvbihrZXkpIHtcbiAgICAgICAgICAgIHNlbGYuYmluZEtleShrZXksIGtleUxpc3Rba2V5XSk7XG4gICAgICAgIH0sIHNlbGYpO1xuICAgIH1cblxuICAgIHB1YmxpYyBfYnVpbGRLZXlIYXNoKGNvbW1hbmQ6IENvbW1hbmQpOiB2b2lkIHtcbiAgICAgICAgdmFyIGJpbmRpbmcgPSBjb21tYW5kLmJpbmRLZXk7XG4gICAgICAgIGlmICghYmluZGluZylcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICB2YXIga2V5ID0gdHlwZW9mIGJpbmRpbmcgPT0gXCJzdHJpbmdcIiA/IGJpbmRpbmcgOiBiaW5kaW5nW3RoaXMucGxhdGZvcm1dO1xuICAgICAgICB0aGlzLmJpbmRLZXkoa2V5LCBjb21tYW5kKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBhY2NlcHRzIGtleXMgaW4gdGhlIGZvcm0gY3RybCtFbnRlciBvciBjdHJsLUVudGVyXG4gICAgICoga2V5cyB3aXRob3V0IG1vZGlmaWVycyBvciBzaGlmdCBvbmx5LlxuICAgICAqXG4gICAgICogQG1ldGhvZCBwYXJzZUtleXNcbiAgICAgKiBAcGFyYW0ga2V5cyB7c3RyaW5nfVxuICAgICAqIEByZXR1cm4ge3trZXk6IHN0cmluZzsgaGFzaElkOiBudW1iZXJ9fVxuICAgICAqL1xuICAgIHBhcnNlS2V5cyhrZXlzOiBzdHJpbmcpOiB7IGtleTogc3RyaW5nOyBoYXNoSWQ6IG51bWJlciB9IHtcbiAgICAgICAgLy8gdG9kbyBzdXBwb3J0IGtleWNoYWlucyBcbiAgICAgICAgaWYgKGtleXMuaW5kZXhPZihcIiBcIikgIT0gLTEpXG4gICAgICAgICAgICBrZXlzID0ga2V5cy5zcGxpdCgvXFxzKy8pLnBvcCgpO1xuXG4gICAgICAgIHZhciBwYXJ0cyA9IGtleXMudG9Mb3dlckNhc2UoKS5zcGxpdCgvW1xcLVxcK10oW1xcLVxcK10pPy8pLmZpbHRlcihmdW5jdGlvbih4OiBhbnkpIHsgcmV0dXJuIHg7IH0pO1xuICAgICAgICB2YXIga2V5ID0gcGFydHMucG9wKCk7XG5cbiAgICAgICAgdmFyIGtleUNvZGUgPSBrZXlDb2Rlc1trZXldO1xuICAgICAgICBpZiAoRlVOQ1RJT05fS0VZU1trZXlDb2RlXSlcbiAgICAgICAgICAgIGtleSA9IEZVTkNUSU9OX0tFWVNba2V5Q29kZV0udG9Mb3dlckNhc2UoKTtcbiAgICAgICAgZWxzZSBpZiAoIXBhcnRzLmxlbmd0aClcbiAgICAgICAgICAgIHJldHVybiB7IGtleToga2V5LCBoYXNoSWQ6IC0xIH07XG4gICAgICAgIGVsc2UgaWYgKHBhcnRzLmxlbmd0aCA9PSAxICYmIHBhcnRzWzBdID09IFwic2hpZnRcIilcbiAgICAgICAgICAgIHJldHVybiB7IGtleToga2V5LnRvVXBwZXJDYXNlKCksIGhhc2hJZDogLTEgfTtcblxuICAgICAgICB2YXIgaGFzaElkOiBudW1iZXIgPSAwO1xuICAgICAgICBmb3IgKHZhciBpID0gcGFydHMubGVuZ3RoOyBpLS07KSB7XG4gICAgICAgICAgICB2YXIgbW9kaWZpZXIgPSBLRVlfTU9EU1twYXJ0c1tpXV07XG4gICAgICAgICAgICBpZiAobW9kaWZpZXIgPT09IG51bGwpIHtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJpbnZhbGlkIG1vZGlmaWVyIFwiICsgcGFydHNbaV0gKyBcIiBpbiBcIiArIGtleXMpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaGFzaElkIHw9IG1vZGlmaWVyO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB7IGtleToga2V5LCBoYXNoSWQ6IGhhc2hJZCB9O1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBtZXRob2QgZmluZEtleUNvbW1hbmRcbiAgICAgKiBAcGFyYW0gaGFzaElkIHtudW1iZXJ9XG4gICAgICogQHBhcmFtIGtleVN0cmluZyB7c3RyaW5nfVxuICAgICAqIEByZXR1cm4ge0NvbW1hbmR9XG4gICAgICovXG4gICAgZmluZEtleUNvbW1hbmQoaGFzaElkOiBudW1iZXIsIGtleVN0cmluZzogc3RyaW5nKTogQ29tbWFuZCB7XG4gICAgICAgIHZhciBja2JyID0gdGhpcy5jb21tYW5kS2V5QmluZGluZztcbiAgICAgICAgcmV0dXJuIGNrYnJbaGFzaElkXSAmJiBja2JyW2hhc2hJZF1ba2V5U3RyaW5nXTtcbiAgICB9XG5cbiAgICBoYW5kbGVLZXlib2FyZChkYXRhVW51c2VkLCBoYXNoSWQ6IG51bWJlciwga2V5U3RyaW5nOiBzdHJpbmcsIGtleUNvZGVVbnVzZWQ/LCBlPyk6IHsgY29tbWFuZDogQ29tbWFuZCB9IHtcbiAgICAgICAgdmFyIHJlc3BvbnNlID0ge1xuICAgICAgICAgICAgY29tbWFuZDogdGhpcy5maW5kS2V5Q29tbWFuZChoYXNoSWQsIGtleVN0cmluZylcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIHJlc3BvbnNlO1xuICAgIH1cbn1cbiJdfQ==