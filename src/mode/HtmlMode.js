"use strict";
import { arrayToMap } from "../lib/lang";
import TextMode from "./TextMode";
import JavaScriptMode from "./JavaScriptMode";
import CssMode from "./CssMode";
import HtmlHighlightRules from "./HtmlHighlightRules";
import HtmlBehaviour from "./behaviour/HtmlBehaviour";
import HtmlFoldMode from "./folding/HtmlFoldMode";
import HtmlCompletions from "./HtmlCompletions";
import WorkerClient from "../worker/WorkerClient";
var voidElements = ["area", "base", "br", "col", "embed", "hr", "img", "input", "keygen", "link", "meta", "param", "source", "track", "wbr"];
var optionalEndTags = ["li", "dt", "dd", "p", "rt", "rp", "optgroup", "option", "colgroup", "td", "th"];
export default class HtmlMode extends TextMode {
    constructor(workerUrl, scriptImports, options) {
        super(workerUrl, scriptImports);
        this.blockComment = { start: "<!--", end: "-->" };
        this.voidElements = arrayToMap(voidElements, 1);
        this.$id = "ace/mode/html";
        this.fragmentContext = options && options.fragmentContext;
        this.HighlightRules = HtmlHighlightRules;
        this.$behaviour = new HtmlBehaviour();
        this.$completer = new HtmlCompletions();
        var X = JavaScriptMode;
        this.createModeDelegates({
            "js-": JavaScriptMode,
            "css-": CssMode
        });
        this.foldingRules = new HtmlFoldMode(this.voidElements, arrayToMap(optionalEndTags, 1));
    }
    getNextLineIndent(state, line, tab) {
        return this.$getIndent(line);
    }
    checkOutdent(state, line, text) {
        return false;
    }
    getCompletions(state, session, pos, prefix) {
        return this.$completer.getCompletions(state, session, pos, prefix);
    }
    createWorker(session) {
        var workerUrl = this.workerUrl;
        var scriptImports = this.scriptImports;
        var mode = this;
        return new Promise(function (resolve, reject) {
            var worker = new WorkerClient(workerUrl);
            worker.on("initAfter", function () {
                worker.attachToDocument(session.getDocument());
                if (mode.fragmentContext) {
                    worker.call("setOptions", [{ context: mode.fragmentContext }]);
                }
                resolve(worker);
            });
            worker.on("initFail", function (message) {
                reject(new Error(`${message}`));
            });
            worker.on("error", function (message) {
                session.setAnnotations(message.data);
            });
            worker.on("terminate", function () {
                worker.detachFromDocument();
                session.clearAnnotations();
            });
            worker.init(scriptImports, 'ace-workers', 'HtmlWorker');
        });
    }
    ;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSHRtbE1vZGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJIdG1sTW9kZS50cyJdLCJuYW1lcyI6WyJIdG1sTW9kZSIsIkh0bWxNb2RlLmNvbnN0cnVjdG9yIiwiSHRtbE1vZGUuZ2V0TmV4dExpbmVJbmRlbnQiLCJIdG1sTW9kZS5jaGVja091dGRlbnQiLCJIdG1sTW9kZS5nZXRDb21wbGV0aW9ucyIsIkh0bWxNb2RlLmNyZWF0ZVdvcmtlciJdLCJtYXBwaW5ncyI6IkFBb0RBLFlBQVksQ0FBQztPQUdOLEVBQUMsVUFBVSxFQUFDLE1BQU0sYUFBYTtPQUkvQixRQUFRLE1BQU0sWUFBWTtPQUMxQixjQUFjLE1BQU0sa0JBQWtCO09BQ3RDLE9BQU8sTUFBTSxXQUFXO09BQ3hCLGtCQUFrQixNQUFNLHNCQUFzQjtPQUM5QyxhQUFhLE1BQU0sMkJBQTJCO09BQzlDLFlBQVksTUFBTSx3QkFBd0I7T0FDMUMsZUFBZSxNQUFNLG1CQUFtQjtPQUN4QyxZQUFZLE1BQU0sd0JBQXdCO0FBSWpELElBQUksWUFBWSxHQUFHLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQztBQUM3SSxJQUFJLGVBQWUsR0FBRyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztBQU14RyxzQ0FBc0MsUUFBUTtJQW1CMUNBLFlBQVlBLFNBQWlCQSxFQUFFQSxhQUF1QkEsRUFBRUEsT0FBcUNBO1FBQ3pGQyxNQUFNQSxTQUFTQSxFQUFFQSxhQUFhQSxDQUFDQSxDQUFDQTtRQW5CMUJB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QUFTLE9BQStCO2dCQUN2RCxPQUFPLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN6QyxDQUFDLENBQUMsQ0FBQztZQUVILE1BQU0sQ0FBQyxFQUFFLENBQUMsV0FBVyxFQUFFO2dCQUNuQixNQUFNLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztnQkFDNUIsT0FBTyxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDL0IsQ0FBQyxDQUFDLENBQUM7WUFHSCxNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxhQUFhLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFDNUQsQ0FBQyxDQUFDQSxDQUFDQTtJQUNQQSxDQUFDQTs7QUFDTEwsQ0FBQ0E7QUFBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qICoqKioqIEJFR0lOIExJQ0VOU0UgQkxPQ0sgKioqKipcbiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKVxuICpcbiAqIENvcHlyaWdodCAoYykgMjAxNC0yMDE2IERhdmlkIEdlbyBIb2xtZXMgPGRhdmlkLmdlby5ob2xtZXNAZ21haWwuY29tPlxuICpcbiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbiAqXG4gKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbiBhbGxcbiAqIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4gKlxuICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4gKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4gKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRVxuICogU09GVFdBUkUuXG4gKiAqKioqKiBFTkQgTElDRU5TRSBCTE9DSyAqKioqKiAqL1xuLyogKioqKiogQkVHSU4gTElDRU5TRSBCTE9DSyAqKioqKlxuICogRGlzdHJpYnV0ZWQgdW5kZXIgdGhlIEJTRCBsaWNlbnNlOlxuICpcbiAqIENvcHlyaWdodCAoYykgMjAxMCwgQWpheC5vcmcgQi5WLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqIFxuICogUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0XG4gKiBtb2RpZmljYXRpb24sIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMgYXJlIG1ldDpcbiAqICAgICAqIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0XG4gKiAgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuXG4gKiAgICAgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodFxuICogICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZVxuICogICAgICAgZG9jdW1lbnRhdGlvbiBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi5cbiAqICAgICAqIE5laXRoZXIgdGhlIG5hbWUgb2YgQWpheC5vcmcgQi5WLiBub3IgdGhlXG4gKiAgICAgICBuYW1lcyBvZiBpdHMgY29udHJpYnV0b3JzIG1heSBiZSB1c2VkIHRvIGVuZG9yc2Ugb3IgcHJvbW90ZSBwcm9kdWN0c1xuICogICAgICAgZGVyaXZlZCBmcm9tIHRoaXMgc29mdHdhcmUgd2l0aG91dCBzcGVjaWZpYyBwcmlvciB3cml0dGVuIHBlcm1pc3Npb24uXG4gKiBcbiAqIFRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgVEhFIENPUFlSSUdIVCBIT0xERVJTIEFORCBDT05UUklCVVRPUlMgXCJBUyBJU1wiIEFORFxuICogQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhFIElNUExJRURcbiAqIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkVcbiAqIERJU0NMQUlNRUQuIElOIE5PIEVWRU5UIFNIQUxMIEFKQVguT1JHIEIuVi4gQkUgTElBQkxFIEZPUiBBTllcbiAqIERJUkVDVCwgSU5ESVJFQ1QsIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTXG4gKiAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVM7XG4gKiBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVTSU5FU1MgSU5URVJSVVBUSU9OKSBIT1dFVkVSIENBVVNFRCBBTkRcbiAqIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QgTElBQklMSVRZLCBPUiBUT1JUXG4gKiAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRSBVU0UgT0YgVEhJU1xuICogU09GVFdBUkUsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuXG4gKlxuICogKioqKiogRU5EIExJQ0VOU0UgQkxPQ0sgKioqKiogKi9cblwidXNlIHN0cmljdFwiO1xuXG5pbXBvcnQge2luaGVyaXRzfSBmcm9tIFwiLi4vbGliL29vcFwiO1xuaW1wb3J0IHthcnJheVRvTWFwfSBmcm9tIFwiLi4vbGliL2xhbmdcIjtcbmltcG9ydCBBbm5vdGF0aW9uIGZyb20gXCIuLi9Bbm5vdGF0aW9uXCI7XG5pbXBvcnQgQ29tcGxldGlvbiBmcm9tIFwiLi4vQ29tcGxldGlvblwiO1xuaW1wb3J0IFBvc2l0aW9uIGZyb20gXCIuLi9Qb3NpdGlvblwiO1xuaW1wb3J0IFRleHRNb2RlIGZyb20gXCIuL1RleHRNb2RlXCI7XG5pbXBvcnQgSmF2YVNjcmlwdE1vZGUgZnJvbSBcIi4vSmF2YVNjcmlwdE1vZGVcIjtcbmltcG9ydCBDc3NNb2RlIGZyb20gXCIuL0Nzc01vZGVcIjtcbmltcG9ydCBIdG1sSGlnaGxpZ2h0UnVsZXMgZnJvbSBcIi4vSHRtbEhpZ2hsaWdodFJ1bGVzXCI7XG5pbXBvcnQgSHRtbEJlaGF2aW91ciBmcm9tIFwiLi9iZWhhdmlvdXIvSHRtbEJlaGF2aW91clwiO1xuaW1wb3J0IEh0bWxGb2xkTW9kZSBmcm9tIFwiLi9mb2xkaW5nL0h0bWxGb2xkTW9kZVwiO1xuaW1wb3J0IEh0bWxDb21wbGV0aW9ucyBmcm9tIFwiLi9IdG1sQ29tcGxldGlvbnNcIjtcbmltcG9ydCBXb3JrZXJDbGllbnQgZnJvbSBcIi4uL3dvcmtlci9Xb3JrZXJDbGllbnRcIjtcbmltcG9ydCBFZGl0U2Vzc2lvbiBmcm9tIFwiLi4vRWRpdFNlc3Npb25cIjtcblxuLy8gaHR0cDovL3d3dy53My5vcmcvVFIvaHRtbDUvc3ludGF4Lmh0bWwjdm9pZC1lbGVtZW50c1xudmFyIHZvaWRFbGVtZW50cyA9IFtcImFyZWFcIiwgXCJiYXNlXCIsIFwiYnJcIiwgXCJjb2xcIiwgXCJlbWJlZFwiLCBcImhyXCIsIFwiaW1nXCIsIFwiaW5wdXRcIiwgXCJrZXlnZW5cIiwgXCJsaW5rXCIsIFwibWV0YVwiLCBcInBhcmFtXCIsIFwic291cmNlXCIsIFwidHJhY2tcIiwgXCJ3YnJcIl07XG52YXIgb3B0aW9uYWxFbmRUYWdzID0gW1wibGlcIiwgXCJkdFwiLCBcImRkXCIsIFwicFwiLCBcInJ0XCIsIFwicnBcIiwgXCJvcHRncm91cFwiLCBcIm9wdGlvblwiLCBcImNvbGdyb3VwXCIsIFwidGRcIiwgXCJ0aFwiXTtcblxuLyoqXG4gKiBAY2xhc3MgSHRtbE1vZGVcbiAqIEBleHRlbmRzIFRleHRNb2RlXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEh0bWxNb2RlIGV4dGVuZHMgVGV4dE1vZGUge1xuICAgIHByb3RlY3RlZCBibG9ja0NvbW1lbnQgPSB7IHN0YXJ0OiBcIjwhLS1cIiwgZW5kOiBcIi0tPlwiIH07XG4gICAgcHJpdmF0ZSB2b2lkRWxlbWVudHMgPSBhcnJheVRvTWFwKHZvaWRFbGVtZW50cywgMSk7XG4gICAgcHVibGljICRpZCA9IFwiYWNlL21vZGUvaHRtbFwiO1xuXG4gICAgLyoqXG4gICAgICogVGhlIG5hbWUgb2YgdGhlIGVsZW1lbnQgZm9yIGZyYWdtZW50IHBhcnNpbmcuXG4gICAgICovXG4gICAgcHJpdmF0ZSBmcmFnbWVudENvbnRleHQ6IHN0cmluZztcblxuICAgICRjb21wbGV0ZXI6IEh0bWxDb21wbGV0aW9ucztcblxuICAgIC8qKlxuICAgICAqIEBjbGFzcyBIdG1sTW9kZVxuICAgICAqIEBjb25zdHJ1Y3RvclxuICAgICAqIEBwYXJhbSB3b3JrZXJVcmwge3N0cmluZ31cbiAgICAgKiBAcGFyYW0gc2NyaXB0SW1wb3J0cyB7c3RyaW5nW119XG4gICAgICogQHBhcmFtIFtvcHRpb25zXVxuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKHdvcmtlclVybDogc3RyaW5nLCBzY3JpcHRJbXBvcnRzOiBzdHJpbmdbXSwgb3B0aW9ucz86IHsgZnJhZ21lbnRDb250ZXh0OiBzdHJpbmcgfSkge1xuICAgICAgICBzdXBlcih3b3JrZXJVcmwsIHNjcmlwdEltcG9ydHMpO1xuICAgICAgICB0aGlzLmZyYWdtZW50Q29udGV4dCA9IG9wdGlvbnMgJiYgb3B0aW9ucy5mcmFnbWVudENvbnRleHQ7XG4gICAgICAgIHRoaXMuSGlnaGxpZ2h0UnVsZXMgPSBIdG1sSGlnaGxpZ2h0UnVsZXM7XG4gICAgICAgIHRoaXMuJGJlaGF2aW91ciA9IG5ldyBIdG1sQmVoYXZpb3VyKCk7XG4gICAgICAgIHRoaXMuJGNvbXBsZXRlciA9IG5ldyBIdG1sQ29tcGxldGlvbnMoKTtcblxuICAgICAgICB2YXIgWCA9IEphdmFTY3JpcHRNb2RlO1xuXG4gICAgICAgIHRoaXMuY3JlYXRlTW9kZURlbGVnYXRlcyh7XG4gICAgICAgICAgICBcImpzLVwiOiBKYXZhU2NyaXB0TW9kZSxcbiAgICAgICAgICAgIFwiY3NzLVwiOiBDc3NNb2RlXG4gICAgICAgIH0pO1xuXG4gICAgICAgIHRoaXMuZm9sZGluZ1J1bGVzID0gbmV3IEh0bWxGb2xkTW9kZSh0aGlzLnZvaWRFbGVtZW50cywgYXJyYXlUb01hcChvcHRpb25hbEVuZFRhZ3MsIDEpKTtcbiAgICB9XG5cbiAgICBnZXROZXh0TGluZUluZGVudChzdGF0ZTogc3RyaW5nLCBsaW5lOiBzdHJpbmcsIHRhYjogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuJGdldEluZGVudChsaW5lKTtcbiAgICB9XG5cbiAgICBjaGVja091dGRlbnQoc3RhdGU6IHN0cmluZywgbGluZTogc3RyaW5nLCB0ZXh0OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIGdldENvbXBsZXRpb25zKHN0YXRlOiBzdHJpbmcsIHNlc3Npb246IEVkaXRTZXNzaW9uLCBwb3M6IFBvc2l0aW9uLCBwcmVmaXg6IHN0cmluZyk6IENvbXBsZXRpb25bXSB7XG4gICAgICAgIHJldHVybiB0aGlzLiRjb21wbGV0ZXIuZ2V0Q29tcGxldGlvbnMoc3RhdGUsIHNlc3Npb24sIHBvcywgcHJlZml4KTtcbiAgICB9XG5cbiAgICBjcmVhdGVXb3JrZXIoc2Vzc2lvbjogRWRpdFNlc3Npb24pOiBQcm9taXNlPFdvcmtlckNsaWVudD4ge1xuXG4gICAgICAgIHZhciB3b3JrZXJVcmwgPSB0aGlzLndvcmtlclVybDtcbiAgICAgICAgdmFyIHNjcmlwdEltcG9ydHMgPSB0aGlzLnNjcmlwdEltcG9ydHM7XG4gICAgICAgIHZhciBtb2RlID0gdGhpcztcblxuICAgICAgICByZXR1cm4gbmV3IFByb21pc2U8V29ya2VyQ2xpZW50PihmdW5jdGlvbihyZXNvbHZlLCByZWplY3QpIHtcbiAgICAgICAgICAgIHZhciB3b3JrZXIgPSBuZXcgV29ya2VyQ2xpZW50KHdvcmtlclVybCk7XG5cbiAgICAgICAgICAgIHdvcmtlci5vbihcImluaXRBZnRlclwiLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICB3b3JrZXIuYXR0YWNoVG9Eb2N1bWVudChzZXNzaW9uLmdldERvY3VtZW50KCkpO1xuICAgICAgICAgICAgICAgIGlmIChtb2RlLmZyYWdtZW50Q29udGV4dCkge1xuICAgICAgICAgICAgICAgICAgICB3b3JrZXIuY2FsbChcInNldE9wdGlvbnNcIiwgW3sgY29udGV4dDogbW9kZS5mcmFnbWVudENvbnRleHQgfV0pO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXNvbHZlKHdvcmtlcik7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgd29ya2VyLm9uKFwiaW5pdEZhaWxcIiwgZnVuY3Rpb24obWVzc2FnZSkge1xuICAgICAgICAgICAgICAgIHJlamVjdChuZXcgRXJyb3IoYCR7bWVzc2FnZX1gKSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgd29ya2VyLm9uKFwiZXJyb3JcIiwgZnVuY3Rpb24obWVzc2FnZTogeyBkYXRhOiBBbm5vdGF0aW9uW10gfSkge1xuICAgICAgICAgICAgICAgIHNlc3Npb24uc2V0QW5ub3RhdGlvbnMobWVzc2FnZS5kYXRhKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICB3b3JrZXIub24oXCJ0ZXJtaW5hdGVcIiwgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgd29ya2VyLmRldGFjaEZyb21Eb2N1bWVudCgpO1xuICAgICAgICAgICAgICAgIHNlc3Npb24uY2xlYXJBbm5vdGF0aW9ucygpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIC8vIEZJWE1FOiBNdXN0IGJlIGFibGUgdG8gaW5qZWN0IHRoZSBtb2R1bGUgbmFtZS5cbiAgICAgICAgICAgIHdvcmtlci5pbml0KHNjcmlwdEltcG9ydHMsICdhY2Utd29ya2VycycsICdIdG1sV29ya2VyJyk7XG4gICAgICAgIH0pO1xuICAgIH07XG59XG4iXX0=