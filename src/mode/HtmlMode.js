"use strict";
import { arrayToMap } from "../lib/lang";
import TextMode from "./TextMode";
import JavaScriptMode from "./JavaScriptMode";
import CssMode from "./CssMode";
import HtmlHighlightRules from "./HtmlHighlightRules";
import HtmlBehaviour from "./behaviour/HtmlBehaviour";
import HtmlFoldMode from "./folding/HtmlFoldMode";
import HtmlCompletions from "./HtmlCompletions";
import WorkerClient from "../worker/WorkerClient";
var voidElements = ["area", "base", "br", "col", "embed", "hr", "img", "input", "keygen", "link", "meta", "param", "source", "track", "wbr"];
var optionalEndTags = ["li", "dt", "dd", "p", "rt", "rp", "optgroup", "option", "colgroup", "td", "th"];
export default class HtmlMode extends TextMode {
    constructor(workerUrl, scriptImports, options) {
        super(workerUrl, scriptImports);
        this.blockComment = { start: "<!--", end: "-->" };
        this.voidElements = arrayToMap(voidElements, 1);
        this.$id = "ace/mode/html";
        this.fragmentContext = options && options.fragmentContext;
        this.HighlightRules = HtmlHighlightRules;
        this.$behaviour = new HtmlBehaviour();
        this.$completer = new HtmlCompletions();
        var X = JavaScriptMode;
        this.createModeDelegates({
            "js-": JavaScriptMode,
            "css-": CssMode
        });
        this.foldingRules = new HtmlFoldMode(this.voidElements, arrayToMap(optionalEndTags, 1));
    }
    getNextLineIndent(state, line, tab) {
        return this.$getIndent(line);
    }
    checkOutdent(state, line, text) {
        return false;
    }
    getCompletions(state, session, pos, prefix) {
        return this.$completer.getCompletions(state, session, pos, prefix);
    }
    createWorker(session) {
        var workerUrl = this.workerUrl;
        var scriptImports = this.scriptImports;
        var mode = this;
        return new Promise(function (resolve, reject) {
            var worker = new WorkerClient(workerUrl);
            worker.on("initAfter", function () {
                worker.attachToDocument(session.getDocument());
                if (mode.fragmentContext) {
                    worker.call("setOptions", [{ context: mode.fragmentContext }]);
                }
                resolve(worker);
            });
            worker.on("initFail", function (message) {
                reject(new Error(`${message}`));
            });
            worker.on("error", function (message) {
                session.setAnnotations(message.data);
            });
            worker.on("terminate", function () {
                worker.detachFromDocument();
                session.clearAnnotations();
            });
            worker.init(scriptImports, 'ace-workers.js', 'HtmlWorker');
        });
    }
    ;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSHRtbE1vZGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJIdG1sTW9kZS50cyJdLCJuYW1lcyI6WyJIdG1sTW9kZSIsIkh0bWxNb2RlLmNvbnN0cnVjdG9yIiwiSHRtbE1vZGUuZ2V0TmV4dExpbmVJbmRlbnQiLCJIdG1sTW9kZS5jaGVja091dGRlbnQiLCJIdG1sTW9kZS5nZXRDb21wbGV0aW9ucyIsIkh0bWxNb2RlLmNyZWF0ZVdvcmtlciJdLCJtYXBwaW5ncyI6IkFBb0RBLFlBQVksQ0FBQztPQUdOLEVBQUMsVUFBVSxFQUFDLE1BQU0sYUFBYTtPQUkvQixRQUFRLE1BQU0sWUFBWTtPQUMxQixjQUFjLE1BQU0sa0JBQWtCO09BQ3RDLE9BQU8sTUFBTSxXQUFXO09BQ3hCLGtCQUFrQixNQUFNLHNCQUFzQjtPQUM5QyxhQUFhLE1BQU0sMkJBQTJCO09BQzlDLFlBQVksTUFBTSx3QkFBd0I7T0FDMUMsZUFBZSxNQUFNLG1CQUFtQjtPQUN4QyxZQUFZLE1BQU0sd0JBQXdCO0FBSWpELElBQUksWUFBWSxHQUFHLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUUsUUFBUSxFQUFFLE9BQU8sRUFBRSxLQUFLLENBQUMsQ0FBQztBQUM3SSxJQUFJLGVBQWUsR0FBRyxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLFVBQVUsRUFBRSxRQUFRLEVBQUUsVUFBVSxFQUFFLElBQUksRUFBRSxJQUFJLENBQUMsQ0FBQztBQU14RyxzQ0FBc0MsUUFBUTtJQW1CMUNBLFlBQVlBLFNBQWlCQSxFQUFFQSxhQUF1QkEsRUFBRUEsT0FBcUNBO1FBQ3pGQyxNQUFNQSxTQUFTQSxFQUFFQSxhQUFhQSxDQUFDQSxDQUFDQTtRQW5CMUJBLGlCQUFZQSxHQUFHQSxFQUFFQSxLQUFLQSxFQUFFQSxNQUFNQSxFQUFFQSxHQUFHQSxFQUFFQSxLQUFLQSxFQUFFQSxDQUFDQTtRQUMvQ0EsaUJBQVlBLEdBQUdBLFVBQVVBLENBQUNBLFlBQVlBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1FBQzVDQSxRQUFHQSxHQUFHQSxlQUFlQSxDQUFDQTtRQWtCekJBLElBQUlBLENBQUNBLGVBQWVBLEdBQUdBLE9BQU9BLElBQUlBLE9BQU9BLENBQUNBLGVBQWVBLENBQUNBO1FBQzFEQSxJQUFJQSxDQUFDQSxjQUFjQSxHQUFHQSxrQkFBa0JBLENBQUNBO1FBQ3pDQSxJQUFJQSxDQUFDQSxVQUFVQSxHQUFHQSxJQUFJQSxhQUFhQSxFQUFFQSxDQUFDQTtRQUN0Q0EsSUFBSUEsQ0FBQ0EsVUFBVUEsR0FBR0EsSUFBSUEsZUFBZUEsRUFBRUEsQ0FBQ0E7UUFFeENBLElBQUlBLENBQUNBLEdBQUdBLGNBQWNBLENBQUNBO1FBRXZCQSxJQUFJQSxDQUFDQSxtQkFBbUJBLENBQUNBO1lBQ3JCQSxLQUFLQSxFQUFFQSxjQUFjQTtZQUNyQkEsTUFBTUEsRUFBRUEsT0FBT0E7U0FDbEJBLENBQUNBLENBQUNBO1FBRUhBLElBQUlBLENBQUNBLFlBQVlBLEdBQUdBLElBQUlBLFlBQVlBLENBQUNBLElBQUlBLENBQUNBLFlBQVlBLEVBQUVBLFVBQVVBLENBQUNBLGVBQWVBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO0lBQzVGQSxDQUFDQTtJQUVERCxpQkFBaUJBLENBQUNBLEtBQWFBLEVBQUVBLElBQVlBLEVBQUVBLEdBQVdBO1FBQ3RERSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxVQUFVQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtJQUNqQ0EsQ0FBQ0E7SUFFREYsWUFBWUEsQ0FBQ0EsS0FBYUEsRUFBRUEsSUFBWUEsRUFBRUEsSUFBWUE7UUFDbERHLE1BQU1BLENBQUNBLEtBQUtBLENBQUNBO0lBQ2pCQSxDQUFDQTtJQUVESCxjQUFjQSxDQUFDQSxLQUFhQSxFQUFFQSxPQUFvQkEsRUFBRUEsR0FBYUEsRUFBRUEsTUFBY0E7UUFDN0VJLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFVBQVVBLENBQUNBLGNBQWNBLENBQUNBLEtBQUtBLEVBQUVBLE9BQU9BLEVBQUVBLEdBQUdBLEVBQUVBLE1BQU1BLENBQUNBLENBQUNBO0lBQ3ZFQSxDQUFDQTtJQUVESixZQUFZQSxDQUFDQSxPQUFvQkE7UUFFN0JLLElBQUlBLFNBQVNBLEdBQUdBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBO1FBQy9CQSxJQUFJQSxhQUFhQSxHQUFHQSxJQUFJQSxDQUFDQSxhQUFhQSxDQUFDQTtRQUN2Q0EsSUFBSUEsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0E7UUFFaEJBLE1BQU1BLENBQUNBLElBQUlBLE9BQU9BLENBQWVBLFVBQVNBLE9BQU9BLEVBQUVBLE1BQU1BO1lBRXJELElBQUksTUFBTSxHQUFHLElBQUksWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBRXpDLE1BQU0sQ0FBQyxFQUFFLENBQUMsV0FBVyxFQUFFO2dCQUNuQixNQUFNLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUM7Z0JBQy9DLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDO29CQUN2QixNQUFNLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ25FLENBQUM7Z0JBQ0QsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ3BCLENBQUMsQ0FBQyxDQUFDO1lBRUgsTUFBTSxDQUFDLEVBQUUsQ0FBQyxVQUFVLEVBQUUsVUFBUyxPQUFPO2dCQUNsQyxNQUFNLENBQUMsSUFBSSxLQUFLLENBQUMsR0FBRyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDcEMsQ0FBQyxDQUFDLENBQUM7WUFFSCxNQUFNLENBQUMsRUFBRSxDQUFDLE9BQU8sRUFBRSxVQUFTLE9BQStCO2dCQUN2RCxPQUFPLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUN6QyxDQUFDLENBQUMsQ0FBQztZQUVILE1BQU0sQ0FBQyxFQUFFLENBQUMsV0FBVyxFQUFFO2dCQUNuQixNQUFNLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztnQkFDNUIsT0FBTyxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDL0IsQ0FBQyxDQUFDLENBQUM7WUFHSCxNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsRUFBRSxnQkFBZ0IsRUFBRSxZQUFZLENBQUMsQ0FBQztRQUMvRCxDQUFDLENBQUNBLENBQUNBO0lBQ1BBLENBQUNBOztBQUNMTCxDQUFDQTtBQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLyogKioqKiogQkVHSU4gTElDRU5TRSBCTE9DSyAqKioqKlxuICogVGhlIE1JVCBMaWNlbnNlIChNSVQpXG4gKlxuICogQ29weXJpZ2h0IChjKSAyMDE0LTIwMTYgRGF2aWQgR2VvIEhvbG1lcyA8ZGF2aWQuZ2VvLmhvbG1lc0BnbWFpbC5jb20+XG4gKlxuICogUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGEgY29weVxuICogb2YgdGhpcyBzb2Z0d2FyZSBhbmQgYXNzb2NpYXRlZCBkb2N1bWVudGF0aW9uIGZpbGVzICh0aGUgXCJTb2Z0d2FyZVwiKSwgdG8gZGVhbFxuICogaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0c1xuICogdG8gdXNlLCBjb3B5LCBtb2RpZnksIG1lcmdlLCBwdWJsaXNoLCBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbFxuICogY29waWVzIG9mIHRoZSBTb2Z0d2FyZSwgYW5kIHRvIHBlcm1pdCBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzXG4gKiBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlIGZvbGxvd2luZyBjb25kaXRpb25zOlxuICpcbiAqIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkIGluIGFsbFxuICogY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS5cbiAqXG4gKiBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgXCJBUyBJU1wiLCBXSVRIT1VUIFdBUlJBTlRZIE9GIEFOWSBLSU5ELCBFWFBSRVNTIE9SXG4gKiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSxcbiAqIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFORCBOT05JTkZSSU5HRU1FTlQuIElOIE5PIEVWRU5UIFNIQUxMIFRIRVxuICogQVVUSE9SUyBPUiBDT1BZUklHSFQgSE9MREVSUyBCRSBMSUFCTEUgRk9SIEFOWSBDTEFJTSwgREFNQUdFUyBPUiBPVEhFUlxuICogTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUiBPVEhFUldJU0UsIEFSSVNJTkcgRlJPTSxcbiAqIE9VVCBPRiBPUiBJTiBDT05ORUNUSU9OIFdJVEggVEhFIFNPRlRXQVJFIE9SIFRIRSBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFXG4gKiBTT0ZUV0FSRS5cbiAqICoqKioqIEVORCBMSUNFTlNFIEJMT0NLICoqKioqICovXG4vKiAqKioqKiBCRUdJTiBMSUNFTlNFIEJMT0NLICoqKioqXG4gKiBEaXN0cmlidXRlZCB1bmRlciB0aGUgQlNEIGxpY2Vuc2U6XG4gKlxuICogQ29weXJpZ2h0IChjKSAyMDEwLCBBamF4Lm9yZyBCLlYuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICogXG4gKiBSZWRpc3RyaWJ1dGlvbiBhbmQgdXNlIGluIHNvdXJjZSBhbmQgYmluYXJ5IGZvcm1zLCB3aXRoIG9yIHdpdGhvdXRcbiAqIG1vZGlmaWNhdGlvbiwgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OlxuICogICAgICogUmVkaXN0cmlidXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHRcbiAqICAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci5cbiAqICAgICAqIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0XG4gKiAgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIgaW4gdGhlXG4gKiAgICAgICBkb2N1bWVudGF0aW9uIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLlxuICogICAgICogTmVpdGhlciB0aGUgbmFtZSBvZiBBamF4Lm9yZyBCLlYuIG5vciB0aGVcbiAqICAgICAgIG5hbWVzIG9mIGl0cyBjb250cmlidXRvcnMgbWF5IGJlIHVzZWQgdG8gZW5kb3JzZSBvciBwcm9tb3RlIHByb2R1Y3RzXG4gKiAgICAgICBkZXJpdmVkIGZyb20gdGhpcyBzb2Z0d2FyZSB3aXRob3V0IHNwZWNpZmljIHByaW9yIHdyaXR0ZW4gcGVybWlzc2lvbi5cbiAqIFxuICogVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQ09QWVJJR0hUIEhPTERFUlMgQU5EIENPTlRSSUJVVE9SUyBcIkFTIElTXCIgQU5EXG4gKiBBTlkgRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUgSU1QTElFRFxuICogV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkgQU5EIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFSRVxuICogRElTQ0xBSU1FRC4gSU4gTk8gRVZFTlQgU0hBTEwgQUpBWC5PUkcgQi5WLiBCRSBMSUFCTEUgRk9SIEFOWVxuICogRElSRUNULCBJTkRJUkVDVCwgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVNcbiAqIChJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUztcbiAqIExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORFxuICogT04gQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVCBMSUFCSUxJVFksIE9SIFRPUlRcbiAqIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFIFVTRSBPRiBUSElTXG4gKiBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS5cbiAqXG4gKiAqKioqKiBFTkQgTElDRU5TRSBCTE9DSyAqKioqKiAqL1xuXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCB7aW5oZXJpdHN9IGZyb20gXCIuLi9saWIvb29wXCI7XG5pbXBvcnQge2FycmF5VG9NYXB9IGZyb20gXCIuLi9saWIvbGFuZ1wiO1xuaW1wb3J0IEFubm90YXRpb24gZnJvbSBcIi4uL0Fubm90YXRpb25cIjtcbmltcG9ydCBDb21wbGV0aW9uIGZyb20gXCIuLi9Db21wbGV0aW9uXCI7XG5pbXBvcnQgUG9zaXRpb24gZnJvbSBcIi4uL1Bvc2l0aW9uXCI7XG5pbXBvcnQgVGV4dE1vZGUgZnJvbSBcIi4vVGV4dE1vZGVcIjtcbmltcG9ydCBKYXZhU2NyaXB0TW9kZSBmcm9tIFwiLi9KYXZhU2NyaXB0TW9kZVwiO1xuaW1wb3J0IENzc01vZGUgZnJvbSBcIi4vQ3NzTW9kZVwiO1xuaW1wb3J0IEh0bWxIaWdobGlnaHRSdWxlcyBmcm9tIFwiLi9IdG1sSGlnaGxpZ2h0UnVsZXNcIjtcbmltcG9ydCBIdG1sQmVoYXZpb3VyIGZyb20gXCIuL2JlaGF2aW91ci9IdG1sQmVoYXZpb3VyXCI7XG5pbXBvcnQgSHRtbEZvbGRNb2RlIGZyb20gXCIuL2ZvbGRpbmcvSHRtbEZvbGRNb2RlXCI7XG5pbXBvcnQgSHRtbENvbXBsZXRpb25zIGZyb20gXCIuL0h0bWxDb21wbGV0aW9uc1wiO1xuaW1wb3J0IFdvcmtlckNsaWVudCBmcm9tIFwiLi4vd29ya2VyL1dvcmtlckNsaWVudFwiO1xuaW1wb3J0IEVkaXRTZXNzaW9uIGZyb20gXCIuLi9FZGl0U2Vzc2lvblwiO1xuXG4vLyBodHRwOi8vd3d3LnczLm9yZy9UUi9odG1sNS9zeW50YXguaHRtbCN2b2lkLWVsZW1lbnRzXG52YXIgdm9pZEVsZW1lbnRzID0gW1wiYXJlYVwiLCBcImJhc2VcIiwgXCJiclwiLCBcImNvbFwiLCBcImVtYmVkXCIsIFwiaHJcIiwgXCJpbWdcIiwgXCJpbnB1dFwiLCBcImtleWdlblwiLCBcImxpbmtcIiwgXCJtZXRhXCIsIFwicGFyYW1cIiwgXCJzb3VyY2VcIiwgXCJ0cmFja1wiLCBcIndiclwiXTtcbnZhciBvcHRpb25hbEVuZFRhZ3MgPSBbXCJsaVwiLCBcImR0XCIsIFwiZGRcIiwgXCJwXCIsIFwicnRcIiwgXCJycFwiLCBcIm9wdGdyb3VwXCIsIFwib3B0aW9uXCIsIFwiY29sZ3JvdXBcIiwgXCJ0ZFwiLCBcInRoXCJdO1xuXG4vKipcbiAqIEBjbGFzcyBIdG1sTW9kZVxuICogQGV4dGVuZHMgVGV4dE1vZGVcbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSHRtbE1vZGUgZXh0ZW5kcyBUZXh0TW9kZSB7XG4gICAgcHJvdGVjdGVkIGJsb2NrQ29tbWVudCA9IHsgc3RhcnQ6IFwiPCEtLVwiLCBlbmQ6IFwiLS0+XCIgfTtcbiAgICBwcml2YXRlIHZvaWRFbGVtZW50cyA9IGFycmF5VG9NYXAodm9pZEVsZW1lbnRzLCAxKTtcbiAgICBwdWJsaWMgJGlkID0gXCJhY2UvbW9kZS9odG1sXCI7XG5cbiAgICAvKipcbiAgICAgKiBUaGUgbmFtZSBvZiB0aGUgZWxlbWVudCBmb3IgZnJhZ21lbnQgcGFyc2luZy5cbiAgICAgKi9cbiAgICBwcml2YXRlIGZyYWdtZW50Q29udGV4dDogc3RyaW5nO1xuXG4gICAgJGNvbXBsZXRlcjogSHRtbENvbXBsZXRpb25zO1xuXG4gICAgLyoqXG4gICAgICogQGNsYXNzIEh0bWxNb2RlXG4gICAgICogQGNvbnN0cnVjdG9yXG4gICAgICogQHBhcmFtIHdvcmtlclVybCB7c3RyaW5nfVxuICAgICAqIEBwYXJhbSBzY3JpcHRJbXBvcnRzIHtzdHJpbmdbXX1cbiAgICAgKiBAcGFyYW0gW29wdGlvbnNdXG4gICAgICovXG4gICAgY29uc3RydWN0b3Iod29ya2VyVXJsOiBzdHJpbmcsIHNjcmlwdEltcG9ydHM6IHN0cmluZ1tdLCBvcHRpb25zPzogeyBmcmFnbWVudENvbnRleHQ6IHN0cmluZyB9KSB7XG4gICAgICAgIHN1cGVyKHdvcmtlclVybCwgc2NyaXB0SW1wb3J0cyk7XG4gICAgICAgIHRoaXMuZnJhZ21lbnRDb250ZXh0ID0gb3B0aW9ucyAmJiBvcHRpb25zLmZyYWdtZW50Q29udGV4dDtcbiAgICAgICAgdGhpcy5IaWdobGlnaHRSdWxlcyA9IEh0bWxIaWdobGlnaHRSdWxlcztcbiAgICAgICAgdGhpcy4kYmVoYXZpb3VyID0gbmV3IEh0bWxCZWhhdmlvdXIoKTtcbiAgICAgICAgdGhpcy4kY29tcGxldGVyID0gbmV3IEh0bWxDb21wbGV0aW9ucygpO1xuXG4gICAgICAgIHZhciBYID0gSmF2YVNjcmlwdE1vZGU7XG5cbiAgICAgICAgdGhpcy5jcmVhdGVNb2RlRGVsZWdhdGVzKHtcbiAgICAgICAgICAgIFwianMtXCI6IEphdmFTY3JpcHRNb2RlLFxuICAgICAgICAgICAgXCJjc3MtXCI6IENzc01vZGVcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5mb2xkaW5nUnVsZXMgPSBuZXcgSHRtbEZvbGRNb2RlKHRoaXMudm9pZEVsZW1lbnRzLCBhcnJheVRvTWFwKG9wdGlvbmFsRW5kVGFncywgMSkpO1xuICAgIH1cblxuICAgIGdldE5leHRMaW5lSW5kZW50KHN0YXRlOiBzdHJpbmcsIGxpbmU6IHN0cmluZywgdGFiOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gdGhpcy4kZ2V0SW5kZW50KGxpbmUpO1xuICAgIH1cblxuICAgIGNoZWNrT3V0ZGVudChzdGF0ZTogc3RyaW5nLCBsaW5lOiBzdHJpbmcsIHRleHQ6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgZ2V0Q29tcGxldGlvbnMoc3RhdGU6IHN0cmluZywgc2Vzc2lvbjogRWRpdFNlc3Npb24sIHBvczogUG9zaXRpb24sIHByZWZpeDogc3RyaW5nKTogQ29tcGxldGlvbltdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuJGNvbXBsZXRlci5nZXRDb21wbGV0aW9ucyhzdGF0ZSwgc2Vzc2lvbiwgcG9zLCBwcmVmaXgpO1xuICAgIH1cblxuICAgIGNyZWF0ZVdvcmtlcihzZXNzaW9uOiBFZGl0U2Vzc2lvbik6IFByb21pc2U8V29ya2VyQ2xpZW50PiB7XG5cbiAgICAgICAgdmFyIHdvcmtlclVybCA9IHRoaXMud29ya2VyVXJsO1xuICAgICAgICB2YXIgc2NyaXB0SW1wb3J0cyA9IHRoaXMuc2NyaXB0SW1wb3J0cztcbiAgICAgICAgdmFyIG1vZGUgPSB0aGlzO1xuXG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZTxXb3JrZXJDbGllbnQ+KGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkge1xuXG4gICAgICAgICAgICB2YXIgd29ya2VyID0gbmV3IFdvcmtlckNsaWVudCh3b3JrZXJVcmwpO1xuXG4gICAgICAgICAgICB3b3JrZXIub24oXCJpbml0QWZ0ZXJcIiwgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgd29ya2VyLmF0dGFjaFRvRG9jdW1lbnQoc2Vzc2lvbi5nZXREb2N1bWVudCgpKTtcbiAgICAgICAgICAgICAgICBpZiAobW9kZS5mcmFnbWVudENvbnRleHQpIHtcbiAgICAgICAgICAgICAgICAgICAgd29ya2VyLmNhbGwoXCJzZXRPcHRpb25zXCIsIFt7IGNvbnRleHQ6IG1vZGUuZnJhZ21lbnRDb250ZXh0IH1dKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgcmVzb2x2ZSh3b3JrZXIpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHdvcmtlci5vbihcImluaXRGYWlsXCIsIGZ1bmN0aW9uKG1lc3NhZ2UpIHtcbiAgICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKGAke21lc3NhZ2V9YCkpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgIHdvcmtlci5vbihcImVycm9yXCIsIGZ1bmN0aW9uKG1lc3NhZ2U6IHsgZGF0YTogQW5ub3RhdGlvbltdIH0pIHtcbiAgICAgICAgICAgICAgICBzZXNzaW9uLnNldEFubm90YXRpb25zKG1lc3NhZ2UuZGF0YSk7XG4gICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgd29ya2VyLm9uKFwidGVybWluYXRlXCIsIGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIHdvcmtlci5kZXRhY2hGcm9tRG9jdW1lbnQoKTtcbiAgICAgICAgICAgICAgICBzZXNzaW9uLmNsZWFyQW5ub3RhdGlvbnMoKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAvLyBGSVhNRTogTXVzdCBiZSBhYmxlIHRvIGluamVjdCB0aGUgbW9kdWxlIG5hbWUuXG4gICAgICAgICAgICB3b3JrZXIuaW5pdChzY3JpcHRJbXBvcnRzLCAnYWNlLXdvcmtlcnMuanMnLCAnSHRtbFdvcmtlcicpO1xuICAgICAgICB9KTtcbiAgICB9O1xufVxuIl19