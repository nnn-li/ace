import { snippetManager } from "../snippets";
import { getCompleter, setCompleter, CompleterAggregate, Autocomplete } from "../autocomplete";
import { defineOptions, loadModule } from "../config";
import { retrievePrecedingIdentifier } from "../autocomplete/util";
import Editor from "../Editor";
import textCompleter from '../autocomplete/text_completer';
export var keyWordCompleter = {
    getCompletions: function (editor, session, pos, prefix, callback) {
        var state = session.getState(pos.row);
        var completions = session.$mode.getCompletions(state, session, pos, prefix);
        callback(null, completions);
    }
};
export var snippetCompleter = {
    getCompletions: function (editor, session, pos, prefix, callback) {
        var snippetMap = snippetManager.snippetMap;
        var completions = [];
        snippetManager.getActiveScopes(editor).forEach(function (scope) {
            var snippets = snippetMap[scope] || [];
            for (var i = snippets.length; i--;) {
                var s = snippets[i];
                var caption = s.name || s.tabTrigger;
                if (!caption)
                    continue;
                completions.push({
                    caption: caption,
                    snippet: s.content,
                    meta: s.tabTrigger && !s.name ? s.tabTrigger + "\u21E5 " : "snippet"
                });
            }
        }, this);
        callback(null, completions);
    }
};
var completers = [snippetCompleter, { getCompletions: textCompleter }, keyWordCompleter];
export function addCompleter(completer) {
    completers.push(completer);
}
;
var expandSnippet = {
    name: 'expandSnippet',
    exec: function (editor) {
        var success = snippetManager.expandWithTab(editor);
        if (!success) {
            editor.execCommand('indent');
        }
    },
    bindKey: 'Tab'
};
var onChangeMode = function (e, editor) {
    loadSnippetsForMode(editor.getSession().$mode);
};
var loadSnippetsForMode = function (mode) {
    var id = mode.$id;
    if (!snippetManager['files']) {
        snippetManager['files'] = {};
    }
    loadSnippetFile(id);
    if (mode.modes) {
        mode.modes.forEach(loadSnippetsForMode);
    }
};
var loadSnippetFile = function (id) {
    if (!id || snippetManager['files'][id])
        return;
    var snippetFilePath = id.replace("mode", "snippets");
    snippetManager['files'][id] = {};
    loadModule(snippetFilePath, function (m) {
        if (m) {
            snippetManager['files'][id] = m;
            if (!m.snippets && m.snippetText)
                m.snippets = snippetManager.parseSnippetFile(m.snippetText);
            snippetManager.register(m.snippets || [], m.scope);
            if (m.includeScopes) {
                snippetManager.snippetMap[m.scope].includeScopes = m.includeScopes;
                m.includeScopes.forEach(function (x) {
                    loadSnippetFile("ace/mode/" + x);
                });
            }
        }
    });
};
function getCompletionPrefix(editor) {
    var pos = editor.getCursorPosition();
    var line = editor.getSession().getLine(pos.row);
    var prefix = retrievePrecedingIdentifier(line, pos.column);
    editor.completers.forEach(function (completer) {
        if (completer['identifierRegexps']) {
            completer['identifierRegexps'].forEach(function (identifierRegex) {
                if (!prefix && identifierRegex) {
                    prefix = retrievePrecedingIdentifier(line, pos.column, identifierRegex);
                }
            });
        }
    });
    return prefix;
}
var doLiveAutocomplete = function (e) {
    var editor = e.editor;
    var text = e.args || "";
    var hasCompleter = getCompleter(editor) && getCompleter(editor).activated;
    if (e.command.name === "backspace") {
        if (hasCompleter && !getCompletionPrefix(editor))
            getCompleter(editor).detach();
    }
    else if (e.command.name === "insertstring") {
        var prefix = getCompletionPrefix(editor);
        if (prefix && !hasCompleter) {
            if (!getCompleter(editor)) {
                setCompleter(editor, new CompleterAggregate(editor));
            }
            getCompleter(editor).autoSelect = false;
            getCompleter(editor).autoInsert = false;
            getCompleter(editor).showPopup(editor);
        }
    }
};
defineOptions(Editor.prototype, 'editor', {
    enableBasicAutocompletion: {
        set: function (val) {
            var editor = this;
            if (val) {
                if (!editor.completers) {
                    editor.completers = Array.isArray(val) ? val : completers;
                }
                editor.commands.addCommand(Autocomplete.startCommand);
            }
            else {
                editor.commands.removeCommand(Autocomplete.startCommand.name);
            }
        },
        value: false
    },
    enableLiveAutocompletion: {
        set: function (val) {
            var editor = this;
            if (val) {
                if (!editor.completers) {
                    editor.completers = Array.isArray(val) ? val : completers;
                }
                editor.commands.on('afterExec', doLiveAutocomplete);
            }
            else {
                editor.commands.off('afterExec', doLiveAutocomplete);
            }
        },
        value: false
    },
    enableSnippets: {
        set: function (val) {
            var editor = this;
            if (val) {
                editor.commands.addCommand(expandSnippet);
                editor.on("changeMode", onChangeMode);
                onChangeMode(null, editor);
            }
            else {
                editor.commands.removeCommand(expandSnippet.name);
                editor.off("changeMode", onChangeMode);
            }
        },
        value: false
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGFuZ3VhZ2VfdG9vbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJsYW5ndWFnZV90b29scy50cyJdLCJuYW1lcyI6WyJhZGRDb21wbGV0ZXIiLCJnZXRDb21wbGV0aW9uUHJlZml4Il0sIm1hcHBpbmdzIjoiT0ErQk8sRUFBQyxjQUFjLEVBQUMsTUFBTSxhQUFhO09BQ25DLEVBQVksWUFBWSxFQUFFLFlBQVksRUFBRSxrQkFBa0IsRUFBRSxZQUFZLEVBQUMsTUFBTSxpQkFBaUI7T0FDaEcsRUFBQyxhQUFhLEVBQUUsVUFBVSxFQUFDLE1BQU0sV0FBVztPQUM1QyxFQUFDLDJCQUEyQixFQUFDLE1BQU0sc0JBQXNCO09BRXpELE1BQU0sTUFBTSxXQUFXO09BRXZCLGFBQWEsTUFBTSxnQ0FBZ0M7QUFPMUQsV0FBVyxnQkFBZ0IsR0FBYztJQUNyQyxjQUFjLEVBQUUsVUFBUyxNQUFjLEVBQUUsT0FBb0IsRUFBRSxHQUFhLEVBQUUsTUFBYyxFQUFFLFFBQVE7UUFDbEcsSUFBSSxLQUFLLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDdEMsSUFBSSxXQUFXLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsS0FBSyxFQUFFLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFDNUUsUUFBUSxDQUFDLElBQUksRUFBRSxXQUFXLENBQUMsQ0FBQztJQUNoQyxDQUFDO0NBQ0osQ0FBQztBQUVGLFdBQVcsZ0JBQWdCLEdBQWM7SUFDckMsY0FBYyxFQUFFLFVBQVMsTUFBYyxFQUFFLE9BQW9CLEVBQUUsR0FBb0MsRUFBRSxNQUFjLEVBQUUsUUFBUTtRQUN6SCxJQUFJLFVBQVUsR0FBRyxjQUFjLENBQUMsVUFBVSxDQUFDO1FBQzNDLElBQUksV0FBVyxHQUFHLEVBQUUsQ0FBQztRQUNyQixjQUFjLENBQUMsZUFBZSxDQUFDLE1BQU0sQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFTLEtBQUs7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c291cmNlc0NvbnRlbnQiOlsiLyogKioqKiogQkVHSU4gTElDRU5TRSBCTE9DSyAqKioqKlxuICogRGlzdHJpYnV0ZWQgdW5kZXIgdGhlIEJTRCBsaWNlbnNlOlxuICpcbiAqIENvcHlyaWdodCAoYykgMjAxMiwgQWpheC5vcmcgQi5WLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBSZWRpc3RyaWJ1dGlvbiBhbmQgdXNlIGluIHNvdXJjZSBhbmQgYmluYXJ5IGZvcm1zLCB3aXRoIG9yIHdpdGhvdXRcbiAqIG1vZGlmaWNhdGlvbiwgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OlxuICogICAgICogUmVkaXN0cmlidXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHRcbiAqICAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci5cbiAqICAgICAqIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0XG4gKiAgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIgaW4gdGhlXG4gKiAgICAgICBkb2N1bWVudGF0aW9uIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLlxuICogICAgICogTmVpdGhlciB0aGUgbmFtZSBvZiBBamF4Lm9yZyBCLlYuIG5vciB0aGVcbiAqICAgICAgIG5hbWVzIG9mIGl0cyBjb250cmlidXRvcnMgbWF5IGJlIHVzZWQgdG8gZW5kb3JzZSBvciBwcm9tb3RlIHByb2R1Y3RzXG4gKiAgICAgICBkZXJpdmVkIGZyb20gdGhpcyBzb2Z0d2FyZSB3aXRob3V0IHNwZWNpZmljIHByaW9yIHdyaXR0ZW4gcGVybWlzc2lvbi5cbiAqXG4gKiBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIFRIRSBDT1BZUklHSFQgSE9MREVSUyBBTkQgQ09OVFJJQlVUT1JTIFwiQVMgSVNcIiBBTkRcbiAqIEFOWSBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRSBJTVBMSUVEXG4gKiBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFXG4gKiBESVNDTEFJTUVELiBJTiBOTyBFVkVOVCBTSEFMTCBBSkFYLk9SRyBCLlYuIEJFIExJQUJMRSBGT1IgQU5ZXG4gKiBESVJFQ1QsIElORElSRUNULCBJTkNJREVOVEFMLCBTUEVDSUFMLCBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFU1xuICogKElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRFIEdPT0RTIE9SIFNFUlZJQ0VTO1xuICogTE9TUyBPRiBVU0UsIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTIElOVEVSUlVQVElPTikgSE9XRVZFUiBDQVVTRUQgQU5EXG4gKiBPTiBBTlkgVEhFT1JZIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUIExJQUJJTElUWSwgT1IgVE9SVFxuICogKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZIE9VVCBPRiBUSEUgVVNFIE9GIFRISVNcbiAqIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLlxuICpcbiAqICoqKioqIEVORCBMSUNFTlNFIEJMT0NLICoqKioqICovXG5cbmltcG9ydCBDb21tYW5kIGZyb20gJy4uL2NvbW1hbmRzL0NvbW1hbmQnO1xuaW1wb3J0IHtzbmlwcGV0TWFuYWdlcn0gZnJvbSBcIi4uL3NuaXBwZXRzXCI7XG5pbXBvcnQge0NvbXBsZXRlciwgZ2V0Q29tcGxldGVyLCBzZXRDb21wbGV0ZXIsIENvbXBsZXRlckFnZ3JlZ2F0ZSwgQXV0b2NvbXBsZXRlfSBmcm9tIFwiLi4vYXV0b2NvbXBsZXRlXCI7XG5pbXBvcnQge2RlZmluZU9wdGlvbnMsIGxvYWRNb2R1bGV9IGZyb20gXCIuLi9jb25maWdcIjtcbmltcG9ydCB7cmV0cmlldmVQcmVjZWRpbmdJZGVudGlmaWVyfSBmcm9tIFwiLi4vYXV0b2NvbXBsZXRlL3V0aWxcIjtcbmltcG9ydCBDb21wbGV0aW9uIGZyb20gXCIuLi9Db21wbGV0aW9uXCI7XG5pbXBvcnQgRWRpdG9yIGZyb20gXCIuLi9FZGl0b3JcIjtcbmltcG9ydCBFZGl0U2Vzc2lvbiBmcm9tICcuLi9FZGl0U2Vzc2lvbic7XG5pbXBvcnQgdGV4dENvbXBsZXRlciBmcm9tICcuLi9hdXRvY29tcGxldGUvdGV4dF9jb21wbGV0ZXInO1xuaW1wb3J0IExhbmd1YWdlTW9kZSBmcm9tICcuLi9MYW5ndWFnZU1vZGUnO1xuaW1wb3J0IFBvc2l0aW9uIGZyb20gJy4uL1Bvc2l0aW9uJztcblxuLy8gRXhwb3J0cyBleGlzdGluZyBjb21wbGV0ZXIgc28gdGhhdCB1c2VyIGNhbiBjb25zdHJ1Y3QgaGlzIG93biBzZXQgb2YgY29tcGxldGVycy5cbi8vIGV4cG9ydCB2YXIgdGV4dENvbXBsZXRlcjogYWNtLkNvbXBsZXRlciA9IHRjbTtcblxuZXhwb3J0IHZhciBrZXlXb3JkQ29tcGxldGVyOiBDb21wbGV0ZXIgPSB7XG4gICAgZ2V0Q29tcGxldGlvbnM6IGZ1bmN0aW9uKGVkaXRvcjogRWRpdG9yLCBzZXNzaW9uOiBFZGl0U2Vzc2lvbiwgcG9zOiBQb3NpdGlvbiwgcHJlZml4OiBzdHJpbmcsIGNhbGxiYWNrKSB7XG4gICAgICAgIHZhciBzdGF0ZSA9IHNlc3Npb24uZ2V0U3RhdGUocG9zLnJvdyk7XG4gICAgICAgIHZhciBjb21wbGV0aW9ucyA9IHNlc3Npb24uJG1vZGUuZ2V0Q29tcGxldGlvbnMoc3RhdGUsIHNlc3Npb24sIHBvcywgcHJlZml4KTtcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgY29tcGxldGlvbnMpO1xuICAgIH1cbn07XG5cbmV4cG9ydCB2YXIgc25pcHBldENvbXBsZXRlcjogQ29tcGxldGVyID0ge1xuICAgIGdldENvbXBsZXRpb25zOiBmdW5jdGlvbihlZGl0b3I6IEVkaXRvciwgc2Vzc2lvbjogRWRpdFNlc3Npb24sIHBvczogeyByb3c6IG51bWJlcjsgY29sdW1uOiBudW1iZXIgfSwgcHJlZml4OiBzdHJpbmcsIGNhbGxiYWNrKSB7XG4gICAgICAgIHZhciBzbmlwcGV0TWFwID0gc25pcHBldE1hbmFnZXIuc25pcHBldE1hcDtcbiAgICAgICAgdmFyIGNvbXBsZXRpb25zID0gW107XG4gICAgICAgIHNuaXBwZXRNYW5hZ2VyLmdldEFjdGl2ZVNjb3BlcyhlZGl0b3IpLmZvckVhY2goZnVuY3Rpb24oc2NvcGUpIHtcbiAgICAgICAgICAgIHZhciBzbmlwcGV0cyA9IHNuaXBwZXRNYXBbc2NvcGVdIHx8IFtdO1xuICAgICAgICAgICAgZm9yICh2YXIgaSA9IHNuaXBwZXRzLmxlbmd0aDsgaS0tOykge1xuICAgICAgICAgICAgICAgIHZhciBzID0gc25pcHBldHNbaV07XG4gICAgICAgICAgICAgICAgdmFyIGNhcHRpb24gPSBzLm5hbWUgfHwgcy50YWJUcmlnZ2VyO1xuICAgICAgICAgICAgICAgIGlmICghY2FwdGlvbilcbiAgICAgICAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICAgICAgY29tcGxldGlvbnMucHVzaCh7XG4gICAgICAgICAgICAgICAgICAgIGNhcHRpb246IGNhcHRpb24sXG4gICAgICAgICAgICAgICAgICAgIHNuaXBwZXQ6IHMuY29udGVudCxcbiAgICAgICAgICAgICAgICAgICAgbWV0YTogcy50YWJUcmlnZ2VyICYmICFzLm5hbWUgPyBzLnRhYlRyaWdnZXIgKyBcIlxcdTIxRTUgXCIgOiBcInNuaXBwZXRcIlxuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LCB0aGlzKTtcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgY29tcGxldGlvbnMpO1xuICAgIH1cbn07XG5cbnZhciBjb21wbGV0ZXJzOiBDb21wbGV0ZXJbXSA9IFtzbmlwcGV0Q29tcGxldGVyLCB7IGdldENvbXBsZXRpb25zOiB0ZXh0Q29tcGxldGVyIH0sIGtleVdvcmRDb21wbGV0ZXJdO1xuXG5leHBvcnQgZnVuY3Rpb24gYWRkQ29tcGxldGVyKGNvbXBsZXRlcjogQ29tcGxldGVyKSB7XG4gICAgY29tcGxldGVycy5wdXNoKGNvbXBsZXRlcik7XG59O1xuXG52YXIgZXhwYW5kU25pcHBldDogQ29tbWFuZCA9IHtcbiAgICBuYW1lOiAnZXhwYW5kU25pcHBldCcsXG4gICAgZXhlYzogZnVuY3Rpb24oZWRpdG9yOiBFZGl0b3IpIHtcbiAgICAgICAgdmFyIHN1Y2Nlc3MgPSBzbmlwcGV0TWFuYWdlci5leHBhbmRXaXRoVGFiKGVkaXRvcik7XG4gICAgICAgIGlmICghc3VjY2Vzcykge1xuICAgICAgICAgICAgZWRpdG9yLmV4ZWNDb21tYW5kKCdpbmRlbnQnKTtcbiAgICAgICAgfVxuICAgIH0sXG4gICAgYmluZEtleTogJ1RhYidcbn07XG5cbnZhciBvbkNoYW5nZU1vZGUgPSBmdW5jdGlvbihlLCBlZGl0b3I6IEVkaXRvcikge1xuICAgIGxvYWRTbmlwcGV0c0Zvck1vZGUoZWRpdG9yLmdldFNlc3Npb24oKS4kbW9kZSk7XG59O1xuXG52YXIgbG9hZFNuaXBwZXRzRm9yTW9kZSA9IGZ1bmN0aW9uKG1vZGU6IExhbmd1YWdlTW9kZSkge1xuICAgIHZhciBpZCA9IG1vZGUuJGlkO1xuICAgIGlmICghc25pcHBldE1hbmFnZXJbJ2ZpbGVzJ10pIHtcbiAgICAgICAgc25pcHBldE1hbmFnZXJbJ2ZpbGVzJ10gPSB7fTtcbiAgICB9XG4gICAgbG9hZFNuaXBwZXRGaWxlKGlkKTtcbiAgICBpZiAobW9kZS5tb2Rlcykge1xuICAgICAgICBtb2RlLm1vZGVzLmZvckVhY2gobG9hZFNuaXBwZXRzRm9yTW9kZSk7XG4gICAgfVxufTtcblxudmFyIGxvYWRTbmlwcGV0RmlsZSA9IGZ1bmN0aW9uKGlkOiBzdHJpbmcpIHtcbiAgICBpZiAoIWlkIHx8IHNuaXBwZXRNYW5hZ2VyWydmaWxlcyddW2lkXSlcbiAgICAgICAgcmV0dXJuO1xuICAgIHZhciBzbmlwcGV0RmlsZVBhdGggPSBpZC5yZXBsYWNlKFwibW9kZVwiLCBcInNuaXBwZXRzXCIpO1xuICAgIHNuaXBwZXRNYW5hZ2VyWydmaWxlcyddW2lkXSA9IHt9O1xuICAgIGxvYWRNb2R1bGUoc25pcHBldEZpbGVQYXRoLCBmdW5jdGlvbihtKSB7XG4gICAgICAgIGlmIChtKSB7XG4gICAgICAgICAgICBzbmlwcGV0TWFuYWdlclsnZmlsZXMnXVtpZF0gPSBtO1xuICAgICAgICAgICAgaWYgKCFtLnNuaXBwZXRzICYmIG0uc25pcHBldFRleHQpXG4gICAgICAgICAgICAgICAgbS5zbmlwcGV0cyA9IHNuaXBwZXRNYW5hZ2VyLnBhcnNlU25pcHBldEZpbGUobS5zbmlwcGV0VGV4dCk7XG4gICAgICAgICAgICBzbmlwcGV0TWFuYWdlci5yZWdpc3RlcihtLnNuaXBwZXRzIHx8IFtdLCBtLnNjb3BlKTtcbiAgICAgICAgICAgIGlmIChtLmluY2x1ZGVTY29wZXMpIHtcbiAgICAgICAgICAgICAgICBzbmlwcGV0TWFuYWdlci5zbmlwcGV0TWFwW20uc2NvcGVdLmluY2x1ZGVTY29wZXMgPSBtLmluY2x1ZGVTY29wZXM7XG4gICAgICAgICAgICAgICAgbS5pbmNsdWRlU2NvcGVzLmZvckVhY2goZnVuY3Rpb24oeCkge1xuICAgICAgICAgICAgICAgICAgICBsb2FkU25pcHBldEZpbGUoXCJhY2UvbW9kZS9cIiArIHgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSk7XG59O1xuXG5mdW5jdGlvbiBnZXRDb21wbGV0aW9uUHJlZml4KGVkaXRvcjogRWRpdG9yKSB7XG4gICAgdmFyIHBvcyA9IGVkaXRvci5nZXRDdXJzb3JQb3NpdGlvbigpO1xuICAgIHZhciBsaW5lID0gZWRpdG9yLmdldFNlc3Npb24oKS5nZXRMaW5lKHBvcy5yb3cpO1xuICAgIHZhciBwcmVmaXggPSByZXRyaWV2ZVByZWNlZGluZ0lkZW50aWZpZXIobGluZSwgcG9zLmNvbHVtbik7XG4gICAgLy8gVHJ5IHRvIGZpbmQgY3VzdG9tIHByZWZpeGVzIG9uIHRoZSBjb21wbGV0ZXJzXG4gICAgZWRpdG9yLmNvbXBsZXRlcnMuZm9yRWFjaChmdW5jdGlvbihjb21wbGV0ZXIpIHtcbiAgICAgICAgaWYgKGNvbXBsZXRlclsnaWRlbnRpZmllclJlZ2V4cHMnXSkge1xuICAgICAgICAgICAgY29tcGxldGVyWydpZGVudGlmaWVyUmVnZXhwcyddLmZvckVhY2goZnVuY3Rpb24oaWRlbnRpZmllclJlZ2V4KSB7XG4gICAgICAgICAgICAgICAgaWYgKCFwcmVmaXggJiYgaWRlbnRpZmllclJlZ2V4KSB7XG4gICAgICAgICAgICAgICAgICAgIHByZWZpeCA9IHJldHJpZXZlUHJlY2VkaW5nSWRlbnRpZmllcihsaW5lLCBwb3MuY29sdW1uLCBpZGVudGlmaWVyUmVnZXgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHByZWZpeDtcbn1cblxudmFyIGRvTGl2ZUF1dG9jb21wbGV0ZSA9IGZ1bmN0aW9uKGU6IHsgZWRpdG9yOiBFZGl0b3I7IGNvbW1hbmQ6IHsgbmFtZTogc3RyaW5nIH07IGFyZ3MgfSkge1xuICAgIHZhciBlZGl0b3IgPSBlLmVkaXRvcjtcbiAgICB2YXIgdGV4dCA9IGUuYXJncyB8fCBcIlwiO1xuICAgIHZhciBoYXNDb21wbGV0ZXIgPSBnZXRDb21wbGV0ZXIoZWRpdG9yKSAmJiBnZXRDb21wbGV0ZXIoZWRpdG9yKS5hY3RpdmF0ZWQ7XG5cbiAgICAvLyBXZSBkb24ndCB3YW50IHRvIGF1dG9jb21wbGV0ZSB3aXRoIG5vIHByZWZpeFxuICAgIGlmIChlLmNvbW1hbmQubmFtZSA9PT0gXCJiYWNrc3BhY2VcIikge1xuICAgICAgICBpZiAoaGFzQ29tcGxldGVyICYmICFnZXRDb21wbGV0aW9uUHJlZml4KGVkaXRvcikpXG4gICAgICAgICAgICBnZXRDb21wbGV0ZXIoZWRpdG9yKS5kZXRhY2goKTtcbiAgICB9XG4gICAgZWxzZSBpZiAoZS5jb21tYW5kLm5hbWUgPT09IFwiaW5zZXJ0c3RyaW5nXCIpIHtcbiAgICAgICAgdmFyIHByZWZpeCA9IGdldENvbXBsZXRpb25QcmVmaXgoZWRpdG9yKTtcbiAgICAgICAgLy8gT25seSBhdXRvY29tcGxldGUgaWYgdGhlcmUncyBhIHByZWZpeCB0aGF0IGNhbiBiZSBtYXRjaGVkXG4gICAgICAgIGlmIChwcmVmaXggJiYgIWhhc0NvbXBsZXRlcikge1xuICAgICAgICAgICAgaWYgKCFnZXRDb21wbGV0ZXIoZWRpdG9yKSkge1xuICAgICAgICAgICAgICAgIHNldENvbXBsZXRlcihlZGl0b3IsIG5ldyBDb21wbGV0ZXJBZ2dyZWdhdGUoZWRpdG9yKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICAvLyBEaXNhYmxlIGF1dG9JbnNlcnRcbiAgICAgICAgICAgIGdldENvbXBsZXRlcihlZGl0b3IpLmF1dG9TZWxlY3QgPSBmYWxzZTtcbiAgICAgICAgICAgIGdldENvbXBsZXRlcihlZGl0b3IpLmF1dG9JbnNlcnQgPSBmYWxzZTtcbiAgICAgICAgICAgIGdldENvbXBsZXRlcihlZGl0b3IpLnNob3dQb3B1cChlZGl0b3IpO1xuICAgICAgICB9XG4gICAgfVxufTtcblxuZGVmaW5lT3B0aW9ucyhFZGl0b3IucHJvdG90eXBlLCAnZWRpdG9yJywge1xuICAgIGVuYWJsZUJhc2ljQXV0b2NvbXBsZXRpb246IHtcbiAgICAgICAgc2V0OiBmdW5jdGlvbih2YWwpIHtcbiAgICAgICAgICAgIHZhciBlZGl0b3I6IEVkaXRvciA9IHRoaXM7XG4gICAgICAgICAgICBpZiAodmFsKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFlZGl0b3IuY29tcGxldGVycykge1xuICAgICAgICAgICAgICAgICAgICBlZGl0b3IuY29tcGxldGVycyA9IEFycmF5LmlzQXJyYXkodmFsKSA/IHZhbCA6IGNvbXBsZXRlcnM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVkaXRvci5jb21tYW5kcy5hZGRDb21tYW5kKEF1dG9jb21wbGV0ZS5zdGFydENvbW1hbmQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgZWRpdG9yLmNvbW1hbmRzLnJlbW92ZUNvbW1hbmQoQXV0b2NvbXBsZXRlLnN0YXJ0Q29tbWFuZC5uYW1lKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgdmFsdWU6IGZhbHNlXG4gICAgfSxcbiAgICAvKipcbiAgICAgKiBFbmFibGUgbGl2ZSBhdXRvY29tcGxldGUuIElmIHRoZSB2YWx1ZSBpcyBhbiBhcnJheSwgaXQgaXMgYXNzdW1lZCB0byBiZSBhbiBhcnJheSBvZiBjb21wbGV0ZXJzXG4gICAgICogYW5kIHdpbGwgdXNlIHRoZW0gaW5zdGVhZCBvZiB0aGUgZGVmYXVsdCBjb21wbGV0ZXJzLlxuICAgICAqL1xuICAgIGVuYWJsZUxpdmVBdXRvY29tcGxldGlvbjoge1xuICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbCkge1xuICAgICAgICAgICAgdmFyIGVkaXRvcjogRWRpdG9yID0gdGhpcztcbiAgICAgICAgICAgIGlmICh2YWwpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWVkaXRvci5jb21wbGV0ZXJzKSB7XG4gICAgICAgICAgICAgICAgICAgIGVkaXRvci5jb21wbGV0ZXJzID0gQXJyYXkuaXNBcnJheSh2YWwpID8gdmFsIDogY29tcGxldGVycztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgLy8gT24gZWFjaCBjaGFuZ2UgYXV0b21hdGljYWxseSB0cmlnZ2VyIHRoZSBhdXRvY29tcGxldGVcbiAgICAgICAgICAgICAgICBlZGl0b3IuY29tbWFuZHMub24oJ2FmdGVyRXhlYycsIGRvTGl2ZUF1dG9jb21wbGV0ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBlZGl0b3IuY29tbWFuZHMub2ZmKCdhZnRlckV4ZWMnLCBkb0xpdmVBdXRvY29tcGxldGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICB2YWx1ZTogZmFsc2VcbiAgICB9LFxuICAgIGVuYWJsZVNuaXBwZXRzOiB7XG4gICAgICAgIHNldDogZnVuY3Rpb24odmFsKSB7XG4gICAgICAgICAgICB2YXIgZWRpdG9yOiBFZGl0b3IgPSB0aGlzO1xuICAgICAgICAgICAgaWYgKHZhbCkge1xuICAgICAgICAgICAgICAgIGVkaXRvci5jb21tYW5kcy5hZGRDb21tYW5kKGV4cGFuZFNuaXBwZXQpO1xuICAgICAgICAgICAgICAgIGVkaXRvci5vbihcImNoYW5nZU1vZGVcIiwgb25DaGFuZ2VNb2RlKTtcbiAgICAgICAgICAgICAgICBvbkNoYW5nZU1vZGUobnVsbCwgZWRpdG9yKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGVkaXRvci5jb21tYW5kcy5yZW1vdmVDb21tYW5kKGV4cGFuZFNuaXBwZXQubmFtZSk7XG4gICAgICAgICAgICAgICAgZWRpdG9yLm9mZihcImNoYW5nZU1vZGVcIiwgb25DaGFuZ2VNb2RlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgdmFsdWU6IGZhbHNlXG4gICAgfVxufSk7XG4iXX0=