"use strict";
export default class CompletionList {
    constructor(all, filterText) {
        this.all = all;
        this.filtered = all;
        this.filterText = filterText || "";
    }
    setFilter(filterText) {
        var matches;
        if (filterText.length > this.filterText.length && filterText.lastIndexOf(this.filterText, 0) === 0) {
            matches = this.filtered;
        }
        else {
            matches = this.all;
        }
        this.filterText = filterText;
        matches = this.filterCompletions(matches, this.filterText);
        matches = matches.sort(function (a, b) {
            return b.exactMatch - a.exactMatch || b.score - a.score;
        });
        var prev = null;
        matches = matches.filter(function (item) {
            var caption = item.value || item.caption || item.snippet;
            if (caption === prev)
                return false;
            prev = caption;
            return true;
        });
        this.filtered = matches;
    }
    filterCompletions(items, needle) {
        var results = [];
        var upper = needle.toUpperCase();
        var lower = needle.toLowerCase();
        loop: for (var i = 0, length = items.length; i < length; i++) {
            var item = items[i];
            var caption = item.value || item.caption || item.snippet;
            if (!caption)
                continue;
            var lastIndex = -1;
            var matchMask = 0;
            var penalty = 0;
            var index;
            var distance;
            for (var j = 0; j < needle.length; j++) {
                var i1 = caption.indexOf(lower[j], lastIndex + 1);
                var i2 = caption.indexOf(upper[j], lastIndex + 1);
                index = (i1 >= 0) ? ((i2 < 0 || i1 < i2) ? i1 : i2) : i2;
                if (index < 0)
                    continue loop;
                distance = index - lastIndex - 1;
                if (distance > 0) {
                    if (lastIndex === -1)
                        penalty += 10;
                    penalty += distance;
                }
                matchMask = matchMask | (1 << index);
                lastIndex = index;
            }
            item.matchMask = matchMask;
            item.exactMatch = penalty ? 0 : 1;
            item.score = (item.score || 0) - penalty;
            results.push(item);
        }
        return results;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29tcGxldGlvbkxpc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJDb21wbGV0aW9uTGlzdC50cyJdLCJuYW1lcyI6WyJDb21wbGV0aW9uTGlzdCIsIkNvbXBsZXRpb25MaXN0LmNvbnN0cnVjdG9yIiwiQ29tcGxldGlvbkxpc3Quc2V0RmlsdGVyIiwiQ29tcGxldGlvbkxpc3QuZmlsdGVyQ29tcGxldGlvbnMiXSwibWFwcGluZ3MiOiJBQXVCQSxZQUFZLENBQUM7QUFPYjtJQTJCSUEsWUFBWUEsR0FBaUJBLEVBQUVBLFVBQW1CQTtRQUM5Q0MsSUFBSUEsQ0FBQ0EsR0FBR0EsR0FBR0EsR0FBR0EsQ0FBQ0E7UUFDZkEsSUFBSUEsQ0FBQ0EsUUFBUUEsR0FBR0EsR0FBR0EsQ0FBQ0E7UUFDcEJBLElBQUlBLENBQUNBLFVBQVVBLEdBQUdBLFVBQVVBLElBQUlBLEVBQUVBLENBQUNBO0lBQ3ZDQSxDQUFDQTtJQVNNRCxTQUFTQSxDQUFDQSxVQUFrQkE7UUFFL0JFLElBQUlBLE9BQXFCQSxDQUFDQTtRQUUxQkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsVUFBVUEsQ0FBQ0EsTUFBTUEsR0FBR0EsSUFBSUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsTUFBTUEsSUFBSUEsVUFBVUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsVUFBVUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDakdBLE9BQU9BLEdBQUdBLElBQUlBLENBQUNBLFFBQVFBLENBQUNBO1FBQzVCQSxDQUFDQTtRQUNEQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUNGQSxPQUFPQSxHQUFHQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQTtRQUN2QkEsQ0FBQ0E7UUFFREEsSUFBSUEsQ0FBQ0EsVUFBVUEsR0FBR0EsVUFBVUEsQ0FBQ0E7UUFFN0JBLE9BQU9BLEdBQUdBLElBQUlBLENBQUNBLGlCQUFpQkEsQ0FBQ0EsT0FBT0EsRUFBRUEsSUFBSUEsQ0FBQ0EsVUFB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O2dCQUN6REEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsS0FBS0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7b0JBQ1ZBLFFBQVFBLENBQUNBLElBQUlBLENBQUNBO2dCQUNsQkEsUUFBUUEsR0FBR0EsS0FBS0EsR0FBR0EsU0FBU0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ2pDQSxFQUFFQSxDQUFDQSxDQUFDQSxRQUFRQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtvQkFFZkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsU0FBU0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7d0JBQ2pCQSxPQUFPQSxJQUFJQSxFQUFFQSxDQUFDQTtvQkFDbEJBLE9BQU9BLElBQUlBLFFBQVFBLENBQUNBO2dCQUN4QkEsQ0FBQ0E7Z0JBQ0RBLFNBQVNBLEdBQUdBLFNBQVNBLEdBQUdBLENBQUNBLENBQUNBLElBQUlBLEtBQUtBLENBQUNBLENBQUNBO2dCQUNyQ0EsU0FBU0EsR0FBR0EsS0FBS0EsQ0FBQ0E7WUFDdEJBLENBQUNBO1lBQ0RBLElBQUlBLENBQUNBLFNBQVNBLEdBQUdBLFNBQVNBLENBQUNBO1lBQzNCQSxJQUFJQSxDQUFDQSxVQUFVQSxHQUFHQSxPQUFPQSxHQUFHQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQTtZQUNsQ0EsSUFBSUEsQ0FBQ0EsS0FBS0EsR0FBR0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsS0FBS0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsT0FBT0EsQ0FBQ0E7WUFDekNBLE9BQU9BLENBQUNBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO1FBQ3ZCQSxDQUFDQTtRQUNEQSxNQUFNQSxDQUFDQSxPQUFPQSxDQUFDQTtJQUNuQkEsQ0FBQ0E7QUFDTEgsQ0FBQ0E7QUFBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qICoqKioqIEJFR0lOIExJQ0VOU0UgQkxPQ0sgKioqKipcbiAqIFRoZSBNSVQgTGljZW5zZSAoTUlUKVxuICpcbiAqIENvcHlyaWdodCAoYykgMjAxNC0yMDE2IERhdmlkIEdlbyBIb2xtZXMgPGRhdmlkLmdlby5ob2xtZXNAZ21haWwuY29tPlxuICpcbiAqIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhIGNvcHlcbiAqIG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlIFwiU29mdHdhcmVcIiksIHRvIGRlYWxcbiAqIGluIHRoZSBTb2Z0d2FyZSB3aXRob3V0IHJlc3RyaWN0aW9uLCBpbmNsdWRpbmcgd2l0aG91dCBsaW1pdGF0aW9uIHRoZSByaWdodHNcbiAqIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwgZGlzdHJpYnV0ZSwgc3VibGljZW5zZSwgYW5kL29yIHNlbGxcbiAqIGNvcGllcyBvZiB0aGUgU29mdHdhcmUsIGFuZCB0byBwZXJtaXQgcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpc1xuICogZnVybmlzaGVkIHRvIGRvIHNvLCBzdWJqZWN0IHRvIHRoZSBmb2xsb3dpbmcgY29uZGl0aW9uczpcbiAqXG4gKiBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZCBpbiBhbGxcbiAqIGNvcGllcyBvciBzdWJzdGFudGlhbCBwb3J0aW9ucyBvZiB0aGUgU29mdHdhcmUuXG4gKlxuICogVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEIFwiQVMgSVNcIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUyBPUlxuICogSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFksXG4gKiBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTiBOTyBFVkVOVCBTSEFMTCBUSEVcbiAqIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sIERBTUFHRVMgT1IgT1RIRVJcbiAqIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IgT1RIRVJXSVNFLCBBUklTSU5HIEZST00sXG4gKiBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUgVVNFIE9SIE9USEVSIERFQUxJTkdTIElOIFRIRVxuICogU09GVFdBUkUuXG4gKiAqKioqKiBFTkQgTElDRU5TRSBCTE9DSyAqKioqKiAqL1xuXCJ1c2Ugc3RyaWN0XCI7XG5cbmltcG9ydCBDb21wbGV0aW9uIGZyb20gXCIuL0NvbXBsZXRpb25cIjtcblxuLyoqXG4gKiBAY2xhc3MgQ29tcGxldGlvbkxpc3RcbiAqL1xuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQ29tcGxldGlvbkxpc3Qge1xuXG4gICAgLyoqXG4gICAgICogQHByb3BlcnR5IGFsbFxuICAgICAqIEB0eXBlIENvbXBsZXRpb25bXVxuICAgICAqIEBwcml2YXRlXG4gICAgICovXG4gICAgcHJpdmF0ZSBhbGw6IENvbXBsZXRpb25bXTtcblxuICAgIC8qKlxuICAgICAqIEBwcm9wZXJ0eSBmaWx0ZXJlZFxuICAgICAqIEB0eXBlIENvbXBsZXRpb25bXVxuICAgICAqL1xuICAgIHB1YmxpYyBmaWx0ZXJlZDogQ29tcGxldGlvbltdO1xuXG4gICAgLyoqXG4gICAgICogQHByb3BlcnR5IGZpbHRlclRleHRcbiAgICAgKiBAdHlwZSBzdHJpbmdcbiAgICAgKi9cbiAgICBwdWJsaWMgZmlsdGVyVGV4dDogc3RyaW5nO1xuXG4gICAgLyoqXG4gICAgICogQGNsYXNzIENvbXBsZXRpb25MaXN0XG4gICAgICogQGNvbnN0cnVjdG9yXG4gICAgICogQHBhcmFtIGFsbCB7Q29tcGxldGlvbltdfVxuICAgICAqIEBwYXJhbSBbZmlsdGVyVGV4dF0ge3N0cmluZ31cbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihhbGw6IENvbXBsZXRpb25bXSwgZmlsdGVyVGV4dD86IHN0cmluZykge1xuICAgICAgICB0aGlzLmFsbCA9IGFsbDtcbiAgICAgICAgdGhpcy5maWx0ZXJlZCA9IGFsbDtcbiAgICAgICAgdGhpcy5maWx0ZXJUZXh0ID0gZmlsdGVyVGV4dCB8fCBcIlwiO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFVwZGF0ZXMgdGhlIDxjb2RlPmZpbHRlcmVkPC9jb2RlPiBwcm9wZXJ0eSBvZiB0aGlzIGxpc3Qgb2YgY29tcGxldGlvbnMuXG4gICAgICpcbiAgICAgKiBAbWV0aG9kIHNldEZpbHRlclxuICAgICAqIEBwYXJhbSBmaWx0ZXJUZXh0IHtzdHJpbmd9XG4gICAgICogQHJldHVybiB7dm9pZH1cbiAgICAgKi9cbiAgICBwdWJsaWMgc2V0RmlsdGVyKGZpbHRlclRleHQ6IHN0cmluZyk6IHZvaWQge1xuXG4gICAgICAgIHZhciBtYXRjaGVzOiBDb21wbGV0aW9uW107XG5cbiAgICAgICAgaWYgKGZpbHRlclRleHQubGVuZ3RoID4gdGhpcy5maWx0ZXJUZXh0Lmxlbmd0aCAmJiBmaWx0ZXJUZXh0Lmxhc3RJbmRleE9mKHRoaXMuZmlsdGVyVGV4dCwgMCkgPT09IDApIHtcbiAgICAgICAgICAgIG1hdGNoZXMgPSB0aGlzLmZpbHRlcmVkO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgbWF0Y2hlcyA9IHRoaXMuYWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5maWx0ZXJUZXh0ID0gZmlsdGVyVGV4dDtcblxuICAgICAgICBtYXRjaGVzID0gdGhpcy5maWx0ZXJDb21wbGV0aW9ucyhtYXRjaGVzLCB0aGlzLmZpbHRlclRleHQpO1xuXG4gICAgICAgIG1hdGNoZXMgPSBtYXRjaGVzLnNvcnQoZnVuY3Rpb24oYTogQ29tcGxldGlvbiwgYjogQ29tcGxldGlvbikge1xuICAgICAgICAgICAgcmV0dXJuIGIuZXhhY3RNYXRjaCAtIGEuZXhhY3RNYXRjaCB8fCBiLnNjb3JlIC0gYS5zY29yZTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gbWFrZSB1bmlxdWVcbiAgICAgICAgdmFyIHByZXY6IHN0cmluZyA9IG51bGw7XG4gICAgICAgIG1hdGNoZXMgPSBtYXRjaGVzLmZpbHRlcihmdW5jdGlvbihpdGVtOiBDb21wbGV0aW9uKSB7XG4gICAgICAgICAgICB2YXIgY2FwdGlvbiA9IGl0ZW0udmFsdWUgfHwgaXRlbS5jYXB0aW9uIHx8IGl0ZW0uc25pcHBldDtcbiAgICAgICAgICAgIGlmIChjYXB0aW9uID09PSBwcmV2KSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICBwcmV2ID0gY2FwdGlvbjtcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9KTtcblxuICAgICAgICB0aGlzLmZpbHRlcmVkID0gbWF0Y2hlcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAbWV0aG9kIGZpbHRlckNvbXBsZXRpb25zXG4gICAgICogQHBhcmFtIGl0ZW1zIHtDb21wbGV0aW9uW119XG4gICAgICogQHBhcmFtIG5lZWRsZSB7c3RyaW5nfVxuICAgICAqIEByZXR1cm4ge0NvbXBsZXRpb25bXX1cbiAgICAgKiBAcHJpdmF0ZVxuICAgICAqL1xuICAgIHByaXZhdGUgZmlsdGVyQ29tcGxldGlvbnMoaXRlbXM6IENvbXBsZXRpb25bXSwgbmVlZGxlOiBzdHJpbmcpOiBDb21wbGV0aW9uW10ge1xuXG4gICAgICAgIHZhciByZXN1bHRzOiBDb21wbGV0aW9uW10gPSBbXTtcbiAgICAgICAgdmFyIHVwcGVyID0gbmVlZGxlLnRvVXBwZXJDYXNlKCk7XG4gICAgICAgIHZhciBsb3dlciA9IG5lZWRsZS50b0xvd2VyQ2FzZSgpO1xuXG4gICAgICAgIGxvb3A6IGZvciAodmFyIGkgPSAwLCBsZW5ndGggPSBpdGVtcy5sZW5ndGg7IGkgPCBsZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgdmFyIGl0ZW06IENvbXBsZXRpb24gPSBpdGVtc1tpXTtcbiAgICAgICAgICAgIHZhciBjYXB0aW9uID0gaXRlbS52YWx1ZSB8fCBpdGVtLmNhcHRpb24gfHwgaXRlbS5zbmlwcGV0O1xuICAgICAgICAgICAgaWYgKCFjYXB0aW9uKSBjb250aW51ZTtcbiAgICAgICAgICAgIHZhciBsYXN0SW5kZXggPSAtMTtcbiAgICAgICAgICAgIHZhciBtYXRjaE1hc2sgPSAwO1xuICAgICAgICAgICAgdmFyIHBlbmFsdHkgPSAwO1xuICAgICAgICAgICAgdmFyIGluZGV4OiBudW1iZXI7XG4gICAgICAgICAgICB2YXIgZGlzdGFuY2U6IG51bWJlcjtcbiAgICAgICAgICAgIC8vIGNhcHRpb24gY2hhciBpdGVyYXRpb24gaXMgZmFzdGVyIGluIENocm9tZSBidXQgc2xvd2VyIGluIEZpcmVmb3gsIHNvIGxldHMgdXNlIGluZGV4T2ZcbiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgbmVlZGxlLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgLy8gVE9ETyBhZGQgcGVuYWx0eSBvbiBjYXNlIG1pc21hdGNoXG4gICAgICAgICAgICAgICAgdmFyIGkxID0gY2FwdGlvbi5pbmRleE9mKGxvd2VyW2pdLCBsYXN0SW5kZXggKyAxKTtcbiAgICAgICAgICAgICAgICB2YXIgaTIgPSBjYXB0aW9uLmluZGV4T2YodXBwZXJbal0sIGxhc3RJbmRleCArIDEpO1xuICAgICAgICAgICAgICAgIGluZGV4ID0gKGkxID49IDApID8gKChpMiA8IDAgfHwgaTEgPCBpMikgPyBpMSA6IGkyKSA6IGkyO1xuICAgICAgICAgICAgICAgIGlmIChpbmRleCA8IDApXG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlIGxvb3A7XG4gICAgICAgICAgICAgICAgZGlzdGFuY2UgPSBpbmRleCAtIGxhc3RJbmRleCAtIDE7XG4gICAgICAgICAgICAgICAgaWYgKGRpc3RhbmNlID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAvLyBmaXJzdCBjaGFyIG1pc21hdGNoIHNob3VsZCBiZSBtb3JlIHNlbnNpdGl2ZVxuICAgICAgICAgICAgICAgICAgICBpZiAobGFzdEluZGV4ID09PSAtMSlcbiAgICAgICAgICAgICAgICAgICAgICAgIHBlbmFsdHkgKz0gMTA7XG4gICAgICAgICAgICAgICAgICAgIHBlbmFsdHkgKz0gZGlzdGFuY2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG1hdGNoTWFzayA9IG1hdGNoTWFzayB8ICgxIDw8IGluZGV4KTtcbiAgICAgICAgICAgICAgICBsYXN0SW5kZXggPSBpbmRleDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGl0ZW0ubWF0Y2hNYXNrID0gbWF0Y2hNYXNrO1xuICAgICAgICAgICAgaXRlbS5leGFjdE1hdGNoID0gcGVuYWx0eSA/IDAgOiAxO1xuICAgICAgICAgICAgaXRlbS5zY29yZSA9IChpdGVtLnNjb3JlIHx8IDApIC0gcGVuYWx0eTtcbiAgICAgICAgICAgIHJlc3VsdHMucHVzaChpdGVtKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0cztcbiAgICB9XG59XG4iXX0=