<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/lib/event.ts - deuce</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../../assets/logo.png" title="deuce"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.16</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Anchor.html">Anchor</a></li>
                                <li><a href="../classes/BackgroundTokenizer.html">BackgroundTokenizer</a></li>
                                <li><a href="../classes/Editor.html">Editor</a></li>
                                <li><a href="../classes/EditorDocument.html">EditorDocument</a></li>
                                <li><a href="../classes/EditSession.html">EditSession</a></li>
                                <li><a href="../classes/Fold.html">Fold</a></li>
                                <li><a href="../classes/FoldLine.html">FoldLine</a></li>
                                <li><a href="../classes/GutterTooltip.html">GutterTooltip</a></li>
                                <li><a href="../classes/HScrollBar.html">HScrollBar</a></li>
                                <li><a href="../classes/HtmlMode.html">HtmlMode</a></li>
                                <li><a href="../classes/.html"></a></li>
                                <li><a href="../classes/Mode.html">Mode</a></li>
                                <li><a href="../classes/Position.html">Position</a></li>
                                <li><a href="../classes/Range.html">Range</a></li>
                                <li><a href="../classes/ScrollBar.html">ScrollBar</a></li>
                                <li><a href="../classes/Search.html">Search</a></li>
                                <li><a href="../classes/Selection.html">Selection</a></li>
                                <li><a href="../classes/TokenIterator.html">TokenIterator</a></li>
                                <li><a href="../classes/Tokenizer.html">Tokenizer</a></li>
                                <li><a href="../classes/Tooltip.html">Tooltip</a></li>
                                <li><a href="../classes/UndoManager.html">UndoManager</a></li>
                                <li><a href="../classes/VirtualRenderer.html">VirtualRenderer</a></li>
                                <li><a href="../classes/VScrollBar.html">VScrollBar</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/lib/event.ts</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/* ***** BEGIN LICENSE BLOCK *****
 * Distributed under the BSD license:
 *
 * Copyright (c) 2010, Ajax.org B.V.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above copyright
 *       notice, this list of conditions and the following disclaimer in the
 *       documentation and/or other materials provided with the distribution.
 *     * Neither the name of Ajax.org B.V. nor the
 *       names of its contributors may be used to endorse or promote products
 *       derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL AJAX.ORG B.V. BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * ***** END LICENSE BLOCK ***** */
import { FUNCTION_KEYS, KEY_MODS, MODIFIER_KEYS, PRINTABLE_KEYS } from &#x27;./keys&#x27;;
import { isChromeOS, isIE, isMac, isOldGecko, isOldIE, isOpera } from &#x27;./useragent&#x27;;

export interface ListenerTarget extends EventTarget {
}

export function addListener(target: ListenerTarget, type: string, callback, useCapture?: boolean) {
    if (target.addEventListener) {
        return target.addEventListener(type, callback, false);
    }
}

export function removeListener(target: ListenerTarget, type, callback, useCapture?: boolean) {
    if (target.removeEventListener) {
        return target.removeEventListener(type, callback, false);
    }
}

/*
* Prevents propagation and clobbers the default action of the passed event
*/
export function stopEvent(e: Event): boolean {
    stopPropagation(e);
    preventDefault(e);
    return false;
}

export function stopPropagation(e: Event): void {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    else {
        e.cancelBubble = true;
    }
}

export function preventDefault(e: Event): void {
    // returnValue is no longer documented in typings.
    var RETURN_VALUE_DEPRECATED = &#x27;returnValue&#x27;;
    if (e.preventDefault) {
        e.preventDefault();
    }
    else if (e[RETURN_VALUE_DEPRECATED]) {
        e[RETURN_VALUE_DEPRECATED] = false;
    }
}

/*
 * @return {Number} 0 for left button, 1 for middle button, 2 for right button
 */
export function getButton(e: MouseEvent): number {
    if (e.type == &quot;dblclick&quot;)
        return 0;
    if (e.type == &quot;contextmenu&quot; || (isMac &amp;&amp; (e.ctrlKey &amp;&amp; !e.altKey &amp;&amp; !e.shiftKey)))
        return 2;

    // DOM Event
    if (e.preventDefault) {
        return e.button;
    }
    // old IE
    else {
        return { 1: 0, 2: 2, 4: 1 }[e.button];
    }
}

// FIXME: We should not be assuming the document as window.document!
/**
 * Returns a function which may be used to manually release the mouse.
 */
export function capture(unused: HTMLElement, acquireCaptureHandler: (event: MouseEvent) =&gt; void, releaseCaptureHandler: (event: MouseEvent) =&gt; void): (event: MouseEvent) =&gt; void {
    // FIXME: &#x27;Document&#x27; is missing property &#x27;onmouseleave&#x27; from &#x27;HTMLElement&#x27;.
    var element: any = document;

    function releaseMouse(e: MouseEvent) {

        // It seems redundant and cumbersome to provide this event to both handlers?
        acquireCaptureHandler &amp;&amp; acquireCaptureHandler(e);

        releaseCaptureHandler &amp;&amp; releaseCaptureHandler(e);

        removeListener(element, &quot;mousemove&quot;, acquireCaptureHandler, true);
        removeListener(element, &quot;mouseup&quot;, releaseMouse, true);
        removeListener(element, &quot;dragstart&quot;, releaseMouse, true);
    }

    addListener(element, &quot;mousemove&quot;, acquireCaptureHandler, true);
    addListener(element, &quot;mouseup&quot;, releaseMouse, true);
    addListener(element, &quot;dragstart&quot;, releaseMouse, true);

    return releaseMouse;
}

/**
 * Adds a portable &#x27;mousewheel&#x27; [&#x27;wheel&#x27;,&#x27;DOM MouseScroll&#x27;] listener to an element.
 */
export function addMouseWheelListener(element: HTMLElement, callback: (event: MouseWheelEvent) =&gt; void): void {
    if (&quot;onmousewheel&quot; in element) {
        addListener(element, &quot;mousewheel&quot;, function(e: MouseWheelEvent) {
            var factor = 8;
            if (e[&#x27;wheelDeltaX&#x27;] !== undefined) {
                e[&#x27;wheelX&#x27;] = -e[&#x27;wheelDeltaX&#x27;] / factor;
                e[&#x27;wheelY&#x27;] = -e[&#x27;wheelDeltaY&#x27;] / factor;
            }
            else {
                e[&#x27;wheelX&#x27;] = 0;
                e[&#x27;wheelY&#x27;] = -e.wheelDelta / factor;
            }
            callback(e);
        });
    }
    else if (&quot;onwheel&quot; in element) {
        addListener(element, &quot;wheel&quot;, function(e) {
            var factor = 0.35;
            switch (e.deltaMode) {
                case e.DOM_DELTA_PIXEL:
                    e.wheelX = e.deltaX * factor || 0;
                    e.wheelY = e.deltaY * factor || 0;
                    break;
                case e.DOM_DELTA_LINE:
                case e.DOM_DELTA_PAGE:
                    e.wheelX = (e.deltaX || 0) * 5;
                    e.wheelY = (e.deltaY || 0) * 5;
                    break;
            }
            callback(e);
        });
    }
    else {
        // TODO: Define interface for DOMMouseScroll.
        addListener(element, &quot;DOMMouseScroll&quot;, function(e) {
            if (e.axis &amp;&amp; e.axis == e.HORIZONTAL_AXIS) {
                e.wheelX = (e.detail || 0) * 5;
                e.wheelY = 0;
            }
            else {
                e.wheelX = 0;
                e.wheelY = (e.detail || 0) * 5;
            }
            callback(e);
        });
    }
}

export function addMultiMouseDownListener(el, timeouts, eventHandler, callbackName) {
    var clicks = 0;
    var startX, startY, timer;
    var eventNames = {
        2: &quot;dblclick&quot;,
        3: &quot;tripleclick&quot;,
        4: &quot;quadclick&quot;
    };

    addListener(el, &quot;mousedown&quot;, function(e: MouseEvent) {
        if (getButton(e) !== 0) {
            clicks = 0;
        } else if (e.detail &gt; 1) {
            clicks++;
            if (clicks &gt; 4)
                clicks = 1;
        } else {
            clicks = 1;
        }
        if (isIE) {
            var isNewClick = Math.abs(e.clientX - startX) &gt; 5 || Math.abs(e.clientY - startY) &gt; 5;
            if (!timer || isNewClick)
                clicks = 1;
            if (timer)
                clearTimeout(timer);
            timer = setTimeout(function() { timer = null }, timeouts[clicks - 1] || 600);

            if (clicks == 1) {
                startX = e.clientX;
                startY = e.clientY;
            }
        }

        // TODO. This custom property is not part of MouseEvent.
        e[&#x27;_clicks&#x27;] = clicks;

        eventHandler[callbackName](&quot;mousedown&quot;, e);

        if (clicks &gt; 4)
            clicks = 0;
        else if (clicks &gt; 1)
            return eventHandler[callbackName](eventNames[clicks], e);
    });

    if (isOldIE) {
        addListener(el, &quot;dblclick&quot;, function(e) {
            clicks = 2;
            if (timer)
                clearTimeout(timer);
            timer = setTimeout(function() { timer = null }, timeouts[clicks - 1] || 600);
            eventHandler[callbackName](&quot;mousedown&quot;, e);
            eventHandler[callbackName](eventNames[clicks], e);
        });
    }
}

var getModifierHash = isMac &amp;&amp; isOpera &amp;&amp; !(&quot;KeyboardEvent&quot; in window)
    ? function(e) {
        return 0 | (e.metaKey ? 1 : 0) | (e.altKey ? 2 : 0) | (e.shiftKey ? 4 : 0) | (e.ctrlKey ? 8 : 0);
    }
    : function(e) {
        return 0 | (e.ctrlKey ? 1 : 0) | (e.altKey ? 2 : 0) | (e.shiftKey ? 4 : 0) | (e.metaKey ? 8 : 0);
    };

export function getModifierString(e) {
    return KEY_MODS[getModifierHash(e)];
}

function normalizeCommandKeys(callback, e: KeyboardEvent, keyCode: number) {
    var hashId = getModifierHash(e);

    if (!isMac &amp;&amp; pressedKeys) {
        if (pressedKeys[91] || pressedKeys[92])
            hashId |= 8;
        if (pressedKeys.altGr) {
            if ((3 &amp; hashId) != 3)
                pressedKeys.altGr = 0;
            else
                return;
        }
        if (keyCode === 18 || keyCode === 17) {
            if (keyCode === 17 &amp;&amp; e.location === 1) {
                ts = e.timeStamp;
            } else if (keyCode === 18 &amp;&amp; hashId === 3 &amp;&amp; e.location === 2) {
                var dt = -ts;
                ts = e.timeStamp;
                dt += ts;
                if (dt &lt; 3)
                    pressedKeys.altGr = true;
            }
        }
    }

    if (keyCode in MODIFIER_KEYS) {
        switch (MODIFIER_KEYS[keyCode]) {
            case &quot;Alt&quot;:
                hashId = 2;
                break;
            case &quot;Shift&quot;:
                hashId = 4;
                break;
            case &quot;Ctrl&quot;:
                hashId = 1;
                break;
            default:
                hashId = 8;
                break;
        }
        keyCode = -1;
    }

    if (hashId &amp; 8 &amp;&amp; (keyCode === 91 || keyCode === 93)) {
        keyCode = -1;
    }

    if (!hashId &amp;&amp; keyCode === 13) {
        if (e.location === 3) {
            callback(e, hashId, -keyCode);
            if (e.defaultPrevented)
                return;
        }
    }

    if (isChromeOS &amp;&amp; hashId &amp; 8) {
        callback(e, hashId, keyCode);
        if (e.defaultPrevented)
            return;
        else
            hashId &amp;= ~8;
    }

    // If there is no hashId and the keyCode is not a function key, then
    // we don&#x27;t call the callback as we don&#x27;t handle a command key here
    // (it&#x27;s a normal key/character input).
    if (!hashId &amp;&amp; !(keyCode in FUNCTION_KEYS) &amp;&amp; !(keyCode in PRINTABLE_KEYS)) {
        return false;
    }

    return callback(e, hashId, keyCode);
}

var pressedKeys = null;

function resetPressedKeys(e) {
    pressedKeys = Object.create(null);
}

var ts = 0;
export function addCommandKeyListener(el, callback) {
    if (isOldGecko || (isOpera &amp;&amp; !(&quot;KeyboardEvent&quot; in window))) {
        // Old versions of Gecko aka. Firefox &lt; 4.0 didn&#x27;t repeat the keydown
        // event if the user pressed the key for a longer time. Instead, the
        // keydown event was fired once and later on only the keypress event.
        // To emulate the &#x27;right&#x27; keydown behavior, the keyCode of the initial
        // keyDown event is stored and in the following keypress events the
        // stores keyCode is used to emulate a keyDown event.
        var lastKeyDownKeyCode = null;
        addListener(el, &quot;keydown&quot;, function(e: KeyboardEvent) {
            lastKeyDownKeyCode = e.keyCode;
        });
        addListener(el, &quot;keypress&quot;, function(e: KeyboardEvent) {
            return normalizeCommandKeys(callback, e, lastKeyDownKeyCode);
        });
    }
    else {
        var lastDefaultPrevented = null;

        addListener(el, &quot;keydown&quot;, function(e: KeyboardEvent) {
            pressedKeys[e.keyCode] = true;
            var result = normalizeCommandKeys(callback, e, e.keyCode);
            lastDefaultPrevented = e.defaultPrevented;
            return result;
        });

        addListener(el, &#x27;keypress&#x27;, function(e: KeyboardEvent) {
            if (lastDefaultPrevented &amp;&amp; (e.ctrlKey || e.altKey || e.shiftKey || e.metaKey)) {
                stopEvent(e);
                lastDefaultPrevented = null;
            }
        });

        addListener(el, &#x27;keyup&#x27;, function(e: KeyboardEvent) {
            pressedKeys[e.keyCode] = null;
        });

        if (!pressedKeys) {
            pressedKeys = Object.create(null);
            addListener(window, &#x27;focus&#x27;, resetPressedKeys);
        }
    }
}

// FIXME: Conditional exports not supported by TypeScript or Harmony/ES6.
// declare var exports: any;
/*
if (window.postMessage &amp;&amp; !isOldIE) {
    var postMessageId = 1;
    exports.nextTick = function(callback, win) {
        win = win || window;
        var messageName = &quot;zero-timeout-message-&quot; + postMessageId;
        addListener(win, &quot;message&quot;, function listener(e) {
            if (e.data == messageName) {
                stopPropagation(e);
                removeListener(win, &quot;message&quot;, listener);
                callback();
            }
        });
        win.postMessage(messageName, &quot;*&quot;);
    };
}
*/

var nextFrameCandidate: (callback: () =&gt; void, $window: Window) =&gt; void = window.requestAnimationFrame ||
    window[&#x27;mozRequestAnimationFrame&#x27;] ||
    window[&#x27;webkitRequestAnimationFrame&#x27;] ||
    window.msRequestAnimationFrame ||
    window[&#x27;oRequestAnimationFrame&#x27;];

if (nextFrameCandidate) {
    nextFrameCandidate = nextFrameCandidate.bind(window);
}
else {
    nextFrameCandidate = function(callback) {
        setTimeout(callback, 17);
    };
}

/**
 * A backwards-compatible, browser-neutral, requestAnimationFrame.
 */
export var requestAnimationFrame: (callback: () =&gt; void, $window: Window) =&gt; void = nextFrameCandidate;

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
