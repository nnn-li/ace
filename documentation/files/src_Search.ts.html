<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/Search.ts - deuce</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../../assets/logo.png" title="deuce"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.15</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Anchor.html">Anchor</a></li>
                                <li><a href="../classes/BackgroundTokenizer.html">BackgroundTokenizer</a></li>
                                <li><a href="../classes/Editor.html">Editor</a></li>
                                <li><a href="../classes/EditorDocument.html">EditorDocument</a></li>
                                <li><a href="../classes/EditSession.html">EditSession</a></li>
                                <li><a href="../classes/Fold.html">Fold</a></li>
                                <li><a href="../classes/FoldLine.html">FoldLine</a></li>
                                <li><a href="../classes/GutterTooltip.html">GutterTooltip</a></li>
                                <li><a href="../classes/HScrollBar.html">HScrollBar</a></li>
                                <li><a href="../classes/HtmlMode.html">HtmlMode</a></li>
                                <li><a href="../classes/.html"></a></li>
                                <li><a href="../classes/Mode.html">Mode</a></li>
                                <li><a href="../classes/Position.html">Position</a></li>
                                <li><a href="../classes/Range.html">Range</a></li>
                                <li><a href="../classes/ScrollBar.html">ScrollBar</a></li>
                                <li><a href="../classes/Search.html">Search</a></li>
                                <li><a href="../classes/Selection.html">Selection</a></li>
                                <li><a href="../classes/TokenIterator.html">TokenIterator</a></li>
                                <li><a href="../classes/Tokenizer.html">Tokenizer</a></li>
                                <li><a href="../classes/Tooltip.html">Tooltip</a></li>
                                <li><a href="../classes/UndoManager.html">UndoManager</a></li>
                                <li><a href="../classes/VirtualRenderer.html">VirtualRenderer</a></li>
                                <li><a href="../classes/VScrollBar.html">VScrollBar</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/Search.ts</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/* ***** BEGIN LICENSE BLOCK *****
 * Distributed under the BSD license:
 *
 * Copyright (c) 2010, Ajax.org B.V.
 * All rights reserved.
 * 
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above copyright
 *       notice, this list of conditions and the following disclaimer in the
 *       documentation and/or other materials provided with the distribution.
 *     * Neither the name of Ajax.org B.V. nor the
 *       names of its contributors may be used to endorse or promote products
 *       derived from this software without specific prior written permission.
 * 
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL AJAX.ORG B.V. BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * ***** END LICENSE BLOCK ***** */

import { copyObject, escapeRegExp, getMatchOffsets } from &quot;./lib/lang&quot;;
import { mixin } from &quot;./lib/oop&quot;;
import Range from &quot;./Range&quot;;
import EditSession from &quot;./EditSession&quot;;

/**
 * A class designed to handle all sorts of text searches within a [[Document &#x60;Document&#x60;]].
 * @class Search
 */
export default class Search {
    $options;
    /**
     * Creates a new &#x60;Search&#x60; object. The following search options are avaliable:
     *
     * - &#x60;needle&#x60;: The string or regular expression you&#x27;re looking for
     * - &#x60;backwards&#x60;: Whether to search backwards from where cursor currently is. Defaults to &#x60;false&#x60;.
     * - &#x60;wrap&#x60;: Whether to wrap the search back to the beginning when it hits the end. Defaults to &#x60;false&#x60;.
     * - &#x60;caseSensitive&#x60;: Whether the search ought to be case-sensitive. Defaults to &#x60;false&#x60;.
     * - &#x60;wholeWord&#x60;: Whether the search matches only on whole words. Defaults to &#x60;false&#x60;.
     * - &#x60;range&#x60;: The [[Range]] to search within. Set this to &#x60;null&#x60; for the whole document
     * - &#x60;regExp&#x60;: Whether the search is a regular expression or not. Defaults to &#x60;false&#x60;.
     * - &#x60;start&#x60;: The starting [[Range]] or cursor position to begin the search
     * - &#x60;skipCurrent&#x60;: Whether or not to include the current line in the search. Default to &#x60;false&#x60;.
     *
     * @class Search 
     * @constructor
     */
    constructor() {
        this.$options = {};
    }

    /**
     * Sets the search options via the &#x60;options&#x60; parameter.
     * @param {Object} options An object containing all the new search properties
     *
     * 
     * @return {Search}
     * @chainable
    **/
    set(options) {
        mixin(this.$options, options);
        return this;
    }

    /**
     * [Returns an object containing all the search options.]{: #Search.getOptions}
     * @return {Object}
    **/
    getOptions() {
        return copyObject(this.$options);
    }
    
    /**
     * Sets the search options via the &#x60;options&#x60; parameter.
     * @param {Object} An object containing all the search propertie
     * @related Search.set
    **/
    setOptions(options) {
        this.$options = options;
    }

    /**
     * Searches for &#x60;options.needle&#x60;. If found, this method returns the [[Range &#x60;Range&#x60;]] where the text first occurs. If &#x60;options.backwards&#x60; is &#x60;true&#x60;, the search goes backwards in the session.
     * @param {EditSession} session The session to search with
     *
     * 
     * @return {Range}
    **/
    find(session: EditSession): Range {
        var iterator = this.$matchIterator(session, this.$options);

        if (!iterator) {
            return void 0;
        }

        var firstRange: Range = null;
        iterator.forEach(function(range, row, offset) {
            if (!range.start) {
                var column = range.offset + (offset || 0);
                firstRange = new Range(row, column, row, column + range.length);
            } else
                firstRange = range;
            return true;
        });

        return firstRange;
    }

    /**
     * Searches for all occurances &#x60;options.needle&#x60;. If found, this method returns an array of [[Range &#x60;Range&#x60;s]] where the text first occurs. If &#x60;options.backwards&#x60; is &#x60;true&#x60;, the search goes backwards in the session.
     * @param {EditSession} session The session to search with
     *
     * 
     * @return {[Range]}
    **/
    findAll(session: EditSession): Range[] {
        var options = this.$options;
        if (!options.needle)
            return [];
        this.$assembleRegExp(options);

        var range = options.range;
        var lines = range
            ? session.getLines(range.start.row, range.end.row)
            : session.doc.getAllLines();

        var ranges: Range[] = [];
        var re = options.re;
        if (options.$isMultiLine) {
            var len = re.length;
            var maxRow = lines.length - len;
            var prevRange;
            outer: for (var row = re.offset || 0; row &lt;= maxRow; row++) {
                for (var j = 0; j &lt; len; j++)
                    if (lines[row + j].search(re[j]) == -1)
                        continue outer;

                var startLine = lines[row];
                var line = lines[row + len - 1];
                var startIndex = startLine.length - startLine.match(re[0])[0].length;
                var endIndex = line.match(re[len - 1])[0].length;

                if (prevRange &amp;&amp; prevRange.end.row === row &amp;&amp;
                    prevRange.end.column &gt; startIndex
                ) {
                    continue;
                }
                ranges.push(prevRange = new Range(
                    row, startIndex, row + len - 1, endIndex
                ));
                if (len &gt; 2)
                    row = row + len - 2;
            }
        }
        else {
            for (var i = 0; i &lt; lines.length; i++) {
                var matches = getMatchOffsets(lines[i], re);
                for (var j = 0; j &lt; matches.length; j++) {
                    var match = matches[j];
                    ranges.push(new Range(i, match.offset, i, match.offset + match.length));
                }
            }
        }

        if (range) {
            var startColumn = range.start.column;
            var endColumn = range.start.column;
            var i = 0, j = ranges.length - 1;
            while (i &lt; j &amp;&amp; ranges[i].start.column &lt; startColumn &amp;&amp; ranges[i].start.row == range.start.row)
                i++;

            while (i &lt; j &amp;&amp; ranges[j].end.column &gt; endColumn &amp;&amp; ranges[j].end.row == range.end.row)
                j--;

            ranges = ranges.slice(i, j + 1);
            for (i = 0, j = ranges.length; i &lt; j; i++) {
                ranges[i].start.row += range.start.row;
                ranges[i].end.row += range.start.row;
            }
        }

        return ranges;
    }

    /**
     * Searches for &#x60;options.needle&#x60; in &#x60;input&#x60;, and, if found, replaces it with &#x60;replacement&#x60;.
     * @param {String} input The text to search in
     * @param {String} replacement The replacing text
     * + (String): If &#x60;options.regExp&#x60; is &#x60;true&#x60;, this function returns &#x60;input&#x60; with the replacement already made. Otherwise, this function just returns &#x60;replacement&#x60;.&lt;br/&gt;
     * If &#x60;options.needle&#x60; was not found, this function returns &#x60;null&#x60;.
     *
     * 
     * @return {String}
    **/
    replace(input: string, replacement: string): string {
        var options = this.$options;

        var re = this.$assembleRegExp(options);
        if (options.$isMultiLine)
            return replacement;

        if (!re)
            return;

        var match = re.exec(input);
        if (!match || match[0].length != input.length)
            return null;

        replacement = input.replace(re, replacement);
        if (options.preserveCase) {
            var parts: string[] = replacement.split(&quot;&quot;);
            for (var i = Math.min(input.length, input.length); i--;) {
                var ch = input[i];
                if (ch &amp;&amp; ch.toLowerCase() != ch)
                    parts[i] = parts[i].toUpperCase();
                else
                    parts[i] = parts[i].toLowerCase();
            }
            replacement = parts.join(&quot;&quot;);
        }

        return replacement;
    }

    private $matchIterator(session: EditSession, options: { backwards: boolean; $isMultiLine: boolean }): any {
        var re = this.$assembleRegExp(options);
        if (!re)
            return false;

        var self = this, callback, backwards = options.backwards;

        if (options.$isMultiLine) {
            var len = re.length;
            var matchIterator = function(line, row, offset) {
                var startIndex = line.search(re[0]);
                if (startIndex == -1)
                    return;
                for (var i = 1; i &lt; len; i++) {
                    line = session.getLine(row + i);
                    if (line.search(re[i]) == -1)
                        return;
                }

                var endIndex = line.match(re[len - 1])[0].length;

                var range = new Range(row, startIndex, row + len - 1, endIndex);
                if (re.offset == 1) {
                    range.start.row--;
                    range.start.column = Number.MAX_VALUE;
                } else if (offset)
                    range.start.column += offset;

                if (callback(range))
                    return true;
            };
        }
        else if (backwards) {
            var matchIterator = function(line, row, startIndex) {
                var matches = getMatchOffsets(line, re);
                for (var i = matches.length - 1; i &gt;= 0; i--)
                    if (callback(matches[i], row, startIndex))
                        return true;
            };
        }
        else {
            var matchIterator = function(line, row, startIndex) {
                var matches = getMatchOffsets(line, re);
                for (var i = 0; i &lt; matches.length; i++)
                    if (callback(matches[i], row, startIndex))
                        return true;
            };
        }

        return {
            forEach: function(_callback) {
                callback = _callback;
                self.$lineIterator(session, options).forEach(matchIterator);
            }
        };
    }

    // FIXME: Editor needs access.
    public $assembleRegExp(options, $disableFakeMultiline?: boolean) {
        if (options.needle instanceof RegExp)
            return options.re = options.needle;

        var needle = options.needle;

        if (!options.needle)
            return options.re = false;

        if (!options.regExp)
            needle = escapeRegExp(needle);

        if (options.wholeWord)
            needle = &quot;\\b&quot; + needle + &quot;\\b&quot;;

        var modifier = options.caseSensitive ? &quot;g&quot; : &quot;gi&quot;;

        options.$isMultiLine = !$disableFakeMultiline &amp;&amp; /[\n\r]/.test(needle);
        if (options.$isMultiLine)
            return options.re = this.$assembleMultilineRegExp(needle, modifier);

        try {
            var re: any = new RegExp(needle, modifier);
        }
        catch (e) {
            re = false;
        }
        return options.re = re;
    }

    private $assembleMultilineRegExp(needle: string, modifier): RegExp[] {
        var parts = needle.replace(/\r\n|\r|\n/g, &quot;$\n^&quot;).split(&quot;\n&quot;);
        var re: RegExp[] = [];
        for (var i = 0; i &lt; parts.length; i++) {
            try {
                re.push(new RegExp(parts[i], modifier));
            }
            catch (e) {
                return void 0;
            }
        }
        if (parts[0] == &quot;&quot;) {
            re.shift();
            re[&#x27;offset&#x27;] = 1;
        }
        else {
            re[&#x27;offset&#x27;] = 0;
        }
        return re;
    }

    private $lineIterator(session: EditSession, options) {
        var backwards = options.backwards == true;
        var skipCurrent = options.skipCurrent != false;

        var range = options.range;
        var start = options.start;
        if (!start)
            start = range ? range[backwards ? &quot;end&quot; : &quot;start&quot;] : session.getSelection().getRange();

        if (start.start)
            start = start[skipCurrent != backwards ? &quot;end&quot; : &quot;start&quot;];

        var firstRow = range ? range.start.row : 0;
        var lastRow = range ? range.end.row : session.getLength() - 1;

        var forEach = backwards ? function(callback) {
            var row = start.row;

            var line = session.getLine(row).substring(0, start.column);
            if (callback(line, row))
                return;

            for (row--; row &gt;= firstRow; row--)
                if (callback(session.getLine(row), row))
                    return;

            if (options.wrap == false)
                return;

            for (row = lastRow, firstRow = start.row; row &gt;= firstRow; row--)
                if (callback(session.getLine(row), row))
                    return;
        } : function(callback) {
            var row = start.row;

            var line = session.getLine(row).substr(start.column);
            if (callback(line, row, start.column))
                return;

            for (row = row + 1; row &lt;= lastRow; row++)
                if (callback(session.getLine(row), row))
                    return;

            if (options.wrap == false)
                return;

            for (row = firstRow, lastRow = start.row; row &lt;= lastRow; row++)
                if (callback(session.getLine(row), row))
                    return;
        };

        return { forEach: forEach };
    }
}

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
