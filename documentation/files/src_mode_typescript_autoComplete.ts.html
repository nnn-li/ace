<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/mode/typescript/autoComplete.ts - deuce</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../../assets/logo.png" title="deuce"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.17</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/parserlib.css.Combinator.html">parserlib.css.Combinator</a></li>
                                <li><a href="../classes/parserlib.css.MediaFeature.html">parserlib.css.MediaFeature</a></li>
                                <li><a href="../classes/parserlib.css.MediaQuery.html">parserlib.css.MediaQuery</a></li>
                                <li><a href="../classes/parserlib.css.Parser.html">parserlib.css.Parser</a></li>
                                <li><a href="../classes/parserlib.css.PropertyName.html">parserlib.css.PropertyName</a></li>
                                <li><a href="../classes/parserlib.css.PropertyValue.html">parserlib.css.PropertyValue</a></li>
                                <li><a href="../classes/parserlib.css.PropertyValueIterator.html">parserlib.css.PropertyValueIterator</a></li>
                                <li><a href="../classes/parserlib.css.PropertyValuePart.html">parserlib.css.PropertyValuePart</a></li>
                                <li><a href="../classes/parserlib.css.Selector.html">parserlib.css.Selector</a></li>
                                <li><a href="../classes/parserlib.css.SelectorPart.html">parserlib.css.SelectorPart</a></li>
                                <li><a href="../classes/parserlib.css.SelectorSubPart.html">parserlib.css.SelectorSubPart</a></li>
                                <li><a href="../classes/parserlib.css.Specificity.html">parserlib.css.Specificity</a></li>
                                <li><a href="../classes/parserlib.css.TokenStream.html">parserlib.css.TokenStream</a></li>
                                <li><a href="../classes/parserlib.css.TokenStreamBase.html">parserlib.css.TokenStreamBase</a></li>
                                <li><a href="../classes/parserlib.util.Anchor.html">parserlib.util.Anchor</a></li>
                                <li><a href="../classes/parserlib.util.BackgroundTokenizer.html">parserlib.util.BackgroundTokenizer</a></li>
                                <li><a href="../classes/parserlib.util.CSSLint.html">parserlib.util.CSSLint</a></li>
                                <li><a href="../classes/parserlib.util.Editor.html">parserlib.util.Editor</a></li>
                                <li><a href="../classes/parserlib.util.EditorDocument.html">parserlib.util.EditorDocument</a></li>
                                <li><a href="../classes/parserlib.util.EditSession.html">parserlib.util.EditSession</a></li>
                                <li><a href="../classes/parserlib.util.EventTarget.html">parserlib.util.EventTarget</a></li>
                                <li><a href="../classes/parserlib.util.Fold.html">parserlib.util.Fold</a></li>
                                <li><a href="../classes/parserlib.util.FoldLine.html">parserlib.util.FoldLine</a></li>
                                <li><a href="../classes/parserlib.util.GutterTooltip.html">parserlib.util.GutterTooltip</a></li>
                                <li><a href="../classes/parserlib.util.HScrollBar.html">parserlib.util.HScrollBar</a></li>
                                <li><a href="../classes/parserlib.util.HtmlMode.html">parserlib.util.HtmlMode</a></li>
                                <li><a href="../classes/parserlib.util.Mode.html">parserlib.util.Mode</a></li>
                                <li><a href="../classes/.html"></a></li>
                                <li><a href="../classes/parserlib.util.Position.html">parserlib.util.Position</a></li>
                                <li><a href="../classes/parserlib.util.Range.html">parserlib.util.Range</a></li>
                                <li><a href="../classes/parserlib.util.Reporter.html">parserlib.util.Reporter</a></li>
                                <li><a href="../classes/parserlib.util.ScrollBar.html">parserlib.util.ScrollBar</a></li>
                                <li><a href="../classes/parserlib.util.Search.html">parserlib.util.Search</a></li>
                                <li><a href="../classes/parserlib.util.Selection.html">parserlib.util.Selection</a></li>
                                <li><a href="../classes/parserlib.util.StringReader.html">parserlib.util.StringReader</a></li>
                                <li><a href="../classes/parserlib.util.SyntaxError.html">parserlib.util.SyntaxError</a></li>
                                <li><a href="../classes/parserlib.util.SyntaxUnit.html">parserlib.util.SyntaxUnit</a></li>
                                <li><a href="../classes/parserlib.util.TokenIterator.html">parserlib.util.TokenIterator</a></li>
                                <li><a href="../classes/parserlib.util.Tokenizer.html">parserlib.util.Tokenizer</a></li>
                                <li><a href="../classes/parserlib.util.Tooltip.html">parserlib.util.Tooltip</a></li>
                                <li><a href="../classes/parserlib.util.TypeScriptWorker.html">parserlib.util.TypeScriptWorker</a></li>
                                <li><a href="../classes/parserlib.util.UndoManager.html">parserlib.util.UndoManager</a></li>
                                <li><a href="../classes/parserlib.util.ValidationError.html">parserlib.util.ValidationError</a></li>
                                <li><a href="../classes/parserlib.util.VirtualRenderer.html">parserlib.util.VirtualRenderer</a></li>
                                <li><a href="../classes/parserlib.util.VScrollBar.html">parserlib.util.VScrollBar</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/mode/typescript/autoComplete.ts</h1>

<div class="file">
    <pre class="code prettyprint linenums">
declare var $: any;

import Position from &#x27;../../Position&#x27;;
import HashHandler from &#x27;../../keyboard/HashHandler&#x27;;
import EventEmitterClass from &#x27;../../lib/event_emitter&#x27;;
import Editor from &#x27;../../Editor&#x27;;
import CompletionService from &#x27;./CompletionService&#x27;;
import AutoCompleteView from &#x27;../../mode/typescript/AutoCompleteView&#x27;;
//import popup = require(&#x27;../../autocomplete/popup&#x27;);

/**
 * Makes a function that can be used to compare completion entries for sorting purposes.
 */
function makeCompareFn(text: string) {
    return function(a: ts.CompletionEntry, b: ts.CompletionEntry) {
        var matchFunc = function(entry: ts.CompletionEntry): number {
            return entry.name.indexOf(text) === 0 ? 1 : 0;
        };
        var matchCompare = function(): number {
            return matchFunc(b) - matchFunc(a);
        };
        var textCompare = function(): number {
            if (a.name === b.name) {
                return 0;
            }
            else {
                return (a.name &gt; b.name) ? 1 : -1;
            }
        };
        var ret = matchCompare();
        return (ret !== 0) ? ret : textCompare();
    };
}

/**
 * Using the functional constructor pattern here because &#x27;this&#x27; is too error-prone.
 *
 * Accordingly, the function is camelCase and is not called using the &#x27;new&#x27; operator.
 */
export default function autoComplete(editor: Editor, fileNameProvider: () =&gt; string, completionService: CompletionService) {
    /**
     * Declare the return object now because the AutoCompleteView needs a reference.
     */
    var AutoComplete = function() {

    };
    var that: { activate: () =&gt; void; deactivate: () =&gt; void; isActive: () =&gt; boolean } = new AutoComplete();
    that.isActive = isActive;
    that.activate = activate;
    that.deactivate = deactivate;

    /**
     *
     */
    var _eventEmitter = new EventEmitterClass();

    /**
     *
     */
    var _active: boolean = false;

    /**
     *
     */
    var _handler: any = new HashHandler();

    /**
     *
     */
    var _view = new AutoCompleteView(editor, that);
    // var _view = new popup.ListViewPopup(document.body || document.documentElement);

    /**
     *
     */
    var _inputText = &#x27;&#x27;;

    _handler.attach = function() {

        editor.on(&quot;change&quot;, onEditorChange);

        _eventEmitter._emit(&quot;attach&quot;, { &#x27;sender&#x27;: that });
        _active = true;
    };

    _handler.detach = function() {
        editor.off(&quot;change&quot;, onEditorChange);
        _view.hide();
        _eventEmitter._emit(&quot;detach&quot;, { &#x27;sender&#x27;: that });
        _active = false;
    };

    _handler.handleKeyboard = function(data, hashId, key, keyCode) {

        if (hashId == -1) {
            if (&quot; -=,[]_/()!&#x27;;:&lt;&gt;&quot;.indexOf(key) != -1) {
                deactivate();
            }
            return null;
        }

        var command = _handler.findKeyCommand(hashId, key);

        if (!command) {

            var defaultCommand = editor.commands.findKeyCommand(hashId, key);
            if (defaultCommand) {
                if (defaultCommand.name == &quot;backspace&quot;) {
                    return null;
                }
                deactivate();
            }
            return null;
        }

        if (typeof command !== &quot;string&quot;) {
            var args = command.args;
            command = command.command;
        }

        if (typeof command === &quot;string&quot;) {
            command = this.commands[command];
        }

        return { &#x27;command&#x27;: command, &#x27;args&#x27;: args };

    };

    _handler.bindKeys({ &quot;Up|Ctrl-p&quot;: &quot;moveprev&quot;, &quot;Down|Ctrl-n&quot;: &quot;movenext&quot;, &quot;esc|Ctrl-g&quot;: &quot;cancel&quot;, &quot;Return|Tab&quot;: &quot;insert&quot; });

    _handler.addCommands({
        movenext: function(editor) { _view.focusNext(); },
        moveprev: function(editor) { _view.focusPrev(); },
        cancel: function(editor) { deactivate(); },
        insert: function(editor: Editor) {
            editor.off(&quot;change&quot;, onEditorChange);

            for (var i = 0; i &lt; _inputText.length; i++) {
                editor.remove(&quot;left&quot;);
            }

            // TODO: This is where the insertion happens.
            var curr = _view.current();
            if (curr) {
                editor.insert($(curr).data(&quot;name&quot;));
            }
            deactivate();
        }
    });

    function isActive(): boolean {
        return _active;
    }

    /**
     * Returns the number of completions asynchronously in the callback with the side effect of showing the completions.
     */
    function activateUsingCursor(cursor: Position) {
        completionService.getCompletionsAtCursor(fileNameProvider(), cursor, function(err, completionInfo: ts.CompletionInfo) {
            if (!err) {
                // FIXME: The matchText should not be visisble, or rather part of the callback.
                var text = completionService.matchText;

                _inputText = text;

                var completions = completionInfo ? completionInfo.entries : null;

                if (completions &amp;&amp; _inputText.length &gt; 0) {
                    completions = completions.filter(function(elm) {
                        return elm.name.toLowerCase().indexOf(_inputText.toLowerCase()) === 0;
                    });
                }

                completions = completions ? completions.sort(makeCompareFn(_inputText)) : completions;

                showCompletions(completions);

                var count = completions ? completions.length : 0;
                if (count &gt; 0) {
                    editor.keyBinding.addKeyboardHandler(_handler);
                }
            }
            function showCompletions(infos: ts.CompletionEntry[]) {
                // FIXME: The &#x27;view&#x27; does not seem to be very well encapsulated here.
                if (infos &amp;&amp; infos.length &gt; 0) {
                    editor.container.appendChild(_view.wrap);
                    var html = &#x27;&#x27;;
                    for (var n in infos) {
                        // {name, kind, kindModifiers}
                        var info = infos[n];
                        var name = &#x27;&lt;span class=&quot;label-name&quot;&gt;&#x27; + info.name + &#x27;&lt;/span&gt;&#x27;;
                        var kind = &#x27;&lt;span class=&quot;label-kind label-kind-&#x27; + info.kind + &#x27;&quot;&gt;&#x27; + info.kind.charAt(0) + &#x27;&lt;/span&gt;&#x27;;

                        html += &#x27;&lt;li data-name=&quot;&#x27; + info.name + &#x27;&quot;&gt;&#x27; + kind + name + &#x27;&lt;/li&gt;&#x27;;
                    }
                    //                  _view.setData();
                    var coords: { pageX: number; pageY: number } = editor.renderer.textToScreenCoordinates(cursor.row, cursor.column - text.length);
                    var lineHeight = 9;
                    var topdownOnly = false;
                    _view.show(coords/*, lineHeight, topdownOnly*/);
                    _view.listElement.innerHTML = html;
                    _view.ensureFocus();
                }
                else {
                    _view.hide();
                }
            }
        });

    }

    /**
     * Listens for changes in the editor and maybe shows the completions.
     */
    function onEditorChange(event: { data: { action: string; text: string } }): void {
        var cursor = editor.getCursorPosition();
        if (event.data.action == &quot;insertText&quot;) {
            activateUsingCursor({ row: cursor.row, column: cursor.column + 1 });
        }
        else if (event.data.action == &quot;removeText&quot;) {
            if (event.data.text == &#x27;\n&#x27;) {
                deactivate();
            }
            else {
                activateUsingCursor(cursor);
            }
        }
        else {
            activateUsingCursor(cursor);
        }
    }

    function activate(): void {
        activateUsingCursor(editor.getCursorPosition());
    }

    function deactivate() {
        editor.keyBinding.removeKeyboardHandler(_handler);
    }

    return that;
}
    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
