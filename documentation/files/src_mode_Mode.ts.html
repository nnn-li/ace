<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/mode/Mode.ts - deuce</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../../assets/logo.png" title="deuce"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.17</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/parserlib.css.Combinator.html">parserlib.css.Combinator</a></li>
                                <li><a href="../classes/parserlib.css.MediaFeature.html">parserlib.css.MediaFeature</a></li>
                                <li><a href="../classes/parserlib.css.MediaQuery.html">parserlib.css.MediaQuery</a></li>
                                <li><a href="../classes/parserlib.css.Parser.html">parserlib.css.Parser</a></li>
                                <li><a href="../classes/parserlib.css.PropertyName.html">parserlib.css.PropertyName</a></li>
                                <li><a href="../classes/parserlib.css.PropertyValue.html">parserlib.css.PropertyValue</a></li>
                                <li><a href="../classes/parserlib.css.PropertyValueIterator.html">parserlib.css.PropertyValueIterator</a></li>
                                <li><a href="../classes/parserlib.css.PropertyValuePart.html">parserlib.css.PropertyValuePart</a></li>
                                <li><a href="../classes/parserlib.css.Selector.html">parserlib.css.Selector</a></li>
                                <li><a href="../classes/parserlib.css.SelectorPart.html">parserlib.css.SelectorPart</a></li>
                                <li><a href="../classes/parserlib.css.SelectorSubPart.html">parserlib.css.SelectorSubPart</a></li>
                                <li><a href="../classes/parserlib.css.Specificity.html">parserlib.css.Specificity</a></li>
                                <li><a href="../classes/parserlib.css.TokenStream.html">parserlib.css.TokenStream</a></li>
                                <li><a href="../classes/parserlib.css.TokenStreamBase.html">parserlib.css.TokenStreamBase</a></li>
                                <li><a href="../classes/parserlib.util.Anchor.html">parserlib.util.Anchor</a></li>
                                <li><a href="../classes/parserlib.util.BackgroundTokenizer.html">parserlib.util.BackgroundTokenizer</a></li>
                                <li><a href="../classes/parserlib.util.CSSLint.html">parserlib.util.CSSLint</a></li>
                                <li><a href="../classes/parserlib.util.Editor.html">parserlib.util.Editor</a></li>
                                <li><a href="../classes/parserlib.util.EditorDocument.html">parserlib.util.EditorDocument</a></li>
                                <li><a href="../classes/parserlib.util.EditSession.html">parserlib.util.EditSession</a></li>
                                <li><a href="../classes/parserlib.util.EventTarget.html">parserlib.util.EventTarget</a></li>
                                <li><a href="../classes/parserlib.util.Fold.html">parserlib.util.Fold</a></li>
                                <li><a href="../classes/parserlib.util.FoldLine.html">parserlib.util.FoldLine</a></li>
                                <li><a href="../classes/parserlib.util.GutterTooltip.html">parserlib.util.GutterTooltip</a></li>
                                <li><a href="../classes/parserlib.util.HScrollBar.html">parserlib.util.HScrollBar</a></li>
                                <li><a href="../classes/parserlib.util.HtmlMode.html">parserlib.util.HtmlMode</a></li>
                                <li><a href="../classes/parserlib.util.Mode.html">parserlib.util.Mode</a></li>
                                <li><a href="../classes/.html"></a></li>
                                <li><a href="../classes/parserlib.util.Position.html">parserlib.util.Position</a></li>
                                <li><a href="../classes/parserlib.util.Range.html">parserlib.util.Range</a></li>
                                <li><a href="../classes/parserlib.util.Reporter.html">parserlib.util.Reporter</a></li>
                                <li><a href="../classes/parserlib.util.ScrollBar.html">parserlib.util.ScrollBar</a></li>
                                <li><a href="../classes/parserlib.util.Search.html">parserlib.util.Search</a></li>
                                <li><a href="../classes/parserlib.util.Selection.html">parserlib.util.Selection</a></li>
                                <li><a href="../classes/parserlib.util.StringReader.html">parserlib.util.StringReader</a></li>
                                <li><a href="../classes/parserlib.util.SyntaxError.html">parserlib.util.SyntaxError</a></li>
                                <li><a href="../classes/parserlib.util.SyntaxUnit.html">parserlib.util.SyntaxUnit</a></li>
                                <li><a href="../classes/parserlib.util.TokenIterator.html">parserlib.util.TokenIterator</a></li>
                                <li><a href="../classes/parserlib.util.Tokenizer.html">parserlib.util.Tokenizer</a></li>
                                <li><a href="../classes/parserlib.util.Tooltip.html">parserlib.util.Tooltip</a></li>
                                <li><a href="../classes/parserlib.util.TypeScriptWorker.html">parserlib.util.TypeScriptWorker</a></li>
                                <li><a href="../classes/parserlib.util.UndoManager.html">parserlib.util.UndoManager</a></li>
                                <li><a href="../classes/parserlib.util.ValidationError.html">parserlib.util.ValidationError</a></li>
                                <li><a href="../classes/parserlib.util.VirtualRenderer.html">parserlib.util.VirtualRenderer</a></li>
                                <li><a href="../classes/parserlib.util.VScrollBar.html">parserlib.util.VScrollBar</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/mode/Mode.ts</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/* ***** BEGIN LICENSE BLOCK *****
 * Distributed under the BSD license:
 *
 * Copyright (c) 2010, Ajax.org B.V.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above copyright
 *       notice, this list of conditions and the following disclaimer in the
 *       documentation and/or other materials provided with the distribution.
 *     * Neither the name of Ajax.org B.V. nor the
 *       names of its contributors may be used to endorse or promote products
 *       derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL AJAX.ORG B.V. BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * ***** END LICENSE BLOCK ***** */

// FIXME: For some reason the generated file causes a breakage in the mouse/mouse_handler_test
import Tokenizer from &quot;../Tokenizer&quot;;
import TextHighlightRules from &quot;./TextHighlightRules&quot;;
import Behaviour from &quot;./Behaviour&quot;;
import {packages} from &quot;../unicode&quot;;
import {escapeRegExp} from &quot;../lib/lang&quot;;
import TokenIterator from &quot;../TokenIterator&quot;;
import Range from &quot;../Range&quot;;
import EditSession from &#x27;../EditSession&#x27;;
import Editor from &#x27;../Editor&#x27;;
import WorkerClient from &quot;../worker/WorkerClient&quot;;

/**
 * @class Mode
 */
export default class Mode {
    /**
     * Used when loading snippets for zero or more modes?
     */
    public modes: Mode[];
    protected HighlightRules: any = TextHighlightRules;
    protected $behaviour = new Behaviour();
    public tokenRe = new RegExp(&quot;^[&quot;
        + packages.L
        + packages.Mn + packages.Mc
        + packages.Nd
        + packages.Pc + &quot;\\$_]+&quot;, &quot;g&quot;
    );

    public nonTokenRe = new RegExp(&quot;^(?:[^&quot;
        + packages.L
        + packages.Mn + packages.Mc
        + packages.Nd
        + packages.Pc + &quot;\\$_]|\\s])+&quot;, &quot;g&quot;
    );

    protected lineCommentStart: any = &quot;&quot;;
    protected blockComment: any = &quot;&quot;;
    public $id = &quot;ace/mode/text&quot;;
    private $tokenizer: Tokenizer;
    private $highlightRules: any;
    private $keywordList;
    private $embeds;
    private $modes;
    private completionKeywords;
    public $indentWithTabs: boolean;
    public foldingRules;
    public getMatching: (session: EditSession) =&gt; Range;

    constructor() {
    }

    getTokenizer(): Tokenizer {
        if (!this.$tokenizer) {
            this.$highlightRules = this.$highlightRules || new this.HighlightRules();
            this.$tokenizer = new Tokenizer(this.$highlightRules.getRules());
        }
        return this.$tokenizer;
    }

    toggleCommentLines(state, session: EditSession, startRow: number, endRow: number) {
        var doc = session.doc;

        var ignoreBlankLines = true;
        var shouldRemove = true;
        var minIndent = Infinity;
        var tabSize = session.getTabSize();
        var insertAtTabStop = false;

        if (!this.lineCommentStart) {
            if (!this.blockComment)
                return false;
            var lineCommentStart = this.blockComment.start;
            var lineCommentEnd = this.blockComment.end;
            var regexpStart = new RegExp(&quot;^(\\s*)(?:&quot; + escapeRegExp(lineCommentStart) + &quot;)&quot;);
            var regexpEnd = new RegExp(&quot;(?:&quot; + escapeRegExp(lineCommentEnd) + &quot;)\\s*$&quot;);

            var comment = function(line: string, i: number) {
                if (testRemove(line, i))
                    return;
                if (!ignoreBlankLines || /\S/.test(line)) {
                    doc.insertInLine({ row: i, column: line.length }, lineCommentEnd);
                    doc.insertInLine({ row: i, column: minIndent }, lineCommentStart);
                }
            };

            var uncomment = function(line: string, i: number) {
                var m;
                if (m = line.match(regexpEnd))
                    doc.removeInLine(i, line.length - m[0].length, line.length);
                if (m = line.match(regexpStart))
                    doc.removeInLine(i, m[1].length, m[0].length);
            };

            var testRemove = function(line: string, row: number) {
                if (regexpStart.test(line))
                    return true;
                var tokens = session.getTokens(row);
                for (var i = 0; i &lt; tokens.length; i++) {
                    if (tokens[i].type === &#x27;comment&#x27;)
                        return true;
                }
            };
        }
        else {
            if (Array.isArray(this.lineCommentStart)) {
                var regexpStartString: string = this.lineCommentStart.map(escapeRegExp).join(&quot;|&quot;);
                var lineCommentStart = this.lineCommentStart[0];
            }
            else {
                var regexpStartString: string = escapeRegExp(this.lineCommentStart);
                var lineCommentStart = this.lineCommentStart;
            }
            regexpStart = new RegExp(&quot;^(\\s*)(?:&quot; + regexpStartString + &quot;) ?&quot;);

            insertAtTabStop = session.getUseSoftTabs();

            var uncomment = function(line: string, i: number) {
                var m = line.match(regexpStart);
                if (!m) return;
                var start = m[1].length, end = m[0].length;
                if (!shouldInsertSpace(line, start, end) &amp;&amp; m[0][end - 1] == &quot; &quot;)
                    end--;
                doc.removeInLine(i, start, end);
            };
            var commentWithSpace = lineCommentStart + &quot; &quot;;
            var comment = function(line: string, i: number) {
                if (!ignoreBlankLines || /\S/.test(line)) {
                    if (shouldInsertSpace(line, minIndent, minIndent))
                        doc.insertInLine({ row: i, column: minIndent }, commentWithSpace);
                    else
                        doc.insertInLine({ row: i, column: minIndent }, lineCommentStart);
                }
            };
            var testRemove = function(line: string, i: number) {
                return regexpStart.test(line);
            };

            var shouldInsertSpace = function(line: string, before: number, after: number) {
                var spaces = 0;
                while (before-- &amp;&amp; line.charAt(before) == &quot; &quot;)
                    spaces++;
                if (spaces % tabSize != 0)
                    return false;
                var spaces = 0;
                while (line.charAt(after++) == &quot; &quot;)
                    spaces++;
                if (tabSize &gt; 2)
                    return spaces % tabSize != tabSize - 1;
                else
                    return spaces % tabSize == 0;
                return true;
            };
        }

        function iter(fun) {
            for (var i = startRow; i &lt;= endRow; i++)
                fun(doc.getLine(i), i);
        }


        var minEmptyLength = Infinity;
        iter(function(line: string, row: number) {
            var indent = line.search(/\S/);
            if (indent !== -1) {
                if (indent &lt; minIndent)
                    minIndent = indent;
                if (shouldRemove &amp;&amp; !testRemove(line, row))
                    shouldRemove = false;
            } else if (minEmptyLength &gt; line.length) {
                minEmptyLength = line.length;
            }
        });

        if (minIndent == Infinity) {
            minIndent = minEmptyLength;
            ignoreBlankLines = false;
            shouldRemove = false;
        }

        if (insertAtTabStop &amp;&amp; minIndent % tabSize != 0)
            minIndent = Math.floor(minIndent / tabSize) * tabSize;

        iter(shouldRemove ? uncomment : comment);
    }

    toggleBlockComment(state, session: EditSession, range: Range, cursor: { row: number; column: number }) {
        var comment = this.blockComment;
        if (!comment)
            return;
        if (!comment.start &amp;&amp; comment[0])
            comment = comment[0];

        var iterator = new TokenIterator(session, cursor.row, cursor.column);
        var token = iterator.getCurrentToken();

        var selection = session.getSelection();
        var initialRange = selection.toOrientedRange();
        var startRow, colDiff;

        if (token &amp;&amp; /comment/.test(token.type)) {
            var startRange, endRange;
            while (token &amp;&amp; /comment/.test(token.type)) {
                var i = token.value.indexOf(comment.start);
                if (i != -1) {
                    var row = iterator.getCurrentTokenRow();
                    var column = iterator.getCurrentTokenColumn() + i;
                    startRange = new Range(row, column, row, column + comment.start.length);
                    break;
                }
                token = iterator.stepBackward();
            }

            var iterator = new TokenIterator(session, cursor.row, cursor.column);
            var token = iterator.getCurrentToken();
            while (token &amp;&amp; /comment/.test(token.type)) {
                var i = token.value.indexOf(comment.end);
                if (i != -1) {
                    var row = iterator.getCurrentTokenRow();
                    var column = iterator.getCurrentTokenColumn() + i;
                    endRange = new Range(row, column, row, column + comment.end.length);
                    break;
                }
                token = iterator.stepForward();
            }
            if (endRange)
                session.remove(endRange);
            if (startRange) {
                session.remove(startRange);
                startRow = startRange.start.row;
                colDiff = -comment.start.length;
            }
        } else {
            colDiff = comment.start.length;
            startRow = range.start.row;
            session.insert(range.end, comment.end);
            session.insert(range.start, comment.start);
        }
        // todo: selection should have ended up in the right place automatically!
        if (initialRange.start.row == startRow)
            initialRange.start.column += colDiff;
        if (initialRange.end.row == startRow)
            initialRange.end.column += colDiff;
        session.getSelection().fromOrientedRange(initialRange);
    }

    getNextLineIndent(state: string, line: string, tab: string): string {
        return this.$getIndent(line);
    }

    checkOutdent(state: string, line: string, text: string): boolean {
        return false;
    }

    autoOutdent(state: string, session: EditSession, row: number): number {
        return 0;
    }

    $getIndent(line: string): string {
        return line.match(/^\s*/)[0];
    }

    createWorker(session: EditSession): WorkerClient {
        return null;
    }

    createModeDelegates(mapping) {
        this.$embeds = [];
        this.$modes = {};
        for (var p in mapping) {
            if (mapping[p]) {
                this.$embeds.push(p);
                this.$modes[p] = new mapping[p]();
            }
        }

        var delegations = [&#x27;toggleBlockComment&#x27;, &#x27;toggleCommentLines&#x27;, &#x27;getNextLineIndent&#x27;,
            &#x27;checkOutdent&#x27;, &#x27;autoOutdent&#x27;, &#x27;transformAction&#x27;, &#x27;getCompletions&#x27;];

        for (var k = 0; k &lt; delegations.length; k++) {
            (function(scope) {
                var functionName = delegations[k];
                var defaultHandler = scope[functionName];
                scope[delegations[k]] = function() {
                    return this.$delegator(functionName, arguments, defaultHandler);
                };
            } (this));
        }
    }

    $delegator(method, args, defaultHandler) {
        var state = args[0];
        if (typeof state != &quot;string&quot;)
            state = state[0];
        for (var i = 0; i &lt; this.$embeds.length; i++) {
            if (!this.$modes[this.$embeds[i]]) continue;

            var split = state.split(this.$embeds[i]);
            if (!split[0] &amp;&amp; split[1]) {
                args[0] = split[1];
                var mode = this.$modes[this.$embeds[i]];
                return mode[method].apply(mode, args);
            }
        }
        var ret = defaultHandler.apply(this, args);
        return defaultHandler ? ret : undefined;
    }

    transformAction(state, action, editor: Editor, session: EditSession, param) {
        if (this.$behaviour) {
            var behaviours = this.$behaviour.getBehaviours();
            for (var key in behaviours) {
                if (behaviours[key][action]) {
                    var ret = behaviours[key][action].apply(this, arguments);
                    if (ret) {
                        return ret;
                    }
                }
            }
        }
    }

    getKeywords(append: boolean) {
        // this is for autocompletion to pick up regexp&#x27;ed keywords
        if (!this.completionKeywords) {

            var rules = this.$tokenizer.states;
            var completionKeywords: string[] = [];
            for (var rule in rules) {
                var ruleItr = rules[rule];
                for (var r = 0, l = ruleItr.length; r &lt; l; r++) {
                    if (typeof ruleItr[r].token === &quot;string&quot;) {
                        if (/keyword|support|storage/.test(ruleItr[r].token))
                            completionKeywords.push(ruleItr[r].regex);
                    }
                    else if (typeof ruleItr[r].token === &quot;object&quot;) {
                        for (var a = 0, aLength = ruleItr[r].token.length; a &lt; aLength; a++) {
                            if (/keyword|support|storage/.test(ruleItr[r].token[a])) {
                                // drop surrounding parens
                                var rule = ruleItr[r].regex.match(/\(.+?\)/g)[a];
                                completionKeywords.push(rule.substr(1, rule.length - 2));
                            }
                        }
                    }
                }
            }
            this.completionKeywords = completionKeywords;
        }
        // this is for highlighting embed rules, like HAML/Ruby or Obj-C/C
        if (!append) {
            return this.$keywordList;
        }
        return completionKeywords.concat(this.$keywordList || []);
    }

    $createKeywordList() {
        if (!this.$highlightRules)
            this.getTokenizer();
        return this.$keywordList = this.$highlightRules.$keywordList || [];
    }

    getCompletions(state, session: EditSession, pos, prefix) {
        var keywords = this.$keywordList || this.$createKeywordList();
        return keywords.map(function(word) {
            return {
                name: word,
                value: word,
                score: 0,
                meta: &quot;keyword&quot;
            };
        });
    }
}

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
