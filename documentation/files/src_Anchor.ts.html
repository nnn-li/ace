<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src/Anchor.ts - deuce</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="icon" href="../assets/favicon.ico">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
                <h1><img src="../../assets/logo.png" title="deuce"></h1>
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.15</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
                    <h2 class="off-left">APIs</h2>
                    <div id="api-tabview" class="tabview">
                        <ul class="tabs">
                            <li><a href="#api-classes">Classes</a></li>
                            <li><a href="#api-modules">Modules</a></li>
                        </ul>
                
                        <div id="api-tabview-filter">
                            <input type="search" id="api-filter" placeholder="Type to filter APIs">
                        </div>
                
                        <div id="api-tabview-panel">
                            <ul id="api-classes" class="apis classes">
                                <li><a href="../classes/Anchor.html">Anchor</a></li>
                                <li><a href="../classes/BackgroundTokenizer.html">BackgroundTokenizer</a></li>
                                <li><a href="../classes/Editor.html">Editor</a></li>
                                <li><a href="../classes/EditorDocument.html">EditorDocument</a></li>
                                <li><a href="../classes/EditSession.html">EditSession</a></li>
                                <li><a href="../classes/Fold.html">Fold</a></li>
                                <li><a href="../classes/FoldLine.html">FoldLine</a></li>
                                <li><a href="../classes/GutterTooltip.html">GutterTooltip</a></li>
                                <li><a href="../classes/HScrollBar.html">HScrollBar</a></li>
                                <li><a href="../classes/HtmlMode.html">HtmlMode</a></li>
                                <li><a href="../classes/.html"></a></li>
                                <li><a href="../classes/Mode.html">Mode</a></li>
                                <li><a href="../classes/Position.html">Position</a></li>
                                <li><a href="../classes/Range.html">Range</a></li>
                                <li><a href="../classes/ScrollBar.html">ScrollBar</a></li>
                                <li><a href="../classes/Search.html">Search</a></li>
                                <li><a href="../classes/Selection.html">Selection</a></li>
                                <li><a href="../classes/TokenIterator.html">TokenIterator</a></li>
                                <li><a href="../classes/Tokenizer.html">Tokenizer</a></li>
                                <li><a href="../classes/Tooltip.html">Tooltip</a></li>
                                <li><a href="../classes/UndoManager.html">UndoManager</a></li>
                                <li><a href="../classes/VirtualRenderer.html">VirtualRenderer</a></li>
                                <li><a href="../classes/VScrollBar.html">VScrollBar</a></li>
                            </ul>
                
                
                            <ul id="api-modules" class="apis modules">
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
                    Show:
                    <label for="api-show-inherited">
                        <input type="checkbox" id="api-show-inherited" checked>
                        Inherited
                    </label>
            
                    <label for="api-show-protected">
                        <input type="checkbox" id="api-show-protected">
                        Protected
                    </label>
            
                    <label for="api-show-private">
                        <input type="checkbox" id="api-show-private">
                        Private
                    </label>
                    <label for="api-show-deprecated">
                        <input type="checkbox" id="api-show-deprecated">
                        Deprecated
                    </label>
            
                </div>
            
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
<h1 class="file-heading">File: src/Anchor.ts</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/* ***** BEGIN LICENSE BLOCK *****
 * Distributed under the BSD license:
 *
 * Copyright (c) 2010, Ajax.org B.V.
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above copyright
 *       notice, this list of conditions and the following disclaimer in the
 *       documentation and/or other materials provided with the distribution.
 *     * Neither the name of Ajax.org B.V. nor the
 *       names of its contributors may be used to endorse or promote products
 *       derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS &quot;AS IS&quot; AND
 * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED
 * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL AJAX.ORG B.V. BE LIABLE FOR ANY
 * DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES
 * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;
 * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND
 * ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
 * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 * ***** END LICENSE BLOCK ***** */
import EditorDocument from &quot;./EditorDocument&quot;;
import Range from &quot;./Range&quot;;
import EventEmitterClass from &#x27;./lib/event_emitter&#x27;;
import { assert } from &#x27;./lib/asserts&#x27;;

/**
 * Defines the floating pointer in the document. Whenever text is inserted or deleted before the cursor, the position of the cursor is updated.
 * @class Anchor
 * @extends EventEmitterClass
 */
export default class Anchor extends EventEmitterClass {

    /**
     * @property row
     * @type number
     */
    public row: number;

    /**
     * @property column
     * @type number
     */
    public column: number;

    /**
     * @property document
     * @type {EditorDocument}
     * @private
     */
    private document: EditorDocument;
    private $onChange: (event, doc: EditorDocument) =&gt; void;

    /**
     * @property $insertRight
     * @type boolean
     * @default false
     * @private
     */
    private $insertRight: boolean;

    /**
     * Creates a new &lt;code&gt;Anchor&lt;/code&gt; and associates it with a document.
     *
     * @param doc {EditorDocument} The document to associate with the anchor.
     * @param row {number} The starting row position.
     * @param column {number} The starting column position.
     *
     * @constructor
     */
    constructor(doc: EditorDocument, row: number, column: number) {
        super();
        assert(typeof row === &#x27;number&#x27;, &quot;row must be a number&quot;);
        assert(typeof column === &#x27;number&#x27;, &quot;column must be a number&quot;);
        this.$onChange = this.onChange.bind(this);
        this.attach(doc);
        this.setPosition(row, column);
        this.$insertRight = false;
    }

    /**
     * Returns an object identifying the &#x60;row&#x60; and &#x60;column&#x60; position of the current anchor.
     * @return {Object}
     **/
    getPosition() {
        return this.$clipPositionToDocument(this.row, this.column);
    }

    /**
     * Returns the current document.
     * @method getDocument
     * @return {EditorDocument}
     */
    getDocument(): EditorDocument {
        return this.document;
    }

    /**
     * Fires whenever the anchor position changes.
     *
     * Both of these objects have a &#x60;row&#x60; and &#x60;column&#x60; property corresponding to the position.
     *
     * Events that can trigger this function include [[Anchor.setPosition &#x60;setPosition()&#x60;]].
     *
     * @event change
     * @param {Object} e  An object containing information about the anchor position. It has two properties:
     *  - &#x60;old&#x60;: An object describing the old Anchor position
     *  - &#x60;value&#x60;: An object describing the new Anchor position
     *
     **/
    onChange(e: { data: { range: Range; action: string } }, doc: EditorDocument) {
        var delta = e.data;
        var range = delta.range;

        if (range.start.row == range.end.row &amp;&amp; range.start.row != this.row)
            return;

        if (range.start.row &gt; this.row)
            return;

        if (range.start.row == this.row &amp;&amp; range.start.column &gt; this.column)
            return;

        var row = this.row;
        var column = this.column;
        var start = range.start;
        var end = range.end;

        if (delta.action === &quot;insertText&quot;) {
            if (start.row === row &amp;&amp; start.column &lt;= column) {
                if (start.column === column &amp;&amp; this.$insertRight) {
                    // do nothing
                }
                else if (start.row === end.row) {
                    column += end.column - start.column;
                }
                else {
                    column -= start.column;
                    row += end.row - start.row;
                }
            }
            else if (start.row !== end.row &amp;&amp; start.row &lt; row) {
                row += end.row - start.row;
            }
        }
        else if (delta.action === &quot;insertLines&quot;) {
            if (start.row === row &amp;&amp; column === 0 &amp;&amp; this.$insertRight) {
                // do nothing
            }
            else if (start.row &lt;= row) {
                row += end.row - start.row;
            }
        }
        else if (delta.action === &quot;removeText&quot;) {
            if (start.row === row &amp;&amp; start.column &lt; column) {
                if (end.column &gt;= column)
                    column = start.column;
                else
                    column = Math.max(0, column - (end.column - start.column));

            }
            else if (start.row !== end.row &amp;&amp; start.row &lt; row) {
                if (end.row === row)
                    column = Math.max(0, column - end.column) + start.column;
                row -= (end.row - start.row);
            }
            else if (end.row === row) {
                row -= end.row - start.row;
                column = Math.max(0, column - end.column) + start.column;
            }
        }
        else if (delta.action == &quot;removeLines&quot;) {
            if (start.row &lt;= row) {
                if (end.row &lt;= row)
                    row -= end.row - start.row;
                else {
                    row = start.row;
                    column = 0;
                }
            }
        }

        this.setPosition(row, column, true);
    }

    /**
     * Sets the anchor position to the specified row and column. If &#x60;noClip&#x60; is &#x60;true&#x60;, the position is not clipped.
     * @param {Number} row The row index to move the anchor to
     * @param {Number} column The column index to move the anchor to
     * @param {Boolean} noClip Identifies if you want the position to be clipped
     **/
    setPosition(row: number, column: number, noClip?: boolean): void {
        var pos: { row: number; column: number };
        if (noClip) {
            pos = {
                row: row,
                column: column
            };
        }
        else {
            pos = this.$clipPositionToDocument(row, column);
        }

        if (this.row === pos.row &amp;&amp; this.column === pos.column) {
            return;
        }

        var old = {
            row: this.row,
            column: this.column
        };

        this.row = pos.row;
        this.column = pos.column;
        this._signal(&quot;change&quot;, {
            old: old,
            value: pos
        });
    }

    /**
     * When called, the &#x60;&#x27;change&#x27;&#x60; event listener is removed.
     *
     **/
    detach(): void {
        this.document.off(&quot;change&quot;, this.$onChange);
    }

    attach(doc: EditorDocument): void {
        this.document = doc || this.document;
        this.document.on(&quot;change&quot;, this.$onChange);
    }

    /**
     * Clips the anchor position to the specified row and column.
     * @param {Number} row The row index to clip the anchor to
     * @param {Number} column The column index to clip the anchor to
     *
     **/
    $clipPositionToDocument(row: number, column: number): { row: number; column: number } {
        var pos: { row: number; column: number } = { row: 0, column: 0 };

        if (row &gt;= this.document.getLength()) {
            pos.row = Math.max(0, this.document.getLength() - 1);
            pos.column = this.document.getLine(pos.row).length;
        }
        else if (row &lt; 0) {
            pos.row = 0;
            pos.column = 0;
        }
        else {
            pos.row = row;
            pos.column = Math.min(this.document.getLine(pos.row).length, Math.max(0, column));
        }

        if (column &lt; 0)
            pos.column = 0;

        return pos;
    }
}

    </pre>
</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
