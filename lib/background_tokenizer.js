import EventEmitterClass from "./lib/event_emitter";
export class BackgroundTokenizer extends EventEmitterClass {
    constructor(tokenizer, editor) {
        super();
        this.running = 0;
        this.lines = [];
        this.states = [];
        this.currentLine = 0;
        this.tokenizer = tokenizer;
        var self = this;
        this.$worker = function () {
            if (!self.running) {
                return;
            }
            var workerStart = new Date();
            var currentLine = self.currentLine;
            var endLine = -1;
            var doc = self.doc;
            while (self.lines[currentLine])
                currentLine++;
            var startLine = currentLine;
            var len = doc.getLength();
            var processedLines = 0;
            self.running = 0;
            while (currentLine < len) {
                self.$tokenizeRow(currentLine);
                endLine = currentLine;
                do {
                    currentLine++;
                } while (self.lines[currentLine]);
                processedLines++;
                if ((processedLines % 5 === 0) && (new Date().getTime() - workerStart.getTime()) > 20) {
                    self.running = setTimeout(self.$worker, 20);
                    break;
                }
            }
            self.currentLine = currentLine;
            if (startLine <= endLine)
                self.fireUpdateEvent(startLine, endLine);
        };
    }
    setTokenizer(tokenizer) {
        this.tokenizer = tokenizer;
        this.lines = [];
        this.states = [];
        this.start(0);
    }
    setDocument(doc) {
        this.doc = doc;
        this.lines = [];
        this.states = [];
        this.stop();
    }
    fireUpdateEvent(firstRow, lastRow) {
        var data = {
            first: firstRow,
            last: lastRow
        };
        this._signal("update", { data: data });
    }
    start(startRow) {
        this.currentLine = Math.min(startRow || 0, this.currentLine, this.doc.getLength());
        this.lines.splice(this.currentLine, this.lines.length);
        this.states.splice(this.currentLine, this.states.length);
        this.stop();
        this.running = setTimeout(this.$worker, 700);
    }
    scheduleStart() {
        if (!this.running)
            this.running = setTimeout(this.$worker, 700);
    }
    $updateOnChange(delta) {
        var range = delta.range;
        var startRow = range.start.row;
        var len = range.end.row - startRow;
        if (len === 0) {
            this.lines[startRow] = null;
        }
        else if (delta.action == "removeText" || delta.action == "removeLines") {
            this.lines.splice(startRow, len + 1, null);
            this.states.splice(startRow, len + 1, null);
        }
        else {
            var args = Array(len + 1);
            args.unshift(startRow, 1);
            this.lines.splice.apply(this.lines, args);
            this.states.splice.apply(this.states, args);
        }
        this.currentLine = Math.min(startRow, this.currentLine, this.doc.getLength());
        this.stop();
    }
    stop() {
        if (this.running) {
            clearTimeout(this.running);
        }
        this.running = 0;
    }
    getTokens(row) {
        return this.lines[row] || this.$tokenizeRow(row);
    }
    getState(row) {
        if (this.currentLine == row) {
            this.$tokenizeRow(row);
        }
        return this.states[row] || "start";
    }
    $tokenizeRow(row) {
        var line = this.doc.getLine(row);
        var state = this.states[row - 1];
        var data = this.tokenizer.getLineTokens(line, state);
        if (this.states[row] + "" !== data.state + "") {
            this.states[row] = data.state;
            this.lines[row + 1] = null;
            if (this.currentLine > row + 1)
                this.currentLine = row + 1;
        }
        else if (this.currentLine == row) {
            this.currentLine = row + 1;
        }
        return this.lines[row] = data.tokens;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFja2dyb3VuZF90b2tlbml6ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvYmFja2dyb3VuZF90b2tlbml6ZXIudHMiXSwibmFtZXMiOlsiQmFja2dyb3VuZFRva2VuaXplciIsIkJhY2tncm91bmRUb2tlbml6ZXIuY29uc3RydWN0b3IiLCJCYWNrZ3JvdW5kVG9rZW5pemVyLnNldFRva2VuaXplciIsIkJhY2tncm91bmRUb2tlbml6ZXIuc2V0RG9jdW1lbnQiLCJCYWNrZ3JvdW5kVG9rZW5pemVyLmZpcmVVcGRhdGVFdmVudCIsIkJhY2tncm91bmRUb2tlbml6ZXIuc3RhcnQiLCJCYWNrZ3JvdW5kVG9rZW5pemVyLnNjaGVkdWxlU3RhcnQiLCJCYWNrZ3JvdW5kVG9rZW5pemVyLiR1cGRhdGVPbkNoYW5nZSIsIkJhY2tncm91bmRUb2tlbml6ZXIuc3RvcCIsIkJhY2tncm91bmRUb2tlbml6ZXIuZ2V0VG9rZW5zIiwiQmFja2dyb3VuZFRva2VuaXplci5nZXRTdGF0ZSIsIkJhY2tncm91bmRUb2tlbml6ZXIuJHRva2VuaXplUm93Il0sIm1hcHBpbmdzIjoiT0ErQk8saUJBQWlCLE1BQU0scUJBQXFCO0FBa0JuRCx5Q0FBeUMsaUJBQWlCO0lBWXREQSxZQUFZQSxTQUFvQkEsRUFBRUEsTUFBT0E7UUFDckNDLE9BQU9BLENBQUNBO1FBUkpBLFlBQU9BLEdBQVdBLENBQUNBLENBQUNBO1FBQ3BCQSxVQUFLQSxHQUF1REEsRUFBRUEsQ0FBQ0E7UUFDL0RBLFdBQU1BLEdBQWFBLEVBQUVBLENBQUNBO1FBQ3RCQSxnQkFBV0EsR0FBV0EsQ0FBQ0EsQ0FBQ0E7UUFNNUJBLElBQUlBLENBQUNBLFNBQVNBLEdBQUdBLFNBQVNBLENBQUNBO1FBRTNCQSxJQUFJQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUVoQkEsSUFBSUEsQ0FBQ0EsT0FBT0EsR0FBR0E7WUFDWCxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FB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LENBQUNBO1FBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLEtBQUtBLENBQUNBLE1BQU1BLElBQUlBLFlBQVlBLElBQUlBLEtBQUtBLENBQUNBLE1BQU1BLElBQUlBLGFBQWFBLENBQUNBLENBQUNBLENBQUNBO1lBQ3ZFQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxNQUFNQSxDQUFDQSxRQUFRQSxFQUFFQSxHQUFHQSxHQUFHQSxDQUFDQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUMzQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsUUFBUUEsRUFBRUEsR0FBR0EsR0FBR0EsQ0FBQ0EsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDaERBLENBQUNBO1FBQUNBLElBQUlBLENBQUNBLENBQUNBO1lBQ0pBLElBQUlBLElBQUlBLEdBQUdBLEtBQUtBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBO1lBQzFCQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxRQUFRQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUMxQkEsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsS0FBS0EsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDMUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLEtBQUtBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO1FBQ2hEQSxDQUFDQTtRQUVEQSxJQUFJQSxDQUFDQSxXQUFXQSxHQUFHQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQSxRQUFRQSxFQUFFQSxJQUFJQSxDQUFDQSxXQUFXQSxFQUFFQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQSxTQUFTQSxFQUFFQSxDQUFDQSxDQUFDQTtRQUU5RUEsSUFBSUEsQ0FBQ0EsSUFBSUEsRUFBRUEsQ0FBQ0E7SUFDaEJBLENBQUNBO0lBTURQLElBQUlBO1FBQ0FRLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBO1lBQ2ZBLFlBQVlBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBO1FBQy9CQSxDQUFDQTtRQUNEQSxJQUFJQSxDQUFDQSxPQUFPQSxHQUFHQSxDQUFDQSxDQUFDQTtJQUNyQkEsQ0FBQ0E7SUFVRFIsU0FBU0EsQ0FBQ0EsR0FBV0E7UUFDakJTLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLEdBQUdBLENBQUNBLElBQUlBLElBQUlBLENBQUNBLFlBQVlBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO0lBQ3JEQSxDQUFDQTtJQU9EVCxRQUFRQSxDQUFDQSxHQUFXQTtRQUNoQlUsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsSUFBSUEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDMUJBLElBQUlBLENBQUNBLFlBQVlBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO1FBQzNCQSxDQUFDQTtRQUNEQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxHQUFHQSxDQUFDQSxJQUFJQSxPQUFPQSxDQUFDQTtJQUN2Q0EsQ0FBQ0E7SUFFRFYsWUFBWUEsQ0FBQ0EsR0FBV0E7UUFDcEJXLElBQUlBLElBQUlBLEdBQVdBLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLE9BQU9BLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO1FBQ3pDQSxJQUFJQSxLQUFLQSxHQUFHQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxHQUFHQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUdqQ0EsSUFBSUEsSUFBSUEsR0FBNkVBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLGFBQWFBLENBQUNBLElBQUlBLEVBQUVBLEtBQUtBLENBQVVBLENBQUNBO1FBRXhJQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFHQSxFQUFFQSxLQUFLQSxJQUFJQSxDQUFDQSxLQUFLQSxHQUFHQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUM1Q0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0E7WUFDOUJBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBO1lBQzNCQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxXQUFXQSxHQUFHQSxHQUFHQSxHQUFHQSxDQUFDQSxDQUFDQTtnQkFDM0JBLElBQUlBLENBQUNBLFdBQVdBLEdBQUdBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBO1FBQ25DQSxDQUFDQTtRQUFDQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxXQUFXQSxJQUFJQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNqQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsR0FBR0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDL0JBLENBQUNBO1FBRURBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLEdBQUdBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBO0lBQ3pDQSxDQUFDQTtBQUNMWCxDQUFDQTtBQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLyogKioqKiogQkVHSU4gTElDRU5TRSBCTE9DSyAqKioqKlxuICogRGlzdHJpYnV0ZWQgdW5kZXIgdGhlIEJTRCBsaWNlbnNlOlxuICpcbiAqIENvcHlyaWdodCAoYykgMjAxMCwgQWpheC5vcmcgQi5WLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqIFxuICogUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0XG4gKiBtb2RpZmljYXRpb24sIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMgYXJlIG1ldDpcbiAqICAgICAqIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0XG4gKiAgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuXG4gKiAgICAgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodFxuICogICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZVxuICogICAgICAgZG9jdW1lbnRhdGlvbiBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi5cbiAqICAgICAqIE5laXRoZXIgdGhlIG5hbWUgb2YgQWpheC5vcmcgQi5WLiBub3IgdGhlXG4gKiAgICAgICBuYW1lcyBvZiBpdHMgY29udHJpYnV0b3JzIG1heSBiZSB1c2VkIHRvIGVuZG9yc2Ugb3IgcHJvbW90ZSBwcm9kdWN0c1xuICogICAgICAgZGVyaXZlZCBmcm9tIHRoaXMgc29mdHdhcmUgd2l0aG91dCBzcGVjaWZpYyBwcmlvciB3cml0dGVuIHBlcm1pc3Npb24uXG4gKiBcbiAqIFRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgVEhFIENPUFlSSUdIVCBIT0xERVJTIEFORCBDT05UUklCVVRPUlMgXCJBUyBJU1wiIEFORFxuICogQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhFIElNUExJRURcbiAqIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkVcbiAqIERJU0NMQUlNRUQuIElOIE5PIEVWRU5UIFNIQUxMIEFKQVguT1JHIEIuVi4gQkUgTElBQkxFIEZPUiBBTllcbiAqIERJUkVDVCwgSU5ESVJFQ1QsIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTXG4gKiAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVM7XG4gKiBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVTSU5FU1MgSU5URVJSVVBUSU9OKSBIT1dFVkVSIENBVVNFRCBBTkRcbiAqIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QgTElBQklMSVRZLCBPUiBUT1JUXG4gKiAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRSBVU0UgT0YgVEhJU1xuICogU09GVFdBUkUsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuXG4gKlxuICogKioqKiogRU5EIExJQ0VOU0UgQkxPQ0sgKioqKiogKi9cbmltcG9ydCB7fSBmcm9tIFwiLi9saWIvb29wXCJcbmltcG9ydCBFZGl0b3JEb2N1bWVudCBmcm9tICcuL0VkaXRvckRvY3VtZW50J1xuaW1wb3J0IEV2ZW50RW1pdHRlckNsYXNzIGZyb20gXCIuL2xpYi9ldmVudF9lbWl0dGVyXCJcbmltcG9ydCBUb2tlbml6ZXIgZnJvbSAnLi9Ub2tlbml6ZXInXG5cbi8qKlxuICogVG9rZW5pemVzIHRoZSBjdXJyZW50IFtbRWRpdG9yRG9jdW1lbnQgYEVkaXRvckRvY3VtZW50YF1dIGluIHRoZSBiYWNrZ3JvdW5kLCBhbmQgY2FjaGVzIHRoZSB0b2tlbml6ZWQgcm93cyBmb3IgZnV0dXJlIHVzZS4gXG4gKiBcbiAqIElmIGEgY2VydGFpbiByb3cgaXMgY2hhbmdlZCwgZXZlcnl0aGluZyBiZWxvdyB0aGF0IHJvdyBpcyByZS10b2tlbml6ZWQuXG4gKlxuICogQGNsYXNzIEJhY2tncm91bmRUb2tlbml6ZXJcbiAqKi9cblxuLyoqXG4gKiBDcmVhdGVzIGEgbmV3IGBCYWNrZ3JvdW5kVG9rZW5pemVyYCBvYmplY3QuXG4gKiBAcGFyYW0ge1Rva2VuaXplcn0gdG9rZW5pemVyIFRoZSB0b2tlbml6ZXIgdG8gdXNlXG4gKiBAcGFyYW0ge0VkaXRvcn0gZWRpdG9yIFRoZSBlZGl0b3IgdG8gYXNzb2NpYXRlIHdpdGhcbiAqXG4gKiBAY29uc3RydWN0b3JcbiAqKi9cbmV4cG9ydCBjbGFzcyBCYWNrZ3JvdW5kVG9rZW5pemVyIGV4dGVuZHMgRXZlbnRFbWl0dGVyQ2xhc3Mge1xuICAgIC8qKlxuICAgICAqIFRoaXMgaXMgdGhlIHZhbHVlIHJldHVybmVkIGJ5IHNldFRpbWVvdXQsIHNvIGl0J3MgcmVhbGx5IGEgdGltZXIgaGFuZGxlLlxuICAgICAqIFRoZXJlIGFyZSBzb21lIGNvbmRpdGlvbmFscyBsb29raW5nIGZvciBhIGZhbHNleSB2YWx1ZSwgc28gd2UgdXNlIHplcm8gd2hlcmUgbmVlZGVkLlxuICAgICAqL1xuICAgIHByaXZhdGUgcnVubmluZzogbnVtYmVyID0gMDtcbiAgICBwcml2YXRlIGxpbmVzOiB7IHN0YXJ0OiBudW1iZXI7IHR5cGU6IHN0cmluZzsgdmFsdWU6IHN0cmluZyB9W11bXSA9IFtdO1xuICAgIHByaXZhdGUgc3RhdGVzOiBzdHJpbmdbXSA9IFtdO1xuICAgIHByaXZhdGUgY3VycmVudExpbmU6IG51bWJlciA9IDA7XG4gICAgcHJpdmF0ZSB0b2tlbml6ZXI6IFRva2VuaXplcjtcbiAgICBwcml2YXRlIGRvYzogRWRpdG9yRG9jdW1lbnQ7XG4gICAgcHJpdmF0ZSAkd29ya2VyO1xuICAgIGNvbnN0cnVjdG9yKHRva2VuaXplcjogVG9rZW5pemVyLCBlZGl0b3I/KSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMudG9rZW5pemVyID0gdG9rZW5pemVyO1xuXG4gICAgICAgIHZhciBzZWxmID0gdGhpcztcblxuICAgICAgICB0aGlzLiR3b3JrZXIgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIGlmICghc2VsZi5ydW5uaW5nKSB7IHJldHVybjsgfVxuXG4gICAgICAgICAgICB2YXIgd29ya2VyU3RhcnQgPSBuZXcgRGF0ZSgpO1xuICAgICAgICAgICAgdmFyIGN1cnJlbnRMaW5lID0gc2VsZi5jdXJyZW50TGluZTtcbiAgICAgICAgICAgIHZhciBlbmRMaW5lID0gLTE7XG4gICAgICAgICAgICB2YXIgZG9jID0gc2VsZi5kb2M7XG5cbiAgICAgICAgICAgIHdoaWxlIChzZWxmLmxpbmVzW2N1cnJlbnRMaW5lXSlcbiAgICAgICAgICAgICAgICBjdXJyZW50TGluZSsrO1xuXG4gICAgICAgICAgICB2YXIgc3RhcnRMaW5lID0gY3VycmVudExpbmU7XG5cbiAgICAgICAgICAgIHZhciBsZW4gPSBkb2MuZ2V0TGVuZ3RoKCk7XG4gICAgICAgICAgICB2YXIgcHJvY2Vzc2VkTGluZXMgPSAwO1xuICAgICAgICAgICAgc2VsZi5ydW5uaW5nID0gMDtcbiAgICAgICAgICAgIHdoaWxlIChjdXJyZW50TGluZSA8IGxlbikge1xuICAgICAgICAgICAgICAgIHNlbGYuJHRva2VuaXplUm93KGN1cnJlbnRMaW5lKTtcbiAgICAgICAgICAgICAgICBlbmRMaW5lID0gY3VycmVudExpbmU7XG4gICAgICAgICAgICAgICAgZG8ge1xuICAgICAgICAgICAgICAgICAgICBjdXJyZW50TGluZSsrO1xuICAgICAgICAgICAgICAgIH0gd2hpbGUgKHNlbGYubGluZXNbY3VycmVudExpbmVdKTtcbiAgICBcbiAgICAgICAgICAgICAgICAvLyBvbmx5IGNoZWNrIGV2ZXJ5IDUgbGluZXNcbiAgICAgICAgICAgICAgICBwcm9jZXNzZWRMaW5lcysrO1xuICAgICAgICAgICAgICAgIGlmICgocHJvY2Vzc2VkTGluZXMgJSA1ID09PSAwKSAmJiAobmV3IERhdGUoKS5nZXRUaW1lKCkgLSB3b3JrZXJTdGFydC5nZXRUaW1lKCkpID4gMjApIHtcbiAgICAgICAgICAgICAgICAgICAgc2VsZi5ydW5uaW5nID0gc2V0VGltZW91dChzZWxmLiR3b3JrZXIsIDIwKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc2VsZi5jdXJyZW50TGluZSA9IGN1cnJlbnRMaW5lO1xuXG4gICAgICAgICAgICBpZiAoc3RhcnRMaW5lIDw9IGVuZExpbmUpXG4gICAgICAgICAgICAgICAgc2VsZi5maXJlVXBkYXRlRXZlbnQoc3RhcnRMaW5lLCBlbmRMaW5lKTtcbiAgICAgICAgfTtcbiAgICB9XG4gICAgLyoqXG4gICAgICogU2V0cyBhIG5ldyB0b2tlbml6ZXIgZm9yIHRoaXMgb2JqZWN0LlxuICAgICAqXG4gICAgICogQHBhcmFtIHtUb2tlbml6ZXJ9IHRva2VuaXplciBUaGUgbmV3IHRva2VuaXplciB0byB1c2VcbiAgICAgKlxuICAgICAqKi9cbiAgICBzZXRUb2tlbml6ZXIodG9rZW5pemVyOiBUb2tlbml6ZXIpIHtcbiAgICAgICAgdGhpcy50b2tlbml6ZXIgPSB0b2tlbml6ZXI7XG4gICAgICAgIHRoaXMubGluZXMgPSBbXTtcbiAgICAgICAgdGhpcy5zdGF0ZXMgPSBbXTtcblxuICAgICAgICB0aGlzLnN0YXJ0KDApO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFNldHMgYSBuZXcgZG9jdW1lbnQgdG8gYXNzb2NpYXRlIHdpdGggdGhpcyBvYmplY3QuXG4gICAgICogQHBhcmFtIHtFZGl0b3JEb2N1bWVudH0gZG9jIFRoZSBuZXcgZG9jdW1lbnQgdG8gYXNzb2NpYXRlIHdpdGhcbiAgICAgKiovXG4gICAgc2V0RG9jdW1lbnQoZG9jOiBFZGl0b3JEb2N1bWVudCkge1xuICAgICAgICB0aGlzLmRvYyA9IGRvYztcbiAgICAgICAgdGhpcy5saW5lcyA9IFtdO1xuICAgICAgICB0aGlzLnN0YXRlcyA9IFtdO1xuXG4gICAgICAgIHRoaXMuc3RvcCgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICogRmlyZXMgd2hlbmV2ZXIgdGhlIGJhY2tncm91bmQgdG9rZW5pemllcnMgYmV0d2VlbiBhIHJhbmdlIG9mIHJvd3MgYXJlIGdvaW5nIHRvIGJlIHVwZGF0ZWQuXG4gICAgKiBcbiAgICAqIEBldmVudCB1cGRhdGVcbiAgICAqIEBwYXJhbSB7T2JqZWN0fSBlIEFuIG9iamVjdCBjb250YWluaW5nIHR3byBwcm9wZXJ0aWVzLCBgZmlyc3RgIGFuZCBgbGFzdGAsIHdoaWNoIGluZGljYXRlIHRoZSByb3dzIG9mIHRoZSByZWdpb24gYmVpbmcgdXBkYXRlZC5cbiAgICAqXG4gICAgKiovXG4gICAgLyoqXG4gICAgICogRW1pdHMgdGhlIGAndXBkYXRlJ2AgZXZlbnQuIGBmaXJzdFJvd2AgYW5kIGBsYXN0Um93YCBhcmUgdXNlZCB0byBkZWZpbmUgdGhlIGJvdW5kYXJpZXMgb2YgdGhlIHJlZ2lvbiB0byBiZSB1cGRhdGVkLlxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBmaXJzdFJvdyBUaGUgc3RhcnRpbmcgcm93IHJlZ2lvblxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBsYXN0Um93IFRoZSBmaW5hbCByb3cgcmVnaW9uXG4gICAgICpcbiAgICAgKiovXG4gICAgZmlyZVVwZGF0ZUV2ZW50KGZpcnN0Um93OiBudW1iZXIsIGxhc3RSb3c6IG51bWJlcikge1xuICAgICAgICB2YXIgZGF0YSA9IHtcbiAgICAgICAgICAgIGZpcnN0OiBmaXJzdFJvdyxcbiAgICAgICAgICAgIGxhc3Q6IGxhc3RSb3dcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5fc2lnbmFsKFwidXBkYXRlXCIsIHsgZGF0YTogZGF0YSB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdGFydHMgdG9rZW5pemluZyBhdCB0aGUgcm93IGluZGljYXRlZC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydFJvdyBUaGUgcm93IHRvIHN0YXJ0IGF0XG4gICAgICpcbiAgICAgKiovXG4gICAgc3RhcnQoc3RhcnRSb3c6IG51bWJlcikge1xuICAgICAgICB0aGlzLmN1cnJlbnRMaW5lID0gTWF0aC5taW4oc3RhcnRSb3cgfHwgMCwgdGhpcy5jdXJyZW50TGluZSwgdGhpcy5kb2MuZ2V0TGVuZ3RoKCkpO1xuXG4gICAgICAgIC8vIHJlbW92ZSBhbGwgY2FjaGVkIGl0ZW1zIGJlbG93IHRoaXMgbGluZVxuICAgICAgICB0aGlzLmxpbmVzLnNwbGljZSh0aGlzLmN1cnJlbnRMaW5lLCB0aGlzLmxpbmVzLmxlbmd0aCk7XG4gICAgICAgIHRoaXMuc3RhdGVzLnNwbGljZSh0aGlzLmN1cnJlbnRMaW5lLCB0aGlzLnN0YXRlcy5sZW5ndGgpO1xuXG4gICAgICAgIHRoaXMuc3RvcCgpO1xuICAgICAgICAvLyBwcmV0dHkgbG9uZyBkZWxheSB0byBwcmV2ZW50IHRoZSB0b2tlbml6ZXIgZnJvbSBpbnRlcmZlcmluZyB3aXRoIHRoZSB1c2VyXG4gICAgICAgIHRoaXMucnVubmluZyA9IHNldFRpbWVvdXQodGhpcy4kd29ya2VyLCA3MDApO1xuICAgIH1cblxuICAgIHNjaGVkdWxlU3RhcnQoKSB7XG4gICAgICAgIGlmICghdGhpcy5ydW5uaW5nKVxuICAgICAgICAgICAgdGhpcy5ydW5uaW5nID0gc2V0VGltZW91dCh0aGlzLiR3b3JrZXIsIDcwMCk7XG4gICAgfVxuXG4gICAgJHVwZGF0ZU9uQ2hhbmdlKGRlbHRhOiB7IHJhbmdlOiB7IHN0YXJ0OiB7IHJvdyB9OyBlbmQ6IHsgcm93IH0gfTsgYWN0aW9uOiBzdHJpbmcgfSkge1xuICAgICAgICB2YXIgcmFuZ2UgPSBkZWx0YS5yYW5nZTtcbiAgICAgICAgdmFyIHN0YXJ0Um93ID0gcmFuZ2Uuc3RhcnQucm93O1xuICAgICAgICB2YXIgbGVuID0gcmFuZ2UuZW5kLnJvdyAtIHN0YXJ0Um93O1xuXG4gICAgICAgIGlmIChsZW4gPT09IDApIHtcbiAgICAgICAgICAgIHRoaXMubGluZXNbc3RhcnRSb3ddID0gbnVsbDtcbiAgICAgICAgfSBlbHNlIGlmIChkZWx0YS5hY3Rpb24gPT0gXCJyZW1vdmVUZXh0XCIgfHwgZGVsdGEuYWN0aW9uID09IFwicmVtb3ZlTGluZXNcIikge1xuICAgICAgICAgICAgdGhpcy5saW5lcy5zcGxpY2Uoc3RhcnRSb3csIGxlbiArIDEsIG51bGwpO1xuICAgICAgICAgICAgdGhpcy5zdGF0ZXMuc3BsaWNlKHN0YXJ0Um93LCBsZW4gKyAxLCBudWxsKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkobGVuICsgMSk7XG4gICAgICAgICAgICBhcmdzLnVuc2hpZnQoc3RhcnRSb3csIDEpO1xuICAgICAgICAgICAgdGhpcy5saW5lcy5zcGxpY2UuYXBwbHkodGhpcy5saW5lcywgYXJncyk7XG4gICAgICAgICAgICB0aGlzLnN0YXRlcy5zcGxpY2UuYXBwbHkodGhpcy5zdGF0ZXMsIGFyZ3MpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5jdXJyZW50TGluZSA9IE1hdGgubWluKHN0YXJ0Um93LCB0aGlzLmN1cnJlbnRMaW5lLCB0aGlzLmRvYy5nZXRMZW5ndGgoKSk7XG5cbiAgICAgICAgdGhpcy5zdG9wKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RvcHMgdG9rZW5pemluZy5cbiAgICAgKlxuICAgICAqKi9cbiAgICBzdG9wKCkge1xuICAgICAgICBpZiAodGhpcy5ydW5uaW5nKSB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5ydW5uaW5nKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnJ1bm5pbmcgPSAwO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdpdmVzIGxpc3Qgb2YgdG9rZW5zIG9mIHRoZSByb3cuICh0b2tlbnMgYXJlIGNhY2hlZClcbiAgICAgKiBcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gcm93IFRoZSByb3cgdG8gZ2V0IHRva2VucyBhdFxuICAgICAqXG4gICAgICogXG4gICAgICpcbiAgICAgKiovXG4gICAgZ2V0VG9rZW5zKHJvdzogbnVtYmVyKTogeyBzdGFydDogbnVtYmVyOyB0eXBlOiBzdHJpbmc7IHZhbHVlOiBzdHJpbmcgfVtdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubGluZXNbcm93XSB8fCB0aGlzLiR0b2tlbml6ZVJvdyhyb3cpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFtSZXR1cm5zIHRoZSBzdGF0ZSBvZiB0b2tlbml6YXRpb24gYXQgdGhlIGVuZCBvZiBhIHJvdy5dezogI0JhY2tncm91bmRUb2tlbml6ZXIuZ2V0U3RhdGV9XG4gICAgICpcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gcm93IFRoZSByb3cgdG8gZ2V0IHN0YXRlIGF0XG4gICAgICoqL1xuICAgIGdldFN0YXRlKHJvdzogbnVtYmVyKTogc3RyaW5nIHtcbiAgICAgICAgaWYgKHRoaXMuY3VycmVudExpbmUgPT0gcm93KSB7XG4gICAgICAgICAgICB0aGlzLiR0b2tlbml6ZVJvdyhyb3cpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlc1tyb3ddIHx8IFwic3RhcnRcIjtcbiAgICB9XG5cbiAgICAkdG9rZW5pemVSb3cocm93OiBudW1iZXIpOiB7IHN0YXJ0OiBudW1iZXI7IHR5cGU6IHN0cmluZzsgdmFsdWU6IHN0cmluZyB9W10ge1xuICAgICAgICB2YXIgbGluZTogc3RyaW5nID0gdGhpcy5kb2MuZ2V0TGluZShyb3cpO1xuICAgICAgICB2YXIgc3RhdGUgPSB0aGlzLnN0YXRlc1tyb3cgLSAxXTtcbiAgICAgICAgXG4gICAgICAgIC8vIEZJWE1FOiBUaGVyZSBpcyBubyB0aGlyZCBhcmd1bWVudCBpbiBnZXRMaW5lVG9rZW5zIVxuICAgICAgICB2YXIgZGF0YTogeyBzdGF0ZTogYW55OyB0b2tlbnM6IHsgc3RhcnQ6IG51bWJlcjsgdHlwZTogc3RyaW5nOyB2YWx1ZTogc3RyaW5nIH1bXSB9ID0gdGhpcy50b2tlbml6ZXIuZ2V0TGluZVRva2VucyhsaW5lLCBzdGF0ZS8qLCByb3cqLyk7XG5cbiAgICAgICAgaWYgKHRoaXMuc3RhdGVzW3Jvd10gKyBcIlwiICE9PSBkYXRhLnN0YXRlICsgXCJcIikge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZXNbcm93XSA9IGRhdGEuc3RhdGU7XG4gICAgICAgICAgICB0aGlzLmxpbmVzW3JvdyArIDFdID0gbnVsbDtcbiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRMaW5lID4gcm93ICsgMSlcbiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRMaW5lID0gcm93ICsgMTtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmN1cnJlbnRMaW5lID09IHJvdykge1xuICAgICAgICAgICAgdGhpcy5jdXJyZW50TGluZSA9IHJvdyArIDE7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5saW5lc1tyb3ddID0gZGF0YS50b2tlbnM7XG4gICAgfVxufSJdfQ==