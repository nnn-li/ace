var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var eve = require("./lib/event_emitter");
var BackgroundTokenizer = (function (_super) {
    __extends(BackgroundTokenizer, _super);
    function BackgroundTokenizer(tokenizer, editor) {
        _super.call(this);
        this.running = 0;
        this.lines = [];
        this.states = [];
        this.currentLine = 0;
        this.tokenizer = tokenizer;
        var self = this;
        this.$worker = function () {
            if (!self.running) {
                return;
            }
            var workerStart = new Date();
            var currentLine = self.currentLine;
            var endLine = -1;
            var doc = self.doc;
            while (self.lines[currentLine])
                currentLine++;
            var startLine = currentLine;
            var len = doc.getLength();
            var processedLines = 0;
            self.running = 0;
            while (currentLine < len) {
                self.$tokenizeRow(currentLine);
                endLine = currentLine;
                do {
                    currentLine++;
                } while (self.lines[currentLine]);
                processedLines++;
                if ((processedLines % 5 === 0) && (new Date().getTime() - workerStart.getTime()) > 20) {
                    self.running = setTimeout(self.$worker, 20);
                    break;
                }
            }
            self.currentLine = currentLine;
            if (startLine <= endLine)
                self.fireUpdateEvent(startLine, endLine);
        };
    }
    BackgroundTokenizer.prototype.setTokenizer = function (tokenizer) {
        this.tokenizer = tokenizer;
        this.lines = [];
        this.states = [];
        this.start(0);
    };
    BackgroundTokenizer.prototype.setDocument = function (doc) {
        this.doc = doc;
        this.lines = [];
        this.states = [];
        this.stop();
    };
    BackgroundTokenizer.prototype.fireUpdateEvent = function (firstRow, lastRow) {
        var data = {
            first: firstRow,
            last: lastRow
        };
        this._signal("update", { data: data });
    };
    BackgroundTokenizer.prototype.start = function (startRow) {
        this.currentLine = Math.min(startRow || 0, this.currentLine, this.doc.getLength());
        this.lines.splice(this.currentLine, this.lines.length);
        this.states.splice(this.currentLine, this.states.length);
        this.stop();
        this.running = setTimeout(this.$worker, 700);
    };
    BackgroundTokenizer.prototype.scheduleStart = function () {
        if (!this.running)
            this.running = setTimeout(this.$worker, 700);
    };
    BackgroundTokenizer.prototype.$updateOnChange = function (delta) {
        var range = delta.range;
        var startRow = range.start.row;
        var len = range.end.row - startRow;
        if (len === 0) {
            this.lines[startRow] = null;
        }
        else if (delta.action == "removeText" || delta.action == "removeLines") {
            this.lines.splice(startRow, len + 1, null);
            this.states.splice(startRow, len + 1, null);
        }
        else {
            var args = Array(len + 1);
            args.unshift(startRow, 1);
            this.lines.splice.apply(this.lines, args);
            this.states.splice.apply(this.states, args);
        }
        this.currentLine = Math.min(startRow, this.currentLine, this.doc.getLength());
        this.stop();
    };
    BackgroundTokenizer.prototype.stop = function () {
        if (this.running) {
            clearTimeout(this.running);
        }
        this.running = 0;
    };
    BackgroundTokenizer.prototype.getTokens = function (row) {
        return this.lines[row] || this.$tokenizeRow(row);
    };
    BackgroundTokenizer.prototype.getState = function (row) {
        if (this.currentLine == row) {
            this.$tokenizeRow(row);
        }
        return this.states[row] || "start";
    };
    BackgroundTokenizer.prototype.$tokenizeRow = function (row) {
        var line = this.doc.getLine(row);
        var state = this.states[row - 1];
        var data = this.tokenizer.getLineTokens(line, state);
        if (this.states[row] + "" !== data.state + "") {
            this.states[row] = data.state;
            this.lines[row + 1] = null;
            if (this.currentLine > row + 1)
                this.currentLine = row + 1;
        }
        else if (this.currentLine == row) {
            this.currentLine = row + 1;
        }
        return this.lines[row] = data.tokens;
    };
    return BackgroundTokenizer;
})(eve.EventEmitterClass);
exports.BackgroundTokenizer = BackgroundTokenizer;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFja2dyb3VuZF90b2tlbml6ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvYmFja2dyb3VuZF90b2tlbml6ZXIudHMiXSwibmFtZXMiOlsiQmFja2dyb3VuZFRva2VuaXplciIsIkJhY2tncm91bmRUb2tlbml6ZXIuY29uc3RydWN0b3IiLCJCYWNrZ3JvdW5kVG9rZW5pemVyLnNldFRva2VuaXplciIsIkJhY2tncm91bmRUb2tlbml6ZXIuc2V0RG9jdW1lbnQiLCJCYWNrZ3JvdW5kVG9rZW5pemVyLmZpcmVVcGRhdGVFdmVudCIsIkJhY2tncm91bmRUb2tlbml6ZXIuc3RhcnQiLCJCYWNrZ3JvdW5kVG9rZW5pemVyLnNjaGVkdWxlU3RhcnQiLCJCYWNrZ3JvdW5kVG9rZW5pemVyLiR1cGRhdGVPbkNoYW5nZSIsIkJhY2tncm91bmRUb2tlbml6ZXIuc3RvcCIsIkJhY2tncm91bmRUb2tlbml6ZXIuZ2V0VG9rZW5zIiwiQmFja2dyb3VuZFRva2VuaXplci5nZXRTdGF0ZSIsIkJhY2tncm91bmRUb2tlbml6ZXIuJHRva2VuaXplUm93Il0sIm1hcHBpbmdzIjoiOzs7OztBQStCQSxJQUFPLEdBQUcsV0FBVyxxQkFBcUIsQ0FBQyxDQUFDO0FBa0I1QztJQUF5Q0EsdUNBQXFCQTtJQVkxREEsNkJBQVlBLFNBQW9CQSxFQUFFQSxNQUFPQTtRQUNyQ0MsaUJBQU9BLENBQUNBO1FBUkpBLFlBQU9BLEdBQVdBLENBQUNBLENBQUNBO1FBQ3BCQSxVQUFLQSxHQUF3Q0EsRUFBRUEsQ0FBQ0E7UUFDaERBLFdBQU1BLEdBQWFBLEVBQUVBLENBQUNBO1FBQ3RCQSxnQkFBV0EsR0FBV0EsQ0FBQ0EsQ0FBQ0E7UUFNNUJBLElBQUlBLENBQUNBLFNBQVNBLEdBQUdBLFNBQVNBLENBQUNBO1FBRTNCQSxJQUFJQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUVoQkEsSUFBSUEsQ0FBQ0EsT0FBT0EsR0FBR0E7WUFDWCxFQUFFLENBQUMsQ0FBQyxDQUFDLElB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QUNaQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxRQUFRQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUNoQ0EsQ0FBQ0E7UUFBQ0EsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsTUFBTUEsSUFBSUEsWUFBWUEsSUFBSUEsS0FBS0EsQ0FBQ0EsTUFBTUEsSUFBSUEsYUFBYUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDdkVBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLE1BQU1BLENBQUNBLFFBQVFBLEVBQUVBLEdBQUdBLEdBQUdBLENBQUNBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO1lBQzNDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQSxRQUFRQSxFQUFFQSxHQUFHQSxHQUFHQSxDQUFDQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUNoREEsQ0FBQ0E7UUFBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDSkEsSUFBSUEsSUFBSUEsR0FBR0EsS0FBS0EsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDMUJBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLFFBQVFBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1lBQzFCQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxNQUFNQSxDQUFDQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxLQUFLQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUMxQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDaERBLENBQUNBO1FBRURBLElBQUlBLENBQUNBLFdBQVdBLEdBQUdBLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLFFBQVFBLEVBQUVBLElBQUlBLENBQUNBLFdBQVdBLEVBQUVBLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLFNBQVNBLEVBQUVBLENBQUNBLENBQUNBO1FBRTlFQSxJQUFJQSxDQUFDQSxJQUFJQSxFQUFFQSxDQUFDQTtJQUNoQkEsQ0FBQ0E7SUFNRFAsa0NBQUlBLEdBQUpBO1FBQ0lRLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBO1lBQ2ZBLFlBQVlBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBO1FBQy9CQSxDQUFDQTtRQUNEQSxJQUFJQSxDQUFDQSxPQUFPQSxHQUFHQSxDQUFDQSxDQUFDQTtJQUNyQkEsQ0FBQ0E7SUFVRFIsdUNBQVNBLEdBQVRBLFVBQVVBLEdBQVdBO1FBQ2pCUyxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxHQUFHQSxDQUFDQSxJQUFJQSxJQUFJQSxDQUFDQSxZQUFZQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQTtJQUNyREEsQ0FBQ0E7SUFPRFQsc0NBQVFBLEdBQVJBLFVBQVNBLEdBQVdBO1FBQ2hCVSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxXQUFXQSxJQUFJQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUMxQkEsSUFBSUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDM0JBLENBQUNBO1FBQ0RBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLEdBQUdBLENBQUNBLElBQUlBLE9BQU9BLENBQUNBO0lBQ3ZDQSxDQUFDQTtJQUVEViwwQ0FBWUEsR0FBWkEsVUFBYUEsR0FBV0E7UUFDcEJXLElBQUlBLElBQUlBLEdBQVdBLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLE9BQU9BLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO1FBQ3pDQSxJQUFJQSxLQUFLQSxHQUFHQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxHQUFHQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUdqQ0EsSUFBSUEsSUFBSUEsR0FBOERBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLGFBQWFBLENBQUNBLElBQUlBLEVBQUVBLEtBQUtBLENBQVVBLENBQUNBO1FBRXpIQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFHQSxFQUFFQSxLQUFLQSxJQUFJQSxDQUFDQSxLQUFLQSxHQUFHQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUM1Q0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0E7WUFDOUJBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBO1lBQzNCQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxXQUFXQSxHQUFHQSxHQUFHQSxHQUFHQSxDQUFDQSxDQUFDQTtnQkFDM0JBLElBQUlBLENBQUNBLFdBQVdBLEdBQUdBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBO1FBQ25DQSxDQUFDQTtRQUFDQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxXQUFXQSxJQUFJQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNqQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsR0FBR0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDL0JBLENBQUNBO1FBRURBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLEdBQUdBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBO0lBQ3pDQSxDQUFDQTtJQUNMWCwwQkFBQ0E7QUFBREEsQ0FBQ0EsQUF2TUQsRUFBeUMsR0FBRyxDQUFDLGlCQUFpQixFQXVNN0Q7QUF2TVksMkJBQW1CLHNCQXVNL0IsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qICoqKioqIEJFR0lOIExJQ0VOU0UgQkxPQ0sgKioqKipcbiAqIERpc3RyaWJ1dGVkIHVuZGVyIHRoZSBCU0QgbGljZW5zZTpcbiAqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTAsIEFqYXgub3JnIEIuVi5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKiBcbiAqIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dFxuICogbW9kaWZpY2F0aW9uLCBhcmUgcGVybWl0dGVkIHByb3ZpZGVkIHRoYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zIGFyZSBtZXQ6XG4gKiAgICAgKiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodFxuICogICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLlxuICogICAgICogUmVkaXN0cmlidXRpb25zIGluIGJpbmFyeSBmb3JtIG11c3QgcmVwcm9kdWNlIHRoZSBhYm92ZSBjb3B5cmlnaHRcbiAqICAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGVcbiAqICAgICAgIGRvY3VtZW50YXRpb24gYW5kL29yIG90aGVyIG1hdGVyaWFscyBwcm92aWRlZCB3aXRoIHRoZSBkaXN0cmlidXRpb24uXG4gKiAgICAgKiBOZWl0aGVyIHRoZSBuYW1lIG9mIEFqYXgub3JnIEIuVi4gbm9yIHRoZVxuICogICAgICAgbmFtZXMgb2YgaXRzIGNvbnRyaWJ1dG9ycyBtYXkgYmUgdXNlZCB0byBlbmRvcnNlIG9yIHByb21vdGUgcHJvZHVjdHNcbiAqICAgICAgIGRlcml2ZWQgZnJvbSB0aGlzIHNvZnR3YXJlIHdpdGhvdXQgc3BlY2lmaWMgcHJpb3Igd3JpdHRlbiBwZXJtaXNzaW9uLlxuICogXG4gKiBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIFRIRSBDT1BZUklHSFQgSE9MREVSUyBBTkQgQ09OVFJJQlVUT1JTIFwiQVMgSVNcIiBBTkRcbiAqIEFOWSBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRSBJTVBMSUVEXG4gKiBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFXG4gKiBESVNDTEFJTUVELiBJTiBOTyBFVkVOVCBTSEFMTCBBSkFYLk9SRyBCLlYuIEJFIExJQUJMRSBGT1IgQU5ZXG4gKiBESVJFQ1QsIElORElSRUNULCBJTkNJREVOVEFMLCBTUEVDSUFMLCBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFU1xuICogKElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRFIEdPT0RTIE9SIFNFUlZJQ0VTO1xuICogTE9TUyBPRiBVU0UsIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTIElOVEVSUlVQVElPTikgSE9XRVZFUiBDQVVTRUQgQU5EXG4gKiBPTiBBTlkgVEhFT1JZIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUIExJQUJJTElUWSwgT1IgVE9SVFxuICogKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZIE9VVCBPRiBUSEUgVVNFIE9GIFRISVNcbiAqIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLlxuICpcbiAqICoqKioqIEVORCBMSUNFTlNFIEJMT0NLICoqKioqICovXG5pbXBvcnQgb29wID0gcmVxdWlyZShcIi4vbGliL29vcFwiKTtcbmltcG9ydCBkY20gPSByZXF1aXJlKCcuL2RvY3VtZW50JylcbmltcG9ydCBldmUgPSByZXF1aXJlKFwiLi9saWIvZXZlbnRfZW1pdHRlclwiKTtcbmltcG9ydCBUb2tlbml6ZXIgPSByZXF1aXJlKCcuL1Rva2VuaXplcicpXG5cbi8qKlxuICogVG9rZW5pemVzIHRoZSBjdXJyZW50IFtbRG9jdW1lbnQgYERvY3VtZW50YF1dIGluIHRoZSBiYWNrZ3JvdW5kLCBhbmQgY2FjaGVzIHRoZSB0b2tlbml6ZWQgcm93cyBmb3IgZnV0dXJlIHVzZS4gXG4gKiBcbiAqIElmIGEgY2VydGFpbiByb3cgaXMgY2hhbmdlZCwgZXZlcnl0aGluZyBiZWxvdyB0aGF0IHJvdyBpcyByZS10b2tlbml6ZWQuXG4gKlxuICogQGNsYXNzIEJhY2tncm91bmRUb2tlbml6ZXJcbiAqKi9cblxuLyoqXG4gKiBDcmVhdGVzIGEgbmV3IGBCYWNrZ3JvdW5kVG9rZW5pemVyYCBvYmplY3QuXG4gKiBAcGFyYW0ge1Rva2VuaXplcn0gdG9rZW5pemVyIFRoZSB0b2tlbml6ZXIgdG8gdXNlXG4gKiBAcGFyYW0ge0VkaXRvcn0gZWRpdG9yIFRoZSBlZGl0b3IgdG8gYXNzb2NpYXRlIHdpdGhcbiAqXG4gKiBAY29uc3RydWN0b3JcbiAqKi9cbmV4cG9ydCBjbGFzcyBCYWNrZ3JvdW5kVG9rZW5pemVyIGV4dGVuZHMgZXZlLkV2ZW50RW1pdHRlckNsYXNzIHtcbiAgICAvKipcbiAgICAgKiBUaGlzIGlzIHRoZSB2YWx1ZSByZXR1cm5lZCBieSBzZXRUaW1lb3V0LCBzbyBpdCdzIHJlYWxseSBhIHRpbWVyIGhhbmRsZS5cbiAgICAgKiBUaGVyZSBhcmUgc29tZSBjb25kaXRpb25hbHMgbG9va2luZyBmb3IgYSBmYWxzZXkgdmFsdWUsIHNvIHdlIHVzZSB6ZXJvIHdoZXJlIG5lZWRlZC5cbiAgICAgKi9cbiAgICBwcml2YXRlIHJ1bm5pbmc6IG51bWJlciA9IDA7XG4gICAgcHJpdmF0ZSBsaW5lczogeyB0eXBlOiBzdHJpbmc7IHZhbHVlOiBzdHJpbmcgfVtdW10gPSBbXTtcbiAgICBwcml2YXRlIHN0YXRlczogc3RyaW5nW10gPSBbXTtcbiAgICBwcml2YXRlIGN1cnJlbnRMaW5lOiBudW1iZXIgPSAwO1xuICAgIHByaXZhdGUgdG9rZW5pemVyOiBUb2tlbml6ZXI7XG4gICAgcHJpdmF0ZSBkb2M6IGRjbS5Eb2N1bWVudDtcbiAgICBwcml2YXRlICR3b3JrZXI7XG4gICAgY29uc3RydWN0b3IodG9rZW5pemVyOiBUb2tlbml6ZXIsIGVkaXRvcj8pIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgdGhpcy50b2tlbml6ZXIgPSB0b2tlbml6ZXI7XG5cbiAgICAgICAgdmFyIHNlbGYgPSB0aGlzO1xuXG4gICAgICAgIHRoaXMuJHdvcmtlciA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgaWYgKCFzZWxmLnJ1bm5pbmcpIHsgcmV0dXJuOyB9XG5cbiAgICAgICAgICAgIHZhciB3b3JrZXJTdGFydCA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgICB2YXIgY3VycmVudExpbmUgPSBzZWxmLmN1cnJlbnRMaW5lO1xuICAgICAgICAgICAgdmFyIGVuZExpbmUgPSAtMTtcbiAgICAgICAgICAgIHZhciBkb2MgPSBzZWxmLmRvYztcblxuICAgICAgICAgICAgd2hpbGUgKHNlbGYubGluZXNbY3VycmVudExpbmVdKVxuICAgICAgICAgICAgICAgIGN1cnJlbnRMaW5lKys7XG5cbiAgICAgICAgICAgIHZhciBzdGFydExpbmUgPSBjdXJyZW50TGluZTtcblxuICAgICAgICAgICAgdmFyIGxlbiA9IGRvYy5nZXRMZW5ndGgoKTtcbiAgICAgICAgICAgIHZhciBwcm9jZXNzZWRMaW5lcyA9IDA7XG4gICAgICAgICAgICBzZWxmLnJ1bm5pbmcgPSAwO1xuICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnRMaW5lIDwgbGVuKSB7XG4gICAgICAgICAgICAgICAgc2VsZi4kdG9rZW5pemVSb3coY3VycmVudExpbmUpO1xuICAgICAgICAgICAgICAgIGVuZExpbmUgPSBjdXJyZW50TGluZTtcbiAgICAgICAgICAgICAgICBkbyB7XG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRMaW5lKys7XG4gICAgICAgICAgICAgICAgfSB3aGlsZSAoc2VsZi5saW5lc1tjdXJyZW50TGluZV0pO1xuICAgIFxuICAgICAgICAgICAgICAgIC8vIG9ubHkgY2hlY2sgZXZlcnkgNSBsaW5lc1xuICAgICAgICAgICAgICAgIHByb2Nlc3NlZExpbmVzKys7XG4gICAgICAgICAgICAgICAgaWYgKChwcm9jZXNzZWRMaW5lcyAlIDUgPT09IDApICYmIChuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHdvcmtlclN0YXJ0LmdldFRpbWUoKSkgPiAyMCkge1xuICAgICAgICAgICAgICAgICAgICBzZWxmLnJ1bm5pbmcgPSBzZXRUaW1lb3V0KHNlbGYuJHdvcmtlciwgMjApO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzZWxmLmN1cnJlbnRMaW5lID0gY3VycmVudExpbmU7XG5cbiAgICAgICAgICAgIGlmIChzdGFydExpbmUgPD0gZW5kTGluZSlcbiAgICAgICAgICAgICAgICBzZWxmLmZpcmVVcGRhdGVFdmVudChzdGFydExpbmUsIGVuZExpbmUpO1xuICAgICAgICB9O1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBTZXRzIGEgbmV3IHRva2VuaXplciBmb3IgdGhpcyBvYmplY3QuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge1Rva2VuaXplcn0gdG9rZW5pemVyIFRoZSBuZXcgdG9rZW5pemVyIHRvIHVzZVxuICAgICAqXG4gICAgICoqL1xuICAgIHNldFRva2VuaXplcih0b2tlbml6ZXI6IFRva2VuaXplcikge1xuICAgICAgICB0aGlzLnRva2VuaXplciA9IHRva2VuaXplcjtcbiAgICAgICAgdGhpcy5saW5lcyA9IFtdO1xuICAgICAgICB0aGlzLnN0YXRlcyA9IFtdO1xuXG4gICAgICAgIHRoaXMuc3RhcnQoMCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2V0cyBhIG5ldyBkb2N1bWVudCB0byBhc3NvY2lhdGUgd2l0aCB0aGlzIG9iamVjdC5cbiAgICAgKiBAcGFyYW0ge0RvY3VtZW50fSBkb2MgVGhlIG5ldyBkb2N1bWVudCB0byBhc3NvY2lhdGUgd2l0aFxuICAgICAqKi9cbiAgICBzZXREb2N1bWVudChkb2M6IGRjbS5Eb2N1bWVudCkge1xuICAgICAgICB0aGlzLmRvYyA9IGRvYztcbiAgICAgICAgdGhpcy5saW5lcyA9IFtdO1xuICAgICAgICB0aGlzLnN0YXRlcyA9IFtdO1xuXG4gICAgICAgIHRoaXMuc3RvcCgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICogRmlyZXMgd2hlbmV2ZXIgdGhlIGJhY2tncm91bmQgdG9rZW5pemllcnMgYmV0d2VlbiBhIHJhbmdlIG9mIHJvd3MgYXJlIGdvaW5nIHRvIGJlIHVwZGF0ZWQuXG4gICAgKiBcbiAgICAqIEBldmVudCB1cGRhdGVcbiAgICAqIEBwYXJhbSB7T2JqZWN0fSBlIEFuIG9iamVjdCBjb250YWluaW5nIHR3byBwcm9wZXJ0aWVzLCBgZmlyc3RgIGFuZCBgbGFzdGAsIHdoaWNoIGluZGljYXRlIHRoZSByb3dzIG9mIHRoZSByZWdpb24gYmVpbmcgdXBkYXRlZC5cbiAgICAqXG4gICAgKiovXG4gICAgLyoqXG4gICAgICogRW1pdHMgdGhlIGAndXBkYXRlJ2AgZXZlbnQuIGBmaXJzdFJvd2AgYW5kIGBsYXN0Um93YCBhcmUgdXNlZCB0byBkZWZpbmUgdGhlIGJvdW5kYXJpZXMgb2YgdGhlIHJlZ2lvbiB0byBiZSB1cGRhdGVkLlxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBmaXJzdFJvdyBUaGUgc3RhcnRpbmcgcm93IHJlZ2lvblxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBsYXN0Um93IFRoZSBmaW5hbCByb3cgcmVnaW9uXG4gICAgICpcbiAgICAgKiovXG4gICAgZmlyZVVwZGF0ZUV2ZW50KGZpcnN0Um93OiBudW1iZXIsIGxhc3RSb3c6IG51bWJlcikge1xuICAgICAgICB2YXIgZGF0YSA9IHtcbiAgICAgICAgICAgIGZpcnN0OiBmaXJzdFJvdyxcbiAgICAgICAgICAgIGxhc3Q6IGxhc3RSb3dcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5fc2lnbmFsKFwidXBkYXRlXCIsIHsgZGF0YTogZGF0YSB9KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdGFydHMgdG9rZW5pemluZyBhdCB0aGUgcm93IGluZGljYXRlZC5cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSBzdGFydFJvdyBUaGUgcm93IHRvIHN0YXJ0IGF0XG4gICAgICpcbiAgICAgKiovXG4gICAgc3RhcnQoc3RhcnRSb3c6IG51bWJlcikge1xuICAgICAgICB0aGlzLmN1cnJlbnRMaW5lID0gTWF0aC5taW4oc3RhcnRSb3cgfHwgMCwgdGhpcy5jdXJyZW50TGluZSwgdGhpcy5kb2MuZ2V0TGVuZ3RoKCkpO1xuXG4gICAgICAgIC8vIHJlbW92ZSBhbGwgY2FjaGVkIGl0ZW1zIGJlbG93IHRoaXMgbGluZVxuICAgICAgICB0aGlzLmxpbmVzLnNwbGljZSh0aGlzLmN1cnJlbnRMaW5lLCB0aGlzLmxpbmVzLmxlbmd0aCk7XG4gICAgICAgIHRoaXMuc3RhdGVzLnNwbGljZSh0aGlzLmN1cnJlbnRMaW5lLCB0aGlzLnN0YXRlcy5sZW5ndGgpO1xuXG4gICAgICAgIHRoaXMuc3RvcCgpO1xuICAgICAgICAvLyBwcmV0dHkgbG9uZyBkZWxheSB0byBwcmV2ZW50IHRoZSB0b2tlbml6ZXIgZnJvbSBpbnRlcmZlcmluZyB3aXRoIHRoZSB1c2VyXG4gICAgICAgIHRoaXMucnVubmluZyA9IHNldFRpbWVvdXQodGhpcy4kd29ya2VyLCA3MDApO1xuICAgIH1cblxuICAgIHNjaGVkdWxlU3RhcnQoKSB7XG4gICAgICAgIGlmICghdGhpcy5ydW5uaW5nKVxuICAgICAgICAgICAgdGhpcy5ydW5uaW5nID0gc2V0VGltZW91dCh0aGlzLiR3b3JrZXIsIDcwMCk7XG4gICAgfVxuXG4gICAgJHVwZGF0ZU9uQ2hhbmdlKGRlbHRhOiB7IHJhbmdlOiB7IHN0YXJ0OiB7IHJvdyB9OyBlbmQ6IHsgcm93IH0gfTsgYWN0aW9uOiBzdHJpbmcgfSkge1xuICAgICAgICB2YXIgcmFuZ2UgPSBkZWx0YS5yYW5nZTtcbiAgICAgICAgdmFyIHN0YXJ0Um93ID0gcmFuZ2Uuc3RhcnQucm93O1xuICAgICAgICB2YXIgbGVuID0gcmFuZ2UuZW5kLnJvdyAtIHN0YXJ0Um93O1xuXG4gICAgICAgIGlmIChsZW4gPT09IDApIHtcbiAgICAgICAgICAgIHRoaXMubGluZXNbc3RhcnRSb3ddID0gbnVsbDtcbiAgICAgICAgfSBlbHNlIGlmIChkZWx0YS5hY3Rpb24gPT0gXCJyZW1vdmVUZXh0XCIgfHwgZGVsdGEuYWN0aW9uID09IFwicmVtb3ZlTGluZXNcIikge1xuICAgICAgICAgICAgdGhpcy5saW5lcy5zcGxpY2Uoc3RhcnRSb3csIGxlbiArIDEsIG51bGwpO1xuICAgICAgICAgICAgdGhpcy5zdGF0ZXMuc3BsaWNlKHN0YXJ0Um93LCBsZW4gKyAxLCBudWxsKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHZhciBhcmdzID0gQXJyYXkobGVuICsgMSk7XG4gICAgICAgICAgICBhcmdzLnVuc2hpZnQoc3RhcnRSb3csIDEpO1xuICAgICAgICAgICAgdGhpcy5saW5lcy5zcGxpY2UuYXBwbHkodGhpcy5saW5lcywgYXJncyk7XG4gICAgICAgICAgICB0aGlzLnN0YXRlcy5zcGxpY2UuYXBwbHkodGhpcy5zdGF0ZXMsIGFyZ3MpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5jdXJyZW50TGluZSA9IE1hdGgubWluKHN0YXJ0Um93LCB0aGlzLmN1cnJlbnRMaW5lLCB0aGlzLmRvYy5nZXRMZW5ndGgoKSk7XG5cbiAgICAgICAgdGhpcy5zdG9wKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU3RvcHMgdG9rZW5pemluZy5cbiAgICAgKlxuICAgICAqKi9cbiAgICBzdG9wKCkge1xuICAgICAgICBpZiAodGhpcy5ydW5uaW5nKSB7XG4gICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5ydW5uaW5nKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnJ1bm5pbmcgPSAwO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEdpdmVzIGxpc3Qgb2YgdG9rZW5zIG9mIHRoZSByb3cuICh0b2tlbnMgYXJlIGNhY2hlZClcbiAgICAgKiBcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gcm93IFRoZSByb3cgdG8gZ2V0IHRva2VucyBhdFxuICAgICAqXG4gICAgICogXG4gICAgICpcbiAgICAgKiovXG4gICAgZ2V0VG9rZW5zKHJvdzogbnVtYmVyKTogeyB0eXBlOiBzdHJpbmc7IHZhbHVlOiBzdHJpbmcgfVtdIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubGluZXNbcm93XSB8fCB0aGlzLiR0b2tlbml6ZVJvdyhyb3cpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFtSZXR1cm5zIHRoZSBzdGF0ZSBvZiB0b2tlbml6YXRpb24gYXQgdGhlIGVuZCBvZiBhIHJvdy5dezogI0JhY2tncm91bmRUb2tlbml6ZXIuZ2V0U3RhdGV9XG4gICAgICpcbiAgICAgKiBAcGFyYW0ge251bWJlcn0gcm93IFRoZSByb3cgdG8gZ2V0IHN0YXRlIGF0XG4gICAgICoqL1xuICAgIGdldFN0YXRlKHJvdzogbnVtYmVyKTogc3RyaW5nIHtcbiAgICAgICAgaWYgKHRoaXMuY3VycmVudExpbmUgPT0gcm93KSB7XG4gICAgICAgICAgICB0aGlzLiR0b2tlbml6ZVJvdyhyb3cpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLnN0YXRlc1tyb3ddIHx8IFwic3RhcnRcIjtcbiAgICB9XG5cbiAgICAkdG9rZW5pemVSb3cocm93OiBudW1iZXIpOiB7IHR5cGU6IHN0cmluZzsgdmFsdWU6IHN0cmluZyB9W10ge1xuICAgICAgICB2YXIgbGluZTogc3RyaW5nID0gdGhpcy5kb2MuZ2V0TGluZShyb3cpO1xuICAgICAgICB2YXIgc3RhdGUgPSB0aGlzLnN0YXRlc1tyb3cgLSAxXTtcbiAgICAgICAgXG4gICAgICAgIC8vIEZJWE1FOiBUaGVyZSBpcyBubyB0aGlyZCBhcmd1bWVudCBpbiBnZXRMaW5lVG9rZW5zIVxuICAgICAgICB2YXIgZGF0YTogeyBzdGF0ZTogYW55OyB0b2tlbnM6IHsgdHlwZTogc3RyaW5nOyB2YWx1ZTogc3RyaW5nIH1bXSB9ID0gdGhpcy50b2tlbml6ZXIuZ2V0TGluZVRva2VucyhsaW5lLCBzdGF0ZS8qLCByb3cqLyk7XG5cbiAgICAgICAgaWYgKHRoaXMuc3RhdGVzW3Jvd10gKyBcIlwiICE9PSBkYXRhLnN0YXRlICsgXCJcIikge1xuICAgICAgICAgICAgdGhpcy5zdGF0ZXNbcm93XSA9IGRhdGEuc3RhdGU7XG4gICAgICAgICAgICB0aGlzLmxpbmVzW3JvdyArIDFdID0gbnVsbDtcbiAgICAgICAgICAgIGlmICh0aGlzLmN1cnJlbnRMaW5lID4gcm93ICsgMSlcbiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRMaW5lID0gcm93ICsgMTtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLmN1cnJlbnRMaW5lID09IHJvdykge1xuICAgICAgICAgICAgdGhpcy5jdXJyZW50TGluZSA9IHJvdyArIDE7XG4gICAgICAgIH1cblxuICAgICAgICByZXR1cm4gdGhpcy5saW5lc1tyb3ddID0gZGF0YS50b2tlbnM7XG4gICAgfVxufSJdfQ==