import { EventEmitterClass } from "./lib/event_emitter";
export class BackgroundTokenizer extends EventEmitterClass {
    constructor(tokenizer, editor) {
        super();
        this.running = 0;
        this.lines = [];
        this.states = [];
        this.currentLine = 0;
        this.tokenizer = tokenizer;
        var self = this;
        this.$worker = function () {
            if (!self.running) {
                return;
            }
            var workerStart = new Date();
            var currentLine = self.currentLine;
            var endLine = -1;
            var doc = self.doc;
            while (self.lines[currentLine])
                currentLine++;
            var startLine = currentLine;
            var len = doc.getLength();
            var processedLines = 0;
            self.running = 0;
            while (currentLine < len) {
                self.$tokenizeRow(currentLine);
                endLine = currentLine;
                do {
                    currentLine++;
                } while (self.lines[currentLine]);
                processedLines++;
                if ((processedLines % 5 === 0) && (new Date().getTime() - workerStart.getTime()) > 20) {
                    self.running = setTimeout(self.$worker, 20);
                    break;
                }
            }
            self.currentLine = currentLine;
            if (startLine <= endLine)
                self.fireUpdateEvent(startLine, endLine);
        };
    }
    setTokenizer(tokenizer) {
        this.tokenizer = tokenizer;
        this.lines = [];
        this.states = [];
        this.start(0);
    }
    setDocument(doc) {
        this.doc = doc;
        this.lines = [];
        this.states = [];
        this.stop();
    }
    fireUpdateEvent(firstRow, lastRow) {
        var data = {
            first: firstRow,
            last: lastRow
        };
        this._signal("update", { data: data });
    }
    start(startRow) {
        this.currentLine = Math.min(startRow || 0, this.currentLine, this.doc.getLength());
        this.lines.splice(this.currentLine, this.lines.length);
        this.states.splice(this.currentLine, this.states.length);
        this.stop();
        this.running = setTimeout(this.$worker, 700);
    }
    scheduleStart() {
        if (!this.running)
            this.running = setTimeout(this.$worker, 700);
    }
    $updateOnChange(delta) {
        var range = delta.range;
        var startRow = range.start.row;
        var len = range.end.row - startRow;
        if (len === 0) {
            this.lines[startRow] = null;
        }
        else if (delta.action == "removeText" || delta.action == "removeLines") {
            this.lines.splice(startRow, len + 1, null);
            this.states.splice(startRow, len + 1, null);
        }
        else {
            var args = Array(len + 1);
            args.unshift(startRow, 1);
            this.lines.splice.apply(this.lines, args);
            this.states.splice.apply(this.states, args);
        }
        this.currentLine = Math.min(startRow, this.currentLine, this.doc.getLength());
        this.stop();
    }
    stop() {
        if (this.running) {
            clearTimeout(this.running);
        }
        this.running = 0;
    }
    getTokens(row) {
        return this.lines[row] || this.$tokenizeRow(row);
    }
    getState(row) {
        if (this.currentLine == row) {
            this.$tokenizeRow(row);
        }
        return this.states[row] || "start";
    }
    $tokenizeRow(row) {
        var line = this.doc.getLine(row);
        var state = this.states[row - 1];
        var data = this.tokenizer.getLineTokens(line, state);
        if (this.states[row] + "" !== data.state + "") {
            this.states[row] = data.state;
            this.lines[row + 1] = null;
            if (this.currentLine > row + 1)
                this.currentLine = row + 1;
        }
        else if (this.currentLine == row) {
            this.currentLine = row + 1;
        }
        return this.lines[row] = data.tokens;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFja2dyb3VuZF90b2tlbml6ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvYmFja2dyb3VuZF90b2tlbml6ZXIudHMiXSwibmFtZXMiOlsiQmFja2dyb3VuZFRva2VuaXplciIsIkJhY2tncm91bmRUb2tlbml6ZXIuY29uc3RydWN0b3IiLCJCYWNrZ3JvdW5kVG9rZW5pemVyLnNldFRva2VuaXplciIsIkJhY2tncm91bmRUb2tlbml6ZXIuc2V0RG9jdW1lbnQiLCJCYWNrZ3JvdW5kVG9rZW5pemVyLmZpcmVVcGRhdGVFdmVudCIsIkJhY2tncm91bmRUb2tlbml6ZXIuc3RhcnQiLCJCYWNrZ3JvdW5kVG9rZW5pemVyLnNjaGVkdWxlU3RhcnQiLCJCYWNrZ3JvdW5kVG9rZW5pemVyLiR1cGRhdGVPbkNoYW5nZSIsIkJhY2tncm91bmRUb2tlbml6ZXIuc3RvcCIsIkJhY2tncm91bmRUb2tlbml6ZXIuZ2V0VG9rZW5zIiwiQmFja2dyb3VuZFRva2VuaXplci5nZXRTdGF0ZSIsIkJhY2tncm91bmRUb2tlbml6ZXIuJHRva2VuaXplUm93Il0sIm1hcHBpbmdzIjoiT0ErQk8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHFCQUFxQjtBQWtCdkQseUNBQXlDLGlCQUFpQjtJQVl0REEsWUFBWUEsU0FBb0JBLEVBQUVBLE1BQU9BO1FBQ3JDQyxPQUFPQSxDQUFDQTtRQVJKQSxZQUFPQSxHQUFXQSxDQUFDQSxDQUFDQTtRQUNwQkEsVUFBS0EsR0FBdURBLEVBQUVBLENBQUNBO1FBQy9EQSxXQUFNQSxHQUFhQSxFQUFFQSxDQUFDQTtRQUN0QkEsZ0JBQVdBLEdBQVdBLENBQUNBLENBQUNBO1FBTTVCQSxJQUFJQSxDQUFDQSxTQUFTQSxHQUFHQSxTQUFTQSxDQUFDQTtRQUUzQkEsSUFBSUEsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0E7UUFFaEJBLElBQUlBLENBQUNBLE9BQU9BLEdBQUdBO1lBQ1gsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FB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Q0E7UUFDaENBLENBQUNBO1FBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLEtBQUtBLENBQUNBLE1BQU1BLElBQUlBLFlBQVlBLElBQUlBLEtBQUtBLENBQUNBLE1BQU1BLElBQUlBLGFBQWFBLENBQUNBLENBQUNBLENBQUNBO1lBQ3ZFQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxNQUFNQSxDQUFDQSxRQUFRQSxFQUFFQSxHQUFHQSxHQUFHQSxDQUFDQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUMzQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsUUFBUUEsRUFBRUEsR0FBR0EsR0FBR0EsQ0FBQ0EsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDaERBLENBQUNBO1FBQUNBLElBQUlBLENBQUNBLENBQUNBO1lBQ0pBLElBQUlBLElBQUlBLEdBQUdBLEtBQUtBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBO1lBQzFCQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxRQUFRQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUMxQkEsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsS0FBS0EsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDMUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLEtBQUtBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO1FBQ2hEQSxDQUFDQTtRQUVEQSxJQUFJQSxDQUFDQSxXQUFXQSxHQUFHQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQSxRQUFRQSxFQUFFQSxJQUFJQSxDQUFDQSxXQUFXQSxFQUFFQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQSxTQUFTQSxFQUFFQSxDQUFDQSxDQUFDQTtRQUU5RUEsSUFBSUEsQ0FBQ0EsSUFBSUEsRUFBRUEsQ0FBQ0E7SUFDaEJBLENBQUNBO0lBTURQLElBQUlBO1FBQ0FRLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBO1lBQ2ZBLFlBQVlBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBO1FBQy9CQSxDQUFDQTtRQUNEQSxJQUFJQSxDQUFDQSxPQUFPQSxHQUFHQSxDQUFDQSxDQUFDQTtJQUNyQkEsQ0FBQ0E7SUFVRFIsU0FBU0EsQ0FBQ0EsR0FBV0E7UUFDakJTLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLEdBQUdBLENBQUNBLElBQUlBLElBQUlBLENBQUNBLFlBQVlBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO0lBQ3JEQSxDQUFDQTtJQU9EVCxRQUFRQSxDQUFDQSxHQUFXQTtRQUNoQlUsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsSUFBSUEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDMUJBLElBQUlBLENBQUNBLFlBQVlBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO1FBQzNCQSxDQUFDQTtRQUNEQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxHQUFHQSxDQUFDQSxJQUFJQSxPQUFPQSxDQUFDQTtJQUN2Q0EsQ0FBQ0E7SUFFRFYsWUFBWUEsQ0FBQ0EsR0FBV0E7UUFDcEJXLElBQUlBLElBQUlBLEdBQVdBLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLE9BQU9BLENBQUNBLEdBQUdBLENBQUNBLENBQUNBO1FBQ3pDQSxJQUFJQSxLQUFLQSxHQUFHQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxHQUFHQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUdqQ0EsSUFBSUEsSUFBSUEsR0FBNkVBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLGFBQWFBLENBQUNBLElBQUlBLEVBQUVBLEtBQUtBLENBQVVBLENBQUNBO1FBRXhJQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFHQSxFQUFFQSxLQUFLQSxJQUFJQSxDQUFDQSxLQUFLQSxHQUFHQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUM1Q0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0E7WUFDOUJBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBO1lBQzNCQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxXQUFXQSxHQUFHQSxHQUFHQSxHQUFHQSxDQUFDQSxDQUFDQTtnQkFDM0JBLElBQUlBLENBQUNBLFdBQVdBLEdBQUdBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBO1FBQ25DQSxDQUFDQTtRQUFDQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxXQUFXQSxJQUFJQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNqQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsR0FBR0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDL0JBLENBQUNBO1FBRURBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLEdBQUdBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBO0lBQ3pDQSxDQUFDQTtBQUNMWCxDQUFDQTtBQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLyogKioqKiogQkVHSU4gTElDRU5TRSBCTE9DSyAqKioqKlxuICogRGlzdHJpYnV0ZWQgdW5kZXIgdGhlIEJTRCBsaWNlbnNlOlxuICpcbiAqIENvcHlyaWdodCAoYykgMjAxMCwgQWpheC5vcmcgQi5WLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqIFxuICogUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0XG4gKiBtb2RpZmljYXRpb24sIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMgYXJlIG1ldDpcbiAqICAgICAqIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0XG4gKiAgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuXG4gKiAgICAgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodFxuICogICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZVxuICogICAgICAgZG9jdW1lbnRhdGlvbiBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi5cbiAqICAgICAqIE5laXRoZXIgdGhlIG5hbWUgb2YgQWpheC5vcmcgQi5WLiBub3IgdGhlXG4gKiAgICAgICBuYW1lcyBvZiBpdHMgY29udHJpYnV0b3JzIG1heSBiZSB1c2VkIHRvIGVuZG9yc2Ugb3IgcHJvbW90ZSBwcm9kdWN0c1xuICogICAgICAgZGVyaXZlZCBmcm9tIHRoaXMgc29mdHdhcmUgd2l0aG91dCBzcGVjaWZpYyBwcmlvciB3cml0dGVuIHBlcm1pc3Npb24uXG4gKiBcbiAqIFRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgVEhFIENPUFlSSUdIVCBIT0xERVJTIEFORCBDT05UUklCVVRPUlMgXCJBUyBJU1wiIEFORFxuICogQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhFIElNUExJRURcbiAqIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkVcbiAqIERJU0NMQUlNRUQuIElOIE5PIEVWRU5UIFNIQUxMIEFKQVguT1JHIEIuVi4gQkUgTElBQkxFIEZPUiBBTllcbiAqIERJUkVDVCwgSU5ESVJFQ1QsIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTXG4gKiAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVM7XG4gKiBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVTSU5FU1MgSU5URVJSVVBUSU9OKSBIT1dFVkVSIENBVVNFRCBBTkRcbiAqIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QgTElBQklMSVRZLCBPUiBUT1JUXG4gKiAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRSBVU0UgT0YgVEhJU1xuICogU09GVFdBUkUsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuXG4gKlxuICogKioqKiogRU5EIExJQ0VOU0UgQkxPQ0sgKioqKiogKi9cbmltcG9ydCB7fSBmcm9tIFwiLi9saWIvb29wXCJcbmltcG9ydCB7IERvY3VtZW50IH0gZnJvbSAnLi9kb2N1bWVudCdcbmltcG9ydCB7IEV2ZW50RW1pdHRlckNsYXNzIH0gZnJvbSBcIi4vbGliL2V2ZW50X2VtaXR0ZXJcIlxuaW1wb3J0IFRva2VuaXplciBmcm9tICcuL1Rva2VuaXplcidcblxuLyoqXG4gKiBUb2tlbml6ZXMgdGhlIGN1cnJlbnQgW1tEb2N1bWVudCBgRG9jdW1lbnRgXV0gaW4gdGhlIGJhY2tncm91bmQsIGFuZCBjYWNoZXMgdGhlIHRva2VuaXplZCByb3dzIGZvciBmdXR1cmUgdXNlLiBcbiAqIFxuICogSWYgYSBjZXJ0YWluIHJvdyBpcyBjaGFuZ2VkLCBldmVyeXRoaW5nIGJlbG93IHRoYXQgcm93IGlzIHJlLXRva2VuaXplZC5cbiAqXG4gKiBAY2xhc3MgQmFja2dyb3VuZFRva2VuaXplclxuICoqL1xuXG4vKipcbiAqIENyZWF0ZXMgYSBuZXcgYEJhY2tncm91bmRUb2tlbml6ZXJgIG9iamVjdC5cbiAqIEBwYXJhbSB7VG9rZW5pemVyfSB0b2tlbml6ZXIgVGhlIHRva2VuaXplciB0byB1c2VcbiAqIEBwYXJhbSB7RWRpdG9yfSBlZGl0b3IgVGhlIGVkaXRvciB0byBhc3NvY2lhdGUgd2l0aFxuICpcbiAqIEBjb25zdHJ1Y3RvclxuICoqL1xuZXhwb3J0IGNsYXNzIEJhY2tncm91bmRUb2tlbml6ZXIgZXh0ZW5kcyBFdmVudEVtaXR0ZXJDbGFzcyB7XG4gICAgLyoqXG4gICAgICogVGhpcyBpcyB0aGUgdmFsdWUgcmV0dXJuZWQgYnkgc2V0VGltZW91dCwgc28gaXQncyByZWFsbHkgYSB0aW1lciBoYW5kbGUuXG4gICAgICogVGhlcmUgYXJlIHNvbWUgY29uZGl0aW9uYWxzIGxvb2tpbmcgZm9yIGEgZmFsc2V5IHZhbHVlLCBzbyB3ZSB1c2UgemVybyB3aGVyZSBuZWVkZWQuXG4gICAgICovXG4gICAgcHJpdmF0ZSBydW5uaW5nOiBudW1iZXIgPSAwO1xuICAgIHByaXZhdGUgbGluZXM6IHsgc3RhcnQ6IG51bWJlcjsgdHlwZTogc3RyaW5nOyB2YWx1ZTogc3RyaW5nIH1bXVtdID0gW107XG4gICAgcHJpdmF0ZSBzdGF0ZXM6IHN0cmluZ1tdID0gW107XG4gICAgcHJpdmF0ZSBjdXJyZW50TGluZTogbnVtYmVyID0gMDtcbiAgICBwcml2YXRlIHRva2VuaXplcjogVG9rZW5pemVyO1xuICAgIHByaXZhdGUgZG9jOiBEb2N1bWVudDtcbiAgICBwcml2YXRlICR3b3JrZXI7XG4gICAgY29uc3RydWN0b3IodG9rZW5pemVyOiBUb2tlbml6ZXIsIGVkaXRvcj8pIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgdGhpcy50b2tlbml6ZXIgPSB0b2tlbml6ZXI7XG5cbiAgICAgICAgdmFyIHNlbGYgPSB0aGlzO1xuXG4gICAgICAgIHRoaXMuJHdvcmtlciA9IGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgaWYgKCFzZWxmLnJ1bm5pbmcpIHsgcmV0dXJuOyB9XG5cbiAgICAgICAgICAgIHZhciB3b3JrZXJTdGFydCA9IG5ldyBEYXRlKCk7XG4gICAgICAgICAgICB2YXIgY3VycmVudExpbmUgPSBzZWxmLmN1cnJlbnRMaW5lO1xuICAgICAgICAgICAgdmFyIGVuZExpbmUgPSAtMTtcbiAgICAgICAgICAgIHZhciBkb2MgPSBzZWxmLmRvYztcblxuICAgICAgICAgICAgd2hpbGUgKHNlbGYubGluZXNbY3VycmVudExpbmVdKVxuICAgICAgICAgICAgICAgIGN1cnJlbnRMaW5lKys7XG5cbiAgICAgICAgICAgIHZhciBzdGFydExpbmUgPSBjdXJyZW50TGluZTtcblxuICAgICAgICAgICAgdmFyIGxlbiA9IGRvYy5nZXRMZW5ndGgoKTtcbiAgICAgICAgICAgIHZhciBwcm9jZXNzZWRMaW5lcyA9IDA7XG4gICAgICAgICAgICBzZWxmLnJ1bm5pbmcgPSAwO1xuICAgICAgICAgICAgd2hpbGUgKGN1cnJlbnRMaW5lIDwgbGVuKSB7XG4gICAgICAgICAgICAgICAgc2VsZi4kdG9rZW5pemVSb3coY3VycmVudExpbmUpO1xuICAgICAgICAgICAgICAgIGVuZExpbmUgPSBjdXJyZW50TGluZTtcbiAgICAgICAgICAgICAgICBkbyB7XG4gICAgICAgICAgICAgICAgICAgIGN1cnJlbnRMaW5lKys7XG4gICAgICAgICAgICAgICAgfSB3aGlsZSAoc2VsZi5saW5lc1tjdXJyZW50TGluZV0pO1xuICAgIFxuICAgICAgICAgICAgICAgIC8vIG9ubHkgY2hlY2sgZXZlcnkgNSBsaW5lc1xuICAgICAgICAgICAgICAgIHByb2Nlc3NlZExpbmVzKys7XG4gICAgICAgICAgICAgICAgaWYgKChwcm9jZXNzZWRMaW5lcyAlIDUgPT09IDApICYmIChuZXcgRGF0ZSgpLmdldFRpbWUoKSAtIHdvcmtlclN0YXJ0LmdldFRpbWUoKSkgPiAyMCkge1xuICAgICAgICAgICAgICAgICAgICBzZWxmLnJ1bm5pbmcgPSBzZXRUaW1lb3V0KHNlbGYuJHdvcmtlciwgMjApO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBzZWxmLmN1cnJlbnRMaW5lID0gY3VycmVudExpbmU7XG5cbiAgICAgICAgICAgIGlmIChzdGFydExpbmUgPD0gZW5kTGluZSlcbiAgICAgICAgICAgICAgICBzZWxmLmZpcmVVcGRhdGVFdmVudChzdGFydExpbmUsIGVuZExpbmUpO1xuICAgICAgICB9O1xuICAgIH1cbiAgICAvKipcbiAgICAgKiBTZXRzIGEgbmV3IHRva2VuaXplciBmb3IgdGhpcyBvYmplY3QuXG4gICAgICpcbiAgICAgKiBAcGFyYW0ge1Rva2VuaXplcn0gdG9rZW5pemVyIFRoZSBuZXcgdG9rZW5pemVyIHRvIHVzZVxuICAgICAqXG4gICAgICoqL1xuICAgIHNldFRva2VuaXplcih0b2tlbml6ZXI6IFRva2VuaXplcikge1xuICAgICAgICB0aGlzLnRva2VuaXplciA9IHRva2VuaXplcjtcbiAgICAgICAgdGhpcy5saW5lcyA9IFtdO1xuICAgICAgICB0aGlzLnN0YXRlcyA9IFtdO1xuXG4gICAgICAgIHRoaXMuc3RhcnQoMCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogU2V0cyBhIG5ldyBkb2N1bWVudCB0byBhc3NvY2lhdGUgd2l0aCB0aGlzIG9iamVjdC5cbiAgICAgKiBAcGFyYW0ge0RvY3VtZW50fSBkb2MgVGhlIG5ldyBkb2N1bWVudCB0byBhc3NvY2lhdGUgd2l0aFxuICAgICAqKi9cbiAgICBzZXREb2N1bWVudChkb2M6IERvY3VtZW50KSB7XG4gICAgICAgIHRoaXMuZG9jID0gZG9jO1xuICAgICAgICB0aGlzLmxpbmVzID0gW107XG4gICAgICAgIHRoaXMuc3RhdGVzID0gW107XG5cbiAgICAgICAgdGhpcy5zdG9wKCk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgKiBGaXJlcyB3aGVuZXZlciB0aGUgYmFja2dyb3VuZCB0b2tlbml6aWVycyBiZXR3ZWVuIGEgcmFuZ2Ugb2Ygcm93cyBhcmUgZ29pbmcgdG8gYmUgdXBkYXRlZC5cbiAgICAqIFxuICAgICogQGV2ZW50IHVwZGF0ZVxuICAgICogQHBhcmFtIHtPYmplY3R9IGUgQW4gb2JqZWN0IGNvbnRhaW5pbmcgdHdvIHByb3BlcnRpZXMsIGBmaXJzdGAgYW5kIGBsYXN0YCwgd2hpY2ggaW5kaWNhdGUgdGhlIHJvd3Mgb2YgdGhlIHJlZ2lvbiBiZWluZyB1cGRhdGVkLlxuICAgICpcbiAgICAqKi9cbiAgICAvKipcbiAgICAgKiBFbWl0cyB0aGUgYCd1cGRhdGUnYCBldmVudC4gYGZpcnN0Um93YCBhbmQgYGxhc3RSb3dgIGFyZSB1c2VkIHRvIGRlZmluZSB0aGUgYm91bmRhcmllcyBvZiB0aGUgcmVnaW9uIHRvIGJlIHVwZGF0ZWQuXG4gICAgICogQHBhcmFtIHtudW1iZXJ9IGZpcnN0Um93IFRoZSBzdGFydGluZyByb3cgcmVnaW9uXG4gICAgICogQHBhcmFtIHtudW1iZXJ9IGxhc3RSb3cgVGhlIGZpbmFsIHJvdyByZWdpb25cbiAgICAgKlxuICAgICAqKi9cbiAgICBmaXJlVXBkYXRlRXZlbnQoZmlyc3RSb3c6IG51bWJlciwgbGFzdFJvdzogbnVtYmVyKSB7XG4gICAgICAgIHZhciBkYXRhID0ge1xuICAgICAgICAgICAgZmlyc3Q6IGZpcnN0Um93LFxuICAgICAgICAgICAgbGFzdDogbGFzdFJvd1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLl9zaWduYWwoXCJ1cGRhdGVcIiwgeyBkYXRhOiBkYXRhIH0pO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFN0YXJ0cyB0b2tlbml6aW5nIGF0IHRoZSByb3cgaW5kaWNhdGVkLlxuICAgICAqXG4gICAgICogQHBhcmFtIHtudW1iZXJ9IHN0YXJ0Um93IFRoZSByb3cgdG8gc3RhcnQgYXRcbiAgICAgKlxuICAgICAqKi9cbiAgICBzdGFydChzdGFydFJvdzogbnVtYmVyKSB7XG4gICAgICAgIHRoaXMuY3VycmVudExpbmUgPSBNYXRoLm1pbihzdGFydFJvdyB8fCAwLCB0aGlzLmN1cnJlbnRMaW5lLCB0aGlzLmRvYy5nZXRMZW5ndGgoKSk7XG5cbiAgICAgICAgLy8gcmVtb3ZlIGFsbCBjYWNoZWQgaXRlbXMgYmVsb3cgdGhpcyBsaW5lXG4gICAgICAgIHRoaXMubGluZXMuc3BsaWNlKHRoaXMuY3VycmVudExpbmUsIHRoaXMubGluZXMubGVuZ3RoKTtcbiAgICAgICAgdGhpcy5zdGF0ZXMuc3BsaWNlKHRoaXMuY3VycmVudExpbmUsIHRoaXMuc3RhdGVzLmxlbmd0aCk7XG5cbiAgICAgICAgdGhpcy5zdG9wKCk7XG4gICAgICAgIC8vIHByZXR0eSBsb25nIGRlbGF5IHRvIHByZXZlbnQgdGhlIHRva2VuaXplciBmcm9tIGludGVyZmVyaW5nIHdpdGggdGhlIHVzZXJcbiAgICAgICAgdGhpcy5ydW5uaW5nID0gc2V0VGltZW91dCh0aGlzLiR3b3JrZXIsIDcwMCk7XG4gICAgfVxuXG4gICAgc2NoZWR1bGVTdGFydCgpIHtcbiAgICAgICAgaWYgKCF0aGlzLnJ1bm5pbmcpXG4gICAgICAgICAgICB0aGlzLnJ1bm5pbmcgPSBzZXRUaW1lb3V0KHRoaXMuJHdvcmtlciwgNzAwKTtcbiAgICB9XG5cbiAgICAkdXBkYXRlT25DaGFuZ2UoZGVsdGE6IHsgcmFuZ2U6IHsgc3RhcnQ6IHsgcm93IH07IGVuZDogeyByb3cgfSB9OyBhY3Rpb246IHN0cmluZyB9KSB7XG4gICAgICAgIHZhciByYW5nZSA9IGRlbHRhLnJhbmdlO1xuICAgICAgICB2YXIgc3RhcnRSb3cgPSByYW5nZS5zdGFydC5yb3c7XG4gICAgICAgIHZhciBsZW4gPSByYW5nZS5lbmQucm93IC0gc3RhcnRSb3c7XG5cbiAgICAgICAgaWYgKGxlbiA9PT0gMCkge1xuICAgICAgICAgICAgdGhpcy5saW5lc1tzdGFydFJvd10gPSBudWxsO1xuICAgICAgICB9IGVsc2UgaWYgKGRlbHRhLmFjdGlvbiA9PSBcInJlbW92ZVRleHRcIiB8fCBkZWx0YS5hY3Rpb24gPT0gXCJyZW1vdmVMaW5lc1wiKSB7XG4gICAgICAgICAgICB0aGlzLmxpbmVzLnNwbGljZShzdGFydFJvdywgbGVuICsgMSwgbnVsbCk7XG4gICAgICAgICAgICB0aGlzLnN0YXRlcy5zcGxpY2Uoc3RhcnRSb3csIGxlbiArIDEsIG51bGwpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdmFyIGFyZ3MgPSBBcnJheShsZW4gKyAxKTtcbiAgICAgICAgICAgIGFyZ3MudW5zaGlmdChzdGFydFJvdywgMSk7XG4gICAgICAgICAgICB0aGlzLmxpbmVzLnNwbGljZS5hcHBseSh0aGlzLmxpbmVzLCBhcmdzKTtcbiAgICAgICAgICAgIHRoaXMuc3RhdGVzLnNwbGljZS5hcHBseSh0aGlzLnN0YXRlcywgYXJncyk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmN1cnJlbnRMaW5lID0gTWF0aC5taW4oc3RhcnRSb3csIHRoaXMuY3VycmVudExpbmUsIHRoaXMuZG9jLmdldExlbmd0aCgpKTtcblxuICAgICAgICB0aGlzLnN0b3AoKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBTdG9wcyB0b2tlbml6aW5nLlxuICAgICAqXG4gICAgICoqL1xuICAgIHN0b3AoKSB7XG4gICAgICAgIGlmICh0aGlzLnJ1bm5pbmcpIHtcbiAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aGlzLnJ1bm5pbmcpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMucnVubmluZyA9IDA7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogR2l2ZXMgbGlzdCBvZiB0b2tlbnMgb2YgdGhlIHJvdy4gKHRva2VucyBhcmUgY2FjaGVkKVxuICAgICAqIFxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSByb3cgVGhlIHJvdyB0byBnZXQgdG9rZW5zIGF0XG4gICAgICpcbiAgICAgKiBcbiAgICAgKlxuICAgICAqKi9cbiAgICBnZXRUb2tlbnMocm93OiBudW1iZXIpOiB7IHN0YXJ0OiBudW1iZXI7IHR5cGU6IHN0cmluZzsgdmFsdWU6IHN0cmluZyB9W10ge1xuICAgICAgICByZXR1cm4gdGhpcy5saW5lc1tyb3ddIHx8IHRoaXMuJHRva2VuaXplUm93KHJvdyk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogW1JldHVybnMgdGhlIHN0YXRlIG9mIHRva2VuaXphdGlvbiBhdCB0aGUgZW5kIG9mIGEgcm93Ll17OiAjQmFja2dyb3VuZFRva2VuaXplci5nZXRTdGF0ZX1cbiAgICAgKlxuICAgICAqIEBwYXJhbSB7bnVtYmVyfSByb3cgVGhlIHJvdyB0byBnZXQgc3RhdGUgYXRcbiAgICAgKiovXG4gICAgZ2V0U3RhdGUocm93OiBudW1iZXIpOiBzdHJpbmcge1xuICAgICAgICBpZiAodGhpcy5jdXJyZW50TGluZSA9PSByb3cpIHtcbiAgICAgICAgICAgIHRoaXMuJHRva2VuaXplUm93KHJvdyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHRoaXMuc3RhdGVzW3Jvd10gfHwgXCJzdGFydFwiO1xuICAgIH1cblxuICAgICR0b2tlbml6ZVJvdyhyb3c6IG51bWJlcik6IHsgc3RhcnQ6IG51bWJlcjsgdHlwZTogc3RyaW5nOyB2YWx1ZTogc3RyaW5nIH1bXSB7XG4gICAgICAgIHZhciBsaW5lOiBzdHJpbmcgPSB0aGlzLmRvYy5nZXRMaW5lKHJvdyk7XG4gICAgICAgIHZhciBzdGF0ZSA9IHRoaXMuc3RhdGVzW3JvdyAtIDFdO1xuICAgICAgICBcbiAgICAgICAgLy8gRklYTUU6IFRoZXJlIGlzIG5vIHRoaXJkIGFyZ3VtZW50IGluIGdldExpbmVUb2tlbnMhXG4gICAgICAgIHZhciBkYXRhOiB7IHN0YXRlOiBhbnk7IHRva2VuczogeyBzdGFydDogbnVtYmVyOyB0eXBlOiBzdHJpbmc7IHZhbHVlOiBzdHJpbmcgfVtdIH0gPSB0aGlzLnRva2VuaXplci5nZXRMaW5lVG9rZW5zKGxpbmUsIHN0YXRlLyosIHJvdyovKTtcblxuICAgICAgICBpZiAodGhpcy5zdGF0ZXNbcm93XSArIFwiXCIgIT09IGRhdGEuc3RhdGUgKyBcIlwiKSB7XG4gICAgICAgICAgICB0aGlzLnN0YXRlc1tyb3ddID0gZGF0YS5zdGF0ZTtcbiAgICAgICAgICAgIHRoaXMubGluZXNbcm93ICsgMV0gPSBudWxsO1xuICAgICAgICAgICAgaWYgKHRoaXMuY3VycmVudExpbmUgPiByb3cgKyAxKVxuICAgICAgICAgICAgICAgIHRoaXMuY3VycmVudExpbmUgPSByb3cgKyAxO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMuY3VycmVudExpbmUgPT0gcm93KSB7XG4gICAgICAgICAgICB0aGlzLmN1cnJlbnRMaW5lID0gcm93ICsgMTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB0aGlzLmxpbmVzW3Jvd10gPSBkYXRhLnRva2VucztcbiAgICB9XG59Il19