var rng = require("../range");
var dom = require("../lib/dom");
var Marker = (function () {
    function Marker(parentEl) {
        this.$padding = 0;
        this.element = dom.createElement("div");
        this.element.className = "ace_layer ace_marker-layer";
        parentEl.appendChild(this.element);
    }
    Marker.prototype.setPadding = function (padding) {
        this.$padding = padding;
    };
    Marker.prototype.setSession = function (session) {
        this.session = session;
    };
    Marker.prototype.setMarkers = function (markers) {
        this.markers = markers;
    };
    Marker.prototype.update = function (config) {
        var config = config || this.config;
        if (!config)
            return;
        this.config = config;
        var html = [];
        for (var key in this.markers) {
            var marker = this.markers[key];
            if (!marker.range) {
                marker.update(html, this, this.session, config);
                continue;
            }
            var range = marker.range.clipRows(config.firstRow, config.lastRow);
            if (range.isEmpty())
                continue;
            range = range.toScreenRange(this.session);
            if (marker.renderer) {
                var top = this.$getTop(range.start.row, config);
                var left = this.$padding + range.start.column * config.characterWidth;
                marker.renderer(html, range, left, top, config);
            }
            else if (marker.type == "fullLine") {
                this.drawFullLineMarker(html, range, marker.clazz, config);
            }
            else if (marker.type == "screenLine") {
                this.drawScreenLineMarker(html, range, marker.clazz, config);
            }
            else if (range.isMultiLine()) {
                if (marker.type == "text")
                    this.drawTextMarker(html, range, marker.clazz, config);
                else
                    this.drawMultiLineMarker(html, range, marker.clazz, config);
            }
            else {
                this.drawSingleLineMarker(html, range, marker.clazz + " ace_start ace_br15", config);
            }
        }
        this.element.innerHTML = html.join("");
    };
    Marker.prototype.$getTop = function (row, layerConfig) {
        return (row - layerConfig.firstRowScreen) * layerConfig.lineHeight;
    };
    Marker.prototype.drawTextMarker = function (stringBuilder, range, clazz, layerConfig, extraStyle) {
        function getBorderClass(tl, tr, br, bl) {
            return (tl ? 1 : 0) | (tr ? 2 : 0) | (br ? 4 : 0) | (bl ? 8 : 0);
        }
        var session = this.session;
        var start = range.start.row;
        var end = range.end.row;
        var row = start;
        var prev = 0;
        var curr = 0;
        var next = session.getScreenLastRowColumn(row);
        var lineRange = new rng.Range(row, range.start.column, row, curr);
        for (; row <= end; row++) {
            lineRange.start.row = lineRange.end.row = row;
            lineRange.start.column = row == start ? range.start.column : session.getRowWrapIndent(row);
            lineRange.end.column = next;
            prev = curr;
            curr = next;
            next = row + 1 < end ? session.getScreenLastRowColumn(row + 1) : row == end ? 0 : range.end.column;
            this.drawSingleLineMarker(stringBuilder, lineRange, clazz + (row == start ? " ace_start" : "") + " ace_br" + getBorderClass(row == start || row == start + 1 && range.start.column, prev < curr, curr > next, row == end), layerConfig, row == end ? 0 : 1, extraStyle);
        }
    };
    Marker.prototype.drawMultiLineMarker = function (stringBuilder, range, clazz, config, extraStyle) {
        var padding = this.$padding;
        var height = config.lineHeight;
        var top = this.$getTop(range.start.row, config);
        var left = padding + range.start.column * config.characterWidth;
        extraStyle = extraStyle || "";
        stringBuilder.push("<div class='", clazz, " ace_br1 ace_start' style='", "height:", height, "px;", "right:0;", "top:", top, "px;", "left:", left, "px;", extraStyle, "'></div>");
        top = this.$getTop(range.end.row, config);
        var width = range.end.column * config.characterWidth;
        stringBuilder.push("<div class='", clazz, " ace_br12' style='", "height:", height, "px;", "width:", width, "px;", "top:", top, "px;", "left:", padding, "px;", extraStyle, "'></div>");
        height = (range.end.row - range.start.row - 1) * config.lineHeight;
        if (height < 0) {
            return;
        }
        top = this.$getTop(range.start.row + 1, config);
        var radiusClass = (range.start.column ? 1 : 0) | (range.end.column ? 0 : 8);
        stringBuilder.push("<div class='", clazz, (radiusClass ? " ace_br" + radiusClass : ""), "' style='", "height:", height, "px;", "right:0;", "top:", top, "px;", "left:", padding, "px;", extraStyle, "'></div>");
    };
    Marker.prototype.drawSingleLineMarker = function (stringBuilder, range, clazz, config, extraLength, extraStyle) {
        var height = config.lineHeight;
        var width = (range.end.column + (extraLength || 0) - range.start.column) * config.characterWidth;
        var top = this.$getTop(range.start.row, config);
        var left = this.$padding + range.start.column * config.characterWidth;
        stringBuilder.push("<div class='", clazz, "' style='", "height:", height, "px;", "width:", width, "px;", "top:", top, "px;", "left:", left, "px;", extraStyle || "", "'></div>");
    };
    Marker.prototype.drawFullLineMarker = function (stringBuilder, range, clazz, config, extraStyle) {
        var top = this.$getTop(range.start.row, config);
        var height = config.lineHeight;
        if (range.start.row != range.end.row) {
            height += this.$getTop(range.end.row, config) - top;
        }
        stringBuilder.push("<div class='", clazz, "' style='", "height:", height, "px;", "top:", top, "px;", "left:0;right:0;", extraStyle || "", "'></div>");
    };
    Marker.prototype.drawScreenLineMarker = function (stringBuilder, range, clazz, config, extraStyle) {
        var top = this.$getTop(range.start.row, config);
        var height = config.lineHeight;
        stringBuilder.push("<div class='", clazz, "' style='", "height:", height, "px;", "top:", top, "px;", "left:0;right:0;", extraStyle || "", "'></div>");
    };
    return Marker;
})();
exports.Marker = Marker;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFya2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2xheWVyL21hcmtlci50cyJdLCJuYW1lcyI6WyJNYXJrZXIiLCJNYXJrZXIuY29uc3RydWN0b3IiLCJNYXJrZXIuc2V0UGFkZGluZyIsIk1hcmtlci5zZXRTZXNzaW9uIiwiTWFya2VyLnNldE1hcmtlcnMiLCJNYXJrZXIudXBkYXRlIiwiTWFya2VyLiRnZXRUb3AiLCJNYXJrZXIuZHJhd1RleHRNYXJrZXIiLCJNYXJrZXIuZHJhd1RleHRNYXJrZXIuZ2V0Qm9yZGVyQ2xhc3MiLCJNYXJrZXIuZHJhd011bHRpTGluZU1hcmtlciIsIk1hcmtlci5kcmF3U2luZ2xlTGluZU1hcmtlciIsIk1hcmtlci5kcmF3RnVsbExpbmVNYXJrZXIiLCJNYXJrZXIuZHJhd1NjcmVlbkxpbmVNYXJrZXIiXSwibWFwcGluZ3MiOiJBQThCQSxJQUFPLEdBQUcsV0FBVyxVQUFVLENBQUMsQ0FBQztBQUNqQyxJQUFPLEdBQUcsV0FBVyxZQUFZLENBQUMsQ0FBQztBQUduQztJQU9FQSxnQkFBWUEsUUFBY0E7UUFGbEJDLGFBQVFBLEdBQVdBLENBQUNBLENBQUNBO1FBRzNCQSxJQUFJQSxDQUFDQSxPQUFPQSxHQUFtQkEsR0FBR0EsQ0FBQ0EsYUFBYUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0E7UUFDeERBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLFNBQVNBLEdBQUdBLDRCQUE0QkEsQ0FBQ0E7UUFDdERBLFFBQVFBLENBQUNBLFdBQVdBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBO0lBQ3JDQSxDQUFDQTtJQUVNRCwyQkFBVUEsR0FBakJBLFVBQWtCQSxPQUFlQTtRQUMvQkUsSUFBSUEsQ0FBQ0EsUUFBUUEsR0FBR0EsT0FBT0EsQ0FBQ0E7SUFDMUJBLENBQUNBO0lBRU1GLDJCQUFVQSxHQUFqQkEsVUFBa0JBLE9BQXdCQTtRQUN4Q0csSUFBSUEsQ0FBQ0EsT0FBT0EsR0FBR0Es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QUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxHQUFHQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxHQUFHQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxHQUFHQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNuRUEsQ0FBQ0E7UUFFREQsSUFBSUEsT0FBT0EsR0FBR0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0E7UUFDM0JBLElBQUlBLEtBQUtBLEdBQUdBLEtBQUtBLENBQUNBLEtBQUtBLENBQUNBLEdBQUdBLENBQUNBO1FBQzVCQSxJQUFJQSxHQUFHQSxHQUFHQSxLQUFLQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFHQSxDQUFDQTtRQUN4QkEsSUFBSUEsR0FBR0EsR0FBR0EsS0FBS0EsQ0FBQ0E7UUFDaEJBLElBQUlBLElBQUlBLEdBQUdBLENBQUNBLENBQUNBO1FBQ2JBLElBQUlBLElBQUlBLEdBQUdBLENBQUNBLENBQUNBO1FBQ2JBLElBQUlBLElBQUlBLEdBQUdBLE9BQU9BLENBQUNBLHNCQUFzQkEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDL0NBLElBQUlBLFNBQVNBLEdBQUdBLElBQUlBLEdBQUdBLENBQUNBLEtBQUtBLENBQUNBLEdBQUdBLEVBQUVBLEtBQUtBLENBQUNBLEtBQUtBLENBQUNBLE1BQU1BLEVBQUVBLEdBQUdBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO1FBQ2xFQSxHQUFHQSxDQUFDQSxDQUFDQSxFQUFFQSxHQUFHQSxJQUFJQSxHQUFHQSxFQUFFQSxHQUFHQSxFQUFFQSxFQUFFQSxDQUFDQTtZQUN6QkEsU0FBU0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsR0FBR0EsR0FBR0EsU0FBU0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsR0FBR0EsR0FBR0EsR0FBR0EsQ0FBQ0E7WUFDOUNBLFNBQVNBLENBQUNBLEtBQUtBLENBQUNBLE1BQU1BLEdBQUdBLEdBQUdBLElBQUlBLEtBQUtBLEdBQUdBLEtBQUtBLENBQUNBLEtB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RUFDbEJBLE9BQU9BLEVBQUVBLE9BQU9BLEVBQUVBLEtBQUtBLEVBQUVBLFVBQVVBLEVBQUVBLFVBQVVBLENBQ2hEQSxDQUFDQTtRQUdGQSxNQUFNQSxHQUFHQSxDQUFDQSxLQUFLQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFHQSxHQUFHQSxLQUFLQSxDQUFDQSxLQUFLQSxDQUFDQSxHQUFHQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxNQUFNQSxDQUFDQSxVQUFVQSxDQUFDQTtRQUNuRUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDZkEsTUFBTUEsQ0FBQ0E7UUFDVEEsQ0FBQ0E7UUFDREEsR0FBR0EsR0FBR0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsRUFBRUEsTUFBTUEsQ0FBQ0EsQ0FBQ0E7UUFFaERBLElBQUlBLFdBQVdBLEdBQUdBLENBQUNBLEtBQUtBLENBQUNBLEtBQUtBLENBQUNBLE1BQU1BLEdBQUdBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEtBQUtBLENBQUNBLEdBQUdBLENBQUNBLE1BQU1BLEdBQUdBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBO1FBRTVFQSxhQUFhQSxDQUFDQSxJQUFJQSxDQUNoQkEsY0FBY0EsRUFBRUEsS0FBS0EsRUFBRUEsQ0FBQ0EsV0FBV0EsR0FBR0EsU0FBU0EsR0FBR0EsV0FBV0EsR0FBR0EsRUFBRUEsQ0FBQ0EsRUFBRUEsV0FBV0EsRUFDaEZBLFNBQVNBLEVBQUVBLE1BQU1BLEVBQUVBLEtBQUtBLEVBQ3hCQSxVQUFVQSxFQUNWQSxNQUFNQSxFQUFFQSxHQUFHQSxFQUFFQSxLQUFLQSxFQUNsQkEsT0FBT0EsRUFBRUEsT0FBT0EsRUFBRUEsS0FBS0EsRUFBRUEsVUFBVUEsRUFBRUEsVUFBVUEsQ0FDaERBLENBQUNBO0lBQ0pBLENBQUNBO0lBR09ULHFDQUFvQkEsR0FBNUJBLFVBQTZC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R0EsRUFBRUEsS0FBS0EsRUFDbEJBLGlCQUFpQkEsRUFBRUEsVUFBVUEsSUFBSUEsRUFBRUEsRUFBRUEsVUFBVUEsQ0FDaERBLENBQUNBO0lBQ0pBLENBQUNBO0lBQ0haLGFBQUNBO0FBQURBLENBQUNBLEFBcE1ELElBb01DO0FBcE1ZLGNBQU0sU0FvTWxCLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKiAqKioqKiBCRUdJTiBMSUNFTlNFIEJMT0NLICoqKioqXG4gKiBEaXN0cmlidXRlZCB1bmRlciB0aGUgQlNEIGxpY2Vuc2U6XG4gKlxuICogQ29weXJpZ2h0IChjKSAyMDEwLCBBamF4Lm9yZyBCLlYuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICogXG4gKiBSZWRpc3RyaWJ1dGlvbiBhbmQgdXNlIGluIHNvdXJjZSBhbmQgYmluYXJ5IGZvcm1zLCB3aXRoIG9yIHdpdGhvdXRcbiAqIG1vZGlmaWNhdGlvbiwgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OlxuICogICAgICogUmVkaXN0cmlidXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHRcbiAqICAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci5cbiAqICAgICAqIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0XG4gKiAgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIgaW4gdGhlXG4gKiAgICAgICBkb2N1bWVudGF0aW9uIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLlxuICogICAgICogTmVpdGhlciB0aGUgbmFtZSBvZiBBamF4Lm9yZyBCLlYuIG5vciB0aGVcbiAqICAgICAgIG5hbWVzIG9mIGl0cyBjb250cmlidXRvcnMgbWF5IGJlIHVzZWQgdG8gZW5kb3JzZSBvciBwcm9tb3RlIHByb2R1Y3RzXG4gKiAgICAgICBkZXJpdmVkIGZyb20gdGhpcyBzb2Z0d2FyZSB3aXRob3V0IHNwZWNpZmljIHByaW9yIHdyaXR0ZW4gcGVybWlzc2lvbi5cbiAqIFxuICogVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQ09QWVJJR0hUIEhPTERFUlMgQU5EIENPTlRSSUJVVE9SUyBcIkFTIElTXCIgQU5EXG4gKiBBTlkgRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUgSU1QTElFRFxuICogV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkgQU5EIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFSRVxuICogRElTQ0xBSU1FRC4gSU4gTk8gRVZFTlQgU0hBTEwgQUpBWC5PUkcgQi5WLiBCRSBMSUFCTEUgRk9SIEFOWVxuICogRElSRUNULCBJTkRJUkVDVCwgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVNcbiAqIChJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUztcbiAqIExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORFxuICogT04gQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVCBMSUFCSUxJVFksIE9SIFRPUlRcbiAqIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFIFVTRSBPRiBUSElTXG4gKiBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS5cbiAqXG4gKiAqKioqKiBFTkQgTElDRU5TRSBCTE9DSyAqKioqKiAqL1xuXG5pbXBvcnQgcm5nID0gcmVxdWlyZShcIi4uL3JhbmdlXCIpO1xuaW1wb3J0IGRvbSA9IHJlcXVpcmUoXCIuLi9saWIvZG9tXCIpO1xuaW1wb3J0IGVzbSA9IHJlcXVpcmUoJy4uL2VkaXRfc2Vzc2lvbicpO1xuXG5leHBvcnQgY2xhc3MgTWFya2VyIHtcbiAgcHJpdmF0ZSBlbGVtZW50OiBIVE1MRGl2RWxlbWVudDtcbiAgcHJpdmF0ZSBzZXNzaW9uOiBlc20uRWRpdFNlc3Npb247XG4gIHByaXZhdGUgbWFya2VycztcbiAgcHJpdmF0ZSBjb25maWc7XG4gIHByaXZhdGUgJHBhZGRpbmc6IG51bWJlciA9IDA7XG5cbiAgY29uc3RydWN0b3IocGFyZW50RWw6IE5vZGUpIHtcbiAgICB0aGlzLmVsZW1lbnQgPSA8SFRNTERpdkVsZW1lbnQ+ZG9tLmNyZWF0ZUVsZW1lbnQoXCJkaXZcIik7XG4gICAgdGhpcy5lbGVtZW50LmNsYXNzTmFtZSA9IFwiYWNlX2xheWVyIGFjZV9tYXJrZXItbGF5ZXJcIjtcbiAgICBwYXJlbnRFbC5hcHBlbmRDaGlsZCh0aGlzLmVsZW1lbnQpO1xuICB9XG5cbiAgcHVibGljIHNldFBhZGRpbmcocGFkZGluZzogbnVtYmVyKSB7XG4gICAgdGhpcy4kcGFkZGluZyA9IHBhZGRpbmc7XG4gIH1cbiAgICBcbiAgcHVibGljIHNldFNlc3Npb24oc2Vzc2lvbjogZXNtLkVkaXRTZXNzaW9uKSB7XG4gICAgdGhpcy5zZXNzaW9uID0gc2Vzc2lvbjtcbiAgfVxuICAgIFxuICBwdWJsaWMgc2V0TWFya2VycyhtYXJrZXJzKSB7XG4gICAgdGhpcy5tYXJrZXJzID0gbWFya2VycztcbiAgfVxuXG4gIHB1YmxpYyB1cGRhdGUoY29uZmlnKSB7XG4gICAgdmFyIGNvbmZpZyA9IGNvbmZpZyB8fCB0aGlzLmNvbmZpZztcbiAgICBpZiAoIWNvbmZpZylcbiAgICAgIHJldHVybjtcblxuICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuXG4gICAgdmFyIGh0bWwgPSBbXTtcbiAgICBmb3IgKHZhciBrZXkgaW4gdGhpcy5tYXJrZXJzKSB7XG4gICAgICB2YXIgbWFya2VyID0gdGhpcy5tYXJrZXJzW2tleV07XG5cbiAgICAgIGlmICghbWFya2VyLnJhbmdlKSB7XG4gICAgICAgIG1hcmtlci51cGRhdGUoaHRtbCwgdGhpcywgdGhpcy5zZXNzaW9uLCBjb25maWcpO1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cblxuICAgICAgdmFyIHJhbmdlID0gbWFya2VyLnJhbmdlLmNsaXBSb3dzKGNvbmZpZy5maXJzdFJvdywgY29uZmlnLmxhc3RSb3cpO1xuICAgICAgaWYgKHJhbmdlLmlzRW1wdHkoKSkgY29udGludWU7XG5cbiAgICAgIHJhbmdlID0gcmFuZ2UudG9TY3JlZW5SYW5nZSh0aGlzLnNlc3Npb24pO1xuICAgICAgaWYgKG1hcmtlci5yZW5kZXJlcikge1xuICAgICAgICB2YXIgdG9wID0gdGhpcy4kZ2V0VG9wKHJhbmdlLnN0YXJ0LnJvdywgY29uZmlnKTtcbiAgICAgICAgdmFyIGxlZnQgPSB0aGlzLiRwYWRkaW5nICsgcmFuZ2Uuc3RhcnQuY29sdW1uICogY29uZmlnLmNoYXJhY3RlcldpZHRoO1xuICAgICAgICBtYXJrZXIucmVuZGVyZXIoaHRtbCwgcmFuZ2UsIGxlZnQsIHRvcCwgY29uZmlnKTtcbiAgICAgIH1cbiAgICAgIGVsc2UgaWYgKG1hcmtlci50eXBlID09IFwiZnVsbExpbmVcIikge1xuICAgICAgICB0aGlzLmRyYXdGdWxsTGluZU1hcmtlcihodG1sLCByYW5nZSwgbWFya2VyLmNsYXp6LCBjb25maWcpO1xuICAgICAgfVxuICAgICAgZWxzZSBpZiAobWFya2VyLnR5cGUgPT0gXCJzY3JlZW5MaW5lXCIpIHtcbiAgICAgICAgdGhpcy5kcmF3U2NyZWVuTGluZU1hcmtlcihodG1sLCByYW5nZSwgbWFya2VyLmNsYXp6LCBjb25maWcpO1xuICAgICAgfVxuICAgICAgZWxzZSBpZiAocmFuZ2UuaXNNdWx0aUxpbmUoKSkge1xuICAgICAgICBpZiAobWFya2VyLnR5cGUgPT0gXCJ0ZXh0XCIpXG4gICAgICAgICAgdGhpcy5kcmF3VGV4dE1hcmtlcihodG1sLCByYW5nZSwgbWFya2VyLmNsYXp6LCBjb25maWcpO1xuICAgICAgICBlbHNlXG4gICAgICAgICAgdGhpcy5kcmF3TXVsdGlMaW5lTWFya2VyKGh0bWwsIHJhbmdlLCBtYXJrZXIuY2xhenosIGNvbmZpZyk7XG4gICAgICB9XG4gICAgICBlbHNlIHtcbiAgICAgICAgdGhpcy5kcmF3U2luZ2xlTGluZU1hcmtlcihodG1sLCByYW5nZSwgbWFya2VyLmNsYXp6ICsgXCIgYWNlX3N0YXJ0IGFjZV9icjE1XCIsIGNvbmZpZyk7XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMuZWxlbWVudC5pbm5lckhUTUwgPSBodG1sLmpvaW4oXCJcIik7XG4gIH1cblxuICBwcml2YXRlICRnZXRUb3Aocm93LCBsYXllckNvbmZpZykge1xuICAgIHJldHVybiAocm93IC0gbGF5ZXJDb25maWcuZmlyc3RSb3dTY3JlZW4pICogbGF5ZXJDb25maWcubGluZUhlaWdodDtcbiAgfVxuXG4gIC8vIERyYXdzIGEgbWFya2VyLCB3aGljaCBzcGFucyBhIHJhbmdlIG9mIHRleHQgb24gbXVsdGlwbGUgbGluZXMgXG4gIHByaXZhdGUgZHJhd1RleHRNYXJrZXIoc3RyaW5nQnVpbGRlciwgcmFuZ2UsIGNsYXp6LCBsYXllckNvbmZpZywgZXh0cmFTdHlsZT8pIHtcblxuICAgIGZ1bmN0aW9uIGdldEJvcmRlckNsYXNzKHRsLCB0ciwgYnIsIGJsKSB7XG4gICAgICByZXR1cm4gKHRsID8gMSA6IDApIHwgKHRyID8gMiA6IDApIHwgKGJyID8gNCA6IDApIHwgKGJsID8gOCA6IDApO1xuICAgIH1cbiAgICBcbiAgICB2YXIgc2Vzc2lvbiA9IHRoaXMuc2Vzc2lvbjtcbiAgICB2YXIgc3RhcnQgPSByYW5nZS5zdGFydC5yb3c7XG4gICAgdmFyIGVuZCA9IHJhbmdlLmVuZC5yb3c7XG4gICAgdmFyIHJvdyA9IHN0YXJ0O1xuICAgIHZhciBwcmV2ID0gMDsgXG4gICAgdmFyIGN1cnIgPSAwO1xuICAgIHZhciBuZXh0ID0gc2Vzc2lvbi5nZXRTY3JlZW5MYXN0Um93Q29sdW1uKHJvdyk7XG4gICAgdmFyIGxpbmVSYW5nZSA9IG5ldyBybmcuUmFuZ2Uocm93LCByYW5nZS5zdGFydC5jb2x1bW4sIHJvdywgY3Vycik7XG4gICAgZm9yICg7IHJvdyA8PSBlbmQ7IHJvdysrKSB7XG4gICAgICBsaW5lUmFuZ2Uuc3RhcnQucm93ID0gbGluZVJhbmdlLmVuZC5yb3cgPSByb3c7XG4gICAgICBsaW5lUmFuZ2Uuc3RhcnQuY29sdW1uID0gcm93ID09IHN0YXJ0ID8gcmFuZ2Uuc3RhcnQuY29sdW1uIDogc2Vzc2lvbi5nZXRSb3dXcmFwSW5kZW50KHJvdyk7XG4gICAgICBsaW5lUmFuZ2UuZW5kLmNvbHVtbiA9IG5leHQ7XG4gICAgICBwcmV2ID0gY3VycjtcbiAgICAgIGN1cnIgPSBuZXh0O1xuICAgICAgbmV4dCA9IHJvdyArIDEgPCBlbmQgPyBzZXNzaW9uLmdldFNjcmVlbkxhc3RSb3dDb2x1bW4ocm93ICsgMSkgOiByb3cgPT0gZW5kID8gMCA6IHJhbmdlLmVuZC5jb2x1bW47XG4gICAgICB0aGlzLmRyYXdTaW5nbGVMaW5lTWFya2VyKFxuICAgICAgICBzdHJpbmdCdWlsZGVyLFxuICAgICAgICBsaW5lUmFuZ2UsXG4gICAgICAgIGNsYXp6ICsgKHJvdyA9PSBzdGFydCAgPyBcIiBhY2Vfc3RhcnRcIiA6IFwiXCIpICsgXCIgYWNlX2JyXCIgKyBnZXRCb3JkZXJDbGFzcyhyb3cgPT0gc3RhcnQgfHwgcm93ID09IHN0YXJ0ICsgMSAmJiByYW5nZS5zdGFydC5jb2x1bW4sIHByZXYgPCBjdXJyLCBjdXJyID4gbmV4dCwgcm93ID09IGVuZCksXG4gICAgICAgIGxheWVyQ29uZmlnLFxuICAgICAgICByb3cgPT0gZW5kID8gMCA6IDEsXG4gICAgICAgIGV4dHJhU3R5bGUpO1xuICAgIH1cbiAgfVxuXG4gIC8vIERyYXdzIGEgbXVsdGkgbGluZSBtYXJrZXIsIHdoZXJlIGxpbmVzIHNwYW4gdGhlIGZ1bGwgd2lkdGhcbiAgcHJpdmF0ZSBkcmF3TXVsdGlMaW5lTWFya2VyKHN0cmluZ0J1aWxkZXIsIHJhbmdlLCBjbGF6eiwgY29uZmlnLCBleHRyYVN0eWxlPykge1xuICAgIC8vIGZyb20gc2VsZWN0aW9uIHN0YXJ0IHRvIHRoZSBlbmQgb2YgdGhlIGxpbmVcbiAgICB2YXIgcGFkZGluZyA9IHRoaXMuJHBhZGRpbmc7XG4gICAgdmFyIGhlaWdodCA9IGNvbmZpZy5saW5lSGVpZ2h0O1xuICAgIHZhciB0b3AgPSB0aGlzLiRnZXRUb3AocmFuZ2Uuc3RhcnQucm93LCBjb25maWcpO1xuICAgIHZhciBsZWZ0ID0gcGFkZGluZyArIHJhbmdlLnN0YXJ0LmNvbHVtbiAqIGNvbmZpZy5jaGFyYWN0ZXJXaWR0aDtcbiAgICBcbiAgICBleHRyYVN0eWxlID0gZXh0cmFTdHlsZSB8fCBcIlwiO1xuXG4gICAgc3RyaW5nQnVpbGRlci5wdXNoKFxuICAgICAgXCI8ZGl2IGNsYXNzPSdcIiwgY2xhenosIFwiIGFjZV9icjEgYWNlX3N0YXJ0JyBzdHlsZT0nXCIsXG4gICAgICBcImhlaWdodDpcIiwgaGVpZ2h0LCBcInB4O1wiLFxuICAgICAgXCJyaWdodDowO1wiLFxuICAgICAgXCJ0b3A6XCIsIHRvcCwgXCJweDtcIixcbiAgICAgIFwibGVmdDpcIiwgbGVmdCwgXCJweDtcIiwgZXh0cmFTdHlsZSwgXCInPjwvZGl2PlwiXG4gICAgKTtcblxuICAgIC8vIGZyb20gc3RhcnQgb2YgdGhlIGxhc3QgbGluZSB0byB0aGUgc2VsZWN0aW9uIGVuZFxuICAgIHRvcCA9IHRoaXMuJGdldFRvcChyYW5nZS5lbmQucm93LCBjb25maWcpO1xuICAgIHZhciB3aWR0aCA9IHJhbmdlLmVuZC5jb2x1bW4gKiBjb25maWcuY2hhcmFjdGVyV2lkdGg7XG5cbiAgICBzdHJpbmdCdWlsZGVyLnB1c2goXG4gICAgICBcIjxkaXYgY2xhc3M9J1wiLCBjbGF6eiwgXCIgYWNlX2JyMTInIHN0eWxlPSdcIixcbiAgICAgIFwiaGVpZ2h0OlwiLCBoZWlnaHQsIFwicHg7XCIsXG4gICAgICBcIndpZHRoOlwiLCB3aWR0aCwgXCJweDtcIixcbiAgICAgIFwidG9wOlwiLCB0b3AsIFwicHg7XCIsXG4gICAgICBcImxlZnQ6XCIsIHBhZGRpbmcsIFwicHg7XCIsIGV4dHJhU3R5bGUsIFwiJz48L2Rpdj5cIlxuICAgICk7XG5cbiAgICAvLyBhbGwgdGhlIGNvbXBsZXRlIGxpbmVzXG4gICAgaGVpZ2h0ID0gKHJhbmdlLmVuZC5yb3cgLSByYW5nZS5zdGFydC5yb3cgLSAxKSAqIGNvbmZpZy5saW5lSGVpZ2h0O1xuICAgIGlmIChoZWlnaHQgPCAwKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRvcCA9IHRoaXMuJGdldFRvcChyYW5nZS5zdGFydC5yb3cgKyAxLCBjb25maWcpO1xuXG4gICAgdmFyIHJhZGl1c0NsYXNzID0gKHJhbmdlLnN0YXJ0LmNvbHVtbiA/IDEgOiAwKSB8IChyYW5nZS5lbmQuY29sdW1uID8gMCA6IDgpO1xuXG4gICAgc3RyaW5nQnVpbGRlci5wdXNoKFxuICAgICAgXCI8ZGl2IGNsYXNzPSdcIiwgY2xhenosIChyYWRpdXNDbGFzcyA/IFwiIGFjZV9iclwiICsgcmFkaXVzQ2xhc3MgOiBcIlwiKSwgXCInIHN0eWxlPSdcIixcbiAgICAgIFwiaGVpZ2h0OlwiLCBoZWlnaHQsIFwicHg7XCIsXG4gICAgICBcInJpZ2h0OjA7XCIsXG4gICAgICBcInRvcDpcIiwgdG9wLCBcInB4O1wiLFxuICAgICAgXCJsZWZ0OlwiLCBwYWRkaW5nLCBcInB4O1wiLCBleHRyYVN0eWxlLCBcIic+PC9kaXY+XCJcbiAgICApO1xuICB9XG5cbiAgLy8gRHJhd3MgYSBtYXJrZXIgd2hpY2ggY292ZXJzIHBhcnQgb3Igd2hvbGUgd2lkdGggb2YgYSBzaW5nbGUgc2NyZWVuIGxpbmVcbiAgcHJpdmF0ZSBkcmF3U2luZ2xlTGluZU1hcmtlcihzdHJpbmdCdWlsZGVyLCByYW5nZSwgY2xhenosIGNvbmZpZywgZXh0cmFMZW5ndGg/LCBleHRyYVN0eWxlPykge1xuICAgIHZhciBoZWlnaHQgPSBjb25maWcubGluZUhlaWdodDtcbiAgICB2YXIgd2lkdGggPSAocmFuZ2UuZW5kLmNvbHVtbiArIChleHRyYUxlbmd0aCB8fCAwKSAtIHJhbmdlLnN0YXJ0LmNvbHVtbikgKiBjb25maWcuY2hhcmFjdGVyV2lkdGg7XG5cbiAgICB2YXIgdG9wID0gdGhpcy4kZ2V0VG9wKHJhbmdlLnN0YXJ0LnJvdywgY29uZmlnKTtcbiAgICB2YXIgbGVmdCA9IHRoaXMuJHBhZGRpbmcgKyByYW5nZS5zdGFydC5jb2x1bW4gKiBjb25maWcuY2hhcmFjdGVyV2lkdGg7XG5cbiAgICBzdHJpbmdCdWlsZGVyLnB1c2goXG4gICAgICBcIjxkaXYgY2xhc3M9J1wiLCBjbGF6eiwgXCInIHN0eWxlPSdcIixcbiAgICAgIFwiaGVpZ2h0OlwiLCBoZWlnaHQsIFwicHg7XCIsXG4gICAgICBcIndpZHRoOlwiLCB3aWR0aCwgXCJweDtcIixcbiAgICAgIFwidG9wOlwiLCB0b3AsIFwicHg7XCIsXG4gICAgICBcImxlZnQ6XCIsIGxlZnQsIFwicHg7XCIsIGV4dHJhU3R5bGUgfHwgXCJcIiwgXCInPjwvZGl2PlwiXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZHJhd0Z1bGxMaW5lTWFya2VyKHN0cmluZ0J1aWxkZXIsIHJhbmdlLCBjbGF6eiwgY29uZmlnLCBleHRyYVN0eWxlPykge1xuICAgIHZhciB0b3AgPSB0aGlzLiRnZXRUb3AocmFuZ2Uuc3RhcnQucm93LCBjb25maWcpO1xuICAgIHZhciBoZWlnaHQgPSBjb25maWcubGluZUhlaWdodDtcbiAgICBpZiAocmFuZ2Uuc3RhcnQucm93ICE9IHJhbmdlLmVuZC5yb3cpIHtcbiAgICAgIGhlaWdodCArPSB0aGlzLiRnZXRUb3AocmFuZ2UuZW5kLnJvdywgY29uZmlnKSAtIHRvcDtcbiAgICB9XG5cbiAgICBzdHJpbmdCdWlsZGVyLnB1c2goXG4gICAgICBcIjxkaXYgY2xhc3M9J1wiLCBjbGF6eiwgXCInIHN0eWxlPSdcIixcbiAgICAgIFwiaGVpZ2h0OlwiLCBoZWlnaHQsIFwicHg7XCIsXG4gICAgICBcInRvcDpcIiwgdG9wLCBcInB4O1wiLFxuICAgICAgXCJsZWZ0OjA7cmlnaHQ6MDtcIiwgZXh0cmFTdHlsZSB8fCBcIlwiLCBcIic+PC9kaXY+XCJcbiAgICApO1xuICB9XG4gICAgXG4gIHByaXZhdGUgZHJhd1NjcmVlbkxpbmVNYXJrZXIoc3RyaW5nQnVpbGRlciwgcmFuZ2UsIGNsYXp6LCBjb25maWcsIGV4dHJhU3R5bGU/KSB7XG4gICAgdmFyIHRvcCA9IHRoaXMuJGdldFRvcChyYW5nZS5zdGFydC5yb3csIGNvbmZpZyk7XG4gICAgdmFyIGhlaWdodCA9IGNvbmZpZy5saW5lSGVpZ2h0O1xuXG4gICAgc3RyaW5nQnVpbGRlci5wdXNoKFxuICAgICAgXCI8ZGl2IGNsYXNzPSdcIiwgY2xhenosIFwiJyBzdHlsZT0nXCIsXG4gICAgICBcImhlaWdodDpcIiwgaGVpZ2h0LCBcInB4O1wiLFxuICAgICAgXCJ0b3A6XCIsIHRvcCwgXCJweDtcIixcbiAgICAgIFwibGVmdDowO3JpZ2h0OjA7XCIsIGV4dHJhU3R5bGUgfHwgXCJcIiwgXCInPjwvZGl2PlwiXG4gICAgKTtcbiAgfVxufVxuIl19