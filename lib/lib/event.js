var keys = require("./keys");
var useragent = require("./useragent");
function addListener(target, type, callback, useCapture) {
    if (target.addEventListener) {
        return target.addEventListener(type, callback, false);
    }
}
exports.addListener = addListener;
function removeListener(target, type, callback, useCapture) {
    if (target.removeEventListener) {
        return target.removeEventListener(type, callback, false);
    }
}
exports.removeListener = removeListener;
function stopEvent(e) {
    stopPropagation(e);
    preventDefault(e);
    return false;
}
exports.stopEvent = stopEvent;
function stopPropagation(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    else {
        e.cancelBubble = true;
    }
}
exports.stopPropagation = stopPropagation;
function preventDefault(e) {
    var RETURN_VALUE_DEPRECATED = 'returnValue';
    if (e.preventDefault) {
        e.preventDefault();
    }
    else if (e[RETURN_VALUE_DEPRECATED]) {
        e[RETURN_VALUE_DEPRECATED] = false;
    }
}
exports.preventDefault = preventDefault;
function getButton(e) {
    if (e.type == "dblclick")
        return 0;
    if (e.type == "contextmenu" || (useragent.isMac && (e.ctrlKey && !e.altKey && !e.shiftKey)))
        return 2;
    if (e.preventDefault) {
        return e.button;
    }
    else {
        return { 1: 0, 2: 2, 4: 1 }[e.button];
    }
}
exports.getButton = getButton;
function capture(unused, acquireCaptureHandler, releaseCaptureHandler) {
    var element = document;
    function releaseMouse(e) {
        acquireCaptureHandler && acquireCaptureHandler(e);
        releaseCaptureHandler && releaseCaptureHandler(e);
        removeListener(element, "mousemove", acquireCaptureHandler, true);
        removeListener(element, "mouseup", releaseMouse, true);
        removeListener(element, "dragstart", releaseMouse, true);
    }
    addListener(element, "mousemove", acquireCaptureHandler, true);
    addListener(element, "mouseup", releaseMouse, true);
    addListener(element, "dragstart", releaseMouse, true);
    return releaseMouse;
}
exports.capture = capture;
function addMouseWheelListener(element, callback) {
    if ("onmousewheel" in element) {
        addListener(element, "mousewheel", function (e) {
            var factor = 8;
            if (e['wheelDeltaX'] !== undefined) {
                e['wheelX'] = -e['wheelDeltaX'] / factor;
                e['wheelY'] = -e['wheelDeltaY'] / factor;
            }
            else {
                e['wheelX'] = 0;
                e['wheelY'] = -e.wheelDelta / factor;
            }
            callback(e);
        });
    }
    else if ("onwheel" in element) {
        addListener(element, "wheel", function (e) {
            var factor = 0.35;
            switch (e.deltaMode) {
                case e.DOM_DELTA_PIXEL:
                    e.wheelX = e.deltaX * factor || 0;
                    e.wheelY = e.deltaY * factor || 0;
                    break;
                case e.DOM_DELTA_LINE:
                case e.DOM_DELTA_PAGE:
                    e.wheelX = (e.deltaX || 0) * 5;
                    e.wheelY = (e.deltaY || 0) * 5;
                    break;
            }
            callback(e);
        });
    }
    else {
        addListener(element, "DOMMouseScroll", function (e) {
            if (e.axis && e.axis == e.HORIZONTAL_AXIS) {
                e.wheelX = (e.detail || 0) * 5;
                e.wheelY = 0;
            }
            else {
                e.wheelX = 0;
                e.wheelY = (e.detail || 0) * 5;
            }
            callback(e);
        });
    }
}
exports.addMouseWheelListener = addMouseWheelListener;
function addMultiMouseDownListener(el, timeouts, eventHandler, callbackName) {
    var clicks = 0;
    var startX, startY, timer;
    var eventNames = {
        2: "dblclick",
        3: "tripleclick",
        4: "quadclick"
    };
    addListener(el, "mousedown", function (e) {
        if (getButton(e) !== 0) {
            clicks = 0;
        }
        else if (e.detail > 1) {
            clicks++;
            if (clicks > 4)
                clicks = 1;
        }
        else {
            clicks = 1;
        }
        if (useragent.isIE) {
            var isNewClick = Math.abs(e.clientX - startX) > 5 || Math.abs(e.clientY - startY) > 5;
            if (!timer || isNewClick)
                clicks = 1;
            if (timer)
                clearTimeout(timer);
            timer = setTimeout(function () { timer = null; }, timeouts[clicks - 1] || 600);
            if (clicks == 1) {
                startX = e.clientX;
                startY = e.clientY;
            }
        }
        e['_clicks'] = clicks;
        eventHandler[callbackName]("mousedown", e);
        if (clicks > 4)
            clicks = 0;
        else if (clicks > 1)
            return eventHandler[callbackName](eventNames[clicks], e);
    });
    if (useragent.isOldIE) {
        addListener(el, "dblclick", function (e) {
            clicks = 2;
            if (timer)
                clearTimeout(timer);
            timer = setTimeout(function () { timer = null; }, timeouts[clicks - 1] || 600);
            eventHandler[callbackName]("mousedown", e);
            eventHandler[callbackName](eventNames[clicks], e);
        });
    }
}
exports.addMultiMouseDownListener = addMultiMouseDownListener;
var getModifierHash = useragent.isMac && useragent.isOpera && !("KeyboardEvent" in window)
    ? function (e) {
        return 0 | (e.metaKey ? 1 : 0) | (e.altKey ? 2 : 0) | (e.shiftKey ? 4 : 0) | (e.ctrlKey ? 8 : 0);
    }
    : function (e) {
        return 0 | (e.ctrlKey ? 1 : 0) | (e.altKey ? 2 : 0) | (e.shiftKey ? 4 : 0) | (e.metaKey ? 8 : 0);
    };
function getModifierString(e) {
    return keys.KEY_MODS[getModifierHash(e)];
}
exports.getModifierString = getModifierString;
function normalizeCommandKeys(callback, e, keyCode) {
    var hashId = getModifierHash(e);
    if (!useragent.isMac && pressedKeys) {
        if (pressedKeys[91] || pressedKeys[92])
            hashId |= 8;
        if (pressedKeys.altGr) {
            if ((3 & hashId) != 3)
                pressedKeys.altGr = 0;
            else
                return;
        }
        if (keyCode === 18 || keyCode === 17) {
            if (keyCode === 17 && e.location === 1) {
                ts = e.timeStamp;
            }
            else if (keyCode === 18 && hashId === 3 && e.location === 2) {
                var dt = -ts;
                ts = e.timeStamp;
                dt += ts;
                if (dt < 3)
                    pressedKeys.altGr = true;
            }
        }
    }
    if (keyCode in keys.MODIFIER_KEYS) {
        switch (keys.MODIFIER_KEYS[keyCode]) {
            case "Alt":
                hashId = 2;
                break;
            case "Shift":
                hashId = 4;
                break;
            case "Ctrl":
                hashId = 1;
                break;
            default:
                hashId = 8;
                break;
        }
        keyCode = -1;
    }
    if (hashId & 8 && (keyCode === 91 || keyCode === 93)) {
        keyCode = -1;
    }
    if (!hashId && keyCode === 13) {
        if (e.location === 3) {
            callback(e, hashId, -keyCode);
            if (e.defaultPrevented)
                return;
        }
    }
    if (useragent.isChromeOS && hashId & 8) {
        callback(e, hashId, keyCode);
        if (e.defaultPrevented)
            return;
        else
            hashId &= ~8;
    }
    if (!hashId && !(keyCode in keys.FUNCTION_KEYS) && !(keyCode in keys.PRINTABLE_KEYS)) {
        return false;
    }
    return callback(e, hashId, keyCode);
}
var pressedKeys = null;
function resetPressedKeys(e) {
    pressedKeys = Object.create(null);
}
var ts = 0;
function addCommandKeyListener(el, callback) {
    if (useragent.isOldGecko || (useragent.isOpera && !("KeyboardEvent" in window))) {
        var lastKeyDownKeyCode = null;
        addListener(el, "keydown", function (e) {
            lastKeyDownKeyCode = e.keyCode;
        });
        addListener(el, "keypress", function (e) {
            return normalizeCommandKeys(callback, e, lastKeyDownKeyCode);
        });
    }
    else {
        var lastDefaultPrevented = null;
        addListener(el, "keydown", function (e) {
            pressedKeys[e.keyCode] = true;
            var result = normalizeCommandKeys(callback, e, e.keyCode);
            lastDefaultPrevented = e.defaultPrevented;
            return result;
        });
        addListener(el, 'keypress', function (e) {
            if (lastDefaultPrevented && (e.ctrlKey || e.altKey || e.shiftKey || e.metaKey)) {
                stopEvent(e);
                lastDefaultPrevented = null;
            }
        });
        addListener(el, 'keyup', function (e) {
            pressedKeys[e.keyCode] = null;
        });
        if (!pressedKeys) {
            pressedKeys = Object.create(null);
            addListener(window, 'focus', resetPressedKeys);
        }
    }
}
exports.addCommandKeyListener = addCommandKeyListener;
if (window.postMessage && !useragent.isOldIE) {
    var postMessageId = 1;
    exports.nextTick = function (callback, win) {
        win = win || window;
        var messageName = "zero-timeout-message-" + postMessageId;
        addListener(win, "message", function listener(e) {
            if (e.data == messageName) {
                stopPropagation(e);
                removeListener(win, "message", listener);
                callback();
            }
        });
        win.postMessage(messageName, "*");
    };
}
var nextFrameCandidate = window.requestAnimationFrame ||
    window['mozRequestAnimationFrame'] ||
    window['webkitRequestAnimationFrame'] ||
    window.msRequestAnimationFrame ||
    window['oRequestAnimationFrame'];
if (nextFrameCandidate) {
    nextFrameCandidate = nextFrameCandidate.bind(window);
}
else {
    nextFrameCandidate = function (callback) {
        setTimeout(callback, 17);
    };
}
exports.requestAnimationFrame = nextFrameCandidate;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbGliL2V2ZW50LnRzIl0sIm5hbWVzIjpbImFkZExpc3RlbmVyIiwicmVtb3ZlTGlzdGVuZXIiLCJzdG9wRXZlbnQiLCJzdG9wUHJvcGFnYXRpb24iLCJwcmV2ZW50RGVmYXVsdCIsImdldEJ1dHRvbiIsImNhcHR1cmUiLCJjYXB0dXJlLnJlbGVhc2VNb3VzZSIsImFkZE1vdXNlV2hlZWxMaXN0ZW5lciIsImFkZE11bHRpTW91c2VEb3duTGlzdGVuZXIiLCJnZXRNb2RpZmllclN0cmluZyIsIm5vcm1hbGl6ZUNvbW1hbmRLZXlzIiwicmVzZXRQcmVzc2VkS2V5cyIsImFkZENvbW1hbmRLZXlMaXN0ZW5lciIsImxpc3RlbmVyIl0sIm1hcHBpbmdzIjoiQUE2QkEsSUFBTyxJQUFJLFdBQVcsUUFBUSxDQUFDLENBQUM7QUFDaEMsSUFBTyxTQUFTLFdBQVcsYUFBYSxDQUFDLENBQUM7QUFLMUMscUJBQTRCLE1BQXNCLEVBQUUsSUFBWSxFQUFFLFFBQVEsRUFBRSxVQUFvQjtJQUM1RkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUMxQkEsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxJQUFJQSxFQUFFQSxRQUFRQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQTtJQUMxREEsQ0FBQ0E7QUFDTEEsQ0FBQ0E7QUFKZSxtQkFBVyxjQUkxQixDQUFBO0FBRUQsd0JBQStCLE1BQXNCLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxVQUFvQjtJQUN2RkMsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsbUJBQW1CQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUM3QkEsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsbUJBQW1CQSxDQUFDQSxJQUFJQSxFQUFFQSxRQUFRQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQTtJQUM3REEsQ0FBQ0E7QUFDTEEsQ0FBQ0E7QUFKZSxzQkFBYyxpQkFJN0IsQ0FBQTtBQUtELG1CQUEwQixDQUFRO0lBQzlCQyxlQUFlQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtJQUNuQkEsY0FBY0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7SUFDbEJBLE1BQU1BLENBQUNBLEtBQUtBLENBQUNBO0FBQ2pCQSxDQUFDQTtBQUplLGlCQUFTLFlBSXhCLENBQUE7QUFFRCx5QkFBZ0MsQ0FBUTtJQUNwQ0MsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsZUFBZUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDcEJBLENBQUNBLENBQUNBLGVBQWVBLEVBQUVBLENBQUNBO0lBQ3hCQSxDQUFDQTtJQUNEQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUNGQSxDQUFDQSxDQUFDQSxZQUFZQSxHQUFHQSxJQUFJQSxDQUFDQTtJQUMxQkEsQ0FBQ0E7QUFDTEEsQ0FBQ0E7QUFQZSx1QkFBZSxrQkFPOUIsQ0FBQTtBQUVELHdCQUErQixDQUFRO0lBRW5DQyxJQUFJQSx1QkFBdUJBLEdBQUdBLGFBQWFBLENBQUNBO0lBQzVDQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxjQUFjQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNuQkEsQ0FBQ0EsQ0FBQ0EsY0FBY0EsRUFBRUEsQ0FBQ0E7SUFDdkJBLENBQUNBO0lBQ0RBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLHVCQUF1QkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDbENBLENBQUNBLENBQUNBLHVCQUF1QkEsQ0FBQ0EsR0FBR0EsS0FBS0EsQ0FBQ0E7SUFDdkNBLENBQUNBO0FBQ0xBLENBQUNBO0FBVGUsc0JBQWMsaUJBUzdCLENBQUE7QUFLRCxtQkFBMEIsQ0FBYTtJQUNuQ0MsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsSUFBSUEsVUFBVUEsQ0FBQ0E7UUFDckJBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBO0lBQ2JBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLElBQUlBLElBQUlBLGFBQWFBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLEtBQUtBLElBQUlBLENBQUNBLENBQUNBLENBQUNBLE9BQU9BLElBQUlBLENBQUNBLENBQUNBLENBQUNBLE1BQU1BLElBQUlBLENBQUNBLENBQUNBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBLENBQUNBO1FBQ3hGQSxNQUFNQSxDQUFDQSxDQUFDQSxDQUFDQTtJQUdiQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxjQUFjQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNuQkEsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsTUFBTUEsQ0FBQ0E7SUFDcEJBLENBQUNBO0lBRURBLElBQUlBLENBQUNBLENBQUNBO1FBQ0ZBLE1BQU1BLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBO0lBQzFDQSxDQUFDQTtBQUNMQSxDQUFDQTtBQWRlLGlCQUFTLFlBY3hCLENBQUE7QUFNRCxpQkFBd0IsTUFBbUIsRUFBRSxxQkFBa0QsRUFBRSxxQkFBa0Q7SUFFL0lDLElBQUlBLE9BQU9BLEdBQVFBLFFBQVFBLENBQUNBO0lBRTVCQSxzQkFBc0JBLENBQWFBO1FBRy9CQyxxQkFBcUJBLElBQUlBLHFCQUFxQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFFbERBLHFCQUFxQkEsSUFBSUEscUJBQXFCQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUVsREEsY0FBY0EsQ0FBQ0EsT0FBT0EsRUFBRUEsV0FBV0EsRUFBRUEscUJBQXFCQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUNsRUEsY0FBY0EsQ0FBQ0EsT0FBT0EsRUFBRUEsU0FBU0EsRUFBRUEsWUFBWUEsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDdkRBLGNBQWNBLENBQUNBLE9BQU9BLEVBQUVBLFdBQVdBLEVBQUVBLFlBQVlBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO0lBQzdEQSxDQUFDQTtJQUVERCxXQUFXQSxDQUFDQSxPQUFPQSxFQUFFQSxXQUFXQSxFQUFFQSxxQkFBcUJBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO0lBQy9EQSxXQUFXQSxDQUFDQSxPQUFPQSxFQUFFQSxTQUFTQSxFQUFFQSxZQUFZQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtJQUNwREEsV0FBV0EsQ0FBQ0EsT0FBT0EsRUFBRUEsV0FBV0EsRUFBRUEsWUFBWUEsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7SUFFdERBLE1BQU1BLENBQUNBLFlBQVlBLENBQUNBO0FBQ3hCQSxDQUFDQTtBQXJCZSxlQUFPLFVBcUJ0QixDQUFBO0FBS0QsK0JBQXNDLE9BQW9CLEVBQUUsUUFBMEM7SUFDbEdFLEVBQUVBLENBQUNBLENBQUNBLGNBQWNBLElBQUlBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBO1FBQzVCQSxXQUFXQSxDQUFDQSxPQUFPQSxFQUFFQSxZQUFZQSxFQUFFQSxVQUFTQSxDQUFrQkE7WUFDMUQsSUFBSSxNQUFNLEdBQUcsQ0FBQyxDQUFDO1lBQ2YsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2pDLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsR0FBRyxNQUFNLENBQUM7Z0JBQ3pDLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsR0FBRyxNQUFNLENBQUM7WUFDN0MsQ0FBQztZQUNELElBQUksQ0FBQyxDQUFDO2dCQUNGLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUM7Z0JBQ2hCLENBQUMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxVQUFVLEdBQUcsTUFBTSxDQUFDO1lBQ3pDLENBQUM7WUFDRCxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDaEIsQ0FBQyxDQUFDQSxDQUFDQTtJQUNQQSxDQUFDQTtJQUNEQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxTQUFTQSxJQUFJQSxPQUFPQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUM1QkEsV0FBV0EsQ0FBQ0EsT0FBT0EsRUFBRUEsT0FBT0EsRUFBRUEsVUFBU0EsQ0FBQ0E7WUFDcEMsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDO1lBQ2xCLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO2dCQUNsQixLQUFLLENBQUMsQ0FBQyxlQUFlO29CQUNsQixDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsQ0FBQztvQkFDbEMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsTUFBTSxHQUFHLE1BQU0sSUFBSSxDQUFDLENBQUM7b0JBQ2xDLEtBQUssQ0FBQztnQkFDVixLQUFLLENBQUMsQ0FBQyxjQUFjLENBQUM7Z0JBQ3RCLEtBQUssQ0FBQyxDQUFDLGNBQWM7b0JBQ2pCLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztvQkFDL0IsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLElBQUksQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO29CQUMvQixLQUFLLENBQUM7WUFDZCxDQUFDO1lBQ0QsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2hCLENBQUMsQ0FBQ0EsQ0FBQ0E7SUFDUEEsQ0FBQ0E7SUFDREEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFFRkEsV0FBV0EsQ0FBQ0EsT0FBT0EsRUFBRUEsZ0JBQWdCQSxFQUFFQSxVQUFTQSxDQUFDQTtZQUM3QyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUM7Z0JBQ3hDLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDL0IsQ0FBQyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUM7WUFDakIsQ0FBQztZQUNELElBQUksQ0FBQyxDQUFDO2dCQUNGLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO2dCQUNiLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUNuQyxDQUFDO1lBQ0QsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ2hCLENBQUMsQ0FBQ0EsQ0FBQ0E7SUFDUEEsQ0FBQ0E7QUFDTEEsQ0FBQ0E7QUE5Q2UsNkJBQXFCLHdCQThDcEMsQ0FBQTtBQUVELG1DQUEwQyxFQUFFLEVBQUUsUUFBUSxFQUFFLFlBQVksRUFBRSxZQUFZO0lBQzlFQyxJQUFJQSxNQUFNQSxHQUFHQSxDQUFDQSxDQUFDQTtJQUNmQSxJQUFJQSxNQUFNQSxFQUFFQSxNQUFNQSxFQUFFQSxLQUFLQSxDQUFDQTtJQUMxQkEsSUFBSUEsVUFBVUEsR0FBR0E7UUFDYkEsQ0FBQ0EsRUFBRUEsVUFBVUE7UUFDYkEsQ0FBQ0EsRUFBRUEsYUFBYUE7UUFDaEJBLENBQUNBLEVBQUVBLFdBQVdBO0tBQ2pCQSxDQUFDQTtJQUVGQSxXQUFXQSxDQUFDQSxFQUFFQSxFQUFFQSxXQUFXQSxFQUFFQSxVQUFTQSxDQUFhQTtRQUMvQyxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNyQixNQUFNLEdBQUcsQ0FBQyxDQUFDO1FBQ2YsQ0FBQztRQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdEIsTUFBTSxFQUFFLENBQUM7WUFDVCxFQUFFLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO2dCQUNYLE1BQU0sR0FBRyxDQUFDLENBQUM7UUFDbkIsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ0osTUFBTSxHQUFHLENBQUMsQ0FBQztRQUNmLENBQUM7UUFDRCxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNqQixJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxPQUFPLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDdEYsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksVUFBVSxDQUFDO2dCQUNyQixNQUFNLEdBQUcsQ0FBQyxDQUFDO1lBQ2YsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDO2dCQUNOLFlBQVksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN4QixLQUFLLEdBQUcsVUFBVSxDQUFDLGNBQWEsS0FBSyxHQUFHLElBQUksQ0FBQSxDQUFDLENBQUMsRUFBRSxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1lBRTdFLEVBQUUsQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNkLE1BQU0sR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDO2dCQUNuQixNQUFNLEdBQUcsQ0FBQyxDQUFDLE9BQU8sQ0FBQztZQUN2QixDQUFDO1FBQ0wsQ0FBQztRQUdELENBQUMsQ0FBQyxTQUFTLENBQUMsR0FBRyxNQUFNLENBQUM7UUFFdEIsWUFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUUzQyxFQUFFLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO1lBQ1gsTUFBTSxHQUFHLENBQUMsQ0FBQztRQUNmLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO1lBQ2hCLE1BQU0sQ0FBQyxZQUFZLENBQUMsWUFBWSxDQUFDLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO0lBQ2pFLENBQUMsQ0FBQ0EsQ0FBQ0E7SUFFSEEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDcEJBLFdBQVdBLENBQUNBLEVBQUVBLEVBQUVBLFVBQVVBLEVBQUVBLFVBQVNBLENBQUNBO1lBQ2xDLE1BQU0sR0FBRyxDQUFDLENBQUM7WUFDWCxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUM7Z0JBQ04sWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3hCLEtBQUssR0FBRyxVQUFVLENBQUMsY0FBYSxLQUFLLEdBQUcsSUFBSSxDQUFBLENBQUMsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUM7WUFDN0UsWUFBWSxDQUFDLFlBQVksQ0FBQyxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUMzQyxZQUFZLENBQUMsWUFBWSxDQUFDLENBQUMsVUFBVSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ3RELENBQUMsQ0FBQ0EsQ0FBQ0E7SUFDUEEsQ0FBQ0E7QUFDTEEsQ0FBQ0E7QUF0RGUsaUNBQXlCLDRCQXNEeEMsQ0FBQTtBQUVELElBQUksZUFBZSxHQUFHLFNBQVMsQ0FBQyxLQUFLLElBQUksU0FBUyxDQUFDLE9BQU8sSUFBSSxDQUFDLENBQUMsZUFBZSxJQUFJLE1BQU0sQ0FBQztNQUNwRixVQUFTLENBQUM7UUFDUixNQUFNLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE9BQU8sR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxRQUFRLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLE9BQU8sR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7SUFDckcsQ0FBQztNQUNDLFVBQVMsQ0FBQztRQUNSLE1BQU0sQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsT0FBTyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLFFBQVEsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsT0FBTyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUNyRyxDQUFDLENBQUM7QUFFTiwyQkFBa0MsQ0FBQztJQUMvQkMsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7QUFDN0NBLENBQUNBO0FBRmUseUJBQWlCLG9CQUVoQyxDQUFBO0FBRUQsOEJBQThCLFFBQVEsRUFBRSxDQUFnQixFQUFFLE9BQWU7SUFDckVDLElBQUlBLE1BQU1BLEdBQUdBLGVBQWVBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO0lBRWhDQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxTQUFTQSxDQUFDQSxLQUFLQSxJQUFJQSxXQUFXQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNsQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsV0FBV0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsSUFBSUEsV0FBV0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0E7WUFDbkNBLE1BQU1BLElBQUlBLENBQUNBLENBQUNBO1FBQ2hCQSxFQUFFQSxDQUFDQSxDQUFDQSxXQUFXQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNwQkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7Z0JBQ2xCQSxXQUFXQSxDQUFDQSxLQUFLQSxHQUFHQSxDQUFDQSxDQUFDQTtZQUMxQkEsSUFBSUE7Z0JBQ0FBLE1BQU1BLENBQUNBO1FBQ2ZBLENBQUNBO1FBQ0RBLEVBQUVBLENBQUNBLENBQUNBLE9BQU9BLEtBQUtBLEVBQUVBLElBQUlBLE9BQU9BLEtBQUtBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1lBQ25DQSxFQUFFQSxDQUFDQSxDQUFDQSxPQUFPQSxLQUFLQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQSxRQUFRQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDckNBLEVBQUVBLEdBQUdBLENBQUNBLENBQUNBLFNBQVNBLENBQUNBO1lBQ3JCQSxDQUFDQTtZQUFDQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxPQUFPQSxLQUFLQSxFQUFFQSxJQUFJQSxNQUFNQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxRQUFRQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDNURBLElBQUlBLEVBQUVBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBO2dCQUNiQSxFQUFFQSxHQUFHQSxDQUFDQSxDQUFDQSxTQUFTQSxDQUFDQTtnQkFDakJBLEVBQUVBLElBQUlBLEVBQUVBLENBQUNBO2dCQUNUQSxFQUFFQSxDQUFDQSxDQUFDQSxFQUFFQSxHQUFHQSxDQUFDQSxDQUFDQTtvQkFDUEEsV0FBV0EsQ0FBQ0EsS0FBS0EsR0FBR0EsSUFBSUEsQ0FBQ0E7WUFDakNBLENBQUNBO1FBQ0xBLENBQUNBO0lBQ0xBLENBQUNBO0lBRURBLEVBQUVBLENBQUNBLENBQUNBLE9BQU9BLElBQUlBLElBQUlBLENBQUNBLGFBQWFBLENBQUNBLENBQUNBLENBQUNBO1FBQ2hDQSxNQUFNQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxhQUFhQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNsQ0EsS0FBS0EsS0FBS0E7Z0JBQ05BLE1BQU1BLEdBQUdBLENBQUNBLENBQUNBO2dCQUNYQSxLQUFLQSxDQUFDQTtZQUNWQSxLQUFLQSxPQUFPQTtnQkFDUkEsTUFBTUEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ1hBLEtBQUtBLENBQUNBO1lBQ1ZBLEtBQUtBLE1BQU1BO2dCQUNQQSxNQUFNQSxHQUFHQSxDQUFDQSxDQUFDQTtnQkFDWEEsS0FBS0EsQ0FBQ0E7WUFDVkE7Z0JBQ0lBLE1BQU1BLEdBQUdBLENBQUNBLENBQUNBO2dCQUNYQSxLQUFLQSxDQUFDQTtRQUNkQSxDQUFDQTtRQUNEQSxPQUFPQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQTtJQUNqQkEsQ0FBQ0E7SUFFREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsR0FBR0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsS0FBS0EsRUFBRUEsSUFBSUEsT0FBT0EsS0FBS0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDbkRBLE9BQU9BLEdBQUdBLENBQUNBLENBQUNBLENBQUNBO0lBQ2pCQSxDQUFDQTtJQUVEQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxNQUFNQSxJQUFJQSxPQUFPQSxLQUFLQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUM1QkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsUUFBUUEsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDbkJBLFFBQVFBLENBQUNBLENBQUNBLEVBQUVBLE1BQU1BLEVBQUVBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBO1lBQzlCQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxnQkFBZ0JBLENBQUNBO2dCQUNuQkEsTUFBTUEsQ0FBQ0E7UUFDZkEsQ0FBQ0E7SUFDTEEsQ0FBQ0E7SUFFREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsVUFBVUEsSUFBSUEsTUFBTUEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDckNBLFFBQVFBLENBQUNBLENBQUNBLEVBQUVBLE1BQU1BLEVBQUVBLE9BQU9BLENBQUNBLENBQUNBO1FBQzdCQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxnQkFBZ0JBLENBQUNBO1lBQ25CQSxNQUFNQSxDQUFDQTtRQUNYQSxJQUFJQTtZQUNBQSxNQUFNQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQTtJQUNyQkEsQ0FBQ0E7SUFLREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsTUFBTUEsSUFBSUEsQ0FBQ0EsQ0FBQ0EsT0FBT0EsSUFBSUEsSUFBSUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsT0FBT0EsSUFBSUEsSUFBSUEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDbkZBLE1BQU1BLENBQUNBLEtBQUtBLENBQUNBO0lBQ2pCQSxDQUFDQTtJQUVEQSxNQUFNQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQSxFQUFFQSxNQUFNQSxFQUFFQSxPQUFPQSxDQUFDQSxDQUFDQTtBQUN4Q0EsQ0FBQ0E7QUFFRCxJQUFJLFdBQVcsR0FBRyxJQUFJLENBQUM7QUFFdkIsMEJBQTBCLENBQUM7SUFDdkJDLFdBQVdBLEdBQUdBLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLENBQUNBO0FBQ3RDQSxDQUFDQTtBQUVELElBQUksRUFBRSxHQUFHLENBQUMsQ0FBQztBQUNYLCtCQUFzQyxFQUFFLEVBQUUsUUFBUTtJQUM5Q0MsRUFBRUEsQ0FBQ0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsVUFBVUEsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsT0FBT0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsZUFBZUEsSUFBSUEsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFPOUVBLElBQUlBLGtCQUFrQkEsR0FBR0EsSUFBSUEsQ0FBQ0E7UUFDOUJBLFdBQVdBLENBQUNBLEVBQUVBLEVBQUVBLFNBQVNBLEVBQUVBLFVBQVNBLENBQWdCQTtZQUNoRCxrQkFBa0IsR0FBRyxDQUFDLENBQUMsT0FBTyxDQUFDO1FBQ25DLENBQUMsQ0FBQ0EsQ0FBQ0E7UUFDSEEsV0FBV0EsQ0FBQ0EsRUFBRUEsRUFBRUEsVUFBVUEsRUFBRUEsVUFBU0EsQ0FBZ0JBO1lBQ2pELE1BQU0sQ0FBQyxvQkFBb0IsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxFQUFFLGtCQUFrQixDQUFDLENBQUM7UUFDakUsQ0FBQyxDQUFDQSxDQUFDQTtJQUNQQSxDQUFDQTtJQUNEQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUNGQSxJQUFJQSxvQkFBb0JBLEdBQUdBLElBQUlBLENBQUNBO1FBRWhDQSxXQUFXQSxDQUFDQSxFQUFFQSxFQUFFQSxTQUFTQSxFQUFFQSxVQUFTQSxDQUFnQkE7WUFDaEQsV0FBVyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsR0FBRyxJQUFJLENBQUM7WUFDOUIsSUFBSSxNQUFNLEdBQUcsb0JBQW9CLENBQUMsUUFBUSxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUM7WUFDMUQsb0JBQW9CLEdBQUcsQ0FBQyxDQUFDLGdCQUFnQixDQUFDO1lBQzFDLE1BQU0sQ0FBQyxNQUFNLENBQUM7UUFDbEIsQ0FBQyxDQUFDQSxDQUFDQTtRQUVIQSxXQUFXQSxDQUFDQSxFQUFFQSxFQUFFQSxVQUFVQSxFQUFFQSxVQUFTQSxDQUFnQkE7WUFDakQsRUFBRSxDQUFDLENBQUMsb0JBQW9CLElBQUksQ0FBQyxDQUFDLENBQUMsT0FBTyxJQUFJLENBQUMsQ0FBQyxNQUFNLElBQUksQ0FBQyxDQUFDLFFBQVEsSUFBSSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUM3RSxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2Isb0JBQW9CLEdBQUcsSUFBSSxDQUFDO1lBQ2hDLENBQUM7UUFDTCxDQUFDLENBQUNBLENBQUNBO1FBRUhBLFdBQVdBLENBQUNBLEVBQUVBLEVBQUVBLE9BQU9BLEVBQUVBLFVBQVNBLENBQWdCQTtZQUM5QyxXQUFXLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxHQUFHLElBQUksQ0FBQztRQUNsQyxDQUFDLENBQUNBLENBQUNBO1FBRUhBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLFdBQVdBLENBQUNBLENBQUNBLENBQUNBO1lBQ2ZBLFdBQVdBLEdBQUdBLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLENBQUNBO1lBQ2xDQSxXQUFXQSxDQUFDQSxNQUFNQSxFQUFFQSxPQUFPQSxFQUFFQSxnQkFBZ0JBLENBQUNBLENBQUNBO1FBQ25EQSxDQUFDQTtJQUNMQSxDQUFDQTtBQUNMQSxDQUFDQTtBQTFDZSw2QkFBcUIsd0JBMENwQyxDQUFBO0FBSUQsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLFdBQVcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO0lBQzNDLElBQUksYUFBYSxHQUFHLENBQUMsQ0FBQztJQUN0QixPQUFPLENBQUMsUUFBUSxHQUFHLFVBQVMsUUFBUSxFQUFFLEdBQUc7UUFDckMsR0FBRyxHQUFHLEdBQUcsSUFBSSxNQUFNLENBQUM7UUFDcEIsSUFBSSxXQUFXLEdBQUcsdUJBQXVCLEdBQUcsYUFBYSxDQUFDO1FBQzFELFdBQVcsQ0FBQyxHQUFHLEVBQUUsU0FBUyxFQUFFLGtCQUFrQixDQUFDO1lBQzNDQyxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxJQUFJQSxJQUFJQSxXQUFXQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDeEJBLGVBQWVBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO2dCQUNuQkEsY0FBY0EsQ0FBQ0EsR0FBR0EsRUFBRUEsU0FBU0EsRUFBRUEsUUFBUUEsQ0FBQ0EsQ0FBQ0E7Z0JBQ3pDQSxRQUFRQSxFQUFFQSxDQUFDQTtZQUNmQSxDQUFDQTtRQUNMQSxDQUFDQSxDQUFDLENBQUM7UUFDSCxHQUFHLENBQUMsV0FBVyxDQUFDLFdBQVcsRUFBRSxHQUFHLENBQUMsQ0FBQztJQUN0QyxDQUFDLENBQUM7QUFDTixDQUFDO0FBR0QsSUFBSSxrQkFBa0IsR0FBb0QsTUFBTSxDQUFDLHFCQUFxQjtJQUNsRyxNQUFNLENBQUMsMEJBQTBCLENBQUM7SUFDbEMsTUFBTSxDQUFDLDZCQUE2QixDQUFDO0lBQ3JDLE1BQU0sQ0FBQyx1QkFBdUI7SUFDOUIsTUFBTSxDQUFDLHdCQUF3QixDQUFDLENBQUM7QUFFckMsRUFBRSxDQUFDLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDO0lBQ3JCLGtCQUFrQixHQUFHLGtCQUFrQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUN6RCxDQUFDO0FBQ0QsSUFBSSxDQUFDLENBQUM7SUFDRixrQkFBa0IsR0FBRyxVQUFTLFFBQVE7UUFDbEMsVUFBVSxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsQ0FBQztJQUM3QixDQUFDLENBQUM7QUFDTixDQUFDO0FBS1UsNkJBQXFCLEdBQW9ELGtCQUFrQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyogKioqKiogQkVHSU4gTElDRU5TRSBCTE9DSyAqKioqKlxuICogRGlzdHJpYnV0ZWQgdW5kZXIgdGhlIEJTRCBsaWNlbnNlOlxuICpcbiAqIENvcHlyaWdodCAoYykgMjAxMCwgQWpheC5vcmcgQi5WLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBSZWRpc3RyaWJ1dGlvbiBhbmQgdXNlIGluIHNvdXJjZSBhbmQgYmluYXJ5IGZvcm1zLCB3aXRoIG9yIHdpdGhvdXRcbiAqIG1vZGlmaWNhdGlvbiwgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OlxuICogICAgICogUmVkaXN0cmlidXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHRcbiAqICAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci5cbiAqICAgICAqIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0XG4gKiAgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIgaW4gdGhlXG4gKiAgICAgICBkb2N1bWVudGF0aW9uIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLlxuICogICAgICogTmVpdGhlciB0aGUgbmFtZSBvZiBBamF4Lm9yZyBCLlYuIG5vciB0aGVcbiAqICAgICAgIG5hbWVzIG9mIGl0cyBjb250cmlidXRvcnMgbWF5IGJlIHVzZWQgdG8gZW5kb3JzZSBvciBwcm9tb3RlIHByb2R1Y3RzXG4gKiAgICAgICBkZXJpdmVkIGZyb20gdGhpcyBzb2Z0d2FyZSB3aXRob3V0IHNwZWNpZmljIHByaW9yIHdyaXR0ZW4gcGVybWlzc2lvbi5cbiAqXG4gKiBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIFRIRSBDT1BZUklHSFQgSE9MREVSUyBBTkQgQ09OVFJJQlVUT1JTIFwiQVMgSVNcIiBBTkRcbiAqIEFOWSBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRSBJTVBMSUVEXG4gKiBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFXG4gKiBESVNDTEFJTUVELiBJTiBOTyBFVkVOVCBTSEFMTCBBSkFYLk9SRyBCLlYuIEJFIExJQUJMRSBGT1IgQU5ZXG4gKiBESVJFQ1QsIElORElSRUNULCBJTkNJREVOVEFMLCBTUEVDSUFMLCBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFU1xuICogKElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRFIEdPT0RTIE9SIFNFUlZJQ0VTO1xuICogTE9TUyBPRiBVU0UsIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTIElOVEVSUlVQVElPTikgSE9XRVZFUiBDQVVTRUQgQU5EXG4gKiBPTiBBTlkgVEhFT1JZIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUIExJQUJJTElUWSwgT1IgVE9SVFxuICogKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZIE9VVCBPRiBUSEUgVVNFIE9GIFRISVNcbiAqIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLlxuICpcbiAqICoqKioqIEVORCBMSUNFTlNFIEJMT0NLICoqKioqICovXG5pbXBvcnQga2V5cyA9IHJlcXVpcmUoXCIuL2tleXNcIik7XG5pbXBvcnQgdXNlcmFnZW50ID0gcmVxdWlyZShcIi4vdXNlcmFnZW50XCIpO1xuXG5leHBvcnQgaW50ZXJmYWNlIExpc3RlbmVyVGFyZ2V0IGV4dGVuZHMgRXZlbnRUYXJnZXQge1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYWRkTGlzdGVuZXIodGFyZ2V0OiBMaXN0ZW5lclRhcmdldCwgdHlwZTogc3RyaW5nLCBjYWxsYmFjaywgdXNlQ2FwdHVyZT86IGJvb2xlYW4pIHtcbiAgICBpZiAodGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIpIHtcbiAgICAgICAgcmV0dXJuIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGNhbGxiYWNrLCBmYWxzZSk7XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVtb3ZlTGlzdGVuZXIodGFyZ2V0OiBMaXN0ZW5lclRhcmdldCwgdHlwZSwgY2FsbGJhY2ssIHVzZUNhcHR1cmU/OiBib29sZWFuKSB7XG4gICAgaWYgKHRhcmdldC5yZW1vdmVFdmVudExpc3RlbmVyKSB7XG4gICAgICAgIHJldHVybiB0YXJnZXQucmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBjYWxsYmFjaywgZmFsc2UpO1xuICAgIH1cbn1cblxuLypcbiogUHJldmVudHMgcHJvcGFnYXRpb24gYW5kIGNsb2JiZXJzIHRoZSBkZWZhdWx0IGFjdGlvbiBvZiB0aGUgcGFzc2VkIGV2ZW50XG4qL1xuZXhwb3J0IGZ1bmN0aW9uIHN0b3BFdmVudChlOiBFdmVudCk6IGJvb2xlYW4ge1xuICAgIHN0b3BQcm9wYWdhdGlvbihlKTtcbiAgICBwcmV2ZW50RGVmYXVsdChlKTtcbiAgICByZXR1cm4gZmFsc2U7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzdG9wUHJvcGFnYXRpb24oZTogRXZlbnQpOiB2b2lkIHtcbiAgICBpZiAoZS5zdG9wUHJvcGFnYXRpb24pIHtcbiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGUuY2FuY2VsQnViYmxlID0gdHJ1ZTtcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwcmV2ZW50RGVmYXVsdChlOiBFdmVudCk6IHZvaWQge1xuICAgIC8vIHJldHVyblZhbHVlIGlzIG5vIGxvbmdlciBkb2N1bWVudGVkIGluIHR5cGluZ3MuXG4gICAgdmFyIFJFVFVSTl9WQUxVRV9ERVBSRUNBVEVEID0gJ3JldHVyblZhbHVlJztcbiAgICBpZiAoZS5wcmV2ZW50RGVmYXVsdCkge1xuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgfVxuICAgIGVsc2UgaWYgKGVbUkVUVVJOX1ZBTFVFX0RFUFJFQ0FURURdKSB7XG4gICAgICAgIGVbUkVUVVJOX1ZBTFVFX0RFUFJFQ0FURURdID0gZmFsc2U7XG4gICAgfVxufVxuXG4vKlxuICogQHJldHVybiB7TnVtYmVyfSAwIGZvciBsZWZ0IGJ1dHRvbiwgMSBmb3IgbWlkZGxlIGJ1dHRvbiwgMiBmb3IgcmlnaHQgYnV0dG9uXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRCdXR0b24oZTogTW91c2VFdmVudCk6IG51bWJlciB7XG4gICAgaWYgKGUudHlwZSA9PSBcImRibGNsaWNrXCIpXG4gICAgICAgIHJldHVybiAwO1xuICAgIGlmIChlLnR5cGUgPT0gXCJjb250ZXh0bWVudVwiIHx8ICh1c2VyYWdlbnQuaXNNYWMgJiYgKGUuY3RybEtleSAmJiAhZS5hbHRLZXkgJiYgIWUuc2hpZnRLZXkpKSlcbiAgICAgICAgcmV0dXJuIDI7XG5cbiAgICAvLyBET00gRXZlbnRcbiAgICBpZiAoZS5wcmV2ZW50RGVmYXVsdCkge1xuICAgICAgICByZXR1cm4gZS5idXR0b247XG4gICAgfVxuICAgIC8vIG9sZCBJRVxuICAgIGVsc2Uge1xuICAgICAgICByZXR1cm4geyAxOiAwLCAyOiAyLCA0OiAxIH1bZS5idXR0b25dO1xuICAgIH1cbn1cblxuLy8gRklYTUU6IFdlIHNob3VsZCBub3QgYmUgYXNzdW1pbmcgdGhlIGRvY3VtZW50IGFzIHdpbmRvdy5kb2N1bWVudCFcbi8qKlxuICogUmV0dXJucyBhIGZ1bmN0aW9uIHdoaWNoIG1heSBiZSB1c2VkIHRvIG1hbnVhbGx5IHJlbGVhc2UgdGhlIG1vdXNlLlxuICovXG5leHBvcnQgZnVuY3Rpb24gY2FwdHVyZSh1bnVzZWQ6IEhUTUxFbGVtZW50LCBhY3F1aXJlQ2FwdHVyZUhhbmRsZXI6IChldmVudDogTW91c2VFdmVudCkgPT4gdm9pZCwgcmVsZWFzZUNhcHR1cmVIYW5kbGVyOiAoZXZlbnQ6IE1vdXNlRXZlbnQpID0+IHZvaWQpOiAoZXZlbnQ6IE1vdXNlRXZlbnQpID0+IHZvaWQge1xuICAgIC8vIEZJWE1FOiAnRG9jdW1lbnQnIGlzIG1pc3NpbmcgcHJvcGVydHkgJ29ubW91c2VsZWF2ZScgZnJvbSAnSFRNTEVsZW1lbnQnLlxuICAgIHZhciBlbGVtZW50OiBhbnkgPSBkb2N1bWVudDtcblxuICAgIGZ1bmN0aW9uIHJlbGVhc2VNb3VzZShlOiBNb3VzZUV2ZW50KSB7XG5cbiAgICAgICAgLy8gSXQgc2VlbXMgcmVkdW5kYW50IGFuZCBjdW1iZXJzb21lIHRvIHByb3ZpZGUgdGhpcyBldmVudCB0byBib3RoIGhhbmRsZXJzP1xuICAgICAgICBhY3F1aXJlQ2FwdHVyZUhhbmRsZXIgJiYgYWNxdWlyZUNhcHR1cmVIYW5kbGVyKGUpO1xuXG4gICAgICAgIHJlbGVhc2VDYXB0dXJlSGFuZGxlciAmJiByZWxlYXNlQ2FwdHVyZUhhbmRsZXIoZSk7XG5cbiAgICAgICAgcmVtb3ZlTGlzdGVuZXIoZWxlbWVudCwgXCJtb3VzZW1vdmVcIiwgYWNxdWlyZUNhcHR1cmVIYW5kbGVyLCB0cnVlKTtcbiAgICAgICAgcmVtb3ZlTGlzdGVuZXIoZWxlbWVudCwgXCJtb3VzZXVwXCIsIHJlbGVhc2VNb3VzZSwgdHJ1ZSk7XG4gICAgICAgIHJlbW92ZUxpc3RlbmVyKGVsZW1lbnQsIFwiZHJhZ3N0YXJ0XCIsIHJlbGVhc2VNb3VzZSwgdHJ1ZSk7XG4gICAgfVxuXG4gICAgYWRkTGlzdGVuZXIoZWxlbWVudCwgXCJtb3VzZW1vdmVcIiwgYWNxdWlyZUNhcHR1cmVIYW5kbGVyLCB0cnVlKTtcbiAgICBhZGRMaXN0ZW5lcihlbGVtZW50LCBcIm1vdXNldXBcIiwgcmVsZWFzZU1vdXNlLCB0cnVlKTtcbiAgICBhZGRMaXN0ZW5lcihlbGVtZW50LCBcImRyYWdzdGFydFwiLCByZWxlYXNlTW91c2UsIHRydWUpO1xuXG4gICAgcmV0dXJuIHJlbGVhc2VNb3VzZTtcbn1cblxuLyoqXG4gKiBBZGRzIGEgcG9ydGFibGUgJ21vdXNld2hlZWwnIFsnd2hlZWwnLCdET00gTW91c2VTY3JvbGwnXSBsaXN0ZW5lciB0byBhbiBlbGVtZW50LlxuICovXG5leHBvcnQgZnVuY3Rpb24gYWRkTW91c2VXaGVlbExpc3RlbmVyKGVsZW1lbnQ6IEhUTUxFbGVtZW50LCBjYWxsYmFjazogKGV2ZW50OiBNb3VzZVdoZWVsRXZlbnQpID0+IHZvaWQpOiB2b2lkIHtcbiAgICBpZiAoXCJvbm1vdXNld2hlZWxcIiBpbiBlbGVtZW50KSB7XG4gICAgICAgIGFkZExpc3RlbmVyKGVsZW1lbnQsIFwibW91c2V3aGVlbFwiLCBmdW5jdGlvbihlOiBNb3VzZVdoZWVsRXZlbnQpIHtcbiAgICAgICAgICAgIHZhciBmYWN0b3IgPSA4O1xuICAgICAgICAgICAgaWYgKGVbJ3doZWVsRGVsdGFYJ10gIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgICAgICAgIGVbJ3doZWVsWCddID0gLWVbJ3doZWVsRGVsdGFYJ10gLyBmYWN0b3I7XG4gICAgICAgICAgICAgICAgZVsnd2hlZWxZJ10gPSAtZVsnd2hlZWxEZWx0YVknXSAvIGZhY3RvcjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGVbJ3doZWVsWCddID0gMDtcbiAgICAgICAgICAgICAgICBlWyd3aGVlbFknXSA9IC1lLndoZWVsRGVsdGEgLyBmYWN0b3I7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYWxsYmFjayhlKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGVsc2UgaWYgKFwib253aGVlbFwiIGluIGVsZW1lbnQpIHtcbiAgICAgICAgYWRkTGlzdGVuZXIoZWxlbWVudCwgXCJ3aGVlbFwiLCBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICB2YXIgZmFjdG9yID0gMC4zNTtcbiAgICAgICAgICAgIHN3aXRjaCAoZS5kZWx0YU1vZGUpIHtcbiAgICAgICAgICAgICAgICBjYXNlIGUuRE9NX0RFTFRBX1BJWEVMOlxuICAgICAgICAgICAgICAgICAgICBlLndoZWVsWCA9IGUuZGVsdGFYICogZmFjdG9yIHx8IDA7XG4gICAgICAgICAgICAgICAgICAgIGUud2hlZWxZID0gZS5kZWx0YVkgKiBmYWN0b3IgfHwgMDtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSBlLkRPTV9ERUxUQV9MSU5FOlxuICAgICAgICAgICAgICAgIGNhc2UgZS5ET01fREVMVEFfUEFHRTpcbiAgICAgICAgICAgICAgICAgICAgZS53aGVlbFggPSAoZS5kZWx0YVggfHwgMCkgKiA1O1xuICAgICAgICAgICAgICAgICAgICBlLndoZWVsWSA9IChlLmRlbHRhWSB8fCAwKSAqIDU7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2FsbGJhY2soZSk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgLy8gVE9ETzogRGVmaW5lIGludGVyZmFjZSBmb3IgRE9NTW91c2VTY3JvbGwuXG4gICAgICAgIGFkZExpc3RlbmVyKGVsZW1lbnQsIFwiRE9NTW91c2VTY3JvbGxcIiwgZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgaWYgKGUuYXhpcyAmJiBlLmF4aXMgPT0gZS5IT1JJWk9OVEFMX0FYSVMpIHtcbiAgICAgICAgICAgICAgICBlLndoZWVsWCA9IChlLmRldGFpbCB8fCAwKSAqIDU7XG4gICAgICAgICAgICAgICAgZS53aGVlbFkgPSAwO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgZS53aGVlbFggPSAwO1xuICAgICAgICAgICAgICAgIGUud2hlZWxZID0gKGUuZGV0YWlsIHx8IDApICogNTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhbGxiYWNrKGUpO1xuICAgICAgICB9KTtcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBhZGRNdWx0aU1vdXNlRG93bkxpc3RlbmVyKGVsLCB0aW1lb3V0cywgZXZlbnRIYW5kbGVyLCBjYWxsYmFja05hbWUpIHtcbiAgICB2YXIgY2xpY2tzID0gMDtcbiAgICB2YXIgc3RhcnRYLCBzdGFydFksIHRpbWVyO1xuICAgIHZhciBldmVudE5hbWVzID0ge1xuICAgICAgICAyOiBcImRibGNsaWNrXCIsXG4gICAgICAgIDM6IFwidHJpcGxlY2xpY2tcIixcbiAgICAgICAgNDogXCJxdWFkY2xpY2tcIlxuICAgIH07XG5cbiAgICBhZGRMaXN0ZW5lcihlbCwgXCJtb3VzZWRvd25cIiwgZnVuY3Rpb24oZTogTW91c2VFdmVudCkge1xuICAgICAgICBpZiAoZ2V0QnV0dG9uKGUpICE9PSAwKSB7XG4gICAgICAgICAgICBjbGlja3MgPSAwO1xuICAgICAgICB9IGVsc2UgaWYgKGUuZGV0YWlsID4gMSkge1xuICAgICAgICAgICAgY2xpY2tzKys7XG4gICAgICAgICAgICBpZiAoY2xpY2tzID4gNClcbiAgICAgICAgICAgICAgICBjbGlja3MgPSAxO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgY2xpY2tzID0gMTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodXNlcmFnZW50LmlzSUUpIHtcbiAgICAgICAgICAgIHZhciBpc05ld0NsaWNrID0gTWF0aC5hYnMoZS5jbGllbnRYIC0gc3RhcnRYKSA+IDUgfHwgTWF0aC5hYnMoZS5jbGllbnRZIC0gc3RhcnRZKSA+IDU7XG4gICAgICAgICAgICBpZiAoIXRpbWVyIHx8IGlzTmV3Q2xpY2spXG4gICAgICAgICAgICAgICAgY2xpY2tzID0gMTtcbiAgICAgICAgICAgIGlmICh0aW1lcilcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXIpO1xuICAgICAgICAgICAgdGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkgeyB0aW1lciA9IG51bGwgfSwgdGltZW91dHNbY2xpY2tzIC0gMV0gfHwgNjAwKTtcblxuICAgICAgICAgICAgaWYgKGNsaWNrcyA9PSAxKSB7XG4gICAgICAgICAgICAgICAgc3RhcnRYID0gZS5jbGllbnRYO1xuICAgICAgICAgICAgICAgIHN0YXJ0WSA9IGUuY2xpZW50WTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFRPRE8uIFRoaXMgY3VzdG9tIHByb3BlcnR5IGlzIG5vdCBwYXJ0IG9mIE1vdXNlRXZlbnQuXG4gICAgICAgIGVbJ19jbGlja3MnXSA9IGNsaWNrcztcblxuICAgICAgICBldmVudEhhbmRsZXJbY2FsbGJhY2tOYW1lXShcIm1vdXNlZG93blwiLCBlKTtcblxuICAgICAgICBpZiAoY2xpY2tzID4gNClcbiAgICAgICAgICAgIGNsaWNrcyA9IDA7XG4gICAgICAgIGVsc2UgaWYgKGNsaWNrcyA+IDEpXG4gICAgICAgICAgICByZXR1cm4gZXZlbnRIYW5kbGVyW2NhbGxiYWNrTmFtZV0oZXZlbnROYW1lc1tjbGlja3NdLCBlKTtcbiAgICB9KTtcblxuICAgIGlmICh1c2VyYWdlbnQuaXNPbGRJRSkge1xuICAgICAgICBhZGRMaXN0ZW5lcihlbCwgXCJkYmxjbGlja1wiLCBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICBjbGlja3MgPSAyO1xuICAgICAgICAgICAgaWYgKHRpbWVyKVxuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XG4gICAgICAgICAgICB0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IHRpbWVyID0gbnVsbCB9LCB0aW1lb3V0c1tjbGlja3MgLSAxXSB8fCA2MDApO1xuICAgICAgICAgICAgZXZlbnRIYW5kbGVyW2NhbGxiYWNrTmFtZV0oXCJtb3VzZWRvd25cIiwgZSk7XG4gICAgICAgICAgICBldmVudEhhbmRsZXJbY2FsbGJhY2tOYW1lXShldmVudE5hbWVzW2NsaWNrc10sIGUpO1xuICAgICAgICB9KTtcbiAgICB9XG59XG5cbnZhciBnZXRNb2RpZmllckhhc2ggPSB1c2VyYWdlbnQuaXNNYWMgJiYgdXNlcmFnZW50LmlzT3BlcmEgJiYgIShcIktleWJvYXJkRXZlbnRcIiBpbiB3aW5kb3cpXG4gICAgPyBmdW5jdGlvbihlKSB7XG4gICAgICAgIHJldHVybiAwIHwgKGUubWV0YUtleSA/IDEgOiAwKSB8IChlLmFsdEtleSA/IDIgOiAwKSB8IChlLnNoaWZ0S2V5ID8gNCA6IDApIHwgKGUuY3RybEtleSA/IDggOiAwKTtcbiAgICB9XG4gICAgOiBmdW5jdGlvbihlKSB7XG4gICAgICAgIHJldHVybiAwIHwgKGUuY3RybEtleSA/IDEgOiAwKSB8IChlLmFsdEtleSA/IDIgOiAwKSB8IChlLnNoaWZ0S2V5ID8gNCA6IDApIHwgKGUubWV0YUtleSA/IDggOiAwKTtcbiAgICB9O1xuXG5leHBvcnQgZnVuY3Rpb24gZ2V0TW9kaWZpZXJTdHJpbmcoZSkge1xuICAgIHJldHVybiBrZXlzLktFWV9NT0RTW2dldE1vZGlmaWVySGFzaChlKV07XG59XG5cbmZ1bmN0aW9uIG5vcm1hbGl6ZUNvbW1hbmRLZXlzKGNhbGxiYWNrLCBlOiBLZXlib2FyZEV2ZW50LCBrZXlDb2RlOiBudW1iZXIpIHtcbiAgICB2YXIgaGFzaElkID0gZ2V0TW9kaWZpZXJIYXNoKGUpO1xuXG4gICAgaWYgKCF1c2VyYWdlbnQuaXNNYWMgJiYgcHJlc3NlZEtleXMpIHtcbiAgICAgICAgaWYgKHByZXNzZWRLZXlzWzkxXSB8fCBwcmVzc2VkS2V5c1s5Ml0pXG4gICAgICAgICAgICBoYXNoSWQgfD0gODtcbiAgICAgICAgaWYgKHByZXNzZWRLZXlzLmFsdEdyKSB7XG4gICAgICAgICAgICBpZiAoKDMgJiBoYXNoSWQpICE9IDMpXG4gICAgICAgICAgICAgICAgcHJlc3NlZEtleXMuYWx0R3IgPSAwO1xuICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoa2V5Q29kZSA9PT0gMTggfHwga2V5Q29kZSA9PT0gMTcpIHtcbiAgICAgICAgICAgIGlmIChrZXlDb2RlID09PSAxNyAmJiBlLmxvY2F0aW9uID09PSAxKSB7XG4gICAgICAgICAgICAgICAgdHMgPSBlLnRpbWVTdGFtcDtcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5Q29kZSA9PT0gMTggJiYgaGFzaElkID09PSAzICYmIGUubG9jYXRpb24gPT09IDIpIHtcbiAgICAgICAgICAgICAgICB2YXIgZHQgPSAtdHM7XG4gICAgICAgICAgICAgICAgdHMgPSBlLnRpbWVTdGFtcDtcbiAgICAgICAgICAgICAgICBkdCArPSB0cztcbiAgICAgICAgICAgICAgICBpZiAoZHQgPCAzKVxuICAgICAgICAgICAgICAgICAgICBwcmVzc2VkS2V5cy5hbHRHciA9IHRydWU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoa2V5Q29kZSBpbiBrZXlzLk1PRElGSUVSX0tFWVMpIHtcbiAgICAgICAgc3dpdGNoIChrZXlzLk1PRElGSUVSX0tFWVNba2V5Q29kZV0pIHtcbiAgICAgICAgICAgIGNhc2UgXCJBbHRcIjpcbiAgICAgICAgICAgICAgICBoYXNoSWQgPSAyO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBcIlNoaWZ0XCI6XG4gICAgICAgICAgICAgICAgaGFzaElkID0gNDtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgXCJDdHJsXCI6XG4gICAgICAgICAgICAgICAgaGFzaElkID0gMTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgaGFzaElkID0gODtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBrZXlDb2RlID0gLTE7XG4gICAgfVxuXG4gICAgaWYgKGhhc2hJZCAmIDggJiYgKGtleUNvZGUgPT09IDkxIHx8IGtleUNvZGUgPT09IDkzKSkge1xuICAgICAgICBrZXlDb2RlID0gLTE7XG4gICAgfVxuXG4gICAgaWYgKCFoYXNoSWQgJiYga2V5Q29kZSA9PT0gMTMpIHtcbiAgICAgICAgaWYgKGUubG9jYXRpb24gPT09IDMpIHtcbiAgICAgICAgICAgIGNhbGxiYWNrKGUsIGhhc2hJZCwgLWtleUNvZGUpO1xuICAgICAgICAgICAgaWYgKGUuZGVmYXVsdFByZXZlbnRlZClcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodXNlcmFnZW50LmlzQ2hyb21lT1MgJiYgaGFzaElkICYgOCkge1xuICAgICAgICBjYWxsYmFjayhlLCBoYXNoSWQsIGtleUNvZGUpO1xuICAgICAgICBpZiAoZS5kZWZhdWx0UHJldmVudGVkKVxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICBlbHNlXG4gICAgICAgICAgICBoYXNoSWQgJj0gfjg7XG4gICAgfVxuXG4gICAgLy8gSWYgdGhlcmUgaXMgbm8gaGFzaElkIGFuZCB0aGUga2V5Q29kZSBpcyBub3QgYSBmdW5jdGlvbiBrZXksIHRoZW5cbiAgICAvLyB3ZSBkb24ndCBjYWxsIHRoZSBjYWxsYmFjayBhcyB3ZSBkb24ndCBoYW5kbGUgYSBjb21tYW5kIGtleSBoZXJlXG4gICAgLy8gKGl0J3MgYSBub3JtYWwga2V5L2NoYXJhY3RlciBpbnB1dCkuXG4gICAgaWYgKCFoYXNoSWQgJiYgIShrZXlDb2RlIGluIGtleXMuRlVOQ1RJT05fS0VZUykgJiYgIShrZXlDb2RlIGluIGtleXMuUFJJTlRBQkxFX0tFWVMpKSB7XG4gICAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICByZXR1cm4gY2FsbGJhY2soZSwgaGFzaElkLCBrZXlDb2RlKTtcbn1cblxudmFyIHByZXNzZWRLZXlzID0gbnVsbDtcblxuZnVuY3Rpb24gcmVzZXRQcmVzc2VkS2V5cyhlKSB7XG4gICAgcHJlc3NlZEtleXMgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xufVxuXG52YXIgdHMgPSAwO1xuZXhwb3J0IGZ1bmN0aW9uIGFkZENvbW1hbmRLZXlMaXN0ZW5lcihlbCwgY2FsbGJhY2spIHtcbiAgICBpZiAodXNlcmFnZW50LmlzT2xkR2Vja28gfHwgKHVzZXJhZ2VudC5pc09wZXJhICYmICEoXCJLZXlib2FyZEV2ZW50XCIgaW4gd2luZG93KSkpIHtcbiAgICAgICAgLy8gT2xkIHZlcnNpb25zIG9mIEdlY2tvIGFrYS4gRmlyZWZveCA8IDQuMCBkaWRuJ3QgcmVwZWF0IHRoZSBrZXlkb3duXG4gICAgICAgIC8vIGV2ZW50IGlmIHRoZSB1c2VyIHByZXNzZWQgdGhlIGtleSBmb3IgYSBsb25nZXIgdGltZS4gSW5zdGVhZCwgdGhlXG4gICAgICAgIC8vIGtleWRvd24gZXZlbnQgd2FzIGZpcmVkIG9uY2UgYW5kIGxhdGVyIG9uIG9ubHkgdGhlIGtleXByZXNzIGV2ZW50LlxuICAgICAgICAvLyBUbyBlbXVsYXRlIHRoZSAncmlnaHQnIGtleWRvd24gYmVoYXZpb3IsIHRoZSBrZXlDb2RlIG9mIHRoZSBpbml0aWFsXG4gICAgICAgIC8vIGtleURvd24gZXZlbnQgaXMgc3RvcmVkIGFuZCBpbiB0aGUgZm9sbG93aW5nIGtleXByZXNzIGV2ZW50cyB0aGVcbiAgICAgICAgLy8gc3RvcmVzIGtleUNvZGUgaXMgdXNlZCB0byBlbXVsYXRlIGEga2V5RG93biBldmVudC5cbiAgICAgICAgdmFyIGxhc3RLZXlEb3duS2V5Q29kZSA9IG51bGw7XG4gICAgICAgIGFkZExpc3RlbmVyKGVsLCBcImtleWRvd25cIiwgZnVuY3Rpb24oZTogS2V5Ym9hcmRFdmVudCkge1xuICAgICAgICAgICAgbGFzdEtleURvd25LZXlDb2RlID0gZS5rZXlDb2RlO1xuICAgICAgICB9KTtcbiAgICAgICAgYWRkTGlzdGVuZXIoZWwsIFwia2V5cHJlc3NcIiwgZnVuY3Rpb24oZTogS2V5Ym9hcmRFdmVudCkge1xuICAgICAgICAgICAgcmV0dXJuIG5vcm1hbGl6ZUNvbW1hbmRLZXlzKGNhbGxiYWNrLCBlLCBsYXN0S2V5RG93bktleUNvZGUpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIHZhciBsYXN0RGVmYXVsdFByZXZlbnRlZCA9IG51bGw7XG5cbiAgICAgICAgYWRkTGlzdGVuZXIoZWwsIFwia2V5ZG93blwiLCBmdW5jdGlvbihlOiBLZXlib2FyZEV2ZW50KSB7XG4gICAgICAgICAgICBwcmVzc2VkS2V5c1tlLmtleUNvZGVdID0gdHJ1ZTtcbiAgICAgICAgICAgIHZhciByZXN1bHQgPSBub3JtYWxpemVDb21tYW5kS2V5cyhjYWxsYmFjaywgZSwgZS5rZXlDb2RlKTtcbiAgICAgICAgICAgIGxhc3REZWZhdWx0UHJldmVudGVkID0gZS5kZWZhdWx0UHJldmVudGVkO1xuICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgYWRkTGlzdGVuZXIoZWwsICdrZXlwcmVzcycsIGZ1bmN0aW9uKGU6IEtleWJvYXJkRXZlbnQpIHtcbiAgICAgICAgICAgIGlmIChsYXN0RGVmYXVsdFByZXZlbnRlZCAmJiAoZS5jdHJsS2V5IHx8IGUuYWx0S2V5IHx8IGUuc2hpZnRLZXkgfHwgZS5tZXRhS2V5KSkge1xuICAgICAgICAgICAgICAgIHN0b3BFdmVudChlKTtcbiAgICAgICAgICAgICAgICBsYXN0RGVmYXVsdFByZXZlbnRlZCA9IG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuXG4gICAgICAgIGFkZExpc3RlbmVyKGVsLCAna2V5dXAnLCBmdW5jdGlvbihlOiBLZXlib2FyZEV2ZW50KSB7XG4gICAgICAgICAgICBwcmVzc2VkS2V5c1tlLmtleUNvZGVdID0gbnVsbDtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgaWYgKCFwcmVzc2VkS2V5cykge1xuICAgICAgICAgICAgcHJlc3NlZEtleXMgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuICAgICAgICAgICAgYWRkTGlzdGVuZXIod2luZG93LCAnZm9jdXMnLCByZXNldFByZXNzZWRLZXlzKTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuLy8gRklYTUU6IENvbmRpdGlvbmFsIGV4cG9ydHMgbm90IHN1cHBvcnRlZCBieSBUeXBlU2NyaXB0IG9yIEhhcm1vbnkvRVM2LlxuZGVjbGFyZSB2YXIgZXhwb3J0czogYW55O1xuaWYgKHdpbmRvdy5wb3N0TWVzc2FnZSAmJiAhdXNlcmFnZW50LmlzT2xkSUUpIHtcbiAgICB2YXIgcG9zdE1lc3NhZ2VJZCA9IDE7XG4gICAgZXhwb3J0cy5uZXh0VGljayA9IGZ1bmN0aW9uKGNhbGxiYWNrLCB3aW4pIHtcbiAgICAgICAgd2luID0gd2luIHx8IHdpbmRvdztcbiAgICAgICAgdmFyIG1lc3NhZ2VOYW1lID0gXCJ6ZXJvLXRpbWVvdXQtbWVzc2FnZS1cIiArIHBvc3RNZXNzYWdlSWQ7XG4gICAgICAgIGFkZExpc3RlbmVyKHdpbiwgXCJtZXNzYWdlXCIsIGZ1bmN0aW9uIGxpc3RlbmVyKGUpIHtcbiAgICAgICAgICAgIGlmIChlLmRhdGEgPT0gbWVzc2FnZU5hbWUpIHtcbiAgICAgICAgICAgICAgICBzdG9wUHJvcGFnYXRpb24oZSk7XG4gICAgICAgICAgICAgICAgcmVtb3ZlTGlzdGVuZXIod2luLCBcIm1lc3NhZ2VcIiwgbGlzdGVuZXIpO1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB3aW4ucG9zdE1lc3NhZ2UobWVzc2FnZU5hbWUsIFwiKlwiKTtcbiAgICB9O1xufVxuXG5cbnZhciBuZXh0RnJhbWVDYW5kaWRhdGU6IChjYWxsYmFjazogKCkgPT4gdm9pZCwgJHdpbmRvdzogV2luZG93KSA9PiB2b2lkID0gd2luZG93LnJlcXVlc3RBbmltYXRpb25GcmFtZSB8fFxuICAgIHdpbmRvd1snbW96UmVxdWVzdEFuaW1hdGlvbkZyYW1lJ10gfHxcbiAgICB3aW5kb3dbJ3dlYmtpdFJlcXVlc3RBbmltYXRpb25GcmFtZSddIHx8XG4gICAgd2luZG93Lm1zUmVxdWVzdEFuaW1hdGlvbkZyYW1lIHx8XG4gICAgd2luZG93WydvUmVxdWVzdEFuaW1hdGlvbkZyYW1lJ107XG5cbmlmIChuZXh0RnJhbWVDYW5kaWRhdGUpIHtcbiAgICBuZXh0RnJhbWVDYW5kaWRhdGUgPSBuZXh0RnJhbWVDYW5kaWRhdGUuYmluZCh3aW5kb3cpO1xufVxuZWxzZSB7XG4gICAgbmV4dEZyYW1lQ2FuZGlkYXRlID0gZnVuY3Rpb24oY2FsbGJhY2spIHtcbiAgICAgICAgc2V0VGltZW91dChjYWxsYmFjaywgMTcpO1xuICAgIH07XG59XG5cbi8qKlxuICogQSBiYWNrd2FyZHMtY29tcGF0aWJsZSwgYnJvd3Nlci1uZXV0cmFsLCByZXF1ZXN0QW5pbWF0aW9uRnJhbWUuXG4gKi9cbmV4cG9ydCB2YXIgcmVxdWVzdEFuaW1hdGlvbkZyYW1lOiAoY2FsbGJhY2s6ICgpID0+IHZvaWQsICR3aW5kb3c6IFdpbmRvdykgPT4gdm9pZCA9IG5leHRGcmFtZUNhbmRpZGF0ZTtcbiJdfQ==