import { FUNCTION_KEYS, KEY_MODS, MODIFIER_KEYS, PRINTABLE_KEYS } from './keys';
import { isChromeOS, isIE, isMac, isOldGecko, isOldIE, isOpera } from './useragent';
export function addListener(target, type, callback, useCapture) {
    if (target.addEventListener) {
        return target.addEventListener(type, callback, false);
    }
}
export function removeListener(target, type, callback, useCapture) {
    if (target.removeEventListener) {
        return target.removeEventListener(type, callback, false);
    }
}
export function stopEvent(e) {
    stopPropagation(e);
    preventDefault(e);
    return false;
}
export function stopPropagation(e) {
    if (e.stopPropagation) {
        e.stopPropagation();
    }
    else {
        e.cancelBubble = true;
    }
}
export function preventDefault(e) {
    var RETURN_VALUE_DEPRECATED = 'returnValue';
    if (e.preventDefault) {
        e.preventDefault();
    }
    else if (e[RETURN_VALUE_DEPRECATED]) {
        e[RETURN_VALUE_DEPRECATED] = false;
    }
}
export function getButton(e) {
    if (e.type == "dblclick")
        return 0;
    if (e.type == "contextmenu" || (isMac && (e.ctrlKey && !e.altKey && !e.shiftKey)))
        return 2;
    if (e.preventDefault) {
        return e.button;
    }
    else {
        return { 1: 0, 2: 2, 4: 1 }[e.button];
    }
}
export function capture(unused, acquireCaptureHandler, releaseCaptureHandler) {
    var element = document;
    function releaseMouse(e) {
        acquireCaptureHandler && acquireCaptureHandler(e);
        releaseCaptureHandler && releaseCaptureHandler(e);
        removeListener(element, "mousemove", acquireCaptureHandler, true);
        removeListener(element, "mouseup", releaseMouse, true);
        removeListener(element, "dragstart", releaseMouse, true);
    }
    addListener(element, "mousemove", acquireCaptureHandler, true);
    addListener(element, "mouseup", releaseMouse, true);
    addListener(element, "dragstart", releaseMouse, true);
    return releaseMouse;
}
export function addMouseWheelListener(element, callback) {
    if ("onmousewheel" in element) {
        addListener(element, "mousewheel", function (e) {
            var factor = 8;
            if (e['wheelDeltaX'] !== undefined) {
                e['wheelX'] = -e['wheelDeltaX'] / factor;
                e['wheelY'] = -e['wheelDeltaY'] / factor;
            }
            else {
                e['wheelX'] = 0;
                e['wheelY'] = -e.wheelDelta / factor;
            }
            callback(e);
        });
    }
    else if ("onwheel" in element) {
        addListener(element, "wheel", function (e) {
            var factor = 0.35;
            switch (e.deltaMode) {
                case e.DOM_DELTA_PIXEL:
                    e.wheelX = e.deltaX * factor || 0;
                    e.wheelY = e.deltaY * factor || 0;
                    break;
                case e.DOM_DELTA_LINE:
                case e.DOM_DELTA_PAGE:
                    e.wheelX = (e.deltaX || 0) * 5;
                    e.wheelY = (e.deltaY || 0) * 5;
                    break;
            }
            callback(e);
        });
    }
    else {
        addListener(element, "DOMMouseScroll", function (e) {
            if (e.axis && e.axis == e.HORIZONTAL_AXIS) {
                e.wheelX = (e.detail || 0) * 5;
                e.wheelY = 0;
            }
            else {
                e.wheelX = 0;
                e.wheelY = (e.detail || 0) * 5;
            }
            callback(e);
        });
    }
}
export function addMultiMouseDownListener(el, timeouts, eventHandler, callbackName) {
    var clicks = 0;
    var startX, startY, timer;
    var eventNames = {
        2: "dblclick",
        3: "tripleclick",
        4: "quadclick"
    };
    addListener(el, "mousedown", function (e) {
        if (getButton(e) !== 0) {
            clicks = 0;
        }
        else if (e.detail > 1) {
            clicks++;
            if (clicks > 4)
                clicks = 1;
        }
        else {
            clicks = 1;
        }
        if (isIE) {
            var isNewClick = Math.abs(e.clientX - startX) > 5 || Math.abs(e.clientY - startY) > 5;
            if (!timer || isNewClick)
                clicks = 1;
            if (timer)
                clearTimeout(timer);
            timer = setTimeout(function () { timer = null; }, timeouts[clicks - 1] || 600);
            if (clicks == 1) {
                startX = e.clientX;
                startY = e.clientY;
            }
        }
        e['_clicks'] = clicks;
        eventHandler[callbackName]("mousedown", e);
        if (clicks > 4)
            clicks = 0;
        else if (clicks > 1)
            return eventHandler[callbackName](eventNames[clicks], e);
    });
    if (isOldIE) {
        addListener(el, "dblclick", function (e) {
            clicks = 2;
            if (timer)
                clearTimeout(timer);
            timer = setTimeout(function () { timer = null; }, timeouts[clicks - 1] || 600);
            eventHandler[callbackName]("mousedown", e);
            eventHandler[callbackName](eventNames[clicks], e);
        });
    }
}
var getModifierHash = isMac && isOpera && !("KeyboardEvent" in window)
    ? function (e) {
        return 0 | (e.metaKey ? 1 : 0) | (e.altKey ? 2 : 0) | (e.shiftKey ? 4 : 0) | (e.ctrlKey ? 8 : 0);
    }
    : function (e) {
        return 0 | (e.ctrlKey ? 1 : 0) | (e.altKey ? 2 : 0) | (e.shiftKey ? 4 : 0) | (e.metaKey ? 8 : 0);
    };
export function getModifierString(e) {
    return KEY_MODS[getModifierHash(e)];
}
function normalizeCommandKeys(callback, e, keyCode) {
    var hashId = getModifierHash(e);
    if (!isMac && pressedKeys) {
        if (pressedKeys[91] || pressedKeys[92])
            hashId |= 8;
        if (pressedKeys.altGr) {
            if ((3 & hashId) != 3)
                pressedKeys.altGr = 0;
            else
                return;
        }
        if (keyCode === 18 || keyCode === 17) {
            if (keyCode === 17 && e.location === 1) {
                ts = e.timeStamp;
            }
            else if (keyCode === 18 && hashId === 3 && e.location === 2) {
                var dt = -ts;
                ts = e.timeStamp;
                dt += ts;
                if (dt < 3)
                    pressedKeys.altGr = true;
            }
        }
    }
    if (keyCode in MODIFIER_KEYS) {
        switch (MODIFIER_KEYS[keyCode]) {
            case "Alt":
                hashId = 2;
                break;
            case "Shift":
                hashId = 4;
                break;
            case "Ctrl":
                hashId = 1;
                break;
            default:
                hashId = 8;
                break;
        }
        keyCode = -1;
    }
    if (hashId & 8 && (keyCode === 91 || keyCode === 93)) {
        keyCode = -1;
    }
    if (!hashId && keyCode === 13) {
        if (e.location === 3) {
            callback(e, hashId, -keyCode);
            if (e.defaultPrevented)
                return;
        }
    }
    if (isChromeOS && hashId & 8) {
        callback(e, hashId, keyCode);
        if (e.defaultPrevented)
            return;
        else
            hashId &= ~8;
    }
    if (!hashId && !(keyCode in FUNCTION_KEYS) && !(keyCode in PRINTABLE_KEYS)) {
        return false;
    }
    return callback(e, hashId, keyCode);
}
var pressedKeys = null;
function resetPressedKeys(e) {
    pressedKeys = Object.create(null);
}
var ts = 0;
export function addCommandKeyListener(el, callback) {
    if (isOldGecko || (isOpera && !("KeyboardEvent" in window))) {
        var lastKeyDownKeyCode = null;
        addListener(el, "keydown", function (e) {
            lastKeyDownKeyCode = e.keyCode;
        });
        addListener(el, "keypress", function (e) {
            return normalizeCommandKeys(callback, e, lastKeyDownKeyCode);
        });
    }
    else {
        var lastDefaultPrevented = null;
        addListener(el, "keydown", function (e) {
            pressedKeys[e.keyCode] = true;
            var result = normalizeCommandKeys(callback, e, e.keyCode);
            lastDefaultPrevented = e.defaultPrevented;
            return result;
        });
        addListener(el, 'keypress', function (e) {
            if (lastDefaultPrevented && (e.ctrlKey || e.altKey || e.shiftKey || e.metaKey)) {
                stopEvent(e);
                lastDefaultPrevented = null;
            }
        });
        addListener(el, 'keyup', function (e) {
            pressedKeys[e.keyCode] = null;
        });
        if (!pressedKeys) {
            pressedKeys = Object.create(null);
            addListener(window, 'focus', resetPressedKeys);
        }
    }
}
var nextFrameCandidate = window.requestAnimationFrame ||
    window['mozRequestAnimationFrame'] ||
    window['webkitRequestAnimationFrame'] ||
    window.msRequestAnimationFrame ||
    window['oRequestAnimationFrame'];
if (nextFrameCandidate) {
    nextFrameCandidate = nextFrameCandidate.bind(window);
}
else {
    nextFrameCandidate = function (callback) {
        setTimeout(callback, 17);
    };
}
export var requestAnimationFrame = nextFrameCandidate;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZXZlbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvbGliL2V2ZW50LnRzIl0sIm5hbWVzIjpbImFkZExpc3RlbmVyIiwicmVtb3ZlTGlzdGVuZXIiLCJzdG9wRXZlbnQiLCJzdG9wUHJvcGFnYXRpb24iLCJwcmV2ZW50RGVmYXVsdCIsImdldEJ1dHRvbiIsImNhcHR1cmUiLCJjYXB0dXJlLnJlbGVhc2VNb3VzZSIsImFkZE1vdXNlV2hlZWxMaXN0ZW5lciIsImFkZE11bHRpTW91c2VEb3duTGlzdGVuZXIiLCJnZXRNb2RpZmllclN0cmluZyIsIm5vcm1hbGl6ZUNvbW1hbmRLZXlzIiwicmVzZXRQcmVzc2VkS2V5cyIsImFkZENvbW1hbmRLZXlMaXN0ZW5lciJdLCJtYXBwaW5ncyI6Ik9BNkJPLEVBQUUsYUFBYSxFQUFFLFFBQVEsRUFBRSxhQUFhLEVBQUUsY0FBYyxFQUFFLE1BQU0sUUFBUTtPQUN4RSxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLFVBQVUsRUFBRSxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sYUFBYTtBQUtuRiw0QkFBNEIsTUFBc0IsRUFBRSxJQUFZLEVBQUUsUUFBUSxFQUFFLFVBQW9CO0lBQzVGQSxFQUFFQSxDQUFDQSxDQUFDQSxNQUFNQSxDQUFDQSxnQkFBZ0JBLENBQUNBLENBQUNBLENBQUNBO1FBQzFCQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQSxnQkFBZ0JBLENBQUNBLElBQUlBLEVBQUVBLFFBQVFBLEVBQUVBLEtBQUtBLENBQUNBLENBQUNBO0lBQzFEQSxDQUFDQTtBQUNMQSxDQUFDQTtBQUVELCtCQUErQixNQUFzQixFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsVUFBb0I7SUFDdkZDLEVBQUVBLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLG1CQUFtQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDN0JBLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLG1CQUFtQkEsQ0FBQ0EsSUFBSUEsRUFB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Q0FBQ0E7SUFFREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsR0FBR0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsS0FBS0EsRUFBRUEsSUFBSUEsT0FBT0EsS0FBS0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDbkRBLE9BQU9BLEdBQUdBLENBQUNBLENBQUNBLENBQUNBO0lBQ2pCQSxDQUFDQTtJQUVEQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxNQUFNQSxJQUFJQSxPQUFPQSxLQUFLQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUM1QkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsUUFBUUEsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDbkJBLFFBQVFBLENBQUNBLENBQUNBLEVBQUVBLE1BQU1BLEVBQUVBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBO1lBQzlCQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxnQkFBZ0JBLENBQUNBO2dCQUNuQkEsTUFBTUEsQ0FBQ0E7UUFDZkEsQ0FBQ0E7SUFDTEEsQ0FBQ0E7SUFFREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsVUFBVUEsSUFBSUEsTUFBTUEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDM0JBLFFBQVFBLENBQUNBLENBQUNBLEVBQUVBLE1BQU1BLEVBQUVBLE9BQU9BLENBQUNBLENBQUNBO1FBQzdCQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxnQkFBZ0JBLENBQUNBO1lBQ25CQSxNQUFNQSxDQUFDQTtRQUNYQSxJQUFJQTtZQUNBQSxNQUFNQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQTtJQUNyQkEsQ0FBQ0E7SUFLREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsTUFBTUEsSUFBSUEsQ0FBQ0EsQ0FBQ0EsT0FBT0EsSUFBSUEsYUFBYUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsT0FBT0EsSUFBSUEsY0FBY0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDekVBLE1B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QUF1QjtJQUM5QixNQUFNLENBQUMsd0JBQXdCLENBQUMsQ0FBQztBQUVyQyxFQUFFLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUM7SUFDckIsa0JBQWtCLEdBQUcsa0JBQWtCLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0FBQ3pELENBQUM7QUFDRCxJQUFJLENBQUMsQ0FBQztJQUNGLGtCQUFrQixHQUFHLFVBQVMsUUFBUTtRQUNsQyxVQUFVLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQzdCLENBQUMsQ0FBQztBQUNOLENBQUM7QUFLRCxXQUFXLHFCQUFxQixHQUFvRCxrQkFBa0IsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8qICoqKioqIEJFR0lOIExJQ0VOU0UgQkxPQ0sgKioqKipcbiAqIERpc3RyaWJ1dGVkIHVuZGVyIHRoZSBCU0QgbGljZW5zZTpcbiAqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTAsIEFqYXgub3JnIEIuVi5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0XG4gKiBtb2RpZmljYXRpb24sIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMgYXJlIG1ldDpcbiAqICAgICAqIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0XG4gKiAgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuXG4gKiAgICAgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodFxuICogICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZVxuICogICAgICAgZG9jdW1lbnRhdGlvbiBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi5cbiAqICAgICAqIE5laXRoZXIgdGhlIG5hbWUgb2YgQWpheC5vcmcgQi5WLiBub3IgdGhlXG4gKiAgICAgICBuYW1lcyBvZiBpdHMgY29udHJpYnV0b3JzIG1heSBiZSB1c2VkIHRvIGVuZG9yc2Ugb3IgcHJvbW90ZSBwcm9kdWN0c1xuICogICAgICAgZGVyaXZlZCBmcm9tIHRoaXMgc29mdHdhcmUgd2l0aG91dCBzcGVjaWZpYyBwcmlvciB3cml0dGVuIHBlcm1pc3Npb24uXG4gKlxuICogVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQ09QWVJJR0hUIEhPTERFUlMgQU5EIENPTlRSSUJVVE9SUyBcIkFTIElTXCIgQU5EXG4gKiBBTlkgRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUgSU1QTElFRFxuICogV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkgQU5EIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFSRVxuICogRElTQ0xBSU1FRC4gSU4gTk8gRVZFTlQgU0hBTEwgQUpBWC5PUkcgQi5WLiBCRSBMSUFCTEUgRk9SIEFOWVxuICogRElSRUNULCBJTkRJUkVDVCwgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVNcbiAqIChJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUztcbiAqIExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORFxuICogT04gQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVCBMSUFCSUxJVFksIE9SIFRPUlRcbiAqIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFIFVTRSBPRiBUSElTXG4gKiBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS5cbiAqXG4gKiAqKioqKiBFTkQgTElDRU5TRSBCTE9DSyAqKioqKiAqL1xuaW1wb3J0IHsgRlVOQ1RJT05fS0VZUywgS0VZX01PRFMsIE1PRElGSUVSX0tFWVMsIFBSSU5UQUJMRV9LRVlTIH0gZnJvbSAnLi9rZXlzJztcbmltcG9ydCB7IGlzQ2hyb21lT1MsIGlzSUUsIGlzTWFjLCBpc09sZEdlY2tvLCBpc09sZElFLCBpc09wZXJhIH0gZnJvbSAnLi91c2VyYWdlbnQnO1xuXG5leHBvcnQgaW50ZXJmYWNlIExpc3RlbmVyVGFyZ2V0IGV4dGVuZHMgRXZlbnRUYXJnZXQge1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYWRkTGlzdGVuZXIodGFyZ2V0OiBMaXN0ZW5lclRhcmdldCwgdHlwZTogc3RyaW5nLCBjYWxsYmFjaywgdXNlQ2FwdHVyZT86IGJvb2xlYW4pIHtcbiAgICBpZiAodGFyZ2V0LmFkZEV2ZW50TGlzdGVuZXIpIHtcbiAgICAgICAgcmV0dXJuIHRhcmdldC5hZGRFdmVudExpc3RlbmVyKHR5cGUsIGNhbGxiYWNrLCBmYWxzZSk7XG4gICAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVtb3ZlTGlzdGVuZXIodGFyZ2V0OiBMaXN0ZW5lclRhcmdldCwgdHlwZSwgY2FsbGJhY2ssIHVzZUNhcHR1cmU/OiBib29sZWFuKSB7XG4gICAgaWYgKHRhcmdldC5yZW1vdmVFdmVudExpc3RlbmVyKSB7XG4gICAgICAgIHJldHVybiB0YXJnZXQucmVtb3ZlRXZlbnRMaXN0ZW5lcih0eXBlLCBjYWxsYmFjaywgZmFsc2UpO1xuICAgIH1cbn1cblxuLypcbiogUHJldmVudHMgcHJvcGFnYXRpb24gYW5kIGNsb2JiZXJzIHRoZSBkZWZhdWx0IGFjdGlvbiBvZiB0aGUgcGFzc2VkIGV2ZW50XG4qL1xuZXhwb3J0IGZ1bmN0aW9uIHN0b3BFdmVudChlOiBFdmVudCk6IGJvb2xlYW4ge1xuICAgIHN0b3BQcm9wYWdhdGlvbihlKTtcbiAgICBwcmV2ZW50RGVmYXVsdChlKTtcbiAgICByZXR1cm4gZmFsc2U7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzdG9wUHJvcGFnYXRpb24oZTogRXZlbnQpOiB2b2lkIHtcbiAgICBpZiAoZS5zdG9wUHJvcGFnYXRpb24pIHtcbiAgICAgICAgZS5zdG9wUHJvcGFnYXRpb24oKTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICAgIGUuY2FuY2VsQnViYmxlID0gdHJ1ZTtcbiAgICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwcmV2ZW50RGVmYXVsdChlOiBFdmVudCk6IHZvaWQge1xuICAgIC8vIHJldHVyblZhbHVlIGlzIG5vIGxvbmdlciBkb2N1bWVudGVkIGluIHR5cGluZ3MuXG4gICAgdmFyIFJFVFVSTl9WQUxVRV9ERVBSRUNBVEVEID0gJ3JldHVyblZhbHVlJztcbiAgICBpZiAoZS5wcmV2ZW50RGVmYXVsdCkge1xuICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gICAgfVxuICAgIGVsc2UgaWYgKGVbUkVUVVJOX1ZBTFVFX0RFUFJFQ0FURURdKSB7XG4gICAgICAgIGVbUkVUVVJOX1ZBTFVFX0RFUFJFQ0FURURdID0gZmFsc2U7XG4gICAgfVxufVxuXG4vKlxuICogQHJldHVybiB7TnVtYmVyfSAwIGZvciBsZWZ0IGJ1dHRvbiwgMSBmb3IgbWlkZGxlIGJ1dHRvbiwgMiBmb3IgcmlnaHQgYnV0dG9uXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZXRCdXR0b24oZTogTW91c2VFdmVudCk6IG51bWJlciB7XG4gICAgaWYgKGUudHlwZSA9PSBcImRibGNsaWNrXCIpXG4gICAgICAgIHJldHVybiAwO1xuICAgIGlmIChlLnR5cGUgPT0gXCJjb250ZXh0bWVudVwiIHx8IChpc01hYyAmJiAoZS5jdHJsS2V5ICYmICFlLmFsdEtleSAmJiAhZS5zaGlmdEtleSkpKVxuICAgICAgICByZXR1cm4gMjtcblxuICAgIC8vIERPTSBFdmVudFxuICAgIGlmIChlLnByZXZlbnREZWZhdWx0KSB7XG4gICAgICAgIHJldHVybiBlLmJ1dHRvbjtcbiAgICB9XG4gICAgLy8gb2xkIElFXG4gICAgZWxzZSB7XG4gICAgICAgIHJldHVybiB7IDE6IDAsIDI6IDIsIDQ6IDEgfVtlLmJ1dHRvbl07XG4gICAgfVxufVxuXG4vLyBGSVhNRTogV2Ugc2hvdWxkIG5vdCBiZSBhc3N1bWluZyB0aGUgZG9jdW1lbnQgYXMgd2luZG93LmRvY3VtZW50IVxuLyoqXG4gKiBSZXR1cm5zIGEgZnVuY3Rpb24gd2hpY2ggbWF5IGJlIHVzZWQgdG8gbWFudWFsbHkgcmVsZWFzZSB0aGUgbW91c2UuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjYXB0dXJlKHVudXNlZDogSFRNTEVsZW1lbnQsIGFjcXVpcmVDYXB0dXJlSGFuZGxlcjogKGV2ZW50OiBNb3VzZUV2ZW50KSA9PiB2b2lkLCByZWxlYXNlQ2FwdHVyZUhhbmRsZXI6IChldmVudDogTW91c2VFdmVudCkgPT4gdm9pZCk6IChldmVudDogTW91c2VFdmVudCkgPT4gdm9pZCB7XG4gICAgLy8gRklYTUU6ICdEb2N1bWVudCcgaXMgbWlzc2luZyBwcm9wZXJ0eSAnb25tb3VzZWxlYXZlJyBmcm9tICdIVE1MRWxlbWVudCcuXG4gICAgdmFyIGVsZW1lbnQ6IGFueSA9IGRvY3VtZW50O1xuXG4gICAgZnVuY3Rpb24gcmVsZWFzZU1vdXNlKGU6IE1vdXNlRXZlbnQpIHtcblxuICAgICAgICAvLyBJdCBzZWVtcyByZWR1bmRhbnQgYW5kIGN1bWJlcnNvbWUgdG8gcHJvdmlkZSB0aGlzIGV2ZW50IHRvIGJvdGggaGFuZGxlcnM/XG4gICAgICAgIGFjcXVpcmVDYXB0dXJlSGFuZGxlciAmJiBhY3F1aXJlQ2FwdHVyZUhhbmRsZXIoZSk7XG5cbiAgICAgICAgcmVsZWFzZUNhcHR1cmVIYW5kbGVyICYmIHJlbGVhc2VDYXB0dXJlSGFuZGxlcihlKTtcblxuICAgICAgICByZW1vdmVMaXN0ZW5lcihlbGVtZW50LCBcIm1vdXNlbW92ZVwiLCBhY3F1aXJlQ2FwdHVyZUhhbmRsZXIsIHRydWUpO1xuICAgICAgICByZW1vdmVMaXN0ZW5lcihlbGVtZW50LCBcIm1vdXNldXBcIiwgcmVsZWFzZU1vdXNlLCB0cnVlKTtcbiAgICAgICAgcmVtb3ZlTGlzdGVuZXIoZWxlbWVudCwgXCJkcmFnc3RhcnRcIiwgcmVsZWFzZU1vdXNlLCB0cnVlKTtcbiAgICB9XG5cbiAgICBhZGRMaXN0ZW5lcihlbGVtZW50LCBcIm1vdXNlbW92ZVwiLCBhY3F1aXJlQ2FwdHVyZUhhbmRsZXIsIHRydWUpO1xuICAgIGFkZExpc3RlbmVyKGVsZW1lbnQsIFwibW91c2V1cFwiLCByZWxlYXNlTW91c2UsIHRydWUpO1xuICAgIGFkZExpc3RlbmVyKGVsZW1lbnQsIFwiZHJhZ3N0YXJ0XCIsIHJlbGVhc2VNb3VzZSwgdHJ1ZSk7XG5cbiAgICByZXR1cm4gcmVsZWFzZU1vdXNlO1xufVxuXG4vKipcbiAqIEFkZHMgYSBwb3J0YWJsZSAnbW91c2V3aGVlbCcgWyd3aGVlbCcsJ0RPTSBNb3VzZVNjcm9sbCddIGxpc3RlbmVyIHRvIGFuIGVsZW1lbnQuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBhZGRNb3VzZVdoZWVsTGlzdGVuZXIoZWxlbWVudDogSFRNTEVsZW1lbnQsIGNhbGxiYWNrOiAoZXZlbnQ6IE1vdXNlV2hlZWxFdmVudCkgPT4gdm9pZCk6IHZvaWQge1xuICAgIGlmIChcIm9ubW91c2V3aGVlbFwiIGluIGVsZW1lbnQpIHtcbiAgICAgICAgYWRkTGlzdGVuZXIoZWxlbWVudCwgXCJtb3VzZXdoZWVsXCIsIGZ1bmN0aW9uKGU6IE1vdXNlV2hlZWxFdmVudCkge1xuICAgICAgICAgICAgdmFyIGZhY3RvciA9IDg7XG4gICAgICAgICAgICBpZiAoZVsnd2hlZWxEZWx0YVgnXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgICAgZVsnd2hlZWxYJ10gPSAtZVsnd2hlZWxEZWx0YVgnXSAvIGZhY3RvcjtcbiAgICAgICAgICAgICAgICBlWyd3aGVlbFknXSA9IC1lWyd3aGVlbERlbHRhWSddIC8gZmFjdG9yO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgZVsnd2hlZWxYJ10gPSAwO1xuICAgICAgICAgICAgICAgIGVbJ3doZWVsWSddID0gLWUud2hlZWxEZWx0YSAvIGZhY3RvcjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhbGxiYWNrKGUpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgZWxzZSBpZiAoXCJvbndoZWVsXCIgaW4gZWxlbWVudCkge1xuICAgICAgICBhZGRMaXN0ZW5lcihlbGVtZW50LCBcIndoZWVsXCIsIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgIHZhciBmYWN0b3IgPSAwLjM1O1xuICAgICAgICAgICAgc3dpdGNoIChlLmRlbHRhTW9kZSkge1xuICAgICAgICAgICAgICAgIGNhc2UgZS5ET01fREVMVEFfUElYRUw6XG4gICAgICAgICAgICAgICAgICAgIGUud2hlZWxYID0gZS5kZWx0YVggKiBmYWN0b3IgfHwgMDtcbiAgICAgICAgICAgICAgICAgICAgZS53aGVlbFkgPSBlLmRlbHRhWSAqIGZhY3RvciB8fCAwO1xuICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICBjYXNlIGUuRE9NX0RFTFRBX0xJTkU6XG4gICAgICAgICAgICAgICAgY2FzZSBlLkRPTV9ERUxUQV9QQUdFOlxuICAgICAgICAgICAgICAgICAgICBlLndoZWVsWCA9IChlLmRlbHRhWCB8fCAwKSAqIDU7XG4gICAgICAgICAgICAgICAgICAgIGUud2hlZWxZID0gKGUuZGVsdGFZIHx8IDApICogNTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBjYWxsYmFjayhlKTtcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIGVsc2Uge1xuICAgICAgICAvLyBUT0RPOiBEZWZpbmUgaW50ZXJmYWNlIGZvciBET01Nb3VzZVNjcm9sbC5cbiAgICAgICAgYWRkTGlzdGVuZXIoZWxlbWVudCwgXCJET01Nb3VzZVNjcm9sbFwiLCBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICBpZiAoZS5heGlzICYmIGUuYXhpcyA9PSBlLkhPUklaT05UQUxfQVhJUykge1xuICAgICAgICAgICAgICAgIGUud2hlZWxYID0gKGUuZGV0YWlsIHx8IDApICogNTtcbiAgICAgICAgICAgICAgICBlLndoZWVsWSA9IDA7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBlLndoZWVsWCA9IDA7XG4gICAgICAgICAgICAgICAgZS53aGVlbFkgPSAoZS5kZXRhaWwgfHwgMCkgKiA1O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgY2FsbGJhY2soZSk7XG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFkZE11bHRpTW91c2VEb3duTGlzdGVuZXIoZWwsIHRpbWVvdXRzLCBldmVudEhhbmRsZXIsIGNhbGxiYWNrTmFtZSkge1xuICAgIHZhciBjbGlja3MgPSAwO1xuICAgIHZhciBzdGFydFgsIHN0YXJ0WSwgdGltZXI7XG4gICAgdmFyIGV2ZW50TmFtZXMgPSB7XG4gICAgICAgIDI6IFwiZGJsY2xpY2tcIixcbiAgICAgICAgMzogXCJ0cmlwbGVjbGlja1wiLFxuICAgICAgICA0OiBcInF1YWRjbGlja1wiXG4gICAgfTtcblxuICAgIGFkZExpc3RlbmVyKGVsLCBcIm1vdXNlZG93blwiLCBmdW5jdGlvbihlOiBNb3VzZUV2ZW50KSB7XG4gICAgICAgIGlmIChnZXRCdXR0b24oZSkgIT09IDApIHtcbiAgICAgICAgICAgIGNsaWNrcyA9IDA7XG4gICAgICAgIH0gZWxzZSBpZiAoZS5kZXRhaWwgPiAxKSB7XG4gICAgICAgICAgICBjbGlja3MrKztcbiAgICAgICAgICAgIGlmIChjbGlja3MgPiA0KVxuICAgICAgICAgICAgICAgIGNsaWNrcyA9IDE7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBjbGlja3MgPSAxO1xuICAgICAgICB9XG4gICAgICAgIGlmIChpc0lFKSB7XG4gICAgICAgICAgICB2YXIgaXNOZXdDbGljayA9IE1hdGguYWJzKGUuY2xpZW50WCAtIHN0YXJ0WCkgPiA1IHx8IE1hdGguYWJzKGUuY2xpZW50WSAtIHN0YXJ0WSkgPiA1O1xuICAgICAgICAgICAgaWYgKCF0aW1lciB8fCBpc05ld0NsaWNrKVxuICAgICAgICAgICAgICAgIGNsaWNrcyA9IDE7XG4gICAgICAgICAgICBpZiAodGltZXIpXG4gICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTtcbiAgICAgICAgICAgIHRpbWVyID0gc2V0VGltZW91dChmdW5jdGlvbigpIHsgdGltZXIgPSBudWxsIH0sIHRpbWVvdXRzW2NsaWNrcyAtIDFdIHx8IDYwMCk7XG5cbiAgICAgICAgICAgIGlmIChjbGlja3MgPT0gMSkge1xuICAgICAgICAgICAgICAgIHN0YXJ0WCA9IGUuY2xpZW50WDtcbiAgICAgICAgICAgICAgICBzdGFydFkgPSBlLmNsaWVudFk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBUT0RPLiBUaGlzIGN1c3RvbSBwcm9wZXJ0eSBpcyBub3QgcGFydCBvZiBNb3VzZUV2ZW50LlxuICAgICAgICBlWydfY2xpY2tzJ10gPSBjbGlja3M7XG5cbiAgICAgICAgZXZlbnRIYW5kbGVyW2NhbGxiYWNrTmFtZV0oXCJtb3VzZWRvd25cIiwgZSk7XG5cbiAgICAgICAgaWYgKGNsaWNrcyA+IDQpXG4gICAgICAgICAgICBjbGlja3MgPSAwO1xuICAgICAgICBlbHNlIGlmIChjbGlja3MgPiAxKVxuICAgICAgICAgICAgcmV0dXJuIGV2ZW50SGFuZGxlcltjYWxsYmFja05hbWVdKGV2ZW50TmFtZXNbY2xpY2tzXSwgZSk7XG4gICAgfSk7XG5cbiAgICBpZiAoaXNPbGRJRSkge1xuICAgICAgICBhZGRMaXN0ZW5lcihlbCwgXCJkYmxjbGlja1wiLCBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICBjbGlja3MgPSAyO1xuICAgICAgICAgICAgaWYgKHRpbWVyKVxuICAgICAgICAgICAgICAgIGNsZWFyVGltZW91dCh0aW1lcik7XG4gICAgICAgICAgICB0aW1lciA9IHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7IHRpbWVyID0gbnVsbCB9LCB0aW1lb3V0c1tjbGlja3MgLSAxXSB8fCA2MDApO1xuICAgICAgICAgICAgZXZlbnRIYW5kbGVyW2NhbGxiYWNrTmFtZV0oXCJtb3VzZWRvd25cIiwgZSk7XG4gICAgICAgICAgICBldmVudEhhbmRsZXJbY2FsbGJhY2tOYW1lXShldmVudE5hbWVzW2NsaWNrc10sIGUpO1xuICAgICAgICB9KTtcbiAgICB9XG59XG5cbnZhciBnZXRNb2RpZmllckhhc2ggPSBpc01hYyAmJiBpc09wZXJhICYmICEoXCJLZXlib2FyZEV2ZW50XCIgaW4gd2luZG93KVxuICAgID8gZnVuY3Rpb24oZSkge1xuICAgICAgICByZXR1cm4gMCB8IChlLm1ldGFLZXkgPyAxIDogMCkgfCAoZS5hbHRLZXkgPyAyIDogMCkgfCAoZS5zaGlmdEtleSA/IDQgOiAwKSB8IChlLmN0cmxLZXkgPyA4IDogMCk7XG4gICAgfVxuICAgIDogZnVuY3Rpb24oZSkge1xuICAgICAgICByZXR1cm4gMCB8IChlLmN0cmxLZXkgPyAxIDogMCkgfCAoZS5hbHRLZXkgPyAyIDogMCkgfCAoZS5zaGlmdEtleSA/IDQgOiAwKSB8IChlLm1ldGFLZXkgPyA4IDogMCk7XG4gICAgfTtcblxuZXhwb3J0IGZ1bmN0aW9uIGdldE1vZGlmaWVyU3RyaW5nKGUpIHtcbiAgICByZXR1cm4gS0VZX01PRFNbZ2V0TW9kaWZpZXJIYXNoKGUpXTtcbn1cblxuZnVuY3Rpb24gbm9ybWFsaXplQ29tbWFuZEtleXMoY2FsbGJhY2ssIGU6IEtleWJvYXJkRXZlbnQsIGtleUNvZGU6IG51bWJlcikge1xuICAgIHZhciBoYXNoSWQgPSBnZXRNb2RpZmllckhhc2goZSk7XG5cbiAgICBpZiAoIWlzTWFjICYmIHByZXNzZWRLZXlzKSB7XG4gICAgICAgIGlmIChwcmVzc2VkS2V5c1s5MV0gfHwgcHJlc3NlZEtleXNbOTJdKVxuICAgICAgICAgICAgaGFzaElkIHw9IDg7XG4gICAgICAgIGlmIChwcmVzc2VkS2V5cy5hbHRHcikge1xuICAgICAgICAgICAgaWYgKCgzICYgaGFzaElkKSAhPSAzKVxuICAgICAgICAgICAgICAgIHByZXNzZWRLZXlzLmFsdEdyID0gMDtcbiAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGtleUNvZGUgPT09IDE4IHx8IGtleUNvZGUgPT09IDE3KSB7XG4gICAgICAgICAgICBpZiAoa2V5Q29kZSA9PT0gMTcgJiYgZS5sb2NhdGlvbiA9PT0gMSkge1xuICAgICAgICAgICAgICAgIHRzID0gZS50aW1lU3RhbXA7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGtleUNvZGUgPT09IDE4ICYmIGhhc2hJZCA9PT0gMyAmJiBlLmxvY2F0aW9uID09PSAyKSB7XG4gICAgICAgICAgICAgICAgdmFyIGR0ID0gLXRzO1xuICAgICAgICAgICAgICAgIHRzID0gZS50aW1lU3RhbXA7XG4gICAgICAgICAgICAgICAgZHQgKz0gdHM7XG4gICAgICAgICAgICAgICAgaWYgKGR0IDwgMylcbiAgICAgICAgICAgICAgICAgICAgcHJlc3NlZEtleXMuYWx0R3IgPSB0cnVlO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuXG4gICAgaWYgKGtleUNvZGUgaW4gTU9ESUZJRVJfS0VZUykge1xuICAgICAgICBzd2l0Y2ggKE1PRElGSUVSX0tFWVNba2V5Q29kZV0pIHtcbiAgICAgICAgICAgIGNhc2UgXCJBbHRcIjpcbiAgICAgICAgICAgICAgICBoYXNoSWQgPSAyO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBcIlNoaWZ0XCI6XG4gICAgICAgICAgICAgICAgaGFzaElkID0gNDtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGNhc2UgXCJDdHJsXCI6XG4gICAgICAgICAgICAgICAgaGFzaElkID0gMTtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgICAgICAgaGFzaElkID0gODtcbiAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBrZXlDb2RlID0gLTE7XG4gICAgfVxuXG4gICAgaWYgKGhhc2hJZCAmIDggJiYgKGtleUNvZGUgPT09IDkxIHx8IGtleUNvZGUgPT09IDkzKSkge1xuICAgICAgICBrZXlDb2RlID0gLTE7XG4gICAgfVxuXG4gICAgaWYgKCFoYXNoSWQgJiYga2V5Q29kZSA9PT0gMTMpIHtcbiAgICAgICAgaWYgKGUubG9jYXRpb24gPT09IDMpIHtcbiAgICAgICAgICAgIGNhbGxiYWNrKGUsIGhhc2hJZCwgLWtleUNvZGUpO1xuICAgICAgICAgICAgaWYgKGUuZGVmYXVsdFByZXZlbnRlZClcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoaXNDaHJvbWVPUyAmJiBoYXNoSWQgJiA4KSB7XG4gICAgICAgIGNhbGxiYWNrKGUsIGhhc2hJZCwga2V5Q29kZSk7XG4gICAgICAgIGlmIChlLmRlZmF1bHRQcmV2ZW50ZWQpXG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIGhhc2hJZCAmPSB+ODtcbiAgICB9XG5cbiAgICAvLyBJZiB0aGVyZSBpcyBubyBoYXNoSWQgYW5kIHRoZSBrZXlDb2RlIGlzIG5vdCBhIGZ1bmN0aW9uIGtleSwgdGhlblxuICAgIC8vIHdlIGRvbid0IGNhbGwgdGhlIGNhbGxiYWNrIGFzIHdlIGRvbid0IGhhbmRsZSBhIGNvbW1hbmQga2V5IGhlcmVcbiAgICAvLyAoaXQncyBhIG5vcm1hbCBrZXkvY2hhcmFjdGVyIGlucHV0KS5cbiAgICBpZiAoIWhhc2hJZCAmJiAhKGtleUNvZGUgaW4gRlVOQ1RJT05fS0VZUykgJiYgIShrZXlDb2RlIGluIFBSSU5UQUJMRV9LRVlTKSkge1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNhbGxiYWNrKGUsIGhhc2hJZCwga2V5Q29kZSk7XG59XG5cbnZhciBwcmVzc2VkS2V5cyA9IG51bGw7XG5cbmZ1bmN0aW9uIHJlc2V0UHJlc3NlZEtleXMoZSkge1xuICAgIHByZXNzZWRLZXlzID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcbn1cblxudmFyIHRzID0gMDtcbmV4cG9ydCBmdW5jdGlvbiBhZGRDb21tYW5kS2V5TGlzdGVuZXIoZWwsIGNhbGxiYWNrKSB7XG4gICAgaWYgKGlzT2xkR2Vja28gfHwgKGlzT3BlcmEgJiYgIShcIktleWJvYXJkRXZlbnRcIiBpbiB3aW5kb3cpKSkge1xuICAgICAgICAvLyBPbGQgdmVyc2lvbnMgb2YgR2Vja28gYWthLiBGaXJlZm94IDwgNC4wIGRpZG4ndCByZXBlYXQgdGhlIGtleWRvd25cbiAgICAgICAgLy8gZXZlbnQgaWYgdGhlIHVzZXIgcHJlc3NlZCB0aGUga2V5IGZvciBhIGxvbmdlciB0aW1lLiBJbnN0ZWFkLCB0aGVcbiAgICAgICAgLy8ga2V5ZG93biBldmVudCB3YXMgZmlyZWQgb25jZSBhbmQgbGF0ZXIgb24gb25seSB0aGUga2V5cHJlc3MgZXZlbnQuXG4gICAgICAgIC8vIFRvIGVtdWxhdGUgdGhlICdyaWdodCcga2V5ZG93biBiZWhhdmlvciwgdGhlIGtleUNvZGUgb2YgdGhlIGluaXRpYWxcbiAgICAgICAgLy8ga2V5RG93biBldmVudCBpcyBzdG9yZWQgYW5kIGluIHRoZSBmb2xsb3dpbmcga2V5cHJlc3MgZXZlbnRzIHRoZVxuICAgICAgICAvLyBzdG9yZXMga2V5Q29kZSBpcyB1c2VkIHRvIGVtdWxhdGUgYSBrZXlEb3duIGV2ZW50LlxuICAgICAgICB2YXIgbGFzdEtleURvd25LZXlDb2RlID0gbnVsbDtcbiAgICAgICAgYWRkTGlzdGVuZXIoZWwsIFwia2V5ZG93blwiLCBmdW5jdGlvbihlOiBLZXlib2FyZEV2ZW50KSB7XG4gICAgICAgICAgICBsYXN0S2V5RG93bktleUNvZGUgPSBlLmtleUNvZGU7XG4gICAgICAgIH0pO1xuICAgICAgICBhZGRMaXN0ZW5lcihlbCwgXCJrZXlwcmVzc1wiLCBmdW5jdGlvbihlOiBLZXlib2FyZEV2ZW50KSB7XG4gICAgICAgICAgICByZXR1cm4gbm9ybWFsaXplQ29tbWFuZEtleXMoY2FsbGJhY2ssIGUsIGxhc3RLZXlEb3duS2V5Q29kZSk7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgICAgdmFyIGxhc3REZWZhdWx0UHJldmVudGVkID0gbnVsbDtcblxuICAgICAgICBhZGRMaXN0ZW5lcihlbCwgXCJrZXlkb3duXCIsIGZ1bmN0aW9uKGU6IEtleWJvYXJkRXZlbnQpIHtcbiAgICAgICAgICAgIHByZXNzZWRLZXlzW2Uua2V5Q29kZV0gPSB0cnVlO1xuICAgICAgICAgICAgdmFyIHJlc3VsdCA9IG5vcm1hbGl6ZUNvbW1hbmRLZXlzKGNhbGxiYWNrLCBlLCBlLmtleUNvZGUpO1xuICAgICAgICAgICAgbGFzdERlZmF1bHRQcmV2ZW50ZWQgPSBlLmRlZmF1bHRQcmV2ZW50ZWQ7XG4gICAgICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgICAgICB9KTtcblxuICAgICAgICBhZGRMaXN0ZW5lcihlbCwgJ2tleXByZXNzJywgZnVuY3Rpb24oZTogS2V5Ym9hcmRFdmVudCkge1xuICAgICAgICAgICAgaWYgKGxhc3REZWZhdWx0UHJldmVudGVkICYmIChlLmN0cmxLZXkgfHwgZS5hbHRLZXkgfHwgZS5zaGlmdEtleSB8fCBlLm1ldGFLZXkpKSB7XG4gICAgICAgICAgICAgICAgc3RvcEV2ZW50KGUpO1xuICAgICAgICAgICAgICAgIGxhc3REZWZhdWx0UHJldmVudGVkID0gbnVsbDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICAgICAgYWRkTGlzdGVuZXIoZWwsICdrZXl1cCcsIGZ1bmN0aW9uKGU6IEtleWJvYXJkRXZlbnQpIHtcbiAgICAgICAgICAgIHByZXNzZWRLZXlzW2Uua2V5Q29kZV0gPSBudWxsO1xuICAgICAgICB9KTtcblxuICAgICAgICBpZiAoIXByZXNzZWRLZXlzKSB7XG4gICAgICAgICAgICBwcmVzc2VkS2V5cyA9IE9iamVjdC5jcmVhdGUobnVsbCk7XG4gICAgICAgICAgICBhZGRMaXN0ZW5lcih3aW5kb3csICdmb2N1cycsIHJlc2V0UHJlc3NlZEtleXMpO1xuICAgICAgICB9XG4gICAgfVxufVxuXG4vLyBGSVhNRTogQ29uZGl0aW9uYWwgZXhwb3J0cyBub3Qgc3VwcG9ydGVkIGJ5IFR5cGVTY3JpcHQgb3IgSGFybW9ueS9FUzYuXG4vLyBkZWNsYXJlIHZhciBleHBvcnRzOiBhbnk7XG4vKlxuaWYgKHdpbmRvdy5wb3N0TWVzc2FnZSAmJiAhaXNPbGRJRSkge1xuICAgIHZhciBwb3N0TWVzc2FnZUlkID0gMTtcbiAgICBleHBvcnRzLm5leHRUaWNrID0gZnVuY3Rpb24oY2FsbGJhY2ssIHdpbikge1xuICAgICAgICB3aW4gPSB3aW4gfHwgd2luZG93O1xuICAgICAgICB2YXIgbWVzc2FnZU5hbWUgPSBcInplcm8tdGltZW91dC1tZXNzYWdlLVwiICsgcG9zdE1lc3NhZ2VJZDtcbiAgICAgICAgYWRkTGlzdGVuZXIod2luLCBcIm1lc3NhZ2VcIiwgZnVuY3Rpb24gbGlzdGVuZXIoZSkge1xuICAgICAgICAgICAgaWYgKGUuZGF0YSA9PSBtZXNzYWdlTmFtZSkge1xuICAgICAgICAgICAgICAgIHN0b3BQcm9wYWdhdGlvbihlKTtcbiAgICAgICAgICAgICAgICByZW1vdmVMaXN0ZW5lcih3aW4sIFwibWVzc2FnZVwiLCBsaXN0ZW5lcik7XG4gICAgICAgICAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICAgIHdpbi5wb3N0TWVzc2FnZShtZXNzYWdlTmFtZSwgXCIqXCIpO1xuICAgIH07XG59XG4qL1xuXG52YXIgbmV4dEZyYW1lQ2FuZGlkYXRlOiAoY2FsbGJhY2s6ICgpID0+IHZvaWQsICR3aW5kb3c6IFdpbmRvdykgPT4gdm9pZCA9IHdpbmRvdy5yZXF1ZXN0QW5pbWF0aW9uRnJhbWUgfHxcbiAgICB3aW5kb3dbJ21velJlcXVlc3RBbmltYXRpb25GcmFtZSddIHx8XG4gICAgd2luZG93Wyd3ZWJraXRSZXF1ZXN0QW5pbWF0aW9uRnJhbWUnXSB8fFxuICAgIHdpbmRvdy5tc1JlcXVlc3RBbmltYXRpb25GcmFtZSB8fFxuICAgIHdpbmRvd1snb1JlcXVlc3RBbmltYXRpb25GcmFtZSddO1xuXG5pZiAobmV4dEZyYW1lQ2FuZGlkYXRlKSB7XG4gICAgbmV4dEZyYW1lQ2FuZGlkYXRlID0gbmV4dEZyYW1lQ2FuZGlkYXRlLmJpbmQod2luZG93KTtcbn1cbmVsc2Uge1xuICAgIG5leHRGcmFtZUNhbmRpZGF0ZSA9IGZ1bmN0aW9uKGNhbGxiYWNrKSB7XG4gICAgICAgIHNldFRpbWVvdXQoY2FsbGJhY2ssIDE3KTtcbiAgICB9O1xufVxuXG4vKipcbiAqIEEgYmFja3dhcmRzLWNvbXBhdGlibGUsIGJyb3dzZXItbmV1dHJhbCwgcmVxdWVzdEFuaW1hdGlvbkZyYW1lLlxuICovXG5leHBvcnQgdmFyIHJlcXVlc3RBbmltYXRpb25GcmFtZTogKGNhbGxiYWNrOiAoKSA9PiB2b2lkLCAkd2luZG93OiBXaW5kb3cpID0+IHZvaWQgPSBuZXh0RnJhbWVDYW5kaWRhdGU7XG4iXX0=