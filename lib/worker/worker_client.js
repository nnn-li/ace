import { qualifyURL } from '../lib/net';
import { EventEmitterClass } from '../lib/event_emitter';
export class WorkerClient extends EventEmitterClass {
    constructor(topLevelNamespaces, mod, classname, workerUrl) {
        super();
        this.callbacks = {};
        this.callbackId = 1;
        console.log("WorkerClient constructor()");
        console.log("topLevelNamespaces => " + JSON.stringify(topLevelNamespaces));
        console.log("mod => " + mod);
        console.log("classname => " + classname);
        console.log("workerUrl => " + workerUrl);
        this.$sendDeltaQueue = this.$sendDeltaQueue.bind(this);
        this.changeListener = this.changeListener.bind(this);
        this.onMessage = this.onMessage.bind(this);
        var tlns = {};
        try {
            this.$worker = new Worker(workerUrl);
        }
        catch (e) {
            if (e instanceof window['DOMException']) {
                var blob = this.$workerBlob(workerUrl);
                var URL = window['URL'] || window['webkitURL'];
                var blobURL = URL.createObjectURL(blob);
                this.$worker = new Worker(blobURL);
                URL.revokeObjectURL(blobURL);
            }
            else {
                throw e;
            }
        }
        this.$worker.postMessage({
            init: true,
            tlns: tlns,
            module: mod,
            classname: classname
        });
        this.$worker.onmessage = this.onMessage;
    }
    onMessage(e) {
        var msg = e.data;
        switch (msg.type) {
            case "log":
                window.console && console.log && console.log.apply(console, msg.data);
                break;
            case "event":
                this._signal(msg.name, { data: msg.data });
                break;
            case "call":
                var callback = this.callbacks[msg.id];
                if (callback) {
                    callback(msg.data);
                    delete this.callbacks[msg.id];
                }
                break;
        }
    }
    $normalizePath(path) {
        return qualifyURL(path);
    }
    terminate() {
        this._signal("terminate", {});
        this.deltaQueue = null;
        this.$worker.terminate();
        this.$worker = null;
        this.detachFromDocument();
    }
    send(cmd, args) {
        this.$worker.postMessage({ command: cmd, args: args });
    }
    call(cmd, args, callback) {
        if (callback) {
            var id = this.callbackId++;
            this.callbacks[id] = callback;
            args.push(id);
        }
        this.send(cmd, args);
    }
    emit(event, data) {
        try {
            this.$worker.postMessage({ event: event, data: { data: data.data } });
        }
        catch (ex) {
            console.error(ex.stack);
        }
    }
    attachToDocument(doc) {
        if (this.$doc) {
            this.terminate();
        }
        this.$doc = doc;
        this.call("setValue", [doc.getValue()]);
        doc.addEventListener('change', this.changeListener);
    }
    detachFromDocument() {
        this.$doc.removeEventListener('change', this.changeListener);
        this.$doc = null;
    }
    changeListener(e) {
        if (!this.deltaQueue) {
            this.deltaQueue = [e.data];
            setTimeout(this.$sendDeltaQueue, 0);
        }
        else {
            this.deltaQueue.push(e.data);
        }
    }
    $sendDeltaQueue() {
        var doc = this.$doc;
        var q = this.deltaQueue;
        if (!q)
            return;
        this.deltaQueue = null;
        if (q.length > 20 && q.length > doc.getLength() >> 1) {
            this.call("setValue", [doc.getValue()]);
        }
        else
            this.emit("change", { data: q });
    }
    $workerBlob(workerUrl) {
        var script = "importScripts('" + qualifyURL(workerUrl) + "');";
        try {
            return new Blob([script], { "type": "application/javascript" });
        }
        catch (e) {
            var BlobBuilder = window['BlobBuilder'] || window['WebKitBlobBuilder'] || window['MozBlobBuilder'];
            var blobBuilder = new BlobBuilder();
            blobBuilder.append(script);
            return blobBuilder.getBlob("application/javascript");
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid29ya2VyX2NsaWVudC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy93b3JrZXIvd29ya2VyX2NsaWVudC50cyJdLCJuYW1lcyI6WyJXb3JrZXJDbGllbnQiLCJXb3JrZXJDbGllbnQuY29uc3RydWN0b3IiLCJXb3JrZXJDbGllbnQub25NZXNzYWdlIiwiV29ya2VyQ2xpZW50LiRub3JtYWxpemVQYXRoIiwiV29ya2VyQ2xpZW50LnRlcm1pbmF0ZSIsIldvcmtlckNsaWVudC5zZW5kIiwiV29ya2VyQ2xpZW50LmNhbGwiLCJXb3JrZXJDbGllbnQuZW1pdCIsIldvcmtlckNsaWVudC5hdHRhY2hUb0RvY3VtZW50IiwiV29ya2VyQ2xpZW50LmRldGFjaEZyb21Eb2N1bWVudCIsIldvcmtlckNsaWVudC5jaGFuZ2VMaXN0ZW5lciIsIldvcmtlckNsaWVudC4kc2VuZERlbHRhUXVldWUiLCJXb3JrZXJDbGllbnQuJHdvcmtlckJsb2IiXSwibWFwcGluZ3MiOiJPQThCTyxFQUFDLFVBQVUsRUFBQyxNQUFNLFlBQVk7T0FFOUIsRUFBQyxpQkFBaUIsRUFBQyxNQUFNLHNCQUFzQjtBQU10RCxrQ0FBa0MsaUJBQWlCO0lBTS9DQSxZQUFZQSxrQkFBNEJBLEVBQUVBLEdBQVdBLEVBQUVBLFNBQWlCQSxFQUFFQSxTQUFrQkE7UUFDeEZDLE9BQU9BLENBQUNBO1FBSkpBLGNBQVNBLEdBQUdBLEVBQUVBLENBQUNBO1FBQ2ZBLGVBQVVBLEdBQVdBLENBQUNBLENBQUNBO1FBSTNCQSxPQUFPQSxDQUFDQSxHQUFHQSxDQUFDQSw0QkFBNEJBLENBQUNBLENBQUFBO1FBQ3pDQSxPQUFPQSxDQUFDQSxHQUFHQSxDQUFDQSx3QkFBd0JBLEdBQUdBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLGtCQUFrQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDM0VBLE9BQU9BLENBQUNBLEdBQUdBLENBQUNBLFNBQVNBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBO1FBQzdCQSxP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QUFJQSxDQUFDQSxVQUFVQSxFQUFFQSxDQUFDQSxHQUFHQSxDQUFDQSxRQUFRQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUM1Q0EsQ0FBQ0E7UUFDREEsSUFBSUE7WUFDQUEsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsUUFBUUEsRUFBRUEsRUFBRUEsSUFBSUEsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0E7SUFDekNBLENBQUNBO0lBRURYLFdBQVdBLENBQUNBLFNBQWlCQTtRQUd6QlksSUFBSUEsTUFBTUEsR0FBR0EsaUJBQWlCQSxHQUFHQSxVQUFVQSxDQUFDQSxTQUFTQSxDQUFDQSxHQUFHQSxLQUFLQSxDQUFDQTtRQUMvREEsSUFBSUEsQ0FBQ0E7WUFDREEsTUFBTUEsQ0FBQ0EsSUFBSUEsSUFBSUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsRUFBRUEsRUFBRUEsTUFBTUEsRUFBRUEsd0JBQXdCQSxFQUFFQSxDQUFDQSxDQUFDQTtRQUNwRUEsQ0FDQUE7UUFBQUEsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDUEEsSUFBSUEsV0FBV0EsR0FBR0EsTUFBTUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsSUFBSUEsTUFBTUEsQ0FBQ0EsbUJBQW1CQSxDQUFDQSxJQUFJQSxNQUFNQSxDQUFDQSxnQkFBZ0JBLENBQUNBLENBQUNBO1lBQ25HQSxJQUFJQSxXQUFXQSxHQUFHQSxJQUFJQSxXQUFXQSxFQUFFQSxDQUFDQTtZQUNwQ0EsV0FBV0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7WUFDM0JBLE1BQU1BLENBQUNBLFdBQVdBLENBQUNBLE9BQU9BLENBQUNBLHdCQUF3QkEsQ0FBQ0EsQ0FBQ0E7UUFDekRBLENBQUNBO0lBQ0xBLENBQUNBO0FBQ0xaLENBQUNBO0FBQUEiLCJzb3VyY2VzQ29udGVudCI6WyIvKiAqKioqKiBCRUdJTiBMSUNFTlNFIEJMT0NLICoqKioqXG4gKiBEaXN0cmlidXRlZCB1bmRlciB0aGUgQlNEIGxpY2Vuc2U6XG4gKlxuICogQ29weXJpZ2h0IChjKSAyMDEwLCBBamF4Lm9yZyBCLlYuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dFxuICogbW9kaWZpY2F0aW9uLCBhcmUgcGVybWl0dGVkIHByb3ZpZGVkIHRoYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zIGFyZSBtZXQ6XG4gKiAgICAgKiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodFxuICogICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLlxuICogICAgICogUmVkaXN0cmlidXRpb25zIGluIGJpbmFyeSBmb3JtIG11c3QgcmVwcm9kdWNlIHRoZSBhYm92ZSBjb3B5cmlnaHRcbiAqICAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGVcbiAqICAgICAgIGRvY3VtZW50YXRpb24gYW5kL29yIG90aGVyIG1hdGVyaWFscyBwcm92aWRlZCB3aXRoIHRoZSBkaXN0cmlidXRpb24uXG4gKiAgICAgKiBOZWl0aGVyIHRoZSBuYW1lIG9mIEFqYXgub3JnIEIuVi4gbm9yIHRoZVxuICogICAgICAgbmFtZXMgb2YgaXRzIGNvbnRyaWJ1dG9ycyBtYXkgYmUgdXNlZCB0byBlbmRvcnNlIG9yIHByb21vdGUgcHJvZHVjdHNcbiAqICAgICAgIGRlcml2ZWQgZnJvbSB0aGlzIHNvZnR3YXJlIHdpdGhvdXQgc3BlY2lmaWMgcHJpb3Igd3JpdHRlbiBwZXJtaXNzaW9uLlxuICpcbiAqIFRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgVEhFIENPUFlSSUdIVCBIT0xERVJTIEFORCBDT05UUklCVVRPUlMgXCJBUyBJU1wiIEFORFxuICogQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhFIElNUExJRURcbiAqIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkVcbiAqIERJU0NMQUlNRUQuIElOIE5PIEVWRU5UIFNIQUxMIEFKQVguT1JHIEIuVi4gQkUgTElBQkxFIEZPUiBBTllcbiAqIERJUkVDVCwgSU5ESVJFQ1QsIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTXG4gKiAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVM7XG4gKiBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVTSU5FU1MgSU5URVJSVVBUSU9OKSBIT1dFVkVSIENBVVNFRCBBTkRcbiAqIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QgTElBQklMSVRZLCBPUiBUT1JUXG4gKiAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRSBVU0UgT0YgVEhJU1xuICogU09GVFdBUkUsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuXG4gKlxuICogKioqKiogRU5EIExJQ0VOU0UgQkxPQ0sgKioqKiogKi9cbmltcG9ydCB7fSBmcm9tICcuLi9saWIvb29wJztcbmltcG9ydCB7cXVhbGlmeVVSTH0gZnJvbSAnLi4vbGliL25ldCc7XG5pbXBvcnQgRWRpdG9yRG9jdW1lbnQgZnJvbSBcIi4uL0VkaXRvckRvY3VtZW50XCI7XG5pbXBvcnQge0V2ZW50RW1pdHRlckNsYXNzfSBmcm9tICcuLi9saWIvZXZlbnRfZW1pdHRlcic7XG5pbXBvcnQge2dldCwgbW9kdWxlVXJsfSBmcm9tIFwiLi4vY29uZmlnXCI7XG5cbi8qKlxuICogV29ya2VyQ2xpZW50IG1hbmFnZXMgdGhlIGNvbW11bmljYXRpb24gd2l0aCBhIFdlYiBXb3JrZXIuXG4gKi9cbmV4cG9ydCBjbGFzcyBXb3JrZXJDbGllbnQgZXh0ZW5kcyBFdmVudEVtaXR0ZXJDbGFzcyB7XG4gICAgcHJpdmF0ZSAkd29ya2VyXG4gICAgcHJpdmF0ZSBkZWx0YVF1ZXVlO1xuICAgIHByaXZhdGUgY2FsbGJhY2tzID0ge307XG4gICAgcHJpdmF0ZSBjYWxsYmFja0lkOiBudW1iZXIgPSAxO1xuICAgIHByaXZhdGUgJGRvYzogRWRpdG9yRG9jdW1lbnQ7XG4gICAgY29uc3RydWN0b3IodG9wTGV2ZWxOYW1lc3BhY2VzOiBzdHJpbmdbXSwgbW9kOiBzdHJpbmcsIGNsYXNzbmFtZTogc3RyaW5nLCB3b3JrZXJVcmw/OiBzdHJpbmcpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgY29uc29sZS5sb2coXCJXb3JrZXJDbGllbnQgY29uc3RydWN0b3IoKVwiKVxuICAgICAgICBjb25zb2xlLmxvZyhcInRvcExldmVsTmFtZXNwYWNlcyA9PiBcIiArIEpTT04uc3RyaW5naWZ5KHRvcExldmVsTmFtZXNwYWNlcykpO1xuICAgICAgICBjb25zb2xlLmxvZyhcIm1vZCA9PiBcIiArIG1vZCk7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiY2xhc3NuYW1lID0+IFwiICsgY2xhc3NuYW1lKTtcbiAgICAgICAgY29uc29sZS5sb2coXCJ3b3JrZXJVcmwgPT4gXCIgKyB3b3JrZXJVcmwpO1xuICAgICAgICB0aGlzLiRzZW5kRGVsdGFRdWV1ZSA9IHRoaXMuJHNlbmREZWx0YVF1ZXVlLmJpbmQodGhpcyk7XG4gICAgICAgIHRoaXMuY2hhbmdlTGlzdGVuZXIgPSB0aGlzLmNoYW5nZUxpc3RlbmVyLmJpbmQodGhpcyk7XG4gICAgICAgIHRoaXMub25NZXNzYWdlID0gdGhpcy5vbk1lc3NhZ2UuYmluZCh0aGlzKTtcblxuICAgICAgICAvLyBGSVhNRTogV2UgbmVlZCB0byBwb3B1bGF0ZSB0aGlzXG4gICAgICAgIC8qKlxuICAgICAgICAgKlxuICAgICAgICAgKi9cbiAgICAgICAgdmFyIHRsbnM6IHsgW25zOiBzdHJpbmddOiBzdHJpbmcgfSA9IHt9O1xuXG4gICAgICAgIC8vIG5hbWVUb1VybCBpcyByZW5hbWVkIHRvIHRvVXJsIGluIHJlcXVpcmVqcyAyXG4gICAgICAgIC8vIEZJWE1FOiBHZXQgdGhpcyB3b3JraW5nIGFnYWluIHdpdGhvdXQgQU1ELlxuICAgICAgICAvKlxuICAgICAgICBpZiAocmVxdWlyZVsnbmFtZVRvVXJsJ10gJiYgIXJlcXVpcmUudG9VcmwpIHtcbiAgICAgICAgICAgIHJlcXVpcmUudG9VcmwgPSByZXF1aXJlWyduYW1lVG9VcmwnXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChnZXQoXCJwYWNrYWdlZFwiKSB8fCAhcmVxdWlyZS50b1VybCkge1xuICAgICAgICAgICAgd29ya2VyVXJsID0gd29ya2VyVXJsIHx8IG1vZHVsZVVybChtb2QsIFwid29ya2VyXCIpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZVBhdGggPSB0aGlzLiRub3JtYWxpemVQYXRoO1xuICAgICAgICAgICAgLy8gVGhpcyBwYXRoIGlzIGludGVudGlvbmFsbHkgbm90IHJlbGF0aXZlLlxuICAgICAgICAgICAgd29ya2VyVXJsID0gd29ya2VyVXJsIHx8IG5vcm1hbGl6ZVBhdGgocmVxdWlyZS50b1VybChcImFjZS93b3JrZXIvd29ya2VyLmpzXCIpKTtcblxuICAgICAgICAgICAgdmFyIHRsbnMgPSB7fTtcbiAgICAgICAgICAgIHRvcExldmVsTmFtZXNwYWNlcy5mb3JFYWNoKGZ1bmN0aW9uKG5zKSB7XG4gICAgICAgICAgICAgICAgdGxuc1tuc10gPSBub3JtYWxpemVQYXRoKHJlcXVpcmUudG9VcmwobnMpLnJlcGxhY2UoLyhcXC5qcyk/KFxcPy4qKT8kLywgXCJcIikpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgKi9cblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdGhpcy4kd29ya2VyID0gbmV3IFdvcmtlcih3b3JrZXJVcmwpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICBpZiAoZSBpbnN0YW5jZW9mIHdpbmRvd1snRE9NRXhjZXB0aW9uJ10pIHtcbiAgICAgICAgICAgICAgICAvLyBMaWtlbHkgc2FtZSBvcmlnaW4gcHJvYmxlbS4gVXNlIGltcG9ydFNjcmlwdHMgZnJvbSBhIHNoaW0gV29ya2VyXG4gICAgICAgICAgICAgICAgdmFyIGJsb2I6IEJsb2IgPSB0aGlzLiR3b3JrZXJCbG9iKHdvcmtlclVybCk7XG4gICAgICAgICAgICAgICAgdmFyIFVSTDogVVJMID0gd2luZG93WydVUkwnXSB8fCB3aW5kb3dbJ3dlYmtpdFVSTCddO1xuICAgICAgICAgICAgICAgIHZhciBibG9iVVJMOiBzdHJpbmcgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpO1xuXG4gICAgICAgICAgICAgICAgdGhpcy4kd29ya2VyID0gbmV3IFdvcmtlcihibG9iVVJMKTtcbiAgICAgICAgICAgICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKGJsb2JVUkwpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyBTZW5kaW5nIGEgcG9zdE1lc3NhZ2Ugc3RhcnRzIHRoZSB3b3JrZXIuXG4gICAgICAgIHRoaXMuJHdvcmtlci5wb3N0TWVzc2FnZSh7XG4gICAgICAgICAgICBpbml0OiB0cnVlLFxuICAgICAgICAgICAgdGxuczogdGxucyxcbiAgICAgICAgICAgIG1vZHVsZTogbW9kLFxuICAgICAgICAgICAgY2xhc3NuYW1lOiBjbGFzc25hbWVcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy4kd29ya2VyLm9ubWVzc2FnZSA9IHRoaXMub25NZXNzYWdlO1xuICAgIH1cbiAgICBvbk1lc3NhZ2UoZSkge1xuICAgICAgICB2YXIgbXNnID0gZS5kYXRhO1xuICAgICAgICBzd2l0Y2ggKG1zZy50eXBlKSB7XG4gICAgICAgICAgICBjYXNlIFwibG9nXCI6XG4gICAgICAgICAgICAgICAgd2luZG93LmNvbnNvbGUgJiYgY29uc29sZS5sb2cgJiYgY29uc29sZS5sb2cuYXBwbHkoY29uc29sZSwgbXNnLmRhdGEpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlIFwiZXZlbnRcIjpcbiAgICAgICAgICAgICAgICB0aGlzLl9zaWduYWwobXNnLm5hbWUsIHsgZGF0YTogbXNnLmRhdGEgfSk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgXCJjYWxsXCI6XG4gICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gdGhpcy5jYWxsYmFja3NbbXNnLmlkXTtcbiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIHtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobXNnLmRhdGEpO1xuICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5jYWxsYmFja3NbbXNnLmlkXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlICRub3JtYWxpemVQYXRoKHBhdGg6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBxdWFsaWZ5VVJMKHBhdGgpO1xuICAgIH1cblxuICAgIHRlcm1pbmF0ZSgpIHtcbiAgICAgICAgdGhpcy5fc2lnbmFsKFwidGVybWluYXRlXCIsIHt9KTtcbiAgICAgICAgdGhpcy5kZWx0YVF1ZXVlID0gbnVsbDtcbiAgICAgICAgdGhpcy4kd29ya2VyLnRlcm1pbmF0ZSgpO1xuICAgICAgICB0aGlzLiR3b3JrZXIgPSBudWxsO1xuICAgICAgICB0aGlzLmRldGFjaEZyb21Eb2N1bWVudCgpO1xuICAgIH1cblxuICAgIHNlbmQoY21kLCBhcmdzKSB7XG4gICAgICAgIHRoaXMuJHdvcmtlci5wb3N0TWVzc2FnZSh7IGNvbW1hbmQ6IGNtZCwgYXJnczogYXJncyB9KTtcbiAgICB9XG5cbiAgICBjYWxsKGNtZCwgYXJncywgY2FsbGJhY2s/KSB7XG4gICAgICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgICAgICAgdmFyIGlkID0gdGhpcy5jYWxsYmFja0lkKys7XG4gICAgICAgICAgICB0aGlzLmNhbGxiYWNrc1tpZF0gPSBjYWxsYmFjaztcbiAgICAgICAgICAgIGFyZ3MucHVzaChpZCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZW5kKGNtZCwgYXJncyk7XG4gICAgfVxuXG4gICAgZW1pdChldmVudDogc3RyaW5nLCBkYXRhKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvLyBmaXJlZm94IHJlZnVzZXMgdG8gY2xvbmUgb2JqZWN0cyB3aGljaCBoYXZlIGZ1bmN0aW9uIHByb3BlcnRpZXNcbiAgICAgICAgICAgIC8vIFRPRE86IGNsZWFudXAgZXZlbnRcbiAgICAgICAgICAgIHRoaXMuJHdvcmtlci5wb3N0TWVzc2FnZSh7IGV2ZW50OiBldmVudCwgZGF0YTogeyBkYXRhOiBkYXRhLmRhdGEgfSB9KTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXgpIHtcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXguc3RhY2spO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXR0YWNoVG9Eb2N1bWVudChkb2M6IEVkaXRvckRvY3VtZW50KSB7XG4gICAgICAgIGlmICh0aGlzLiRkb2MpIHtcbiAgICAgICAgICAgIHRoaXMudGVybWluYXRlKCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy4kZG9jID0gZG9jO1xuICAgICAgICB0aGlzLmNhbGwoXCJzZXRWYWx1ZVwiLCBbZG9jLmdldFZhbHVlKCldKTtcbiAgICAgICAgZG9jLmFkZEV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIHRoaXMuY2hhbmdlTGlzdGVuZXIpO1xuICAgIH1cblxuICAgIGRldGFjaEZyb21Eb2N1bWVudCgpIHtcbiAgICAgICAgdGhpcy4kZG9jLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NoYW5nZScsIHRoaXMuY2hhbmdlTGlzdGVuZXIpO1xuICAgICAgICB0aGlzLiRkb2MgPSBudWxsO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBhcyB0aGUgYmFzaXMgZm9yIGEgZnVuY3Rpb24gd2hlcmUgdGhpcyBpcyBib3VuZCBzYWZlbHkuXG4gICAgICogSXQgaGFuZGxlcyBjaGFuZ2VzIHRvIHRoZSBkb2N1bWVudCBieSBwbGFjaW5nIHRoZSBtZXNzYWdlcyBpbiBhIHF1ZXVlXG4gICAgICovXG4gICAgcHJpdmF0ZSBjaGFuZ2VMaXN0ZW5lcihlOiB7IGRhdGEgfSkge1xuICAgICAgICBpZiAoIXRoaXMuZGVsdGFRdWV1ZSkge1xuICAgICAgICAgICAgdGhpcy5kZWx0YVF1ZXVlID0gW2UuZGF0YV07XG4gICAgICAgICAgICBzZXRUaW1lb3V0KHRoaXMuJHNlbmREZWx0YVF1ZXVlLCAwKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuZGVsdGFRdWV1ZS5wdXNoKGUuZGF0YSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlICRzZW5kRGVsdGFRdWV1ZSgpIHtcbiAgICAgICAgdmFyIGRvYyA9IHRoaXMuJGRvYztcbiAgICAgICAgdmFyIHEgPSB0aGlzLmRlbHRhUXVldWU7XG4gICAgICAgIGlmICghcSkgcmV0dXJuO1xuICAgICAgICB0aGlzLmRlbHRhUXVldWUgPSBudWxsO1xuICAgICAgICBpZiAocS5sZW5ndGggPiAyMCAmJiBxLmxlbmd0aCA+IGRvYy5nZXRMZW5ndGgoKSA+PiAxKSB7XG4gICAgICAgICAgICB0aGlzLmNhbGwoXCJzZXRWYWx1ZVwiLCBbZG9jLmdldFZhbHVlKCldKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlXG4gICAgICAgICAgICB0aGlzLmVtaXQoXCJjaGFuZ2VcIiwgeyBkYXRhOiBxIH0pO1xuICAgIH1cblxuICAgICR3b3JrZXJCbG9iKHdvcmtlclVybDogc3RyaW5nKTogQmxvYiB7XG4gICAgICAgIC8vIHdvcmtlclVybCBjYW4gYmUgcHJvdG9jb2wgcmVsYXRpdmVcbiAgICAgICAgLy8gaW1wb3J0U2NyaXB0cyBvbmx5IHRha2VzIGZ1bGx5IHF1YWxpZmllZCB1cmxzXG4gICAgICAgIHZhciBzY3JpcHQgPSBcImltcG9ydFNjcmlwdHMoJ1wiICsgcXVhbGlmeVVSTCh3b3JrZXJVcmwpICsgXCInKTtcIjtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgQmxvYihbc2NyaXB0XSwgeyBcInR5cGVcIjogXCJhcHBsaWNhdGlvbi9qYXZhc2NyaXB0XCIgfSk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGUpIHsgLy8gQmFja3dhcmRzLWNvbXBhdGliaWxpdHlcbiAgICAgICAgICAgIHZhciBCbG9iQnVpbGRlciA9IHdpbmRvd1snQmxvYkJ1aWxkZXInXSB8fCB3aW5kb3dbJ1dlYktpdEJsb2JCdWlsZGVyJ10gfHwgd2luZG93WydNb3pCbG9iQnVpbGRlciddO1xuICAgICAgICAgICAgdmFyIGJsb2JCdWlsZGVyID0gbmV3IEJsb2JCdWlsZGVyKCk7XG4gICAgICAgICAgICBibG9iQnVpbGRlci5hcHBlbmQoc2NyaXB0KTtcbiAgICAgICAgICAgIHJldHVybiBibG9iQnVpbGRlci5nZXRCbG9iKFwiYXBwbGljYXRpb24vamF2YXNjcmlwdFwiKTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuIl19