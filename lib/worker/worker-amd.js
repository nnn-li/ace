"no use strict";
;
(function (window) {
    if (typeof window.window != "undefined" && window.document) {
        return;
    }
    window.console = function () {
        var msgs = Array.prototype.slice.call(arguments, 0);
        window.postMessage({ type: "log", data: msgs });
    };
    window.console.error =
        window.console.warn =
            window.console.log =
                window.console.trace = window.console;
    window.window = window;
    window.ace = window;
    window.onerror = function (message, file, line, col, err) {
        console.error("Worker " + (err ? err.stack : message));
    };
    window.normalizeModule = function (parentId, moduleName) {
        if (moduleName.indexOf("!") !== -1) {
            var chunks = moduleName.split("!");
            return window.normalizeModule(parentId, chunks[0]) + "!" + window.normalizeModule(parentId, chunks[1]);
        }
        if (moduleName.charAt(0) == ".") {
            var base = parentId.split("/").slice(0, -1).join("/");
            moduleName = (base ? base + "/" : "") + moduleName;
            while (moduleName.indexOf(".") !== -1 && previous != moduleName) {
                var previous = moduleName;
                moduleName = moduleName.replace(/^\.\//, "").replace(/\/\.\//, "/").replace(/[^\/]+\/\.\.\//, "");
            }
        }
        return moduleName;
    };
    window.require = function (parentId, id) {
        if (!id) {
            id = parentId;
            parentId = null;
        }
        if (!id.charAt)
            throw new Error("worker.js require() accepts only (parentId, id) as arguments");
        id = window.normalizeModule(parentId, id);
        var module = window.require.modules[id];
        if (module) {
            if (!module.initialized) {
                module.initialized = true;
                module.exports = module.factory().exports;
            }
            return module.exports;
        }
        var chunks = id.split("/");
        if (!window.require.tlns)
            return console.log("unable to load " + id);
        chunks[0] = window.require.tlns[chunks[0]] || chunks[0];
        var path = chunks.join("/") + ".js";
        window.require.id = id;
        importScripts(path);
        return window.require(parentId, id);
    };
    window.require.modules = {};
    window.require.tlns = {};
    window.define = function (id, deps, factory) {
        if (arguments.length == 2) {
            factory = deps;
            if (typeof id != "string") {
                deps = id;
                id = window.require.id;
            }
        }
        else if (arguments.length == 1) {
            factory = id;
            deps = [];
            id = window.require.id;
        }
        if (!deps.length)
            deps = ['require', 'exports', 'module'];
        if (id.indexOf("text!") === 0)
            return;
        var req = function (childId) {
            return window.require(id, childId);
        };
        window.require.modules[id] = {
            exports: {},
            factory: function () {
                var module = this;
                var returnExports = factory.apply(this, deps.map(function (dep) {
                    switch (dep) {
                        case 'require': return req;
                        case 'exports': return module.exports;
                        case 'module': return module;
                        default: return req(dep);
                    }
                }));
                if (returnExports)
                    module.exports = returnExports;
                return module;
            }
        };
    };
    window.define.amd = {};
    window.initBaseUrls = function initBaseUrls(topLevelNamespaces) {
        window.require.tlns = topLevelNamespaces;
    };
    window.initSender = function initSender() {
        var EventEmitter = window.require("ace/lib/event_emitter").EventEmitter;
        var oop = window.require("ace/lib/oop");
        var Sender = function () { };
        (function () {
            oop.implement(this, EventEmitter);
            this.callback = function (data, callbackId) {
                window.postMessage({
                    type: "call",
                    id: callbackId,
                    data: data
                });
            };
            this.emit = function (name, data) {
                window.postMessage({
                    type: "event",
                    name: name,
                    data: data
                });
            };
        }).call(Sender.prototype);
        return new Sender();
    };
    var main = window.main = null;
    var sender = window.sender = null;
    window.onmessage = function (e) {
        var msg = e.data;
        if (msg.command) {
            if (main[msg.command]) {
                main[msg.command].apply(main, msg.args);
            }
            else {
                throw new Error("Unknown command:" + msg.command);
            }
        }
        else if (msg.init) {
            window.initBaseUrls(msg.tlns);
            sender = window.sender = window.initSender();
            var clazz = window.require(msg.module)[msg.classname];
            main = window.main = new clazz(sender);
        }
        else if (msg.event && sender) {
            sender._signal(msg.event, msg.data);
        }
    };
})(this);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid29ya2VyLWFtZC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy93b3JrZXIvd29ya2VyLWFtZC50cyJdLCJuYW1lcyI6WyJpbml0QmFzZVVybHMiLCJpbml0U2VuZGVyIl0sIm1hcHBpbmdzIjoiQUFBQSxlQUFlLENBQUM7QUFDaEIsQ0FBQztBQUFDLENBQUMsVUFBUyxNQUFNO0lBQ2QsRUFBRSxDQUFDLENBQUMsT0FBTyxNQUFNLENBQUMsTUFBTSxJQUFJLFdBQVcsSUFBSSxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQztRQUN6RCxNQUFNLENBQUM7SUFDWCxDQUFDO0lBRUQsTUFBTSxDQUFDLE9BQU8sR0FBRztRQUNiLElBQUksSUFBSSxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDcEQsTUFBTSxDQUFDLFdBQVcsQ0FBQyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7SUFDcEQsQ0FBQyxDQUFDO0lBQ0YsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLO1FBQ2hCLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSTtZQUNuQixNQUFNLENBQUMsT0FBTyxDQUFDLEdBQUc7Z0JBQ2xCLE1BQU0sQ0FBQyxPQUFPLENBQUMsS0FBSyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUM7SUFFMUMsTUFBTSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7SUFDdkIsTUFBTSxDQUFDLEdBQUcsR0FBRyxNQUFNLENBQUM7SUFFcEIsTUFBTSxDQUFDLE9BQU8sR0FBRyxVQUFTLE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxHQUFHO1FBQ25ELE9BQU8sQ0FBQyxLQUFLLENBQUMsU0FBUyxHQUFHLENBQUMsR0FBRyxHQUFHLEdBQUcsQ0FBQyxLQUFLLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQztJ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LENBQUM7QUFDTixDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIlwibm8gdXNlIHN0cmljdFwiO1xuOyAoZnVuY3Rpb24od2luZG93KSB7XG4gICAgaWYgKHR5cGVvZiB3aW5kb3cud2luZG93ICE9IFwidW5kZWZpbmVkXCIgJiYgd2luZG93LmRvY3VtZW50KSB7XG4gICAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB3aW5kb3cuY29uc29sZSA9IGZ1bmN0aW9uKCkge1xuICAgICAgICB2YXIgbXNncyA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMCk7XG4gICAgICAgIHdpbmRvdy5wb3N0TWVzc2FnZSh7IHR5cGU6IFwibG9nXCIsIGRhdGE6IG1zZ3MgfSk7XG4gICAgfTtcbiAgICB3aW5kb3cuY29uc29sZS5lcnJvciA9XG4gICAgICAgIHdpbmRvdy5jb25zb2xlLndhcm4gPVxuICAgICAgICB3aW5kb3cuY29uc29sZS5sb2cgPVxuICAgICAgICB3aW5kb3cuY29uc29sZS50cmFjZSA9IHdpbmRvdy5jb25zb2xlO1xuXG4gICAgd2luZG93LndpbmRvdyA9IHdpbmRvdztcbiAgICB3aW5kb3cuYWNlID0gd2luZG93O1xuXG4gICAgd2luZG93Lm9uZXJyb3IgPSBmdW5jdGlvbihtZXNzYWdlLCBmaWxlLCBsaW5lLCBjb2wsIGVycikge1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiV29ya2VyIFwiICsgKGVyciA/IGVyci5zdGFjayA6IG1lc3NhZ2UpKTtcbiAgICB9O1xuXG4gICAgd2luZG93Lm5vcm1hbGl6ZU1vZHVsZSA9IGZ1bmN0aW9uKHBhcmVudElkLCBtb2R1bGVOYW1lKSB7XG4gICAgICAgIC8vIG5vcm1hbGl6ZSBwbHVnaW4gcmVxdWlyZXNcbiAgICAgICAgaWYgKG1vZHVsZU5hbWUuaW5kZXhPZihcIiFcIikgIT09IC0xKSB7XG4gICAgICAgICAgICB2YXIgY2h1bmtzID0gbW9kdWxlTmFtZS5zcGxpdChcIiFcIik7XG4gICAgICAgICAgICByZXR1cm4gd2luZG93Lm5vcm1hbGl6ZU1vZHVsZShwYXJlbnRJZCwgY2h1bmtzWzBdKSArIFwiIVwiICsgd2luZG93Lm5vcm1hbGl6ZU1vZHVsZShwYXJlbnRJZCwgY2h1bmtzWzFdKTtcbiAgICAgICAgfVxuICAgICAgICAvLyBub3JtYWxpemUgcmVsYXRpdmUgcmVxdWlyZXNcbiAgICAgICAgaWYgKG1vZHVsZU5hbWUuY2hhckF0KDApID09IFwiLlwiKSB7XG4gICAgICAgICAgICB2YXIgYmFzZSA9IHBhcmVudElkLnNwbGl0KFwiL1wiKS5zbGljZSgwLCAtMSkuam9pbihcIi9cIik7XG4gICAgICAgICAgICBtb2R1bGVOYW1lID0gKGJhc2UgPyBiYXNlICsgXCIvXCIgOiBcIlwiKSArIG1vZHVsZU5hbWU7XG5cbiAgICAgICAgICAgIHdoaWxlIChtb2R1bGVOYW1lLmluZGV4T2YoXCIuXCIpICE9PSAtMSAmJiBwcmV2aW91cyAhPSBtb2R1bGVOYW1lKSB7XG4gICAgICAgICAgICAgICAgdmFyIHByZXZpb3VzID0gbW9kdWxlTmFtZTtcbiAgICAgICAgICAgICAgICBtb2R1bGVOYW1lID0gbW9kdWxlTmFtZS5yZXBsYWNlKC9eXFwuXFwvLywgXCJcIikucmVwbGFjZSgvXFwvXFwuXFwvLywgXCIvXCIpLnJlcGxhY2UoL1teXFwvXStcXC9cXC5cXC5cXC8vLCBcIlwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBtb2R1bGVOYW1lO1xuICAgIH07XG5cbiAgICB3aW5kb3cucmVxdWlyZSA9IGZ1bmN0aW9uKHBhcmVudElkLCBpZCkge1xuICAgICAgICBpZiAoIWlkKSB7XG4gICAgICAgICAgICBpZCA9IHBhcmVudElkO1xuICAgICAgICAgICAgcGFyZW50SWQgPSBudWxsO1xuICAgICAgICB9XG4gICAgICAgIGlmICghaWQuY2hhckF0KVxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwid29ya2VyLmpzIHJlcXVpcmUoKSBhY2NlcHRzIG9ubHkgKHBhcmVudElkLCBpZCkgYXMgYXJndW1lbnRzXCIpO1xuXG4gICAgICAgIGlkID0gd2luZG93Lm5vcm1hbGl6ZU1vZHVsZShwYXJlbnRJZCwgaWQpO1xuXG4gICAgICAgIHZhciBtb2R1bGUgPSB3aW5kb3cucmVxdWlyZS5tb2R1bGVzW2lkXTtcbiAgICAgICAgaWYgKG1vZHVsZSkge1xuICAgICAgICAgICAgaWYgKCFtb2R1bGUuaW5pdGlhbGl6ZWQpIHtcbiAgICAgICAgICAgICAgICBtb2R1bGUuaW5pdGlhbGl6ZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIG1vZHVsZS5leHBvcnRzID0gbW9kdWxlLmZhY3RvcnkoKS5leHBvcnRzO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIG1vZHVsZS5leHBvcnRzO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFyIGNodW5rcyA9IGlkLnNwbGl0KFwiL1wiKTtcbiAgICAgICAgaWYgKCF3aW5kb3cucmVxdWlyZS50bG5zKVxuICAgICAgICAgICAgcmV0dXJuIGNvbnNvbGUubG9nKFwidW5hYmxlIHRvIGxvYWQgXCIgKyBpZCk7XG4gICAgICAgIGNodW5rc1swXSA9IHdpbmRvdy5yZXF1aXJlLnRsbnNbY2h1bmtzWzBdXSB8fCBjaHVua3NbMF07XG4gICAgICAgIHZhciBwYXRoID0gY2h1bmtzLmpvaW4oXCIvXCIpICsgXCIuanNcIjtcblxuICAgICAgICB3aW5kb3cucmVxdWlyZS5pZCA9IGlkO1xuICAgICAgICBpbXBvcnRTY3JpcHRzKHBhdGgpO1xuICAgICAgICByZXR1cm4gd2luZG93LnJlcXVpcmUocGFyZW50SWQsIGlkKTtcbiAgICB9O1xuICAgIHdpbmRvdy5yZXF1aXJlLm1vZHVsZXMgPSB7fTtcbiAgICB3aW5kb3cucmVxdWlyZS50bG5zID0ge307XG5cbiAgICB3aW5kb3cuZGVmaW5lID0gZnVuY3Rpb24oaWQsIGRlcHMsIGZhY3RvcnkpIHtcbiAgICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT0gMikge1xuICAgICAgICAgICAgZmFjdG9yeSA9IGRlcHM7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGlkICE9IFwic3RyaW5nXCIpIHtcbiAgICAgICAgICAgICAgICBkZXBzID0gaWQ7XG4gICAgICAgICAgICAgICAgaWQgPSB3aW5kb3cucmVxdWlyZS5pZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIGlmIChhcmd1bWVudHMubGVuZ3RoID09IDEpIHtcbiAgICAgICAgICAgIGZhY3RvcnkgPSBpZDtcbiAgICAgICAgICAgIGRlcHMgPSBbXTtcbiAgICAgICAgICAgIGlkID0gd2luZG93LnJlcXVpcmUuaWQ7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWRlcHMubGVuZ3RoKVxuICAgICAgICAgICAgLy8gSWYgdGhlcmUgaXMgbm8gZGVwZW5kZW5jaWVzLCB3ZSBpbmplY3QgJ3JlcXVpcmUnLCAnZXhwb3J0cycgYW5kXG4gICAgICAgICAgICAvLyAnbW9kdWxlJyBhcyBkZXBlbmRlbmNpZXMsIHRvIHByb3ZpZGUgQ29tbW9uSlMgY29tcGF0aWJpbGl0eS5cbiAgICAgICAgICAgIGRlcHMgPSBbJ3JlcXVpcmUnLCAnZXhwb3J0cycsICdtb2R1bGUnXTtcblxuICAgICAgICBpZiAoaWQuaW5kZXhPZihcInRleHQhXCIpID09PSAwKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIHZhciByZXEgPSBmdW5jdGlvbihjaGlsZElkKSB7XG4gICAgICAgICAgICByZXR1cm4gd2luZG93LnJlcXVpcmUoaWQsIGNoaWxkSWQpO1xuICAgICAgICB9O1xuXG4gICAgICAgIHdpbmRvdy5yZXF1aXJlLm1vZHVsZXNbaWRdID0ge1xuICAgICAgICAgICAgZXhwb3J0czoge30sXG4gICAgICAgICAgICBmYWN0b3J5OiBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICB2YXIgbW9kdWxlID0gdGhpcztcbiAgICAgICAgICAgICAgICB2YXIgcmV0dXJuRXhwb3J0cyA9IGZhY3RvcnkuYXBwbHkodGhpcywgZGVwcy5tYXAoZnVuY3Rpb24oZGVwKSB7XG4gICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoZGVwKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBCZWNhdXNlICdyZXF1aXJlJywgJ2V4cG9ydHMnIGFuZCAnbW9kdWxlJyBhcmVuJ3QgYWN0dWFsXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBkZXBlbmRlbmNpZXMsIHdlIG11c3QgaGFuZGxlIHRoZW0gc2VwZXJhdGVseS5cbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ3JlcXVpcmUnOiByZXR1cm4gcmVxO1xuICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAnZXhwb3J0cyc6IHJldHVybiBtb2R1bGUuZXhwb3J0cztcbiAgICAgICAgICAgICAgICAgICAgICAgIGNhc2UgJ21vZHVsZSc6IHJldHVybiBtb2R1bGU7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBCdXQgZm9yIGFsbCBvdGhlciBkZXBlbmRlbmNpZXMsIHdlIGNhbiBqdXN0IGdvIGFoZWFkIGFuZFxuICAgICAgICAgICAgICAgICAgICAgICAgLy8gcmVxdWlyZSB0aGVtLlxuICAgICAgICAgICAgICAgICAgICAgICAgZGVmYXVsdDogcmV0dXJuIHJlcShkZXApO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfSkpO1xuICAgICAgICAgICAgICAgIGlmIChyZXR1cm5FeHBvcnRzKVxuICAgICAgICAgICAgICAgICAgICBtb2R1bGUuZXhwb3J0cyA9IHJldHVybkV4cG9ydHM7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG1vZHVsZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICB9O1xuICAgIHdpbmRvdy5kZWZpbmUuYW1kID0ge307XG5cbiAgICB3aW5kb3cuaW5pdEJhc2VVcmxzID0gZnVuY3Rpb24gaW5pdEJhc2VVcmxzKHRvcExldmVsTmFtZXNwYWNlczogeyBbbnM6IHN0cmluZ106IHN0cmluZyB9KSB7XG4gICAgICAgIHdpbmRvdy5yZXF1aXJlLnRsbnMgPSB0b3BMZXZlbE5hbWVzcGFjZXM7XG4gICAgfTtcblxuICAgIHdpbmRvdy5pbml0U2VuZGVyID0gZnVuY3Rpb24gaW5pdFNlbmRlcigpIHtcblxuICAgICAgICB2YXIgRXZlbnRFbWl0dGVyID0gd2luZG93LnJlcXVpcmUoXCJhY2UvbGliL2V2ZW50X2VtaXR0ZXJcIikuRXZlbnRFbWl0dGVyO1xuICAgICAgICB2YXIgb29wID0gd2luZG93LnJlcXVpcmUoXCJhY2UvbGliL29vcFwiKTtcblxuICAgICAgICB2YXIgU2VuZGVyID0gZnVuY3Rpb24oKSB7IH07XG5cbiAgICAgICAgKGZ1bmN0aW9uKCkge1xuXG4gICAgICAgICAgICBvb3AuaW1wbGVtZW50KHRoaXMsIEV2ZW50RW1pdHRlcik7XG5cbiAgICAgICAgICAgIHRoaXMuY2FsbGJhY2sgPSBmdW5jdGlvbihkYXRhLCBjYWxsYmFja0lkKSB7XG4gICAgICAgICAgICAgICAgd2luZG93LnBvc3RNZXNzYWdlKHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogXCJjYWxsXCIsXG4gICAgICAgICAgICAgICAgICAgIGlkOiBjYWxsYmFja0lkLFxuICAgICAgICAgICAgICAgICAgICBkYXRhOiBkYXRhXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgICAgICB0aGlzLmVtaXQgPSBmdW5jdGlvbihuYW1lLCBkYXRhKSB7XG4gICAgICAgICAgICAgICAgd2luZG93LnBvc3RNZXNzYWdlKHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogXCJldmVudFwiLFxuICAgICAgICAgICAgICAgICAgICBuYW1lOiBuYW1lLFxuICAgICAgICAgICAgICAgICAgICBkYXRhOiBkYXRhXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9O1xuXG4gICAgICAgIH0pLmNhbGwoU2VuZGVyLnByb3RvdHlwZSk7XG5cbiAgICAgICAgcmV0dXJuIG5ldyBTZW5kZXIoKTtcbiAgICB9O1xuXG4gICAgLyoqXG4gICAgICogbWFpbiBpcyB0aGUgaW5zdGFuY2UgdGhhdCB3ZSBhcmUgY3JlYXRpbmc/XG4gICAgICovXG4gICAgdmFyIG1haW4gPSB3aW5kb3cubWFpbiA9IG51bGw7XG4gICAgLyoqXG4gICAgICogc2VuZGVyIGFsbG93cyB1cyB0byBjb21tdW5pY2F0ZSBiYWNrIHRvIHRoZSBXb3JrZXJDbGllbnQ/XG4gICAgICovXG4gICAgdmFyIHNlbmRlciA9IHdpbmRvdy5zZW5kZXIgPSBudWxsO1xuXG4gICAgd2luZG93Lm9ubWVzc2FnZSA9IGZ1bmN0aW9uKGU6IE1lc3NhZ2VFdmVudCkge1xuICAgICAgICB2YXIgbXNnID0gZS5kYXRhO1xuICAgICAgICBpZiAobXNnLmNvbW1hbmQpIHtcbiAgICAgICAgICAgIGlmIChtYWluW21zZy5jb21tYW5kXSkge1xuICAgICAgICAgICAgICAgIG1haW5bbXNnLmNvbW1hbmRdLmFwcGx5KG1haW4sIG1zZy5hcmdzKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihcIlVua25vd24gY29tbWFuZDpcIiArIG1zZy5jb21tYW5kKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChtc2cuaW5pdCkge1xuICAgICAgICAgICAgd2luZG93LmluaXRCYXNlVXJscyhtc2cudGxucyk7XG4gICAgICAgICAgICAvKiB3aW5kb3cucmVxdWlyZShcImFjZS9saWIvZXM1LXNoaW1cIik7ICovXG4gICAgICAgICAgICBzZW5kZXIgPSB3aW5kb3cuc2VuZGVyID0gd2luZG93LmluaXRTZW5kZXIoKTtcbiAgICAgICAgICAgIC8vIFRPRE86IHJlcXVpcmUgPT4gU3lzdGVtLmltcG9ydFxuICAgICAgICAgICAgdmFyIGNsYXp6ID0gd2luZG93LnJlcXVpcmUobXNnLm1vZHVsZSlbbXNnLmNsYXNzbmFtZV07XG4gICAgICAgICAgICAvLyBUT0RPOiBXaHkgaXMgc2VuZGVyIHBhc3NlZCBpbiB0aGUgY29uc3RydWN0b3I/XG4gICAgICAgICAgICBtYWluID0gd2luZG93Lm1haW4gPSBuZXcgY2xhenooc2VuZGVyKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChtc2cuZXZlbnQgJiYgc2VuZGVyKSB7XG4gICAgICAgICAgICBzZW5kZXIuX3NpZ25hbChtc2cuZXZlbnQsIG1zZy5kYXRhKTtcbiAgICAgICAgfVxuICAgIH07XG59KSh0aGlzKTsiXX0=