import { qualifyURL } from '../lib/net';
import EventEmitterClass from '../lib/event_emitter';
export default class WorkerClient extends EventEmitterClass {
    constructor(workerUrl) {
        super();
        this.callbacks = {};
        this.callbackId = 1;
        this.$sendDeltaQueue = this.$sendDeltaQueue.bind(this);
        this.changeListener = this.changeListener.bind(this);
        this.onMessage = this.onMessage.bind(this);
        var workerUrl = qualifyURL(workerUrl);
        try {
            this.$worker = new Worker(workerUrl);
        }
        catch (e) {
            if (e instanceof window['DOMException']) {
                var blob = this.$workerBlob(workerUrl);
                var URL = window['URL'] || window['webkitURL'];
                var blobURL = URL.createObjectURL(blob);
                this.$worker = new Worker(blobURL);
                URL.revokeObjectURL(blobURL);
            }
            else {
                throw e;
            }
        }
        this.$worker.onmessage = this.onMessage;
    }
    init(moduleName, className) {
        var tlns = {};
        this.$worker.postMessage({ init: true, tlns: tlns, module: moduleName, classname: className });
    }
    onMessage(event) {
        var origin = event.origin;
        var source = event.source;
        var msg = event.data;
        switch (msg.type) {
            case "log":
                window.console && console.log && console.log.apply(console, msg.data);
                break;
            case "event":
                this._signal(msg.name, { data: msg.data });
                break;
            case "call":
                var callback = this.callbacks[msg.id];
                if (callback) {
                    callback(msg.data);
                    delete this.callbacks[msg.id];
                }
                break;
        }
    }
    $normalizePath(path) {
        return qualifyURL(path);
    }
    terminate() {
        this._signal("terminate", {});
        this.deltaQueue = null;
        this.$worker.terminate();
        this.$worker = null;
        this.detachFromDocument();
    }
    send(cmd, args) {
        this.$worker.postMessage({ command: cmd, args: args });
    }
    call(cmd, args, callback) {
        if (callback) {
            var id = this.callbackId++;
            this.callbacks[id] = callback;
            args.push(id);
        }
        this.send(cmd, args);
    }
    emit(event, data) {
        try {
            this.$worker.postMessage({ event: event, data: { data: data.data } });
        }
        catch (e) {
            console.error(e.stack);
        }
    }
    attachToDocument(doc) {
        if (this.$doc) {
            this.terminate();
        }
        this.$doc = doc;
        this.call("setValue", [doc.getValue()]);
        doc.on('change', this.changeListener);
    }
    detachFromDocument() {
        this.$doc.off('change', this.changeListener);
        this.$doc = null;
    }
    changeListener(e, doc) {
        if (!this.deltaQueue) {
            this.deltaQueue = [e.data];
            setTimeout(this.$sendDeltaQueue, 0);
        }
        else {
            this.deltaQueue.push(e.data);
        }
    }
    $sendDeltaQueue() {
        var doc = this.$doc;
        var q = this.deltaQueue;
        if (!q)
            return;
        this.deltaQueue = null;
        if (q.length > 20 && q.length > doc.getLength() >> 1) {
            this.call("setValue", [doc.getValue()]);
        }
        else
            this.emit("change", { data: q });
    }
    $workerBlob(workerUrl) {
        var script = "importScripts('" + qualifyURL(workerUrl) + "');";
        try {
            return new Blob([script], { "type": "application/javascript" });
        }
        catch (e) {
            var BlobBuilder = window['BlobBuilder'] || window['WebKitBlobBuilder'] || window['MozBlobBuilder'];
            var blobBuilder = new BlobBuilder();
            blobBuilder.append(script);
            return blobBuilder.getBlob("application/javascript");
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV29ya2VyQ2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3dvcmtlci9Xb3JrZXJDbGllbnQudHMiXSwibmFtZXMiOlsiV29ya2VyQ2xpZW50IiwiV29ya2VyQ2xpZW50LmNvbnN0cnVjdG9yIiwiV29ya2VyQ2xpZW50LmluaXQiLCJXb3JrZXJDbGllbnQub25NZXNzYWdlIiwiV29ya2VyQ2xpZW50LiRub3JtYWxpemVQYXRoIiwiV29ya2VyQ2xpZW50LnRlcm1pbmF0ZSIsIldvcmtlckNsaWVudC5zZW5kIiwiV29ya2VyQ2xpZW50LmNhbGwiLCJXb3JrZXJDbGllbnQuZW1pdCIsIldvcmtlckNsaWVudC5hdHRhY2hUb0RvY3VtZW50IiwiV29ya2VyQ2xpZW50LmRldGFjaEZyb21Eb2N1bWVudCIsIldvcmtlckNsaWVudC5jaGFuZ2VMaXN0ZW5lciIsIldvcmtlckNsaWVudC4kc2VuZERlbHRhUXVldWUiLCJXb3JrZXJDbGllbnQuJHdvcmtlckJsb2IiXSwibWFwcGluZ3MiOiJPQUFPLEVBQUMsVUFBVSxFQUFDLE1BQU0sWUFBWTtPQUU5QixpQkFBaUIsTUFBTSxzQkFBc0I7QUFNcEQsMENBQTBDLGlCQUFpQjtJQU12REEsWUFBWUEsU0FBaUJBO1FBQ3pCQyxPQUFPQSxDQUFDQTtRQUpKQSxjQUFTQSxHQUF5Q0EsRUFBRUEsQ0FBQ0E7UUFDckRBLGVBQVVBLEdBQVdBLENBQUNBLENBQUNBO1FBSTNCQSxJQUFJQSxDQUFDQSxlQUFlQSxHQUFHQSxJQUFJQSxDQUFDQSxlQUFlQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUN2REEsSUFBSUEsQ0FBQ0EsY0FBY0EsR0FBR0EsSUFBSUEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDckRBLElBQUlBLENBQUNBLFNBQVNBLEdBQUdBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO1FBRTNDQSxJQUFJQSxTQUFTQSxHQUFHQSxVQUFVQSxDQUFDQSxTQUFTQSxDQUFDQSxDQUFDQTtRQUV0Q0EsSUFBSUEsQ0FBQ0E7WUFDREEsSUFBSUEsQ0FBQ0EsT0FBT0EsR0FBR0EsSUFBSUEsTUFBTUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQ0E7UUFDekNBLENBQ0FBO1FBQUFBLEtBQUtBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBQ1BBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLFlBQVlBLE1BQU1BLENBQUNBLGNBQWNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO2dCQUV0Q0EsSUFBSUEsSUFBSUEsR0FBU0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQ0E7Z0JBQzdDQSxJQUFJQSxHQUFHQSxHQUFRQSxNQUFNQSxDQUFDQSxLQUFLQSxDQUFDQSxJQUFJQSxNQUFNQSxDQUFDQSxXQUFXQSxDQUFDQSxDQUFDQTtnQkFDcERBLElBQUlBLE9BQU9BLEdBQVdBLEdBQUdBLENBQUNBLGVBQWVBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO2dCQUVoREEsSUFBSUEsQ0FBQ0EsT0FBT0EsR0FBR0EsSUFBSUEsTUFBTUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ25DQSxHQUFHQSxDQUFDQSxlQUFlQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQTtZQUNqQ0EsQ0FBQ0E7WUFDREEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7Z0JBQ0ZBLE1BQU1BLENBQUNBLENBQUNBO1lBQ1pBLENBQUNBO1FBQ0xBLENBQUNBO1FBR0RBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLFNBQVNBLEdBQUdBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBO0lBQzVDQSxDQUFDQTtJQUVERCxJQUFJQSxDQUFDQSxVQUFrQkEsRUFBRUEsU0FBaUJBO1FBQ3RDRSxJQUFJQSxJQUFJQSxHQUE2QkEsRUFBRUEsQ0FBQ0E7UUFFeENBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLFdBQVdBLENBQUNBLEVBQUVBLElBQUlBLEVBQUVBLElBQUlBLEVBQUVBLElBQUlBLEVBQUVBLElBQUlBLEVBQUVBLE1BQU1BLEVBQUVBLFVBQVVBLEVBQUVBLFNBQVNBLEVBQUVBLFNBQVNBLEVBQUVBLENBQUNBLENBQUNBO0lBQ25HQSxDQUFDQTtJQUVERixTQUFTQSxDQUFDQSxLQUFtQkE7UUFDekJHLElBQUlBLE1BQU1BLEdBQVdBLEtBQUtBLENBQUNBLE1BQU1BLENBQUNBO1FBQ2xDQSxJQUFJQSxNQUFNQSxHQUFXQSxLQUFLQSxDQUFDQSxNQUFNQSxDQUFDQTtRQUNsQ0EsSUFBSUEsR0FBR0EsR0FBR0EsS0FBS0EsQ0FBQ0EsSUFBSUEsQ0FBQ0E7UUFDckJBLE1BQU1BLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLENBQUNBO1lBQ2ZBLEtBQUtBLEtBQUtBO2dCQUNOQSxNQUFNQSxDQUFDQSxPQUFPQSxJQUFJQSxPQUFPQSxDQUFDQSxHQUFHQSxJQUFJQSxPQUFPQSxDQUFDQSxHQUFHQSxDQUFDQSxLQUFLQSxDQUFDQSxPQUFPQSxFQUFFQSxHQUFHQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtnQkFDdEVBLEtBQUtBLENBQUNBO1lBRVZBLEtBQUtBLE9BQU9BO2dCQUNSQSxJQUFJQSxDQUFDQSxPQUFPQSxDQUFDQSxHQUFHQSxDQUFDQSxJQUFJQSxFQUFFQSxFQUFFQSxJQUFJQSxFQUFFQSxHQUFHQSxDQUFDQSxJQUFJQSxFQUFFQSxDQUFDQSxDQUFDQTtnQkFDM0NBLEtBQUtBLENBQUNBO1lBRVZBLEtBQUtBLE1BQU1BO2dCQUNQQSxJQUFJQSxRQUFRQSxHQUFHQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQTtnQkFDdENBLEVBQUVBLENBQUNBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBLENBQUNBO29CQUNYQSxRQUFRQSxDQUFDQSxHQUFHQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtvQkFDbkJBLE9BQU9B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QUFJQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQTtJQUN6Q0EsQ0FBQ0E7SUFFRFosV0FBV0EsQ0FBQ0EsU0FBaUJBO1FBR3pCYSxJQUFJQSxNQUFNQSxHQUFHQSxpQkFBaUJBLEdBQUdBLFVBQVVBLENBQUNBLFNBQVNBLENBQUNBLEdBQUdBLEtBQUtBLENBQUNBO1FBQy9EQSxJQUFJQSxDQUFDQTtZQUNEQSxNQUFNQSxDQUFDQSxJQUFJQSxJQUFJQSxDQUFDQSxDQUFDQSxNQUFNQSxDQUFDQSxFQUFFQSxFQUFFQSxNQUFNQSxFQUFFQSx3QkFBd0JBLEVBQUVBLENBQUNBLENBQUNBO1FBQ3BFQSxDQUNBQTtRQUFBQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNQQSxJQUFJQSxXQUFXQSxHQUFHQSxNQUFNQSxDQUFDQSxhQUFhQSxDQUFDQSxJQUFJQSxNQUFNQSxDQUFDQSxtQkFBbUJBLENBQUNBLElBQUlBLE1BQU1BLENBQUNBLGdCQUFnQkEsQ0FBQ0EsQ0FBQ0E7WUFDbkdBLElBQUlBLFdBQVdBLEdBQUdBLElBQUlBLFdBQVdBLEVBQUVBLENBQUNBO1lBQ3BDQSxXQUFXQSxDQUFDQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQTtZQUMzQkEsTUFBTUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsT0FBT0EsQ0FBQ0Esd0JBQXdCQSxDQUFDQSxDQUFDQTtRQUN6REEsQ0FBQ0E7SUFDTEEsQ0FBQ0E7QUFDTGIsQ0FBQ0E7QUFBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7cXVhbGlmeVVSTH0gZnJvbSAnLi4vbGliL25ldCc7XG5pbXBvcnQgRWRpdG9yRG9jdW1lbnQgZnJvbSBcIi4uL0VkaXRvckRvY3VtZW50XCI7XG5pbXBvcnQgRXZlbnRFbWl0dGVyQ2xhc3MgZnJvbSAnLi4vbGliL2V2ZW50X2VtaXR0ZXInO1xuaW1wb3J0IHtnZXQsIG1vZHVsZVVybH0gZnJvbSBcIi4uL2NvbmZpZ1wiO1xuXG4vKipcbiAqIFdvcmtlckNsaWVudCBtYW5hZ2VzIHRoZSBjb21tdW5pY2F0aW9uIHdpdGggYSBXZWIgV29ya2VyLlxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBXb3JrZXJDbGllbnQgZXh0ZW5kcyBFdmVudEVtaXR0ZXJDbGFzcyB7XG4gICAgcHJpdmF0ZSAkd29ya2VyOiBXb3JrZXI7XG4gICAgcHJpdmF0ZSBkZWx0YVF1ZXVlOiBhbnlbXTtcbiAgICBwcml2YXRlIGNhbGxiYWNrczogeyBbaWQ6IG51bWJlcl06IChkYXRhOiBhbnkpID0+IGFueSB9ID0ge307XG4gICAgcHJpdmF0ZSBjYWxsYmFja0lkOiBudW1iZXIgPSAxO1xuICAgIHByaXZhdGUgJGRvYzogRWRpdG9yRG9jdW1lbnQ7XG4gICAgY29uc3RydWN0b3Iod29ya2VyVXJsOiBzdHJpbmcpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgdGhpcy4kc2VuZERlbHRhUXVldWUgPSB0aGlzLiRzZW5kRGVsdGFRdWV1ZS5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLmNoYW5nZUxpc3RlbmVyID0gdGhpcy5jaGFuZ2VMaXN0ZW5lci5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLm9uTWVzc2FnZSA9IHRoaXMub25NZXNzYWdlLmJpbmQodGhpcyk7XG5cbiAgICAgICAgdmFyIHdvcmtlclVybCA9IHF1YWxpZnlVUkwod29ya2VyVXJsKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdGhpcy4kd29ya2VyID0gbmV3IFdvcmtlcih3b3JrZXJVcmwpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICBpZiAoZSBpbnN0YW5jZW9mIHdpbmRvd1snRE9NRXhjZXB0aW9uJ10pIHtcbiAgICAgICAgICAgICAgICAvLyBMaWtlbHkgc2FtZSBvcmlnaW4gcHJvYmxlbS4gVXNlIGltcG9ydFNjcmlwdHMgZnJvbSBhIHNoaW0gV29ya2VyLlxuICAgICAgICAgICAgICAgIHZhciBibG9iOiBCbG9iID0gdGhpcy4kd29ya2VyQmxvYih3b3JrZXJVcmwpO1xuICAgICAgICAgICAgICAgIHZhciBVUkw6IFVSTCA9IHdpbmRvd1snVVJMJ10gfHwgd2luZG93Wyd3ZWJraXRVUkwnXTtcbiAgICAgICAgICAgICAgICB2YXIgYmxvYlVSTDogc3RyaW5nID0gVVJMLmNyZWF0ZU9iamVjdFVSTChibG9iKTtcblxuICAgICAgICAgICAgICAgIHRoaXMuJHdvcmtlciA9IG5ldyBXb3JrZXIoYmxvYlVSTCk7XG4gICAgICAgICAgICAgICAgVVJMLnJldm9rZU9iamVjdFVSTChibG9iVVJMKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHRocm93IGU7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cblxuICAgICAgICAvLyBBZGQgYW4gRXZlbnRMaXN0ZW5lciBmb3IgZGF0YSB0aGUgd29ya2VyIHJldHVybnMuXG4gICAgICAgIHRoaXMuJHdvcmtlci5vbm1lc3NhZ2UgPSB0aGlzLm9uTWVzc2FnZTtcbiAgICB9XG5cbiAgICBpbml0KG1vZHVsZU5hbWU6IHN0cmluZywgY2xhc3NOYW1lOiBzdHJpbmcpOiB2b2lkIHtcbiAgICAgICAgdmFyIHRsbnM6IHsgW25zOiBzdHJpbmddOiBzdHJpbmcgfSA9IHt9O1xuICAgICAgICAvLyBTZW5kaW5nIGEgcG9zdE1lc3NhZ2Ugc3RhcnRzIHRoZSB3b3JrZXIuXG4gICAgICAgIHRoaXMuJHdvcmtlci5wb3N0TWVzc2FnZSh7IGluaXQ6IHRydWUsIHRsbnM6IHRsbnMsIG1vZHVsZTogbW9kdWxlTmFtZSwgY2xhc3NuYW1lOiBjbGFzc05hbWUgfSk7XG4gICAgfVxuXG4gICAgb25NZXNzYWdlKGV2ZW50OiBNZXNzYWdlRXZlbnQpIHtcbiAgICAgICAgdmFyIG9yaWdpbjogc3RyaW5nID0gZXZlbnQub3JpZ2luO1xuICAgICAgICB2YXIgc291cmNlOiBXaW5kb3cgPSBldmVudC5zb3VyY2U7XG4gICAgICAgIHZhciBtc2cgPSBldmVudC5kYXRhO1xuICAgICAgICBzd2l0Y2ggKG1zZy50eXBlKSB7XG4gICAgICAgICAgICBjYXNlIFwibG9nXCI6XG4gICAgICAgICAgICAgICAgd2luZG93LmNvbnNvbGUgJiYgY29uc29sZS5sb2cgJiYgY29uc29sZS5sb2cuYXBwbHkoY29uc29sZSwgbXNnLmRhdGEpO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlIFwiZXZlbnRcIjpcbiAgICAgICAgICAgICAgICB0aGlzLl9zaWduYWwobXNnLm5hbWUsIHsgZGF0YTogbXNnLmRhdGEgfSk7XG4gICAgICAgICAgICAgICAgYnJlYWs7XG5cbiAgICAgICAgICAgIGNhc2UgXCJjYWxsXCI6XG4gICAgICAgICAgICAgICAgdmFyIGNhbGxiYWNrID0gdGhpcy5jYWxsYmFja3NbbXNnLmlkXTtcbiAgICAgICAgICAgICAgICBpZiAoY2FsbGJhY2spIHtcbiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2sobXNnLmRhdGEpO1xuICAgICAgICAgICAgICAgICAgICBkZWxldGUgdGhpcy5jYWxsYmFja3NbbXNnLmlkXTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlICRub3JtYWxpemVQYXRoKHBhdGg6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgICAgIHJldHVybiBxdWFsaWZ5VVJMKHBhdGgpO1xuICAgIH1cblxuICAgIHRlcm1pbmF0ZSgpIHtcbiAgICAgICAgdGhpcy5fc2lnbmFsKFwidGVybWluYXRlXCIsIHt9KTtcbiAgICAgICAgdGhpcy5kZWx0YVF1ZXVlID0gbnVsbDtcbiAgICAgICAgdGhpcy4kd29ya2VyLnRlcm1pbmF0ZSgpO1xuICAgICAgICB0aGlzLiR3b3JrZXIgPSBudWxsO1xuICAgICAgICB0aGlzLmRldGFjaEZyb21Eb2N1bWVudCgpO1xuICAgIH1cblxuICAgIHNlbmQoY21kLCBhcmdzKSB7XG4gICAgICAgIHRoaXMuJHdvcmtlci5wb3N0TWVzc2FnZSh7IGNvbW1hbmQ6IGNtZCwgYXJnczogYXJncyB9KTtcbiAgICB9XG5cbiAgICBjYWxsKGNtZCwgYXJncywgY2FsbGJhY2s/OiAoZGF0YTogYW55KSA9PiBhbnkpIHtcbiAgICAgICAgaWYgKGNhbGxiYWNrKSB7XG4gICAgICAgICAgICB2YXIgaWQgPSB0aGlzLmNhbGxiYWNrSWQrKztcbiAgICAgICAgICAgIHRoaXMuY2FsbGJhY2tzW2lkXSA9IGNhbGxiYWNrO1xuICAgICAgICAgICAgYXJncy5wdXNoKGlkKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLnNlbmQoY21kLCBhcmdzKTtcbiAgICB9XG5cbiAgICBlbWl0KGV2ZW50OiBzdHJpbmcsIGRhdGEpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIC8vIGZpcmVmb3ggcmVmdXNlcyB0byBjbG9uZSBvYmplY3RzIHdoaWNoIGhhdmUgZnVuY3Rpb24gcHJvcGVydGllc1xuICAgICAgICAgICAgLy8gVE9ETzogY2xlYW51cCBldmVudFxuICAgICAgICAgICAgdGhpcy4kd29ya2VyLnBvc3RNZXNzYWdlKHsgZXZlbnQ6IGV2ZW50LCBkYXRhOiB7IGRhdGE6IGRhdGEuZGF0YSB9IH0pO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICBjb25zb2xlLmVycm9yKGUuc3RhY2spO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgYXR0YWNoVG9Eb2N1bWVudChkb2M6IEVkaXRvckRvY3VtZW50KSB7XG4gICAgICAgIGlmICh0aGlzLiRkb2MpIHtcbiAgICAgICAgICAgIHRoaXMudGVybWluYXRlKCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy4kZG9jID0gZG9jO1xuICAgICAgICB0aGlzLmNhbGwoXCJzZXRWYWx1ZVwiLCBbZG9jLmdldFZhbHVlKCldKTtcbiAgICAgICAgZG9jLm9uKCdjaGFuZ2UnLCB0aGlzLmNoYW5nZUxpc3RlbmVyKTtcbiAgICB9XG5cbiAgICBkZXRhY2hGcm9tRG9jdW1lbnQoKSB7XG4gICAgICAgIHRoaXMuJGRvYy5vZmYoJ2NoYW5nZScsIHRoaXMuY2hhbmdlTGlzdGVuZXIpO1xuICAgICAgICB0aGlzLiRkb2MgPSBudWxsO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFRoaXMgZnVuY3Rpb24gaXMgdXNlZCBhcyB0aGUgYmFzaXMgZm9yIGEgZnVuY3Rpb24gd2hlcmUgdGhpcyBpcyBib3VuZCBzYWZlbHkuXG4gICAgICogSXQgaGFuZGxlcyBjaGFuZ2VzIHRvIHRoZSBkb2N1bWVudCBieSBwbGFjaW5nIHRoZSBtZXNzYWdlcyBpbiBhIHF1ZXVlXG4gICAgICovXG4gICAgcHJpdmF0ZSBjaGFuZ2VMaXN0ZW5lcihlOiB7IGRhdGEgfSwgZG9jOiBFZGl0b3JEb2N1bWVudCkge1xuICAgICAgICBpZiAoIXRoaXMuZGVsdGFRdWV1ZSkge1xuICAgICAgICAgICAgdGhpcy5kZWx0YVF1ZXVlID0gW2UuZGF0YV07XG4gICAgICAgICAgICBzZXRUaW1lb3V0KHRoaXMuJHNlbmREZWx0YVF1ZXVlLCAwKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuZGVsdGFRdWV1ZS5wdXNoKGUuZGF0YSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlICRzZW5kRGVsdGFRdWV1ZSgpIHtcbiAgICAgICAgdmFyIGRvYyA9IHRoaXMuJGRvYztcbiAgICAgICAgdmFyIHEgPSB0aGlzLmRlbHRhUXVldWU7XG4gICAgICAgIGlmICghcSkgcmV0dXJuO1xuICAgICAgICB0aGlzLmRlbHRhUXVldWUgPSBudWxsO1xuICAgICAgICBpZiAocS5sZW5ndGggPiAyMCAmJiBxLmxlbmd0aCA+IGRvYy5nZXRMZW5ndGgoKSA+PiAxKSB7XG4gICAgICAgICAgICB0aGlzLmNhbGwoXCJzZXRWYWx1ZVwiLCBbZG9jLmdldFZhbHVlKCldKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlXG4gICAgICAgICAgICB0aGlzLmVtaXQoXCJjaGFuZ2VcIiwgeyBkYXRhOiBxIH0pO1xuICAgIH1cblxuICAgICR3b3JrZXJCbG9iKHdvcmtlclVybDogc3RyaW5nKTogQmxvYiB7XG4gICAgICAgIC8vIHdvcmtlclVybCBjYW4gYmUgcHJvdG9jb2wgcmVsYXRpdmVcbiAgICAgICAgLy8gaW1wb3J0U2NyaXB0cyBvbmx5IHRha2VzIGZ1bGx5IHF1YWxpZmllZCB1cmxzXG4gICAgICAgIHZhciBzY3JpcHQgPSBcImltcG9ydFNjcmlwdHMoJ1wiICsgcXVhbGlmeVVSTCh3b3JrZXJVcmwpICsgXCInKTtcIjtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgQmxvYihbc2NyaXB0XSwgeyBcInR5cGVcIjogXCJhcHBsaWNhdGlvbi9qYXZhc2NyaXB0XCIgfSk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGUpIHsgLy8gQmFja3dhcmRzLWNvbXBhdGliaWxpdHlcbiAgICAgICAgICAgIHZhciBCbG9iQnVpbGRlciA9IHdpbmRvd1snQmxvYkJ1aWxkZXInXSB8fCB3aW5kb3dbJ1dlYktpdEJsb2JCdWlsZGVyJ10gfHwgd2luZG93WydNb3pCbG9iQnVpbGRlciddO1xuICAgICAgICAgICAgdmFyIGJsb2JCdWlsZGVyID0gbmV3IEJsb2JCdWlsZGVyKCk7XG4gICAgICAgICAgICBibG9iQnVpbGRlci5hcHBlbmQoc2NyaXB0KTtcbiAgICAgICAgICAgIHJldHVybiBibG9iQnVpbGRlci5nZXRCbG9iKFwiYXBwbGljYXRpb24vamF2YXNjcmlwdFwiKTtcbiAgICAgICAgfVxuICAgIH1cbn1cbi8qICoqKioqIEJFR0lOIExJQ0VOU0UgQkxPQ0sgKioqKipcbiAqIERpc3RyaWJ1dGVkIHVuZGVyIHRoZSBCU0QgbGljZW5zZTpcbiAqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTAsIEFqYXgub3JnIEIuVi5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0XG4gKiBtb2RpZmljYXRpb24sIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMgYXJlIG1ldDpcbiAqICAgICAqIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0XG4gKiAgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuXG4gKiAgICAgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodFxuICogICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZVxuICogICAgICAgZG9jdW1lbnRhdGlvbiBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi5cbiAqICAgICAqIE5laXRoZXIgdGhlIG5hbWUgb2YgQWpheC5vcmcgQi5WLiBub3IgdGhlXG4gKiAgICAgICBuYW1lcyBvZiBpdHMgY29udHJpYnV0b3JzIG1heSBiZSB1c2VkIHRvIGVuZG9yc2Ugb3IgcHJvbW90ZSBwcm9kdWN0c1xuICogICAgICAgZGVyaXZlZCBmcm9tIHRoaXMgc29mdHdhcmUgd2l0aG91dCBzcGVjaWZpYyBwcmlvciB3cml0dGVuIHBlcm1pc3Npb24uXG4gKlxuICogVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQ09QWVJJR0hUIEhPTERFUlMgQU5EIENPTlRSSUJVVE9SUyBcIkFTIElTXCIgQU5EXG4gKiBBTlkgRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUgSU1QTElFRFxuICogV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkgQU5EIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFSRVxuICogRElTQ0xBSU1FRC4gSU4gTk8gRVZFTlQgU0hBTEwgQUpBWC5PUkcgQi5WLiBCRSBMSUFCTEUgRk9SIEFOWVxuICogRElSRUNULCBJTkRJUkVDVCwgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVNcbiAqIChJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUztcbiAqIExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORFxuICogT04gQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVCBMSUFCSUxJVFksIE9SIFRPUlRcbiAqIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFIFVTRSBPRiBUSElTXG4gKiBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS5cbiAqXG4gKiAqKioqKiBFTkQgTElDRU5TRSBCTE9DSyAqKioqKiAqL1xuIl19