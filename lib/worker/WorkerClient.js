import { qualifyURL } from '../lib/net';
import { EventEmitterClass } from '../lib/event_emitter';
export default class WorkerClient extends EventEmitterClass {
    constructor(topLevelNamespaces, mod, classname, workerUrl) {
        super();
        this.callbacks = {};
        this.callbackId = 1;
        console.log("WorkerClient constructor()");
        console.log("topLevelNamespaces => " + JSON.stringify(topLevelNamespaces));
        console.log("mod => " + mod);
        console.log("classname => " + classname);
        console.log("workerUrl => " + workerUrl);
        this.$sendDeltaQueue = this.$sendDeltaQueue.bind(this);
        this.changeListener = this.changeListener.bind(this);
        this.onMessage = this.onMessage.bind(this);
        var tlns = {};
        try {
            this.$worker = new Worker(workerUrl);
        }
        catch (e) {
            if (e instanceof window['DOMException']) {
                var blob = this.$workerBlob(workerUrl);
                var URL = window['URL'] || window['webkitURL'];
                var blobURL = URL.createObjectURL(blob);
                this.$worker = new Worker(blobURL);
                URL.revokeObjectURL(blobURL);
            }
            else {
                throw e;
            }
        }
        this.$worker.postMessage({ init: true, tlns: tlns, module: mod, classname: classname });
        this.$worker.onmessage = this.onMessage;
    }
    onMessage(e) {
        var msg = e.data;
        switch (msg.type) {
            case "log":
                window.console && console.log && console.log.apply(console, msg.data);
                break;
            case "event":
                this._signal(msg.name, { data: msg.data });
                break;
            case "call":
                var callback = this.callbacks[msg.id];
                if (callback) {
                    callback(msg.data);
                    delete this.callbacks[msg.id];
                }
                break;
        }
    }
    $normalizePath(path) {
        return qualifyURL(path);
    }
    terminate() {
        this._signal("terminate", {});
        this.deltaQueue = null;
        this.$worker.terminate();
        this.$worker = null;
        this.detachFromDocument();
    }
    send(cmd, args) {
        this.$worker.postMessage({ command: cmd, args: args });
    }
    call(cmd, args, callback) {
        if (callback) {
            var id = this.callbackId++;
            this.callbacks[id] = callback;
            args.push(id);
        }
        this.send(cmd, args);
    }
    emit(event, data) {
        try {
            this.$worker.postMessage({ event: event, data: { data: data.data } });
        }
        catch (e) {
            console.error(e.stack);
        }
    }
    attachToDocument(doc) {
        if (this.$doc) {
            this.terminate();
        }
        this.$doc = doc;
        this.call("setValue", [doc.getValue()]);
        doc.addEventListener('change', this.changeListener);
    }
    detachFromDocument() {
        this.$doc.removeEventListener('change', this.changeListener);
        this.$doc = null;
    }
    changeListener(e) {
        if (!this.deltaQueue) {
            this.deltaQueue = [e.data];
            setTimeout(this.$sendDeltaQueue, 0);
        }
        else {
            this.deltaQueue.push(e.data);
        }
    }
    $sendDeltaQueue() {
        var doc = this.$doc;
        var q = this.deltaQueue;
        if (!q)
            return;
        this.deltaQueue = null;
        if (q.length > 20 && q.length > doc.getLength() >> 1) {
            this.call("setValue", [doc.getValue()]);
        }
        else
            this.emit("change", { data: q });
    }
    $workerBlob(workerUrl) {
        var script = "importScripts('" + qualifyURL(workerUrl) + "');";
        try {
            return new Blob([script], { "type": "application/javascript" });
        }
        catch (e) {
            var BlobBuilder = window['BlobBuilder'] || window['WebKitBlobBuilder'] || window['MozBlobBuilder'];
            var blobBuilder = new BlobBuilder();
            blobBuilder.append(script);
            return blobBuilder.getBlob("application/javascript");
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV29ya2VyQ2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3dvcmtlci9Xb3JrZXJDbGllbnQudHMiXSwibmFtZXMiOlsiV29ya2VyQ2xpZW50IiwiV29ya2VyQ2xpZW50LmNvbnN0cnVjdG9yIiwiV29ya2VyQ2xpZW50Lm9uTWVzc2FnZSIsIldvcmtlckNsaWVudC4kbm9ybWFsaXplUGF0aCIsIldvcmtlckNsaWVudC50ZXJtaW5hdGUiLCJXb3JrZXJDbGllbnQuc2VuZCIsIldvcmtlckNsaWVudC5jYWxsIiwiV29ya2VyQ2xpZW50LmVtaXQiLCJXb3JrZXJDbGllbnQuYXR0YWNoVG9Eb2N1bWVudCIsIldvcmtlckNsaWVudC5kZXRhY2hGcm9tRG9jdW1lbnQiLCJXb3JrZXJDbGllbnQuY2hhbmdlTGlzdGVuZXIiLCJXb3JrZXJDbGllbnQuJHNlbmREZWx0YVF1ZXVlIiwiV29ya2VyQ2xpZW50LiR3b3JrZXJCbG9iIl0sIm1hcHBpbmdzIjoiT0FBTyxFQUFDLFVBQVUsRUFBQyxNQUFNLFlBQVk7T0FFOUIsRUFBQyxpQkFBaUIsRUFBQyxNQUFNLHNCQUFzQjtBQU10RCwwQ0FBMEMsaUJBQWlCO0lBTXZEQSxZQUFZQSxrQkFBNEJBLEVBQUVBLEdBQVdBLEVBQUVBLFNBQWlCQSxFQUFFQSxTQUFrQkE7UUFDeEZDLE9BQU9BLENBQUNBO1FBSkpBLGNBQVNBLEdBQXlDQSxFQUFFQSxDQUFDQTtRQUNyREEsZUFBVUEsR0FBV0EsQ0FBQ0EsQ0FBQ0E7UUFJM0JBLE9BQU9BLENBQUNBLEdBQUdBLENBQUNBLDRCQUE0QkEsQ0FBQ0EsQ0FBQUE7UUFDekNBLE9BQU9BLENBQUNBLEdBQUdBLENBQUNBLHdCQUF3QkEsR0FBR0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0Esa0JBQWtCQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUMzRUEsT0FBT0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsU0FBU0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDN0JBLE9B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QUFJQSxDQUFDQSxVQUFVQSxFQUFFQSxDQUFDQSxHQUFHQSxDQUFDQSxRQUFRQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUM1Q0EsQ0FBQ0E7UUFDREEsSUFBSUE7WUFDQUEsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsUUFBUUEsRUFBRUEsRUFBRUEsSUFBSUEsRUFBRUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0E7SUFDekNBLENBQUNBO0lBRURYLFdBQVdBLENBQUNBLFNBQWlCQTtRQUd6QlksSUFBSUEsTUFBTUEsR0FBR0EsaUJBQWlCQSxHQUFHQSxVQUFVQSxDQUFDQSxTQUFTQSxDQUFDQSxHQUFHQSxLQUFLQSxDQUFDQTtRQUMvREEsSUFBSUEsQ0FBQ0E7WUFDREEsTUFBTUEsQ0FBQ0EsSUFBSUEsSUFBSUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsRUFBRUEsRUFBRUEsTUFBTUEsRUFBRUEsd0JBQXdCQSxFQUFFQSxDQUFDQSxDQUFDQTtRQUNwRUEsQ0FDQUE7UUFBQUEsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDUEEsSUFBSUEsV0FBV0EsR0FBR0EsTUFBTUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsSUFBSUEsTUFBTUEsQ0FBQ0EsbUJBQW1CQSxDQUFDQSxJQUFJQSxNQUFNQSxDQUFDQSxnQkFBZ0JBLENBQUNBLENBQUNBO1lBQ25HQSxJQUFJQSxXQUFXQSxHQUFHQSxJQUFJQSxXQUFXQSxFQUFFQSxDQUFDQTtZQUNwQ0EsV0FBV0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7WUFDM0JBLE1BQU1BLENBQUNBLFdBQVdBLENBQUNBLE9BQU9BLENBQUNBLHdCQUF3QkEsQ0FBQ0EsQ0FBQ0E7UUFDekRBLENBQUNBO0lBQ0xBLENBQUNBO0FBQ0xaLENBQUNBO0FBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge3F1YWxpZnlVUkx9IGZyb20gJy4uL2xpYi9uZXQnO1xuaW1wb3J0IEVkaXRvckRvY3VtZW50IGZyb20gXCIuLi9FZGl0b3JEb2N1bWVudFwiO1xuaW1wb3J0IHtFdmVudEVtaXR0ZXJDbGFzc30gZnJvbSAnLi4vbGliL2V2ZW50X2VtaXR0ZXInO1xuaW1wb3J0IHtnZXQsIG1vZHVsZVVybH0gZnJvbSBcIi4uL2NvbmZpZ1wiO1xuXG4vKipcbiAqIFdvcmtlckNsaWVudCBtYW5hZ2VzIHRoZSBjb21tdW5pY2F0aW9uIHdpdGggYSBXZWIgV29ya2VyLlxuICovXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBXb3JrZXJDbGllbnQgZXh0ZW5kcyBFdmVudEVtaXR0ZXJDbGFzcyB7XG4gICAgcHJpdmF0ZSAkd29ya2VyOiBXb3JrZXI7XG4gICAgcHJpdmF0ZSBkZWx0YVF1ZXVlOiBhbnlbXTtcbiAgICBwcml2YXRlIGNhbGxiYWNrczogeyBbaWQ6IG51bWJlcl06IChkYXRhOiBhbnkpID0+IGFueSB9ID0ge307XG4gICAgcHJpdmF0ZSBjYWxsYmFja0lkOiBudW1iZXIgPSAxO1xuICAgIHByaXZhdGUgJGRvYzogRWRpdG9yRG9jdW1lbnQ7XG4gICAgY29uc3RydWN0b3IodG9wTGV2ZWxOYW1lc3BhY2VzOiBzdHJpbmdbXSwgbW9kOiBzdHJpbmcsIGNsYXNzbmFtZTogc3RyaW5nLCB3b3JrZXJVcmw/OiBzdHJpbmcpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgY29uc29sZS5sb2coXCJXb3JrZXJDbGllbnQgY29uc3RydWN0b3IoKVwiKVxuICAgICAgICBjb25zb2xlLmxvZyhcInRvcExldmVsTmFtZXNwYWNlcyA9PiBcIiArIEpTT04uc3RyaW5naWZ5KHRvcExldmVsTmFtZXNwYWNlcykpO1xuICAgICAgICBjb25zb2xlLmxvZyhcIm1vZCA9PiBcIiArIG1vZCk7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiY2xhc3NuYW1lID0+IFwiICsgY2xhc3NuYW1lKTtcbiAgICAgICAgY29uc29sZS5sb2coXCJ3b3JrZXJVcmwgPT4gXCIgKyB3b3JrZXJVcmwpO1xuICAgICAgICB0aGlzLiRzZW5kRGVsdGFRdWV1ZSA9IHRoaXMuJHNlbmREZWx0YVF1ZXVlLmJpbmQodGhpcyk7XG4gICAgICAgIHRoaXMuY2hhbmdlTGlzdGVuZXIgPSB0aGlzLmNoYW5nZUxpc3RlbmVyLmJpbmQodGhpcyk7XG4gICAgICAgIHRoaXMub25NZXNzYWdlID0gdGhpcy5vbk1lc3NhZ2UuYmluZCh0aGlzKTtcblxuICAgICAgICAvLyBGSVhNRTogV2UgbmVlZCB0byBwb3B1bGF0ZSB0aGlzXG4gICAgICAgIC8qKlxuICAgICAgICAgKlxuICAgICAgICAgKi9cbiAgICAgICAgdmFyIHRsbnM6IHsgW25zOiBzdHJpbmddOiBzdHJpbmcgfSA9IHt9O1xuXG4gICAgICAgIC8vIG5hbWVUb1VybCBpcyByZW5hbWVkIHRvIHRvVXJsIGluIHJlcXVpcmVqcyAyXG4gICAgICAgIC8vIEZJWE1FOiBHZXQgdGhpcyB3b3JraW5nIGFnYWluIHdpdGhvdXQgQU1ELlxuICAgICAgICAvKlxuICAgICAgICBpZiAocmVxdWlyZVsnbmFtZVRvVXJsJ10gJiYgIXJlcXVpcmUudG9VcmwpIHtcbiAgICAgICAgICAgIHJlcXVpcmUudG9VcmwgPSByZXF1aXJlWyduYW1lVG9VcmwnXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChnZXQoXCJwYWNrYWdlZFwiKSB8fCAhcmVxdWlyZS50b1VybCkge1xuICAgICAgICAgICAgd29ya2VyVXJsID0gd29ya2VyVXJsIHx8IG1vZHVsZVVybChtb2QsIFwid29ya2VyXCIpO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgdmFyIG5vcm1hbGl6ZVBhdGggPSB0aGlzLiRub3JtYWxpemVQYXRoO1xuICAgICAgICAgICAgLy8gVGhpcyBwYXRoIGlzIGludGVudGlvbmFsbHkgbm90IHJlbGF0aXZlLlxuICAgICAgICAgICAgd29ya2VyVXJsID0gd29ya2VyVXJsIHx8IG5vcm1hbGl6ZVBhdGgocmVxdWlyZS50b1VybChcImFjZS93b3JrZXIvd29ya2VyLmpzXCIpKTtcblxuICAgICAgICAgICAgdmFyIHRsbnMgPSB7fTtcbiAgICAgICAgICAgIHRvcExldmVsTmFtZXNwYWNlcy5mb3JFYWNoKGZ1bmN0aW9uKG5zKSB7XG4gICAgICAgICAgICAgICAgdGxuc1tuc10gPSBub3JtYWxpemVQYXRoKHJlcXVpcmUudG9VcmwobnMpLnJlcGxhY2UoLyhcXC5qcyk/KFxcPy4qKT8kLywgXCJcIikpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgKi9cblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdGhpcy4kd29ya2VyID0gbmV3IFdvcmtlcih3b3JrZXJVcmwpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlKSB7XG4gICAgICAgICAgICBpZiAoZSBpbnN0YW5jZW9mIHdpbmRvd1snRE9NRXhjZXB0aW9uJ10pIHtcbiAgICAgICAgICAgICAgICAvLyBMaWtlbHkgc2FtZSBvcmlnaW4gcHJvYmxlbS4gVXNlIGltcG9ydFNjcmlwdHMgZnJvbSBhIHNoaW0gV29ya2VyXG4gICAgICAgICAgICAgICAgdmFyIGJsb2I6IEJsb2IgPSB0aGlzLiR3b3JrZXJCbG9iKHdvcmtlclVybCk7XG4gICAgICAgICAgICAgICAgdmFyIFVSTDogVVJMID0gd2luZG93WydVUkwnXSB8fCB3aW5kb3dbJ3dlYmtpdFVSTCddO1xuICAgICAgICAgICAgICAgIHZhciBibG9iVVJMOiBzdHJpbmcgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGJsb2IpO1xuXG4gICAgICAgICAgICAgICAgdGhpcy4kd29ya2VyID0gbmV3IFdvcmtlcihibG9iVVJMKTtcbiAgICAgICAgICAgICAgICBVUkwucmV2b2tlT2JqZWN0VVJMKGJsb2JVUkwpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyBTZW5kaW5nIGEgcG9zdE1lc3NhZ2Ugc3RhcnRzIHRoZSB3b3JrZXIuXG4gICAgICAgIHRoaXMuJHdvcmtlci5wb3N0TWVzc2FnZSh7IGluaXQ6IHRydWUsIHRsbnM6IHRsbnMsIG1vZHVsZTogbW9kLCBjbGFzc25hbWU6IGNsYXNzbmFtZSB9KTtcblxuICAgICAgICB0aGlzLiR3b3JrZXIub25tZXNzYWdlID0gdGhpcy5vbk1lc3NhZ2U7XG4gICAgfVxuICAgIG9uTWVzc2FnZShlOiBNZXNzYWdlRXZlbnQpIHtcbiAgICAgICAgdmFyIG1zZyA9IGUuZGF0YTtcbiAgICAgICAgc3dpdGNoIChtc2cudHlwZSkge1xuICAgICAgICAgICAgY2FzZSBcImxvZ1wiOlxuICAgICAgICAgICAgICAgIHdpbmRvdy5jb25zb2xlICYmIGNvbnNvbGUubG9nICYmIGNvbnNvbGUubG9nLmFwcGx5KGNvbnNvbGUsIG1zZy5kYXRhKTtcbiAgICAgICAgICAgICAgICBicmVhaztcblxuICAgICAgICAgICAgY2FzZSBcImV2ZW50XCI6XG4gICAgICAgICAgICAgICAgdGhpcy5fc2lnbmFsKG1zZy5uYW1lLCB7IGRhdGE6IG1zZy5kYXRhIH0pO1xuICAgICAgICAgICAgICAgIGJyZWFrO1xuXG4gICAgICAgICAgICBjYXNlIFwiY2FsbFwiOlxuICAgICAgICAgICAgICAgIHZhciBjYWxsYmFjayA9IHRoaXMuY2FsbGJhY2tzW21zZy5pZF07XG4gICAgICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrKG1zZy5kYXRhKTtcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIHRoaXMuY2FsbGJhY2tzW21zZy5pZF07XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSAkbm9ybWFsaXplUGF0aChwYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgICAgICByZXR1cm4gcXVhbGlmeVVSTChwYXRoKTtcbiAgICB9XG5cbiAgICB0ZXJtaW5hdGUoKSB7XG4gICAgICAgIHRoaXMuX3NpZ25hbChcInRlcm1pbmF0ZVwiLCB7fSk7XG4gICAgICAgIHRoaXMuZGVsdGFRdWV1ZSA9IG51bGw7XG4gICAgICAgIHRoaXMuJHdvcmtlci50ZXJtaW5hdGUoKTtcbiAgICAgICAgdGhpcy4kd29ya2VyID0gbnVsbDtcbiAgICAgICAgdGhpcy5kZXRhY2hGcm9tRG9jdW1lbnQoKTtcbiAgICB9XG5cbiAgICBzZW5kKGNtZCwgYXJncykge1xuICAgICAgICB0aGlzLiR3b3JrZXIucG9zdE1lc3NhZ2UoeyBjb21tYW5kOiBjbWQsIGFyZ3M6IGFyZ3MgfSk7XG4gICAgfVxuXG4gICAgY2FsbChjbWQsIGFyZ3MsIGNhbGxiYWNrPzogKGRhdGE6IGFueSkgPT4gYW55KSB7XG4gICAgICAgIGlmIChjYWxsYmFjaykge1xuICAgICAgICAgICAgdmFyIGlkID0gdGhpcy5jYWxsYmFja0lkKys7XG4gICAgICAgICAgICB0aGlzLmNhbGxiYWNrc1tpZF0gPSBjYWxsYmFjaztcbiAgICAgICAgICAgIGFyZ3MucHVzaChpZCk7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5zZW5kKGNtZCwgYXJncyk7XG4gICAgfVxuXG4gICAgZW1pdChldmVudDogc3RyaW5nLCBkYXRhKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICAvLyBmaXJlZm94IHJlZnVzZXMgdG8gY2xvbmUgb2JqZWN0cyB3aGljaCBoYXZlIGZ1bmN0aW9uIHByb3BlcnRpZXNcbiAgICAgICAgICAgIC8vIFRPRE86IGNsZWFudXAgZXZlbnRcbiAgICAgICAgICAgIHRoaXMuJHdvcmtlci5wb3N0TWVzc2FnZSh7IGV2ZW50OiBldmVudCwgZGF0YTogeyBkYXRhOiBkYXRhLmRhdGEgfSB9KTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlLnN0YWNrKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIGF0dGFjaFRvRG9jdW1lbnQoZG9jOiBFZGl0b3JEb2N1bWVudCkge1xuICAgICAgICBpZiAodGhpcy4kZG9jKSB7XG4gICAgICAgICAgICB0aGlzLnRlcm1pbmF0ZSgpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuJGRvYyA9IGRvYztcbiAgICAgICAgdGhpcy5jYWxsKFwic2V0VmFsdWVcIiwgW2RvYy5nZXRWYWx1ZSgpXSk7XG4gICAgICAgIGRvYy5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCB0aGlzLmNoYW5nZUxpc3RlbmVyKTtcbiAgICB9XG5cbiAgICBkZXRhY2hGcm9tRG9jdW1lbnQoKSB7XG4gICAgICAgIHRoaXMuJGRvYy5yZW1vdmVFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCB0aGlzLmNoYW5nZUxpc3RlbmVyKTtcbiAgICAgICAgdGhpcy4kZG9jID0gbnVsbDtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGZ1bmN0aW9uIGlzIHVzZWQgYXMgdGhlIGJhc2lzIGZvciBhIGZ1bmN0aW9uIHdoZXJlIHRoaXMgaXMgYm91bmQgc2FmZWx5LlxuICAgICAqIEl0IGhhbmRsZXMgY2hhbmdlcyB0byB0aGUgZG9jdW1lbnQgYnkgcGxhY2luZyB0aGUgbWVzc2FnZXMgaW4gYSBxdWV1ZVxuICAgICAqL1xuICAgIHByaXZhdGUgY2hhbmdlTGlzdGVuZXIoZTogeyBkYXRhIH0pIHtcbiAgICAgICAgaWYgKCF0aGlzLmRlbHRhUXVldWUpIHtcbiAgICAgICAgICAgIHRoaXMuZGVsdGFRdWV1ZSA9IFtlLmRhdGFdO1xuICAgICAgICAgICAgc2V0VGltZW91dCh0aGlzLiRzZW5kRGVsdGFRdWV1ZSwgMCk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB0aGlzLmRlbHRhUXVldWUucHVzaChlLmRhdGEpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgcHJpdmF0ZSAkc2VuZERlbHRhUXVldWUoKSB7XG4gICAgICAgIHZhciBkb2MgPSB0aGlzLiRkb2M7XG4gICAgICAgIHZhciBxID0gdGhpcy5kZWx0YVF1ZXVlO1xuICAgICAgICBpZiAoIXEpIHJldHVybjtcbiAgICAgICAgdGhpcy5kZWx0YVF1ZXVlID0gbnVsbDtcbiAgICAgICAgaWYgKHEubGVuZ3RoID4gMjAgJiYgcS5sZW5ndGggPiBkb2MuZ2V0TGVuZ3RoKCkgPj4gMSkge1xuICAgICAgICAgICAgdGhpcy5jYWxsKFwic2V0VmFsdWVcIiwgW2RvYy5nZXRWYWx1ZSgpXSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgdGhpcy5lbWl0KFwiY2hhbmdlXCIsIHsgZGF0YTogcSB9KTtcbiAgICB9XG5cbiAgICAkd29ya2VyQmxvYih3b3JrZXJVcmw6IHN0cmluZyk6IEJsb2Ige1xuICAgICAgICAvLyB3b3JrZXJVcmwgY2FuIGJlIHByb3RvY29sIHJlbGF0aXZlXG4gICAgICAgIC8vIGltcG9ydFNjcmlwdHMgb25seSB0YWtlcyBmdWxseSBxdWFsaWZpZWQgdXJsc1xuICAgICAgICB2YXIgc2NyaXB0ID0gXCJpbXBvcnRTY3JpcHRzKCdcIiArIHF1YWxpZnlVUkwod29ya2VyVXJsKSArIFwiJyk7XCI7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICByZXR1cm4gbmV3IEJsb2IoW3NjcmlwdF0sIHsgXCJ0eXBlXCI6IFwiYXBwbGljYXRpb24vamF2YXNjcmlwdFwiIH0pO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlKSB7IC8vIEJhY2t3YXJkcy1jb21wYXRpYmlsaXR5XG4gICAgICAgICAgICB2YXIgQmxvYkJ1aWxkZXIgPSB3aW5kb3dbJ0Jsb2JCdWlsZGVyJ10gfHwgd2luZG93WydXZWJLaXRCbG9iQnVpbGRlciddIHx8IHdpbmRvd1snTW96QmxvYkJ1aWxkZXInXTtcbiAgICAgICAgICAgIHZhciBibG9iQnVpbGRlciA9IG5ldyBCbG9iQnVpbGRlcigpO1xuICAgICAgICAgICAgYmxvYkJ1aWxkZXIuYXBwZW5kKHNjcmlwdCk7XG4gICAgICAgICAgICByZXR1cm4gYmxvYkJ1aWxkZXIuZ2V0QmxvYihcImFwcGxpY2F0aW9uL2phdmFzY3JpcHRcIik7XG4gICAgICAgIH1cbiAgICB9XG59XG4vKiAqKioqKiBCRUdJTiBMSUNFTlNFIEJMT0NLICoqKioqXG4gKiBEaXN0cmlidXRlZCB1bmRlciB0aGUgQlNEIGxpY2Vuc2U6XG4gKlxuICogQ29weXJpZ2h0IChjKSAyMDEwLCBBamF4Lm9yZyBCLlYuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dFxuICogbW9kaWZpY2F0aW9uLCBhcmUgcGVybWl0dGVkIHByb3ZpZGVkIHRoYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zIGFyZSBtZXQ6XG4gKiAgICAgKiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodFxuICogICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLlxuICogICAgICogUmVkaXN0cmlidXRpb25zIGluIGJpbmFyeSBmb3JtIG11c3QgcmVwcm9kdWNlIHRoZSBhYm92ZSBjb3B5cmlnaHRcbiAqICAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGVcbiAqICAgICAgIGRvY3VtZW50YXRpb24gYW5kL29yIG90aGVyIG1hdGVyaWFscyBwcm92aWRlZCB3aXRoIHRoZSBkaXN0cmlidXRpb24uXG4gKiAgICAgKiBOZWl0aGVyIHRoZSBuYW1lIG9mIEFqYXgub3JnIEIuVi4gbm9yIHRoZVxuICogICAgICAgbmFtZXMgb2YgaXRzIGNvbnRyaWJ1dG9ycyBtYXkgYmUgdXNlZCB0byBlbmRvcnNlIG9yIHByb21vdGUgcHJvZHVjdHNcbiAqICAgICAgIGRlcml2ZWQgZnJvbSB0aGlzIHNvZnR3YXJlIHdpdGhvdXQgc3BlY2lmaWMgcHJpb3Igd3JpdHRlbiBwZXJtaXNzaW9uLlxuICpcbiAqIFRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgVEhFIENPUFlSSUdIVCBIT0xERVJTIEFORCBDT05UUklCVVRPUlMgXCJBUyBJU1wiIEFORFxuICogQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhFIElNUExJRURcbiAqIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkVcbiAqIERJU0NMQUlNRUQuIElOIE5PIEVWRU5UIFNIQUxMIEFKQVguT1JHIEIuVi4gQkUgTElBQkxFIEZPUiBBTllcbiAqIERJUkVDVCwgSU5ESVJFQ1QsIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTXG4gKiAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVM7XG4gKiBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVTSU5FU1MgSU5URVJSVVBUSU9OKSBIT1dFVkVSIENBVVNFRCBBTkRcbiAqIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QgTElBQklMSVRZLCBPUiBUT1JUXG4gKiAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRSBVU0UgT0YgVEhJU1xuICogU09GVFdBUkUsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuXG4gKlxuICogKioqKiogRU5EIExJQ0VOU0UgQkxPQ0sgKioqKiogKi9cbiJdfQ==