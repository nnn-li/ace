import autoComplete from './mode/typescript/autoComplete';
import CompletionService from './mode/typescript/CompletionService';
import EditorPosition from './mode/typescript/EditorPosition';
import { getPosition } from './mode/typescript/DocumentPositionUtil';
import { parallel } from "./lib/async";
import Range from './Range';
import { deferredCall } from "./lib/lang";
import typeInfoTip from "./typeInfoTip";
import { workspace } from './workspace/workspace';
import { COMMAND_NAME_AUTO_COMPLETE } from './editor_protocol';
export function wrap(editor, rootElement, workspace, doc = window.document) {
    function show() {
        rootElement.style.display = "block";
        editor.focus();
    }
    function hide() {
        rootElement.style.display = 'none';
    }
    var _fileName;
    var _completionService = new CompletionService(editor, workspace);
    var _editorPositionService = new EditorPosition(editor);
    var _syncStop = false;
    var _refMarkers = [];
    var _errorMarkers = [];
    var _typeInfo = typeInfoTip(doc, editor, workspace, () => _fileName, rootElement);
    var _autoComplete = autoComplete(editor, () => _fileName, _completionService);
    _typeInfo.startUp();
    function changeFile(content, fileName, cursorPos) {
        if (_fileName) {
            if (workspace) {
                workspace.removeScript(_fileName);
            }
            _fileName = null;
        }
        _fileName = fileName;
        _syncStop = true;
        var data = content.replace(/\r\n?/g, '\n');
        editor.setValue(data, cursorPos);
        if (workspace) {
            workspace.ensureScript(fileName, editor.getSession().getDocument().getValue());
        }
        _syncStop = false;
    }
    editor.commands.addCommands([{
            name: COMMAND_NAME_AUTO_COMPLETE,
            bindKey: "Ctrl-Space",
            exec: function (editor) {
                if (!_autoComplete.isActive()) {
                    _autoComplete.activate();
                }
            }
        }]);
    editor.addEventListener("mousedown", function (event) {
        if (_autoComplete.isActive()) {
            _autoComplete.deactivate();
        }
    });
    editor.addEventListener("changeCursor", function (event) {
    });
    function showOccurrences() {
    }
    var deferredShowOccurrences = deferredCall(showOccurrences);
    editor.addEventListener("changeSelection", function (event) {
        if (!_syncStop) {
            try {
                deferredShowOccurrences.schedule(200);
            }
            catch (ex) {
            }
        }
    });
    editor.addEventListener("change", function (event) {
        var data = event.data;
        var action = data.action;
        var range = data.range;
        if (_fileName) {
            if (!_syncStop) {
                try {
                    updateWorkspaceFile();
                    updateMarkerModels();
                }
                catch (e) {
                }
            }
        }
        function updateWorkspaceFile() {
            function editLanguageServiceScript(start, end, text) {
                if (workspace) {
                    workspace.editScript(_fileName, start, end, text);
                }
            }
            var end;
            var start = _editorPositionService.getPositionChars(range.start);
            if (action === "insertText") {
                editLanguageServiceScript(start, start, data.text);
            }
            else if (action === "removeText") {
                end = start + data.text.length;
                editLanguageServiceScript(start, end, "");
            }
            else if (action === "insertLines") {
                var text = data.lines.map(function (line) { return line + '\n'; }).join('');
                editLanguageServiceScript(start, start, text);
            }
            else if (action === "removeLines") {
                var len = _editorPositionService.getLinesChars(data.lines);
                end = start + len;
                editLanguageServiceScript(start, end, "");
            }
            else {
            }
        }
        function updateMarkerModels() {
            var markers = editor.getSession().getMarkers(true);
            var line_count = 0;
            var isNewLine = editor.getSession().getDocument().isNewLine;
            if (action === "insertText") {
                if (isNewLine(data.text)) {
                    line_count = 1;
                }
            }
            else if (action === "insertLines") {
                line_count = data.lines.length;
            }
            else if (action === "removeText") {
                if (isNewLine(data.text)) {
                    line_count = -1;
                }
            }
            else if (action === "removeLines") {
                line_count = -data.lines.length;
            }
            if (line_count !== 0) {
                var markerUpdate = function (id) {
                    var marker = markers[id];
                    var row = range.start.row;
                    if (line_count > 0) {
                        row = +1;
                    }
                    if (marker && marker.range.start.row > row) {
                        marker.range.start.row += line_count;
                        marker.range.end.row += line_count;
                    }
                };
                _errorMarkers.forEach(markerUpdate);
                _refMarkers.forEach(markerUpdate);
                editor.onChangeFrontMarker();
            }
        }
    });
    editor.getSession().on("compiled", function (message) {
        var session = editor.getSession();
        var doc = session.getDocument();
        function convertError(error) {
            var minChar = error.start;
            var limChar = minChar + error.length;
            var pos = getPosition(doc, minChar);
            return { row: pos.row, column: pos.column, text: error.message, type: 'error' };
        }
        function getSyntaxErrors(callback) {
            if (workspace && typeof _fileName === 'string') {
                workspace.getSyntaxErrors(_fileName, callback);
            }
            else {
                callback(null, []);
            }
        }
        function getSemanticErrors(callback) {
            if (workspace && typeof _fileName === 'string') {
                workspace.getSemanticErrors(_fileName, callback);
            }
            else {
                callback(null, []);
            }
        }
        parallel([getSyntaxErrors, getSemanticErrors], function (err, results) {
            if (!err) {
                var errors = results[0].concat(results[1]);
                var annotations = [];
                if (errors && errors.length) {
                    errors.forEach(function (error) {
                        annotations.push(convertError(error));
                    });
                }
                session.setAnnotations(annotations);
                _errorMarkers.forEach(function (id) { session.removeMarker(id); });
                errors.forEach(function (error) {
                    var minChar = error.start;
                    var limChar = minChar + error.length;
                    var start = _editorPositionService.getPositionFromChars(minChar);
                    var end = _editorPositionService.getPositionFromChars(limChar);
                    var range = new Range(start.row, start.column, end.row, end.column);
                    _errorMarkers.push(session.addMarker(range, "typescript-error", "text", true));
                });
            }
            else {
            }
        });
        if (workspace && typeof _fileName === 'string') {
            workspace.getOutputFiles(_fileName, function (err, outputFiles) {
                session._emit("outputFiles", { data: outputFiles });
            });
        }
    });
    var editorWrapper = {
        clearSelection: () => { editor.clearSelection(); },
        get fileName() { return _fileName; },
        set fileName(value) { _fileName = value; },
        get commands() { return editor.commands; },
        get container() { return editor.container; },
        get session() { return editor.session; },
        getCursorPosition: () => { return editor.getCursorPosition(); },
        getSelection: () => { return editor.getSelection(); },
        getValue: () => { return editor.getValue(); },
        gotoLine: (lineNumber, column, animate) => { return editor.gotoLine(lineNumber, column, animate); },
        focus: () => { editor.focus(); },
        indent: () => { editor.indent(); },
        moveCursorTo: (row, column, animate) => { return editor.moveCursorTo(row, column, animate); },
        resize: (force) => { return editor.resize(force); },
        selectAll: () => { editor.selectAll(); },
        setAutoScrollEditorIntoView: (enable) => { return editor.setAutoScrollEditorIntoView(enable); },
        setFontSize: (fontSize) => { return editor.setFontSize(fontSize); },
        setOption: (name, value) => { return editor.setOption(name, value); },
        setOptions: (options) => { return editor.setOptions(options); },
        setShowInvisibles: (showInvisibles) => { return editor.setShowInvisibles(showInvisibles); },
        setTheme: (theme, callback) => { return editor.setTheme(theme, callback); },
        setValue: (val, cursorPos) => { return editor.setValue(val, cursorPos); },
        getSession: () => { return editor.getSession(); },
        addEventListener: (eventName, callback, capturing) => { return editor.addEventListener(eventName, callback, capturing); },
        get onTextInput() { return editor.onTextInput; },
        set onTextInput(value) { editor.onTextInput = value; },
        getDisplayIndentGuides: () => { return editor.getDisplayIndentGuides(); },
        setDisplayIndentGuides: (displayIndentGuides) => { return editor.setDisplayIndentGuides(displayIndentGuides); },
        getShowPrintMargin: () => { return editor.getShowPrintMargin(); },
        setShowPrintMargin: (showPrintMargin) => { return editor.setShowPrintMargin(showPrintMargin); },
        changeFile: changeFile
    };
    return editorWrapper;
}
function edit(source, workspace, doc = window.document) {
    var rootElement = (function () {
        if (typeof source === "string") {
            var element = doc.getElementById(source);
            if (element) {
                return element;
            }
            else {
                throw new Error(source + " must be an element id");
            }
        }
        else {
            return source;
        }
    })();
    var _editor = (function (element) {
        throw new Error("edit is currently unsupported");
    })(rootElement);
    return wrap(_editor, rootElement, workspace, doc);
}
export function workspace() {
    return workspace();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJpdG9uLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3RyaXRvbi50cyJdLCJuYW1lcyI6WyJ3cmFwIiwid3JhcC5zaG93Iiwid3JhcC5oaWRlIiwid3JhcC5jaGFuZ2VGaWxlIiwid3JhcC5zaG93T2NjdXJyZW5jZXMiLCJ1cGRhdGVXb3Jrc3BhY2VGaWxlIiwidXBkYXRlV29ya3NwYWNlRmlsZS5lZGl0TGFuZ3VhZ2VTZXJ2aWNlU2NyaXB0IiwidXBkYXRlTWFya2VyTW9kZWxzIiwiY29udmVydEVycm9yIiwiZ2V0U3ludGF4RXJyb3JzIiwiZ2V0U2VtYW50aWNFcnJvcnMiLCJ3cmFwLmZpbGVOYW1lIiwid3JhcC5jb21tYW5kcyIsIndyYXAuY29udGFpbmVyIiwid3JhcC5zZXNzaW9uIiwid3JhcC5vblRleHRJbnB1dCIsImVkaXQiLCJ3b3Jrc3BhY2UiXSwibWFwcGluZ3MiOiJPQUFPLFlBQVksTUFBTSxnQ0FBZ0M7T0FDbEQsaUJBQWlCLE1BQU0scUNBQXFDO09BQzVELGNBQWMsTUFBTSxrQ0FBa0M7T0FDdEQsRUFBQyxXQUFXLEVBQUMsTUFBTSx3Q0FBd0M7T0FDM0QsRUFBQyxRQUFRLEVBQUMsTUFBTSxhQUFhO09BRzdCLEtBQUssTUFBTSxTQUFTO09BQ3BCLEVBQUMsWUFBWSxFQUFDLE1BQU0sWUFBWTtPQUNoQyxXQUFXLE1BQU0sZUFBZTtPQUNoQyxFQUFDLFNBQVMsRUFBWSxNQUFNLHVCQUF1QjtPQUNuRCxFQUFDLDBCQUEwQixFQUFDLE1BQU0sbUJBQW1CO0FBVTVELHFCQUFxQixNQUFjLEVBQUUsV0FBd0IsRUFBRSxTQUFTLEVBQUUsR0FBRyxHQUFhLE1BQU0sQ0FBQyxRQUFRO0lBRXJHQTtRQUNJQyxXQUFXQSxDQUFDQSxLQUFLQSxDQUFDQSxPQUFPQSxHQUFHQSxPQUFPQSxDQUFDQTtRQUNwQ0EsTUFBTUEsQ0FBQ0EsS0FBS0EsRUFBRUEsQ0FBQ0E7SUFDbkJBLENBQUNBO0lBRUREO1FBQ0lFLFdBQVdBLENBQUNBLEtBQUtBLENBQUNBLE9BQU9BLEdBQUdBLE1BQU1BLENBQUNBO0lBQ3ZDQSxDQUFDQTtJQUVERixJQUFJQSxTQUFpQkEsQ0FBQ0E7SUFDdEJBLElBQUlBLGtCQUFrQkEsR0FBR0EsSUFBSUEsaUJBQWlCQSxDQUFDQSxNQUFNQSxFQUFFQSxTQUFTQSxDQUFDQSxDQUFDQTtJQUNsRUEsSUFBSUEsc0JBQXNCQSxHQUFHQSxJQUFJQSxjQUFjQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQTtJQUN4REEsSUFBSUEsU0FBU0EsR0FBR0EsS0FBS0EsQ0FBQ0E7SUFDdEJBLElBQUlBLFdBQVdBLEdBQWFBLEVBQUVBLENBQUNBO0lBQy9CQSxJQUFJQSxhQUFhQSxHQUFhQSxFQUFFQSxDQUFDQTtJQUVqQ0EsSUFBSUEsU0FBU0EsR0FBR0EsV0FBV0EsQ0FBQ0EsR0FBR0EsRUFBRUEsTUFBTUEsRUFBRUEsU0FBU0EsRUFBRUEsTUFBTUEsU0FBU0EsRUFBRUEsV0FBV0EsQ0FBQ0EsQ0FBQ0E7SUFDbEZBLElBQUlBLGFBQWFBLEdBQUdBLFlBQVlBLENBQUNBLE1BQU1BLEVBQUVBLE1BQU1BLFNBQVNBLEVBQUVBLGtCQUFrQkEsQ0FBQ0EsQ0FBQ0E7SUFFOUVBLFNBQVNBLENBQUNBLE9BQU9BLEVBQUVBLENBQUNBO0lBS3BCQSxvQkFBb0JBLE9BQWVBLEVBQUVBLFFBQWdCQSxFQUFFQSxTQUFTQTtRQUM1REcsRUFBRUEsQ0FBQ0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDWkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ1pBLFNBQVNBLENBQUNBLFlBQVlBLENBQUNBLFNBQVNBLENBQUNBLENBQUNBO1lBQ3RDQSxDQUFDQTtZQUNEQSxTQUFTQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUNyQkEsQ0FBQ0E7UUFDREEsU0FBU0EsR0FBR0EsUUFBUUEsQ0FBQ0E7UUFDckJBLFNBQVNBLEdBQUdBLElBQUlBLENBQUNBO1FBQ2pCQSxJQUFJQSxJQUFJQSxHQUFHQSxPQUFPQSxDQUFDQSxPQUFPQSxDQUFDQSxRQUFRQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUMzQ0EsTUFBTUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsSUFBSUEsRUFBRUEsU0FBU0EsQ0FBQ0EsQ0FBQ0E7UUFDakNBLEVBQUVBLENBQUNBLENBQUNBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBO1lBQ1pBLFNBQVNBLENBQUNBLFlBQVlBLENBQUNBLFFBQVFBLEVBQUVBLE1BQU1BLENBQUNBLFVBQVVBLEVBQUVBLENBQUNBLFdBQVdBLEVBQUVBLENBQUNBLFFBQVFBLEVBQUVBLENBQUNBLENBQUNBO1FBQ25GQSxDQUFDQTtRQUNEQSxTQUFTQSxHQUFHQSxLQUFLQSxDQUFDQTtJQUN0QkEsQ0FBQ0E7SUFFREgsTUFBTUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsQ0FBQ0E7WUFDekJBLElBQUlBLEVBQUVBLDBCQUEwQkE7WUFDaENBLE9BQU9BLEVBQUVBLFlBQVlBO1lBQ3JCQSxJQUFJQSxFQUFFQSxVQUFTQSxNQUFNQTtnQkFDakIsRUFBRSxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsUUFBUSxFQUFFLENBQUMsQ0FBQyxDQUFDO29CQUM1QixhQUFhLENBQUMsUUFBUSxFQUFFLENBQUM7Z0JBQzdCLENBQUM7WUFDTCxDQUFDO1NBQ0pBLENBQUNBLENBQUNBLENBQUNBO0lBRUpBLE1BQU1BLENBQUNBLGdCQUFnQkEsQ0FBQ0EsV0FBV0EsRUFBRUEsVUFBU0EsS0FBS0E7UUFDL0MsRUFBRSxDQUFDLENBQUMsYUFBYSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUMzQixhQUFhLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDL0IsQ0FBQztJQUNMLENBQUMsQ0FBQ0EsQ0FBQ0E7SUFLSEEsTUFBTUEsQ0FBQ0EsZ0JBQWdCQSxDQUFDQSxjQUFjQSxFQUFFQSxVQUFTQSxLQUFLQTtJQUN0RCxDQUFDLENBQUNBLENBQUNBO0lBRUhBO0lBc0JBSSxDQUFDQTtJQUVESixJQUFJQSx1QkFBdUJBLEdBQUdBLFlBQVlBLENBQUNBLGVBQWVBLENBQUNBLENBQUNBO0lBSzVEQSxNQUFNQSxDQUFDQSxnQkFBZ0JBLENBQUNBLGlCQUFpQkEsRUFBRUEsVUFBU0EsS0FBS0E7UUFFckQsRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ2IsSUFBSSxDQUFDO2dCQUNELHVCQUF1QixDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUMxQyxDQUNBO1lBQUEsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUVaLENBQUM7UUFDTCxDQUFDO0lBQ0wsQ0FBQyxDQUFDQSxDQUFDQTtJQU9IQSxNQUFNQSxDQUFDQSxnQkFBZ0JBLENBQUNBLFFBQVFBLEVBQUVBLFVBQVNBLEtBQXFIQTtRQUM1SixJQUFJLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDO1FBQ3RCLElBQUksTUFBTSxHQUFXLElBQUksQ0FBQyxNQUFNLENBQUM7UUFDakMsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUN2QixFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ1osRUFBRSxDQUFDLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO2dCQUNiLElBQUksQ0FBQztvQkFDRCxtQkFBbUIsRUFBRSxDQUFDO29CQUN0QixrQkFBa0IsRUFBRSxDQUFDO2dCQUN6QixDQUNBO2dCQUFBLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ1gsQ0FBQztZQUNMLENBQUM7UUFDTCxDQUFDO1FBSUQ7WUFDSUssbUNBQW1DQSxLQUFhQSxFQUFFQSxHQUFXQSxFQUFFQSxJQUFZQTtnQkFDdkVDLEVBQUVBLENBQUNBLENBQUNBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBO29CQUNaQSxTQUFTQSxDQUFDQSxVQUFVQSxDQUFDQSxTQUFTQSxFQUFFQSxLQUFLQSxFQUFFQSxHQUFHQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtnQkFDdERBLENBQUNBO1lBQ0xBLENBQUNBO1lBQ0RELElBQUlBLEdBQVdBLENBQUNBO1lBQ2hCQSxJQUFJQSxLQUFLQSxHQUFXQSxzQkFBc0JBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0E7WUFDekVBLEVBQUVBLENBQUNBLENBQUNBLE1BQU1BLEtBQUtBLFlBQVlBLENBQUNBLENBQUNBLENBQUNBO2dCQUMxQkEseUJBQXlCQSxDQUFDQSxLQUFLQSxFQUFFQSxLQUFLQSxFQUFFQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtZQUN2REEsQ0FBQ0E7WUFDREEsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsS0FBS0EsWUFBWUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQy9CQSxHQUFHQSxHQUFHQSxLQUFLQSxHQUFHQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQTtnQkFDL0JBLHlCQUF5QkEsQ0FBQ0EsS0FBS0EsRUFBRUEsR0FBR0EsRUFBRUEsRUFBRUEsQ0FBQ0EsQ0FBQ0E7WUFDOUNBLENBQUNBO1lBQ0RBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLE1BQU1BLEtBQUtBLGFBQWFBLENBQUNBLENBQUNBLENBQUNBO2dCQUNoQ0EsSUFBSUEsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsVUFBU0EsSUFBSUEsSUFBSSxNQUFNLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0E7Z0JBQzNFQSx5QkFBeUJBLENBQUNBLEtBQUtBLEVBQUVBLEtBQUtBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO1lBQ2xEQSxDQUFDQTtZQUNEQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxNQUFNQSxLQUFLQSxhQUFhQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDaENBLElBQUlBLEdBQUdBLEdBQUdBLHNCQUFzQkEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0E7Z0JBQzNEQSxHQUFHQSxHQUFHQSxLQUFLQSxHQUFHQSxHQUFHQSxDQUFDQTtnQkFDbEJBLHlCQUF5QkEsQ0FBQ0EsS0FBS0EsRUFBRUEsR0FBR0EsRUFBRUEsRUFBRUEsQ0FBQ0EsQ0FBQ0E7WUFDOUNBLENBQUNBO1lBQ0RBLElBQUlBLENBQUNBLENBQUNBO1lBQ05BLENBQUNBO1FBQ0xBLENBQUNBO1FBS0Q7WUFDSUUsSUFBSUEsT0FBT0EsR0FBR0EsTUFBTUEsQ0FBQ0EsVUFBVUEsRUFBRUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDbkRBLElBQUlBLFVBQVVBLEdBQUdBLENBQUNBLENBQUNBO1lBQ25CQSxJQUFJQSxTQUFTQSxHQUFHQSxNQUFNQSxDQUFDQSxVQUFVQSxFQUFFQSxDQUFDQSxXQUFXQSxFQUFFQSxDQUFDQSxTQUFTQSxDQUFDQTtZQUM1REEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsS0FBS0EsWUFBWUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQzFCQSxFQUFFQSxDQUFDQSxDQUFDQSxTQUFTQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtvQkFDdkJBLFVBQVVBLEdBQUdBLENBQUNBLENBQUNBO2dCQUNuQkEsQ0FBQ0E7WUFDTEEsQ0FBQ0E7WUFDREEsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsS0FBS0EsYUFBYUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ2hDQSxVQUFVQSxHQUFHQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxNQUFNQSxDQUFDQTtZQUNuQ0EsQ0FBQ0E7WUFDREEsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsS0FBS0EsWUFBWUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQy9CQSxFQUFFQSxDQUFDQSxDQUFDQSxTQUFTQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtvQkFDdkJBLFVBQVVBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBO2dCQUNwQkEsQ0FBQ0E7WUFDTEEsQ0FBQ0E7WUFDREEsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsS0FBS0EsYUFBYUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ2hDQSxVQUFVQSxHQUFHQSxDQUFDQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxNQUFNQSxDQUFDQTtZQUNwQ0EsQ0FBQ0E7WUFDREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsVUFBVUEsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ25CQSxJQUFJQSxZQUFZQSxHQUFHQSxVQUFTQSxFQUFVQTtvQkFDbEMsSUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLEVBQUUsQ0FBQyxDQUFDO29CQUN6QixJQUFJLEdBQUcsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQztvQkFDMUIsRUFBRSxDQUFDLENBQUMsVUFBVSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7d0JBQ2pCLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQztvQkFDYixDQUFDO29CQUNELEVBQUUsQ0FBQyxDQUFDLE1BQU0sSUFBSSxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQzt3QkFDekMsTUFBTSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxJQUFJLFVBQVUsQ0FBQzt3QkFDckMsTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxJQUFJLFVBQVUsQ0FBQztvQkFDdkMsQ0FBQztnQkFDTCxDQUFDLENBQUNBO2dCQUNGQSxhQUFhQSxDQUFDQSxPQUFPQSxDQUFDQSxZQUFZQSxDQUFDQSxDQUFDQTtnQkFDcENBLFdBQVdBLENBQUNBLE9BQU9BLENBQUNBLFlBQVlBLENBQUNBLENBQUNBO2dCQUdsQ0EsTUFBTUEsQ0FBQ0EsbUJBQW1CQSxFQUFFQSxDQUFDQTtZQUNqQ0EsQ0FBQ0E7UUFDTEEsQ0FBQ0E7SUFDTCxDQUFDLENBQUNQLENBQUNBO0lBZ0ZIQSxNQUFNQSxDQUFDQSxVQUFVQSxFQUFFQSxDQUFDQSxFQUFFQSxDQUFDQSxVQUFVQSxFQUFFQSxVQUFTQSxPQUFPQTtRQUMvQyxJQUFJLE9BQU8sR0FBZ0IsTUFBTSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBRS9DLElBQUksR0FBRyxHQUFRLE9BQU8sQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNyQyxzQkFBc0IsS0FBeUQ7WUFDM0VRLElBQUlBLE9BQU9BLEdBQUdBLEtBQUtBLENBQUNBLEtBQUtBLENBQUNBO1lBQzFCQSxJQUFJQSxPQUFPQSxHQUFHQSxPQUFPQSxHQUFHQSxLQUFLQSxDQUFDQSxNQUFNQSxDQUFDQTtZQUNyQ0EsSUFBSUEsR0FBR0EsR0FBR0EsV0FBV0EsQ0FBQ0EsR0FBR0EsRUFBRUEsT0FBT0EsQ0FBQ0EsQ0FBQ0E7WUFDcENBLE1BQU1BLENBQUNBLEVBQUVBLEdBQUdBLEVBQUVBLEdBQUdBLENBQUNBLEdBQUdBLEVBQUVBLE1BQU1BLEVBQUVBLEdBQUdBLENBQUNBLE1BQU1BLEVBQUVBLElBQUlBLEVBQUVBLEtBQUtBLENBQUNBLE9BQU9BLEVBQUVBLElBQUlBLEVBQUVBLE9BQU9BLEVBQUVBLENBQUNBO1FBQ3BGQSxDQUFDQTtRQUVELHlCQUF5QixRQUFRO1lBQzdCQyxFQUFFQSxDQUFDQSxDQUFDQSxTQUFTQSxJQUFJQSxPQUFPQSxTQUFTQSxLQUFLQSxRQUFRQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDN0NBLFNBQVNBLENBQUNBLGVBQWVBLENBQUNBLFNBQVNBLEVBQUVBLFFBQVFBLENBQUNBLENBQUNBO1lBQ25EQSxDQUFDQTtZQUNEQSxJQUFJQSxDQUFDQSxDQUFDQTtnQkFDRkEsUUFBUUEsQ0FBQ0EsSUFBSUEsRUFBRUEsRUFBRUEsQ0FBQ0EsQ0FBQ0E7WUFDdkJBLENBQUNBO1FBQ0xBLENBQUNBO1FBRUQsMkJBQTJCLFFBQVE7WUFDL0JDLEVBQUVBLENBQUNBLENBQUNBLFNBQVNBLElBQUlBLE9BQU9BLFNBQVNBLEtBQUtBLFFBQVFBLENBQUNBLENBQUNBLENBQUNBO2dCQUM3Q0EsU0FBU0EsQ0FBQ0EsaUJBQWlCQSxDQUFDQSxTQUFTQSxFQUFFQSxRQUFRQSxDQUFDQSxDQUFDQTtZQUNyREEsQ0FBQ0E7WUFDREEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7Z0JBQ0ZBLFFBQVFBLENBQUNBLElBQUlBLEVBQUVBLEVBQUVBLENBQUNBLENBQUNBO1lBQ3ZCQSxDQUFDQTtRQUNMQSxDQUFDQTtRQUVELFFBQVEsQ0FBQyxDQUFDLGVBQWUsRUFBRSxpQkFBaUIsQ0FBQyxFQUFFLFVBQVMsR0FBRyxFQUFFLE9BQWdCO1lBQ3pFLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFDUCxJQUFJLE1BQU0sR0FBRyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUMzQyxJQUFJLFdBQVcsR0FBRyxFQUFFLENBQUM7Z0JBQ3JCLEVBQUUsQ0FBQyxDQUFDLE1BQU0sSUFBSSxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztvQkFDMUIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxVQUFTLEtBQUs7d0JBQ3pCLFdBQVcsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7b0JBQzFDLENBQUMsQ0FBQyxDQUFDO2dCQUNQLENBQUM7Z0JBR0QsT0FBTyxDQUFDLGNBQWMsQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFDcEMsYUFBYSxDQUFDLE9BQU8sQ0FBQyxVQUFTLEVBQUUsSUFBSSxPQUFPLENBQUMsWUFBWSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBRWxFLE1BQU0sQ0FBQyxPQUFPLENBQUMsVUFBUyxLQUF5RDtvQkFDN0UsSUFBSSxPQUFPLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQztvQkFDMUIsSUFBSSxPQUFPLEdBQUcsT0FBTyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUM7b0JBQ3JDLElBQUksS0FBSyxHQUFHLHNCQUFzQixDQUFDLG9CQUFvQixDQUFDLE9BQU8sQ0FBQyxDQUFDO29CQUNqRSxJQUFJLEdBQUcsR0FBRyxzQkFBc0IsQ0FBQyxvQkFBb0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztvQkFDL0QsSUFBSSxLQUFLLEdBQUcsSUFBSSxLQUFLLENBQUMsS0FBSyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDO29CQUlwRSxhQUFhLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sRUFBRSxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUNuRixDQUFDLENBQUMsQ0FBQztZQUNQLENBQUM7WUFDRCxJQUFJLENBQUMsQ0FBQztZQUNOLENBQUM7UUFDTCxDQUFDLENBQUMsQ0FBQztRQUNILEVBQUUsQ0FBQyxDQUFDLFNBQVMsSUFBSSxPQUFPLFNBQVMsS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQzdDLFNBQVMsQ0FBQyxjQUFjLENBQUMsU0FBUyxFQUFFLFVBQVMsR0FBRyxFQUFFLFdBQVc7Z0JBQ3pELE9BQU8sQ0FBQyxLQUFLLENBQUMsYUFBYSxFQUFFLEVBQUUsSUFBSSxFQUFFLFdBQVcsRUFBRSxDQUFDLENBQUM7WUFDeEQsQ0FBQyxDQUFDLENBQUM7UUFDUCxDQUFDO0lBQ0wsQ0FBQyxDQUFDVixDQUFDQTtJQUVIQSxJQUFJQSxhQUFhQSxHQUFHQTtRQUNoQkEsY0FBY0EsRUFBRUEsUUFBUUEsTUFBTUEsQ0FBQ0EsY0FBY0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDbERBLElBQUlBLFFBQVFBLEtBQWFXLE1BQU1BLENBQUNBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBO1FBQzVDWCxJQUFJQSxRQUFRQSxDQUFDQSxLQUFLQSxJQUFJVyxTQUFTQSxHQUFHQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUMxQ1gsSUFBSUEsUUFBUUEsS0FBS1ksTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDMUNaLElBQUlBLFNBQVNBLEtBQUthLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBO1FBQzVDYixJQUFJQSxPQUFPQSxLQUFLYyxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUN4Q2QsaUJBQWlCQSxFQUFFQSxRQUFRQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQSxpQkFBaUJBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1FBQy9EQSxZQUFZQSxFQUFFQSxRQUFRQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQSxZQUFZQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNyREEsUUFBUUEsRUFBRUEsUUFBUUEsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsUUFBUUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDN0NBLFFBQVFBLEVBQUVBLENBQUNBLFVBQWtCQSxFQUFFQSxNQUFjQSxFQUFFQSxPQUFpQkEsT0FBT0EsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsVUFBVUEsRUFBRUEsTUFBTUEsRUFBRUEsT0FBT0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDN0hBLEtBQUtBLEVBQUVBLFFBQVFBLE1BQU1BLENBQUNBLEtBQUtBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1FBQ2hDQSxNQUFNQSxFQUFFQSxRQUFRQSxNQUFNQSxDQUFDQSxNQUFNQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNsQ0EsWUFBWUEsRUFBRUEsQ0FBQ0EsR0FBV0EsRUFBRUEsTUFBY0EsRUFBRUEsT0FBaUJBLE9BQU9BLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLFlBQVlBLENBQUNBLEdBQUdBLEVBQUVBLE1BQU1BLEVBQUVBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1FBQ3ZIQSxNQUFNQSxFQUFFQSxDQUFDQSxLQUFjQSxPQUFPQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUM1REEsU0FBU0EsRUFBRUEsUUFBUUEsTUFBTUEsQ0FBQ0EsU0FBU0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDeENBLDJCQUEyQkEsRUFBRUEsQ0FBQ0EsTUFBZUEsT0FBT0EsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsMkJBQTJCQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUN4R0EsV0FBV0EsRUFBRUEsQ0FBQ0EsUUFBZ0JBLE9BQU9BLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLFdBQVdBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1FBQzNFQSxTQUFTQSxFQUFFQSxDQUFDQSxJQUFZQSxFQUFFQSxLQUFVQSxPQUFPQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQSxTQUFTQSxDQUFDQSxJQUFJQSxFQUFFQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNsRkEsVUFBVUEsRUFBRUEsQ0FBQ0EsT0FBWUEsT0FBT0EsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDcEVBLGlCQUFpQkEsRUFBRUEsQ0FBQ0EsY0FBdUJBLE9BQU9BLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLGlCQUFpQkEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDcEdBLFFBQVFBLEVBQUVBLENBQUNBLEtBQWFBLEVBQUVBLFFBQXFCQSxPQUFPQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQSxRQUFRQSxDQUFDQSxLQUFLQSxFQUFFQSxRQUFRQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNoR0EsUUFBUUEsRUFBRUEsQ0FBQ0EsR0FBV0EsRUFBRUEsU0FBa0JBLE9BQU9BLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLFFBQVFBLENBQUNBLEdBQUdBLEVBQUVBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1FBQzFGQSxVQUFVQSxFQUFFQSxRQUFRQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQSxVQUFVQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNqREEsZ0JBQWdCQSxFQUFFQSxDQUFDQSxTQUFpQkEsRUFBRUEsUUFBb0JBLEVBQUVBLFNBQW1CQSxPQUFPQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQSxnQkFBZ0JBLENBQUNBLFNBQVNBLEVBQUVBLFFBQVFBLEVBQUVBLFNBQVNBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1FBQ3ZKQSxJQUFJQSxXQUFXQSxLQUFVZSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQSxXQUFXQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNyRGYsSUFBSUEsV0FBV0EsQ0FBQ0EsS0FBS0EsSUFBSWUsTUFBTUEsQ0FBQ0EsV0FBV0EsR0FBR0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFFdERmLHNCQUFzQkEsRUFBRUEsUUFBUUEsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0Esc0JBQXNCQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUN6RUEsc0JBQXNCQSxFQUFFQSxDQUFDQSxtQkFBNEJBLE9BQU9BLE1BQU1BLENBQUNBLE1BQU1BLENBQUNBLHNCQUFzQkEsQ0FBQ0EsbUJBQW1CQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUV4SEEsa0JBQWtCQSxFQUFFQSxRQUFRQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQSxrQkFBa0JBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1FBQ2pFQSxrQkFBa0JBLEVBQUVBLENBQUNBLGVBQXdCQSxPQUFPQSxNQUFNQSxDQUFDQSxNQUFNQSxDQUFDQSxrQkFBa0JBLENBQUNBLGVBQWVBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1FBRXhHQSxVQUFVQSxFQUFFQSxVQUFVQTtLQUN6QkEsQ0FBQ0E7SUFFRkEsTUFBTUEsQ0FBQ0EsYUFBYUEsQ0FBQ0E7QUFDekJBLENBQUNBO0FBR0QsY0FBYyxNQUFXLEVBQUUsU0FBb0IsRUFBRSxHQUFHLEdBQWEsTUFBTSxDQUFDLFFBQVE7SUFFNUVnQixJQUFJQSxXQUFXQSxHQUFHQSxDQUFDQTtRQUNmLEVBQUUsQ0FBQyxDQUFDLE9BQU8sTUFBTSxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFFN0IsSUFBSSxPQUFPLEdBQUcsR0FBRyxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUN6QyxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO2dCQUNWLE1BQU0sQ0FBQyxPQUFPLENBQUM7WUFDbkIsQ0FBQztZQUNELElBQUksQ0FBQyxDQUFDO2dCQUNGLE1BQU0sSUFBSSxLQUFLLENBQUMsTUFBTSxHQUFHLHdCQUF3QixDQUFDLENBQUM7WUFDdkQsQ0FBQztRQUNMLENBQUM7UUFDRCxJQUFJLENBQUMsQ0FBQztZQUNGLE1BQU0sQ0FBQyxNQUFNLENBQUM7UUFDbEIsQ0FBQztJQUNMLENBQUMsQ0FBQ0EsRUFBRUEsQ0FBQ0E7SUFFTEEsSUFBSUEsT0FBT0EsR0FBR0EsQ0FBQ0EsVUFBU0EsT0FBb0JBO1FBQ3hDLE1BQU0sSUFBSSxLQUFLLENBQUMsK0JBQStCLENBQUMsQ0FBQztJQUVyRCxDQUFDLENBQUNBLENBQUNBLFdBQVdBLENBQUNBLENBQUNBO0lBRWhCQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxFQUFFQSxXQUFXQSxFQUFFQSxTQUFTQSxFQUFFQSxHQUFHQSxDQUFDQSxDQUFDQTtBQUN0REEsQ0FBQ0E7QUFFRDtJQUNJQyxNQUFNQSxDQUFDQSxTQUFTQSxFQUFFQSxDQUFDQTtBQUN2QkEsQ0FBQ0EiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYXV0b0NvbXBsZXRlIGZyb20gJy4vbW9kZS90eXBlc2NyaXB0L2F1dG9Db21wbGV0ZSc7XG5pbXBvcnQgQ29tcGxldGlvblNlcnZpY2UgZnJvbSAnLi9tb2RlL3R5cGVzY3JpcHQvQ29tcGxldGlvblNlcnZpY2UnO1xuaW1wb3J0IEVkaXRvclBvc2l0aW9uIGZyb20gJy4vbW9kZS90eXBlc2NyaXB0L0VkaXRvclBvc2l0aW9uJztcbmltcG9ydCB7Z2V0UG9zaXRpb259IGZyb20gJy4vbW9kZS90eXBlc2NyaXB0L0RvY3VtZW50UG9zaXRpb25VdGlsJztcbmltcG9ydCB7cGFyYWxsZWx9IGZyb20gXCIuL2xpYi9hc3luY1wiO1xuaW1wb3J0IEVkaXRvciBmcm9tICcuL0VkaXRvcic7XG5pbXBvcnQgRWRpdFNlc3Npb24gZnJvbSAnLi9FZGl0U2Vzc2lvbic7XG5pbXBvcnQgUmFuZ2UgZnJvbSAnLi9SYW5nZSc7XG5pbXBvcnQge2RlZmVycmVkQ2FsbH0gZnJvbSBcIi4vbGliL2xhbmdcIjtcbmltcG9ydCB0eXBlSW5mb1RpcCBmcm9tIFwiLi90eXBlSW5mb1RpcFwiO1xuaW1wb3J0IHt3b3Jrc3BhY2UsIFdvcmtzcGFjZX0gZnJvbSAnLi93b3Jrc3BhY2Uvd29ya3NwYWNlJztcbmltcG9ydCB7Q09NTUFORF9OQU1FX0FVVE9fQ09NUExFVEV9IGZyb20gJy4vZWRpdG9yX3Byb3RvY29sJztcbi8vaW1wb3J0IENvbW1hbmRNYW5hZ2VyID0gcmVxdWlyZSgnLi9jb21tYW5kcy9Db21tYW5kTWFuYWdlcicpO1xuaW1wb3J0IHt9IGZyb20gJy4vc2VsZWN0aW9uJztcblxuLyoqXG4gKiBUaGUgZnVuY3Rpb25hbCBjb25zdHJ1Y3RvciBwYXR0ZXJuIHVzZWQgdG8gY3JlYXRlIGEgZmFjYWRlIHRoYXRcbiAqIGluY2x1ZGVzIGFuIGVkaXRvciwgdGhlIEhUTUwgZWxlbWVudCB0aGF0IHRoZSBlZGl0b3Igd2lsbCBiZSBidWlsdCB1cG9uLFxuICogYW5kIHRoZSBzaGFyZWQgd29ya3NwYWNlLlxuICogVGhpcyBpcyBjYWxsZWQgYnkgZWRpdGluZyBhcHBsaWNhdGlvbnMuXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiB3cmFwKGVkaXRvcjogRWRpdG9yLCByb290RWxlbWVudDogSFRNTEVsZW1lbnQsIHdvcmtzcGFjZSwgZG9jOiBEb2N1bWVudCA9IHdpbmRvdy5kb2N1bWVudCkge1xuXG4gICAgZnVuY3Rpb24gc2hvdygpIHtcbiAgICAgICAgcm9vdEVsZW1lbnQuc3R5bGUuZGlzcGxheSA9IFwiYmxvY2tcIjtcbiAgICAgICAgZWRpdG9yLmZvY3VzKCk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gaGlkZSgpIHtcbiAgICAgICAgcm9vdEVsZW1lbnQuc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICB9XG5cbiAgICB2YXIgX2ZpbGVOYW1lOiBzdHJpbmc7XG4gICAgdmFyIF9jb21wbGV0aW9uU2VydmljZSA9IG5ldyBDb21wbGV0aW9uU2VydmljZShlZGl0b3IsIHdvcmtzcGFjZSk7XG4gICAgdmFyIF9lZGl0b3JQb3NpdGlvblNlcnZpY2UgPSBuZXcgRWRpdG9yUG9zaXRpb24oZWRpdG9yKTtcbiAgICB2YXIgX3N5bmNTdG9wID0gZmFsc2U7IC8vZm9yIHN0b3Agc3luYyBvbiBsb2FkZmlsZVxuICAgIHZhciBfcmVmTWFya2VyczogbnVtYmVyW10gPSBbXTtcbiAgICB2YXIgX2Vycm9yTWFya2VyczogbnVtYmVyW10gPSBbXTtcblxuICAgIHZhciBfdHlwZUluZm8gPSB0eXBlSW5mb1RpcChkb2MsIGVkaXRvciwgd29ya3NwYWNlLCAoKSA9PiBfZmlsZU5hbWUsIHJvb3RFbGVtZW50KTtcbiAgICB2YXIgX2F1dG9Db21wbGV0ZSA9IGF1dG9Db21wbGV0ZShlZGl0b3IsICgpID0+IF9maWxlTmFtZSwgX2NvbXBsZXRpb25TZXJ2aWNlKTtcblxuICAgIF90eXBlSW5mby5zdGFydFVwKCk7XG5cbiAgICAvKipcbiAgICAgKiBDaGFuZ2VzIHRoZSBlZGl0b3IgY29udGVudHMgYW5kIHVwZGF0ZXMgdGhlIHdvcmtzcGFjZS5cbiAgICAgKi9cbiAgICBmdW5jdGlvbiBjaGFuZ2VGaWxlKGNvbnRlbnQ6IHN0cmluZywgZmlsZU5hbWU6IHN0cmluZywgY3Vyc29yUG9zKSB7XG4gICAgICAgIGlmIChfZmlsZU5hbWUpIHtcbiAgICAgICAgICAgIGlmICh3b3Jrc3BhY2UpIHtcbiAgICAgICAgICAgICAgICB3b3Jrc3BhY2UucmVtb3ZlU2NyaXB0KF9maWxlTmFtZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBfZmlsZU5hbWUgPSBudWxsO1xuICAgICAgICB9XG4gICAgICAgIF9maWxlTmFtZSA9IGZpbGVOYW1lO1xuICAgICAgICBfc3luY1N0b3AgPSB0cnVlO1xuICAgICAgICB2YXIgZGF0YSA9IGNvbnRlbnQucmVwbGFjZSgvXFxyXFxuPy9nLCAnXFxuJyk7XG4gICAgICAgIGVkaXRvci5zZXRWYWx1ZShkYXRhLCBjdXJzb3JQb3MpO1xuICAgICAgICBpZiAod29ya3NwYWNlKSB7XG4gICAgICAgICAgICB3b3Jrc3BhY2UuZW5zdXJlU2NyaXB0KGZpbGVOYW1lLCBlZGl0b3IuZ2V0U2Vzc2lvbigpLmdldERvY3VtZW50KCkuZ2V0VmFsdWUoKSk7XG4gICAgICAgIH1cbiAgICAgICAgX3N5bmNTdG9wID0gZmFsc2U7XG4gICAgfVxuXG4gICAgZWRpdG9yLmNvbW1hbmRzLmFkZENvbW1hbmRzKFt7XG4gICAgICAgIG5hbWU6IENPTU1BTkRfTkFNRV9BVVRPX0NPTVBMRVRFLFxuICAgICAgICBiaW5kS2V5OiBcIkN0cmwtU3BhY2VcIixcbiAgICAgICAgZXhlYzogZnVuY3Rpb24oZWRpdG9yKSB7XG4gICAgICAgICAgICBpZiAoIV9hdXRvQ29tcGxldGUuaXNBY3RpdmUoKSkge1xuICAgICAgICAgICAgICAgIF9hdXRvQ29tcGxldGUuYWN0aXZhdGUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgIH1dKTtcblxuICAgIGVkaXRvci5hZGRFdmVudExpc3RlbmVyKFwibW91c2Vkb3duXCIsIGZ1bmN0aW9uKGV2ZW50KSB7XG4gICAgICAgIGlmIChfYXV0b0NvbXBsZXRlLmlzQWN0aXZlKCkpIHtcbiAgICAgICAgICAgIF9hdXRvQ29tcGxldGUuZGVhY3RpdmF0ZSgpO1xuICAgICAgICB9XG4gICAgfSk7XG5cbiAgICAvKipcbiAgICAgKiBUaGlzIGV2ZW50IHNlZW1zIHRvIGJlIHByZXR0eSByYXJlLlxuICAgICAqL1xuICAgIGVkaXRvci5hZGRFdmVudExpc3RlbmVyKFwiY2hhbmdlQ3Vyc29yXCIsIGZ1bmN0aW9uKGV2ZW50KSB7XG4gICAgfSk7XG5cbiAgICBmdW5jdGlvbiBzaG93T2NjdXJyZW5jZXMoKSB7XG4gICAgICAgIC8qXG4gICAgICAgIHZhciBzZXNzaW9uID0gX2VkaXRvci5nZXRTZXNzaW9uKCk7XG4gICAgICAgIF9yZWZNYXJrZXJzLmZvckVhY2goZnVuY3Rpb24oaWQpIHtcbiAgICAgICAgICAgIHNlc3Npb24ucmVtb3ZlTWFya2VyKGlkKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIF9sYW5ndWFnZVNlcnZpY2UgIT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICAgICAgdmFyIHJlZmVyZW5jZXMgPSBfbGFuZ3VhZ2VTZXJ2aWNlLmdldE9jY3VycmVuY2VzQXRQb3NpdGlvbihfY3VycmVudEZpbGVOYW1lLCBfZWRpdG9yUG9zaXRpb25TZXJ2aWNlLmdldEN1cnJlbnRDaGFyUG9zaXRpb24oKSk7XG4gICAgICAgICAgICAgICAgaWYgKHJlZmVyZW5jZXMpIHtcbiAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlcy5mb3JFYWNoKGZ1bmN0aW9uKHJlZmVyZW5jZSkge1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIHN0YXJ0ID0gX2VkaXRvclBvc2l0aW9uU2VydmljZS5nZXRQb3NpdGlvbkZyb21DaGFycyhyZWZlcmVuY2UubWluQ2hhcik7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgZW5kID0gX2VkaXRvclBvc2l0aW9uU2VydmljZS5nZXRQb3NpdGlvbkZyb21DaGFycyhyZWZlcmVuY2UubGltQ2hhcik7XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgcmFuZ2UgPSBuZXcgQWNlUmFuZ2Uoc3RhcnQucm93LCBzdGFydC5jb2x1bW4sIGVuZC5yb3csIGVuZC5jb2x1bW4pO1xuICAgICAgICAgICAgICAgICAgICAgICAgX3JlZk1hcmtlcnMucHVzaChzZXNzaW9uLmFkZE1hcmtlcihyYW5nZSwgXCJ0eXBlc2NyaXB0LXJlZlwiLCBcInRleHRcIiwgdHJ1ZSkpO1xuICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgfVxuICAgICAgICAqL1xuICAgIH1cblxuICAgIHZhciBkZWZlcnJlZFNob3dPY2N1cnJlbmNlcyA9IGRlZmVycmVkQ2FsbChzaG93T2NjdXJyZW5jZXMpO1xuXG4gICAgLyoqXG4gICAgICogQ2hhbmdpbmcgdGhlIHNlbGVjdGlvbiBkb2VzIG5vdCB0cmlnZ2VyIGFueSBlZmZvcnQgb24gYmVoYWxmIG9mIHRoZSB3b3JrZXIuXG4gICAgICovXG4gICAgZWRpdG9yLmFkZEV2ZW50TGlzdGVuZXIoXCJjaGFuZ2VTZWxlY3Rpb25cIiwgZnVuY3Rpb24oZXZlbnQpIHtcbiAgICAgICAgLy8gVGhlcmUncyBub3QgbXVjaCBpbiB0aGUgZXZlbnQsIGp1c3QgYSAndHlwZScgcHJvcGVydHkgdGhhdCBpcyAnY2hhbmdlU2VsZWN0aW9uJy5cbiAgICAgICAgaWYgKCFfc3luY1N0b3ApIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgZGVmZXJyZWRTaG93T2NjdXJyZW5jZXMuc2NoZWR1bGUoMjAwKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNhdGNoIChleCkge1xuICAgICAgICAgICAgICAgIC8vVE9ET1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSk7XG5cbiAgICAvKipcbiAgICAgKiBXaGVuIHRoZSB0ZXh0IGluIHRoZSBlZGl0b3IgY2hhbmdlcywgdGhlIGVkaXQgaXMgYXBwbGllZCB0byB0aGUgd29ya3NwYWNlLlxuICAgICAqIFRoZSB3b3Jrc3BhY2UgY29tbXVuaWNhdGVzIHdpdGggdGhlIFdvcmtzcGFjZVdvcmtlciB0aHJvdWdoIGEgV29ya2VyQ2xpZW50IHByb3h5LlxuICAgICAqIFRoZSBvblVwZGF0ZSBtZXRob2Qgb2YgdGhlIHdvcmtlciBpcyBzb29uIHRyaWdnZXJlZCBmb2xsb3dlZCBieSB0aGUgY29tcGlsZSBtZXRob2QuXG4gICAgICovXG4gICAgZWRpdG9yLmFkZEV2ZW50TGlzdGVuZXIoXCJjaGFuZ2VcIiwgZnVuY3Rpb24oZXZlbnQ6IHsgZGF0YTogeyBhY3Rpb246IHN0cmluZzsgcmFuZ2U6IHsgc3RhcnQ6IHsgcm93OiBudW1iZXI7IGNvbHVtbjogbnVtYmVyIH0gfTsgdGV4dDogc3RyaW5nOyBsaW5lczogc3RyaW5nW10gfSB9KSB7XG4gICAgICAgIHZhciBkYXRhID0gZXZlbnQuZGF0YTtcbiAgICAgICAgdmFyIGFjdGlvbjogc3RyaW5nID0gZGF0YS5hY3Rpb247XG4gICAgICAgIHZhciByYW5nZSA9IGRhdGEucmFuZ2U7XG4gICAgICAgIGlmIChfZmlsZU5hbWUpIHtcbiAgICAgICAgICAgIGlmICghX3N5bmNTdG9wKSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgdXBkYXRlV29ya3NwYWNlRmlsZSgpO1xuICAgICAgICAgICAgICAgICAgICB1cGRhdGVNYXJrZXJNb2RlbHMoKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY2F0Y2ggKGUpIHtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgLyoqXG4gICAgICAgICAqIFVwZGF0ZXMgdGhlIGZpbGUgaW4gdGhlIHdvcmtzcGFjZSB1c2luZyB0aGUgKGNhcHR1cmVkKSBmaWxlTmFtZSBhbmQgY2hhbmdlIGV2ZW50LlxuICAgICAgICAgKi9cbiAgICAgICAgZnVuY3Rpb24gdXBkYXRlV29ya3NwYWNlRmlsZSgpIHtcbiAgICAgICAgICAgIGZ1bmN0aW9uIGVkaXRMYW5ndWFnZVNlcnZpY2VTY3JpcHQoc3RhcnQ6IG51bWJlciwgZW5kOiBudW1iZXIsIHRleHQ6IHN0cmluZykge1xuICAgICAgICAgICAgICAgIGlmICh3b3Jrc3BhY2UpIHtcbiAgICAgICAgICAgICAgICAgICAgd29ya3NwYWNlLmVkaXRTY3JpcHQoX2ZpbGVOYW1lLCBzdGFydCwgZW5kLCB0ZXh0KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB2YXIgZW5kOiBudW1iZXI7XG4gICAgICAgICAgICB2YXIgc3RhcnQ6IG51bWJlciA9IF9lZGl0b3JQb3NpdGlvblNlcnZpY2UuZ2V0UG9zaXRpb25DaGFycyhyYW5nZS5zdGFydCk7XG4gICAgICAgICAgICBpZiAoYWN0aW9uID09PSBcImluc2VydFRleHRcIikge1xuICAgICAgICAgICAgICAgIGVkaXRMYW5ndWFnZVNlcnZpY2VTY3JpcHQoc3RhcnQsIHN0YXJ0LCBkYXRhLnRleHQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoYWN0aW9uID09PSBcInJlbW92ZVRleHRcIikge1xuICAgICAgICAgICAgICAgIGVuZCA9IHN0YXJ0ICsgZGF0YS50ZXh0Lmxlbmd0aDtcbiAgICAgICAgICAgICAgICBlZGl0TGFuZ3VhZ2VTZXJ2aWNlU2NyaXB0KHN0YXJ0LCBlbmQsIFwiXCIpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoYWN0aW9uID09PSBcImluc2VydExpbmVzXCIpIHtcbiAgICAgICAgICAgICAgICB2YXIgdGV4dCA9IGRhdGEubGluZXMubWFwKGZ1bmN0aW9uKGxpbmUpIHsgcmV0dXJuIGxpbmUgKyAnXFxuJzsgfSkuam9pbignJyk7XG4gICAgICAgICAgICAgICAgZWRpdExhbmd1YWdlU2VydmljZVNjcmlwdChzdGFydCwgc3RhcnQsIHRleHQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoYWN0aW9uID09PSBcInJlbW92ZUxpbmVzXCIpIHtcbiAgICAgICAgICAgICAgICB2YXIgbGVuID0gX2VkaXRvclBvc2l0aW9uU2VydmljZS5nZXRMaW5lc0NoYXJzKGRhdGEubGluZXMpO1xuICAgICAgICAgICAgICAgIGVuZCA9IHN0YXJ0ICsgbGVuO1xuICAgICAgICAgICAgICAgIGVkaXRMYW5ndWFnZVNlcnZpY2VTY3JpcHQoc3RhcnQsIGVuZCwgXCJcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIC8qKlxuICAgICAgICAgKiBVcGRhdGVzIHRoZSBtYXJrZXIgbW9kZWxzLlxuICAgICAgICAgKi9cbiAgICAgICAgZnVuY3Rpb24gdXBkYXRlTWFya2VyTW9kZWxzKCkge1xuICAgICAgICAgICAgdmFyIG1hcmtlcnMgPSBlZGl0b3IuZ2V0U2Vzc2lvbigpLmdldE1hcmtlcnModHJ1ZSk7XG4gICAgICAgICAgICB2YXIgbGluZV9jb3VudCA9IDA7XG4gICAgICAgICAgICB2YXIgaXNOZXdMaW5lID0gZWRpdG9yLmdldFNlc3Npb24oKS5nZXREb2N1bWVudCgpLmlzTmV3TGluZTtcbiAgICAgICAgICAgIGlmIChhY3Rpb24gPT09IFwiaW5zZXJ0VGV4dFwiKSB7XG4gICAgICAgICAgICAgICAgaWYgKGlzTmV3TGluZShkYXRhLnRleHQpKSB7XG4gICAgICAgICAgICAgICAgICAgIGxpbmVfY291bnQgPSAxO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2UgaWYgKGFjdGlvbiA9PT0gXCJpbnNlcnRMaW5lc1wiKSB7XG4gICAgICAgICAgICAgICAgbGluZV9jb3VudCA9IGRhdGEubGluZXMubGVuZ3RoO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoYWN0aW9uID09PSBcInJlbW92ZVRleHRcIikge1xuICAgICAgICAgICAgICAgIGlmIChpc05ld0xpbmUoZGF0YS50ZXh0KSkge1xuICAgICAgICAgICAgICAgICAgICBsaW5lX2NvdW50ID0gLTE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoYWN0aW9uID09PSBcInJlbW92ZUxpbmVzXCIpIHtcbiAgICAgICAgICAgICAgICBsaW5lX2NvdW50ID0gLWRhdGEubGluZXMubGVuZ3RoO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKGxpbmVfY291bnQgIT09IDApIHtcbiAgICAgICAgICAgICAgICB2YXIgbWFya2VyVXBkYXRlID0gZnVuY3Rpb24oaWQ6IG51bWJlcikge1xuICAgICAgICAgICAgICAgICAgICB2YXIgbWFya2VyID0gbWFya2Vyc1tpZF07XG4gICAgICAgICAgICAgICAgICAgIHZhciByb3cgPSByYW5nZS5zdGFydC5yb3c7XG4gICAgICAgICAgICAgICAgICAgIGlmIChsaW5lX2NvdW50ID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAgICAgcm93ID0gKzE7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgaWYgKG1hcmtlciAmJiBtYXJrZXIucmFuZ2Uuc3RhcnQucm93ID4gcm93KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBtYXJrZXIucmFuZ2Uuc3RhcnQucm93ICs9IGxpbmVfY291bnQ7XG4gICAgICAgICAgICAgICAgICAgICAgICBtYXJrZXIucmFuZ2UuZW5kLnJvdyArPSBsaW5lX2NvdW50O1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICBfZXJyb3JNYXJrZXJzLmZvckVhY2gobWFya2VyVXBkYXRlKTtcbiAgICAgICAgICAgICAgICBfcmVmTWFya2Vycy5mb3JFYWNoKG1hcmtlclVwZGF0ZSk7XG4gICAgICAgICAgICAgICAgLy8gRklYTUU6IFRoaXMgaXMgdGhlIG9kZCBtYW4gb3V0LlxuICAgICAgICAgICAgICAgIC8vIFdlIHNob3VsZCBub3QgYmUgdHJpZ2dlcmluZyBhIHZpZXcgcmVmcmVzaCBoZXJlP1xuICAgICAgICAgICAgICAgIGVkaXRvci5vbkNoYW5nZUZyb250TWFya2VyKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIC8qXG4gICAgZnVuY3Rpb24gbGFuZ3VhZ2VTZXJ2aWNlSW5kZW50KCkge1xuICAgICAgICB2YXIgY3Vyc29yID0gX2VkaXRvci5nZXRDdXJzb3JQb3NpdGlvbigpO1xuICAgICAgICB2YXIgbGluZU51bWJlciA9IGN1cnNvci5yb3c7XG5cbiAgICAgICAgdmFyIHRleHQgPSBfZWRpdG9yLnNlc3Npb24uZ2V0TGluZShsaW5lTnVtYmVyKTtcbiAgICAgICAgdmFyIG1hdGNoZXMgPSB0ZXh0Lm1hdGNoKC8gXltcXHQgXSogLyk7XG4gICAgICAgIHZhciBwcmVJbmRlbnQgPSAwO1xuICAgICAgICB2YXIgd29yZExlbiA9IDA7XG5cbiAgICAgICAgaWYgKG1hdGNoZXMpIHtcbiAgICAgICAgICAgIHdvcmRMZW4gPSBtYXRjaGVzWzBdLmxlbmd0aDtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgbWF0Y2hlc1swXS5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIHZhciBlbG0gPSBtYXRjaGVzWzBdLmNoYXJBdChpKTtcbiAgICAgICAgICAgICAgICB2YXIgc3BhY2VMZW4gPSAoZWxtID09IFwiIFwiKSA/IDEgOiBfZWRpdG9yLnNlc3Npb24uZ2V0VGFiU2l6ZSgpO1xuICAgICAgICAgICAgICAgIHByZUluZGVudCArPSBzcGFjZUxlbjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIHZhciBvcHRpb24gPSBuZXcgU2VydmljZXMuRWRpdG9yT3B0aW9ucygpO1xuICAgICAgICBvcHRpb24uTmV3TGluZUNoYXJhY3RlciA9IFwiXFxuXCI7XG5cbiAgICAgICAgdmFyIHNtYXJ0SW5kZW50ID0gX2xhbmd1YWdlU2VydmljZS5nZXRTbWFydEluZGVudEF0TGluZU51bWJlcihfY3VycmVudEZpbGVOYW1lLCBsaW5lTnVtYmVyLCBvcHRpb24pO1xuXG4gICAgICAgIGlmIChwcmVJbmRlbnQgPiBzbWFydEluZGVudCkge1xuICAgICAgICAgICAgX2VkaXRvci5pbmRlbnQoKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHZhciBpbmRlbnQgPSBzbWFydEluZGVudCAtIHByZUluZGVudDtcblxuICAgICAgICAgICAgaWYgKGluZGVudCA+IDApIHtcbiAgICAgICAgICAgICAgICBfZWRpdG9yLmdldFNlbGVjdGlvbigpLm1vdmVDdXJzb3JMaW5lU3RhcnQoKTtcbiAgICAgICAgICAgICAgICBfZWRpdG9yLmNvbW1hbmRzLmV4ZWMoXCJpbnNlcnR0ZXh0XCIsIF9lZGl0b3IsIHsgdGV4dDogXCIgXCIsIHRpbWVzOiBpbmRlbnQgfSk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIGlmIChjdXJzb3IuY29sdW1uID4gd29yZExlbikge1xuICAgICAgICAgICAgICAgIGN1cnNvci5jb2x1bW4gKz0gaW5kZW50O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgY3Vyc29yLmNvbHVtbiA9IGluZGVudCArIHdvcmRMZW47XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIF9lZGl0b3IuZ2V0U2VsZWN0aW9uKCkubW92ZUN1cnNvclRvUG9zaXRpb24oY3Vyc29yKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIF9lZGl0b3IuY29tbWFuZHMuYWRkQ29tbWFuZHMoW3tcbiAgICAgICAgbmFtZTogXCJpbmRlbnRcIixcbiAgICAgICAgYmluZEtleTogXCJUYWJcIixcbiAgICAgICAgZXhlYzogZnVuY3Rpb24oZWRpdG9yKSB7XG4gICAgICAgICAgICBsYW5ndWFnZVNlcnZpY2VJbmRlbnQoKTtcbiAgICAgICAgfSxcbiAgICAgICAgbXVsdGlTZWxlY3RBY3Rpb246IFwiZm9yRWFjaFwiXG4gICAgfV0pO1xuICAgICovXG5cbiAgICAvKlxuICAgIGZ1bmN0aW9uIHJlZmFjdG9yKCkge1xuICAgICAgICB2YXIgcmVmZXJlbmNlcyA9IF9sYW5ndWFnZVNlcnZpY2UuZ2V0T2NjdXJyZW5jZXNBdFBvc2l0aW9uKF9jdXJyZW50RmlsZU5hbWUsIF9lZGl0b3JQb3NpdGlvblNlcnZpY2UuZ2V0Q3VycmVudENoYXJQb3NpdGlvbigpKTtcblxuICAgICAgICByZWZlcmVuY2VzLmZvckVhY2goZnVuY3Rpb24ocmVmZXJlbmNlKSB7XG4gICAgICAgICAgICB2YXIgc3RhcnQgPSBfZWRpdG9yUG9zaXRpb25TZXJ2aWNlLmdldFBvc2l0aW9uRnJvbUNoYXJzKHJlZmVyZW5jZS5taW5DaGFyKTtcbiAgICAgICAgICAgIHZhciBlbmQgPSBfZWRpdG9yUG9zaXRpb25TZXJ2aWNlLmdldFBvc2l0aW9uRnJvbUNoYXJzKHJlZmVyZW5jZS5saW1DaGFyKTtcbiAgICAgICAgICAgIHZhciByYW5nZSA9IG5ldyBBY2VSYW5nZShzdGFydC5yb3csIHN0YXJ0LmNvbHVtbiwgZW5kLnJvdywgZW5kLmNvbHVtbik7XG4gICAgICAgICAgICBfZWRpdG9yLnNlc3Npb24ubXVsdGlTZWxlY3QuYWRkUmFuZ2UocmFuZ2UpO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBfZWRpdG9yLmNvbW1hbmRzLmFkZENvbW1hbmRzKFt7XG4gICAgICAgIG5hbWU6IFwicmVmYWN0b3JcIixcbiAgICAgICAgYmluZEtleTogXCJGMlwiLFxuICAgICAgICBleGVjOiBmdW5jdGlvbihlZGl0b3IpIHtcbiAgICAgICAgICAgIHJlZmFjdG9yKCk7XG4gICAgICAgIH1cbiAgICB9XSk7XG4gICAgKi9cblxuICAgIC8vIEhhbmRsZSB0aGUgY29tcGlsZWQgbm90aWZpY2F0aW9uXG4gICAgZWRpdG9yLmdldFNlc3Npb24oKS5vbihcImNvbXBpbGVkXCIsIGZ1bmN0aW9uKG1lc3NhZ2UpIHtcbiAgICAgICAgdmFyIHNlc3Npb246IEVkaXRTZXNzaW9uID0gZWRpdG9yLmdldFNlc3Npb24oKTtcbiAgICAgICAgLy8gRklYTUU6IERvY3VtZW50IGhlcmUgY29uZmxpY3RzIHdpdGggdGhlIGJyb3dzZXIgZG9jdW1lbnQgdHlwZS5cbiAgICAgICAgdmFyIGRvYzogYW55ID0gc2Vzc2lvbi5nZXREb2N1bWVudCgpO1xuICAgICAgICBmdW5jdGlvbiBjb252ZXJ0RXJyb3IoZXJyb3I6IHsgbWVzc2FnZTogc3RyaW5nOyBzdGFydDogbnVtYmVyOyBsZW5ndGg6IG51bWJlciB9KTogeyByb3c6IG51bWJlcjsgY29sdW1uOiBudW1iZXI7IHRleHQ6IHN0cmluZzsgdHlwZTogc3RyaW5nIH0ge1xuICAgICAgICAgICAgdmFyIG1pbkNoYXIgPSBlcnJvci5zdGFydDtcbiAgICAgICAgICAgIHZhciBsaW1DaGFyID0gbWluQ2hhciArIGVycm9yLmxlbmd0aDtcbiAgICAgICAgICAgIHZhciBwb3MgPSBnZXRQb3NpdGlvbihkb2MsIG1pbkNoYXIpO1xuICAgICAgICAgICAgcmV0dXJuIHsgcm93OiBwb3Mucm93LCBjb2x1bW46IHBvcy5jb2x1bW4sIHRleHQ6IGVycm9yLm1lc3NhZ2UsIHR5cGU6ICdlcnJvcicgfTtcbiAgICAgICAgfVxuICAgICAgICAvLyBGSVhNRTogVGhlIHR5cGUgb2YgdGhlIGNhbGxiYWNrIHNob3VsZCBiZSBrbm93bi5cbiAgICAgICAgZnVuY3Rpb24gZ2V0U3ludGF4RXJyb3JzKGNhbGxiYWNrKSB7XG4gICAgICAgICAgICBpZiAod29ya3NwYWNlICYmIHR5cGVvZiBfZmlsZU5hbWUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgd29ya3NwYWNlLmdldFN5bnRheEVycm9ycyhfZmlsZU5hbWUsIGNhbGxiYWNrKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIFtdKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICAvLyBGSVhNRTogVGhlIHR5cGUgb2YgdGhlIGNhbGxiYWNrIHNob3VsZCBiZSBrbm93bi5cbiAgICAgICAgZnVuY3Rpb24gZ2V0U2VtYW50aWNFcnJvcnMoY2FsbGJhY2spIHtcbiAgICAgICAgICAgIGlmICh3b3Jrc3BhY2UgJiYgdHlwZW9mIF9maWxlTmFtZSA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICAgICAgICB3b3Jrc3BhY2UuZ2V0U2VtYW50aWNFcnJvcnMoX2ZpbGVOYW1lLCBjYWxsYmFjayk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCBbXSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgLy8gUmVxdWVzdCBzeW50YXggYW5kIHNlbWFudGljIGVycm9ycyBmcm9tIHRoZSB3b3Jrc3BhY2UsIHNldCBtYXJrZXJzIGFuZCBhbm5vdGF0aW9ucy5cbiAgICAgICAgcGFyYWxsZWwoW2dldFN5bnRheEVycm9ycywgZ2V0U2VtYW50aWNFcnJvcnNdLCBmdW5jdGlvbihlcnIsIHJlc3VsdHM6IGFueVtdW10pIHtcbiAgICAgICAgICAgIGlmICghZXJyKSB7XG4gICAgICAgICAgICAgICAgdmFyIGVycm9ycyA9IHJlc3VsdHNbMF0uY29uY2F0KHJlc3VsdHNbMV0pO1xuICAgICAgICAgICAgICAgIHZhciBhbm5vdGF0aW9ucyA9IFtdO1xuICAgICAgICAgICAgICAgIGlmIChlcnJvcnMgJiYgZXJyb3JzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICBlcnJvcnMuZm9yRWFjaChmdW5jdGlvbihlcnJvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgYW5ub3RhdGlvbnMucHVzaChjb252ZXJ0RXJyb3IoZXJyb3IpKTtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIEZJWE1FOiBFZGl0U2Vzc2lvbiBzaG91bGQgZGVjbGFyZSBhbm5vdGF0aW9uIHR5cGUuXG4gICAgICAgICAgICAgICAgLy8gU2VlIEFubm90YXRpb24gaW50ZXJmYWNlLlxuICAgICAgICAgICAgICAgIHNlc3Npb24uc2V0QW5ub3RhdGlvbnMoYW5ub3RhdGlvbnMpO1xuICAgICAgICAgICAgICAgIF9lcnJvck1hcmtlcnMuZm9yRWFjaChmdW5jdGlvbihpZCkgeyBzZXNzaW9uLnJlbW92ZU1hcmtlcihpZCk7IH0pO1xuICAgICAgICAgICAgICAgIC8vIEFkZCB0aGUgbmV3IGNvbXBpbGUgZXJyb3JzIHRvIHRoZSBlZGl0b3Igc2Vzc2lvbiBhbmQgdGhlIGlkKHMpIHRvIHRoZSBtb2RlbC5cbiAgICAgICAgICAgICAgICBlcnJvcnMuZm9yRWFjaChmdW5jdGlvbihlcnJvcjogeyBtZXNzYWdlOiBzdHJpbmc7IHN0YXJ0OiBudW1iZXI7IGxlbmd0aDogbnVtYmVyIH0pIHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIG1pbkNoYXIgPSBlcnJvci5zdGFydDtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGxpbUNoYXIgPSBtaW5DaGFyICsgZXJyb3IubGVuZ3RoO1xuICAgICAgICAgICAgICAgICAgICB2YXIgc3RhcnQgPSBfZWRpdG9yUG9zaXRpb25TZXJ2aWNlLmdldFBvc2l0aW9uRnJvbUNoYXJzKG1pbkNoYXIpO1xuICAgICAgICAgICAgICAgICAgICB2YXIgZW5kID0gX2VkaXRvclBvc2l0aW9uU2VydmljZS5nZXRQb3NpdGlvbkZyb21DaGFycyhsaW1DaGFyKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJhbmdlID0gbmV3IFJhbmdlKHN0YXJ0LnJvdywgc3RhcnQuY29sdW1uLCBlbmQucm93LCBlbmQuY29sdW1uKTtcbiAgICAgICAgICAgICAgICAgICAgLy8gQWRkIGEgbmV3IG1hcmtlciB0byB0aGUgZ2l2ZW4gUmFuZ2UuIFRoZSBsYXN0IGFyZ3VtZW50IChpbkZyb250KSBjYXVzZXMgYVxuICAgICAgICAgICAgICAgICAgICAvLyBmcm9udCBtYXJrZXIgdG8gYmUgZGVmaW5lZCBhbmQgdGhlICdjaGFuZ2VGcm9udE1hcmtlcicgZXZlbnQgZmlyZXMuXG4gICAgICAgICAgICAgICAgICAgIC8vIFRoZSBjbGFzcyBwYXJhbWV0ZXIgaXMgYSBjc3Mgc3R5bGVzaGVldCBjbGFzcyBzbyB5b3UgbXVzdCBoYXZlIGl0IGluIHlvdXIgQ1NTLlxuICAgICAgICAgICAgICAgICAgICBfZXJyb3JNYXJrZXJzLnB1c2goc2Vzc2lvbi5hZGRNYXJrZXIocmFuZ2UsIFwidHlwZXNjcmlwdC1lcnJvclwiLCBcInRleHRcIiwgdHJ1ZSkpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICBpZiAod29ya3NwYWNlICYmIHR5cGVvZiBfZmlsZU5hbWUgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICB3b3Jrc3BhY2UuZ2V0T3V0cHV0RmlsZXMoX2ZpbGVOYW1lLCBmdW5jdGlvbihlcnIsIG91dHB1dEZpbGVzKSB7XG4gICAgICAgICAgICAgICAgc2Vzc2lvbi5fZW1pdChcIm91dHB1dEZpbGVzXCIsIHsgZGF0YTogb3V0cHV0RmlsZXMgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgdmFyIGVkaXRvcldyYXBwZXIgPSB7XG4gICAgICAgIGNsZWFyU2VsZWN0aW9uOiAoKSA9PiB7IGVkaXRvci5jbGVhclNlbGVjdGlvbigpOyB9LFxuICAgICAgICBnZXQgZmlsZU5hbWUoKTogc3RyaW5nIHsgcmV0dXJuIF9maWxlTmFtZTsgfSxcbiAgICAgICAgc2V0IGZpbGVOYW1lKHZhbHVlKSB7IF9maWxlTmFtZSA9IHZhbHVlOyB9LFxuICAgICAgICBnZXQgY29tbWFuZHMoKSB7IHJldHVybiBlZGl0b3IuY29tbWFuZHM7IH0sXG4gICAgICAgIGdldCBjb250YWluZXIoKSB7IHJldHVybiBlZGl0b3IuY29udGFpbmVyOyB9LFxuICAgICAgICBnZXQgc2Vzc2lvbigpIHsgcmV0dXJuIGVkaXRvci5zZXNzaW9uOyB9LFxuICAgICAgICBnZXRDdXJzb3JQb3NpdGlvbjogKCkgPT4geyByZXR1cm4gZWRpdG9yLmdldEN1cnNvclBvc2l0aW9uKCk7IH0sXG4gICAgICAgIGdldFNlbGVjdGlvbjogKCkgPT4geyByZXR1cm4gZWRpdG9yLmdldFNlbGVjdGlvbigpOyB9LFxuICAgICAgICBnZXRWYWx1ZTogKCkgPT4geyByZXR1cm4gZWRpdG9yLmdldFZhbHVlKCk7IH0sXG4gICAgICAgIGdvdG9MaW5lOiAobGluZU51bWJlcjogbnVtYmVyLCBjb2x1bW46IG51bWJlciwgYW5pbWF0ZT86IGJvb2xlYW4pID0+IHsgcmV0dXJuIGVkaXRvci5nb3RvTGluZShsaW5lTnVtYmVyLCBjb2x1bW4sIGFuaW1hdGUpOyB9LFxuICAgICAgICBmb2N1czogKCkgPT4geyBlZGl0b3IuZm9jdXMoKTsgfSxcbiAgICAgICAgaW5kZW50OiAoKSA9PiB7IGVkaXRvci5pbmRlbnQoKTsgfSxcbiAgICAgICAgbW92ZUN1cnNvclRvOiAocm93OiBudW1iZXIsIGNvbHVtbjogbnVtYmVyLCBhbmltYXRlPzogYm9vbGVhbikgPT4geyByZXR1cm4gZWRpdG9yLm1vdmVDdXJzb3JUbyhyb3csIGNvbHVtbiwgYW5pbWF0ZSk7IH0sXG4gICAgICAgIHJlc2l6ZTogKGZvcmNlOiBib29sZWFuKSA9PiB7IHJldHVybiBlZGl0b3IucmVzaXplKGZvcmNlKTsgfSxcbiAgICAgICAgc2VsZWN0QWxsOiAoKSA9PiB7IGVkaXRvci5zZWxlY3RBbGwoKTsgfSxcbiAgICAgICAgc2V0QXV0b1Njcm9sbEVkaXRvckludG9WaWV3OiAoZW5hYmxlOiBib29sZWFuKSA9PiB7IHJldHVybiBlZGl0b3Iuc2V0QXV0b1Njcm9sbEVkaXRvckludG9WaWV3KGVuYWJsZSk7IH0sXG4gICAgICAgIHNldEZvbnRTaXplOiAoZm9udFNpemU6IHN0cmluZykgPT4geyByZXR1cm4gZWRpdG9yLnNldEZvbnRTaXplKGZvbnRTaXplKTsgfSxcbiAgICAgICAgc2V0T3B0aW9uOiAobmFtZTogc3RyaW5nLCB2YWx1ZTogYW55KSA9PiB7IHJldHVybiBlZGl0b3Iuc2V0T3B0aW9uKG5hbWUsIHZhbHVlKTsgfSxcbiAgICAgICAgc2V0T3B0aW9uczogKG9wdGlvbnM6IGFueSkgPT4geyByZXR1cm4gZWRpdG9yLnNldE9wdGlvbnMob3B0aW9ucyk7IH0sXG4gICAgICAgIHNldFNob3dJbnZpc2libGVzOiAoc2hvd0ludmlzaWJsZXM6IGJvb2xlYW4pID0+IHsgcmV0dXJuIGVkaXRvci5zZXRTaG93SW52aXNpYmxlcyhzaG93SW52aXNpYmxlcyk7IH0sXG4gICAgICAgIHNldFRoZW1lOiAodGhlbWU6IHN0cmluZywgY2FsbGJhY2s/OiAoKSA9PiB2b2lkKSA9PiB7IHJldHVybiBlZGl0b3Iuc2V0VGhlbWUodGhlbWUsIGNhbGxiYWNrKTsgfSxcbiAgICAgICAgc2V0VmFsdWU6ICh2YWw6IHN0cmluZywgY3Vyc29yUG9zPzogbnVtYmVyKSA9PiB7IHJldHVybiBlZGl0b3Iuc2V0VmFsdWUodmFsLCBjdXJzb3JQb3MpOyB9LFxuICAgICAgICBnZXRTZXNzaW9uOiAoKSA9PiB7IHJldHVybiBlZGl0b3IuZ2V0U2Vzc2lvbigpOyB9LFxuICAgICAgICBhZGRFdmVudExpc3RlbmVyOiAoZXZlbnROYW1lOiBzdHJpbmcsIGNhbGxiYWNrOiAoKSA9PiB2b2lkLCBjYXB0dXJpbmc/OiBib29sZWFuKSA9PiB7IHJldHVybiBlZGl0b3IuYWRkRXZlbnRMaXN0ZW5lcihldmVudE5hbWUsIGNhbGxiYWNrLCBjYXB0dXJpbmcpOyB9LFxuICAgICAgICBnZXQgb25UZXh0SW5wdXQoKTogYW55IHsgcmV0dXJuIGVkaXRvci5vblRleHRJbnB1dDsgfSxcbiAgICAgICAgc2V0IG9uVGV4dElucHV0KHZhbHVlKSB7IGVkaXRvci5vblRleHRJbnB1dCA9IHZhbHVlOyB9LFxuXG4gICAgICAgIGdldERpc3BsYXlJbmRlbnRHdWlkZXM6ICgpID0+IHsgcmV0dXJuIGVkaXRvci5nZXREaXNwbGF5SW5kZW50R3VpZGVzKCk7IH0sXG4gICAgICAgIHNldERpc3BsYXlJbmRlbnRHdWlkZXM6IChkaXNwbGF5SW5kZW50R3VpZGVzOiBib29sZWFuKSA9PiB7IHJldHVybiBlZGl0b3Iuc2V0RGlzcGxheUluZGVudEd1aWRlcyhkaXNwbGF5SW5kZW50R3VpZGVzKTsgfSxcblxuICAgICAgICBnZXRTaG93UHJpbnRNYXJnaW46ICgpID0+IHsgcmV0dXJuIGVkaXRvci5nZXRTaG93UHJpbnRNYXJnaW4oKTsgfSxcbiAgICAgICAgc2V0U2hvd1ByaW50TWFyZ2luOiAoc2hvd1ByaW50TWFyZ2luOiBib29sZWFuKSA9PiB7IHJldHVybiBlZGl0b3Iuc2V0U2hvd1ByaW50TWFyZ2luKHNob3dQcmludE1hcmdpbik7IH0sXG5cbiAgICAgICAgY2hhbmdlRmlsZTogY2hhbmdlRmlsZVxuICAgIH07XG5cbiAgICByZXR1cm4gZWRpdG9yV3JhcHBlcjtcbn1cblxuLy8gV2UgY2FuJ3QgZXhwb3J0IHRoaXMgeWV0IHVudGlsIHdlIGNhbiBjcmVhdGUgdGhlIGlubmVyIGVkaXRvciBpbiBUeXBlU2NyaXB0LlxuZnVuY3Rpb24gZWRpdChzb3VyY2U6IGFueSwgd29ya3NwYWNlOiBXb3Jrc3BhY2UsIGRvYzogRG9jdW1lbnQgPSB3aW5kb3cuZG9jdW1lbnQpIHtcblxuICAgIHZhciByb290RWxlbWVudCA9IChmdW5jdGlvbigpOiBIVE1MRWxlbWVudCB7XG4gICAgICAgIGlmICh0eXBlb2Ygc291cmNlID09PSBcInN0cmluZ1wiKSB7XG5cbiAgICAgICAgICAgIHZhciBlbGVtZW50ID0gZG9jLmdldEVsZW1lbnRCeUlkKHNvdXJjZSk7XG4gICAgICAgICAgICBpZiAoZWxlbWVudCkge1xuICAgICAgICAgICAgICAgIHJldHVybiBlbGVtZW50O1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKHNvdXJjZSArIFwiIG11c3QgYmUgYW4gZWxlbWVudCBpZFwiKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHJldHVybiBzb3VyY2U7XG4gICAgICAgIH1cbiAgICB9KSgpO1xuXG4gICAgdmFyIF9lZGl0b3IgPSAoZnVuY3Rpb24oZWxlbWVudDogSFRNTEVsZW1lbnQpOiBFZGl0b3Ige1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJlZGl0IGlzIGN1cnJlbnRseSB1bnN1cHBvcnRlZFwiKTtcbiAgICAgICAgLy8gICAgcmV0dXJuIGJhc2ljLmVkaXQoZWxlbWVudCk7XG4gICAgfSkocm9vdEVsZW1lbnQpO1xuXG4gICAgcmV0dXJuIHdyYXAoX2VkaXRvciwgcm9vdEVsZW1lbnQsIHdvcmtzcGFjZSwgZG9jKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHdvcmtzcGFjZSgpIHtcbiAgICByZXR1cm4gd29ya3NwYWNlKCk7XG59XG4iXX0=