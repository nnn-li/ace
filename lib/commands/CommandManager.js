import { applyMixins } from "../lib/mix";
import { HashHandler } from "../keyboard/hash_handler";
import { EventEmitterClass } from "../lib/event_emitter";
export default class CommandManager extends EventEmitterClass {
    constructor(platform, commands) {
        super();
        this.hashHandler = new HashHandler();
        HashHandler.call(this, commands, platform);
        this.byName = this.hashHandler.commands;
        this.setDefaultHandler("exec", function (e) {
            return e.command.exec(e.editor, e.args || {});
        });
    }
    get commands() {
        return this.hashHandler.commands;
    }
    get commandKeyBinding() {
        return this.hashHandler.commandKeyBinding;
    }
    bindKey(key, command) {
        return this.hashHandler.bindKey(key, command);
    }
    bindKeys(keyList) {
        return this.hashHandler.bindKeys(keyList);
    }
    addCommand(command) {
        this.hashHandler.addCommand(command);
    }
    removeCommand(commandName) {
        this.hashHandler.removeCommand(commandName);
    }
    findKeyCommand(hashId, keyString) {
        return this.hashHandler.findKeyCommand(hashId, keyString);
    }
    parseKeys(keys) {
        return this.hashHandler.parseKeys(keys);
    }
    addCommands(commands) {
        this.hashHandler.addCommands(commands);
    }
    removeCommands(commands) {
        this.hashHandler.removeCommands(commands);
    }
    handleKeyboard(data, hashId, keyString, keyCode) {
        return this.hashHandler.handleKeyboard(data, hashId, keyString, keyCode);
    }
    exec(command, editor, args) {
        if (typeof command === 'string') {
            command = this.hashHandler.commands[command];
        }
        if (!command) {
            return false;
        }
        if (editor && editor.$readOnly && !command.readOnly) {
            return false;
        }
        var e = { editor: editor, command: command, args: args };
        var retvalue = this._emit("exec", e);
        this._signal("afterExec", e);
        return retvalue === false ? false : true;
    }
    toggleRecording(editor) {
        if (this.$inReplay)
            return;
        editor && editor._emit("changeStatus");
        if (this.recording) {
            this.macro.pop();
            this.removeEventListener("exec", this.$addCommandToMacro);
            if (!this.macro.length)
                this.macro = this.oldMacro;
            return this.recording = false;
        }
        if (!this.$addCommandToMacro) {
            this.$addCommandToMacro = function (e) {
                this.macro.push([e.command, e.args]);
            }.bind(this);
        }
        this.oldMacro = this.macro;
        this.macro = [];
        this.on("exec", this.$addCommandToMacro);
        return this.recording = true;
    }
    replay(editor) {
        if (this.$inReplay || !this.macro)
            return;
        if (this.recording)
            return this.toggleRecording(editor);
        try {
            this.$inReplay = true;
            this.macro.forEach(function (x) {
                if (typeof x == "string")
                    this.exec(x, editor);
                else
                    this.exec(x[0], editor, x[1]);
            }, this);
        }
        finally {
            this.$inReplay = false;
        }
    }
    trimMacro(m) {
        return m.map(function (x) {
            if (typeof x[0] != "string")
                x[0] = x[0].name;
            if (!x[1])
                x = x[0];
            return x;
        });
    }
}
applyMixins(CommandManager, [HashHandler]);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29tbWFuZE1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29tbWFuZHMvQ29tbWFuZE1hbmFnZXIudHMiXSwibmFtZXMiOlsiQ29tbWFuZE1hbmFnZXIiLCJDb21tYW5kTWFuYWdlci5jb25zdHJ1Y3RvciIsIkNvbW1hbmRNYW5hZ2VyLmNvbW1hbmRzIiwiQ29tbWFuZE1hbmFnZXIuY29tbWFuZEtleUJpbmRpbmciLCJDb21tYW5kTWFuYWdlci5iaW5kS2V5IiwiQ29tbWFuZE1hbmFnZXIuYmluZEtleXMiLCJDb21tYW5kTWFuYWdlci5hZGRDb21tYW5kIiwiQ29tbWFuZE1hbmFnZXIucmVtb3ZlQ29tbWFuZCIsIkNvbW1hbmRNYW5hZ2VyLmZpbmRLZXlDb21tYW5kIiwiQ29tbWFuZE1hbmFnZXIucGFyc2VLZXlzIiwiQ29tbWFuZE1hbmFnZXIuYWRkQ29tbWFuZHMiLCJDb21tYW5kTWFuYWdlci5yZW1vdmVDb21tYW5kcyIsIkNvbW1hbmRNYW5hZ2VyLmhhbmRsZUtleWJvYXJkIiwiQ29tbWFuZE1hbmFnZXIuZXhlYyIsIkNvbW1hbmRNYW5hZ2VyLnRvZ2dsZVJlY29yZGluZyIsIkNvbW1hbmRNYW5hZ2VyLnJlcGxheSIsIkNvbW1hbmRNYW5hZ2VyLnRyaW1NYWNybyJdLCJtYXBwaW5ncyI6Ik9BQU8sRUFBQyxXQUFXLEVBQUMsTUFBTSxZQUFZO09BQy9CLEVBQUMsV0FBVyxFQUFDLE1BQU0sMEJBQTBCO09BQzdDLEVBQUMsaUJBQWlCLEVBQUMsTUFBTSxzQkFBc0I7QUFJdEQsNENBQTRDLGlCQUFpQjtJQWV6REEsWUFBWUEsUUFBZ0JBLEVBQUVBLFFBQW1CQTtRQUM3Q0MsT0FBT0EsQ0FBQ0E7UUFmSkEsZ0JBQVdBLEdBQUdBLElBQUlBLFdBQVdBLEVBQUVBLENBQUNBO1FBZ0JwQ0EsV0FBV0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsRUFBRUEsUUFBUUEsRUFBRUEsUUFBUUEsQ0FBQ0EsQ0FBQ0E7UUFDM0NBLElB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Q0FBQ0EsS0FBS0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsVUFBU0EsQ0FBQ0E7Z0JBQ3pCLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLFFBQVEsQ0FBQztvQkFDckIsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7Z0JBQ3pCLElBQUk7b0JBQ0EsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3RDLENBQUMsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDYkEsQ0FBQ0E7Z0JBQVNBLENBQUNBO1lBQ1BBLElBQUlBLENBQUNBLFNBQVNBLEdBQUdBLEtBQUtBLENBQUNBO1FBQzNCQSxDQUFDQTtJQUNMQSxDQUFDQTtJQUVEZixTQUFTQSxDQUFDQSxDQUFDQTtRQUNQZ0IsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsVUFBU0EsQ0FBQ0E7WUFDbkIsRUFBRSxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksUUFBUSxDQUFDO2dCQUN4QixDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQztZQUNyQixFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDTixDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2IsTUFBTSxDQUFDLENBQUMsQ0FBQztRQUNiLENBQUMsQ0FBQ0EsQ0FBQ0E7SUFDUEEsQ0FBQ0E7QUFDTGhCLENBQUNBO0FBRUQsV0FBVyxDQUFDLGNBQWMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2FwcGx5TWl4aW5zfSBmcm9tIFwiLi4vbGliL21peFwiO1xuaW1wb3J0IHtIYXNoSGFuZGxlcn0gZnJvbSBcIi4uL2tleWJvYXJkL2hhc2hfaGFuZGxlclwiO1xuaW1wb3J0IHtFdmVudEVtaXR0ZXJDbGFzc30gZnJvbSBcIi4uL2xpYi9ldmVudF9lbWl0dGVyXCI7XG5pbXBvcnQgQ29tbWFuZCBmcm9tICcuL0NvbW1hbmQnO1xuaW1wb3J0IEVkaXRvciBmcm9tICcuLi9FZGl0b3InO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBDb21tYW5kTWFuYWdlciBleHRlbmRzIEV2ZW50RW1pdHRlckNsYXNzIGltcGxlbWVudHMgSGFzaEhhbmRsZXIge1xuICAgIHByaXZhdGUgaGFzaEhhbmRsZXIgPSBuZXcgSGFzaEhhbmRsZXIoKTtcbiAgICBwdWJsaWMgcGxhdGZvcm07XG4gICAgcHJpdmF0ZSBieU5hbWU7XG4gICAgcHJpdmF0ZSAkaW5SZXBsYXk7XG4gICAgcHJpdmF0ZSByZWNvcmRpbmc7XG4gICAgcHJpdmF0ZSBtYWNybztcbiAgICBwcml2YXRlIG9sZE1hY3JvO1xuICAgIHByaXZhdGUgJGFkZENvbW1hbmRUb01hY3JvO1xuICAgIF9idWlsZEtleUhhc2hcblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwbGF0Zm9ybSBJZGVudGlmaWVyIGZvciB0aGUgcGxhdGZvcm07IG11c3QgYmUgZWl0aGVyIGAnbWFjJ2Agb3IgYCd3aW4nYFxuICAgICAqIEBwYXJhbSB7QXJyYXl9IGNvbW1hbmRzIEEgbGlzdCBvZiBjb21tYW5kc1xuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKHBsYXRmb3JtOiBzdHJpbmcsIGNvbW1hbmRzOiBDb21tYW5kW10pIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgSGFzaEhhbmRsZXIuY2FsbCh0aGlzLCBjb21tYW5kcywgcGxhdGZvcm0pO1xuICAgICAgICB0aGlzLmJ5TmFtZSA9IHRoaXMuaGFzaEhhbmRsZXIuY29tbWFuZHM7XG4gICAgICAgIHRoaXMuc2V0RGVmYXVsdEhhbmRsZXIoXCJleGVjXCIsIGZ1bmN0aW9uKGU6IHsgY29tbWFuZDogQ29tbWFuZDsgZWRpdG9yOiBFZGl0b3I7IGFyZ3MgfSkge1xuICAgICAgICAgICAgcmV0dXJuIGUuY29tbWFuZC5leGVjKGUuZWRpdG9yLCBlLmFyZ3MgfHwge30pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBnZXQgY29tbWFuZHMoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmhhc2hIYW5kbGVyLmNvbW1hbmRzO1xuICAgIH1cblxuICAgIGdldCBjb21tYW5kS2V5QmluZGluZygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaGFzaEhhbmRsZXIuY29tbWFuZEtleUJpbmRpbmc7XG4gICAgfVxuXG4gICAgYmluZEtleShrZXk6IHN0cmluZywgY29tbWFuZCkge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNoSGFuZGxlci5iaW5kS2V5KGtleSwgY29tbWFuZCk7XG4gICAgfVxuXG4gICAgYmluZEtleXMoa2V5TGlzdCkge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNoSGFuZGxlci5iaW5kS2V5cyhrZXlMaXN0KTtcbiAgICB9XG5cbiAgICBhZGRDb21tYW5kKGNvbW1hbmQpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5oYXNoSGFuZGxlci5hZGRDb21tYW5kKGNvbW1hbmQpO1xuICAgIH1cblxuICAgIHJlbW92ZUNvbW1hbmQoY29tbWFuZE5hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICB0aGlzLmhhc2hIYW5kbGVyLnJlbW92ZUNvbW1hbmQoY29tbWFuZE5hbWUpO1xuICAgIH1cblxuICAgIGZpbmRLZXlDb21tYW5kKGhhc2hJZCwga2V5U3RyaW5nOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaGFzaEhhbmRsZXIuZmluZEtleUNvbW1hbmQoaGFzaElkLCBrZXlTdHJpbmcpO1xuICAgIH1cblxuICAgIHBhcnNlS2V5cyhrZXlzOiBzdHJpbmcpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaGFzaEhhbmRsZXIucGFyc2VLZXlzKGtleXMpO1xuICAgIH1cblxuICAgIGFkZENvbW1hbmRzKGNvbW1hbmRzKTogdm9pZCB7XG4gICAgICAgIHRoaXMuaGFzaEhhbmRsZXIuYWRkQ29tbWFuZHMoY29tbWFuZHMpO1xuICAgIH1cblxuICAgIHJlbW92ZUNvbW1hbmRzKGNvbW1hbmRzKTogdm9pZCB7XG4gICAgICAgIHRoaXMuaGFzaEhhbmRsZXIucmVtb3ZlQ29tbWFuZHMoY29tbWFuZHMpO1xuICAgIH1cblxuICAgIGhhbmRsZUtleWJvYXJkKGRhdGEsIGhhc2hJZDogbnVtYmVyLCBrZXlTdHJpbmc6IHN0cmluZywga2V5Q29kZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNoSGFuZGxlci5oYW5kbGVLZXlib2FyZChkYXRhLCBoYXNoSWQsIGtleVN0cmluZywga2V5Q29kZSk7XG4gICAgfVxuXG4gICAgZXhlYyhjb21tYW5kOiBhbnksIGVkaXRvcj86IEVkaXRvciwgYXJncz8pIHtcbiAgICAgICAgaWYgKHR5cGVvZiBjb21tYW5kID09PSAnc3RyaW5nJykge1xuICAgICAgICAgICAgY29tbWFuZCA9IHRoaXMuaGFzaEhhbmRsZXIuY29tbWFuZHNbY29tbWFuZF07XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoIWNvbW1hbmQpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChlZGl0b3IgJiYgZWRpdG9yLiRyZWFkT25seSAmJiAhY29tbWFuZC5yZWFkT25seSkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFyIGUgPSB7IGVkaXRvcjogZWRpdG9yLCBjb21tYW5kOiBjb21tYW5kLCBhcmdzOiBhcmdzIH07XG4gICAgICAgIHZhciByZXR2YWx1ZSA9IHRoaXMuX2VtaXQoXCJleGVjXCIsIGUpO1xuICAgICAgICB0aGlzLl9zaWduYWwoXCJhZnRlckV4ZWNcIiwgZSk7XG5cbiAgICAgICAgcmV0dXJuIHJldHZhbHVlID09PSBmYWxzZSA/IGZhbHNlIDogdHJ1ZTtcbiAgICB9XG5cbiAgICB0b2dnbGVSZWNvcmRpbmcoZWRpdG9yOiBFZGl0b3IpIHtcbiAgICAgICAgaWYgKHRoaXMuJGluUmVwbGF5KVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGVkaXRvciAmJiBlZGl0b3IuX2VtaXQoXCJjaGFuZ2VTdGF0dXNcIik7XG4gICAgICAgIGlmICh0aGlzLnJlY29yZGluZykge1xuICAgICAgICAgICAgdGhpcy5tYWNyby5wb3AoKTtcbiAgICAgICAgICAgIHRoaXMucmVtb3ZlRXZlbnRMaXN0ZW5lcihcImV4ZWNcIiwgdGhpcy4kYWRkQ29tbWFuZFRvTWFjcm8pO1xuXG4gICAgICAgICAgICBpZiAoIXRoaXMubWFjcm8ubGVuZ3RoKVxuICAgICAgICAgICAgICAgIHRoaXMubWFjcm8gPSB0aGlzLm9sZE1hY3JvO1xuXG4gICAgICAgICAgICByZXR1cm4gdGhpcy5yZWNvcmRpbmcgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIXRoaXMuJGFkZENvbW1hbmRUb01hY3JvKSB7XG4gICAgICAgICAgICB0aGlzLiRhZGRDb21tYW5kVG9NYWNybyA9IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgICAgICB0aGlzLm1hY3JvLnB1c2goW2UuY29tbWFuZCwgZS5hcmdzXSk7XG4gICAgICAgICAgICB9LmJpbmQodGhpcyk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLm9sZE1hY3JvID0gdGhpcy5tYWNybztcbiAgICAgICAgdGhpcy5tYWNybyA9IFtdO1xuICAgICAgICB0aGlzLm9uKFwiZXhlY1wiLCB0aGlzLiRhZGRDb21tYW5kVG9NYWNybyk7XG4gICAgICAgIHJldHVybiB0aGlzLnJlY29yZGluZyA9IHRydWU7XG4gICAgfVxuXG4gICAgcmVwbGF5KGVkaXRvcjogRWRpdG9yKSB7XG4gICAgICAgIGlmICh0aGlzLiRpblJlcGxheSB8fCAhdGhpcy5tYWNybylcbiAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICBpZiAodGhpcy5yZWNvcmRpbmcpXG4gICAgICAgICAgICByZXR1cm4gdGhpcy50b2dnbGVSZWNvcmRpbmcoZWRpdG9yKTtcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgdGhpcy4kaW5SZXBsYXkgPSB0cnVlO1xuICAgICAgICAgICAgdGhpcy5tYWNyby5mb3JFYWNoKGZ1bmN0aW9uKHgpIHtcbiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHggPT0gXCJzdHJpbmdcIilcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5leGVjKHgsIGVkaXRvcik7XG4gICAgICAgICAgICAgICAgZWxzZVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmV4ZWMoeFswXSwgZWRpdG9yLCB4WzFdKTtcbiAgICAgICAgICAgIH0sIHRoaXMpO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgdGhpcy4kaW5SZXBsYXkgPSBmYWxzZTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHRyaW1NYWNybyhtKSB7XG4gICAgICAgIHJldHVybiBtLm1hcChmdW5jdGlvbih4KSB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIHhbMF0gIT0gXCJzdHJpbmdcIilcbiAgICAgICAgICAgICAgICB4WzBdID0geFswXS5uYW1lO1xuICAgICAgICAgICAgaWYgKCF4WzFdKVxuICAgICAgICAgICAgICAgIHggPSB4WzBdO1xuICAgICAgICAgICAgcmV0dXJuIHg7XG4gICAgICAgIH0pO1xuICAgIH1cbn1cblxuYXBwbHlNaXhpbnMoQ29tbWFuZE1hbmFnZXIsIFtIYXNoSGFuZGxlcl0pO1xuIl19