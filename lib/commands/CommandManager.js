var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var mix = require("../lib/mix");
var hhm = require("../keyboard/hash_handler");
var eem = require("../lib/event_emitter");
var CommandManager = (function (_super) {
    __extends(CommandManager, _super);
    function CommandManager(platform, commands) {
        _super.call(this);
        this.hashHandler = new hhm.HashHandler();
        hhm.HashHandler.call(this, commands, platform);
        this.byName = this.hashHandler.commands;
        this.setDefaultHandler("exec", function (e) {
            return e.command.exec(e.editor, e.args || {});
        });
    }
    Object.defineProperty(CommandManager.prototype, "commands", {
        get: function () {
            return this.hashHandler.commands;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(CommandManager.prototype, "commandKeyBinding", {
        get: function () {
            return this.hashHandler.commandKeyBinding;
        },
        enumerable: true,
        configurable: true
    });
    CommandManager.prototype.bindKey = function (key, command) {
        return this.hashHandler.bindKey(key, command);
    };
    CommandManager.prototype.bindKeys = function (keyList) {
        return this.hashHandler.bindKeys(keyList);
    };
    CommandManager.prototype.addCommand = function (command) {
        this.hashHandler.addCommand(command);
    };
    CommandManager.prototype.removeCommand = function (commandName) {
        this.hashHandler.removeCommand(commandName);
    };
    CommandManager.prototype.findKeyCommand = function (hashId, keyString) {
        return this.hashHandler.findKeyCommand(hashId, keyString);
    };
    CommandManager.prototype.parseKeys = function (keys) {
        return this.hashHandler.parseKeys(keys);
    };
    CommandManager.prototype.addCommands = function (commands) {
        this.hashHandler.addCommands(commands);
    };
    CommandManager.prototype.removeCommands = function (commands) {
        this.hashHandler.removeCommands(commands);
    };
    CommandManager.prototype.handleKeyboard = function (data, hashId, keyString, keyCode) {
        return this.hashHandler.handleKeyboard(data, hashId, keyString, keyCode);
    };
    CommandManager.prototype.exec = function (command, editor, args) {
        if (typeof command === 'string') {
            command = this.hashHandler.commands[command];
        }
        if (!command) {
            return false;
        }
        if (editor && editor.$readOnly && !command.readOnly) {
            return false;
        }
        var e = { editor: editor, command: command, args: args };
        var retvalue = this._emit("exec", e);
        this._signal("afterExec", e);
        return retvalue === false ? false : true;
    };
    CommandManager.prototype.toggleRecording = function (editor) {
        if (this.$inReplay)
            return;
        editor && editor._emit("changeStatus");
        if (this.recording) {
            this.macro.pop();
            this.removeEventListener("exec", this.$addCommandToMacro);
            if (!this.macro.length)
                this.macro = this.oldMacro;
            return this.recording = false;
        }
        if (!this.$addCommandToMacro) {
            this.$addCommandToMacro = function (e) {
                this.macro.push([e.command, e.args]);
            }.bind(this);
        }
        this.oldMacro = this.macro;
        this.macro = [];
        this.on("exec", this.$addCommandToMacro);
        return this.recording = true;
    };
    CommandManager.prototype.replay = function (editor) {
        if (this.$inReplay || !this.macro)
            return;
        if (this.recording)
            return this.toggleRecording(editor);
        try {
            this.$inReplay = true;
            this.macro.forEach(function (x) {
                if (typeof x == "string")
                    this.exec(x, editor);
                else
                    this.exec(x[0], editor, x[1]);
            }, this);
        }
        finally {
            this.$inReplay = false;
        }
    };
    CommandManager.prototype.trimMacro = function (m) {
        return m.map(function (x) {
            if (typeof x[0] != "string")
                x[0] = x[0].name;
            if (!x[1])
                x = x[0];
            return x;
        });
    };
    return CommandManager;
})(eem.EventEmitterClass);
mix.applyMixins(CommandManager, [hhm.HashHandler]);
module.exports = CommandManager;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29tbWFuZE1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29tbWFuZHMvQ29tbWFuZE1hbmFnZXIudHMiXSwibmFtZXMiOlsiQ29tbWFuZE1hbmFnZXIiLCJDb21tYW5kTWFuYWdlci5jb25zdHJ1Y3RvciIsIkNvbW1hbmRNYW5hZ2VyLmNvbW1hbmRzIiwiQ29tbWFuZE1hbmFnZXIuY29tbWFuZEtleUJpbmRpbmciLCJDb21tYW5kTWFuYWdlci5iaW5kS2V5IiwiQ29tbWFuZE1hbmFnZXIuYmluZEtleXMiLCJDb21tYW5kTWFuYWdlci5hZGRDb21tYW5kIiwiQ29tbWFuZE1hbmFnZXIucmVtb3ZlQ29tbWFuZCIsIkNvbW1hbmRNYW5hZ2VyLmZpbmRLZXlDb21tYW5kIiwiQ29tbWFuZE1hbmFnZXIucGFyc2VLZXlzIiwiQ29tbWFuZE1hbmFnZXIuYWRkQ29tbWFuZHMiLCJDb21tYW5kTWFuYWdlci5yZW1vdmVDb21tYW5kcyIsIkNvbW1hbmRNYW5hZ2VyLmhhbmRsZUtleWJvYXJkIiwiQ29tbWFuZE1hbmFnZXIuZXhlYyIsIkNvbW1hbmRNYW5hZ2VyLnRvZ2dsZVJlY29yZGluZyIsIkNvbW1hbmRNYW5hZ2VyLnJlcGxheSIsIkNvbW1hbmRNYW5hZ2VyLnRyaW1NYWNybyJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxJQUFPLEdBQUcsV0FBVyxZQUFZLENBQUMsQ0FBQztBQUVuQyxJQUFPLEdBQUcsV0FBVywwQkFBMEIsQ0FBQyxDQUFDO0FBQ2pELElBQU8sR0FBRyxXQUFXLHNCQUFzQixDQUFDLENBQUM7QUFJN0M7SUFBNkJBLGtDQUFxQkE7SUFlOUNBLHdCQUFZQSxRQUFnQkEsRUFBRUEsUUFBbUJBO1FBQzdDQyxpQkFBT0EsQ0FBQ0E7UUFmSkEsZ0JBQVdBLEdBQUdBLElBQUlBLEdBQUdBLENBQUNBLFdBQVdBLEVBQUVBLENBQUNBO1FBZ0J4Q0EsR0FBR0EsQ0FBQ0EsV0FBV0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEs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TGhCLHFCQUFDQTtBQUFEQSxDQUFDQSxBQS9JRCxFQUE2QixHQUFHLENBQUMsaUJBQWlCLEVBK0lqRDtBQUVELEdBQUcsQ0FBQyxXQUFXLENBQUMsY0FBYyxFQUFFLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDLENBQUM7QUFFbkQsaUJBQVMsY0FBYyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IG1peCA9IHJlcXVpcmUoXCIuLi9saWIvbWl4XCIpO1xuaW1wb3J0IG9vcCA9IHJlcXVpcmUoXCIuLi9saWIvb29wXCIpO1xuaW1wb3J0IGhobSA9IHJlcXVpcmUoXCIuLi9rZXlib2FyZC9oYXNoX2hhbmRsZXJcIik7XG5pbXBvcnQgZWVtID0gcmVxdWlyZShcIi4uL2xpYi9ldmVudF9lbWl0dGVyXCIpO1xuaW1wb3J0IENvbW1hbmQgPSByZXF1aXJlKCcuL0NvbW1hbmQnKTtcbmltcG9ydCBFZGl0b3IgPSByZXF1aXJlKCcuLi9FZGl0b3InKTtcblxuY2xhc3MgQ29tbWFuZE1hbmFnZXIgZXh0ZW5kcyBlZW0uRXZlbnRFbWl0dGVyQ2xhc3MgaW1wbGVtZW50cyBoaG0uSGFzaEhhbmRsZXIge1xuICAgIHByaXZhdGUgaGFzaEhhbmRsZXIgPSBuZXcgaGhtLkhhc2hIYW5kbGVyKCk7XG4gICAgcHVibGljIHBsYXRmb3JtO1xuICAgIHByaXZhdGUgYnlOYW1lO1xuICAgIHByaXZhdGUgJGluUmVwbGF5O1xuICAgIHByaXZhdGUgcmVjb3JkaW5nO1xuICAgIHByaXZhdGUgbWFjcm87XG4gICAgcHJpdmF0ZSBvbGRNYWNybztcbiAgICBwcml2YXRlICRhZGRDb21tYW5kVG9NYWNybztcbiAgICBfYnVpbGRLZXlIYXNoXG5cbiAgICAvKipcbiAgICAgKiBAcGFyYW0ge3N0cmluZ30gcGxhdGZvcm0gSWRlbnRpZmllciBmb3IgdGhlIHBsYXRmb3JtOyBtdXN0IGJlIGVpdGhlciBgJ21hYydgIG9yIGAnd2luJ2BcbiAgICAgKiBAcGFyYW0ge0FycmF5fSBjb21tYW5kcyBBIGxpc3Qgb2YgY29tbWFuZHNcbiAgICAgKi9cbiAgICBjb25zdHJ1Y3RvcihwbGF0Zm9ybTogc3RyaW5nLCBjb21tYW5kczogQ29tbWFuZFtdKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIGhobS5IYXNoSGFuZGxlci5jYWxsKHRoaXMsIGNvbW1hbmRzLCBwbGF0Zm9ybSk7XG4gICAgICAgIHRoaXMuYnlOYW1lID0gdGhpcy5oYXNoSGFuZGxlci5jb21tYW5kcztcbiAgICAgICAgdGhpcy5zZXREZWZhdWx0SGFuZGxlcihcImV4ZWNcIiwgZnVuY3Rpb24oZTogeyBjb21tYW5kOiBDb21tYW5kOyBlZGl0b3I6IEVkaXRvcjsgYXJncyB9KSB7XG4gICAgICAgICAgICByZXR1cm4gZS5jb21tYW5kLmV4ZWMoZS5lZGl0b3IsIGUuYXJncyB8fCB7fSk7XG4gICAgICAgIH0pO1xuICAgIH1cblxuICAgIGdldCBjb21tYW5kcygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaGFzaEhhbmRsZXIuY29tbWFuZHM7XG4gICAgfVxuXG4gICAgZ2V0IGNvbW1hbmRLZXlCaW5kaW5nKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNoSGFuZGxlci5jb21tYW5kS2V5QmluZGluZztcbiAgICB9XG5cbiAgICBiaW5kS2V5KGtleTogc3RyaW5nLCBjb21tYW5kKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmhhc2hIYW5kbGVyLmJpbmRLZXkoa2V5LCBjb21tYW5kKTtcbiAgICB9XG5cbiAgICBiaW5kS2V5cyhrZXlMaXN0KSB7XG4gICAgICAgIHJldHVybiB0aGlzLmhhc2hIYW5kbGVyLmJpbmRLZXlzKGtleUxpc3QpO1xuICAgIH1cblxuICAgIGFkZENvbW1hbmQoY29tbWFuZCk6IHZvaWQge1xuICAgICAgICB0aGlzLmhhc2hIYW5kbGVyLmFkZENvbW1hbmQoY29tbWFuZCk7XG4gICAgfVxuXG4gICAgcmVtb3ZlQ29tbWFuZChjb21tYW5kTmFtZTogc3RyaW5nKTogdm9pZCB7XG4gICAgICAgIHRoaXMuaGFzaEhhbmRsZXIucmVtb3ZlQ29tbWFuZChjb21tYW5kTmFtZSk7XG4gICAgfVxuXG4gICAgZmluZEtleUNvbW1hbmQoaGFzaElkLCBrZXlTdHJpbmc6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNoSGFuZGxlci5maW5kS2V5Q29tbWFuZChoYXNoSWQsIGtleVN0cmluZyk7XG4gICAgfVxuXG4gICAgcGFyc2VLZXlzKGtleXM6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNoSGFuZGxlci5wYXJzZUtleXMoa2V5cyk7XG4gICAgfVxuXG4gICAgYWRkQ29tbWFuZHMoY29tbWFuZHMpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5oYXNoSGFuZGxlci5hZGRDb21tYW5kcyhjb21tYW5kcyk7XG4gICAgfVxuXG4gICAgcmVtb3ZlQ29tbWFuZHMoY29tbWFuZHMpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5oYXNoSGFuZGxlci5yZW1vdmVDb21tYW5kcyhjb21tYW5kcyk7XG4gICAgfVxuXG4gICAgaGFuZGxlS2V5Ym9hcmQoZGF0YSwgaGFzaElkOiBudW1iZXIsIGtleVN0cmluZzogc3RyaW5nLCBrZXlDb2RlKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmhhc2hIYW5kbGVyLmhhbmRsZUtleWJvYXJkKGRhdGEsIGhhc2hJZCwga2V5U3RyaW5nLCBrZXlDb2RlKTtcbiAgICB9XG5cbiAgICBleGVjKGNvbW1hbmQ6IGFueSwgZWRpdG9yPzogRWRpdG9yLCBhcmdzPykge1xuICAgICAgICBpZiAodHlwZW9mIGNvbW1hbmQgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICBjb21tYW5kID0gdGhpcy5oYXNoSGFuZGxlci5jb21tYW5kc1tjb21tYW5kXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghY29tbWFuZCkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGVkaXRvciAmJiBlZGl0b3IuJHJlYWRPbmx5ICYmICFjb21tYW5kLnJlYWRPbmx5KSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICB2YXIgZSA9IHsgZWRpdG9yOiBlZGl0b3IsIGNvbW1hbmQ6IGNvbW1hbmQsIGFyZ3M6IGFyZ3MgfTtcbiAgICAgICAgdmFyIHJldHZhbHVlID0gdGhpcy5fZW1pdChcImV4ZWNcIiwgZSk7XG4gICAgICAgIHRoaXMuX3NpZ25hbChcImFmdGVyRXhlY1wiLCBlKTtcblxuICAgICAgICByZXR1cm4gcmV0dmFsdWUgPT09IGZhbHNlID8gZmFsc2UgOiB0cnVlO1xuICAgIH1cblxuICAgIHRvZ2dsZVJlY29yZGluZyhlZGl0b3I6IEVkaXRvcikge1xuICAgICAgICBpZiAodGhpcy4kaW5SZXBsYXkpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgZWRpdG9yICYmIGVkaXRvci5fZW1pdChcImNoYW5nZVN0YXR1c1wiKTtcbiAgICAgICAgaWYgKHRoaXMucmVjb3JkaW5nKSB7XG4gICAgICAgICAgICB0aGlzLm1hY3JvLnBvcCgpO1xuICAgICAgICAgICAgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKFwiZXhlY1wiLCB0aGlzLiRhZGRDb21tYW5kVG9NYWNybyk7XG5cbiAgICAgICAgICAgIGlmICghdGhpcy5tYWNyby5sZW5ndGgpXG4gICAgICAgICAgICAgICAgdGhpcy5tYWNybyA9IHRoaXMub2xkTWFjcm87XG5cbiAgICAgICAgICAgIHJldHVybiB0aGlzLnJlY29yZGluZyA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGlmICghdGhpcy4kYWRkQ29tbWFuZFRvTWFjcm8pIHtcbiAgICAgICAgICAgIHRoaXMuJGFkZENvbW1hbmRUb01hY3JvID0gZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgICAgIHRoaXMubWFjcm8ucHVzaChbZS5jb21tYW5kLCBlLmFyZ3NdKTtcbiAgICAgICAgICAgIH0uYmluZCh0aGlzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMub2xkTWFjcm8gPSB0aGlzLm1hY3JvO1xuICAgICAgICB0aGlzLm1hY3JvID0gW107XG4gICAgICAgIHRoaXMub24oXCJleGVjXCIsIHRoaXMuJGFkZENvbW1hbmRUb01hY3JvKTtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVjb3JkaW5nID0gdHJ1ZTtcbiAgICB9XG5cbiAgICByZXBsYXkoZWRpdG9yOiBFZGl0b3IpIHtcbiAgICAgICAgaWYgKHRoaXMuJGluUmVwbGF5IHx8ICF0aGlzLm1hY3JvKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGlmICh0aGlzLnJlY29yZGluZylcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnRvZ2dsZVJlY29yZGluZyhlZGl0b3IpO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB0aGlzLiRpblJlcGxheSA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLm1hY3JvLmZvckVhY2goZnVuY3Rpb24oeCkge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgeCA9PSBcInN0cmluZ1wiKVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmV4ZWMoeCwgZWRpdG9yKTtcbiAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXhlYyh4WzBdLCBlZGl0b3IsIHhbMV0pO1xuICAgICAgICAgICAgfSwgdGhpcyk7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICB0aGlzLiRpblJlcGxheSA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgdHJpbU1hY3JvKG0pIHtcbiAgICAgICAgcmV0dXJuIG0ubWFwKGZ1bmN0aW9uKHgpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgeFswXSAhPSBcInN0cmluZ1wiKVxuICAgICAgICAgICAgICAgIHhbMF0gPSB4WzBdLm5hbWU7XG4gICAgICAgICAgICBpZiAoIXhbMV0pXG4gICAgICAgICAgICAgICAgeCA9IHhbMF07XG4gICAgICAgICAgICByZXR1cm4geDtcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5taXguYXBwbHlNaXhpbnMoQ29tbWFuZE1hbmFnZXIsIFtoaG0uSGFzaEhhbmRsZXJdKTtcblxuZXhwb3J0ID0gQ29tbWFuZE1hbmFnZXI7XG4iXX0=