import { applyMixins } from "../lib/mix";
import HashHandler from "../keyboard/HashHandler";
import { EventEmitterClass } from "../lib/event_emitter";
export default class CommandManager extends EventEmitterClass {
    constructor(platform, commands) {
        super();
        this.hashHandler = new HashHandler(commands, platform);
        this.setDefaultHandler("exec", function (e) {
            return e.command.exec(e.editor, e.args || {});
        });
    }
    get platform() {
        return this.hashHandler.platform;
    }
    get commands() {
        return this.hashHandler.commands;
    }
    get commandKeyBinding() {
        return this.hashHandler.commandKeyBinding;
    }
    bindKey(key, command) {
        return this.hashHandler.bindKey(key, command);
    }
    bindKeys(keyList) {
        return this.hashHandler.bindKeys(keyList);
    }
    addCommand(command) {
        this.hashHandler.addCommand(command);
    }
    removeCommand(commandName) {
        this.hashHandler.removeCommand(commandName);
    }
    findKeyCommand(hashId, keyString) {
        return this.hashHandler.findKeyCommand(hashId, keyString);
    }
    parseKeys(keys) {
        return this.hashHandler.parseKeys(keys);
    }
    addCommands(commands) {
        this.hashHandler.addCommands(commands);
    }
    removeCommands(commands) {
        this.hashHandler.removeCommands(commands);
    }
    handleKeyboard(data, hashId, keyString, keyCode) {
        return this.hashHandler.handleKeyboard(data, hashId, keyString, keyCode);
    }
    exec(command, editor, args) {
        if (typeof command === 'string') {
            command = this.hashHandler.commands[command];
        }
        if (!command) {
            return false;
        }
        if (editor && editor.$readOnly && !command.readOnly) {
            return false;
        }
        var e = { editor: editor, command: command, args: args };
        var retvalue = this._emit("exec", e);
        this._signal("afterExec", e);
        return retvalue === false ? false : true;
    }
    toggleRecording(editor) {
        if (this.$inReplay)
            return;
        editor && editor._emit("changeStatus");
        if (this.recording) {
            this.macro.pop();
            this.removeEventListener("exec", this.$addCommandToMacro);
            if (!this.macro.length)
                this.macro = this.oldMacro;
            return this.recording = false;
        }
        if (!this.$addCommandToMacro) {
            this.$addCommandToMacro = function (e) {
                this.macro.push([e.command, e.args]);
            }.bind(this);
        }
        this.oldMacro = this.macro;
        this.macro = [];
        this.on("exec", this.$addCommandToMacro);
        return this.recording = true;
    }
    replay(editor) {
        if (this.$inReplay || !this.macro)
            return;
        if (this.recording)
            return this.toggleRecording(editor);
        try {
            this.$inReplay = true;
            this.macro.forEach(function (x) {
                if (typeof x == "string")
                    this.exec(x, editor);
                else
                    this.exec(x[0], editor, x[1]);
            }, this);
        }
        finally {
            this.$inReplay = false;
        }
    }
    trimMacro(m) {
        return m.map(function (x) {
            if (typeof x[0] != "string")
                x[0] = x[0].name;
            if (!x[1])
                x = x[0];
            return x;
        });
    }
}
applyMixins(CommandManager, [HashHandler]);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ29tbWFuZE1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29tbWFuZHMvQ29tbWFuZE1hbmFnZXIudHMiXSwibmFtZXMiOlsiQ29tbWFuZE1hbmFnZXIiLCJDb21tYW5kTWFuYWdlci5jb25zdHJ1Y3RvciIsIkNvbW1hbmRNYW5hZ2VyLnBsYXRmb3JtIiwiQ29tbWFuZE1hbmFnZXIuY29tbWFuZHMiLCJDb21tYW5kTWFuYWdlci5jb21tYW5kS2V5QmluZGluZyIsIkNvbW1hbmRNYW5hZ2VyLmJpbmRLZXkiLCJDb21tYW5kTWFuYWdlci5iaW5kS2V5cyIsIkNvbW1hbmRNYW5hZ2VyLmFkZENvbW1hbmQiLCJDb21tYW5kTWFuYWdlci5yZW1vdmVDb21tYW5kIiwiQ29tbWFuZE1hbmFnZXIuZmluZEtleUNvbW1hbmQiLCJDb21tYW5kTWFuYWdlci5wYXJzZUtleXMiLCJDb21tYW5kTWFuYWdlci5hZGRDb21tYW5kcyIsIkNvbW1hbmRNYW5hZ2VyLnJlbW92ZUNvbW1hbmRzIiwiQ29tbWFuZE1hbmFnZXIuaGFuZGxlS2V5Ym9hcmQiLCJDb21tYW5kTWFuYWdlci5leGVjIiwiQ29tbWFuZE1hbmFnZXIudG9nZ2xlUmVjb3JkaW5nIiwiQ29tbWFuZE1hbmFnZXIucmVwbGF5IiwiQ29tbWFuZE1hbmFnZXIudHJpbU1hY3JvIl0sIm1hcHBpbmdzIjoiT0FBTyxFQUFDLFdBQVcsRUFBQyxNQUFNLFlBQVk7T0FDL0IsV0FBVyxNQUFNLHlCQUF5QjtPQUMxQyxFQUFDLGlCQUFpQixFQUFDLE1BQU0sc0JBQXNCO0FBSXRELDRDQUE0QyxpQkFBaUI7SUFhekRBLFlBQVlBLFFBQWdCQSxFQUFFQSxRQUFtQkE7UUFDN0NDLE9BQU9BLENBQUNBO1FBQ1JBLElBQUlBLENBQUNBLFdBQVdBLEdBQUdBLElBQUlBLFdBQVdBLENBQUNBLFFBQVFBLEVBQUVBLFFBQVFBLENBQUNBLENBQUFBO1FBQ3REQSxJQUFJQSxDQUFDQSxpQkFBaUJBLENBQUNBLE1BQU1BLEVBQUVBLFVBQVNBLENBQTZDQTtZQUNqRixNQUFNLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsSUFBSSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQ2xELENBQUMsQ0FBQ0EsQ0FBQ0E7SUFDUEEsQ0FBQ0E7SUFFREQsSUFBSUEsUUFBUUE7UUFDUkUsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsUUFBUUEsQ0FBQ0E7SUFDckNBLENBQUNBO0lBRURGLElBQUlBLFFBQVFBO1FBQ1JHLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLFFBQVFBLENBQUNBO0lBQ3JDQSxDQUFDQTtJQUVESCxJQUFJQSxpQkFBaUJBO1FBQ2pCSSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxpQkFBaUJBLENBQUNBO0lBQzlDQSxDQUFDQTtJQUVESixPQUFPQSxDQUFDQSxHQUFXQSxFQUFFQSxPQUFZQTtRQUM3QkssTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsR0FBR0EsRUFBRUEsT0FBT0EsQ0FBQ0EsQ0FBQ0E7SUFDbERBLENBQUNBO0lBRURMLFFBQVFBLENBQUNBLE9BQU9BO1FBQ1pNLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLFFBQVFBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBO0lBQzlDQSxDQUFDQTtJQUVETixVQUFVQSxDQUFDQSxPQUFnQkE7UUFDdkJPLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLFVBQVVBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBO0lBQ3pDQSxDQUFDQTtJQUVEUCxhQUFhQSxDQUFDQSxXQUFtQkE7UUFDN0JRLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLGFBQWFBLENBQUNBLFdBQVdBLENBQUNBLENBQUNBO0lBQ2hEQSxDQUFDQTtJQUVEUixjQUFjQSxDQUFDQSxNQUFjQSxFQUFFQSxTQUFpQkE7UUFDNUNTLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLGNBQWNBLENBQUNBLE1BQU1BLEVBQUVBLFNBQVNBLENBQUNBLENBQUNBO0lBQzlEQSxDQUFDQTtJQUVEVCxTQUFTQSxDQUFDQSxJQUFZQTtRQUNsQlUsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7SUFDNUNBLENBQUNBO0lBRURWLFdBQVdBLENBQUNBLFFBQVFBO1FBQ2hCVyxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxXQUFXQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQTtJQUMzQ0EsQ0FBQ0E7SUFFRFgsY0FBY0EsQ0FBQ0EsUUFBUUE7UUFDbkJZLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLGNBQWNBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBO0lBQzlDQSxDQUFDQTtJQUVEWixjQUFjQSxDQUFDQSxJQUFJQSxFQUFFQSxNQUFjQSxFQUFFQSxTQUFpQkEsRUFBRUEsT0FBT0E7UUFDM0RhLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLGNBQWNBLENBQUNBLElBQUlBLEVBQUVBLE1BQU1BLEVBQUVBLFNBQVNBLEVBQUVBLE9BQU9BLENBQUNBLENBQUNBO0lBQzdFQSxDQUFDQTtJQUVEYixJQUFJQSxDQUFDQSxPQUFZQSxFQUFFQSxNQUFlQSxFQUFFQSxJQUFLQTtRQUNyQ2MsRUFBRUEsQ0FBQ0EsQ0FBQ0EsT0FBT0EsT0FBT0EsS0FBS0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDOUJBLE9BQU9BLEdBQUdBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLFFBQVFBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBO1FBQ2pEQSxDQUFDQTtRQUVEQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxPQUFPQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNYQSxNQUFNQSxDQUFDQSxLQUFLQSxDQUFDQTtRQUNqQkEsQ0FBQ0E7UUFFREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsSUFBSUEsTUFBTUEsQ0FBQ0EsU0FBU0EsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDbERBLE1BQU1BLENBQUNBLEtBQUtBLENBQUNBO1FBQ2pCQSxDQUFDQTtRQUVEQSxJQUFJQSxDQUFDQSxHQUFHQSxFQUFFQSxNQUFNQSxFQUFFQSxNQUFNQSxFQUFFQSxPQUFPQSxFQUFFQSxPQUFPQSxFQUFFQSxJQUFJQSxFQUFFQSxJQUFJQSxFQUFFQSxDQUFDQTtRQUN6REEsSUFBSUEsUUFBUUEsR0FBR0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsTUFBTUEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDckNBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLFdBQVdBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBO1FBRTdCQSxNQUFNQSxDQUFDQSxRQUFRQSxLQUFLQSxLQUFLQSxHQUFHQSxLQUFLQSxHQUFHQSxJQUFJQSxDQUFDQTtJQUM3Q0EsQ0FBQ0E7SUFFRGQsZUFBZUEsQ0FBQ0EsTUFBY0E7UUFDMUJlLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBO1lBQ2ZBLE1BQU1BLENBQUNBO1FBRVhBLE1BQU1BLElBQUlBLE1BQU1BLENBQUNBLEtBQUtBLENBQUNBLGNBQWNBLENBQUNBLENBQUNBO1FBQ3ZDQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNqQkEsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsR0FBR0EsRUFBRUEsQ0FBQ0E7WUFDakJBLElBQUlBLENBQUNBLG1CQUFtQkEsQ0FBQ0EsTUFBTUEsRUFBRUEsSUFBSUEsQ0FBQ0Esa0JBQWtCQSxDQUFDQSxDQUFDQTtZQUUxREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsTUFBTUEsQ0FBQ0E7Z0JBQ25CQSxJQUFJQSxDQUFDQSxLQUFLQSxHQUFHQSxJQUFJQSxDQUFDQSxRQUFRQSxDQUFDQTtZQUUvQkEsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsU0FBU0EsR0FBR0EsS0FBS0EsQ0FBQ0E7UUFDbENBLENBQUNBO1FBQ0RBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLGtCQUFrQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDM0JBLElBQUlBLENBQUNBLGtCQUFrQkEsR0FBR0EsVUFBU0EsQ0FBQ0E7Z0JBQ2hDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztZQUN6QyxDQUFDLENBQUNBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO1FBQ2pCQSxDQUFDQTtRQUVEQSxJQUFJQSxDQUFDQSxRQUFRQSxHQUFHQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQTtRQUMzQkEsSUFBSUEsQ0FBQ0EsS0FBS0EsR0FBR0EsRUFBRUEsQ0FBQ0E7UUFDaEJBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLE1BQU1BLEVBQUVBLElBQUlBLENBQUNBLGtCQUFrQkEsQ0FBQ0EsQ0FBQ0E7UUFDekNBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFNBQVNBLEdBQUdBLElBQUlBLENBQUNBO0lBQ2pDQSxDQUFDQTtJQUVEZixNQUFNQSxDQUFDQSxNQUFjQTtRQUNqQmdCLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFNBQVNBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBO1lBQzlCQSxNQUFNQSxDQUFDQTtRQUVYQSxFQUFFQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQTtZQUNmQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxlQUFlQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQTtRQUV4Q0EsSUFBSUEsQ0FBQ0E7WUFDREEsSUFBSUEsQ0FBQ0EsU0FBU0EsR0FBR0EsSUFBSUEsQ0FBQ0E7WUFDdEJBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLE9BQU9BLENBQUNBLFVBQVNBLENBQUNBO2dCQUN6QixFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsSUFBSSxRQUFRLENBQUM7b0JBQ3JCLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDO2dCQUN6QixJQUFJO29CQUNBLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN0QyxDQUFDLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO1FBQ2JBLENBQUNBO2dCQUFTQSxDQUFDQTtZQUNQQSxJQUFJQSxDQUFDQSxTQUFTQSxHQUFHQSxLQUFLQSxDQUFDQTtRQUMzQkEsQ0FBQ0E7SUFDTEEsQ0FBQ0E7SUFFRGhCLFNBQVNBLENBQUNBLENBQUNBO1FBQ1BpQixNQUFNQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxVQUFTQSxDQUFDQTtZQUNuQixFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxRQUFRLENBQUM7Z0JBQ3hCLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1lBQ3JCLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNOLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDYixNQUFNLENBQUMsQ0FBQyxDQUFDO1FBQ2IsQ0FBQyxDQUFDQSxDQUFDQTtJQUNQQSxDQUFDQTtBQUNMakIsQ0FBQ0E7QUFFRCxXQUFXLENBQUMsY0FBYyxFQUFFLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7YXBwbHlNaXhpbnN9IGZyb20gXCIuLi9saWIvbWl4XCI7XG5pbXBvcnQgSGFzaEhhbmRsZXIgZnJvbSBcIi4uL2tleWJvYXJkL0hhc2hIYW5kbGVyXCI7XG5pbXBvcnQge0V2ZW50RW1pdHRlckNsYXNzfSBmcm9tIFwiLi4vbGliL2V2ZW50X2VtaXR0ZXJcIjtcbmltcG9ydCBDb21tYW5kIGZyb20gJy4vQ29tbWFuZCc7XG5pbXBvcnQgRWRpdG9yIGZyb20gJy4uL0VkaXRvcic7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIENvbW1hbmRNYW5hZ2VyIGV4dGVuZHMgRXZlbnRFbWl0dGVyQ2xhc3MgaW1wbGVtZW50cyBIYXNoSGFuZGxlciB7XG4gICAgcHJpdmF0ZSBoYXNoSGFuZGxlcjogSGFzaEhhbmRsZXI7XG4gICAgcHJpdmF0ZSAkaW5SZXBsYXk6IGJvb2xlYW47XG4gICAgcHJpdmF0ZSByZWNvcmRpbmc6IGJvb2xlYW47XG4gICAgcHJpdmF0ZSBtYWNybzogYW55W11bXTtcbiAgICBwcml2YXRlIG9sZE1hY3JvO1xuICAgIHByaXZhdGUgJGFkZENvbW1hbmRUb01hY3JvO1xuICAgIF9idWlsZEtleUhhc2hcblxuICAgIC8qKlxuICAgICAqIEBwYXJhbSB7c3RyaW5nfSBwbGF0Zm9ybSBJZGVudGlmaWVyIGZvciB0aGUgcGxhdGZvcm07IG11c3QgYmUgZWl0aGVyIGAnbWFjJ2Agb3IgYCd3aW4nYFxuICAgICAqIEBwYXJhbSB7QXJyYXl9IGNvbW1hbmRzIEEgbGlzdCBvZiBjb21tYW5kc1xuICAgICAqL1xuICAgIGNvbnN0cnVjdG9yKHBsYXRmb3JtOiBzdHJpbmcsIGNvbW1hbmRzOiBDb21tYW5kW10pIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgdGhpcy5oYXNoSGFuZGxlciA9IG5ldyBIYXNoSGFuZGxlcihjb21tYW5kcywgcGxhdGZvcm0pXG4gICAgICAgIHRoaXMuc2V0RGVmYXVsdEhhbmRsZXIoXCJleGVjXCIsIGZ1bmN0aW9uKGU6IHsgY29tbWFuZDogQ29tbWFuZDsgZWRpdG9yOiBFZGl0b3I7IGFyZ3MgfSkge1xuICAgICAgICAgICAgcmV0dXJuIGUuY29tbWFuZC5leGVjKGUuZWRpdG9yLCBlLmFyZ3MgfHwge30pO1xuICAgICAgICB9KTtcbiAgICB9XG5cbiAgICBnZXQgcGxhdGZvcm0oKTogc3RyaW5nIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaGFzaEhhbmRsZXIucGxhdGZvcm07XG4gICAgfVxuXG4gICAgZ2V0IGNvbW1hbmRzKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNoSGFuZGxlci5jb21tYW5kcztcbiAgICB9XG5cbiAgICBnZXQgY29tbWFuZEtleUJpbmRpbmcoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmhhc2hIYW5kbGVyLmNvbW1hbmRLZXlCaW5kaW5nO1xuICAgIH1cblxuICAgIGJpbmRLZXkoa2V5OiBzdHJpbmcsIGNvbW1hbmQ6IGFueSkge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNoSGFuZGxlci5iaW5kS2V5KGtleSwgY29tbWFuZCk7XG4gICAgfVxuXG4gICAgYmluZEtleXMoa2V5TGlzdCkge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNoSGFuZGxlci5iaW5kS2V5cyhrZXlMaXN0KTtcbiAgICB9XG5cbiAgICBhZGRDb21tYW5kKGNvbW1hbmQ6IENvbW1hbmQpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5oYXNoSGFuZGxlci5hZGRDb21tYW5kKGNvbW1hbmQpO1xuICAgIH1cblxuICAgIHJlbW92ZUNvbW1hbmQoY29tbWFuZE5hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICB0aGlzLmhhc2hIYW5kbGVyLnJlbW92ZUNvbW1hbmQoY29tbWFuZE5hbWUpO1xuICAgIH1cblxuICAgIGZpbmRLZXlDb21tYW5kKGhhc2hJZDogbnVtYmVyLCBrZXlTdHJpbmc6IHN0cmluZyk6IENvbW1hbmQge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNoSGFuZGxlci5maW5kS2V5Q29tbWFuZChoYXNoSWQsIGtleVN0cmluZyk7XG4gICAgfVxuXG4gICAgcGFyc2VLZXlzKGtleXM6IHN0cmluZykge1xuICAgICAgICByZXR1cm4gdGhpcy5oYXNoSGFuZGxlci5wYXJzZUtleXMoa2V5cyk7XG4gICAgfVxuXG4gICAgYWRkQ29tbWFuZHMoY29tbWFuZHMpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5oYXNoSGFuZGxlci5hZGRDb21tYW5kcyhjb21tYW5kcyk7XG4gICAgfVxuXG4gICAgcmVtb3ZlQ29tbWFuZHMoY29tbWFuZHMpOiB2b2lkIHtcbiAgICAgICAgdGhpcy5oYXNoSGFuZGxlci5yZW1vdmVDb21tYW5kcyhjb21tYW5kcyk7XG4gICAgfVxuXG4gICAgaGFuZGxlS2V5Ym9hcmQoZGF0YSwgaGFzaElkOiBudW1iZXIsIGtleVN0cmluZzogc3RyaW5nLCBrZXlDb2RlKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmhhc2hIYW5kbGVyLmhhbmRsZUtleWJvYXJkKGRhdGEsIGhhc2hJZCwga2V5U3RyaW5nLCBrZXlDb2RlKTtcbiAgICB9XG5cbiAgICBleGVjKGNvbW1hbmQ6IGFueSwgZWRpdG9yPzogRWRpdG9yLCBhcmdzPykge1xuICAgICAgICBpZiAodHlwZW9mIGNvbW1hbmQgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICBjb21tYW5kID0gdGhpcy5oYXNoSGFuZGxlci5jb21tYW5kc1tjb21tYW5kXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICghY29tbWFuZCkge1xuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGVkaXRvciAmJiBlZGl0b3IuJHJlYWRPbmx5ICYmICFjb21tYW5kLnJlYWRPbmx5KSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cblxuICAgICAgICB2YXIgZSA9IHsgZWRpdG9yOiBlZGl0b3IsIGNvbW1hbmQ6IGNvbW1hbmQsIGFyZ3M6IGFyZ3MgfTtcbiAgICAgICAgdmFyIHJldHZhbHVlID0gdGhpcy5fZW1pdChcImV4ZWNcIiwgZSk7XG4gICAgICAgIHRoaXMuX3NpZ25hbChcImFmdGVyRXhlY1wiLCBlKTtcblxuICAgICAgICByZXR1cm4gcmV0dmFsdWUgPT09IGZhbHNlID8gZmFsc2UgOiB0cnVlO1xuICAgIH1cblxuICAgIHRvZ2dsZVJlY29yZGluZyhlZGl0b3I6IEVkaXRvcikge1xuICAgICAgICBpZiAodGhpcy4kaW5SZXBsYXkpXG4gICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgZWRpdG9yICYmIGVkaXRvci5fZW1pdChcImNoYW5nZVN0YXR1c1wiKTtcbiAgICAgICAgaWYgKHRoaXMucmVjb3JkaW5nKSB7XG4gICAgICAgICAgICB0aGlzLm1hY3JvLnBvcCgpO1xuICAgICAgICAgICAgdGhpcy5yZW1vdmVFdmVudExpc3RlbmVyKFwiZXhlY1wiLCB0aGlzLiRhZGRDb21tYW5kVG9NYWNybyk7XG5cbiAgICAgICAgICAgIGlmICghdGhpcy5tYWNyby5sZW5ndGgpXG4gICAgICAgICAgICAgICAgdGhpcy5tYWNybyA9IHRoaXMub2xkTWFjcm87XG5cbiAgICAgICAgICAgIHJldHVybiB0aGlzLnJlY29yZGluZyA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgICAgIGlmICghdGhpcy4kYWRkQ29tbWFuZFRvTWFjcm8pIHtcbiAgICAgICAgICAgIHRoaXMuJGFkZENvbW1hbmRUb01hY3JvID0gZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgICAgIHRoaXMubWFjcm8ucHVzaChbZS5jb21tYW5kLCBlLmFyZ3NdKTtcbiAgICAgICAgICAgIH0uYmluZCh0aGlzKTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMub2xkTWFjcm8gPSB0aGlzLm1hY3JvO1xuICAgICAgICB0aGlzLm1hY3JvID0gW107XG4gICAgICAgIHRoaXMub24oXCJleGVjXCIsIHRoaXMuJGFkZENvbW1hbmRUb01hY3JvKTtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVjb3JkaW5nID0gdHJ1ZTtcbiAgICB9XG5cbiAgICByZXBsYXkoZWRpdG9yOiBFZGl0b3IpIHtcbiAgICAgICAgaWYgKHRoaXMuJGluUmVwbGF5IHx8ICF0aGlzLm1hY3JvKVxuICAgICAgICAgICAgcmV0dXJuO1xuXG4gICAgICAgIGlmICh0aGlzLnJlY29yZGluZylcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnRvZ2dsZVJlY29yZGluZyhlZGl0b3IpO1xuXG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICB0aGlzLiRpblJlcGxheSA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLm1hY3JvLmZvckVhY2goZnVuY3Rpb24oeCkge1xuICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgeCA9PSBcInN0cmluZ1wiKVxuICAgICAgICAgICAgICAgICAgICB0aGlzLmV4ZWMoeCwgZWRpdG9yKTtcbiAgICAgICAgICAgICAgICBlbHNlXG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZXhlYyh4WzBdLCBlZGl0b3IsIHhbMV0pO1xuICAgICAgICAgICAgfSwgdGhpcyk7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICB0aGlzLiRpblJlcGxheSA9IGZhbHNlO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgdHJpbU1hY3JvKG0pIHtcbiAgICAgICAgcmV0dXJuIG0ubWFwKGZ1bmN0aW9uKHgpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgeFswXSAhPSBcInN0cmluZ1wiKVxuICAgICAgICAgICAgICAgIHhbMF0gPSB4WzBdLm5hbWU7XG4gICAgICAgICAgICBpZiAoIXhbMV0pXG4gICAgICAgICAgICAgICAgeCA9IHhbMF07XG4gICAgICAgICAgICByZXR1cm4geDtcbiAgICAgICAgfSk7XG4gICAgfVxufVxuXG5hcHBseU1peGlucyhDb21tYW5kTWFuYWdlciwgW0hhc2hIYW5kbGVyXSk7XG4iXX0=