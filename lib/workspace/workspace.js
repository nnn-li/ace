var wcm = require('../worker/worker_client');
var protocol = require('./workspace_protocol');
exports.workspace = function () {
    var workerProxy = new wcm.WorkerClient(['ace'], 'ace/workspace/workspace_worker', 'WorkspaceWorker');
    var callbacks = {};
    var callbackId = 1;
    workerProxy.on("initAfter", function (event) {
    });
    workerProxy.on("fileNames", function (response) {
        var data = response.data;
        var names = data.names;
        var id = data.callbackId;
        var callback = callbacks[id];
        delete callbacks[id];
        callback(null, names);
    });
    workerProxy.on("syntaxErrors", function (response) {
        var data = response.data;
        var errors = data.errors;
        var id = data.callbackId;
        var callback = callbacks[id];
        delete callbacks[id];
        callback(null, errors);
    });
    workerProxy.on("semanticErrors", function (response) {
        var data = response.data;
        var errors = data.errors;
        var id = data.callbackId;
        var callback = callbacks[id];
        delete callbacks[id];
        callback(null, errors);
    });
    workerProxy.on(protocol.EVENT_NAME_COMPLETIONS, function (response) {
        var data = response.data;
        var id = data.callbackId;
        var callback = callbacks[id];
        delete callbacks[id];
        if ('err' in data) {
            callback(data.err);
        }
        else {
            callback(null, data.completions);
        }
    });
    workerProxy.on("typeAtDocumentPosition", function (response) {
        doCallback(response.data);
    });
    workerProxy.on("outputFiles", function (response) {
        doCallback(response.data);
    });
    function doCallback(data) {
        var info = data.results;
        var id = data.callbackId;
        var callback = callbacks[id];
        delete callbacks[id];
        if (data.err) {
            callback(data.err);
        }
        else {
            callback(null, data.results);
        }
    }
    function ensureScript(fileName, content) {
        var message = {
            data: { 'fileName': fileName, 'content': content.replace(/\r\n?/g, '\n') }
        };
        workerProxy.emit("ensureScript", message);
    }
    function editScript(fileName, start, end, text) {
        var message = {
            data: { fileName: fileName, start: start, end: end, text: text }
        };
        workerProxy.emit("editScript", message);
    }
    function removeScript(fileName) {
        workerProxy.emit("removeScript", { data: { 'fileName': fileName } });
    }
    function getFileNames(callback) {
        var id = callbackId++;
        callbacks[id] = callback;
        var message = { data: { callbackId: id } };
        workerProxy.emit("getFileNames", message);
    }
    function getSyntaxErrors(fileName, callback) {
        var id = callbackId++;
        callbacks[id] = callback;
        var message = { data: { fileName: fileName, callbackId: id } };
        workerProxy.emit("getSyntaxErrors", message);
    }
    function getSemanticErrors(fileName, callback) {
        var id = callbackId++;
        callbacks[id] = callback;
        var message = { data: { fileName: fileName, callbackId: id } };
        workerProxy.emit("getSemanticErrors", message);
    }
    function getCompletionsAtPosition(fileName, position, memberMode, callback) {
        var id = callbackId++;
        callbacks[id] = callback;
        var message = { data: { fileName: fileName, position: position, memberMode: memberMode, callbackId: id } };
        workerProxy.emit("getCompletionsAtPosition", message);
    }
    function getTypeAtDocumentPosition(fileName, documentPosition, callback) {
        var id = callbackId++;
        callbacks[id] = callback;
        var message = { data: { fileName: fileName, documentPosition: documentPosition, callbackId: id } };
        workerProxy.emit("getTypeAtDocumentPosition", message);
    }
    function getOutputFiles(fileName, callback) {
        var id = callbackId++;
        callbacks[id] = callback;
        var message = { data: { fileName: fileName, callbackId: id } };
        workerProxy.emit("getOutputFiles", message);
    }
    var that = {
        ensureScript: ensureScript,
        editScript: editScript,
        removeScript: removeScript,
        getFileNames: getFileNames,
        getSyntaxErrors: getSyntaxErrors,
        getSemanticErrors: getSemanticErrors,
        getCompletionsAtPosition: getCompletionsAtPosition,
        getTypeAtDocumentPosition: getTypeAtDocumentPosition,
        getOutputFiles: getOutputFiles
    };
    return that;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoid29ya3NwYWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL3dvcmtzcGFjZS93b3Jrc3BhY2UudHMiXSwibmFtZXMiOlsiZG9DYWxsYmFjayIsImVuc3VyZVNjcmlwdCIsImVkaXRTY3JpcHQiLCJyZW1vdmVTY3JpcHQiLCJnZXRGaWxlTmFtZXMiLCJnZXRTeW50YXhFcnJvcnMiLCJnZXRTZW1hbnRpY0Vycm9ycyIsImdldENvbXBsZXRpb25zQXRQb3NpdGlvbiIsImdldFR5cGVBdERvY3VtZW50UG9zaXRpb24iLCJnZXRPdXRwdXRGaWxlcyJdLCJtYXBwaW5ncyI6IkFBQUEsSUFBTyxHQUFHLFdBQVcseUJBQXlCLENBQUMsQ0FBQztBQUNoRCxJQUFPLFFBQVEsV0FBVyxzQkFBc0IsQ0FBQyxDQUFDO0FBNER2QyxpQkFBUyxHQUFHO0lBR25CLElBQUksV0FBVyxHQUFHLElBQUksR0FBRyxDQUFDLFlBQVksQ0FBQyxDQUFDLEtBQUssQ0FBQyxFQUFFLGdDQUFnQyxFQUFFLGlCQUFpQixDQUFDLENBQUM7SUFDckcsSUFBSSxTQUFTLEdBQUcsRUFBRSxDQUFDO0lBQ25CLElBQUksVUFBVSxHQUFHLENBQUMsQ0FBQztJQUVuQixXQUFXLENBQUMsRUFBRSxDQUFDLFdBQVcsRUFBRSxVQUFTLEtBQUs7SUFHMUMsQ0FBQyxDQUFDLENBQUM7SUFFSCxXQUFXLENBQUMsRUFBRSxDQUFDLFdBQVcsRUFBRSxVQUFTLFFBQTJEO1FBQzVGLElBQUksSUFBSSxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUM7UUFDekIsSUFBSSxLQUFLLEdBQWEsSUFBSSxDQUFDLEtBQUssQ0FBQztRQUNqQyxJQUFJLEVBQUUsR0FBVyxJQUFJLENBQUMsVUFBVSxDQUFDO1FBQ2pDLElBQUksUUFBUSxHQUEyQixTQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDckQsT0FBTyxTQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7UUFDckIsUUFBUSxDQUFDLElBQUksRUFBRSxLQUFL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LHdCQUF3QjtRQUNsRCx5QkFBeUIsRUFBRSx5QkFBeUI7UUFDcEQsY0FBYyxFQUFFLGNBQWM7S0FDakMsQ0FBQztJQUNGLE1BQU0sQ0FBQyxJQUFJLENBQUM7QUFDaEIsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHdjbSA9IHJlcXVpcmUoJy4uL3dvcmtlci93b3JrZXJfY2xpZW50Jyk7XG5pbXBvcnQgcHJvdG9jb2wgPSByZXF1aXJlKCcuL3dvcmtzcGFjZV9wcm90b2NvbCcpO1xuLyoqXG4gKiBBIHdvcmtzcGFjZSBpcyBhIGNvbGxlY3Rpb24gb2Ygc291cmNlIGZpbGVzIGlkZW50aWZpZWQgYnkgbmFtZS5cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBXb3Jrc3BhY2Uge1xuXG4gICAgLyoqXG4gICAgICogSW5zZXJ0IG9yIHVwZGF0ZSBhIHNjcmlwdC5cbiAgICAgKiBUaGlzIGlzIHR5cGljYWxseSBjYWxsZWQgYnkgdGhlIGVkaXRpbmcgYXBwbGljYXRpb24uXG4gICAgICovXG4gICAgZW5zdXJlU2NyaXB0KGZpbGVOYW1lOiBzdHJpbmcsIGNvbnRlbnQ6IHN0cmluZyk6IHZvaWQ7XG5cbiAgICAvKipcbiAgICAgKiBOb3RpZnkgdGhlIHdvcmtzcGFjZSBvZiBhbiBlZGl0IHRvIGEgc2NyaXB0LlxuICAgICAqL1xuICAgIGVkaXRTY3JpcHQoZmlsZU5hbWU6IHN0cmluZywgbWluQ2hhcjogbnVtYmVyLCBsaW1DaGFyOiBudW1iZXIsIG5ld1RleHQ6IHN0cmluZyk6IHZvaWQ7XG5cbiAgICAvKipcbiAgICAgKiBSZW1vdmUgYSBzY3JpcHQuXG4gICAgICogVGhpcyBpcyB0eXBpY2FsbHkgY2FsbGVkIGJ5IHRoZSBlZGl0aW5nIGFwcGxpY2F0aW9uLlxuICAgICAqL1xuICAgIHJlbW92ZVNjcmlwdChmaWxlTmFtZTogc3RyaW5nKTogdm9pZDtcblxuICAgIC8qKlxuICAgICAqXG4gICAgICovXG4gICAgZ2V0RmlsZU5hbWVzKGNhbGxiYWNrKTogdm9pZDtcblxuICAgIC8qKlxuICAgICAqXG4gICAgICovXG4gICAgZ2V0U3ludGF4RXJyb3JzKGZpbGVOYW1lOiBzdHJpbmcsIGNhbGxiYWNrOiAoZXJyLCByZXN1bHRzKSA9PiB2b2lkKTogdm9pZDtcblxuICAgIC8qKlxuICAgICAqXG4gICAgICovXG4gICAgZ2V0U2VtYW50aWNFcnJvcnMoZmlsZU5hbWU6IHN0cmluZywgY2FsbGJhY2s6IChlcnIsIHJlc3VsdHMpID0+IHZvaWQpOiB2b2lkO1xuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKi9cbiAgICBnZXRDb21wbGV0aW9uc0F0UG9zaXRpb24oZmlsZU5hbWU6IHN0cmluZywgcG9zaXRpb246IG51bWJlciwgbWVtYmVyTW9kZTogYm9vbGVhbiwgY2FsbGJhY2s6IChlcnIsIHJlc3VsdHMpID0+IHZvaWQpOiB2b2lkO1xuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKi9cbiAgICBnZXRUeXBlQXREb2N1bWVudFBvc2l0aW9uKGZpbGVOYW1lOiBzdHJpbmcsIGRvY3VtZW50UG9zaXRpb246IHsgcm93OiBudW1iZXI7IGNvbHVtbjogbnVtYmVyIH0sIGNhbGxiYWNrOiAoZXJyLCB0eXBlSW5mbzogdHMuVHlwZSkgPT4gdm9pZCk6IHZvaWQ7XG5cbiAgICAvKipcbiAgICAgKlxuICAgICAqL1xuICAgIGdldE91dHB1dEZpbGVzKGZpbGVOYW1lOiBzdHJpbmcsIGNhbGxiYWNrOiAoZXJyLCByZXN1bHRzKSA9PiB2b2lkKTogdm9pZDtcbn1cblxuLyoqXG4gKiBAcmV0dXJuIGEgd29ya3NwYWNlIGluc3RhbmNlLlxuICogXG4gKiBUaGlzIGlzIGEgZnVuY3Rpb25hbCBjb25zdHJ1Y3RvcjsgZG8gbm90IHVzZSB0aGUgJ25ldycgb3BlcmF0b3IgdG8gY2FsbCBpdC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkbyBub3QgdXNlICd0aGlzJyBpbiB0aGUgY29kZSBiZWxvdy5cbiAqL1xuZXhwb3J0IHZhciB3b3Jrc3BhY2UgPSBmdW5jdGlvbigpIHtcblxuICAgIC8vIE4uQi4gVGhlIG1vZCBwYXJhbWV0ZXIgbXVzdCBiZSBhYnNvbHV0ZSBpbiBvcmRlciB0byB3b3JrIHdoZW4gcmVxdWlyZWpzIGlzIHVzaW5nIGluZGl2aWR1YWwgZmlsZXMuXG4gICAgdmFyIHdvcmtlclByb3h5ID0gbmV3IHdjbS5Xb3JrZXJDbGllbnQoWydhY2UnXSwgJ2FjZS93b3Jrc3BhY2Uvd29ya3NwYWNlX3dvcmtlcicsICdXb3Jrc3BhY2VXb3JrZXInKTtcbiAgICB2YXIgY2FsbGJhY2tzID0ge307XG4gICAgdmFyIGNhbGxiYWNrSWQgPSAxO1xuXG4gICAgd29ya2VyUHJveHkub24oXCJpbml0QWZ0ZXJcIiwgZnVuY3Rpb24oZXZlbnQpIHtcbiAgICAgICAgLy8gTm90IHVzaW5nIHRoaXMgY2FwYWJpbGl0eSByaWdodCBub3cuXG4gICAgICAgIC8vIFdvcmtzcGFjZVdvcmtlciBzZW5kcyB0aGlzIG5vdGlmaWNhdGlvbiB0aGF0IGNvbnN0cnVjdG9yIGZpbmlzaGVkLlxuICAgIH0pO1xuXG4gICAgd29ya2VyUHJveHkub24oXCJmaWxlTmFtZXNcIiwgZnVuY3Rpb24ocmVzcG9uc2U6IHsgZGF0YTogeyBuYW1lczogc3RyaW5nW107IGNhbGxiYWNrSWQ6IG51bWJlciB9IH0pIHtcbiAgICAgICAgdmFyIGRhdGEgPSByZXNwb25zZS5kYXRhO1xuICAgICAgICB2YXIgbmFtZXM6IHN0cmluZ1tdID0gZGF0YS5uYW1lcztcbiAgICAgICAgdmFyIGlkOiBudW1iZXIgPSBkYXRhLmNhbGxiYWNrSWQ7XG4gICAgICAgIHZhciBjYWxsYmFjazogKGVyciwgcmVzdWx0cykgPT4gdm9pZCA9IGNhbGxiYWNrc1tpZF07XG4gICAgICAgIGRlbGV0ZSBjYWxsYmFja3NbaWRdO1xuICAgICAgICBjYWxsYmFjayhudWxsLCBuYW1lcyk7XG4gICAgfSk7XG5cbiAgICB3b3JrZXJQcm94eS5vbihcInN5bnRheEVycm9yc1wiLCBmdW5jdGlvbihyZXNwb25zZTogeyBkYXRhOiB7IGVycm9yczogYW55W107IGNhbGxiYWNrSWQ6IG51bWJlciB9IH0pIHtcbiAgICAgICAgdmFyIGRhdGEgPSByZXNwb25zZS5kYXRhO1xuICAgICAgICB2YXIgZXJyb3JzID0gZGF0YS5lcnJvcnM7XG4gICAgICAgIHZhciBpZDogbnVtYmVyID0gZGF0YS5jYWxsYmFja0lkO1xuICAgICAgICB2YXIgY2FsbGJhY2s6IChlcnIsIHJlc3VsdHMpID0+IHZvaWQgPSBjYWxsYmFja3NbaWRdO1xuICAgICAgICBkZWxldGUgY2FsbGJhY2tzW2lkXTtcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgZXJyb3JzKTtcbiAgICB9KTtcblxuICAgIHdvcmtlclByb3h5Lm9uKFwic2VtYW50aWNFcnJvcnNcIiwgZnVuY3Rpb24ocmVzcG9uc2U6IHsgZGF0YTogeyBlcnJvcnM6IGFueVtdOyBjYWxsYmFja0lkOiBudW1iZXIgfSB9KSB7XG4gICAgICAgIHZhciBkYXRhID0gcmVzcG9uc2UuZGF0YTtcbiAgICAgICAgdmFyIGVycm9ycyA9IGRhdGEuZXJyb3JzO1xuICAgICAgICB2YXIgaWQ6IG51bWJlciA9IGRhdGEuY2FsbGJhY2tJZDtcbiAgICAgICAgdmFyIGNhbGxiYWNrOiAoZXJyLCByZXN1bHRzKSA9PiB2b2lkID0gY2FsbGJhY2tzW2lkXTtcbiAgICAgICAgZGVsZXRlIGNhbGxiYWNrc1tpZF07XG4gICAgICAgIGNhbGxiYWNrKG51bGwsIGVycm9ycyk7XG4gICAgfSk7XG5cbiAgICB3b3JrZXJQcm94eS5vbihwcm90b2NvbC5FVkVOVF9OQU1FX0NPTVBMRVRJT05TLCBmdW5jdGlvbihyZXNwb25zZTogeyBkYXRhOiB7IGVycjogYW55OyBjb21wbGV0aW9uczogYW55W107IGNhbGxiYWNrSWQ6IG51bWJlciB9IH0pIHtcbiAgICAgICAgLy8gVE9ETzogU3RhbmRhcmRpemUgYW5kIGludHJvZHVjZSBhc3NlcnRpb25zIGFuZCBsb2dnaW5nLlxuICAgICAgICB2YXIgZGF0YSA9IHJlc3BvbnNlLmRhdGE7XG4gICAgICAgIHZhciBpZDogbnVtYmVyID0gZGF0YS5jYWxsYmFja0lkO1xuICAgICAgICB2YXIgY2FsbGJhY2s6IChlcnIsIHJlc3VsdHM/KSA9PiB2b2lkID0gY2FsbGJhY2tzW2lkXTtcbiAgICAgICAgZGVsZXRlIGNhbGxiYWNrc1tpZF07XG4gICAgICAgIGlmICgnZXJyJyBpbiBkYXRhKSB7XG5cbiAgICAgICAgICAgIGNhbGxiYWNrKGRhdGEuZXJyKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGNhbGxiYWNrKG51bGwsIGRhdGEuY29tcGxldGlvbnMpO1xuICAgICAgICB9XG4gICAgfSk7XG5cbiAgICB3b3JrZXJQcm94eS5vbihcInR5cGVBdERvY3VtZW50UG9zaXRpb25cIiwgZnVuY3Rpb24ocmVzcG9uc2U6IHsgZGF0YTogeyBlcnI6IHN0cmluZzsgcmVzdWx0czogeyBkZXNjcmlwdGlvbjogc3RyaW5nOyBkb2NDb21tZW50OiBzdHJpbmcgfTsgY2FsbGJhY2tJZDogbnVtYmVyIH0gfSkge1xuICAgICAgICBkb0NhbGxiYWNrKHJlc3BvbnNlLmRhdGEpO1xuICAgIH0pO1xuXG4gICAgd29ya2VyUHJveHkub24oXCJvdXRwdXRGaWxlc1wiLCBmdW5jdGlvbihyZXNwb25zZTogeyBkYXRhOiB7IGVycjogc3RyaW5nOyByZXN1bHRzOiBhbnk7IGNhbGxiYWNrSWQ6IG51bWJlciB9IH0pIHtcbiAgICAgICAgZG9DYWxsYmFjayhyZXNwb25zZS5kYXRhKTtcbiAgICB9KTtcblxuICAgIGZ1bmN0aW9uIGRvQ2FsbGJhY2soZGF0YTogeyBlcnI6IHN0cmluZzsgcmVzdWx0czogYW55OyBjYWxsYmFja0lkOiBudW1iZXIgfSkge1xuICAgICAgICB2YXIgaW5mbyA9IGRhdGEucmVzdWx0cztcbiAgICAgICAgdmFyIGlkOiBudW1iZXIgPSBkYXRhLmNhbGxiYWNrSWQ7XG4gICAgICAgIHZhciBjYWxsYmFjazogKGVyciwgcmVzdWx0cz8pID0+IHZvaWQgPSBjYWxsYmFja3NbaWRdO1xuICAgICAgICBkZWxldGUgY2FsbGJhY2tzW2lkXTtcbiAgICAgICAgaWYgKGRhdGEuZXJyKSB7XG4gICAgICAgICAgICBjYWxsYmFjayhkYXRhLmVycik7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBjYWxsYmFjayhudWxsLCBkYXRhLnJlc3VsdHMpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZW5zdXJlU2NyaXB0KGZpbGVOYW1lOiBzdHJpbmcsIGNvbnRlbnQ6IHN0cmluZykge1xuICAgICAgICB2YXIgbWVzc2FnZSA9XG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgZGF0YTogeyAnZmlsZU5hbWUnOiBmaWxlTmFtZSwgJ2NvbnRlbnQnOiBjb250ZW50LnJlcGxhY2UoL1xcclxcbj8vZywgJ1xcbicpIH1cbiAgICAgICAgICAgIH07XG4gICAgICAgIHdvcmtlclByb3h5LmVtaXQoXCJlbnN1cmVTY3JpcHRcIiwgbWVzc2FnZSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZWRpdFNjcmlwdChmaWxlTmFtZTogc3RyaW5nLCBzdGFydDogbnVtYmVyLCBlbmQ6IG51bWJlciwgdGV4dDogc3RyaW5nKSB7XG4gICAgICAgIHZhciBtZXNzYWdlID1cbiAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICBkYXRhOiB7IGZpbGVOYW1lOiBmaWxlTmFtZSwgc3RhcnQ6IHN0YXJ0LCBlbmQ6IGVuZCwgdGV4dDogdGV4dCB9XG4gICAgICAgICAgICB9O1xuICAgICAgICB3b3JrZXJQcm94eS5lbWl0KFwiZWRpdFNjcmlwdFwiLCBtZXNzYWdlKTtcbiAgICB9XG5cbiAgICBmdW5jdGlvbiByZW1vdmVTY3JpcHQoZmlsZU5hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgICAgICB3b3JrZXJQcm94eS5lbWl0KFwicmVtb3ZlU2NyaXB0XCIsIHsgZGF0YTogeyAnZmlsZU5hbWUnOiBmaWxlTmFtZSB9IH0pO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGdldEZpbGVOYW1lcyhjYWxsYmFjayk6IHZvaWQge1xuICAgICAgICB2YXIgaWQgPSBjYWxsYmFja0lkKys7XG4gICAgICAgIGNhbGxiYWNrc1tpZF0gPSBjYWxsYmFjaztcbiAgICAgICAgdmFyIG1lc3NhZ2UgPSB7IGRhdGE6IHsgY2FsbGJhY2tJZDogaWQgfSB9O1xuICAgICAgICB3b3JrZXJQcm94eS5lbWl0KFwiZ2V0RmlsZU5hbWVzXCIsIG1lc3NhZ2UpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGdldFN5bnRheEVycm9ycyhmaWxlTmFtZTogc3RyaW5nLCBjYWxsYmFjazogKGVyciwgcmVzdWx0cykgPT4gdm9pZCk6IHZvaWQge1xuICAgICAgICB2YXIgaWQgPSBjYWxsYmFja0lkKys7XG4gICAgICAgIGNhbGxiYWNrc1tpZF0gPSBjYWxsYmFjaztcbiAgICAgICAgdmFyIG1lc3NhZ2UgPSB7IGRhdGE6IHsgZmlsZU5hbWU6IGZpbGVOYW1lLCBjYWxsYmFja0lkOiBpZCB9IH07XG4gICAgICAgIHdvcmtlclByb3h5LmVtaXQoXCJnZXRTeW50YXhFcnJvcnNcIiwgbWVzc2FnZSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZ2V0U2VtYW50aWNFcnJvcnMoZmlsZU5hbWU6IHN0cmluZywgY2FsbGJhY2s6IChlcnIsIHJlc3VsdHMpID0+IHZvaWQpOiB2b2lkIHtcbiAgICAgICAgdmFyIGlkID0gY2FsbGJhY2tJZCsrO1xuICAgICAgICBjYWxsYmFja3NbaWRdID0gY2FsbGJhY2s7XG4gICAgICAgIHZhciBtZXNzYWdlID0geyBkYXRhOiB7IGZpbGVOYW1lOiBmaWxlTmFtZSwgY2FsbGJhY2tJZDogaWQgfSB9O1xuICAgICAgICB3b3JrZXJQcm94eS5lbWl0KFwiZ2V0U2VtYW50aWNFcnJvcnNcIiwgbWVzc2FnZSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZ2V0Q29tcGxldGlvbnNBdFBvc2l0aW9uKGZpbGVOYW1lOiBzdHJpbmcsIHBvc2l0aW9uOiBudW1iZXIsIG1lbWJlck1vZGU6IGJvb2xlYW4sIGNhbGxiYWNrOiAoZXJyLCByZXN1bHRzKSA9PiB2b2lkKTogdm9pZCB7XG4gICAgICAgIHZhciBpZCA9IGNhbGxiYWNrSWQrKztcbiAgICAgICAgY2FsbGJhY2tzW2lkXSA9IGNhbGxiYWNrO1xuICAgICAgICB2YXIgbWVzc2FnZSA9IHsgZGF0YTogeyBmaWxlTmFtZTogZmlsZU5hbWUsIHBvc2l0aW9uOiBwb3NpdGlvbiwgbWVtYmVyTW9kZTogbWVtYmVyTW9kZSwgY2FsbGJhY2tJZDogaWQgfSB9O1xuICAgICAgICB3b3JrZXJQcm94eS5lbWl0KFwiZ2V0Q29tcGxldGlvbnNBdFBvc2l0aW9uXCIsIG1lc3NhZ2UpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGdldFR5cGVBdERvY3VtZW50UG9zaXRpb24oZmlsZU5hbWU6IHN0cmluZywgZG9jdW1lbnRQb3NpdGlvbjogeyByb3c6IG51bWJlcjsgY29sdW1uOiBudW1iZXIgfSwgY2FsbGJhY2s6IChlcnIsIHR5cGVJbmZvOiB0cy5UeXBlKSA9PiB2b2lkKTogdm9pZCB7XG4gICAgICAgIHZhciBpZCA9IGNhbGxiYWNrSWQrKztcbiAgICAgICAgY2FsbGJhY2tzW2lkXSA9IGNhbGxiYWNrO1xuICAgICAgICB2YXIgbWVzc2FnZSA9IHsgZGF0YTogeyBmaWxlTmFtZTogZmlsZU5hbWUsIGRvY3VtZW50UG9zaXRpb246IGRvY3VtZW50UG9zaXRpb24sIGNhbGxiYWNrSWQ6IGlkIH0gfTtcbiAgICAgICAgd29ya2VyUHJveHkuZW1pdChcImdldFR5cGVBdERvY3VtZW50UG9zaXRpb25cIiwgbWVzc2FnZSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZ2V0T3V0cHV0RmlsZXMoZmlsZU5hbWU6IHN0cmluZywgY2FsbGJhY2s6IChlcnIsIHJlc3VsdHMpID0+IHZvaWQpOiB2b2lkIHtcbiAgICAgICAgdmFyIGlkID0gY2FsbGJhY2tJZCsrO1xuICAgICAgICBjYWxsYmFja3NbaWRdID0gY2FsbGJhY2s7XG4gICAgICAgIHZhciBtZXNzYWdlID0geyBkYXRhOiB7IGZpbGVOYW1lOiBmaWxlTmFtZSwgY2FsbGJhY2tJZDogaWQgfSB9O1xuICAgICAgICB3b3JrZXJQcm94eS5lbWl0KFwiZ2V0T3V0cHV0RmlsZXNcIiwgbWVzc2FnZSk7XG4gICAgfVxuXG4gICAgdmFyIHRoYXQ6IFdvcmtzcGFjZSA9IHtcbiAgICAgICAgZW5zdXJlU2NyaXB0OiBlbnN1cmVTY3JpcHQsXG4gICAgICAgIGVkaXRTY3JpcHQ6IGVkaXRTY3JpcHQsXG4gICAgICAgIHJlbW92ZVNjcmlwdDogcmVtb3ZlU2NyaXB0LFxuICAgICAgICBnZXRGaWxlTmFtZXM6IGdldEZpbGVOYW1lcyxcbiAgICAgICAgZ2V0U3ludGF4RXJyb3JzOiBnZXRTeW50YXhFcnJvcnMsXG4gICAgICAgIGdldFNlbWFudGljRXJyb3JzOiBnZXRTZW1hbnRpY0Vycm9ycyxcbiAgICAgICAgZ2V0Q29tcGxldGlvbnNBdFBvc2l0aW9uOiBnZXRDb21wbGV0aW9uc0F0UG9zaXRpb24sXG4gICAgICAgIGdldFR5cGVBdERvY3VtZW50UG9zaXRpb246IGdldFR5cGVBdERvY3VtZW50UG9zaXRpb24sXG4gICAgICAgIGdldE91dHB1dEZpbGVzOiBnZXRPdXRwdXRGaWxlc1xuICAgIH07XG4gICAgcmV0dXJuIHRoYXQ7XG59O1xuIl19