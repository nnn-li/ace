import HashHandler from "./keyboard/HashHandler";
import { ListViewPopup } from "./autocomplete/popup";
import { retrievePrecedingIdentifier } from "./autocomplete/util";
import { delayedCall } from "./lib/lang";
import { snippetManager } from "./snippets";
import Range from './Range';
var EDITOR_EXT_COMPLETER = 'completer';
export function getCompleter(editor) {
    return editor[EDITOR_EXT_COMPLETER];
}
export function setCompleter(editor, completer) {
    editor[EDITOR_EXT_COMPLETER] = completer;
}
export class CompleterAggregate {
    constructor(editor) {
        this.keyboardHandler = new HashHandler();
        this.gatherCompletionsId = 0;
        this.autoSelect = true;
        this.autoInsert = true;
        this.showPopup = function (editor) {
            if (this.editor) {
                this.detach();
            }
            this.activated = true;
            this.editor = editor;
            if (getCompleter(editor) != this) {
                if (getCompleter(editor)) {
                    getCompleter(editor).detach();
                }
                setCompleter(editor, this);
            }
            editor.keyBinding.addKeyboardHandler(this.keyboardHandler);
            editor.on("changeSelection", this.changeListener);
            editor.on("blur", this.blurListener);
            editor.on("mousedown", this.mousedownListener);
            editor.on("mousewheel", this.mousewheelListener);
            this.updateCompletions();
        };
        this.editor = editor;
        this.commands = {
            "Up": function (editor) { getCompleter(editor).goTo("up"); },
            "Down": function (editor) { getCompleter(editor).goTo("down"); },
            "Ctrl-Up|Ctrl-Home": function (editor) { getCompleter(editor).goTo("start"); },
            "Ctrl-Down|Ctrl-End": function (editor) { getCompleter(editor).goTo("end"); },
            "Esc": function (editor) { getCompleter(editor).detach(); },
            "Space": function (editor) { getCompleter(editor).detach(); editor.insert(" "); },
            "Return": function (editor) { return getCompleter(editor).insertMatch(); },
            "Shift-Return": function (editor) { getCompleter(editor).insertMatch(true); },
            "Tab": function (editor) {
                var result = getCompleter(editor).insertMatch();
                if (!result && !editor['tabstopManager']) {
                    getCompleter(editor).goTo("down");
                }
                else
                    return result;
            },
            "PageUp": function (editor) { getCompleter(editor).goTo('pageUp'); },
            "PageDown": function (editor) { getCompleter(editor).goTo('pageDown'); }
        };
        this.keyboardHandler.bindKeys(this.commands);
        this.blurListener = this.blurListener.bind(this);
        this.changeListener = this.changeListener.bind(this);
        this.mousedownListener = this.mousedownListener.bind(this);
        this.mousewheelListener = this.mousewheelListener.bind(this);
        this.changeTimer = delayedCall(function () { this.updateCompletions(true); }.bind(this));
    }
    insertMatch(data) {
        if (!data) {
            data = this.popup.getData(this.popup.getRow());
        }
        if (!data) {
            return;
        }
        if (data.completer && data.completer.insertMatch) {
            data.completer.insertMatch(this.editor);
        }
        else {
            if (this.completions.filterText) {
                var ranges = this.editor.selection['getAllRanges']();
                for (var i = 0, range; range = ranges[i]; i++) {
                    range.start.column -= this.completions.filterText.length;
                    this.editor.getSession().remove(range);
                }
            }
            if (data.snippet) {
                snippetManager.insertSnippet(this.editor, data.snippet);
            }
            else {
                this.editor.execCommand("insertstring", data.value || data);
            }
        }
        this.detach();
    }
    detach() {
        this.editor.keyBinding.removeKeyboardHandler(this.keyboardHandler);
        this.editor.off("changeSelection", this.changeListener);
        this.editor.off("blur", this.blurListener);
        this.editor.off("mousedown", this.mousedownListener);
        this.editor.off("mousewheel", this.mousewheelListener);
        this.changeTimer.cancel();
        if (this.popup && this.popup.isOpen) {
            this.gatherCompletionsId += 1;
            this.popup.hide();
        }
        if (this.base)
            this.base.detach();
        this.activated = false;
        this.completions = this.base = null;
    }
    goTo(where) {
        var row = this.popup.getRow();
        var max = this.popup.getLength() - 1;
        switch (where) {
            case "up":
                row = row <= 0 ? max : row - 1;
                break;
            case "down":
                row = row >= max ? -1 : row + 1;
                break;
            case "start":
                row = 0;
                break;
            case "end":
                row = max;
                break;
        }
        this.popup.setRow(row);
    }
    getCompletions(editor, session, pos, prefix, callback) {
        this.base = session.doc.createAnchor(pos.row, pos.column - prefix.length);
        var matches = [];
        var total = editor.completers.length;
        editor.completers.forEach(function (completer, i) {
            completer.getCompletions(editor, session, pos, prefix, function (err, results) {
                if (!err)
                    matches = matches.concat(results);
                var pos = editor.getCursorPosition();
                var line = session.getLine(pos.row);
                callback(null, {
                    prefix: retrievePrecedingIdentifier(line, pos.column, results[0] && results[0].identifierRegex),
                    matches: matches,
                    finished: (--total === 0)
                });
            });
        });
        return true;
    }
    updateCompletions(keepPopupPosition) {
        var pos = this.editor.getCursorPosition();
        var prefix;
        if (keepPopupPosition && this.base && this.completions) {
            var range = new Range(this.base.row, this.base.column, pos.row, pos.column);
            prefix = this.editor.getSession().getTextRange(range);
            if (prefix == this.completions.filterText)
                return;
            this.completions.setFilter(prefix);
            if (!this.completions.filtered.length)
                return this.detach();
            if (this.completions.filtered.length == 1 && this.completions.filtered[0].value == prefix && !this.completions.filtered[0].snippet) {
                return this.detach();
            }
            this.openPopup(this.editor, prefix, keepPopupPosition);
        }
        else {
            var _id = this.gatherCompletionsId;
            var editor = this.editor;
            var session = editor.getSession();
            var line = session.getLine(pos.row);
            prefix = retrievePrecedingIdentifier(line, pos.column);
            this.getCompletions(this.editor, session, this.editor.getCursorPosition(), prefix, function (err, results) {
                var detachIfFinished = function () {
                    if (!results.finished)
                        return;
                    return this.detach();
                }.bind(this);
                var prefix = results.prefix;
                var matches = results && results.matches;
                if (!matches || !matches.length)
                    return detachIfFinished();
                if (prefix.indexOf(results.prefix) !== 0 || _id != this.gatherCompletionsId)
                    return;
                this.completions = new FilteredList(matches);
                this.completions.setFilter(prefix);
                var filtered = this.completions.filtered;
                if (!filtered.length)
                    return detachIfFinished();
                if (filtered.length == 1 && filtered[0].value == prefix && !filtered[0].snippet)
                    return detachIfFinished();
                if (this.autoInsert && filtered.length == 1)
                    return this.insertMatch(filtered[0]);
                this.openPopup(this.editor, prefix, keepPopupPosition);
            }.bind(this));
        }
    }
    openPopup(editor, prefix, keepPopupPosition) {
        if (!this.popup) {
            this.popup = new ListViewPopup(document.body || document.documentElement);
            this.popup.on("click", function (e) { this.insertMatch(); e.stop(); }.bind(this));
            this.popup.focus = this.editor.focus.bind(this.editor);
        }
        this.popup.setData(this.completions.filtered);
        this.popup.setRow(this.autoSelect ? 0 : -1);
        if (!keepPopupPosition) {
            this.popup.setTheme(editor.getTheme());
            this.popup.setFontSize(editor.getFontSize());
            var lineHeight = editor.renderer.layerConfig.lineHeight;
            var pos = editor.renderer.$cursorLayer.getPixelPosition(this.base, true);
            pos.left -= this.popup.getTextLeftOffset();
            var rect = editor.container.getBoundingClientRect();
            pos.top += rect.top - editor.renderer.layerConfig.offset;
            pos.left += rect.left - editor.renderer.scrollLeft;
            pos.left += editor.renderer.$gutterLayer.gutterWidth;
            this.popup.show(pos, lineHeight);
        }
    }
    changeListener(e) {
        var cursor = this.editor.selection.lead;
        if (cursor.row != this.base.row || cursor.column < this.base.column) {
            this.detach();
        }
        if (this.activated)
            this.changeTimer.schedule();
        else
            this.detach();
    }
    blurListener() {
        var el = document.activeElement;
        if (el != this.editor.textInput.getElement() && el.parentNode != this.popup.container) {
            this.detach();
        }
    }
    mousedownListener(e) {
        this.detach();
    }
    mousewheelListener(e) {
        this.detach();
    }
    cancelContextMenu() {
        this.editor.cancelMouseContextMenu();
    }
}
export class Autocomplete {
}
Autocomplete.startCommand = {
    name: "startAutocomplete",
    exec: function (editor) {
        var aggregate = getCompleter(editor);
        if (!aggregate) {
            aggregate = new CompleterAggregate(editor);
            setCompleter(editor, aggregate);
        }
        aggregate.autoInsert = true;
        aggregate.autoSelect = true;
        aggregate.showPopup(editor);
        aggregate.cancelContextMenu();
    },
    bindKey: "Ctrl-Space|Ctrl-Shift-Space|Alt-Space"
};
export class FilteredList {
    constructor(all, filterText, mutateData) {
        this.all = all;
        this.filtered = all;
        this.filterText = filterText || "";
    }
    setFilter(str) {
        var matches;
        if (str.length > this.filterText && str.lastIndexOf(this.filterText, 0) === 0)
            matches = this.filtered;
        else
            matches = this.all;
        this.filterText = str;
        matches = this.filterCompletions(matches, this.filterText);
        matches = matches.sort(function (a, b) {
            return b.exactMatch - a.exactMatch || b.score - a.score;
        });
        var prev = null;
        matches = matches.filter(function (item) {
            var caption = item.value || item.caption || item.snippet;
            if (caption === prev)
                return false;
            prev = caption;
            return true;
        });
        this.filtered = matches;
    }
    filterCompletions(items, needle) {
        var results = [];
        var upper = needle.toUpperCase();
        var lower = needle.toLowerCase();
        loop: for (var i = 0, length = items.length; i < length; i++) {
            var item = items[i];
            var caption = item.value || item.caption || item.snippet;
            if (!caption)
                continue;
            var lastIndex = -1;
            var matchMask = 0;
            var penalty = 0;
            var index, distance;
            for (var j = 0; j < needle.length; j++) {
                var i1 = caption.indexOf(lower[j], lastIndex + 1);
                var i2 = caption.indexOf(upper[j], lastIndex + 1);
                index = (i1 >= 0) ? ((i2 < 0 || i1 < i2) ? i1 : i2) : i2;
                if (index < 0)
                    continue loop;
                distance = index - lastIndex - 1;
                if (distance > 0) {
                    if (lastIndex === -1)
                        penalty += 10;
                    penalty += distance;
                }
                matchMask = matchMask | (1 << index);
                lastIndex = index;
            }
            item.matchMask = matchMask;
            item.exactMatch = penalty ? 0 : 1;
            item.score = (item.score || 0) - penalty;
            results.push(item);
        }
        return results;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0b2NvbXBsZXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2F1dG9jb21wbGV0ZS50cyJdLCJuYW1lcyI6WyJnZXRDb21wbGV0ZXIiLCJzZXRDb21wbGV0ZXIiLCJDb21wbGV0ZXJBZ2dyZWdhdGUiLCJDb21wbGV0ZXJBZ2dyZWdhdGUuY29uc3RydWN0b3IiLCJDb21wbGV0ZXJBZ2dyZWdhdGUuaW5zZXJ0TWF0Y2giLCJDb21wbGV0ZXJBZ2dyZWdhdGUuZGV0YWNoIiwiQ29tcGxldGVyQWdncmVnYXRlLmdvVG8iLCJDb21wbGV0ZXJBZ2dyZWdhdGUuZ2V0Q29tcGxldGlvbnMiLCJDb21wbGV0ZXJBZ2dyZWdhdGUudXBkYXRlQ29tcGxldGlvbnMiLCJDb21wbGV0ZXJBZ2dyZWdhdGUub3BlblBvcHVwIiwiQ29tcGxldGVyQWdncmVnYXRlLmNoYW5nZUxpc3RlbmVyIiwiQ29tcGxldGVyQWdncmVnYXRlLmJsdXJMaXN0ZW5lciIsIkNvbXBsZXRlckFnZ3JlZ2F0ZS5tb3VzZWRvd25MaXN0ZW5lciIsIkNvbXBsZXRlckFnZ3JlZ2F0ZS5tb3VzZXdoZWVsTGlzdGVuZXIiLCJDb21wbGV0ZXJBZ2dyZWdhdGUuY2FuY2VsQ29udGV4dE1lbnUiLCJBdXRvY29tcGxldGUiLCJGaWx0ZXJlZExpc3QiLCJGaWx0ZXJlZExpc3QuY29uc3RydWN0b3IiLCJGaWx0ZXJlZExpc3Quc2V0RmlsdGVyIiwiRmlsdGVyZWRMaXN0LmZpbHRlckNvbXBsZXRpb25zIl0sIm1hcHBpbmdzIjoiT0E4Qk8sV0FBVyxNQUFNLHdCQUF3QjtPQUN6QyxFQUFDLGFBQWEsRUFBQyxNQUFNLHNCQUFzQjtPQUMzQyxFQUFDLDJCQUEyQixFQUFDLE1BQU0scUJBQXFCO09BRXhELEVBQUMsV0FBVyxFQUFDLE1BQU0sWUFBWTtPQUMvQixFQUFDLGNBQWMsRUFBQyxNQUFNLFlBQVk7T0FJbEMsS0FBSyxNQUFNLFNBQVM7QUFFM0IsSUFBSSxvQkFBb0IsR0FBRyxXQUFXLENBQUM7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QUlBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO1FBQ3JEQSxJQUFJQSxDQUFDQSxpQkFBaUJBLEdBQUdBLElBQUlBLENBQUNBLGlCQUFpQkEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDM0RBLElBQUlBLENBQUNBLGtCQUFrQkEsR0FBR0EsSUFBSUEsQ0FBQ0Esa0JBQWtCQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUU3REEsSUFBSUEsQ0FBQ0EsV0FBV0EsR0FBR0EsV0FBV0EsQ0FBQ0EsY0FBYSxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUNBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLENBQUNBO0lBQzVGQSxDQUFDQTtJQU1NRCxXQUFXQSxDQUFDQSxJQUFLQTtRQUNwQkUsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDUkEsSUFBSUEsR0FBR0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsTUFBTUEsRUFBRUEsQ0FBQ0EsQ0FBQ0E7UUFDbkRBLENBQUNBO1FBRURBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLENBQUNBO1lBQ1JBLE1BQU1BLENBQUNBO1FBQ1hBLENBQUNBO1FBRURBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFNBQVNBLElBQUlBLElBQUlBLENBQUNBLFNBQVNBLENBQUNBLFdBQVdBLENBQUNBLENBQUNBLENBQUNBO1lBQy9DQSxJQUFJQSxDQUFDQSxTQUFTQSxDQUFDQSxXQUFXQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQTtRQUM1Q0EsQ0FBQ0E7UUFDREEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDRkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsVUFBVUEsQ0FBQ0Es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WUFDckRBLElBQUlBLEtBQUtBLEdBQUdBLElBQUlBLEtBQUtBLENBQUNBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLEdBQUdBLEVBQUVBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLEVBQUVBLEdBQUdBLENBQUNBLEdBQUdBLEVBQUVBLEdBQUdBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBO1lBQzVFQSxNQUFNQSxHQUFHQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxVQUFVQSxFQUFFQSxDQUFDQSxZQUFZQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQTtZQUN0REEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsTUFBTUEsSUFBSUEsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsVUFBVUEsQ0FBQ0E7Z0JBQ3RDQSxNQUFNQSxDQUFDQTtZQUNYQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxTQUFTQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQTtZQUNuQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsTUFBTUEsQ0FBQ0E7Z0JBQ2xDQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxFQUFFQSxDQUFDQTtZQUV6QkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsTUFBTUEsSUFBSUEsQ0FBQ0EsSUFBSUEsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsS0FBS0EsSUFBSUEsTUFBTUEsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsV0FBV0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ2pJQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxFQUFFQSxDQUFDQTtZQUN6QkEsQ0FBQ0E7WUFFREEsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEs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SUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDZEEsSUFBSUEsQ0FBQ0EsS0FBS0EsR0FBR0EsSUFBSUEsYUFBYUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsSUFBSUEsSUFBSUEsUUFBUUEsQ0FBQ0EsZUFBZUEsQ0FBQ0EsQ0FBQ0E7WUFDMUVBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLEVBQUVBLENBQUNBLE9BQU9BLEVBQUVBLFVBQVNBLENBQUNBLElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNqRkEsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsS0FBS0EsR0FBR0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7UUFDM0RBLENBQUNBO1FBRURBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLE9BQU9BLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBO1FBRTlDQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxVQUFVQSxHQUFHQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUU1Q0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsaUJBQWlCQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNyQkEsSUFBSUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsUUFBUUEsRUFBRUEsQ0FBQ0EsQ0FBQ0E7WUFDdkNBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLFdBQVdBLENBQUNBLE1BQU1BLENBQUNBLFdBQVdBLEVBQUVBLENBQUNBLENBQUNBO1lBRTdDQSxJQUFJQSxVQUFVQSxHQUFHQSxNQUFNQSxDQUFDQSxRQUFRQSxDQUFD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QUdBLE1BQU1BLEVBQUVBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO1lBQzNEQSxJQUFJQSxJQUFJQSxHQUFRQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUN6QkEsSUFBSUEsT0FBT0EsR0FBR0EsSUFBSUEsQ0FBQ0EsS0FBS0EsSUFBSUEsSUFBSUEsQ0FBQ0EsT0FBT0EsSUFBSUEsSUFBSUEsQ0FBQ0EsT0FBT0EsQ0FBQ0E7WUFDekRBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLE9BQU9BLENBQUNBO2dCQUFDQSxRQUFRQSxDQUFDQTtZQUN2QkEsSUFBSUEsU0FBU0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDbkJBLElBQUlBLFNBQVNBLEdBQUdBLENBQUNBLENBQUNBO1lBQ2xCQSxJQUFJQSxPQUFPQSxHQUFHQSxDQUFDQSxDQUFDQTtZQUNoQkEsSUFBSUEsS0FBS0EsRUFBRUEsUUFBUUEsQ0FBQ0E7WUFFcEJBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLEdBQUdBLE1BQU1BLENBQUNBLE1BQU1BLEVBQUVBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBO2dCQUVyQ0EsSUFBSUEsRUFBRUEsR0FBR0EsT0FBT0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsRUFBRUEsU0FBU0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ2xEQSxJQUFJQSxFQUFFQSxHQUFHQSxPQUFPQSxDQUFDQSxPQUFPQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxFQUFFQSxTQUFTQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDbERBLEtBQUtBLEdBQUdBLENBQUNBLEVBQUVBLElBQUlBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLEVBQUVBLEdBQUdBLENBQUNBLElBQUlBLEVBQUVBLEdBQUdBLEVBQUVBLENBQUNBLEdBQUdBLEVBQUVBLEdBQUdBLEVBQUVBLENBQUNBLEdBQUdBLEVBQUVBLENBQUNBO2dCQUN6REEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsS0FBS0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7b0JBQ1ZBLFFBQVFBLENBQUNBLElBQUlBLENBQUNBO2dCQUNsQkEsUUFBUUEsR0FBR0EsS0FBS0EsR0FBR0EsU0FBU0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ2pDQSxFQUFFQSxDQUFDQSxDQUFDQSxRQUFRQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtvQkFFZkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsU0FBU0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7d0JBQ2pCQSxPQUFPQSxJQUFJQSxFQUFFQSxDQUFDQTtvQkFDbEJBLE9BQU9BLElBQUlBLFFBQVFBLENBQUNBO2dCQUN4QkEsQ0FBQ0E7Z0JBQ0RBLFNBQVNBLEdBQUdBLFNBQVNBLEdBQUdBLENBQUNBLENBQUNBLElBQUlBLEtBQUtBLENBQUNBLENBQUNBO2dCQUNyQ0EsU0FBU0EsR0FBR0EsS0FBS0EsQ0FBQ0E7WUFDdEJBLENBQUNBO1lBQ0RBLElBQUlBLENBQUNBLFNBQVNBLEdBQUdBLFNBQVNBLENBQUNBO1lBQzNCQSxJQUFJQSxDQUFDQSxVQUFVQSxHQUFHQSxPQUFPQSxHQUFHQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQTtZQUNsQ0EsSUFBSUEsQ0FBQ0EsS0FBS0EsR0FBR0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsS0FBS0EsSUFBSUEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsT0FBT0EsQ0FBQ0E7WUFDekNBLE9BQU9BLENBQUNBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO1FBQ3ZCQSxDQUFDQTtRQUNEQSxNQUFNQSxDQUFDQSxPQUFPQSxDQUFDQTtJQUNuQkEsQ0FBQ0E7QUFDTEgsQ0FBQ0E7QUFBQSIsInNvdXJjZXNDb250ZW50IjpbIi8qICoqKioqIEJFR0lOIExJQ0VOU0UgQkxPQ0sgKioqKipcbiAqIERpc3RyaWJ1dGVkIHVuZGVyIHRoZSBCU0QgbGljZW5zZTpcbiAqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTIsIEFqYXgub3JnIEIuVi5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0XG4gKiBtb2RpZmljYXRpb24sIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMgYXJlIG1ldDpcbiAqICAgICAqIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0XG4gKiAgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuXG4gKiAgICAgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodFxuICogICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZVxuICogICAgICAgZG9jdW1lbnRhdGlvbiBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi5cbiAqICAgICAqIE5laXRoZXIgdGhlIG5hbWUgb2YgQWpheC5vcmcgQi5WLiBub3IgdGhlXG4gKiAgICAgICBuYW1lcyBvZiBpdHMgY29udHJpYnV0b3JzIG1heSBiZSB1c2VkIHRvIGVuZG9yc2Ugb3IgcHJvbW90ZSBwcm9kdWN0c1xuICogICAgICAgZGVyaXZlZCBmcm9tIHRoaXMgc29mdHdhcmUgd2l0aG91dCBzcGVjaWZpYyBwcmlvciB3cml0dGVuIHBlcm1pc3Npb24uXG4gKlxuICogVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQ09QWVJJR0hUIEhPTERFUlMgQU5EIENPTlRSSUJVVE9SUyBcIkFTIElTXCIgQU5EXG4gKiBBTlkgRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUgSU1QTElFRFxuICogV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkgQU5EIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFSRVxuICogRElTQ0xBSU1FRC4gSU4gTk8gRVZFTlQgU0hBTEwgQUpBWC5PUkcgQi5WLiBCRSBMSUFCTEUgRk9SIEFOWVxuICogRElSRUNULCBJTkRJUkVDVCwgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVNcbiAqIChJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUztcbiAqIExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORFxuICogT04gQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVCBMSUFCSUxJVFksIE9SIFRPUlRcbiAqIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFIFVTRSBPRiBUSElTXG4gKiBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS5cbiAqXG4gKiAqKioqKiBFTkQgTElDRU5TRSBCTE9DSyAqKioqKiAqL1xuXG5pbXBvcnQgSGFzaEhhbmRsZXIgZnJvbSBcIi4va2V5Ym9hcmQvSGFzaEhhbmRsZXJcIjtcbmltcG9ydCB7TGlzdFZpZXdQb3B1cH0gZnJvbSBcIi4vYXV0b2NvbXBsZXRlL3BvcHVwXCI7XG5pbXBvcnQge3JldHJpZXZlUHJlY2VkaW5nSWRlbnRpZmllcn0gZnJvbSBcIi4vYXV0b2NvbXBsZXRlL3V0aWxcIjtcbmltcG9ydCB7fSBmcm9tIFwiLi9saWIvZXZlbnRcIjtcbmltcG9ydCB7ZGVsYXllZENhbGx9IGZyb20gXCIuL2xpYi9sYW5nXCI7XG5pbXBvcnQge3NuaXBwZXRNYW5hZ2VyfSBmcm9tIFwiLi9zbmlwcGV0c1wiO1xuaW1wb3J0IEVkaXRvciBmcm9tICcuL0VkaXRvcic7XG5pbXBvcnQgRWRpdFNlc3Npb24gZnJvbSAnLi9FZGl0U2Vzc2lvbic7XG5pbXBvcnQgQW5jaG9yIGZyb20gJy4vQW5jaG9yJztcbmltcG9ydCBSYW5nZSBmcm9tICcuL1JhbmdlJztcblxudmFyIEVESVRPUl9FWFRfQ09NUExFVEVSID0gJ2NvbXBsZXRlcic7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ29tcGxldGVyIHtcbiAgICBnZXRDb21wbGV0aW9ucyhlZGl0b3I6IEVkaXRvciwgc2Vzc2lvbjogRWRpdFNlc3Npb24sIHBvczogeyByb3c6IG51bWJlcjsgY29sdW1uOiBudW1iZXIgfSwgcHJlZml4OiBzdHJpbmcsIGNhbGxiYWNrKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldENvbXBsZXRlcihlZGl0b3I6IEVkaXRvcik6IENvbXBsZXRlckFnZ3JlZ2F0ZSB7XG4gICAgcmV0dXJuIGVkaXRvcltFRElUT1JfRVhUX0NPTVBMRVRFUl07XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXRDb21wbGV0ZXIoZWRpdG9yOiBFZGl0b3IsIGNvbXBsZXRlcjogQ29tcGxldGVyQWdncmVnYXRlKSB7XG4gICAgZWRpdG9yW0VESVRPUl9FWFRfQ09NUExFVEVSXSA9IGNvbXBsZXRlcjtcbn1cblxuZXhwb3J0IGNsYXNzIENvbXBsZXRlckFnZ3JlZ2F0ZSBpbXBsZW1lbnRzIENvbXBsZXRlciB7XG4gICAgcHJpdmF0ZSBlZGl0b3I6IEVkaXRvcjtcbiAgICBwcml2YXRlIGtleWJvYXJkSGFuZGxlciA9IG5ldyBIYXNoSGFuZGxlcigpO1xuICAgIHB1YmxpYyBhY3RpdmF0ZWQ6IGJvb2xlYW47XG4gICAgcHJpdmF0ZSBjaGFuZ2VUaW1lcjtcbiAgICBwcml2YXRlIGdhdGhlckNvbXBsZXRpb25zSWQgPSAwO1xuICAgIHByaXZhdGUgYmFzZTogQW5jaG9yO1xuICAgIHByaXZhdGUgY29tcGxldGlvbnM6IHsgZmlsdGVyZWQ7IGZpbHRlclRleHQ7IHNldEZpbHRlciB9O1xuICAgIHByaXZhdGUgY29tbWFuZHM6IHsgW25hbWU6IHN0cmluZ106IChlZGl0b3I6IEVkaXRvcikgPT4gdm9pZCB9O1xuICAgIHB1YmxpYyBhdXRvU2VsZWN0ID0gdHJ1ZTtcbiAgICBwdWJsaWMgYXV0b0luc2VydCA9IHRydWU7XG4gICAgY29uc3RydWN0b3IoZWRpdG9yOiBFZGl0b3IpIHtcbiAgICAgICAgdGhpcy5lZGl0b3IgPSBlZGl0b3I7XG4gICAgICAgIHRoaXMuY29tbWFuZHMgPSB7XG4gICAgICAgICAgICBcIlVwXCI6IGZ1bmN0aW9uKGVkaXRvcjogRWRpdG9yKSB7IGdldENvbXBsZXRlcihlZGl0b3IpLmdvVG8oXCJ1cFwiKTsgfSxcbiAgICAgICAgICAgIFwiRG93blwiOiBmdW5jdGlvbihlZGl0b3I6IEVkaXRvcikgeyBnZXRDb21wbGV0ZXIoZWRpdG9yKS5nb1RvKFwiZG93blwiKTsgfSxcbiAgICAgICAgICAgIFwiQ3RybC1VcHxDdHJsLUhvbWVcIjogZnVuY3Rpb24oZWRpdG9yOiBFZGl0b3IpIHsgZ2V0Q29tcGxldGVyKGVkaXRvcikuZ29UbyhcInN0YXJ0XCIpOyB9LFxuICAgICAgICAgICAgXCJDdHJsLURvd258Q3RybC1FbmRcIjogZnVuY3Rpb24oZWRpdG9yOiBFZGl0b3IpIHsgZ2V0Q29tcGxldGVyKGVkaXRvcikuZ29UbyhcImVuZFwiKTsgfSxcblxuICAgICAgICAgICAgXCJFc2NcIjogZnVuY3Rpb24oZWRpdG9yOiBFZGl0b3IpIHsgZ2V0Q29tcGxldGVyKGVkaXRvcikuZGV0YWNoKCk7IH0sXG4gICAgICAgICAgICBcIlNwYWNlXCI6IGZ1bmN0aW9uKGVkaXRvcjogRWRpdG9yKSB7IGdldENvbXBsZXRlcihlZGl0b3IpLmRldGFjaCgpOyBlZGl0b3IuaW5zZXJ0KFwiIFwiKTsgfSxcbiAgICAgICAgICAgIFwiUmV0dXJuXCI6IGZ1bmN0aW9uKGVkaXRvcjogRWRpdG9yKSB7IHJldHVybiBnZXRDb21wbGV0ZXIoZWRpdG9yKS5pbnNlcnRNYXRjaCgpOyB9LFxuICAgICAgICAgICAgXCJTaGlmdC1SZXR1cm5cIjogZnVuY3Rpb24oZWRpdG9yOiBFZGl0b3IpIHsgZ2V0Q29tcGxldGVyKGVkaXRvcikuaW5zZXJ0TWF0Y2godHJ1ZSk7IH0sXG4gICAgICAgICAgICBcIlRhYlwiOiBmdW5jdGlvbihlZGl0b3I6IEVkaXRvcikge1xuICAgICAgICAgICAgICAgIHZhciByZXN1bHQgPSBnZXRDb21wbGV0ZXIoZWRpdG9yKS5pbnNlcnRNYXRjaCgpO1xuICAgICAgICAgICAgICAgIGlmICghcmVzdWx0ICYmICFlZGl0b3JbJ3RhYnN0b3BNYW5hZ2VyJ10pIHtcbiAgICAgICAgICAgICAgICAgICAgZ2V0Q29tcGxldGVyKGVkaXRvcikuZ29UbyhcImRvd25cIik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2VcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICAgICAgICAgIH0sXG5cbiAgICAgICAgICAgIFwiUGFnZVVwXCI6IGZ1bmN0aW9uKGVkaXRvcjogRWRpdG9yKSB7IGdldENvbXBsZXRlcihlZGl0b3IpLmdvVG8oJ3BhZ2VVcCcpOyB9LFxuICAgICAgICAgICAgXCJQYWdlRG93blwiOiBmdW5jdGlvbihlZGl0b3I6IEVkaXRvcikgeyBnZXRDb21wbGV0ZXIoZWRpdG9yKS5nb1RvKCdwYWdlRG93bicpOyB9XG4gICAgICAgIH07XG5cbiAgICAgICAgdGhpcy5rZXlib2FyZEhhbmRsZXIuYmluZEtleXModGhpcy5jb21tYW5kcyk7XG5cbiAgICAgICAgdGhpcy5ibHVyTGlzdGVuZXIgPSB0aGlzLmJsdXJMaXN0ZW5lci5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLmNoYW5nZUxpc3RlbmVyID0gdGhpcy5jaGFuZ2VMaXN0ZW5lci5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLm1vdXNlZG93bkxpc3RlbmVyID0gdGhpcy5tb3VzZWRvd25MaXN0ZW5lci5iaW5kKHRoaXMpO1xuICAgICAgICB0aGlzLm1vdXNld2hlZWxMaXN0ZW5lciA9IHRoaXMubW91c2V3aGVlbExpc3RlbmVyLmJpbmQodGhpcyk7XG5cbiAgICAgICAgdGhpcy5jaGFuZ2VUaW1lciA9IGRlbGF5ZWRDYWxsKGZ1bmN0aW9uKCkgeyB0aGlzLnVwZGF0ZUNvbXBsZXRpb25zKHRydWUpOyB9LmJpbmQodGhpcykpO1xuICAgIH1cbiAgICBwdWJsaWMgcG9wdXA6IExpc3RWaWV3UG9wdXA7XG5cbiAgICAvKipcbiAgICAgKiBJbXBsZW1lbnRhdGlvbiBvZiB0aGUgQ29tcGxldGVyIGludGVyZmFjZS5cbiAgICAgKi9cbiAgICBwdWJsaWMgaW5zZXJ0TWF0Y2goZGF0YT8pIHtcbiAgICAgICAgaWYgKCFkYXRhKSB7XG4gICAgICAgICAgICBkYXRhID0gdGhpcy5wb3B1cC5nZXREYXRhKHRoaXMucG9wdXAuZ2V0Um93KCkpO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCFkYXRhKSB7XG4gICAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICBpZiAoZGF0YS5jb21wbGV0ZXIgJiYgZGF0YS5jb21wbGV0ZXIuaW5zZXJ0TWF0Y2gpIHtcbiAgICAgICAgICAgIGRhdGEuY29tcGxldGVyLmluc2VydE1hdGNoKHRoaXMuZWRpdG9yKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIGlmICh0aGlzLmNvbXBsZXRpb25zLmZpbHRlclRleHQpIHtcbiAgICAgICAgICAgICAgICAvLyBGSVhNRTogZ2V0QWxsUmFuZ2VzIG9uIFNlbGVjdGlvbj9cbiAgICAgICAgICAgICAgICB2YXIgcmFuZ2VzOiBSYW5nZVtdID0gdGhpcy5lZGl0b3Iuc2VsZWN0aW9uWydnZXRBbGxSYW5nZXMnXSgpO1xuICAgICAgICAgICAgICAgIC8vIFRPRE86IEFzc2lnbm1lbnQgaW4gY29uZGl0aW9uYWwgZXhwcmVzc2lvbi5cbiAgICAgICAgICAgICAgICAvLyBUT0RPOiBBc3NpZ25tZW50IGluIGNvbmRpdGlvbmFsIGV4cHJlc3Npb24uXG4gICAgICAgICAgICAgICAgLy8gSXQncyBjdXRlIGJ1dCBhbHNvIG1heSBoYWx0IHByZW1hdHVyZWx5IGFuZCBzbyBoaWRlIGJ1Z3MuXG4gICAgICAgICAgICAgICAgLy8gUmVwbGFjZSBieSBsZW5ndGggdmFyaWFibGUgYW5kIHRlc3Q/XG4gICAgICAgICAgICAgICAgLy8gVXNlIGFzc2VydGlvbiB3aXRoaW4gdGhlIGxvb3AgdG8gbG9vayBmb3IgZmFsc2V5IHZhbHVlcy5cbiAgICAgICAgICAgICAgICBmb3IgKHZhciBpID0gMCwgcmFuZ2U7IHJhbmdlID0gcmFuZ2VzW2ldOyBpKyspIHtcbiAgICAgICAgICAgICAgICAgICAgcmFuZ2Uuc3RhcnQuY29sdW1uIC09IHRoaXMuY29tcGxldGlvbnMuZmlsdGVyVGV4dC5sZW5ndGg7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZWRpdG9yLmdldFNlc3Npb24oKS5yZW1vdmUocmFuZ2UpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmIChkYXRhLnNuaXBwZXQpIHtcbiAgICAgICAgICAgICAgICBzbmlwcGV0TWFuYWdlci5pbnNlcnRTbmlwcGV0KHRoaXMuZWRpdG9yLCBkYXRhLnNuaXBwZXQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdGhpcy5lZGl0b3IuZXhlY0NvbW1hbmQoXCJpbnNlcnRzdHJpbmdcIiwgZGF0YS52YWx1ZSB8fCBkYXRhKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICB0aGlzLmRldGFjaCgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEltcGxlbWVudGF0aW9uIG9mIHRoZSBDb21wbGV0ZXIgaW50ZXJmYWNlLlxuICAgICAqL1xuICAgIHB1YmxpYyBkZXRhY2goKSB7XG4gICAgICAgIHRoaXMuZWRpdG9yLmtleUJpbmRpbmcucmVtb3ZlS2V5Ym9hcmRIYW5kbGVyKHRoaXMua2V5Ym9hcmRIYW5kbGVyKTtcbiAgICAgICAgdGhpcy5lZGl0b3Iub2ZmKFwiY2hhbmdlU2VsZWN0aW9uXCIsIHRoaXMuY2hhbmdlTGlzdGVuZXIpO1xuICAgICAgICB0aGlzLmVkaXRvci5vZmYoXCJibHVyXCIsIHRoaXMuYmx1ckxpc3RlbmVyKTtcbiAgICAgICAgdGhpcy5lZGl0b3Iub2ZmKFwibW91c2Vkb3duXCIsIHRoaXMubW91c2Vkb3duTGlzdGVuZXIpO1xuICAgICAgICB0aGlzLmVkaXRvci5vZmYoXCJtb3VzZXdoZWVsXCIsIHRoaXMubW91c2V3aGVlbExpc3RlbmVyKTtcbiAgICAgICAgdGhpcy5jaGFuZ2VUaW1lci5jYW5jZWwoKTtcblxuICAgICAgICBpZiAodGhpcy5wb3B1cCAmJiB0aGlzLnBvcHVwLmlzT3Blbikge1xuICAgICAgICAgICAgdGhpcy5nYXRoZXJDb21wbGV0aW9uc0lkICs9IDE7XG4gICAgICAgICAgICB0aGlzLnBvcHVwLmhpZGUoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0aGlzLmJhc2UpXG4gICAgICAgICAgICB0aGlzLmJhc2UuZGV0YWNoKCk7XG4gICAgICAgIHRoaXMuYWN0aXZhdGVkID0gZmFsc2U7XG4gICAgICAgIHRoaXMuY29tcGxldGlvbnMgPSB0aGlzLmJhc2UgPSBudWxsO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEltcGxlbWVudGF0aW9uIG9mIHRoZSBDb21wbGV0ZXIgaW50ZXJmYWNlLlxuICAgICAqL1xuICAgIHB1YmxpYyBnb1RvKHdoZXJlOiBzdHJpbmcpIHtcbiAgICAgICAgdmFyIHJvdyA9IHRoaXMucG9wdXAuZ2V0Um93KCk7XG4gICAgICAgIHZhciBtYXggPSB0aGlzLnBvcHVwLmdldExlbmd0aCgpIC0gMTtcblxuICAgICAgICBzd2l0Y2ggKHdoZXJlKSB7XG4gICAgICAgICAgICBjYXNlIFwidXBcIjogcm93ID0gcm93IDw9IDAgPyBtYXggOiByb3cgLSAxOyBicmVhaztcbiAgICAgICAgICAgIGNhc2UgXCJkb3duXCI6IHJvdyA9IHJvdyA+PSBtYXggPyAtMSA6IHJvdyArIDE7IGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBcInN0YXJ0XCI6IHJvdyA9IDA7IGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBcImVuZFwiOiByb3cgPSBtYXg7IGJyZWFrO1xuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5wb3B1cC5zZXRSb3cocm93KTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBJbXBsZW1lbnRhdGlvbiBvZiB0aGUgQ29tcGxldGVyIGludGVyZmFjZS5cbiAgICAgKi9cbiAgICBwdWJsaWMgZ2V0Q29tcGxldGlvbnMoZWRpdG9yOiBFZGl0b3IsIHNlc3Npb246IEVkaXRTZXNzaW9uLCBwb3M6IHsgcm93OiBudW1iZXI7IGNvbHVtbjogbnVtYmVyIH0sIHByZWZpeDogc3RyaW5nLCBjYWxsYmFjaykge1xuXG4gICAgICAgIHRoaXMuYmFzZSA9IHNlc3Npb24uZG9jLmNyZWF0ZUFuY2hvcihwb3Mucm93LCBwb3MuY29sdW1uIC0gcHJlZml4Lmxlbmd0aCk7XG5cbiAgICAgICAgdmFyIG1hdGNoZXMgPSBbXTtcbiAgICAgICAgdmFyIHRvdGFsID0gZWRpdG9yLmNvbXBsZXRlcnMubGVuZ3RoO1xuICAgICAgICBlZGl0b3IuY29tcGxldGVycy5mb3JFYWNoKGZ1bmN0aW9uKGNvbXBsZXRlcjogQ29tcGxldGVyLCBpKSB7XG4gICAgICAgICAgICBjb21wbGV0ZXIuZ2V0Q29tcGxldGlvbnMoZWRpdG9yLCBzZXNzaW9uLCBwb3MsIHByZWZpeCwgZnVuY3Rpb24oZXJyLCByZXN1bHRzKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFlcnIpXG4gICAgICAgICAgICAgICAgICAgIG1hdGNoZXMgPSBtYXRjaGVzLmNvbmNhdChyZXN1bHRzKTtcbiAgICAgICAgICAgICAgICAvLyBGZXRjaCBwcmVmaXggYWdhaW4sIGJlY2F1c2UgdGhleSBtYXkgaGF2ZSBjaGFuZ2VkIGJ5IG5vd1xuICAgICAgICAgICAgICAgIHZhciBwb3M6IHsgcm93OiBudW1iZXI7IGNvbHVtbjogbnVtYmVyIH0gPSBlZGl0b3IuZ2V0Q3Vyc29yUG9zaXRpb24oKTtcbiAgICAgICAgICAgICAgICB2YXIgbGluZSA9IHNlc3Npb24uZ2V0TGluZShwb3Mucm93KTtcbiAgICAgICAgICAgICAgICBjYWxsYmFjayhudWxsLCB7XG4gICAgICAgICAgICAgICAgICAgIHByZWZpeDogcmV0cmlldmVQcmVjZWRpbmdJZGVudGlmaWVyKGxpbmUsIHBvcy5jb2x1bW4sIHJlc3VsdHNbMF0gJiYgcmVzdWx0c1swXS5pZGVudGlmaWVyUmVnZXgpLFxuICAgICAgICAgICAgICAgICAgICBtYXRjaGVzOiBtYXRjaGVzLFxuICAgICAgICAgICAgICAgICAgICBmaW5pc2hlZDogKC0tdG90YWwgPT09IDApXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIHByaXZhdGUgdXBkYXRlQ29tcGxldGlvbnMoa2VlcFBvcHVwUG9zaXRpb246IGJvb2xlYW4pOiB2b2lkIHtcbiAgICAgICAgdmFyIHBvcyA9IHRoaXMuZWRpdG9yLmdldEN1cnNvclBvc2l0aW9uKCk7XG4gICAgICAgIHZhciBwcmVmaXg6IHN0cmluZztcbiAgICAgICAgaWYgKGtlZXBQb3B1cFBvc2l0aW9uICYmIHRoaXMuYmFzZSAmJiB0aGlzLmNvbXBsZXRpb25zKSB7XG4gICAgICAgICAgICB2YXIgcmFuZ2UgPSBuZXcgUmFuZ2UodGhpcy5iYXNlLnJvdywgdGhpcy5iYXNlLmNvbHVtbiwgcG9zLnJvdywgcG9zLmNvbHVtbik7XG4gICAgICAgICAgICBwcmVmaXggPSB0aGlzLmVkaXRvci5nZXRTZXNzaW9uKCkuZ2V0VGV4dFJhbmdlKHJhbmdlKTtcbiAgICAgICAgICAgIGlmIChwcmVmaXggPT0gdGhpcy5jb21wbGV0aW9ucy5maWx0ZXJUZXh0KVxuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIHRoaXMuY29tcGxldGlvbnMuc2V0RmlsdGVyKHByZWZpeCk7XG4gICAgICAgICAgICBpZiAoIXRoaXMuY29tcGxldGlvbnMuZmlsdGVyZWQubGVuZ3RoKVxuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmRldGFjaCgpO1xuXG4gICAgICAgICAgICBpZiAodGhpcy5jb21wbGV0aW9ucy5maWx0ZXJlZC5sZW5ndGggPT0gMSAmJiB0aGlzLmNvbXBsZXRpb25zLmZpbHRlcmVkWzBdLnZhbHVlID09IHByZWZpeCAmJiAhdGhpcy5jb21wbGV0aW9ucy5maWx0ZXJlZFswXS5zbmlwcGV0KSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZGV0YWNoKCk7XG4gICAgICAgICAgICB9XG5cbiAgICAgICAgICAgIHRoaXMub3BlblBvcHVwKHRoaXMuZWRpdG9yLCBwcmVmaXgsIGtlZXBQb3B1cFBvc2l0aW9uKTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIC8vIFNhdmUgY3VycmVudCBnYXRoZXJDb21wbGV0aW9ucyBzZXNzaW9uLCBzZXNzaW9uIGlzIGNsb3NlIHdoZW4gYSBtYXRjaCBpcyBpbnNlcnRcbiAgICAgICAgICAgIHZhciBfaWQgPSB0aGlzLmdhdGhlckNvbXBsZXRpb25zSWQ7XG4gICAgICAgICAgICB2YXIgZWRpdG9yID0gdGhpcy5lZGl0b3I7XG4gICAgICAgICAgICB2YXIgc2Vzc2lvbiA9IGVkaXRvci5nZXRTZXNzaW9uKCk7XG4gICAgICAgICAgICB2YXIgbGluZSA9IHNlc3Npb24uZ2V0TGluZShwb3Mucm93KTtcbiAgICAgICAgICAgIHByZWZpeCA9IHJldHJpZXZlUHJlY2VkaW5nSWRlbnRpZmllcihsaW5lLCBwb3MuY29sdW1uKTtcbiAgICAgICAgICAgIHRoaXMuZ2V0Q29tcGxldGlvbnModGhpcy5lZGl0b3IsIHNlc3Npb24sIHRoaXMuZWRpdG9yLmdldEN1cnNvclBvc2l0aW9uKCksIHByZWZpeCwgZnVuY3Rpb24oZXJyLCByZXN1bHRzKSB7XG4gICAgICAgICAgICAgICAgLy8gT25seSBkZXRhY2ggaWYgcmVzdWx0IGdhdGhlcmluZyBpcyBmaW5pc2hlZFxuICAgICAgICAgICAgICAgIHZhciBkZXRhY2hJZkZpbmlzaGVkID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgICAgIGlmICghcmVzdWx0cy5maW5pc2hlZCkgcmV0dXJuO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5kZXRhY2goKTtcbiAgICAgICAgICAgICAgICB9LmJpbmQodGhpcyk7XG5cbiAgICAgICAgICAgICAgICB2YXIgcHJlZml4ID0gcmVzdWx0cy5wcmVmaXg7XG4gICAgICAgICAgICAgICAgdmFyIG1hdGNoZXMgPSByZXN1bHRzICYmIHJlc3VsdHMubWF0Y2hlcztcblxuICAgICAgICAgICAgICAgIGlmICghbWF0Y2hlcyB8fCAhbWF0Y2hlcy5sZW5ndGgpXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBkZXRhY2hJZkZpbmlzaGVkKCk7XG4gICAgXG4gICAgICAgICAgICAgICAgLy8gV3JvbmcgcHJlZml4IG9yIHdyb25nIHNlc3Npb24gLT4gaWdub3JlXG4gICAgICAgICAgICAgICAgaWYgKHByZWZpeC5pbmRleE9mKHJlc3VsdHMucHJlZml4KSAhPT0gMCB8fCBfaWQgIT0gdGhpcy5nYXRoZXJDb21wbGV0aW9uc0lkKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG5cbiAgICAgICAgICAgICAgICB0aGlzLmNvbXBsZXRpb25zID0gbmV3IEZpbHRlcmVkTGlzdChtYXRjaGVzKTtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbXBsZXRpb25zLnNldEZpbHRlcihwcmVmaXgpO1xuICAgICAgICAgICAgICAgIHZhciBmaWx0ZXJlZCA9IHRoaXMuY29tcGxldGlvbnMuZmlsdGVyZWQ7XG4gICAgXG4gICAgICAgICAgICAgICAgLy8gTm8gcmVzdWx0c1xuICAgICAgICAgICAgICAgIGlmICghZmlsdGVyZWQubGVuZ3RoKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGV0YWNoSWZGaW5pc2hlZCgpO1xuICAgIFxuICAgICAgICAgICAgICAgIC8vIE9uZSByZXN1bHQgZXF1YWxzIHRvIHRoZSBwcmVmaXhcbiAgICAgICAgICAgICAgICBpZiAoZmlsdGVyZWQubGVuZ3RoID09IDEgJiYgZmlsdGVyZWRbMF0udmFsdWUgPT0gcHJlZml4ICYmICFmaWx0ZXJlZFswXS5zbmlwcGV0KVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGV0YWNoSWZGaW5pc2hlZCgpO1xuICAgIFxuICAgICAgICAgICAgICAgIC8vIEF1dG9pbnNlcnQgaWYgb25lIHJlc3VsdFxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmF1dG9JbnNlcnQgJiYgZmlsdGVyZWQubGVuZ3RoID09IDEpXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmluc2VydE1hdGNoKGZpbHRlcmVkWzBdKTtcblxuICAgICAgICAgICAgICAgIHRoaXMub3BlblBvcHVwKHRoaXMuZWRpdG9yLCBwcmVmaXgsIGtlZXBQb3B1cFBvc2l0aW9uKTtcbiAgICAgICAgICAgIH0uYmluZCh0aGlzKSk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIG9wZW5Qb3B1cChlZGl0b3I6IEVkaXRvciwgcHJlZml4OiBzdHJpbmcsIGtlZXBQb3B1cFBvc2l0aW9uOiBib29sZWFuKSB7XG4gICAgICAgIGlmICghdGhpcy5wb3B1cCkge1xuICAgICAgICAgICAgdGhpcy5wb3B1cCA9IG5ldyBMaXN0Vmlld1BvcHVwKGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KTtcbiAgICAgICAgICAgIHRoaXMucG9wdXAub24oXCJjbGlja1wiLCBmdW5jdGlvbihlKSB7IHRoaXMuaW5zZXJ0TWF0Y2goKTsgZS5zdG9wKCk7IH0uYmluZCh0aGlzKSk7XG4gICAgICAgICAgICB0aGlzLnBvcHVwLmZvY3VzID0gdGhpcy5lZGl0b3IuZm9jdXMuYmluZCh0aGlzLmVkaXRvcik7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLnBvcHVwLnNldERhdGEodGhpcy5jb21wbGV0aW9ucy5maWx0ZXJlZCk7XG5cbiAgICAgICAgdGhpcy5wb3B1cC5zZXRSb3codGhpcy5hdXRvU2VsZWN0ID8gMCA6IC0xKTtcblxuICAgICAgICBpZiAoIWtlZXBQb3B1cFBvc2l0aW9uKSB7XG4gICAgICAgICAgICB0aGlzLnBvcHVwLnNldFRoZW1lKGVkaXRvci5nZXRUaGVtZSgpKTtcbiAgICAgICAgICAgIHRoaXMucG9wdXAuc2V0Rm9udFNpemUoZWRpdG9yLmdldEZvbnRTaXplKCkpO1xuXG4gICAgICAgICAgICB2YXIgbGluZUhlaWdodCA9IGVkaXRvci5yZW5kZXJlci5sYXllckNvbmZpZy5saW5lSGVpZ2h0O1xuXG4gICAgICAgICAgICB2YXIgcG9zOiB7IGxlZnQ6IG51bWJlcjsgdG9wOiBudW1iZXIgfSA9IGVkaXRvci5yZW5kZXJlci4kY3Vyc29yTGF5ZXIuZ2V0UGl4ZWxQb3NpdGlvbih0aGlzLmJhc2UsIHRydWUpO1xuICAgICAgICAgICAgcG9zLmxlZnQgLT0gdGhpcy5wb3B1cC5nZXRUZXh0TGVmdE9mZnNldCgpO1xuXG4gICAgICAgICAgICB2YXIgcmVjdCA9IGVkaXRvci5jb250YWluZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgICAgICAgICBwb3MudG9wICs9IHJlY3QudG9wIC0gZWRpdG9yLnJlbmRlcmVyLmxheWVyQ29uZmlnLm9mZnNldDtcbiAgICAgICAgICAgIHBvcy5sZWZ0ICs9IHJlY3QubGVmdCAtIGVkaXRvci5yZW5kZXJlci5zY3JvbGxMZWZ0O1xuICAgICAgICAgICAgcG9zLmxlZnQgKz0gZWRpdG9yLnJlbmRlcmVyLiRndXR0ZXJMYXllci5ndXR0ZXJXaWR0aDtcblxuICAgICAgICAgICAgdGhpcy5wb3B1cC5zaG93KHBvcywgbGluZUhlaWdodCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBwcml2YXRlIGNoYW5nZUxpc3RlbmVyKGUpIHtcbiAgICAgICAgdmFyIGN1cnNvciA9IHRoaXMuZWRpdG9yLnNlbGVjdGlvbi5sZWFkO1xuICAgICAgICBpZiAoY3Vyc29yLnJvdyAhPSB0aGlzLmJhc2Uucm93IHx8IGN1cnNvci5jb2x1bW4gPCB0aGlzLmJhc2UuY29sdW1uKSB7XG4gICAgICAgICAgICB0aGlzLmRldGFjaCgpO1xuICAgICAgICB9XG4gICAgICAgIGlmICh0aGlzLmFjdGl2YXRlZClcbiAgICAgICAgICAgIHRoaXMuY2hhbmdlVGltZXIuc2NoZWR1bGUoKTtcbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgdGhpcy5kZXRhY2goKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGJsdXJMaXN0ZW5lcigpIHtcbiAgICAgICAgLy8gd2UgaGF2ZSB0byBjaGVjayBpZiBhY3RpdmVFbGVtZW50IGlzIGEgY2hpbGQgb2YgcG9wdXAgYmVjYXVzZVxuICAgICAgICAvLyBvbiBJRSBwcmV2ZW50RGVmYXVsdCBkb2Vzbid0IHN0b3Agc2Nyb2xsYmFyIGZyb20gYmVpbmcgZm9jdXNzZWRcbiAgICAgICAgdmFyIGVsID0gZG9jdW1lbnQuYWN0aXZlRWxlbWVudDtcbiAgICAgICAgaWYgKGVsICE9IHRoaXMuZWRpdG9yLnRleHRJbnB1dC5nZXRFbGVtZW50KCkgJiYgZWwucGFyZW50Tm9kZSAhPSB0aGlzLnBvcHVwLmNvbnRhaW5lcikge1xuICAgICAgICAgICAgdGhpcy5kZXRhY2goKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHByaXZhdGUgbW91c2Vkb3duTGlzdGVuZXIoZSkge1xuICAgICAgICB0aGlzLmRldGFjaCgpO1xuICAgIH1cblxuICAgIHByaXZhdGUgbW91c2V3aGVlbExpc3RlbmVyKGUpIHtcbiAgICAgICAgdGhpcy5kZXRhY2goKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgc2hvd1BvcHVwID0gZnVuY3Rpb24oZWRpdG9yOiBFZGl0b3IpIHtcblxuICAgICAgICBpZiAodGhpcy5lZGl0b3IpIHtcbiAgICAgICAgICAgIHRoaXMuZGV0YWNoKCk7XG4gICAgICAgIH1cblxuICAgICAgICB0aGlzLmFjdGl2YXRlZCA9IHRydWU7XG5cbiAgICAgICAgdGhpcy5lZGl0b3IgPSBlZGl0b3I7XG5cbiAgICAgICAgaWYgKGdldENvbXBsZXRlcihlZGl0b3IpICE9IHRoaXMpIHtcbiAgICAgICAgICAgIGlmIChnZXRDb21wbGV0ZXIoZWRpdG9yKSkge1xuICAgICAgICAgICAgICAgIGdldENvbXBsZXRlcihlZGl0b3IpLmRldGFjaCgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgc2V0Q29tcGxldGVyKGVkaXRvciwgdGhpcyk7XG4gICAgICAgIH1cblxuICAgICAgICBlZGl0b3Iua2V5QmluZGluZy5hZGRLZXlib2FyZEhhbmRsZXIodGhpcy5rZXlib2FyZEhhbmRsZXIpO1xuICAgICAgICBlZGl0b3Iub24oXCJjaGFuZ2VTZWxlY3Rpb25cIiwgdGhpcy5jaGFuZ2VMaXN0ZW5lcik7XG4gICAgICAgIGVkaXRvci5vbihcImJsdXJcIiwgdGhpcy5ibHVyTGlzdGVuZXIpO1xuICAgICAgICBlZGl0b3Iub24oXCJtb3VzZWRvd25cIiwgdGhpcy5tb3VzZWRvd25MaXN0ZW5lcik7XG4gICAgICAgIGVkaXRvci5vbihcIm1vdXNld2hlZWxcIiwgdGhpcy5tb3VzZXdoZWVsTGlzdGVuZXIpO1xuXG4gICAgICAgIHRoaXMudXBkYXRlQ29tcGxldGlvbnMoKTtcbiAgICB9XG4gICAgcHVibGljIGNhbmNlbENvbnRleHRNZW51KCkge1xuICAgICAgICB0aGlzLmVkaXRvci5jYW5jZWxNb3VzZUNvbnRleHRNZW51KCk7XG4gICAgfVxufVxuXG4vLyBUT0RPOiBTaG91bGQgd2UgaW1wbGVtZW50IENvbXBsZXRlciBvciBpcyBpdCByZWFsbHkganVzdCBpbXBsZW1lbnRhdGlvbj9cbmV4cG9ydCBjbGFzcyBBdXRvY29tcGxldGUge1xuICAgIHN0YXRpYyBzdGFydENvbW1hbmQgPSB7XG4gICAgICAgIG5hbWU6IFwic3RhcnRBdXRvY29tcGxldGVcIixcbiAgICAgICAgZXhlYzogZnVuY3Rpb24oZWRpdG9yOiBFZGl0b3IpIHtcbiAgICAgICAgICAgIHZhciBhZ2dyZWdhdGU6IENvbXBsZXRlckFnZ3JlZ2F0ZSA9IGdldENvbXBsZXRlcihlZGl0b3IpO1xuICAgICAgICAgICAgaWYgKCFhZ2dyZWdhdGUpIHtcbiAgICAgICAgICAgICAgICBhZ2dyZWdhdGUgPSBuZXcgQ29tcGxldGVyQWdncmVnYXRlKGVkaXRvcik7XG4gICAgICAgICAgICAgICAgc2V0Q29tcGxldGVyKGVkaXRvciwgYWdncmVnYXRlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGFnZ3JlZ2F0ZS5hdXRvSW5zZXJ0ID0gdHJ1ZTtcbiAgICAgICAgICAgIGFnZ3JlZ2F0ZS5hdXRvU2VsZWN0ID0gdHJ1ZTtcbiAgICAgICAgICAgIGFnZ3JlZ2F0ZS5zaG93UG9wdXAoZWRpdG9yKTtcbiAgICAgICAgICAgIC8vIG5lZWRlZCBmb3IgZmlyZWZveCBvbiBtYWNcbiAgICAgICAgICAgIGFnZ3JlZ2F0ZS5jYW5jZWxDb250ZXh0TWVudSgpO1xuICAgICAgICB9LFxuICAgICAgICBiaW5kS2V5OiBcIkN0cmwtU3BhY2V8Q3RybC1TaGlmdC1TcGFjZXxBbHQtU3BhY2VcIlxuICAgIH07XG59XG5cbmV4cG9ydCBjbGFzcyBGaWx0ZXJlZExpc3Qge1xuICAgIHByaXZhdGUgYWxsO1xuICAgIHByaXZhdGUgZmlsdGVyZWQ7XG4gICAgcHJpdmF0ZSBmaWx0ZXJUZXh0OiBzdHJpbmc7XG4gICAgY29uc3RydWN0b3IoYWxsLCBmaWx0ZXJUZXh0Pzogc3RyaW5nLCBtdXRhdGVEYXRhPykge1xuICAgICAgICB0aGlzLmFsbCA9IGFsbDtcbiAgICAgICAgdGhpcy5maWx0ZXJlZCA9IGFsbDtcbiAgICAgICAgdGhpcy5maWx0ZXJUZXh0ID0gZmlsdGVyVGV4dCB8fCBcIlwiO1xuICAgIH1cbiAgICBwcml2YXRlIHNldEZpbHRlcihzdHIpIHtcbiAgICAgICAgdmFyIG1hdGNoZXM7XG4gICAgICAgIGlmIChzdHIubGVuZ3RoID4gdGhpcy5maWx0ZXJUZXh0ICYmIHN0ci5sYXN0SW5kZXhPZih0aGlzLmZpbHRlclRleHQsIDApID09PSAwKVxuICAgICAgICAgICAgbWF0Y2hlcyA9IHRoaXMuZmlsdGVyZWQ7XG4gICAgICAgIGVsc2VcbiAgICAgICAgICAgIG1hdGNoZXMgPSB0aGlzLmFsbDtcblxuICAgICAgICB0aGlzLmZpbHRlclRleHQgPSBzdHI7XG4gICAgICAgIG1hdGNoZXMgPSB0aGlzLmZpbHRlckNvbXBsZXRpb25zKG1hdGNoZXMsIHRoaXMuZmlsdGVyVGV4dCk7XG4gICAgICAgIG1hdGNoZXMgPSBtYXRjaGVzLnNvcnQoZnVuY3Rpb24oYSwgYikge1xuICAgICAgICAgICAgcmV0dXJuIGIuZXhhY3RNYXRjaCAtIGEuZXhhY3RNYXRjaCB8fCBiLnNjb3JlIC0gYS5zY29yZTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgLy8gbWFrZSB1bmlxdWVcbiAgICAgICAgdmFyIHByZXYgPSBudWxsO1xuICAgICAgICBtYXRjaGVzID0gbWF0Y2hlcy5maWx0ZXIoZnVuY3Rpb24oaXRlbSkge1xuICAgICAgICAgICAgdmFyIGNhcHRpb24gPSBpdGVtLnZhbHVlIHx8IGl0ZW0uY2FwdGlvbiB8fCBpdGVtLnNuaXBwZXQ7XG4gICAgICAgICAgICBpZiAoY2FwdGlvbiA9PT0gcHJldikgcmV0dXJuIGZhbHNlO1xuICAgICAgICAgICAgcHJldiA9IGNhcHRpb247XG4gICAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgdGhpcy5maWx0ZXJlZCA9IG1hdGNoZXM7XG4gICAgfVxuICAgIHByaXZhdGUgZmlsdGVyQ29tcGxldGlvbnMoaXRlbXM6IHsgY2FwdGlvbjsgdmFsdWU7IHNuaXBwZXQgfVtdLCBuZWVkbGU6IHN0cmluZykge1xuICAgICAgICB2YXIgcmVzdWx0cyA9IFtdO1xuICAgICAgICB2YXIgdXBwZXIgPSBuZWVkbGUudG9VcHBlckNhc2UoKTtcbiAgICAgICAgdmFyIGxvd2VyID0gbmVlZGxlLnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIC8vIFRPRE86IEFzc2lnbm1lbnQgaW4gY29uZGl0aW9uYWwgZXhwcmVzc2lvbi5cbiAgICAgICAgLy8gSXQncyBjdXRlIGJ1dCBhbHNvIG1heSBoYWx0IHByZW1hdHVyZWx5IGFuZCBzbyBoaWRlIGJ1Z3MuXG4gICAgICAgIC8vIFJlcGxhY2UgYnkgbGVuZ3RoIHZhcmlhYmxlIGFuZCB0ZXN0P1xuICAgICAgICAvLyBVc2UgYXNzZXJ0aW9uIHdpdGhpbiB0aGUgbG9vcCB0byBsb29rIGZvciBmYWxzZXkgdmFsdWVzLlxuICAgICAgICBsb29wOiBmb3IgKHZhciBpID0gMCwgbGVuZ3RoID0gaXRlbXMubGVuZ3RoOyBpIDwgbGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgIHZhciBpdGVtOiBhbnkgPSBpdGVtc1tpXTtcbiAgICAgICAgICAgIHZhciBjYXB0aW9uID0gaXRlbS52YWx1ZSB8fCBpdGVtLmNhcHRpb24gfHwgaXRlbS5zbmlwcGV0O1xuICAgICAgICAgICAgaWYgKCFjYXB0aW9uKSBjb250aW51ZTtcbiAgICAgICAgICAgIHZhciBsYXN0SW5kZXggPSAtMTtcbiAgICAgICAgICAgIHZhciBtYXRjaE1hc2sgPSAwO1xuICAgICAgICAgICAgdmFyIHBlbmFsdHkgPSAwO1xuICAgICAgICAgICAgdmFyIGluZGV4LCBkaXN0YW5jZTtcbiAgICAgICAgICAgIC8vIGNhcHRpb24gY2hhciBpdGVyYXRpb24gaXMgZmFzdGVyIGluIENocm9tZSBidXQgc2xvd2VyIGluIEZpcmVmb3gsIHNvIGxldHMgdXNlIGluZGV4T2ZcbiAgICAgICAgICAgIGZvciAodmFyIGogPSAwOyBqIDwgbmVlZGxlLmxlbmd0aDsgaisrKSB7XG4gICAgICAgICAgICAgICAgLy8gVE9ETyBhZGQgcGVuYWx0eSBvbiBjYXNlIG1pc21hdGNoXG4gICAgICAgICAgICAgICAgdmFyIGkxID0gY2FwdGlvbi5pbmRleE9mKGxvd2VyW2pdLCBsYXN0SW5kZXggKyAxKTtcbiAgICAgICAgICAgICAgICB2YXIgaTIgPSBjYXB0aW9uLmluZGV4T2YodXBwZXJbal0sIGxhc3RJbmRleCArIDEpO1xuICAgICAgICAgICAgICAgIGluZGV4ID0gKGkxID49IDApID8gKChpMiA8IDAgfHwgaTEgPCBpMikgPyBpMSA6IGkyKSA6IGkyO1xuICAgICAgICAgICAgICAgIGlmIChpbmRleCA8IDApXG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlIGxvb3A7XG4gICAgICAgICAgICAgICAgZGlzdGFuY2UgPSBpbmRleCAtIGxhc3RJbmRleCAtIDE7XG4gICAgICAgICAgICAgICAgaWYgKGRpc3RhbmNlID4gMCkge1xuICAgICAgICAgICAgICAgICAgICAvLyBmaXJzdCBjaGFyIG1pc21hdGNoIHNob3VsZCBiZSBtb3JlIHNlbnNpdGl2ZVxuICAgICAgICAgICAgICAgICAgICBpZiAobGFzdEluZGV4ID09PSAtMSlcbiAgICAgICAgICAgICAgICAgICAgICAgIHBlbmFsdHkgKz0gMTA7XG4gICAgICAgICAgICAgICAgICAgIHBlbmFsdHkgKz0gZGlzdGFuY2U7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIG1hdGNoTWFzayA9IG1hdGNoTWFzayB8ICgxIDw8IGluZGV4KTtcbiAgICAgICAgICAgICAgICBsYXN0SW5kZXggPSBpbmRleDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGl0ZW0ubWF0Y2hNYXNrID0gbWF0Y2hNYXNrO1xuICAgICAgICAgICAgaXRlbS5leGFjdE1hdGNoID0gcGVuYWx0eSA/IDAgOiAxO1xuICAgICAgICAgICAgaXRlbS5zY29yZSA9IChpdGVtLnNjb3JlIHx8IDApIC0gcGVuYWx0eTtcbiAgICAgICAgICAgIHJlc3VsdHMucHVzaChpdGVtKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gcmVzdWx0cztcbiAgICB9XG59XG4iXX0=