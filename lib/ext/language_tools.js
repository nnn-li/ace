import { snippetManager } from "../snippets";
import { getCompleter, setCompleter, CompleterAggregate, Autocomplete } from "../autocomplete";
import { defineOptions, loadModule } from "../config";
import { retrievePrecedingIdentifier } from "../autocomplete/util";
import Editor from "../Editor";
export var keyWordCompleter = {
    getCompletions: function (editor, session, pos, prefix, callback) {
        var state = editor.session.getState(pos.row);
        var completions = session.$mode.getCompletions(state, session, pos, prefix);
        callback(null, completions);
    }
};
export var snippetCompleter = {
    getCompletions: function (editor, session, pos, prefix, callback) {
        var snippetMap = snippetManager.snippetMap;
        var completions = [];
        snippetManager.getActiveScopes(editor).forEach(function (scope) {
            var snippets = snippetMap[scope] || [];
            for (var i = snippets.length; i--;) {
                var s = snippets[i];
                var caption = s.name || s.tabTrigger;
                if (!caption)
                    continue;
                completions.push({
                    caption: caption,
                    snippet: s.content,
                    meta: s.tabTrigger && !s.name ? s.tabTrigger + "\u21E5 " : "snippet"
                });
            }
        }, this);
        callback(null, completions);
    }
};
var completers = [snippetCompleter, keyWordCompleter];
export function addCompleter(completer) {
    completers.push(completer);
}
;
var expandSnippet = {
    name: 'expandSnippet',
    exec: function (editor) {
        var success = snippetManager.expandWithTab(editor);
        if (!success) {
            editor.execCommand('indent');
        }
    },
    bindKey: 'Tab'
};
var onChangeMode = function (e, editor) {
    loadSnippetsForMode(editor.session.$mode);
};
var loadSnippetsForMode = function (mode) {
    var id = mode.$id;
    if (!snippetManager['files']) {
        snippetManager['files'] = {};
    }
    loadSnippetFile(id);
    if (mode.modes) {
        mode.modes.forEach(loadSnippetsForMode);
    }
};
var loadSnippetFile = function (id) {
    if (!id || snippetManager['files'][id])
        return;
    var snippetFilePath = id.replace("mode", "snippets");
    snippetManager['files'][id] = {};
    loadModule(snippetFilePath, function (m) {
        if (m) {
            snippetManager['files'][id] = m;
            if (!m.snippets && m.snippetText)
                m.snippets = snippetManager.parseSnippetFile(m.snippetText);
            snippetManager.register(m.snippets || [], m.scope);
            if (m.includeScopes) {
                snippetManager.snippetMap[m.scope].includeScopes = m.includeScopes;
                m.includeScopes.forEach(function (x) {
                    loadSnippetFile("ace/mode/" + x);
                });
            }
        }
    });
};
function getCompletionPrefix(editor) {
    var pos = editor.getCursorPosition();
    var line = editor.session.getLine(pos.row);
    var prefix = retrievePrecedingIdentifier(line, pos.column);
    editor.completers.forEach(function (completer) {
        if (completer['identifierRegexps']) {
            completer['identifierRegexps'].forEach(function (identifierRegex) {
                if (!prefix && identifierRegex) {
                    prefix = retrievePrecedingIdentifier(line, pos.column, identifierRegex);
                }
            });
        }
    });
    return prefix;
}
var doLiveAutocomplete = function (e) {
    var editor = e.editor;
    var text = e.args || "";
    var hasCompleter = getCompleter(editor) && getCompleter(editor).activated;
    if (e.command.name === "backspace") {
        if (hasCompleter && !getCompletionPrefix(editor))
            getCompleter(editor).detach();
    }
    else if (e.command.name === "insertstring") {
        var prefix = getCompletionPrefix(editor);
        if (prefix && !hasCompleter) {
            if (!getCompleter(editor)) {
                setCompleter(editor, new CompleterAggregate(editor));
            }
            getCompleter(editor).autoSelect = false;
            getCompleter(editor).autoInsert = false;
            getCompleter(editor).showPopup(editor);
        }
    }
};
defineOptions(Editor.prototype, 'editor', {
    enableBasicAutocompletion: {
        set: function (val) {
            var editor = this;
            if (val) {
                if (!editor.completers) {
                    editor.completers = Array.isArray(val) ? val : completers;
                }
                editor.commands.addCommand(Autocomplete.startCommand);
            }
            else {
                editor.commands.removeCommand(Autocomplete.startCommand.name);
            }
        },
        value: false
    },
    enableLiveAutocompletion: {
        set: function (val) {
            var editor = this;
            if (val) {
                if (!editor.completers) {
                    editor.completers = Array.isArray(val) ? val : completers;
                }
                editor.commands.on('afterExec', doLiveAutocomplete);
            }
            else {
                editor.commands.off('afterExec', doLiveAutocomplete);
            }
        },
        value: false
    },
    enableSnippets: {
        set: function (val) {
            var editor = this;
            if (val) {
                editor.commands.addCommand(expandSnippet);
                editor.on("changeMode", onChangeMode);
                onChangeMode(null, editor);
            }
            else {
                editor.commands.removeCommand(expandSnippet.name);
                editor.off("changeMode", onChangeMode);
            }
        },
        value: false
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGFuZ3VhZ2VfdG9vbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZXh0L2xhbmd1YWdlX3Rvb2xzLnRzIl0sIm5hbWVzIjpbImFkZENvbXBsZXRlciIsImdldENvbXBsZXRpb25QcmVmaXgiXSwibWFwcGluZ3MiOiJPQStCTyxFQUFDLGNBQWMsRUFBQyxNQUFNLGFBQWE7T0FDbkMsRUFBWSxZQUFZLEVBQUUsWUFBWSxFQUFFLGtCQUFrQixFQUFFLFlBQVksRUFBQyxNQUFNLGlCQUFpQjtPQUNoRyxFQUFDLGFBQWEsRUFBRSxVQUFVLEVBQUMsTUFBTSxXQUFXO09BQzVDLEVBQUMsMkJBQTJCLEVBQUMsTUFBTSxzQkFBc0I7T0FDekQsTUFBTSxNQUFNLFdBQVc7QUFROUIsV0FBVyxnQkFBZ0IsR0FBYztJQUNyQyxjQUFjLEVBQUUsVUFBUyxNQUFjLEVBQUUsT0FBb0IsRUFBRSxHQUFvQyxFQUFFLE1BQWMsRUFBRSxRQUFRO1FBQ3pILElBQUksS0FBSyxHQUFHLE1BQU0sQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUM3QyxJQUFJLFdBQVcsR0FBRyxPQUFPLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUM1RSxRQUFRLENBQUMsSUFBSSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0lBQ2hDLENBQUM7Q0FDSixDQUFDO0FBRUYsV0FBVyxnQkFBZ0IsR0FBYztJQUNyQyxjQUFjLEVBQUUsVUFBUyxNQUFjLEVBQUUsT0FBb0IsRUFBRSxHQUFvQyxFQUFFLE1BQWMsRUFBRSxRQUFRO1FBQ3pILElBQUksVUFBVSxHQUFHLGNBQWMsQ0FBQyxVQUFVLENBQUM7UUFDM0MsSUFBSSxXQUFXLEdBQUcsRUFBRSxDQUFDO1FBQ3JCLGNBQWMsQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVMsS0FB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RSBCTE9DSyAqKioqKlxuICogRGlzdHJpYnV0ZWQgdW5kZXIgdGhlIEJTRCBsaWNlbnNlOlxuICpcbiAqIENvcHlyaWdodCAoYykgMjAxMiwgQWpheC5vcmcgQi5WLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBSZWRpc3RyaWJ1dGlvbiBhbmQgdXNlIGluIHNvdXJjZSBhbmQgYmluYXJ5IGZvcm1zLCB3aXRoIG9yIHdpdGhvdXRcbiAqIG1vZGlmaWNhdGlvbiwgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OlxuICogICAgICogUmVkaXN0cmlidXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHRcbiAqICAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci5cbiAqICAgICAqIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0XG4gKiAgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIgaW4gdGhlXG4gKiAgICAgICBkb2N1bWVudGF0aW9uIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLlxuICogICAgICogTmVpdGhlciB0aGUgbmFtZSBvZiBBamF4Lm9yZyBCLlYuIG5vciB0aGVcbiAqICAgICAgIG5hbWVzIG9mIGl0cyBjb250cmlidXRvcnMgbWF5IGJlIHVzZWQgdG8gZW5kb3JzZSBvciBwcm9tb3RlIHByb2R1Y3RzXG4gKiAgICAgICBkZXJpdmVkIGZyb20gdGhpcyBzb2Z0d2FyZSB3aXRob3V0IHNwZWNpZmljIHByaW9yIHdyaXR0ZW4gcGVybWlzc2lvbi5cbiAqXG4gKiBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIFRIRSBDT1BZUklHSFQgSE9MREVSUyBBTkQgQ09OVFJJQlVUT1JTIFwiQVMgSVNcIiBBTkRcbiAqIEFOWSBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRSBJTVBMSUVEXG4gKiBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFXG4gKiBESVNDTEFJTUVELiBJTiBOTyBFVkVOVCBTSEFMTCBBSkFYLk9SRyBCLlYuIEJFIExJQUJMRSBGT1IgQU5ZXG4gKiBESVJFQ1QsIElORElSRUNULCBJTkNJREVOVEFMLCBTUEVDSUFMLCBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFU1xuICogKElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRFIEdPT0RTIE9SIFNFUlZJQ0VTO1xuICogTE9TUyBPRiBVU0UsIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTIElOVEVSUlVQVElPTikgSE9XRVZFUiBDQVVTRUQgQU5EXG4gKiBPTiBBTlkgVEhFT1JZIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUIExJQUJJTElUWSwgT1IgVE9SVFxuICogKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZIE9VVCBPRiBUSEUgVVNFIE9GIFRISVNcbiAqIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLlxuICpcbiAqICoqKioqIEVORCBMSUNFTlNFIEJMT0NLICoqKioqICovXG5cbmltcG9ydCBDb21tYW5kIGZyb20gJy4uL2NvbW1hbmRzL0NvbW1hbmQnO1xuaW1wb3J0IHtzbmlwcGV0TWFuYWdlcn0gZnJvbSBcIi4uL3NuaXBwZXRzXCI7XG5pbXBvcnQge0NvbXBsZXRlciwgZ2V0Q29tcGxldGVyLCBzZXRDb21wbGV0ZXIsIENvbXBsZXRlckFnZ3JlZ2F0ZSwgQXV0b2NvbXBsZXRlfSBmcm9tIFwiLi4vYXV0b2NvbXBsZXRlXCI7XG5pbXBvcnQge2RlZmluZU9wdGlvbnMsIGxvYWRNb2R1bGV9IGZyb20gXCIuLi9jb25maWdcIjtcbmltcG9ydCB7cmV0cmlldmVQcmVjZWRpbmdJZGVudGlmaWVyfSBmcm9tIFwiLi4vYXV0b2NvbXBsZXRlL3V0aWxcIjtcbmltcG9ydCBFZGl0b3IgZnJvbSBcIi4uL0VkaXRvclwiO1xuaW1wb3J0IEVkaXRTZXNzaW9uIGZyb20gJy4uL0VkaXRTZXNzaW9uJztcbmltcG9ydCB7Z2V0Q29tcGxldGlvbnN9IGZyb20gJy4uL2F1dG9jb21wbGV0ZS90ZXh0X2NvbXBsZXRlcic7XG5pbXBvcnQgTW9kZSBmcm9tICcuLi9tb2RlL01vZGUnO1xuXG4vLyBFeHBvcnRzIGV4aXN0aW5nIGNvbXBsZXRlciBzbyB0aGF0IHVzZXIgY2FuIGNvbnN0cnVjdCBoaXMgb3duIHNldCBvZiBjb21wbGV0ZXJzLlxuLy8gZXhwb3J0IHZhciB0ZXh0Q29tcGxldGVyOiBhY20uQ29tcGxldGVyID0gdGNtO1xuXG5leHBvcnQgdmFyIGtleVdvcmRDb21wbGV0ZXI6IENvbXBsZXRlciA9IHtcbiAgICBnZXRDb21wbGV0aW9uczogZnVuY3Rpb24oZWRpdG9yOiBFZGl0b3IsIHNlc3Npb246IEVkaXRTZXNzaW9uLCBwb3M6IHsgcm93OiBudW1iZXI7IGNvbHVtbjogbnVtYmVyIH0sIHByZWZpeDogc3RyaW5nLCBjYWxsYmFjaykge1xuICAgICAgICB2YXIgc3RhdGUgPSBlZGl0b3Iuc2Vzc2lvbi5nZXRTdGF0ZShwb3Mucm93KTtcbiAgICAgICAgdmFyIGNvbXBsZXRpb25zID0gc2Vzc2lvbi4kbW9kZS5nZXRDb21wbGV0aW9ucyhzdGF0ZSwgc2Vzc2lvbiwgcG9zLCBwcmVmaXgpO1xuICAgICAgICBjYWxsYmFjayhudWxsLCBjb21wbGV0aW9ucyk7XG4gICAgfVxufTtcblxuZXhwb3J0IHZhciBzbmlwcGV0Q29tcGxldGVyOiBDb21wbGV0ZXIgPSB7XG4gICAgZ2V0Q29tcGxldGlvbnM6IGZ1bmN0aW9uKGVkaXRvcjogRWRpdG9yLCBzZXNzaW9uOiBFZGl0U2Vzc2lvbiwgcG9zOiB7IHJvdzogbnVtYmVyOyBjb2x1bW46IG51bWJlciB9LCBwcmVmaXg6IHN0cmluZywgY2FsbGJhY2spIHtcbiAgICAgICAgdmFyIHNuaXBwZXRNYXAgPSBzbmlwcGV0TWFuYWdlci5zbmlwcGV0TWFwO1xuICAgICAgICB2YXIgY29tcGxldGlvbnMgPSBbXTtcbiAgICAgICAgc25pcHBldE1hbmFnZXIuZ2V0QWN0aXZlU2NvcGVzKGVkaXRvcikuZm9yRWFjaChmdW5jdGlvbihzY29wZSkge1xuICAgICAgICAgICAgdmFyIHNuaXBwZXRzID0gc25pcHBldE1hcFtzY29wZV0gfHwgW107XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gc25pcHBldHMubGVuZ3RoOyBpLS07KSB7XG4gICAgICAgICAgICAgICAgdmFyIHMgPSBzbmlwcGV0c1tpXTtcbiAgICAgICAgICAgICAgICB2YXIgY2FwdGlvbiA9IHMubmFtZSB8fCBzLnRhYlRyaWdnZXI7XG4gICAgICAgICAgICAgICAgaWYgKCFjYXB0aW9uKVxuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICBjb21wbGV0aW9ucy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgY2FwdGlvbjogY2FwdGlvbixcbiAgICAgICAgICAgICAgICAgICAgc25pcHBldDogcy5jb250ZW50LFxuICAgICAgICAgICAgICAgICAgICBtZXRhOiBzLnRhYlRyaWdnZXIgJiYgIXMubmFtZSA/IHMudGFiVHJpZ2dlciArIFwiXFx1MjFFNSBcIiA6IFwic25pcHBldFwiXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sIHRoaXMpO1xuICAgICAgICBjYWxsYmFjayhudWxsLCBjb21wbGV0aW9ucyk7XG4gICAgfVxufTtcblxudmFyIGNvbXBsZXRlcnM6IENvbXBsZXRlcltdID0gW3NuaXBwZXRDb21wbGV0ZXIvKiwgdGV4dENvbXBsZXRlciovLCBrZXlXb3JkQ29tcGxldGVyXTtcblxuZXhwb3J0IGZ1bmN0aW9uIGFkZENvbXBsZXRlcihjb21wbGV0ZXI6IENvbXBsZXRlcikge1xuICAgIGNvbXBsZXRlcnMucHVzaChjb21wbGV0ZXIpO1xufTtcblxudmFyIGV4cGFuZFNuaXBwZXQ6IENvbW1hbmQgPSB7XG4gICAgbmFtZTogJ2V4cGFuZFNuaXBwZXQnLFxuICAgIGV4ZWM6IGZ1bmN0aW9uKGVkaXRvcjogRWRpdG9yKSB7XG4gICAgICAgIHZhciBzdWNjZXNzID0gc25pcHBldE1hbmFnZXIuZXhwYW5kV2l0aFRhYihlZGl0b3IpO1xuICAgICAgICBpZiAoIXN1Y2Nlc3MpIHtcbiAgICAgICAgICAgIGVkaXRvci5leGVjQ29tbWFuZCgnaW5kZW50Jyk7XG4gICAgICAgIH1cbiAgICB9LFxuICAgIGJpbmRLZXk6ICdUYWInXG59O1xuXG52YXIgb25DaGFuZ2VNb2RlID0gZnVuY3Rpb24oZSwgZWRpdG9yOiBFZGl0b3IpIHtcbiAgICBsb2FkU25pcHBldHNGb3JNb2RlKGVkaXRvci5zZXNzaW9uLiRtb2RlKTtcbn07XG5cbnZhciBsb2FkU25pcHBldHNGb3JNb2RlID0gZnVuY3Rpb24obW9kZTogTW9kZSkge1xuICAgIHZhciBpZCA9IG1vZGUuJGlkO1xuICAgIGlmICghc25pcHBldE1hbmFnZXJbJ2ZpbGVzJ10pIHtcbiAgICAgICAgc25pcHBldE1hbmFnZXJbJ2ZpbGVzJ10gPSB7fTtcbiAgICB9XG4gICAgbG9hZFNuaXBwZXRGaWxlKGlkKTtcbiAgICBpZiAobW9kZS5tb2Rlcykge1xuICAgICAgICBtb2RlLm1vZGVzLmZvckVhY2gobG9hZFNuaXBwZXRzRm9yTW9kZSk7XG4gICAgfVxufTtcblxudmFyIGxvYWRTbmlwcGV0RmlsZSA9IGZ1bmN0aW9uKGlkOiBzdHJpbmcpIHtcbiAgICBpZiAoIWlkIHx8IHNuaXBwZXRNYW5hZ2VyWydmaWxlcyddW2lkXSlcbiAgICAgICAgcmV0dXJuO1xuICAgIHZhciBzbmlwcGV0RmlsZVBhdGggPSBpZC5yZXBsYWNlKFwibW9kZVwiLCBcInNuaXBwZXRzXCIpO1xuICAgIHNuaXBwZXRNYW5hZ2VyWydmaWxlcyddW2lkXSA9IHt9O1xuICAgIGxvYWRNb2R1bGUoc25pcHBldEZpbGVQYXRoLCBmdW5jdGlvbihtKSB7XG4gICAgICAgIGlmIChtKSB7XG4gICAgICAgICAgICBzbmlwcGV0TWFuYWdlclsnZmlsZXMnXVtpZF0gPSBtO1xuICAgICAgICAgICAgaWYgKCFtLnNuaXBwZXRzICYmIG0uc25pcHBldFRleHQpXG4gICAgICAgICAgICAgICAgbS5zbmlwcGV0cyA9IHNuaXBwZXRNYW5hZ2VyLnBhcnNlU25pcHBldEZpbGUobS5zbmlwcGV0VGV4dCk7XG4gICAgICAgICAgICBzbmlwcGV0TWFuYWdlci5yZWdpc3RlcihtLnNuaXBwZXRzIHx8IFtdLCBtLnNjb3BlKTtcbiAgICAgICAgICAgIGlmIChtLmluY2x1ZGVTY29wZXMpIHtcbiAgICAgICAgICAgICAgICBzbmlwcGV0TWFuYWdlci5zbmlwcGV0TWFwW20uc2NvcGVdLmluY2x1ZGVTY29wZXMgPSBtLmluY2x1ZGVTY29wZXM7XG4gICAgICAgICAgICAgICAgbS5pbmNsdWRlU2NvcGVzLmZvckVhY2goZnVuY3Rpb24oeCkge1xuICAgICAgICAgICAgICAgICAgICBsb2FkU25pcHBldEZpbGUoXCJhY2UvbW9kZS9cIiArIHgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfSk7XG59O1xuXG5mdW5jdGlvbiBnZXRDb21wbGV0aW9uUHJlZml4KGVkaXRvcjogRWRpdG9yKSB7XG4gICAgdmFyIHBvcyA9IGVkaXRvci5nZXRDdXJzb3JQb3NpdGlvbigpO1xuICAgIHZhciBsaW5lID0gZWRpdG9yLnNlc3Npb24uZ2V0TGluZShwb3Mucm93KTtcbiAgICB2YXIgcHJlZml4ID0gcmV0cmlldmVQcmVjZWRpbmdJZGVudGlmaWVyKGxpbmUsIHBvcy5jb2x1bW4pO1xuICAgIC8vIFRyeSB0byBmaW5kIGN1c3RvbSBwcmVmaXhlcyBvbiB0aGUgY29tcGxldGVyc1xuICAgIGVkaXRvci5jb21wbGV0ZXJzLmZvckVhY2goZnVuY3Rpb24oY29tcGxldGVyKSB7XG4gICAgICAgIGlmIChjb21wbGV0ZXJbJ2lkZW50aWZpZXJSZWdleHBzJ10pIHtcbiAgICAgICAgICAgIGNvbXBsZXRlclsnaWRlbnRpZmllclJlZ2V4cHMnXS5mb3JFYWNoKGZ1bmN0aW9uKGlkZW50aWZpZXJSZWdleCkge1xuICAgICAgICAgICAgICAgIGlmICghcHJlZml4ICYmIGlkZW50aWZpZXJSZWdleCkge1xuICAgICAgICAgICAgICAgICAgICBwcmVmaXggPSByZXRyaWV2ZVByZWNlZGluZ0lkZW50aWZpZXIobGluZSwgcG9zLmNvbHVtbiwgaWRlbnRpZmllclJlZ2V4KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBwcmVmaXg7XG59XG5cbnZhciBkb0xpdmVBdXRvY29tcGxldGUgPSBmdW5jdGlvbihlOiB7IGVkaXRvcjogRWRpdG9yOyBjb21tYW5kOiB7IG5hbWU6IHN0cmluZyB9OyBhcmdzIH0pIHtcbiAgICB2YXIgZWRpdG9yID0gZS5lZGl0b3I7XG4gICAgdmFyIHRleHQgPSBlLmFyZ3MgfHwgXCJcIjtcbiAgICB2YXIgaGFzQ29tcGxldGVyID0gZ2V0Q29tcGxldGVyKGVkaXRvcikgJiYgZ2V0Q29tcGxldGVyKGVkaXRvcikuYWN0aXZhdGVkO1xuXG4gICAgLy8gV2UgZG9uJ3Qgd2FudCB0byBhdXRvY29tcGxldGUgd2l0aCBubyBwcmVmaXhcbiAgICBpZiAoZS5jb21tYW5kLm5hbWUgPT09IFwiYmFja3NwYWNlXCIpIHtcbiAgICAgICAgaWYgKGhhc0NvbXBsZXRlciAmJiAhZ2V0Q29tcGxldGlvblByZWZpeChlZGl0b3IpKVxuICAgICAgICAgICAgZ2V0Q29tcGxldGVyKGVkaXRvcikuZGV0YWNoKCk7XG4gICAgfVxuICAgIGVsc2UgaWYgKGUuY29tbWFuZC5uYW1lID09PSBcImluc2VydHN0cmluZ1wiKSB7XG4gICAgICAgIHZhciBwcmVmaXggPSBnZXRDb21wbGV0aW9uUHJlZml4KGVkaXRvcik7XG4gICAgICAgIC8vIE9ubHkgYXV0b2NvbXBsZXRlIGlmIHRoZXJlJ3MgYSBwcmVmaXggdGhhdCBjYW4gYmUgbWF0Y2hlZFxuICAgICAgICBpZiAocHJlZml4ICYmICFoYXNDb21wbGV0ZXIpIHtcbiAgICAgICAgICAgIGlmICghZ2V0Q29tcGxldGVyKGVkaXRvcikpIHtcbiAgICAgICAgICAgICAgICBzZXRDb21wbGV0ZXIoZWRpdG9yLCBuZXcgQ29tcGxldGVyQWdncmVnYXRlKGVkaXRvcikpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gRGlzYWJsZSBhdXRvSW5zZXJ0XG4gICAgICAgICAgICBnZXRDb21wbGV0ZXIoZWRpdG9yKS5hdXRvU2VsZWN0ID0gZmFsc2U7XG4gICAgICAgICAgICBnZXRDb21wbGV0ZXIoZWRpdG9yKS5hdXRvSW5zZXJ0ID0gZmFsc2U7XG4gICAgICAgICAgICBnZXRDb21wbGV0ZXIoZWRpdG9yKS5zaG93UG9wdXAoZWRpdG9yKTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5cbmRlZmluZU9wdGlvbnMoRWRpdG9yLnByb3RvdHlwZSwgJ2VkaXRvcicsIHtcbiAgICBlbmFibGVCYXNpY0F1dG9jb21wbGV0aW9uOiB7XG4gICAgICAgIHNldDogZnVuY3Rpb24odmFsKSB7XG4gICAgICAgICAgICB2YXIgZWRpdG9yOiBFZGl0b3IgPSB0aGlzO1xuICAgICAgICAgICAgaWYgKHZhbCkge1xuICAgICAgICAgICAgICAgIGlmICghZWRpdG9yLmNvbXBsZXRlcnMpIHtcbiAgICAgICAgICAgICAgICAgICAgZWRpdG9yLmNvbXBsZXRlcnMgPSBBcnJheS5pc0FycmF5KHZhbCkgPyB2YWwgOiBjb21wbGV0ZXJzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlZGl0b3IuY29tbWFuZHMuYWRkQ29tbWFuZChBdXRvY29tcGxldGUuc3RhcnRDb21tYW5kKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGVkaXRvci5jb21tYW5kcy5yZW1vdmVDb21tYW5kKEF1dG9jb21wbGV0ZS5zdGFydENvbW1hbmQubmFtZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIHZhbHVlOiBmYWxzZVxuICAgIH0sXG4gICAgLyoqXG4gICAgICogRW5hYmxlIGxpdmUgYXV0b2NvbXBsZXRlLiBJZiB0aGUgdmFsdWUgaXMgYW4gYXJyYXksIGl0IGlzIGFzc3VtZWQgdG8gYmUgYW4gYXJyYXkgb2YgY29tcGxldGVyc1xuICAgICAqIGFuZCB3aWxsIHVzZSB0aGVtIGluc3RlYWQgb2YgdGhlIGRlZmF1bHQgY29tcGxldGVycy5cbiAgICAgKi9cbiAgICBlbmFibGVMaXZlQXV0b2NvbXBsZXRpb246IHtcbiAgICAgICAgc2V0OiBmdW5jdGlvbih2YWwpIHtcbiAgICAgICAgICAgIHZhciBlZGl0b3I6IEVkaXRvciA9IHRoaXM7XG4gICAgICAgICAgICBpZiAodmFsKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFlZGl0b3IuY29tcGxldGVycykge1xuICAgICAgICAgICAgICAgICAgICBlZGl0b3IuY29tcGxldGVycyA9IEFycmF5LmlzQXJyYXkodmFsKSA/IHZhbCA6IGNvbXBsZXRlcnM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIE9uIGVhY2ggY2hhbmdlIGF1dG9tYXRpY2FsbHkgdHJpZ2dlciB0aGUgYXV0b2NvbXBsZXRlXG4gICAgICAgICAgICAgICAgZWRpdG9yLmNvbW1hbmRzLm9uKCdhZnRlckV4ZWMnLCBkb0xpdmVBdXRvY29tcGxldGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgZWRpdG9yLmNvbW1hbmRzLm9mZignYWZ0ZXJFeGVjJywgZG9MaXZlQXV0b2NvbXBsZXRlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgdmFsdWU6IGZhbHNlXG4gICAgfSxcbiAgICBlbmFibGVTbmlwcGV0czoge1xuICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbCkge1xuICAgICAgICAgICAgdmFyIGVkaXRvcjogRWRpdG9yID0gdGhpcztcbiAgICAgICAgICAgIGlmICh2YWwpIHtcbiAgICAgICAgICAgICAgICBlZGl0b3IuY29tbWFuZHMuYWRkQ29tbWFuZChleHBhbmRTbmlwcGV0KTtcbiAgICAgICAgICAgICAgICBlZGl0b3Iub24oXCJjaGFuZ2VNb2RlXCIsIG9uQ2hhbmdlTW9kZSk7XG4gICAgICAgICAgICAgICAgb25DaGFuZ2VNb2RlKG51bGwsIGVkaXRvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBlZGl0b3IuY29tbWFuZHMucmVtb3ZlQ29tbWFuZChleHBhbmRTbmlwcGV0Lm5hbWUpO1xuICAgICAgICAgICAgICAgIGVkaXRvci5vZmYoXCJjaGFuZ2VNb2RlXCIsIG9uQ2hhbmdlTW9kZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIHZhbHVlOiBmYWxzZVxuICAgIH1cbn0pO1xuIl19