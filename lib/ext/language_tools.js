var snip = require("../snippets");
var acm = require("../autocomplete");
var config = require("../config");
var util = require("../autocomplete/util");
var Editor = require("../Editor");
exports.keyWordCompleter = {
    getCompletions: function (editor, session, pos, prefix, callback) {
        var state = editor.session.getState(pos.row);
        var completions = session.$mode.getCompletions(state, session, pos, prefix);
        callback(null, completions);
    }
};
exports.snippetCompleter = {
    getCompletions: function (editor, session, pos, prefix, callback) {
        var snippetMap = snip.snippetManager.snippetMap;
        var completions = [];
        snip.snippetManager.getActiveScopes(editor).forEach(function (scope) {
            var snippets = snippetMap[scope] || [];
            for (var i = snippets.length; i--;) {
                var s = snippets[i];
                var caption = s.name || s.tabTrigger;
                if (!caption)
                    continue;
                completions.push({
                    caption: caption,
                    snippet: s.content,
                    meta: s.tabTrigger && !s.name ? s.tabTrigger + "\u21E5 " : "snippet"
                });
            }
        }, this);
        callback(null, completions);
    }
};
var completers = [exports.snippetCompleter, exports.keyWordCompleter];
function addCompleter(completer) {
    completers.push(completer);
}
exports.addCompleter = addCompleter;
;
var expandSnippet = {
    name: 'expandSnippet',
    exec: function (editor) {
        var success = snip.snippetManager.expandWithTab(editor);
        if (!success) {
            editor.execCommand('indent');
        }
    },
    bindKey: 'Tab'
};
var onChangeMode = function (e, editor) {
    loadSnippetsForMode(editor.session.$mode);
};
var loadSnippetsForMode = function (mode) {
    var id = mode.$id;
    if (!snip.snippetManager['files']) {
        snip.snippetManager['files'] = {};
    }
    loadSnippetFile(id);
    if (mode.modes)
        mode.modes.forEach(loadSnippetsForMode);
};
var loadSnippetFile = function (id) {
    if (!id || snip.snippetManager['files'][id])
        return;
    var snippetFilePath = id.replace("mode", "snippets");
    snip.snippetManager['files'][id] = {};
    config.loadModule(snippetFilePath, function (m) {
        if (m) {
            snip.snippetManager['files'][id] = m;
            if (!m.snippets && m.snippetText)
                m.snippets = snip.snippetManager.parseSnippetFile(m.snippetText);
            snip.snippetManager.register(m.snippets || [], m.scope);
            if (m.includeScopes) {
                snip.snippetManager.snippetMap[m.scope].includeScopes = m.includeScopes;
                m.includeScopes.forEach(function (x) {
                    loadSnippetFile("ace/mode/" + x);
                });
            }
        }
    });
};
function getCompletionPrefix(editor) {
    var pos = editor.getCursorPosition();
    var line = editor.session.getLine(pos.row);
    var prefix = util.retrievePrecedingIdentifier(line, pos.column);
    editor.completers.forEach(function (completer) {
        if (completer['identifierRegexps']) {
            completer['identifierRegexps'].forEach(function (identifierRegex) {
                if (!prefix && identifierRegex) {
                    prefix = util.retrievePrecedingIdentifier(line, pos.column, identifierRegex);
                }
            });
        }
    });
    return prefix;
}
var doLiveAutocomplete = function (e) {
    var editor = e.editor;
    var text = e.args || "";
    var hasCompleter = acm.getCompleter(editor) && acm.getCompleter(editor).activated;
    if (e.command.name === "backspace") {
        if (hasCompleter && !getCompletionPrefix(editor))
            acm.getCompleter(editor).detach();
    }
    else if (e.command.name === "insertstring") {
        var prefix = getCompletionPrefix(editor);
        if (prefix && !hasCompleter) {
            if (!acm.getCompleter(editor)) {
                acm.setCompleter(editor, new acm.CompleterAggregate(editor));
            }
            acm.getCompleter(editor).autoSelect = false;
            acm.getCompleter(editor).autoInsert = false;
            acm.getCompleter(editor).showPopup(editor);
        }
    }
};
config.defineOptions(Editor.prototype, 'editor', {
    enableBasicAutocompletion: {
        set: function (val) {
            var editor = this;
            if (val) {
                if (!editor.completers) {
                    editor.completers = Array.isArray(val) ? val : completers;
                }
                editor.commands.addCommand(acm.Autocomplete.startCommand);
            }
            else {
                editor.commands.removeCommand(acm.Autocomplete.startCommand.name);
            }
        },
        value: false
    },
    enableLiveAutocompletion: {
        set: function (val) {
            var editor = this;
            if (val) {
                if (!editor.completers) {
                    editor.completers = Array.isArray(val) ? val : completers;
                }
                editor.commands.on('afterExec', doLiveAutocomplete);
            }
            else {
                editor.commands.off('afterExec', doLiveAutocomplete);
            }
        },
        value: false
    },
    enableSnippets: {
        set: function (val) {
            var editor = this;
            if (val) {
                editor.commands.addCommand(expandSnippet);
                editor.on("changeMode", onChangeMode);
                onChangeMode(null, editor);
            }
            else {
                editor.commands.removeCommand(expandSnippet.name);
                editor.off("changeMode", onChangeMode);
            }
        },
        value: false
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGFuZ3VhZ2VfdG9vbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZXh0L2xhbmd1YWdlX3Rvb2xzLnRzIl0sIm5hbWVzIjpbImFkZENvbXBsZXRlciIsImdldENvbXBsZXRpb25QcmVmaXgiXSwibWFwcGluZ3MiOiJBQStCQSxJQUFPLElBQUksV0FBVyxhQUFhLENBQUMsQ0FBQztBQUNyQyxJQUFPLEdBQUcsV0FBVyxpQkFBaUIsQ0FBQyxDQUFDO0FBQ3hDLElBQU8sTUFBTSxXQUFXLFdBQVcsQ0FBQyxDQUFDO0FBQ3JDLElBQU8sSUFBSSxXQUFXLHNCQUFzQixDQUFDLENBQUM7QUFDOUMsSUFBTyxNQUFNLFdBQVcsV0FBVyxDQUFDLENBQUM7QUFPMUIsd0JBQWdCLEdBQWtCO0lBQ3pDLGNBQWMsRUFBRSxVQUFTLE1BQWMsRUFBRSxPQUF3QixFQUFFLEdBQW9DLEVBQUUsTUFBYyxFQUFFLFFBQVE7UUFDN0gsSUFBSSxLQUFLLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzdDLElBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQzVFLFFBQVEsQ0FBQyxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDaEMsQ0FBQztDQUNKLENBQUM7QUFFUyx3QkFBZ0IsR0FBa0I7SUFDekMsY0FBYyxFQUFFLFVBQVMsTUFBYyxFQUFFLE9BQXdCLEVBQUUsR0FBb0MsRUFBRSxNQUFjLEVBQUUsUUFBUTtRQUM3SCxJQUFJLFVBQVUsR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLFVBQVUsQ0FBQztRQUNoRCxJQUFJLFdBQVcsR0FBRyxFQUFFLENBQUM7UUFDckIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxlQUFlLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLFVBQVMs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QztZQUMvQixDQUFDO1lBQ0QsSUFBSSxDQUFDLENBQUM7Z0JBQ0YsTUFBTSxDQUFDLFFBQVEsQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUNsRCxNQUFNLENBQUMsR0FBRyxDQUFDLFlBQVksRUFBRSxZQUFZLENBQUMsQ0FBQztZQUMzQyxDQUFDO1FBQ0wsQ0FBQztRQUNELEtBQUssRUFBRSxLQUFLO0tBQ2Y7Q0FDSixDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvKiAqKioqKiBCRUdJTiBMSUNFTlNFIEJMT0NLICoqKioqXG4gKiBEaXN0cmlidXRlZCB1bmRlciB0aGUgQlNEIGxpY2Vuc2U6XG4gKlxuICogQ29weXJpZ2h0IChjKSAyMDEyLCBBamF4Lm9yZyBCLlYuXG4gKiBBbGwgcmlnaHRzIHJlc2VydmVkLlxuICpcbiAqIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dFxuICogbW9kaWZpY2F0aW9uLCBhcmUgcGVybWl0dGVkIHByb3ZpZGVkIHRoYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zIGFyZSBtZXQ6XG4gKiAgICAgKiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodFxuICogICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLlxuICogICAgICogUmVkaXN0cmlidXRpb25zIGluIGJpbmFyeSBmb3JtIG11c3QgcmVwcm9kdWNlIHRoZSBhYm92ZSBjb3B5cmlnaHRcbiAqICAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGVcbiAqICAgICAgIGRvY3VtZW50YXRpb24gYW5kL29yIG90aGVyIG1hdGVyaWFscyBwcm92aWRlZCB3aXRoIHRoZSBkaXN0cmlidXRpb24uXG4gKiAgICAgKiBOZWl0aGVyIHRoZSBuYW1lIG9mIEFqYXgub3JnIEIuVi4gbm9yIHRoZVxuICogICAgICAgbmFtZXMgb2YgaXRzIGNvbnRyaWJ1dG9ycyBtYXkgYmUgdXNlZCB0byBlbmRvcnNlIG9yIHByb21vdGUgcHJvZHVjdHNcbiAqICAgICAgIGRlcml2ZWQgZnJvbSB0aGlzIHNvZnR3YXJlIHdpdGhvdXQgc3BlY2lmaWMgcHJpb3Igd3JpdHRlbiBwZXJtaXNzaW9uLlxuICpcbiAqIFRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgVEhFIENPUFlSSUdIVCBIT0xERVJTIEFORCBDT05UUklCVVRPUlMgXCJBUyBJU1wiIEFORFxuICogQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhFIElNUExJRURcbiAqIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkVcbiAqIERJU0NMQUlNRUQuIElOIE5PIEVWRU5UIFNIQUxMIEFKQVguT1JHIEIuVi4gQkUgTElBQkxFIEZPUiBBTllcbiAqIERJUkVDVCwgSU5ESVJFQ1QsIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTXG4gKiAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVM7XG4gKiBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVTSU5FU1MgSU5URVJSVVBUSU9OKSBIT1dFVkVSIENBVVNFRCBBTkRcbiAqIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QgTElBQklMSVRZLCBPUiBUT1JUXG4gKiAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRSBVU0UgT0YgVEhJU1xuICogU09GVFdBUkUsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuXG4gKlxuICogKioqKiogRU5EIExJQ0VOU0UgQkxPQ0sgKioqKiogKi9cblxuaW1wb3J0IENvbW1hbmQgPSByZXF1aXJlKCcuLi9jb21tYW5kcy9Db21tYW5kJyk7XG5pbXBvcnQgc25pcCA9IHJlcXVpcmUoXCIuLi9zbmlwcGV0c1wiKTtcbmltcG9ydCBhY20gPSByZXF1aXJlKFwiLi4vYXV0b2NvbXBsZXRlXCIpO1xuaW1wb3J0IGNvbmZpZyA9IHJlcXVpcmUoXCIuLi9jb25maWdcIik7XG5pbXBvcnQgdXRpbCA9IHJlcXVpcmUoXCIuLi9hdXRvY29tcGxldGUvdXRpbFwiKTtcbmltcG9ydCBFZGl0b3IgPSByZXF1aXJlKFwiLi4vRWRpdG9yXCIpO1xuaW1wb3J0IGVzbSA9IHJlcXVpcmUoJy4uL2VkaXRfc2Vzc2lvbicpO1xuaW1wb3J0IHRjbSA9IHJlcXVpcmUoJy4uL2F1dG9jb21wbGV0ZS90ZXh0X2NvbXBsZXRlcicpO1xuXG4vLyBFeHBvcnRzIGV4aXN0aW5nIGNvbXBsZXRlciBzbyB0aGF0IHVzZXIgY2FuIGNvbnN0cnVjdCBoaXMgb3duIHNldCBvZiBjb21wbGV0ZXJzLlxuLy8gZXhwb3J0IHZhciB0ZXh0Q29tcGxldGVyOiBhY20uQ29tcGxldGVyID0gdGNtO1xuXG5leHBvcnQgdmFyIGtleVdvcmRDb21wbGV0ZXI6IGFjbS5Db21wbGV0ZXIgPSB7XG4gICAgZ2V0Q29tcGxldGlvbnM6IGZ1bmN0aW9uKGVkaXRvcjogRWRpdG9yLCBzZXNzaW9uOiBlc20uRWRpdFNlc3Npb24sIHBvczogeyByb3c6IG51bWJlcjsgY29sdW1uOiBudW1iZXIgfSwgcHJlZml4OiBzdHJpbmcsIGNhbGxiYWNrKSB7XG4gICAgICAgIHZhciBzdGF0ZSA9IGVkaXRvci5zZXNzaW9uLmdldFN0YXRlKHBvcy5yb3cpO1xuICAgICAgICB2YXIgY29tcGxldGlvbnMgPSBzZXNzaW9uLiRtb2RlLmdldENvbXBsZXRpb25zKHN0YXRlLCBzZXNzaW9uLCBwb3MsIHByZWZpeCk7XG4gICAgICAgIGNhbGxiYWNrKG51bGwsIGNvbXBsZXRpb25zKTtcbiAgICB9XG59O1xuXG5leHBvcnQgdmFyIHNuaXBwZXRDb21wbGV0ZXI6IGFjbS5Db21wbGV0ZXIgPSB7XG4gICAgZ2V0Q29tcGxldGlvbnM6IGZ1bmN0aW9uKGVkaXRvcjogRWRpdG9yLCBzZXNzaW9uOiBlc20uRWRpdFNlc3Npb24sIHBvczogeyByb3c6IG51bWJlcjsgY29sdW1uOiBudW1iZXIgfSwgcHJlZml4OiBzdHJpbmcsIGNhbGxiYWNrKSB7XG4gICAgICAgIHZhciBzbmlwcGV0TWFwID0gc25pcC5zbmlwcGV0TWFuYWdlci5zbmlwcGV0TWFwO1xuICAgICAgICB2YXIgY29tcGxldGlvbnMgPSBbXTtcbiAgICAgICAgc25pcC5zbmlwcGV0TWFuYWdlci5nZXRBY3RpdmVTY29wZXMoZWRpdG9yKS5mb3JFYWNoKGZ1bmN0aW9uKHNjb3BlKSB7XG4gICAgICAgICAgICB2YXIgc25pcHBldHMgPSBzbmlwcGV0TWFwW3Njb3BlXSB8fCBbXTtcbiAgICAgICAgICAgIGZvciAodmFyIGkgPSBzbmlwcGV0cy5sZW5ndGg7IGktLTspIHtcbiAgICAgICAgICAgICAgICB2YXIgcyA9IHNuaXBwZXRzW2ldO1xuICAgICAgICAgICAgICAgIHZhciBjYXB0aW9uID0gcy5uYW1lIHx8IHMudGFiVHJpZ2dlcjtcbiAgICAgICAgICAgICAgICBpZiAoIWNhcHRpb24pXG4gICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgICAgIGNvbXBsZXRpb25zLnB1c2goe1xuICAgICAgICAgICAgICAgICAgICBjYXB0aW9uOiBjYXB0aW9uLFxuICAgICAgICAgICAgICAgICAgICBzbmlwcGV0OiBzLmNvbnRlbnQsXG4gICAgICAgICAgICAgICAgICAgIG1ldGE6IHMudGFiVHJpZ2dlciAmJiAhcy5uYW1lID8gcy50YWJUcmlnZ2VyICsgXCJcXHUyMUU1IFwiIDogXCJzbmlwcGV0XCJcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSwgdGhpcyk7XG4gICAgICAgIGNhbGxiYWNrKG51bGwsIGNvbXBsZXRpb25zKTtcbiAgICB9XG59O1xuXG52YXIgY29tcGxldGVyczogYWNtLkNvbXBsZXRlcltdID0gW3NuaXBwZXRDb21wbGV0ZXIvKiwgdGV4dENvbXBsZXRlciovLCBrZXlXb3JkQ29tcGxldGVyXTtcblxuZXhwb3J0IGZ1bmN0aW9uIGFkZENvbXBsZXRlcihjb21wbGV0ZXI6IGFjbS5Db21wbGV0ZXIpIHtcbiAgICBjb21wbGV0ZXJzLnB1c2goY29tcGxldGVyKTtcbn07XG5cbnZhciBleHBhbmRTbmlwcGV0OiBDb21tYW5kID0ge1xuICAgIG5hbWU6ICdleHBhbmRTbmlwcGV0JyxcbiAgICBleGVjOiBmdW5jdGlvbihlZGl0b3I6IEVkaXRvcikge1xuICAgICAgICB2YXIgc3VjY2VzcyA9IHNuaXAuc25pcHBldE1hbmFnZXIuZXhwYW5kV2l0aFRhYihlZGl0b3IpO1xuICAgICAgICBpZiAoIXN1Y2Nlc3MpIHtcbiAgICAgICAgICAgIGVkaXRvci5leGVjQ29tbWFuZCgnaW5kZW50Jyk7XG4gICAgICAgIH1cbiAgICB9LFxuICAgIGJpbmRLZXk6ICdUYWInXG59O1xuXG52YXIgb25DaGFuZ2VNb2RlID0gZnVuY3Rpb24oZSwgZWRpdG9yOiBFZGl0b3IpIHtcbiAgICBsb2FkU25pcHBldHNGb3JNb2RlKGVkaXRvci5zZXNzaW9uLiRtb2RlKTtcbn07XG5cbnZhciBsb2FkU25pcHBldHNGb3JNb2RlID0gZnVuY3Rpb24obW9kZTogeyAkaWQ6IHN0cmluZzsgbW9kZXMgfSkge1xuICAgIHZhciBpZCA9IG1vZGUuJGlkO1xuICAgIGlmICghc25pcC5zbmlwcGV0TWFuYWdlclsnZmlsZXMnXSkge1xuICAgICAgICBzbmlwLnNuaXBwZXRNYW5hZ2VyWydmaWxlcyddID0ge307XG4gICAgfVxuICAgIGxvYWRTbmlwcGV0RmlsZShpZCk7XG4gICAgaWYgKG1vZGUubW9kZXMpXG4gICAgICAgIG1vZGUubW9kZXMuZm9yRWFjaChsb2FkU25pcHBldHNGb3JNb2RlKTtcbn07XG5cbnZhciBsb2FkU25pcHBldEZpbGUgPSBmdW5jdGlvbihpZDogc3RyaW5nKSB7XG4gICAgaWYgKCFpZCB8fCBzbmlwLnNuaXBwZXRNYW5hZ2VyWydmaWxlcyddW2lkXSlcbiAgICAgICAgcmV0dXJuO1xuICAgIHZhciBzbmlwcGV0RmlsZVBhdGggPSBpZC5yZXBsYWNlKFwibW9kZVwiLCBcInNuaXBwZXRzXCIpO1xuICAgIHNuaXAuc25pcHBldE1hbmFnZXJbJ2ZpbGVzJ11baWRdID0ge307XG4gICAgY29uZmlnLmxvYWRNb2R1bGUoc25pcHBldEZpbGVQYXRoLCBmdW5jdGlvbihtKSB7XG4gICAgICAgIGlmIChtKSB7XG4gICAgICAgICAgICBzbmlwLnNuaXBwZXRNYW5hZ2VyWydmaWxlcyddW2lkXSA9IG07XG4gICAgICAgICAgICBpZiAoIW0uc25pcHBldHMgJiYgbS5zbmlwcGV0VGV4dClcbiAgICAgICAgICAgICAgICBtLnNuaXBwZXRzID0gc25pcC5zbmlwcGV0TWFuYWdlci5wYXJzZVNuaXBwZXRGaWxlKG0uc25pcHBldFRleHQpO1xuICAgICAgICAgICAgc25pcC5zbmlwcGV0TWFuYWdlci5yZWdpc3RlcihtLnNuaXBwZXRzIHx8IFtdLCBtLnNjb3BlKTtcbiAgICAgICAgICAgIGlmIChtLmluY2x1ZGVTY29wZXMpIHtcbiAgICAgICAgICAgICAgICBzbmlwLnNuaXBwZXRNYW5hZ2VyLnNuaXBwZXRNYXBbbS5zY29wZV0uaW5jbHVkZVNjb3BlcyA9IG0uaW5jbHVkZVNjb3BlcztcbiAgICAgICAgICAgICAgICBtLmluY2x1ZGVTY29wZXMuZm9yRWFjaChmdW5jdGlvbih4KSB7XG4gICAgICAgICAgICAgICAgICAgIGxvYWRTbmlwcGV0RmlsZShcImFjZS9tb2RlL1wiICsgeCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9KTtcbn07XG5cbmZ1bmN0aW9uIGdldENvbXBsZXRpb25QcmVmaXgoZWRpdG9yOiBFZGl0b3IpIHtcbiAgICB2YXIgcG9zID0gZWRpdG9yLmdldEN1cnNvclBvc2l0aW9uKCk7XG4gICAgdmFyIGxpbmUgPSBlZGl0b3Iuc2Vzc2lvbi5nZXRMaW5lKHBvcy5yb3cpO1xuICAgIHZhciBwcmVmaXggPSB1dGlsLnJldHJpZXZlUHJlY2VkaW5nSWRlbnRpZmllcihsaW5lLCBwb3MuY29sdW1uKTtcbiAgICAvLyBUcnkgdG8gZmluZCBjdXN0b20gcHJlZml4ZXMgb24gdGhlIGNvbXBsZXRlcnNcbiAgICBlZGl0b3IuY29tcGxldGVycy5mb3JFYWNoKGZ1bmN0aW9uKGNvbXBsZXRlcikge1xuICAgICAgICBpZiAoY29tcGxldGVyWydpZGVudGlmaWVyUmVnZXhwcyddKSB7XG4gICAgICAgICAgICBjb21wbGV0ZXJbJ2lkZW50aWZpZXJSZWdleHBzJ10uZm9yRWFjaChmdW5jdGlvbihpZGVudGlmaWVyUmVnZXgpIHtcbiAgICAgICAgICAgICAgICBpZiAoIXByZWZpeCAmJiBpZGVudGlmaWVyUmVnZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgcHJlZml4ID0gdXRpbC5yZXRyaWV2ZVByZWNlZGluZ0lkZW50aWZpZXIobGluZSwgcG9zLmNvbHVtbiwgaWRlbnRpZmllclJlZ2V4KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBwcmVmaXg7XG59XG5cbnZhciBkb0xpdmVBdXRvY29tcGxldGUgPSBmdW5jdGlvbihlOiB7IGVkaXRvcjogRWRpdG9yOyBjb21tYW5kOiB7IG5hbWU6IHN0cmluZyB9OyBhcmdzIH0pIHtcbiAgICB2YXIgZWRpdG9yID0gZS5lZGl0b3I7XG4gICAgdmFyIHRleHQgPSBlLmFyZ3MgfHwgXCJcIjtcbiAgICB2YXIgaGFzQ29tcGxldGVyID0gYWNtLmdldENvbXBsZXRlcihlZGl0b3IpICYmIGFjbS5nZXRDb21wbGV0ZXIoZWRpdG9yKS5hY3RpdmF0ZWQ7XG5cbiAgICAvLyBXZSBkb24ndCB3YW50IHRvIGF1dG9jb21wbGV0ZSB3aXRoIG5vIHByZWZpeFxuICAgIGlmIChlLmNvbW1hbmQubmFtZSA9PT0gXCJiYWNrc3BhY2VcIikge1xuICAgICAgICBpZiAoaGFzQ29tcGxldGVyICYmICFnZXRDb21wbGV0aW9uUHJlZml4KGVkaXRvcikpXG4gICAgICAgICAgICBhY20uZ2V0Q29tcGxldGVyKGVkaXRvcikuZGV0YWNoKCk7XG4gICAgfVxuICAgIGVsc2UgaWYgKGUuY29tbWFuZC5uYW1lID09PSBcImluc2VydHN0cmluZ1wiKSB7XG4gICAgICAgIHZhciBwcmVmaXggPSBnZXRDb21wbGV0aW9uUHJlZml4KGVkaXRvcik7XG4gICAgICAgIC8vIE9ubHkgYXV0b2NvbXBsZXRlIGlmIHRoZXJlJ3MgYSBwcmVmaXggdGhhdCBjYW4gYmUgbWF0Y2hlZFxuICAgICAgICBpZiAocHJlZml4ICYmICFoYXNDb21wbGV0ZXIpIHtcbiAgICAgICAgICAgIGlmICghYWNtLmdldENvbXBsZXRlcihlZGl0b3IpKSB7XG4gICAgICAgICAgICAgICAgYWNtLnNldENvbXBsZXRlcihlZGl0b3IsIG5ldyBhY20uQ29tcGxldGVyQWdncmVnYXRlKGVkaXRvcikpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gRGlzYWJsZSBhdXRvSW5zZXJ0XG4gICAgICAgICAgICBhY20uZ2V0Q29tcGxldGVyKGVkaXRvcikuYXV0b1NlbGVjdCA9IGZhbHNlO1xuICAgICAgICAgICAgYWNtLmdldENvbXBsZXRlcihlZGl0b3IpLmF1dG9JbnNlcnQgPSBmYWxzZTtcbiAgICAgICAgICAgIGFjbS5nZXRDb21wbGV0ZXIoZWRpdG9yKS5zaG93UG9wdXAoZWRpdG9yKTtcbiAgICAgICAgfVxuICAgIH1cbn07XG5cbmNvbmZpZy5kZWZpbmVPcHRpb25zKEVkaXRvci5wcm90b3R5cGUsICdlZGl0b3InLCB7XG4gICAgZW5hYmxlQmFzaWNBdXRvY29tcGxldGlvbjoge1xuICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbCkge1xuICAgICAgICAgICAgdmFyIGVkaXRvcjogRWRpdG9yID0gdGhpcztcbiAgICAgICAgICAgIGlmICh2YWwpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWVkaXRvci5jb21wbGV0ZXJzKSB7XG4gICAgICAgICAgICAgICAgICAgIGVkaXRvci5jb21wbGV0ZXJzID0gQXJyYXkuaXNBcnJheSh2YWwpID8gdmFsIDogY29tcGxldGVycztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWRpdG9yLmNvbW1hbmRzLmFkZENvbW1hbmQoYWNtLkF1dG9jb21wbGV0ZS5zdGFydENvbW1hbmQpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgZWRpdG9yLmNvbW1hbmRzLnJlbW92ZUNvbW1hbmQoYWNtLkF1dG9jb21wbGV0ZS5zdGFydENvbW1hbmQubmFtZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIHZhbHVlOiBmYWxzZVxuICAgIH0sXG4gICAgLyoqXG4gICAgICogRW5hYmxlIGxpdmUgYXV0b2NvbXBsZXRlLiBJZiB0aGUgdmFsdWUgaXMgYW4gYXJyYXksIGl0IGlzIGFzc3VtZWQgdG8gYmUgYW4gYXJyYXkgb2YgY29tcGxldGVyc1xuICAgICAqIGFuZCB3aWxsIHVzZSB0aGVtIGluc3RlYWQgb2YgdGhlIGRlZmF1bHQgY29tcGxldGVycy5cbiAgICAgKi9cbiAgICBlbmFibGVMaXZlQXV0b2NvbXBsZXRpb246IHtcbiAgICAgICAgc2V0OiBmdW5jdGlvbih2YWwpIHtcbiAgICAgICAgICAgIHZhciBlZGl0b3I6IEVkaXRvciA9IHRoaXM7XG4gICAgICAgICAgICBpZiAodmFsKSB7XG4gICAgICAgICAgICAgICAgaWYgKCFlZGl0b3IuY29tcGxldGVycykge1xuICAgICAgICAgICAgICAgICAgICBlZGl0b3IuY29tcGxldGVycyA9IEFycmF5LmlzQXJyYXkodmFsKSA/IHZhbCA6IGNvbXBsZXRlcnM7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIC8vIE9uIGVhY2ggY2hhbmdlIGF1dG9tYXRpY2FsbHkgdHJpZ2dlciB0aGUgYXV0b2NvbXBsZXRlXG4gICAgICAgICAgICAgICAgZWRpdG9yLmNvbW1hbmRzLm9uKCdhZnRlckV4ZWMnLCBkb0xpdmVBdXRvY29tcGxldGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgZWRpdG9yLmNvbW1hbmRzLm9mZignYWZ0ZXJFeGVjJywgZG9MaXZlQXV0b2NvbXBsZXRlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfSxcbiAgICAgICAgdmFsdWU6IGZhbHNlXG4gICAgfSxcbiAgICBlbmFibGVTbmlwcGV0czoge1xuICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbCkge1xuICAgICAgICAgICAgdmFyIGVkaXRvcjogRWRpdG9yID0gdGhpcztcbiAgICAgICAgICAgIGlmICh2YWwpIHtcbiAgICAgICAgICAgICAgICBlZGl0b3IuY29tbWFuZHMuYWRkQ29tbWFuZChleHBhbmRTbmlwcGV0KTtcbiAgICAgICAgICAgICAgICBlZGl0b3Iub24oXCJjaGFuZ2VNb2RlXCIsIG9uQ2hhbmdlTW9kZSk7XG4gICAgICAgICAgICAgICAgb25DaGFuZ2VNb2RlKG51bGwsIGVkaXRvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBlZGl0b3IuY29tbWFuZHMucmVtb3ZlQ29tbWFuZChleHBhbmRTbmlwcGV0Lm5hbWUpO1xuICAgICAgICAgICAgICAgIGVkaXRvci5vZmYoXCJjaGFuZ2VNb2RlXCIsIG9uQ2hhbmdlTW9kZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIHZhbHVlOiBmYWxzZVxuICAgIH1cbn0pO1xuIl19