import { snippetManager } from "../snippets";
import { getCompleter, setCompleter, CompleterAggregate, Autocomplete } from "../autocomplete";
import { defineOptions, loadModule } from "../config";
import { retrievePrecedingIdentifier } from "../autocomplete/util";
import Editor from "../Editor";
export var keyWordCompleter = {
    getCompletions: function (editor, session, pos, prefix, callback) {
        var state = session.getState(pos.row);
        var completions = session.$mode.getCompletions(state, session, pos, prefix);
        callback(null, completions);
    }
};
export var snippetCompleter = {
    getCompletions: function (editor, session, pos, prefix, callback) {
        var snippetMap = snippetManager.snippetMap;
        var completions = [];
        snippetManager.getActiveScopes(editor).forEach(function (scope) {
            var snippets = snippetMap[scope] || [];
            for (var i = snippets.length; i--;) {
                var s = snippets[i];
                var caption = s.name || s.tabTrigger;
                if (!caption)
                    continue;
                completions.push({
                    caption: caption,
                    snippet: s.content,
                    meta: s.tabTrigger && !s.name ? s.tabTrigger + "\u21E5 " : "snippet"
                });
            }
        }, this);
        callback(null, completions);
    }
};
var completers = [snippetCompleter, keyWordCompleter];
export function addCompleter(completer) {
    completers.push(completer);
}
;
var expandSnippet = {
    name: 'expandSnippet',
    exec: function (editor) {
        var success = snippetManager.expandWithTab(editor);
        if (!success) {
            editor.execCommand('indent');
        }
    },
    bindKey: 'Tab'
};
var onChangeMode = function (e, editor) {
    loadSnippetsForMode(editor.getSession().$mode);
};
var loadSnippetsForMode = function (mode) {
    var id = mode.$id;
    if (!snippetManager['files']) {
        snippetManager['files'] = {};
    }
    loadSnippetFile(id);
    if (mode.modes) {
        mode.modes.forEach(loadSnippetsForMode);
    }
};
var loadSnippetFile = function (id) {
    if (!id || snippetManager['files'][id])
        return;
    var snippetFilePath = id.replace("mode", "snippets");
    snippetManager['files'][id] = {};
    loadModule(snippetFilePath, function (m) {
        if (m) {
            snippetManager['files'][id] = m;
            if (!m.snippets && m.snippetText)
                m.snippets = snippetManager.parseSnippetFile(m.snippetText);
            snippetManager.register(m.snippets || [], m.scope);
            if (m.includeScopes) {
                snippetManager.snippetMap[m.scope].includeScopes = m.includeScopes;
                m.includeScopes.forEach(function (x) {
                    loadSnippetFile("ace/mode/" + x);
                });
            }
        }
    });
};
function getCompletionPrefix(editor) {
    var pos = editor.getCursorPosition();
    var line = editor.getSession().getLine(pos.row);
    var prefix = retrievePrecedingIdentifier(line, pos.column);
    editor.completers.forEach(function (completer) {
        if (completer['identifierRegexps']) {
            completer['identifierRegexps'].forEach(function (identifierRegex) {
                if (!prefix && identifierRegex) {
                    prefix = retrievePrecedingIdentifier(line, pos.column, identifierRegex);
                }
            });
        }
    });
    return prefix;
}
var doLiveAutocomplete = function (e) {
    var editor = e.editor;
    var text = e.args || "";
    var hasCompleter = getCompleter(editor) && getCompleter(editor).activated;
    if (e.command.name === "backspace") {
        if (hasCompleter && !getCompletionPrefix(editor))
            getCompleter(editor).detach();
    }
    else if (e.command.name === "insertstring") {
        var prefix = getCompletionPrefix(editor);
        if (prefix && !hasCompleter) {
            if (!getCompleter(editor)) {
                setCompleter(editor, new CompleterAggregate(editor));
            }
            getCompleter(editor).autoSelect = false;
            getCompleter(editor).autoInsert = false;
            getCompleter(editor).showPopup(editor);
        }
    }
};
defineOptions(Editor.prototype, 'editor', {
    enableBasicAutocompletion: {
        set: function (val) {
            var editor = this;
            if (val) {
                if (!editor.completers) {
                    editor.completers = Array.isArray(val) ? val : completers;
                }
                editor.commands.addCommand(Autocomplete.startCommand);
            }
            else {
                editor.commands.removeCommand(Autocomplete.startCommand.name);
            }
        },
        value: false
    },
    enableLiveAutocompletion: {
        set: function (val) {
            var editor = this;
            if (val) {
                if (!editor.completers) {
                    editor.completers = Array.isArray(val) ? val : completers;
                }
                editor.commands.on('afterExec', doLiveAutocomplete);
            }
            else {
                editor.commands.off('afterExec', doLiveAutocomplete);
            }
        },
        value: false
    },
    enableSnippets: {
        set: function (val) {
            var editor = this;
            if (val) {
                editor.commands.addCommand(expandSnippet);
                editor.on("changeMode", onChangeMode);
                onChangeMode(null, editor);
            }
            else {
                editor.commands.removeCommand(expandSnippet.name);
                editor.off("changeMode", onChangeMode);
            }
        },
        value: false
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGFuZ3VhZ2VfdG9vbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvZXh0L2xhbmd1YWdlX3Rvb2xzLnRzIl0sIm5hbWVzIjpbImFkZENvbXBsZXRlciIsImdldENvbXBsZXRpb25QcmVmaXgiXSwibWFwcGluZ3MiOiJPQStCTyxFQUFDLGNBQWMsRUFBQyxNQUFNLGFBQWE7T0FDbkMsRUFBWSxZQUFZLEVBQUUsWUFBWSxFQUFFLGtCQUFrQixFQUFFLFlBQVksRUFBQyxNQUFNLGlCQUFpQjtPQUNoRyxFQUFDLGFBQWEsRUFBRSxVQUFVLEVBQUMsTUFBTSxXQUFXO09BQzVDLEVBQUMsMkJBQTJCLEVBQUMsTUFBTSxzQkFBc0I7T0FDekQsTUFBTSxNQUFNLFdBQVc7QUFROUIsV0FBVyxnQkFBZ0IsR0FBYztJQUNyQyxjQUFjLEVBQUUsVUFBUyxNQUFjLEVBQUUsT0FBb0IsRUFBRSxHQUFvQyxFQUFFLE1BQWMsRUFBRSxRQUFRO1FBQ3pILElBQUksS0FBSyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ3RDLElBQUksV0FBVyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLEtBQUssRUFBRSxPQUFPLEVBQUUsR0FBRyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQzVFLFFBQVEsQ0FBQyxJQUFJLEVBQUUsV0FBVyxDQUFDLENBQUM7SUFDaEMsQ0FBQztDQUNKLENBQUM7QUFFRixXQUFXLGdCQUFnQixHQUFjO0lBQ3JDLGNBQWMsRUFBRSxVQUFTLE1BQWMsRUFBRSxPQUFvQixFQUFFLEdBQW9DLEVBQUUsTUFBYyxFQUFFLFFBQVE7UUFDekgsSUFBSSxVQUFVLEdBQUcsY0FBYyxDQUFDLFVBQVUsQ0FBQztRQUMzQyxJQUFJLFdBQVcsR0FBRyxFQUFFLENBQUM7UUFDckIsY0FBYyxDQUFDLGVBQWUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBUyxLQUFLO1lBQ3pELElB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U0UgQkxPQ0sgKioqKipcbiAqIERpc3RyaWJ1dGVkIHVuZGVyIHRoZSBCU0QgbGljZW5zZTpcbiAqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTIsIEFqYXgub3JnIEIuVi5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKlxuICogUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0XG4gKiBtb2RpZmljYXRpb24sIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMgYXJlIG1ldDpcbiAqICAgICAqIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0XG4gKiAgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuXG4gKiAgICAgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodFxuICogICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZVxuICogICAgICAgZG9jdW1lbnRhdGlvbiBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi5cbiAqICAgICAqIE5laXRoZXIgdGhlIG5hbWUgb2YgQWpheC5vcmcgQi5WLiBub3IgdGhlXG4gKiAgICAgICBuYW1lcyBvZiBpdHMgY29udHJpYnV0b3JzIG1heSBiZSB1c2VkIHRvIGVuZG9yc2Ugb3IgcHJvbW90ZSBwcm9kdWN0c1xuICogICAgICAgZGVyaXZlZCBmcm9tIHRoaXMgc29mdHdhcmUgd2l0aG91dCBzcGVjaWZpYyBwcmlvciB3cml0dGVuIHBlcm1pc3Npb24uXG4gKlxuICogVEhJUyBTT0ZUV0FSRSBJUyBQUk9WSURFRCBCWSBUSEUgQ09QWVJJR0hUIEhPTERFUlMgQU5EIENPTlRSSUJVVE9SUyBcIkFTIElTXCIgQU5EXG4gKiBBTlkgRVhQUkVTUyBPUiBJTVBMSUVEIFdBUlJBTlRJRVMsIElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBUSEUgSU1QTElFRFxuICogV0FSUkFOVElFUyBPRiBNRVJDSEFOVEFCSUxJVFkgQU5EIEZJVE5FU1MgRk9SIEEgUEFSVElDVUxBUiBQVVJQT1NFIEFSRVxuICogRElTQ0xBSU1FRC4gSU4gTk8gRVZFTlQgU0hBTEwgQUpBWC5PUkcgQi5WLiBCRSBMSUFCTEUgRk9SIEFOWVxuICogRElSRUNULCBJTkRJUkVDVCwgSU5DSURFTlRBTCwgU1BFQ0lBTCwgRVhFTVBMQVJZLCBPUiBDT05TRVFVRU5USUFMIERBTUFHRVNcbiAqIChJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgUFJPQ1VSRU1FTlQgT0YgU1VCU1RJVFVURSBHT09EUyBPUiBTRVJWSUNFUztcbiAqIExPU1MgT0YgVVNFLCBEQVRBLCBPUiBQUk9GSVRTOyBPUiBCVVNJTkVTUyBJTlRFUlJVUFRJT04pIEhPV0VWRVIgQ0FVU0VEIEFORFxuICogT04gQU5ZIFRIRU9SWSBPRiBMSUFCSUxJVFksIFdIRVRIRVIgSU4gQ09OVFJBQ1QsIFNUUklDVCBMSUFCSUxJVFksIE9SIFRPUlRcbiAqIChJTkNMVURJTkcgTkVHTElHRU5DRSBPUiBPVEhFUldJU0UpIEFSSVNJTkcgSU4gQU5ZIFdBWSBPVVQgT0YgVEhFIFVTRSBPRiBUSElTXG4gKiBTT0ZUV0FSRSwgRVZFTiBJRiBBRFZJU0VEIE9GIFRIRSBQT1NTSUJJTElUWSBPRiBTVUNIIERBTUFHRS5cbiAqXG4gKiAqKioqKiBFTkQgTElDRU5TRSBCTE9DSyAqKioqKiAqL1xuXG5pbXBvcnQgQ29tbWFuZCBmcm9tICcuLi9jb21tYW5kcy9Db21tYW5kJztcbmltcG9ydCB7c25pcHBldE1hbmFnZXJ9IGZyb20gXCIuLi9zbmlwcGV0c1wiO1xuaW1wb3J0IHtDb21wbGV0ZXIsIGdldENvbXBsZXRlciwgc2V0Q29tcGxldGVyLCBDb21wbGV0ZXJBZ2dyZWdhdGUsIEF1dG9jb21wbGV0ZX0gZnJvbSBcIi4uL2F1dG9jb21wbGV0ZVwiO1xuaW1wb3J0IHtkZWZpbmVPcHRpb25zLCBsb2FkTW9kdWxlfSBmcm9tIFwiLi4vY29uZmlnXCI7XG5pbXBvcnQge3JldHJpZXZlUHJlY2VkaW5nSWRlbnRpZmllcn0gZnJvbSBcIi4uL2F1dG9jb21wbGV0ZS91dGlsXCI7XG5pbXBvcnQgRWRpdG9yIGZyb20gXCIuLi9FZGl0b3JcIjtcbmltcG9ydCBFZGl0U2Vzc2lvbiBmcm9tICcuLi9FZGl0U2Vzc2lvbic7XG5pbXBvcnQge2dldENvbXBsZXRpb25zfSBmcm9tICcuLi9hdXRvY29tcGxldGUvdGV4dF9jb21wbGV0ZXInO1xuaW1wb3J0IE1vZGUgZnJvbSAnLi4vbW9kZS9Nb2RlJztcblxuLy8gRXhwb3J0cyBleGlzdGluZyBjb21wbGV0ZXIgc28gdGhhdCB1c2VyIGNhbiBjb25zdHJ1Y3QgaGlzIG93biBzZXQgb2YgY29tcGxldGVycy5cbi8vIGV4cG9ydCB2YXIgdGV4dENvbXBsZXRlcjogYWNtLkNvbXBsZXRlciA9IHRjbTtcblxuZXhwb3J0IHZhciBrZXlXb3JkQ29tcGxldGVyOiBDb21wbGV0ZXIgPSB7XG4gICAgZ2V0Q29tcGxldGlvbnM6IGZ1bmN0aW9uKGVkaXRvcjogRWRpdG9yLCBzZXNzaW9uOiBFZGl0U2Vzc2lvbiwgcG9zOiB7IHJvdzogbnVtYmVyOyBjb2x1bW46IG51bWJlciB9LCBwcmVmaXg6IHN0cmluZywgY2FsbGJhY2spIHtcbiAgICAgICAgdmFyIHN0YXRlID0gc2Vzc2lvbi5nZXRTdGF0ZShwb3Mucm93KTtcbiAgICAgICAgdmFyIGNvbXBsZXRpb25zID0gc2Vzc2lvbi4kbW9kZS5nZXRDb21wbGV0aW9ucyhzdGF0ZSwgc2Vzc2lvbiwgcG9zLCBwcmVmaXgpO1xuICAgICAgICBjYWxsYmFjayhudWxsLCBjb21wbGV0aW9ucyk7XG4gICAgfVxufTtcblxuZXhwb3J0IHZhciBzbmlwcGV0Q29tcGxldGVyOiBDb21wbGV0ZXIgPSB7XG4gICAgZ2V0Q29tcGxldGlvbnM6IGZ1bmN0aW9uKGVkaXRvcjogRWRpdG9yLCBzZXNzaW9uOiBFZGl0U2Vzc2lvbiwgcG9zOiB7IHJvdzogbnVtYmVyOyBjb2x1bW46IG51bWJlciB9LCBwcmVmaXg6IHN0cmluZywgY2FsbGJhY2spIHtcbiAgICAgICAgdmFyIHNuaXBwZXRNYXAgPSBzbmlwcGV0TWFuYWdlci5zbmlwcGV0TWFwO1xuICAgICAgICB2YXIgY29tcGxldGlvbnMgPSBbXTtcbiAgICAgICAgc25pcHBldE1hbmFnZXIuZ2V0QWN0aXZlU2NvcGVzKGVkaXRvcikuZm9yRWFjaChmdW5jdGlvbihzY29wZSkge1xuICAgICAgICAgICAgdmFyIHNuaXBwZXRzID0gc25pcHBldE1hcFtzY29wZV0gfHwgW107XG4gICAgICAgICAgICBmb3IgKHZhciBpID0gc25pcHBldHMubGVuZ3RoOyBpLS07KSB7XG4gICAgICAgICAgICAgICAgdmFyIHMgPSBzbmlwcGV0c1tpXTtcbiAgICAgICAgICAgICAgICB2YXIgY2FwdGlvbiA9IHMubmFtZSB8fCBzLnRhYlRyaWdnZXI7XG4gICAgICAgICAgICAgICAgaWYgKCFjYXB0aW9uKVxuICAgICAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgICAgICBjb21wbGV0aW9ucy5wdXNoKHtcbiAgICAgICAgICAgICAgICAgICAgY2FwdGlvbjogY2FwdGlvbixcbiAgICAgICAgICAgICAgICAgICAgc25pcHBldDogcy5jb250ZW50LFxuICAgICAgICAgICAgICAgICAgICBtZXRhOiBzLnRhYlRyaWdnZXIgJiYgIXMubmFtZSA/IHMudGFiVHJpZ2dlciArIFwiXFx1MjFFNSBcIiA6IFwic25pcHBldFwiXG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sIHRoaXMpO1xuICAgICAgICBjYWxsYmFjayhudWxsLCBjb21wbGV0aW9ucyk7XG4gICAgfVxufTtcblxudmFyIGNvbXBsZXRlcnM6IENvbXBsZXRlcltdID0gW3NuaXBwZXRDb21wbGV0ZXIvKiwgdGV4dENvbXBsZXRlciovLCBrZXlXb3JkQ29tcGxldGVyXTtcblxuZXhwb3J0IGZ1bmN0aW9uIGFkZENvbXBsZXRlcihjb21wbGV0ZXI6IENvbXBsZXRlcikge1xuICAgIGNvbXBsZXRlcnMucHVzaChjb21wbGV0ZXIpO1xufTtcblxudmFyIGV4cGFuZFNuaXBwZXQ6IENvbW1hbmQgPSB7XG4gICAgbmFtZTogJ2V4cGFuZFNuaXBwZXQnLFxuICAgIGV4ZWM6IGZ1bmN0aW9uKGVkaXRvcjogRWRpdG9yKSB7XG4gICAgICAgIHZhciBzdWNjZXNzID0gc25pcHBldE1hbmFnZXIuZXhwYW5kV2l0aFRhYihlZGl0b3IpO1xuICAgICAgICBpZiAoIXN1Y2Nlc3MpIHtcbiAgICAgICAgICAgIGVkaXRvci5leGVjQ29tbWFuZCgnaW5kZW50Jyk7XG4gICAgICAgIH1cbiAgICB9LFxuICAgIGJpbmRLZXk6ICdUYWInXG59O1xuXG52YXIgb25DaGFuZ2VNb2RlID0gZnVuY3Rpb24oZSwgZWRpdG9yOiBFZGl0b3IpIHtcbiAgICBsb2FkU25pcHBldHNGb3JNb2RlKGVkaXRvci5nZXRTZXNzaW9uKCkuJG1vZGUpO1xufTtcblxudmFyIGxvYWRTbmlwcGV0c0Zvck1vZGUgPSBmdW5jdGlvbihtb2RlOiBNb2RlKSB7XG4gICAgdmFyIGlkID0gbW9kZS4kaWQ7XG4gICAgaWYgKCFzbmlwcGV0TWFuYWdlclsnZmlsZXMnXSkge1xuICAgICAgICBzbmlwcGV0TWFuYWdlclsnZmlsZXMnXSA9IHt9O1xuICAgIH1cbiAgICBsb2FkU25pcHBldEZpbGUoaWQpO1xuICAgIGlmIChtb2RlLm1vZGVzKSB7XG4gICAgICAgIG1vZGUubW9kZXMuZm9yRWFjaChsb2FkU25pcHBldHNGb3JNb2RlKTtcbiAgICB9XG59O1xuXG52YXIgbG9hZFNuaXBwZXRGaWxlID0gZnVuY3Rpb24oaWQ6IHN0cmluZykge1xuICAgIGlmICghaWQgfHwgc25pcHBldE1hbmFnZXJbJ2ZpbGVzJ11baWRdKVxuICAgICAgICByZXR1cm47XG4gICAgdmFyIHNuaXBwZXRGaWxlUGF0aCA9IGlkLnJlcGxhY2UoXCJtb2RlXCIsIFwic25pcHBldHNcIik7XG4gICAgc25pcHBldE1hbmFnZXJbJ2ZpbGVzJ11baWRdID0ge307XG4gICAgbG9hZE1vZHVsZShzbmlwcGV0RmlsZVBhdGgsIGZ1bmN0aW9uKG0pIHtcbiAgICAgICAgaWYgKG0pIHtcbiAgICAgICAgICAgIHNuaXBwZXRNYW5hZ2VyWydmaWxlcyddW2lkXSA9IG07XG4gICAgICAgICAgICBpZiAoIW0uc25pcHBldHMgJiYgbS5zbmlwcGV0VGV4dClcbiAgICAgICAgICAgICAgICBtLnNuaXBwZXRzID0gc25pcHBldE1hbmFnZXIucGFyc2VTbmlwcGV0RmlsZShtLnNuaXBwZXRUZXh0KTtcbiAgICAgICAgICAgIHNuaXBwZXRNYW5hZ2VyLnJlZ2lzdGVyKG0uc25pcHBldHMgfHwgW10sIG0uc2NvcGUpO1xuICAgICAgICAgICAgaWYgKG0uaW5jbHVkZVNjb3Blcykge1xuICAgICAgICAgICAgICAgIHNuaXBwZXRNYW5hZ2VyLnNuaXBwZXRNYXBbbS5zY29wZV0uaW5jbHVkZVNjb3BlcyA9IG0uaW5jbHVkZVNjb3BlcztcbiAgICAgICAgICAgICAgICBtLmluY2x1ZGVTY29wZXMuZm9yRWFjaChmdW5jdGlvbih4KSB7XG4gICAgICAgICAgICAgICAgICAgIGxvYWRTbmlwcGV0RmlsZShcImFjZS9tb2RlL1wiICsgeCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9KTtcbn07XG5cbmZ1bmN0aW9uIGdldENvbXBsZXRpb25QcmVmaXgoZWRpdG9yOiBFZGl0b3IpIHtcbiAgICB2YXIgcG9zID0gZWRpdG9yLmdldEN1cnNvclBvc2l0aW9uKCk7XG4gICAgdmFyIGxpbmUgPSBlZGl0b3IuZ2V0U2Vzc2lvbigpLmdldExpbmUocG9zLnJvdyk7XG4gICAgdmFyIHByZWZpeCA9IHJldHJpZXZlUHJlY2VkaW5nSWRlbnRpZmllcihsaW5lLCBwb3MuY29sdW1uKTtcbiAgICAvLyBUcnkgdG8gZmluZCBjdXN0b20gcHJlZml4ZXMgb24gdGhlIGNvbXBsZXRlcnNcbiAgICBlZGl0b3IuY29tcGxldGVycy5mb3JFYWNoKGZ1bmN0aW9uKGNvbXBsZXRlcikge1xuICAgICAgICBpZiAoY29tcGxldGVyWydpZGVudGlmaWVyUmVnZXhwcyddKSB7XG4gICAgICAgICAgICBjb21wbGV0ZXJbJ2lkZW50aWZpZXJSZWdleHBzJ10uZm9yRWFjaChmdW5jdGlvbihpZGVudGlmaWVyUmVnZXgpIHtcbiAgICAgICAgICAgICAgICBpZiAoIXByZWZpeCAmJiBpZGVudGlmaWVyUmVnZXgpIHtcbiAgICAgICAgICAgICAgICAgICAgcHJlZml4ID0gcmV0cmlldmVQcmVjZWRpbmdJZGVudGlmaWVyKGxpbmUsIHBvcy5jb2x1bW4sIGlkZW50aWZpZXJSZWdleCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICB9KTtcbiAgICByZXR1cm4gcHJlZml4O1xufVxuXG52YXIgZG9MaXZlQXV0b2NvbXBsZXRlID0gZnVuY3Rpb24oZTogeyBlZGl0b3I6IEVkaXRvcjsgY29tbWFuZDogeyBuYW1lOiBzdHJpbmcgfTsgYXJncyB9KSB7XG4gICAgdmFyIGVkaXRvciA9IGUuZWRpdG9yO1xuICAgIHZhciB0ZXh0ID0gZS5hcmdzIHx8IFwiXCI7XG4gICAgdmFyIGhhc0NvbXBsZXRlciA9IGdldENvbXBsZXRlcihlZGl0b3IpICYmIGdldENvbXBsZXRlcihlZGl0b3IpLmFjdGl2YXRlZDtcblxuICAgIC8vIFdlIGRvbid0IHdhbnQgdG8gYXV0b2NvbXBsZXRlIHdpdGggbm8gcHJlZml4XG4gICAgaWYgKGUuY29tbWFuZC5uYW1lID09PSBcImJhY2tzcGFjZVwiKSB7XG4gICAgICAgIGlmIChoYXNDb21wbGV0ZXIgJiYgIWdldENvbXBsZXRpb25QcmVmaXgoZWRpdG9yKSlcbiAgICAgICAgICAgIGdldENvbXBsZXRlcihlZGl0b3IpLmRldGFjaCgpO1xuICAgIH1cbiAgICBlbHNlIGlmIChlLmNvbW1hbmQubmFtZSA9PT0gXCJpbnNlcnRzdHJpbmdcIikge1xuICAgICAgICB2YXIgcHJlZml4ID0gZ2V0Q29tcGxldGlvblByZWZpeChlZGl0b3IpO1xuICAgICAgICAvLyBPbmx5IGF1dG9jb21wbGV0ZSBpZiB0aGVyZSdzIGEgcHJlZml4IHRoYXQgY2FuIGJlIG1hdGNoZWRcbiAgICAgICAgaWYgKHByZWZpeCAmJiAhaGFzQ29tcGxldGVyKSB7XG4gICAgICAgICAgICBpZiAoIWdldENvbXBsZXRlcihlZGl0b3IpKSB7XG4gICAgICAgICAgICAgICAgc2V0Q29tcGxldGVyKGVkaXRvciwgbmV3IENvbXBsZXRlckFnZ3JlZ2F0ZShlZGl0b3IpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIC8vIERpc2FibGUgYXV0b0luc2VydFxuICAgICAgICAgICAgZ2V0Q29tcGxldGVyKGVkaXRvcikuYXV0b1NlbGVjdCA9IGZhbHNlO1xuICAgICAgICAgICAgZ2V0Q29tcGxldGVyKGVkaXRvcikuYXV0b0luc2VydCA9IGZhbHNlO1xuICAgICAgICAgICAgZ2V0Q29tcGxldGVyKGVkaXRvcikuc2hvd1BvcHVwKGVkaXRvcik7XG4gICAgICAgIH1cbiAgICB9XG59O1xuXG5kZWZpbmVPcHRpb25zKEVkaXRvci5wcm90b3R5cGUsICdlZGl0b3InLCB7XG4gICAgZW5hYmxlQmFzaWNBdXRvY29tcGxldGlvbjoge1xuICAgICAgICBzZXQ6IGZ1bmN0aW9uKHZhbCkge1xuICAgICAgICAgICAgdmFyIGVkaXRvcjogRWRpdG9yID0gdGhpcztcbiAgICAgICAgICAgIGlmICh2YWwpIHtcbiAgICAgICAgICAgICAgICBpZiAoIWVkaXRvci5jb21wbGV0ZXJzKSB7XG4gICAgICAgICAgICAgICAgICAgIGVkaXRvci5jb21wbGV0ZXJzID0gQXJyYXkuaXNBcnJheSh2YWwpID8gdmFsIDogY29tcGxldGVycztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWRpdG9yLmNvbW1hbmRzLmFkZENvbW1hbmQoQXV0b2NvbXBsZXRlLnN0YXJ0Q29tbWFuZCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBlZGl0b3IuY29tbWFuZHMucmVtb3ZlQ29tbWFuZChBdXRvY29tcGxldGUuc3RhcnRDb21tYW5kLm5hbWUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICB2YWx1ZTogZmFsc2VcbiAgICB9LFxuICAgIC8qKlxuICAgICAqIEVuYWJsZSBsaXZlIGF1dG9jb21wbGV0ZS4gSWYgdGhlIHZhbHVlIGlzIGFuIGFycmF5LCBpdCBpcyBhc3N1bWVkIHRvIGJlIGFuIGFycmF5IG9mIGNvbXBsZXRlcnNcbiAgICAgKiBhbmQgd2lsbCB1c2UgdGhlbSBpbnN0ZWFkIG9mIHRoZSBkZWZhdWx0IGNvbXBsZXRlcnMuXG4gICAgICovXG4gICAgZW5hYmxlTGl2ZUF1dG9jb21wbGV0aW9uOiB7XG4gICAgICAgIHNldDogZnVuY3Rpb24odmFsKSB7XG4gICAgICAgICAgICB2YXIgZWRpdG9yOiBFZGl0b3IgPSB0aGlzO1xuICAgICAgICAgICAgaWYgKHZhbCkge1xuICAgICAgICAgICAgICAgIGlmICghZWRpdG9yLmNvbXBsZXRlcnMpIHtcbiAgICAgICAgICAgICAgICAgICAgZWRpdG9yLmNvbXBsZXRlcnMgPSBBcnJheS5pc0FycmF5KHZhbCkgPyB2YWwgOiBjb21wbGV0ZXJzO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAvLyBPbiBlYWNoIGNoYW5nZSBhdXRvbWF0aWNhbGx5IHRyaWdnZXIgdGhlIGF1dG9jb21wbGV0ZVxuICAgICAgICAgICAgICAgIGVkaXRvci5jb21tYW5kcy5vbignYWZ0ZXJFeGVjJywgZG9MaXZlQXV0b2NvbXBsZXRlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIGVkaXRvci5jb21tYW5kcy5vZmYoJ2FmdGVyRXhlYycsIGRvTGl2ZUF1dG9jb21wbGV0ZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIHZhbHVlOiBmYWxzZVxuICAgIH0sXG4gICAgZW5hYmxlU25pcHBldHM6IHtcbiAgICAgICAgc2V0OiBmdW5jdGlvbih2YWwpIHtcbiAgICAgICAgICAgIHZhciBlZGl0b3I6IEVkaXRvciA9IHRoaXM7XG4gICAgICAgICAgICBpZiAodmFsKSB7XG4gICAgICAgICAgICAgICAgZWRpdG9yLmNvbW1hbmRzLmFkZENvbW1hbmQoZXhwYW5kU25pcHBldCk7XG4gICAgICAgICAgICAgICAgZWRpdG9yLm9uKFwiY2hhbmdlTW9kZVwiLCBvbkNoYW5nZU1vZGUpO1xuICAgICAgICAgICAgICAgIG9uQ2hhbmdlTW9kZShudWxsLCBlZGl0b3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgZWRpdG9yLmNvbW1hbmRzLnJlbW92ZUNvbW1hbmQoZXhwYW5kU25pcHBldC5uYW1lKTtcbiAgICAgICAgICAgICAgICBlZGl0b3Iub2ZmKFwiY2hhbmdlTW9kZVwiLCBvbkNoYW5nZU1vZGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICB2YWx1ZTogZmFsc2VcbiAgICB9XG59KTtcbiJdfQ==