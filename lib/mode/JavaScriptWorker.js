import { mixin } from "../lib/oop";
import Mirror from "../worker/Mirror";
import { JSHINT } from "./javascript/jshint";
function startRegex(arr) {
    return RegExp("^(" + arr.join("|") + ")");
}
var disabledWarningsRe = startRegex([
    "Bad for in variable '(.+)'.",
    'Missing "use strict"'
]);
var errorsRe = startRegex([
    "Unexpected",
    "Expected ",
    "Confusing (plus|minus)",
    "\\{a\\} unterminated regular expression",
    "Unclosed ",
    "Unmatched ",
    "Unbegun comment",
    "Bad invocation",
    "Missing space after",
    "Missing operator at"
]);
var infoRe = startRegex([
    "Expected an assignment",
    "Bad escapement of EOL",
    "Unexpected comma",
    "Unexpected space",
    "Missing radix parameter.",
    "A leading decimal point can",
    "\\['{a}'\\] is better written in dot notation.",
    "'{a}' used out of scope"
]);
export default class JavaScriptWorker extends Mirror {
    constructor(sender) {
        super(sender);
        this.setOptions();
        sender.emit('initAfter');
    }
    setOptions(options) {
        this.options = options || {
            esnext: true,
            moz: true,
            devel: true,
            browser: true,
            node: true,
            laxcomma: true,
            laxbreak: true,
            lastsemic: true,
            onevar: false,
            passfail: false,
            maxerr: 100,
            expr: true,
            multistr: true,
            globalstrict: true
        };
        this.doc.getValue() && this.deferredUpdate.schedule(100);
    }
    changeOptions(newOptions) {
        mixin(this.options, newOptions);
        this.doc.getValue() && this.deferredUpdate.schedule(100);
    }
    isValidJS(str) {
        try {
            eval("throw 0;" + str);
        }
        catch (e) {
            if (e === 0)
                return true;
        }
        return false;
    }
    onUpdate() {
        var value = this.doc.getValue();
        value = value.replace(/^#!.*\n/, "\n");
        if (!value) {
            this.sender.emit("errors", []);
            return;
        }
        var errors = [];
        var maxErrorLevel = this.isValidJS(value) ? "warning" : "error";
        JSHINT(value, this.options);
        var results = JSHINT.errors;
        var errorAdded = false;
        for (var i = 0; i < results.length; i++) {
            var error = results[i];
            if (!error)
                continue;
            var raw = error.raw;
            var type = "warning";
            if (raw == "Missing semicolon.") {
                var str = error.evidence.substr(error.character);
                str = str.charAt(str.search(/\S/));
                if (maxErrorLevel == "error" && str && /[\w\d{(['"]/.test(str)) {
                    error.reason = 'Missing ";" before statement';
                    type = "error";
                }
                else {
                    type = "info";
                }
            }
            else if (disabledWarningsRe.test(raw)) {
                continue;
            }
            else if (infoRe.test(raw)) {
                type = "info";
            }
            else if (errorsRe.test(raw)) {
                errorAdded = true;
                type = maxErrorLevel;
            }
            else if (raw === "'{a}' is not defined.") {
                type = "warning";
            }
            else if (raw === "'{a}' is defined but never used.") {
                type = "info";
            }
            errors.push({
                row: error.line - 1,
                column: error.character - 1,
                text: error.reason,
                type: type
            });
            if (errorAdded) {
            }
        }
        this.sender.emit("errors", errors);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSmF2YVNjcmlwdFdvcmtlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tb2RlL0phdmFTY3JpcHRXb3JrZXIudHMiXSwibmFtZXMiOlsic3RhcnRSZWdleCIsIkphdmFTY3JpcHRXb3JrZXIiLCJKYXZhU2NyaXB0V29ya2VyLmNvbnN0cnVjdG9yIiwiSmF2YVNjcmlwdFdvcmtlci5zZXRPcHRpb25zIiwiSmF2YVNjcmlwdFdvcmtlci5jaGFuZ2VPcHRpb25zIiwiSmF2YVNjcmlwdFdvcmtlci5pc1ZhbGlkSlMiLCJKYXZhU2NyaXB0V29ya2VyLm9uVXBkYXRlIl0sIm1hcHBpbmdzIjoiT0FBTyxFQUFDLEtBQUssRUFBQyxNQUFNLFlBQVk7T0FFekIsTUFBTSxNQUFNLGtCQUFrQjtPQUc5QixFQUFDLE1BQU0sRUFBQyxNQUFNLHFCQUFxQjtBQUkxQyxvQkFBb0IsR0FBRztJQUNyQkEsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsR0FBR0EsR0FBR0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7QUFDNUNBLENBQUNBO0FBRUQsSUFBSSxrQkFBa0IsR0FBRyxVQUFVLENBQUM7SUFDbEMsNkJBQTZCO0lBQzdCLHNCQUFzQjtDQUN2QixDQUFDLENBQUM7QUFFSCxJQUFJLFFBQVEsR0FBRyxVQUFVLENBQUM7SUFDeEIsWUFBWTtJQUNaLFdBQVc7SUFDWCx3QkFBd0I7SUFDeEIseUNBQXlDO0lBQ3pDLFdBQVc7SUFDWCxZQUFZO0lBQ1osaUJBQWlCO0lBQ2pCLGdCQUFnQjtJQUNoQixxQkFBcUI7SUFDckIscUJBQXFCO0NBQ3RCLENBQUMsQ0FBQztBQUNILElBQUksTUFBTSxHQUFHLFVBQVUsQ0FBQztJQUN0Qix3QkFBd0I7SUFDeEIsdUJBQXVCO0lBQ3ZCLGtCQUFrQjtJQUNsQixrQkFBa0I7SUFDbEIsMEJBQTBCO0lBQzFCLDZCQUE2QjtJQUM3QixnREFBZ0Q7SUFDaEQseUJBQXlCO0NBQzFCLENBQUMsQ0FBQztBQUVILDhDQUE4QyxNQUFNO0lBRWxEQyxZQUFZQSxNQUFjQTtRQUN4QkMsTUFBTUEsTUFBTUEsQ0FBQ0EsQ0FBQ0E7UUFDZEEsSUFBSUEsQ0FBQ0EsVUFBVUEsRUFBRUEsQ0FBQ0E7UUFDbEJBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLENBQUNBO0lBQzNCQSxDQUFDQTtJQUVERCxVQUFVQSxDQUFDQSxPQUFZQTtRQUNyQkUsSUFBSUEsQ0FBQ0EsT0FBT0EsR0FBR0EsT0FBT0EsSUFBSUE7WUFHeEJBLE1BQU1BLEVBQUVBLElBQUlBO1lBQ1pBLEdBQUdBLEVBQUVBLElBQUlBO1lBQ1RBLEtBQUtBLEVBQUVBLElBQUlBO1lBQ1hBLE9BQU9BLEVBQUVBLElBQUlBO1lBQ2JBLElBQUlBLEVBQUVBLElBQUlBO1lBQ1ZBLFFBQVFBLEVBQUVBLElBQUlBO1lBQ2RBLFFBQVFBLEVBQUVBLElBQUlBO1lBQ2RBLFNBQVNBLEVBQUVBLElBQUlBO1lBQ2ZBLE1BQU1BLEVBQUVBLEtBQUtBO1lBQ2JBLFFBQVFBLEVBQUVBLEtBQUtBO1lBQ2ZBLE1BQU1BLEVBQUVBLEdBQUdBO1lBQ1hBLElBQUlBLEVBQUVBLElBQUlBO1lBQ1ZBLFFBQVFBLEVBQUVBLElBQUlBO1lBQ2RBLFlBQVlBLEVBQUVBLElBQUlBO1NBQ25CQSxDQUFDQTtRQUNGQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQSxRQUFRQSxFQUFFQSxJQUFJQSxJQUFJQSxDQUFDQSxjQUFjQSxDQUFDQSxRQUFRQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQTtJQUMzREEsQ0FBQ0E7SUFFREYsYUFBYUEsQ0FBQ0EsVUFBVUE7UUFDdEJHLEtBQUtBLENBQUNBLElBQUlBLENBQUNBLE9BQU9BLEVBQUVBLFVBQVVBLENBQUNBLENBQUNBO1FBQ2hDQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQSxRQUFRQSxFQUFFQSxJQUFJQSxJQUFJQSxDQUFDQSxjQUFjQSxDQUFDQSxRQUFRQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQTtJQUMzREEsQ0FBQ0E7SUFFREgsU0FBU0EsQ0FBQ0EsR0FBV0E7UUFDbkJJLElBQUlBLENBQUNBO1lBRUhBLElBQUlBLENBQUNBLFVBQVVBLEdBQUdBLEdBQUdBLENBQUNBLENBQUNBO1FBQ3pCQSxDQUNBQTtRQUFBQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNUQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxLQUFLQSxDQUFDQSxDQUFDQTtnQkFDVkEsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7UUFDaEJBLENBQUNBO1FBQ0RBLE1BQU1BLENBQUNBLEtBQUtBLENBQUFBO0lBQ2RBLENBQUNBO0lBRURKLFFBQVFBO1FBQ05LLElBQUlBLEtBQUtBLEdBQUdBLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLFFBQVFBLEVBQUVBLENBQUNBO1FBQ2hDQSxLQUFLQSxHQUFHQSxLQUFLQSxDQUFDQSxPQUFPQSxDQUFDQSxTQUFTQSxFQUFFQSxJQUFJQSxDQUFDQSxDQUFDQTtRQUN2Q0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDWEEsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsUUFBUUEsRUFBRUEsRUFBRUEsQ0FBQ0EsQ0FBQ0E7WUFDL0JBLE1BQU1BLENBQUNBO1FBQ1RBLENBQUNBO1FBQ0RBLElBQUlBLE1BQU1BLEdBQWlCQSxFQUFFQSxDQUFDQTtRQUk5QkEsSUFBSUEsYUFBYUEsR0FBR0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsR0FBR0EsU0FBU0EsR0FBR0EsT0FBT0EsQ0FBQ0E7UUFHaEVBLE1BQU1BLENBQUNBLEtBQUtBLEVBQUVBLElBQUlBLENBQUNBLE9BQU9BLENBQUNBLENBQUNBO1FBQzVCQSxJQUFJQSxPQUFPQSxHQUFrQkEsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0E7UUFFM0NBLElBQUlBLFVBQVVBLEdBQUdBLEtBQUtBLENBQUFBO1FBQ3RCQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxFQUFFQSxDQUFDQSxHQUFHQSxPQUFPQSxDQUFDQSxNQUFNQSxFQUFFQSxDQUFDQSxFQUFFQSxFQUFFQSxDQUFDQTtZQUN4Q0EsSUFBSUEsS0FBS0EsR0FBR0EsT0FBT0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDdkJBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLEtBQUtBLENBQUNBO2dCQUNUQSxRQUFRQSxDQUFDQTtZQUNYQSxJQUFJQSxHQUFHQSxHQUFHQSxLQUFLQSxDQUFDQSxHQUFHQSxDQUFDQTtZQUNwQkEsSUFBSUEsSUFBSUEsR0FBR0EsU0FBU0EsQ0FBQ0E7WUFFckJBLEVBQUVBLENBQUNBLENBQUNBLEdBQUdBLElBQUlBLG9CQUFvQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ2hDQSxJQUFJQSxHQUFHQSxHQUFHQSxLQUFLQSxDQUFDQSxRQUFRQSxDQUFDQSxNQUFNQSxDQUFDQSxLQUFLQSxDQUFDQSxTQUFTQSxDQUFDQSxDQUFDQTtnQkFDakRBLEdBQUdBLEdBQUdBLEdBQUdBLENBQUNBLE1BQU1BLENBQUNBLEdBQUdBLENBQUNBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLENBQUNBLENBQUNBO2dCQUNuQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsYUFBYUEsSUFBSUEsT0FBT0EsSUFBSUEsR0FBR0EsSUFBSUEsYUFBYUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7b0JBQy9EQSxLQUFLQSxDQUFDQSxNQUFNQSxHQUFHQSw4QkFBOEJBLENBQUNBO29CQUM5Q0EsSUFBSUEsR0FBR0EsT0FBT0EsQ0FBQ0E7Z0JBQ2pCQSxDQUFDQTtnQkFDREEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7b0JBQ0pBLElBQUlBLEdBQUdBLE1BQU1BLENBQUNBO2dCQUNoQkEsQ0FBQ0E7WUFDSEEsQ0FBQ0E7WUFDREEsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0Esa0JBQWtCQSxDQUFDQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDdENBLFFBQVFBLENBQUNBO1lBQ1hBLENBQUNBO1lBQ0RBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO2dCQUMxQkEsSUFBSUEsR0FBR0EsTUFBTUEsQ0FBQUE7WUFDZkEsQ0FBQ0E7WUFDREEsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQzVCQSxVQUFVQSxHQUFHQSxJQUFJQSxDQUFDQTtnQkFDbEJBLElBQUlBLEdBQUdBLGFBQWFBLENBQUNBO1lBQ3ZCQSxDQUFDQTtZQUNEQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxHQUFHQSxLQUFLQSx1QkFBdUJBLENBQUNBLENBQUNBLENBQUNBO2dCQUN6Q0EsSUFBSUEsR0FBR0EsU0FBU0EsQ0FBQ0E7WUFDbkJBLENBQUNBO1lBQ0RBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLEdBQUdBLEtBQUtBLGtDQUFrQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ3BEQSxJQUFJQSxHQUFHQSxNQUFNQSxDQUFDQTtZQUNoQkEsQ0FBQ0E7WUFFREEsTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7Z0JBQ1ZBLEdBQUdBLEVBQUVBLEtBQUtBLENBQUNBLElBQUlBLEdBQUdBLENBQUNBO2dCQUNuQkEsTUFBTUEsRUFBRUEsS0FBS0EsQ0FBQ0EsU0FBU0EsR0FBR0EsQ0FBQ0E7Z0JBQzNCQSxJQUFJQSxFQUFFQSxLQUFLQSxDQUFDQSxNQUFNQTtnQkFDbEJBLElBQUlBLEVBQUVBLElBQUlBO2FBQ1hBLENBQUNBLENBQUNBO1lBRUhBLEVBQUVBLENBQUNBLENBQUNBLFVBQVVBLENBQUNBLENBQUNBLENBQUNBO1lBRWpCQSxDQUFDQTtRQUNIQSxDQUFDQTtRQUVEQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxRQUFRQSxFQUFFQSxNQUFNQSxDQUFDQSxDQUFDQTtJQUNyQ0EsQ0FBQ0E7QUFDSEwsQ0FBQ0E7QUFBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7bWl4aW59IGZyb20gXCIuLi9saWIvb29wXCI7XG5pbXBvcnQgQW5ub3RhdGlvbiBmcm9tIFwiLi4vQW5ub3RhdGlvblwiO1xuaW1wb3J0IE1pcnJvciBmcm9tIFwiLi4vd29ya2VyL01pcnJvclwiO1xuaW1wb3J0IFNlbmRlciBmcm9tIFwiLi4vbGliL1NlbmRlclwiO1xuXG5pbXBvcnQge0pTSElOVH0gZnJvbSBcIi4vamF2YXNjcmlwdC9qc2hpbnRcIjtcbmltcG9ydCBKU0hpbnRPcHRpb25zIGZyb20gXCIuL2phdmFzY3JpcHQvSlNIaW50T3B0aW9uc1wiO1xuaW1wb3J0IEpTSGludEVycm9yIGZyb20gXCIuL2phdmFzY3JpcHQvSlNIaW50RXJyb3JcIjtcblxuZnVuY3Rpb24gc3RhcnRSZWdleChhcnIpIHtcbiAgcmV0dXJuIFJlZ0V4cChcIl4oXCIgKyBhcnIuam9pbihcInxcIikgKyBcIilcIik7XG59XG5cbnZhciBkaXNhYmxlZFdhcm5pbmdzUmUgPSBzdGFydFJlZ2V4KFtcbiAgXCJCYWQgZm9yIGluIHZhcmlhYmxlICcoLispJy5cIixcbiAgJ01pc3NpbmcgXCJ1c2Ugc3RyaWN0XCInXG5dKTtcblxudmFyIGVycm9yc1JlID0gc3RhcnRSZWdleChbXG4gIFwiVW5leHBlY3RlZFwiLFxuICBcIkV4cGVjdGVkIFwiLFxuICBcIkNvbmZ1c2luZyAocGx1c3xtaW51cylcIixcbiAgXCJcXFxce2FcXFxcfSB1bnRlcm1pbmF0ZWQgcmVndWxhciBleHByZXNzaW9uXCIsXG4gIFwiVW5jbG9zZWQgXCIsXG4gIFwiVW5tYXRjaGVkIFwiLFxuICBcIlVuYmVndW4gY29tbWVudFwiLFxuICBcIkJhZCBpbnZvY2F0aW9uXCIsXG4gIFwiTWlzc2luZyBzcGFjZSBhZnRlclwiLFxuICBcIk1pc3Npbmcgb3BlcmF0b3IgYXRcIlxuXSk7XG52YXIgaW5mb1JlID0gc3RhcnRSZWdleChbXG4gIFwiRXhwZWN0ZWQgYW4gYXNzaWdubWVudFwiLFxuICBcIkJhZCBlc2NhcGVtZW50IG9mIEVPTFwiLFxuICBcIlVuZXhwZWN0ZWQgY29tbWFcIixcbiAgXCJVbmV4cGVjdGVkIHNwYWNlXCIsXG4gIFwiTWlzc2luZyByYWRpeCBwYXJhbWV0ZXIuXCIsXG4gIFwiQSBsZWFkaW5nIGRlY2ltYWwgcG9pbnQgY2FuXCIsXG4gIFwiXFxcXFsne2F9J1xcXFxdIGlzIGJldHRlciB3cml0dGVuIGluIGRvdCBub3RhdGlvbi5cIixcbiAgXCIne2F9JyB1c2VkIG91dCBvZiBzY29wZVwiXG5dKTtcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSmF2YVNjcmlwdFdvcmtlciBleHRlbmRzIE1pcnJvciB7XG4gIG9wdGlvbnM6IEpTSGludE9wdGlvbnM7XG4gIGNvbnN0cnVjdG9yKHNlbmRlcjogU2VuZGVyKSB7XG4gICAgc3VwZXIoc2VuZGVyKTtcbiAgICB0aGlzLnNldE9wdGlvbnMoKTtcbiAgICBzZW5kZXIuZW1pdCgnaW5pdEFmdGVyJyk7XG4gIH1cblxuICBzZXRPcHRpb25zKG9wdGlvbnM/OiB7fSkge1xuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnMgfHwge1xuICAgICAgLy8gdW5kZWY6IHRydWUsXG4gICAgICAvLyB1bnVzZWQ6IHRydWUsXG4gICAgICBlc25leHQ6IHRydWUsXG4gICAgICBtb3o6IHRydWUsXG4gICAgICBkZXZlbDogdHJ1ZSxcbiAgICAgIGJyb3dzZXI6IHRydWUsXG4gICAgICBub2RlOiB0cnVlLFxuICAgICAgbGF4Y29tbWE6IHRydWUsXG4gICAgICBsYXhicmVhazogdHJ1ZSxcbiAgICAgIGxhc3RzZW1pYzogdHJ1ZSxcbiAgICAgIG9uZXZhcjogZmFsc2UsXG4gICAgICBwYXNzZmFpbDogZmFsc2UsXG4gICAgICBtYXhlcnI6IDEwMCxcbiAgICAgIGV4cHI6IHRydWUsXG4gICAgICBtdWx0aXN0cjogdHJ1ZSxcbiAgICAgIGdsb2JhbHN0cmljdDogdHJ1ZVxuICAgIH07XG4gICAgdGhpcy5kb2MuZ2V0VmFsdWUoKSAmJiB0aGlzLmRlZmVycmVkVXBkYXRlLnNjaGVkdWxlKDEwMCk7XG4gIH1cblxuICBjaGFuZ2VPcHRpb25zKG5ld09wdGlvbnMpIHtcbiAgICBtaXhpbih0aGlzLm9wdGlvbnMsIG5ld09wdGlvbnMpO1xuICAgIHRoaXMuZG9jLmdldFZhbHVlKCkgJiYgdGhpcy5kZWZlcnJlZFVwZGF0ZS5zY2hlZHVsZSgxMDApO1xuICB9XG5cbiAgaXNWYWxpZEpTKHN0cjogc3RyaW5nKSB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIGV2YWx1YXRlZCBjb2RlIGNhbiBvbmx5IGNyZWF0ZSB2YXJpYWJsZXMgaW4gdGhpcyBmdW5jdGlvblxuICAgICAgZXZhbChcInRocm93IDA7XCIgKyBzdHIpO1xuICAgIH1cbiAgICBjYXRjaCAoZSkge1xuICAgICAgaWYgKGUgPT09IDApXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgICByZXR1cm4gZmFsc2VcbiAgfVxuXG4gIG9uVXBkYXRlKCkge1xuICAgIHZhciB2YWx1ZSA9IHRoaXMuZG9jLmdldFZhbHVlKCk7XG4gICAgdmFsdWUgPSB2YWx1ZS5yZXBsYWNlKC9eIyEuKlxcbi8sIFwiXFxuXCIpO1xuICAgIGlmICghdmFsdWUpIHtcbiAgICAgIHRoaXMuc2VuZGVyLmVtaXQoXCJlcnJvcnNcIiwgW10pO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB2YXIgZXJyb3JzOiBBbm5vdGF0aW9uW10gPSBbXTtcblxuICAgIC8vIGpzaGludCByZXBvcnRzIG1hbnkgZmFsc2UgZXJyb3JzXG4gICAgLy8gcmVwb3J0IHRoZW0gYXMgZXJyb3Igb25seSBpZiBjb2RlIGlzIGFjdHVhbGx5IGludmFsaWRcbiAgICB2YXIgbWF4RXJyb3JMZXZlbCA9IHRoaXMuaXNWYWxpZEpTKHZhbHVlKSA/IFwid2FybmluZ1wiIDogXCJlcnJvclwiO1xuXG4gICAgLy8gdmFyIHN0YXJ0ID0gbmV3IERhdGUoKTtcbiAgICBKU0hJTlQodmFsdWUsIHRoaXMub3B0aW9ucyk7XG4gICAgdmFyIHJlc3VsdHM6IEpTSGludEVycm9yW10gPSBKU0hJTlQuZXJyb3JzO1xuXG4gICAgdmFyIGVycm9yQWRkZWQgPSBmYWxzZVxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzdWx0cy5sZW5ndGg7IGkrKykge1xuICAgICAgdmFyIGVycm9yID0gcmVzdWx0c1tpXTtcbiAgICAgIGlmICghZXJyb3IpXG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgdmFyIHJhdyA9IGVycm9yLnJhdztcbiAgICAgIHZhciB0eXBlID0gXCJ3YXJuaW5nXCI7XG5cbiAgICAgIGlmIChyYXcgPT0gXCJNaXNzaW5nIHNlbWljb2xvbi5cIikge1xuICAgICAgICB2YXIgc3RyID0gZXJyb3IuZXZpZGVuY2Uuc3Vic3RyKGVycm9yLmNoYXJhY3Rlcik7XG4gICAgICAgIHN0ciA9IHN0ci5jaGFyQXQoc3RyLnNlYXJjaCgvXFxTLykpO1xuICAgICAgICBpZiAobWF4RXJyb3JMZXZlbCA9PSBcImVycm9yXCIgJiYgc3RyICYmIC9bXFx3XFxkeyhbJ1wiXS8udGVzdChzdHIpKSB7XG4gICAgICAgICAgZXJyb3IucmVhc29uID0gJ01pc3NpbmcgXCI7XCIgYmVmb3JlIHN0YXRlbWVudCc7XG4gICAgICAgICAgdHlwZSA9IFwiZXJyb3JcIjtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICB0eXBlID0gXCJpbmZvXCI7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGVsc2UgaWYgKGRpc2FibGVkV2FybmluZ3NSZS50ZXN0KHJhdykpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBlbHNlIGlmIChpbmZvUmUudGVzdChyYXcpKSB7XG4gICAgICAgIHR5cGUgPSBcImluZm9cIlxuICAgICAgfVxuICAgICAgZWxzZSBpZiAoZXJyb3JzUmUudGVzdChyYXcpKSB7XG4gICAgICAgIGVycm9yQWRkZWQgPSB0cnVlO1xuICAgICAgICB0eXBlID0gbWF4RXJyb3JMZXZlbDtcbiAgICAgIH1cbiAgICAgIGVsc2UgaWYgKHJhdyA9PT0gXCIne2F9JyBpcyBub3QgZGVmaW5lZC5cIikge1xuICAgICAgICB0eXBlID0gXCJ3YXJuaW5nXCI7XG4gICAgICB9XG4gICAgICBlbHNlIGlmIChyYXcgPT09IFwiJ3thfScgaXMgZGVmaW5lZCBidXQgbmV2ZXIgdXNlZC5cIikge1xuICAgICAgICB0eXBlID0gXCJpbmZvXCI7XG4gICAgICB9XG5cbiAgICAgIGVycm9ycy5wdXNoKHtcbiAgICAgICAgcm93OiBlcnJvci5saW5lIC0gMSxcbiAgICAgICAgY29sdW1uOiBlcnJvci5jaGFyYWN0ZXIgLSAxLFxuICAgICAgICB0ZXh0OiBlcnJvci5yZWFzb24sXG4gICAgICAgIHR5cGU6IHR5cGVcbiAgICAgIH0pO1xuXG4gICAgICBpZiAoZXJyb3JBZGRlZCkge1xuICAgICAgICAvLyBicmVhaztcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLnNlbmRlci5lbWl0KFwiZXJyb3JzXCIsIGVycm9ycyk7XG4gIH1cbn1cbi8qICoqKioqIEJFR0lOIExJQ0VOU0UgQkxPQ0sgKioqKipcbiAqIERpc3RyaWJ1dGVkIHVuZGVyIHRoZSBCU0QgbGljZW5zZTpcbiAqXG4gKiBDb3B5cmlnaHQgKGMpIDIwMTAsIEFqYXgub3JnIEIuVi5cbiAqIEFsbCByaWdodHMgcmVzZXJ2ZWQuXG4gKiBcbiAqIFJlZGlzdHJpYnV0aW9uIGFuZCB1c2UgaW4gc291cmNlIGFuZCBiaW5hcnkgZm9ybXMsIHdpdGggb3Igd2l0aG91dFxuICogbW9kaWZpY2F0aW9uLCBhcmUgcGVybWl0dGVkIHByb3ZpZGVkIHRoYXQgdGhlIGZvbGxvd2luZyBjb25kaXRpb25zIGFyZSBtZXQ6XG4gKiAgICAgKiBSZWRpc3RyaWJ1dGlvbnMgb2Ygc291cmNlIGNvZGUgbXVzdCByZXRhaW4gdGhlIGFib3ZlIGNvcHlyaWdodFxuICogICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyLlxuICogICAgICogUmVkaXN0cmlidXRpb25zIGluIGJpbmFyeSBmb3JtIG11c3QgcmVwcm9kdWNlIHRoZSBhYm92ZSBjb3B5cmlnaHRcbiAqICAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lciBpbiB0aGVcbiAqICAgICAgIGRvY3VtZW50YXRpb24gYW5kL29yIG90aGVyIG1hdGVyaWFscyBwcm92aWRlZCB3aXRoIHRoZSBkaXN0cmlidXRpb24uXG4gKiAgICAgKiBOZWl0aGVyIHRoZSBuYW1lIG9mIEFqYXgub3JnIEIuVi4gbm9yIHRoZVxuICogICAgICAgbmFtZXMgb2YgaXRzIGNvbnRyaWJ1dG9ycyBtYXkgYmUgdXNlZCB0byBlbmRvcnNlIG9yIHByb21vdGUgcHJvZHVjdHNcbiAqICAgICAgIGRlcml2ZWQgZnJvbSB0aGlzIHNvZnR3YXJlIHdpdGhvdXQgc3BlY2lmaWMgcHJpb3Igd3JpdHRlbiBwZXJtaXNzaW9uLlxuICogXG4gKiBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIFRIRSBDT1BZUklHSFQgSE9MREVSUyBBTkQgQ09OVFJJQlVUT1JTIFwiQVMgSVNcIiBBTkRcbiAqIEFOWSBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRSBJTVBMSUVEXG4gKiBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFXG4gKiBESVNDTEFJTUVELiBJTiBOTyBFVkVOVCBTSEFMTCBBSkFYLk9SRyBCLlYuIEJFIExJQUJMRSBGT1IgQU5ZXG4gKiBESVJFQ1QsIElORElSRUNULCBJTkNJREVOVEFMLCBTUEVDSUFMLCBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFU1xuICogKElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRFIEdPT0RTIE9SIFNFUlZJQ0VTO1xuICogTE9TUyBPRiBVU0UsIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTIElOVEVSUlVQVElPTikgSE9XRVZFUiBDQVVTRUQgQU5EXG4gKiBPTiBBTlkgVEhFT1JZIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUIExJQUJJTElUWSwgT1IgVE9SVFxuICogKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZIE9VVCBPRiBUSEUgVVNFIE9GIFRISVNcbiAqIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLlxuICpcbiAqICoqKioqIEVORCBMSUNFTlNFIEJMT0NLICoqKioqICovXG4iXX0=