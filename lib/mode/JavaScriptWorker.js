import { mixin } from "../lib/oop";
import Mirror from "../worker/Mirror";
function startRegex(arr) {
    return RegExp("^(" + arr.join("|") + ")");
}
var disabledWarningsRe = startRegex([
    "Bad for in variable '(.+)'.",
    'Missing "use strict"'
]);
var errorsRe = startRegex([
    "Unexpected",
    "Expected ",
    "Confusing (plus|minus)",
    "\\{a\\} unterminated regular expression",
    "Unclosed ",
    "Unmatched ",
    "Unbegun comment",
    "Bad invocation",
    "Missing space after",
    "Missing operator at"
]);
var infoRe = startRegex([
    "Expected an assignment",
    "Bad escapement of EOL",
    "Unexpected comma",
    "Unexpected space",
    "Missing radix parameter.",
    "A leading decimal point can",
    "\\['{a}'\\] is better written in dot notation.",
    "'{a}' used out of scope"
]);
export default class JavaScriptWorker extends Mirror {
    constructor(sender) {
        super(sender, 500);
        this.setOptions();
        sender.emit('initAfter');
    }
    setOptions(options) {
        this.options = options || {
            esnext: true,
            moz: true,
            devel: true,
            browser: true,
            node: true,
            laxcomma: true,
            laxbreak: true,
            lastsemic: true,
            onevar: false,
            passfail: false,
            maxerr: 100,
            expr: true,
            multistr: true,
            globalstrict: true
        };
        this.doc.getValue() && this.deferredUpdate.schedule(100);
    }
    changeOptions(newOptions) {
        mixin(this.options, newOptions);
        this.doc.getValue() && this.deferredUpdate.schedule(100);
    }
    isValidJS(str) {
        try {
            eval("throw 0;" + str);
        }
        catch (e) {
            if (e === 0)
                return true;
        }
        return false;
    }
    onUpdate() {
        var value = this.doc.getValue();
        value = value.replace(/^#!.*\n/, "\n");
        if (!value) {
            this.sender.emit("jslint", []);
            return;
        }
        var errors = [];
        var maxErrorLevel = this.isValidJS(value) ? "warning" : "error";
        var results = [];
        var errorAdded = false;
        for (var i = 0; i < results.length; i++) {
            var error = results[i];
            if (!error)
                continue;
            var raw = error.raw;
            var type = "warning";
            if (raw == "Missing semicolon.") {
                var str = error.evidence.substr(error.character);
                str = str.charAt(str.search(/\S/));
                if (maxErrorLevel == "error" && str && /[\w\d{(['"]/.test(str)) {
                    error.reason = 'Missing ";" before statement';
                    type = "error";
                }
                else {
                    type = "info";
                }
            }
            else if (disabledWarningsRe.test(raw)) {
                continue;
            }
            else if (infoRe.test(raw)) {
                type = "info";
            }
            else if (errorsRe.test(raw)) {
                errorAdded = true;
                type = maxErrorLevel;
            }
            else if (raw == "'{a}' is not defined.") {
                type = "warning";
            }
            else if (raw == "'{a}' is defined but never used.") {
                type = "info";
            }
            errors.push({
                row: error.line - 1,
                column: error.character - 1,
                text: error.reason,
                type: type,
                raw: raw
            });
            if (errorAdded) {
            }
        }
        this.sender.emit("jslint", errors);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSmF2YVNjcmlwdFdvcmtlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9tb2RlL0phdmFTY3JpcHRXb3JrZXIudHMiXSwibmFtZXMiOlsic3RhcnRSZWdleCIsIkphdmFTY3JpcHRXb3JrZXIiLCJKYXZhU2NyaXB0V29ya2VyLmNvbnN0cnVjdG9yIiwiSmF2YVNjcmlwdFdvcmtlci5zZXRPcHRpb25zIiwiSmF2YVNjcmlwdFdvcmtlci5jaGFuZ2VPcHRpb25zIiwiSmF2YVNjcmlwdFdvcmtlci5pc1ZhbGlkSlMiLCJKYXZhU2NyaXB0V29ya2VyLm9uVXBkYXRlIl0sIm1hcHBpbmdzIjoiT0FBTyxFQUFDLEtBQUssRUFBQyxNQUFNLFlBQVk7T0FDekIsTUFBTSxNQUFNLGtCQUFrQjtBQUtyQyxvQkFBb0IsR0FBRztJQUNyQkEsTUFBTUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsSUFBSUEsR0FBR0EsR0FBR0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsR0FBR0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7QUFDNUNBLENBQUNBO0FBRUQsSUFBSSxrQkFBa0IsR0FBRyxVQUFVLENBQUM7SUFDbEMsNkJBQTZCO0lBQzdCLHNCQUFzQjtDQUN2QixDQUFDLENBQUM7QUFDSCxJQUFJLFFBQVEsR0FBRyxVQUFVLENBQUM7SUFDeEIsWUFBWTtJQUNaLFdBQVc7SUFDWCx3QkFBd0I7SUFDeEIseUNBQXlDO0lBQ3pDLFdBQVc7SUFDWCxZQUFZO0lBQ1osaUJBQWlCO0lBQ2pCLGdCQUFnQjtJQUNoQixxQkFBcUI7SUFDckIscUJBQXFCO0NBQ3RCLENBQUMsQ0FBQztBQUNILElBQUksTUFBTSxHQUFHLFVBQVUsQ0FBQztJQUN0Qix3QkFBd0I7SUFDeEIsdUJBQXVCO0lBQ3ZCLGtCQUFrQjtJQUNsQixrQkFBa0I7SUFDbEIsMEJBQTBCO0lBQzFCLDZCQUE2QjtJQUM3QixnREFBZ0Q7SUFDaEQseUJBQXlCO0NBQzFCLENBQUMsQ0FBQztBQUVILDhDQUE4QyxNQUFNO0lBRWxEQyxZQUFZQSxNQUFjQTtRQUN4QkMsTUFBTUEsTUFBTUEsRUFBRUEsR0FBR0EsQ0FBQ0EsQ0FBQ0E7UUFDbkJBLElBQUlBLENBQUNBLFVBQVVBLEVBQUVBLENBQUNBO1FBQ2xCQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxDQUFDQTtJQUMzQkEsQ0FBQ0E7SUFDREQsVUFBVUEsQ0FBQ0EsT0FBWUE7UUFDckJFLElBQUlBLENBQUNBLE9BQU9BLEdBQUdBLE9BQU9BLElBQUlBO1lBR3hCQSxNQUFNQSxFQUFFQSxJQUFJQTtZQUNaQSxHQUFHQSxFQUFFQSxJQUFJQTtZQUNUQSxLQUFLQSxFQUFFQSxJQUFJQTtZQUNYQSxPQUFPQSxFQUFFQSxJQUFJQTtZQUNiQSxJQUFJQSxFQUFFQSxJQUFJQTtZQUNWQSxRQUFRQSxFQUFFQSxJQUFJQTtZQUNkQSxRQUFRQSxFQUFFQSxJQUFJQTtZQUNkQSxTQUFTQSxFQUFFQSxJQUFJQTtZQUNmQSxNQUFNQSxFQUFFQSxLQUFLQTtZQUNiQSxRQUFRQSxFQUFFQSxLQUFLQTtZQUNmQSxNQUFNQSxFQUFFQSxHQUFHQTtZQUNYQSxJQUFJQSxFQUFFQSxJQUFJQTtZQUNWQSxRQUFRQSxFQUFFQSxJQUFJQTtZQUNkQSxZQUFZQSxFQUFFQSxJQUFJQTtTQUNuQkEsQ0FBQ0E7UUFDRkEsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsUUFBUUEsRUFBRUEsSUFBSUEsSUFBSUEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7SUFDM0RBLENBQUNBO0lBRURGLGFBQWFBLENBQUNBLFVBQVVBO1FBQ3RCRyxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxPQUFPQSxFQUFFQSxVQUFVQSxDQUFDQSxDQUFDQTtRQUNoQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsUUFBUUEsRUFBRUEsSUFBSUEsSUFBSUEsQ0FBQ0EsY0FBY0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0E7SUFDM0RBLENBQUNBO0lBRURILFNBQVNBLENBQUNBLEdBQVdBO1FBQ25CSSxJQUFJQSxDQUFDQTtZQUVIQSxJQUFJQSxDQUFDQSxVQUFVQSxHQUFHQSxHQUFHQSxDQUFDQSxDQUFDQTtRQUN6QkEsQ0FDQUE7UUFBQUEsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDVEEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ1ZBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBO1FBQ2hCQSxDQUFDQTtRQUNEQSxNQUFNQSxDQUFDQSxLQUFLQSxDQUFBQTtJQUNkQSxDQUFDQTtJQUVESixRQUFRQTtRQUNOSyxJQUFJQSxLQUFLQSxHQUFHQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQSxRQUFRQSxFQUFFQSxDQUFDQTtRQUNoQ0EsS0FBS0EsR0FBR0EsS0FBS0EsQ0FBQ0EsT0FBT0EsQ0FBQ0EsU0FBU0EsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDdkNBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLEtBQUtBLENBQUNBLENBQUNBLENBQUNBO1lBQ1hBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFFBQVFBLEVBQUVBLEVBQUVBLENBQUNBLENBQUNBO1lBQy9CQSxNQUFNQSxDQUFDQTtRQUNUQSxDQUFDQTtRQUNEQSxJQUFJQSxNQUFNQSxHQUFHQSxFQUFFQSxDQUFDQTtRQUloQkEsSUFBSUEsYUFBYUEsR0FBR0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsR0FBR0EsU0FBU0EsR0FBR0EsT0FBT0EsQ0FBQ0E7UUFJaEVBLElBQUlBLE9BQU9BLEdBQUdBLEVBQUVBLENBQUNBO1FBRWpCQSxJQUFJQSxVQUFVQSxHQUFHQSxLQUFLQSxDQUFBQTtRQUN0QkEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsR0FBR0EsT0FBT0EsQ0FBQ0EsTUFBTUEsRUFBRUEsQ0FBQ0EsRUFBRUEsRUFBRUEsQ0FBQ0E7WUFDeENBLElBQUlBLEtBQUtBLEdBQUdBLE9BQU9BLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBQ3ZCQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxLQUFLQSxDQUFDQTtnQkFDVEEsUUFBUUEsQ0FBQ0E7WUFDWEEsSUFBSUEsR0FBR0EsR0FBR0EsS0FBS0EsQ0FBQ0EsR0FBR0EsQ0FBQ0E7WUFDcEJBLElBQUlBLElBQUlBLEdBQUdBLFNBQVNBLENBQUNBO1lBRXJCQSxFQUFFQSxDQUFDQSxDQUFDQSxHQUFHQSxJQUFJQSxvQkFBb0JBLENBQUNBLENBQUNBLENBQUNBO2dCQUNoQ0EsSUFBSUEsR0FBR0EsR0FBR0EsS0FBS0EsQ0FBQ0EsUUFBUUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsS0FBS0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ2pEQSxHQUFHQSxHQUFHQSxHQUFHQSxDQUFDQSxNQUFNQSxDQUFDQSxHQUFHQSxDQUFDQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDbkNBLEVBQUVBLENBQUNBLENBQUNBLGFBQWFBLElBQUlBLE9BQU9BLElBQUlBLEdBQUdBLElBQUlBLGFBQWFBLENBQUNBLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO29CQUMvREEsS0FBS0EsQ0FBQ0EsTUFBTUEsR0FBR0EsOEJBQThCQSxDQUFDQTtvQkFDOUNBLElBQUlBLEdBQUdBLE9BQU9BLENBQUNBO2dCQUNqQkEsQ0FBQ0E7Z0JBQUNBLElBQUlBLENBQUNBLENBQUNBO29CQUNOQSxJQUFJQSxHQUFHQSxNQUFNQSxDQUFDQTtnQkFDaEJBLENBQUNBO1lBQ0hBLENBQUNBO1lBQ0RBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLGtCQUFrQkEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQ3RDQSxRQUFRQSxDQUFDQTtZQUNYQSxDQUFDQTtZQUNEQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDMUJBLElBQUlBLEdBQUdBLE1BQU1BLENBQUFBO1lBQ2ZBLENBQUNBO1lBQ0RBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLFFBQVFBLENBQUNBLElBQUlBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO2dCQUM1QkEsVUFBVUEsR0FBR0EsSUFBSUEsQ0FBQ0E7Z0JBQ2xCQSxJQUFJQSxHQUFHQSxhQUFhQSxDQUFDQTtZQUN2QkEsQ0FBQ0E7WUFDREEsSUFBSUEsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsSUFBSUEsdUJBQXVCQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDeENBLElBQUlBLEdBQUdBLFNBQVNBLENBQUNBO1lBQ25CQSxDQUFDQTtZQUNEQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxHQUFHQSxJQUFJQSxrQ0FBa0NBLENBQUNBLENBQUNBLENBQUNBO2dCQUNuREEsSUFBSUEsR0FBR0EsTUFBTUEsQ0FBQ0E7WUFDaEJBLENBQUNBO1lBRURBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBO2dCQUNWQSxHQUFHQSxFQUFFQSxLQUFLQSxDQUFDQSxJQUFJQSxHQUFHQSxDQUFDQTtnQkFDbkJBLE1BQU1BLEVBQUVBLEtBQUtBLENBQUNBLFNBQVNBLEdBQUdBLENBQUNBO2dCQUMzQkEsSUFBSUEsRUFBRUEsS0FBS0EsQ0FBQ0EsTUFBTUE7Z0JBQ2xCQSxJQUFJQSxFQUFFQSxJQUFJQTtnQkFDVkEsR0FBR0EsRUFBRUEsR0FBR0E7YUFDVEEsQ0FBQ0EsQ0FBQ0E7WUFFSEEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFFakJBLENBQUNBO1FBQ0hBLENBQUNBO1FBRURBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLFFBQVFBLEVBQUVBLE1BQU1BLENBQUNBLENBQUNBO0lBQ3JDQSxDQUFDQTtBQUNITCxDQUFDQTtBQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHttaXhpbn0gZnJvbSBcIi4uL2xpYi9vb3BcIjtcbmltcG9ydCBNaXJyb3IgZnJvbSBcIi4uL3dvcmtlci9NaXJyb3JcIjtcbmltcG9ydCBTZW5kZXIgZnJvbSBcIi4uL2xpYi9TZW5kZXJcIjtcblxuLy92YXIgbGludCA9IHJlcXVpcmUoXCIuL2phdmFzY3JpcHQvanNoaW50XCIpLkpTSElOVDtcblxuZnVuY3Rpb24gc3RhcnRSZWdleChhcnIpIHtcbiAgcmV0dXJuIFJlZ0V4cChcIl4oXCIgKyBhcnIuam9pbihcInxcIikgKyBcIilcIik7XG59XG5cbnZhciBkaXNhYmxlZFdhcm5pbmdzUmUgPSBzdGFydFJlZ2V4KFtcbiAgXCJCYWQgZm9yIGluIHZhcmlhYmxlICcoLispJy5cIixcbiAgJ01pc3NpbmcgXCJ1c2Ugc3RyaWN0XCInXG5dKTtcbnZhciBlcnJvcnNSZSA9IHN0YXJ0UmVnZXgoW1xuICBcIlVuZXhwZWN0ZWRcIixcbiAgXCJFeHBlY3RlZCBcIixcbiAgXCJDb25mdXNpbmcgKHBsdXN8bWludXMpXCIsXG4gIFwiXFxcXHthXFxcXH0gdW50ZXJtaW5hdGVkIHJlZ3VsYXIgZXhwcmVzc2lvblwiLFxuICBcIlVuY2xvc2VkIFwiLFxuICBcIlVubWF0Y2hlZCBcIixcbiAgXCJVbmJlZ3VuIGNvbW1lbnRcIixcbiAgXCJCYWQgaW52b2NhdGlvblwiLFxuICBcIk1pc3Npbmcgc3BhY2UgYWZ0ZXJcIixcbiAgXCJNaXNzaW5nIG9wZXJhdG9yIGF0XCJcbl0pO1xudmFyIGluZm9SZSA9IHN0YXJ0UmVnZXgoW1xuICBcIkV4cGVjdGVkIGFuIGFzc2lnbm1lbnRcIixcbiAgXCJCYWQgZXNjYXBlbWVudCBvZiBFT0xcIixcbiAgXCJVbmV4cGVjdGVkIGNvbW1hXCIsXG4gIFwiVW5leHBlY3RlZCBzcGFjZVwiLFxuICBcIk1pc3NpbmcgcmFkaXggcGFyYW1ldGVyLlwiLFxuICBcIkEgbGVhZGluZyBkZWNpbWFsIHBvaW50IGNhblwiLFxuICBcIlxcXFxbJ3thfSdcXFxcXSBpcyBiZXR0ZXIgd3JpdHRlbiBpbiBkb3Qgbm90YXRpb24uXCIsXG4gIFwiJ3thfScgdXNlZCBvdXQgb2Ygc2NvcGVcIlxuXSk7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEphdmFTY3JpcHRXb3JrZXIgZXh0ZW5kcyBNaXJyb3Ige1xuICBvcHRpb25zO1xuICBjb25zdHJ1Y3RvcihzZW5kZXI6IFNlbmRlcikge1xuICAgIHN1cGVyKHNlbmRlciwgNTAwKTtcbiAgICB0aGlzLnNldE9wdGlvbnMoKTtcbiAgICBzZW5kZXIuZW1pdCgnaW5pdEFmdGVyJyk7XG4gIH1cbiAgc2V0T3B0aW9ucyhvcHRpb25zPzoge30pIHtcbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zIHx8IHtcbiAgICAgIC8vIHVuZGVmOiB0cnVlLFxuICAgICAgLy8gdW51c2VkOiB0cnVlLFxuICAgICAgZXNuZXh0OiB0cnVlLFxuICAgICAgbW96OiB0cnVlLFxuICAgICAgZGV2ZWw6IHRydWUsXG4gICAgICBicm93c2VyOiB0cnVlLFxuICAgICAgbm9kZTogdHJ1ZSxcbiAgICAgIGxheGNvbW1hOiB0cnVlLFxuICAgICAgbGF4YnJlYWs6IHRydWUsXG4gICAgICBsYXN0c2VtaWM6IHRydWUsXG4gICAgICBvbmV2YXI6IGZhbHNlLFxuICAgICAgcGFzc2ZhaWw6IGZhbHNlLFxuICAgICAgbWF4ZXJyOiAxMDAsXG4gICAgICBleHByOiB0cnVlLFxuICAgICAgbXVsdGlzdHI6IHRydWUsXG4gICAgICBnbG9iYWxzdHJpY3Q6IHRydWVcbiAgICB9O1xuICAgIHRoaXMuZG9jLmdldFZhbHVlKCkgJiYgdGhpcy5kZWZlcnJlZFVwZGF0ZS5zY2hlZHVsZSgxMDApO1xuICB9XG5cbiAgY2hhbmdlT3B0aW9ucyhuZXdPcHRpb25zKSB7XG4gICAgbWl4aW4odGhpcy5vcHRpb25zLCBuZXdPcHRpb25zKTtcbiAgICB0aGlzLmRvYy5nZXRWYWx1ZSgpICYmIHRoaXMuZGVmZXJyZWRVcGRhdGUuc2NoZWR1bGUoMTAwKTtcbiAgfVxuXG4gIGlzVmFsaWRKUyhzdHI6IHN0cmluZykge1xuICAgIHRyeSB7XG4gICAgICAvLyBldmFsdWF0ZWQgY29kZSBjYW4gb25seSBjcmVhdGUgdmFyaWFibGVzIGluIHRoaXMgZnVuY3Rpb25cbiAgICAgIGV2YWwoXCJ0aHJvdyAwO1wiICsgc3RyKTtcbiAgICB9XG4gICAgY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChlID09PSAwKVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cblxuICBvblVwZGF0ZSgpIHtcbiAgICB2YXIgdmFsdWUgPSB0aGlzLmRvYy5nZXRWYWx1ZSgpO1xuICAgIHZhbHVlID0gdmFsdWUucmVwbGFjZSgvXiMhLipcXG4vLCBcIlxcblwiKTtcbiAgICBpZiAoIXZhbHVlKSB7XG4gICAgICB0aGlzLnNlbmRlci5lbWl0KFwianNsaW50XCIsIFtdKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdmFyIGVycm9ycyA9IFtdO1xuXG4gICAgLy8ganNoaW50IHJlcG9ydHMgbWFueSBmYWxzZSBlcnJvcnNcbiAgICAvLyByZXBvcnQgdGhlbSBhcyBlcnJvciBvbmx5IGlmIGNvZGUgaXMgYWN0dWFsbHkgaW52YWxpZFxuICAgIHZhciBtYXhFcnJvckxldmVsID0gdGhpcy5pc1ZhbGlkSlModmFsdWUpID8gXCJ3YXJuaW5nXCIgOiBcImVycm9yXCI7XG5cbiAgICAvLyB2YXIgc3RhcnQgPSBuZXcgRGF0ZSgpO1xuICAgIC8vIGxpbnQodmFsdWUsIHRoaXMub3B0aW9ucyk7XG4gICAgdmFyIHJlc3VsdHMgPSBbXTsvL2xpbnQuZXJyb3JzO1xuXG4gICAgdmFyIGVycm9yQWRkZWQgPSBmYWxzZVxuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgcmVzdWx0cy5sZW5ndGg7IGkrKykge1xuICAgICAgdmFyIGVycm9yID0gcmVzdWx0c1tpXTtcbiAgICAgIGlmICghZXJyb3IpXG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgdmFyIHJhdyA9IGVycm9yLnJhdztcbiAgICAgIHZhciB0eXBlID0gXCJ3YXJuaW5nXCI7XG5cbiAgICAgIGlmIChyYXcgPT0gXCJNaXNzaW5nIHNlbWljb2xvbi5cIikge1xuICAgICAgICB2YXIgc3RyID0gZXJyb3IuZXZpZGVuY2Uuc3Vic3RyKGVycm9yLmNoYXJhY3Rlcik7XG4gICAgICAgIHN0ciA9IHN0ci5jaGFyQXQoc3RyLnNlYXJjaCgvXFxTLykpO1xuICAgICAgICBpZiAobWF4RXJyb3JMZXZlbCA9PSBcImVycm9yXCIgJiYgc3RyICYmIC9bXFx3XFxkeyhbJ1wiXS8udGVzdChzdHIpKSB7XG4gICAgICAgICAgZXJyb3IucmVhc29uID0gJ01pc3NpbmcgXCI7XCIgYmVmb3JlIHN0YXRlbWVudCc7XG4gICAgICAgICAgdHlwZSA9IFwiZXJyb3JcIjtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0eXBlID0gXCJpbmZvXCI7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIGVsc2UgaWYgKGRpc2FibGVkV2FybmluZ3NSZS50ZXN0KHJhdykpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBlbHNlIGlmIChpbmZvUmUudGVzdChyYXcpKSB7XG4gICAgICAgIHR5cGUgPSBcImluZm9cIlxuICAgICAgfVxuICAgICAgZWxzZSBpZiAoZXJyb3JzUmUudGVzdChyYXcpKSB7XG4gICAgICAgIGVycm9yQWRkZWQgPSB0cnVlO1xuICAgICAgICB0eXBlID0gbWF4RXJyb3JMZXZlbDtcbiAgICAgIH1cbiAgICAgIGVsc2UgaWYgKHJhdyA9PSBcIid7YX0nIGlzIG5vdCBkZWZpbmVkLlwiKSB7XG4gICAgICAgIHR5cGUgPSBcIndhcm5pbmdcIjtcbiAgICAgIH1cbiAgICAgIGVsc2UgaWYgKHJhdyA9PSBcIid7YX0nIGlzIGRlZmluZWQgYnV0IG5ldmVyIHVzZWQuXCIpIHtcbiAgICAgICAgdHlwZSA9IFwiaW5mb1wiO1xuICAgICAgfVxuXG4gICAgICBlcnJvcnMucHVzaCh7XG4gICAgICAgIHJvdzogZXJyb3IubGluZSAtIDEsXG4gICAgICAgIGNvbHVtbjogZXJyb3IuY2hhcmFjdGVyIC0gMSxcbiAgICAgICAgdGV4dDogZXJyb3IucmVhc29uLFxuICAgICAgICB0eXBlOiB0eXBlLFxuICAgICAgICByYXc6IHJhd1xuICAgICAgfSk7XG5cbiAgICAgIGlmIChlcnJvckFkZGVkKSB7XG4gICAgICAgIC8vIGJyZWFrO1xuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMuc2VuZGVyLmVtaXQoXCJqc2xpbnRcIiwgZXJyb3JzKTtcbiAgfVxufVxuLyogKioqKiogQkVHSU4gTElDRU5TRSBCTE9DSyAqKioqKlxuICogRGlzdHJpYnV0ZWQgdW5kZXIgdGhlIEJTRCBsaWNlbnNlOlxuICpcbiAqIENvcHlyaWdodCAoYykgMjAxMCwgQWpheC5vcmcgQi5WLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqIFxuICogUmVkaXN0cmlidXRpb24gYW5kIHVzZSBpbiBzb3VyY2UgYW5kIGJpbmFyeSBmb3Jtcywgd2l0aCBvciB3aXRob3V0XG4gKiBtb2RpZmljYXRpb24sIGFyZSBwZXJtaXR0ZWQgcHJvdmlkZWQgdGhhdCB0aGUgZm9sbG93aW5nIGNvbmRpdGlvbnMgYXJlIG1ldDpcbiAqICAgICAqIFJlZGlzdHJpYnV0aW9ucyBvZiBzb3VyY2UgY29kZSBtdXN0IHJldGFpbiB0aGUgYWJvdmUgY29weXJpZ2h0XG4gKiAgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIuXG4gKiAgICAgKiBSZWRpc3RyaWJ1dGlvbnMgaW4gYmluYXJ5IGZvcm0gbXVzdCByZXByb2R1Y2UgdGhlIGFib3ZlIGNvcHlyaWdodFxuICogICAgICAgbm90aWNlLCB0aGlzIGxpc3Qgb2YgY29uZGl0aW9ucyBhbmQgdGhlIGZvbGxvd2luZyBkaXNjbGFpbWVyIGluIHRoZVxuICogICAgICAgZG9jdW1lbnRhdGlvbiBhbmQvb3Igb3RoZXIgbWF0ZXJpYWxzIHByb3ZpZGVkIHdpdGggdGhlIGRpc3RyaWJ1dGlvbi5cbiAqICAgICAqIE5laXRoZXIgdGhlIG5hbWUgb2YgQWpheC5vcmcgQi5WLiBub3IgdGhlXG4gKiAgICAgICBuYW1lcyBvZiBpdHMgY29udHJpYnV0b3JzIG1heSBiZSB1c2VkIHRvIGVuZG9yc2Ugb3IgcHJvbW90ZSBwcm9kdWN0c1xuICogICAgICAgZGVyaXZlZCBmcm9tIHRoaXMgc29mdHdhcmUgd2l0aG91dCBzcGVjaWZpYyBwcmlvciB3cml0dGVuIHBlcm1pc3Npb24uXG4gKiBcbiAqIFRISVMgU09GVFdBUkUgSVMgUFJPVklERUQgQlkgVEhFIENPUFlSSUdIVCBIT0xERVJTIEFORCBDT05UUklCVVRPUlMgXCJBUyBJU1wiIEFORFxuICogQU5ZIEVYUFJFU1MgT1IgSU1QTElFRCBXQVJSQU5USUVTLCBJTkNMVURJTkcsIEJVVCBOT1QgTElNSVRFRCBUTywgVEhFIElNUExJRURcbiAqIFdBUlJBTlRJRVMgT0YgTUVSQ0hBTlRBQklMSVRZIEFORCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBUkVcbiAqIERJU0NMQUlNRUQuIElOIE5PIEVWRU5UIFNIQUxMIEFKQVguT1JHIEIuVi4gQkUgTElBQkxFIEZPUiBBTllcbiAqIERJUkVDVCwgSU5ESVJFQ1QsIElOQ0lERU5UQUwsIFNQRUNJQUwsIEVYRU1QTEFSWSwgT1IgQ09OU0VRVUVOVElBTCBEQU1BR0VTXG4gKiAoSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFBST0NVUkVNRU5UIE9GIFNVQlNUSVRVVEUgR09PRFMgT1IgU0VSVklDRVM7XG4gKiBMT1NTIE9GIFVTRSwgREFUQSwgT1IgUFJPRklUUzsgT1IgQlVTSU5FU1MgSU5URVJSVVBUSU9OKSBIT1dFVkVSIENBVVNFRCBBTkRcbiAqIE9OIEFOWSBUSEVPUlkgT0YgTElBQklMSVRZLCBXSEVUSEVSIElOIENPTlRSQUNULCBTVFJJQ1QgTElBQklMSVRZLCBPUiBUT1JUXG4gKiAoSU5DTFVESU5HIE5FR0xJR0VOQ0UgT1IgT1RIRVJXSVNFKSBBUklTSU5HIElOIEFOWSBXQVkgT1VUIE9GIFRIRSBVU0UgT0YgVEhJU1xuICogU09GVFdBUkUsIEVWRU4gSUYgQURWSVNFRCBPRiBUSEUgUE9TU0lCSUxJVFkgT0YgU1VDSCBEQU1BR0UuXG4gKlxuICogKioqKiogRU5EIExJQ0VOU0UgQkxPQ0sgKioqKiogKi9cbiJdfQ==