import HashHandler from '../../keyboard/HashHandler';
import EventEmitterClass from '../../lib/event_emitter';
import AutoCompleteView from '../../mode/typescript/AutoCompleteView';
function makeCompareFn(text) {
    return function (a, b) {
        var matchFunc = function (entry) {
            return entry.name.indexOf(text) === 0 ? 1 : 0;
        };
        var matchCompare = function () {
            return matchFunc(b) - matchFunc(a);
        };
        var textCompare = function () {
            if (a.name === b.name) {
                return 0;
            }
            else {
                return (a.name > b.name) ? 1 : -1;
            }
        };
        var ret = matchCompare();
        return (ret !== 0) ? ret : textCompare();
    };
}
export default function autoComplete(editor, fileNameProvider, completionService) {
    var AutoComplete = function () {
    };
    var that = new AutoComplete();
    that.isActive = isActive;
    that.activate = activate;
    that.deactivate = deactivate;
    var _eventEmitter = new EventEmitterClass();
    var _active = false;
    var _handler = new HashHandler();
    var _view = new AutoCompleteView(editor, that);
    var _inputText = '';
    _handler.attach = function () {
        editor.addEventListener("change", onEditorChange);
        _eventEmitter._emit("attach", { 'sender': that });
        _active = true;
    };
    _handler.detach = function () {
        editor.removeEventListener("change", onEditorChange);
        _view.hide();
        _eventEmitter._emit("detach", { 'sender': that });
        _active = false;
    };
    _handler.handleKeyboard = function (data, hashId, key, keyCode) {
        if (hashId == -1) {
            if (" -=,[]_/()!';:<>".indexOf(key) != -1) {
                deactivate();
            }
            return null;
        }
        var command = _handler.findKeyCommand(hashId, key);
        if (!command) {
            var defaultCommand = editor.commands.findKeyCommand(hashId, key);
            if (defaultCommand) {
                if (defaultCommand.name == "backspace") {
                    return null;
                }
                deactivate();
            }
            return null;
        }
        if (typeof command !== "string") {
            var args = command.args;
            command = command.command;
        }
        if (typeof command === "string") {
            command = this.commands[command];
        }
        return { 'command': command, 'args': args };
    };
    _handler.bindKeys({ "Up|Ctrl-p": "moveprev", "Down|Ctrl-n": "movenext", "esc|Ctrl-g": "cancel", "Return|Tab": "insert" });
    _handler.addCommands({
        movenext: function (editor) { _view.focusNext(); },
        moveprev: function (editor) { _view.focusPrev(); },
        cancel: function (editor) { deactivate(); },
        insert: function (editor) {
            editor.removeEventListener("change", onEditorChange);
            for (var i = 0; i < _inputText.length; i++) {
                editor.remove("left");
            }
            var curr = _view.current();
            if (curr) {
                editor.insert($(curr).data("name"));
            }
            deactivate();
        }
    });
    function isActive() {
        return _active;
    }
    function activateUsingCursor(cursor) {
        completionService.getCompletionsAtCursor(fileNameProvider(), cursor, function (err, completionInfo) {
            if (!err) {
                var text = completionService.matchText;
                _inputText = text;
                var completions = completionInfo ? completionInfo.entries : null;
                if (completions && _inputText.length > 0) {
                    completions = completions.filter(function (elm) {
                        return elm.name.toLowerCase().indexOf(_inputText.toLowerCase()) === 0;
                    });
                }
                completions = completions ? completions.sort(makeCompareFn(_inputText)) : completions;
                showCompletions(completions);
                var count = completions ? completions.length : 0;
                if (count > 0) {
                    editor.keyBinding.addKeyboardHandler(_handler);
                }
            }
            function showCompletions(infos) {
                if (infos && infos.length > 0) {
                    editor.container.appendChild(_view.wrap);
                    var html = '';
                    for (var n in infos) {
                        var info = infos[n];
                        var name = '<span class="label-name">' + info.name + '</span>';
                        var kind = '<span class="label-kind label-kind-' + info.kind + '">' + info.kind.charAt(0) + '</span>';
                        html += '<li data-name="' + info.name + '">' + kind + name + '</li>';
                    }
                    var coords = editor.renderer.textToScreenCoordinates(cursor.row, cursor.column - text.length);
                    var lineHeight = 9;
                    var topdownOnly = false;
                    _view.show(coords);
                    _view.listElement.innerHTML = html;
                    _view.ensureFocus();
                }
                else {
                    _view.hide();
                }
            }
        });
    }
    function onEditorChange(event) {
        var cursor = editor.getCursorPosition();
        if (event.data.action == "insertText") {
            activateUsingCursor({ row: cursor.row, column: cursor.column + 1 });
        }
        else if (event.data.action == "removeText") {
            if (event.data.text == '\n') {
                deactivate();
            }
            else {
                activateUsingCursor(cursor);
            }
        }
        else {
            activateUsingCursor(cursor);
        }
    }
    function activate() {
        activateUsingCursor(editor.getCursorPosition());
    }
    function deactivate() {
        editor.keyBinding.removeKeyboardHandler(_handler);
    }
    return that;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0b0NvbXBsZXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL21vZGUvdHlwZXNjcmlwdC9hdXRvQ29tcGxldGUudHMiXSwibmFtZXMiOlsibWFrZUNvbXBhcmVGbiIsImF1dG9Db21wbGV0ZSIsImF1dG9Db21wbGV0ZS5pc0FjdGl2ZSIsImF1dG9Db21wbGV0ZS5hY3RpdmF0ZVVzaW5nQ3Vyc29yIiwic2hvd0NvbXBsZXRpb25zIiwiYXV0b0NvbXBsZXRlLm9uRWRpdG9yQ2hhbmdlIiwiYXV0b0NvbXBsZXRlLmFjdGl2YXRlIiwiYXV0b0NvbXBsZXRlLmRlYWN0aXZhdGUiXSwibWFwcGluZ3MiOiJPQUdPLFdBQVcsTUFBTSw0QkFBNEI7T0FDN0MsaUJBQWlCLE1BQU0seUJBQXlCO09BR2hELGdCQUFnQixNQUFNLHdDQUF3QztBQU1yRSx1QkFBdUIsSUFBWTtJQUMvQkEsTUFBTUEsQ0FBQ0EsVUFBU0EsQ0FBcUJBLEVBQUVBLENBQXFCQTtRQUN4RCxJQUFJLFNBQVMsR0FBRyxVQUFTLEtBQXlCO1lBQzlDLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNsRCxDQUFDLENBQUM7UUFDRixJQUFJLFlBQVksR0FBRztZQUNmLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3ZDLENBQUMsQ0FBQztRQUNGLElBQUksV0FBVyxHQUFHO1lBQ2QsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFDcEIsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNiLENBQUM7WUFDRCxJQUFJLENBQUMsQ0FBQztnQkFDRixNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxJQUFJ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QSxDQUFDQSxDQUFDQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxJQUFJQSxZQUFZQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUN6Q0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsSUFBSUEsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQzFCQSxVQUFVQSxFQUFFQSxDQUFDQTtZQUNqQkEsQ0FBQ0E7WUFDREEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7Z0JBQ0ZBLG1CQUFtQkEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7WUFDaENBLENBQUNBO1FBQ0xBLENBQUNBO1FBQ0RBLElBQUlBLENBQUNBLENBQUNBO1lBQ0ZBLG1CQUFtQkEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7UUFDaENBLENBQUNBO0lBQ0xBLENBQUNBO0lBRURKO1FBQ0lLLG1CQUFtQkEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsaUJBQWlCQSxFQUFFQSxDQUFDQSxDQUFDQTtJQUNwREEsQ0FBQ0E7SUFFREw7UUFDSU0sTUFBTUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EscUJBQXFCQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQTtJQUN0REEsQ0FBQ0E7SUFFRE4sTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7QUFDaEJBLENBQUNBIiwic291cmNlc0NvbnRlbnQiOlsiZGVjbGFyZSB2YXIgJDogYW55O1xuXG5pbXBvcnQgQ3Vyc29yUG9zaXRpb24gZnJvbSAnLi4vLi4vQ3Vyc29yUG9zaXRpb24nO1xuaW1wb3J0IEhhc2hIYW5kbGVyIGZyb20gJy4uLy4uL2tleWJvYXJkL0hhc2hIYW5kbGVyJztcbmltcG9ydCBFdmVudEVtaXR0ZXJDbGFzcyBmcm9tICcuLi8uLi9saWIvZXZlbnRfZW1pdHRlcic7XG5pbXBvcnQgRWRpdG9yIGZyb20gJy4uLy4uL0VkaXRvcic7XG5pbXBvcnQgQ29tcGxldGlvblNlcnZpY2UgZnJvbSAnLi9Db21wbGV0aW9uU2VydmljZSc7XG5pbXBvcnQgQXV0b0NvbXBsZXRlVmlldyBmcm9tICcuLi8uLi9tb2RlL3R5cGVzY3JpcHQvQXV0b0NvbXBsZXRlVmlldyc7XG4vL2ltcG9ydCBwb3B1cCA9IHJlcXVpcmUoJy4uLy4uL2F1dG9jb21wbGV0ZS9wb3B1cCcpO1xuXG4vKipcbiAqIE1ha2VzIGEgZnVuY3Rpb24gdGhhdCBjYW4gYmUgdXNlZCB0byBjb21wYXJlIGNvbXBsZXRpb24gZW50cmllcyBmb3Igc29ydGluZyBwdXJwb3Nlcy5cbiAqL1xuZnVuY3Rpb24gbWFrZUNvbXBhcmVGbih0ZXh0OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gZnVuY3Rpb24oYTogdHMuQ29tcGxldGlvbkVudHJ5LCBiOiB0cy5Db21wbGV0aW9uRW50cnkpIHtcbiAgICAgICAgdmFyIG1hdGNoRnVuYyA9IGZ1bmN0aW9uKGVudHJ5OiB0cy5Db21wbGV0aW9uRW50cnkpOiBudW1iZXIge1xuICAgICAgICAgICAgcmV0dXJuIGVudHJ5Lm5hbWUuaW5kZXhPZih0ZXh0KSA9PT0gMCA/IDEgOiAwO1xuICAgICAgICB9O1xuICAgICAgICB2YXIgbWF0Y2hDb21wYXJlID0gZnVuY3Rpb24oKTogbnVtYmVyIHtcbiAgICAgICAgICAgIHJldHVybiBtYXRjaEZ1bmMoYikgLSBtYXRjaEZ1bmMoYSk7XG4gICAgICAgIH07XG4gICAgICAgIHZhciB0ZXh0Q29tcGFyZSA9IGZ1bmN0aW9uKCk6IG51bWJlciB7XG4gICAgICAgICAgICBpZiAoYS5uYW1lID09PSBiLm5hbWUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiAoYS5uYW1lID4gYi5uYW1lKSA/IDEgOiAtMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgdmFyIHJldCA9IG1hdGNoQ29tcGFyZSgpO1xuICAgICAgICByZXR1cm4gKHJldCAhPT0gMCkgPyByZXQgOiB0ZXh0Q29tcGFyZSgpO1xuICAgIH07XG59XG5cbi8qKlxuICogVXNpbmcgdGhlIGZ1bmN0aW9uYWwgY29uc3RydWN0b3IgcGF0dGVybiBoZXJlIGJlY2F1c2UgJ3RoaXMnIGlzIHRvbyBlcnJvci1wcm9uZS5cbiAqXG4gKiBBY2NvcmRpbmdseSwgdGhlIGZ1bmN0aW9uIGlzIGNhbWVsQ2FzZSBhbmQgaXMgbm90IGNhbGxlZCB1c2luZyB0aGUgJ25ldycgb3BlcmF0b3IuXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGF1dG9Db21wbGV0ZShlZGl0b3I6IEVkaXRvciwgZmlsZU5hbWVQcm92aWRlcjogKCkgPT4gc3RyaW5nLCBjb21wbGV0aW9uU2VydmljZTogQ29tcGxldGlvblNlcnZpY2UpIHtcbiAgICAvKipcbiAgICAgKiBEZWNsYXJlIHRoZSByZXR1cm4gb2JqZWN0IG5vdyBiZWNhdXNlIHRoZSBBdXRvQ29tcGxldGVWaWV3IG5lZWRzIGEgcmVmZXJlbmNlLlxuICAgICAqL1xuICAgIHZhciBBdXRvQ29tcGxldGUgPSBmdW5jdGlvbigpIHtcblxuICAgIH07XG4gICAgdmFyIHRoYXQ6IHsgYWN0aXZhdGU6ICgpID0+IHZvaWQ7IGRlYWN0aXZhdGU6ICgpID0+IHZvaWQ7IGlzQWN0aXZlOiAoKSA9PiBib29sZWFuIH0gPSBuZXcgQXV0b0NvbXBsZXRlKCk7XG4gICAgdGhhdC5pc0FjdGl2ZSA9IGlzQWN0aXZlO1xuICAgIHRoYXQuYWN0aXZhdGUgPSBhY3RpdmF0ZTtcbiAgICB0aGF0LmRlYWN0aXZhdGUgPSBkZWFjdGl2YXRlO1xuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKi9cbiAgICB2YXIgX2V2ZW50RW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXJDbGFzcygpO1xuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKi9cbiAgICB2YXIgX2FjdGl2ZTogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKi9cbiAgICB2YXIgX2hhbmRsZXI6IGFueSA9IG5ldyBIYXNoSGFuZGxlcigpO1xuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKi9cbiAgICB2YXIgX3ZpZXcgPSBuZXcgQXV0b0NvbXBsZXRlVmlldyhlZGl0b3IsIHRoYXQpO1xuICAgIC8vIHZhciBfdmlldyA9IG5ldyBwb3B1cC5MaXN0Vmlld1BvcHVwKGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KTtcblxuICAgIC8qKlxuICAgICAqXG4gICAgICovXG4gICAgdmFyIF9pbnB1dFRleHQgPSAnJztcblxuICAgIF9oYW5kbGVyLmF0dGFjaCA9IGZ1bmN0aW9uKCkge1xuXG4gICAgICAgIGVkaXRvci5hZGRFdmVudExpc3RlbmVyKFwiY2hhbmdlXCIsIG9uRWRpdG9yQ2hhbmdlKTtcblxuICAgICAgICBfZXZlbnRFbWl0dGVyLl9lbWl0KFwiYXR0YWNoXCIsIHsgJ3NlbmRlcic6IHRoYXQgfSk7XG4gICAgICAgIF9hY3RpdmUgPSB0cnVlO1xuICAgIH07XG5cbiAgICBfaGFuZGxlci5kZXRhY2ggPSBmdW5jdGlvbigpIHtcbiAgICAgICAgZWRpdG9yLnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJjaGFuZ2VcIiwgb25FZGl0b3JDaGFuZ2UpO1xuICAgICAgICBfdmlldy5oaWRlKCk7XG4gICAgICAgIF9ldmVudEVtaXR0ZXIuX2VtaXQoXCJkZXRhY2hcIiwgeyAnc2VuZGVyJzogdGhhdCB9KTtcbiAgICAgICAgX2FjdGl2ZSA9IGZhbHNlO1xuICAgIH07XG5cbiAgICBfaGFuZGxlci5oYW5kbGVLZXlib2FyZCA9IGZ1bmN0aW9uKGRhdGEsIGhhc2hJZCwga2V5LCBrZXlDb2RlKSB7XG5cbiAgICAgICAgaWYgKGhhc2hJZCA9PSAtMSkge1xuICAgICAgICAgICAgaWYgKFwiIC09LFtdXy8oKSEnOzo8PlwiLmluZGV4T2Yoa2V5KSAhPSAtMSkge1xuICAgICAgICAgICAgICAgIGRlYWN0aXZhdGUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFyIGNvbW1hbmQgPSBfaGFuZGxlci5maW5kS2V5Q29tbWFuZChoYXNoSWQsIGtleSk7XG5cbiAgICAgICAgaWYgKCFjb21tYW5kKSB7XG5cbiAgICAgICAgICAgIHZhciBkZWZhdWx0Q29tbWFuZCA9IGVkaXRvci5jb21tYW5kcy5maW5kS2V5Q29tbWFuZChoYXNoSWQsIGtleSk7XG4gICAgICAgICAgICBpZiAoZGVmYXVsdENvbW1hbmQpIHtcbiAgICAgICAgICAgICAgICBpZiAoZGVmYXVsdENvbW1hbmQubmFtZSA9PSBcImJhY2tzcGFjZVwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBkZWFjdGl2YXRlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0eXBlb2YgY29tbWFuZCAhPT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgICAgdmFyIGFyZ3MgPSBjb21tYW5kLmFyZ3M7XG4gICAgICAgICAgICBjb21tYW5kID0gY29tbWFuZC5jb21tYW5kO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHR5cGVvZiBjb21tYW5kID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICBjb21tYW5kID0gdGhpcy5jb21tYW5kc1tjb21tYW5kXTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB7ICdjb21tYW5kJzogY29tbWFuZCwgJ2FyZ3MnOiBhcmdzIH07XG5cbiAgICB9O1xuXG4gICAgX2hhbmRsZXIuYmluZEtleXMoeyBcIlVwfEN0cmwtcFwiOiBcIm1vdmVwcmV2XCIsIFwiRG93bnxDdHJsLW5cIjogXCJtb3ZlbmV4dFwiLCBcImVzY3xDdHJsLWdcIjogXCJjYW5jZWxcIiwgXCJSZXR1cm58VGFiXCI6IFwiaW5zZXJ0XCIgfSk7XG5cbiAgICBfaGFuZGxlci5hZGRDb21tYW5kcyh7XG4gICAgICAgIG1vdmVuZXh0OiBmdW5jdGlvbihlZGl0b3IpIHsgX3ZpZXcuZm9jdXNOZXh0KCk7IH0sXG4gICAgICAgIG1vdmVwcmV2OiBmdW5jdGlvbihlZGl0b3IpIHsgX3ZpZXcuZm9jdXNQcmV2KCk7IH0sXG4gICAgICAgIGNhbmNlbDogZnVuY3Rpb24oZWRpdG9yKSB7IGRlYWN0aXZhdGUoKTsgfSxcbiAgICAgICAgaW5zZXJ0OiBmdW5jdGlvbihlZGl0b3I6IEVkaXRvcikge1xuICAgICAgICAgICAgZWRpdG9yLnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJjaGFuZ2VcIiwgb25FZGl0b3JDaGFuZ2UpO1xuXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IF9pbnB1dFRleHQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBlZGl0b3IucmVtb3ZlKFwibGVmdFwiKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gVE9ETzogVGhpcyBpcyB3aGVyZSB0aGUgaW5zZXJ0aW9uIGhhcHBlbnMuXG4gICAgICAgICAgICB2YXIgY3VyciA9IF92aWV3LmN1cnJlbnQoKTtcbiAgICAgICAgICAgIGlmIChjdXJyKSB7XG4gICAgICAgICAgICAgICAgZWRpdG9yLmluc2VydCgkKGN1cnIpLmRhdGEoXCJuYW1lXCIpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRlYWN0aXZhdGUoKTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgZnVuY3Rpb24gaXNBY3RpdmUoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBfYWN0aXZlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybnMgdGhlIG51bWJlciBvZiBjb21wbGV0aW9ucyBhc3luY2hyb25vdXNseSBpbiB0aGUgY2FsbGJhY2sgd2l0aCB0aGUgc2lkZSBlZmZlY3Qgb2Ygc2hvd2luZyB0aGUgY29tcGxldGlvbnMuXG4gICAgICovXG4gICAgZnVuY3Rpb24gYWN0aXZhdGVVc2luZ0N1cnNvcihjdXJzb3I6IEN1cnNvclBvc2l0aW9uKSB7XG4gICAgICAgIGNvbXBsZXRpb25TZXJ2aWNlLmdldENvbXBsZXRpb25zQXRDdXJzb3IoZmlsZU5hbWVQcm92aWRlcigpLCBjdXJzb3IsIGZ1bmN0aW9uKGVyciwgY29tcGxldGlvbkluZm86IHRzLkNvbXBsZXRpb25JbmZvKSB7XG4gICAgICAgICAgICBpZiAoIWVycikge1xuICAgICAgICAgICAgICAgIC8vIEZJWE1FOiBUaGUgbWF0Y2hUZXh0IHNob3VsZCBub3QgYmUgdmlzaXNibGUsIG9yIHJhdGhlciBwYXJ0IG9mIHRoZSBjYWxsYmFjay5cbiAgICAgICAgICAgICAgICB2YXIgdGV4dCA9IGNvbXBsZXRpb25TZXJ2aWNlLm1hdGNoVGV4dDtcblxuICAgICAgICAgICAgICAgIF9pbnB1dFRleHQgPSB0ZXh0O1xuXG4gICAgICAgICAgICAgICAgdmFyIGNvbXBsZXRpb25zID0gY29tcGxldGlvbkluZm8gPyBjb21wbGV0aW9uSW5mby5lbnRyaWVzIDogbnVsbDtcblxuICAgICAgICAgICAgICAgIGlmIChjb21wbGV0aW9ucyAmJiBfaW5wdXRUZXh0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgY29tcGxldGlvbnMgPSBjb21wbGV0aW9ucy5maWx0ZXIoZnVuY3Rpb24oZWxtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxtLm5hbWUudG9Mb3dlckNhc2UoKS5pbmRleE9mKF9pbnB1dFRleHQudG9Mb3dlckNhc2UoKSkgPT09IDA7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGNvbXBsZXRpb25zID0gY29tcGxldGlvbnMgPyBjb21wbGV0aW9ucy5zb3J0KG1ha2VDb21wYXJlRm4oX2lucHV0VGV4dCkpIDogY29tcGxldGlvbnM7XG5cbiAgICAgICAgICAgICAgICBzaG93Q29tcGxldGlvbnMoY29tcGxldGlvbnMpO1xuXG4gICAgICAgICAgICAgICAgdmFyIGNvdW50ID0gY29tcGxldGlvbnMgPyBjb21wbGV0aW9ucy5sZW5ndGggOiAwO1xuICAgICAgICAgICAgICAgIGlmIChjb3VudCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgZWRpdG9yLmtleUJpbmRpbmcuYWRkS2V5Ym9hcmRIYW5kbGVyKF9oYW5kbGVyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiBzaG93Q29tcGxldGlvbnMoaW5mb3M6IHRzLkNvbXBsZXRpb25FbnRyeVtdKSB7XG4gICAgICAgICAgICAgICAgLy8gRklYTUU6IFRoZSAndmlldycgZG9lcyBub3Qgc2VlbSB0byBiZSB2ZXJ5IHdlbGwgZW5jYXBzdWxhdGVkIGhlcmUuXG4gICAgICAgICAgICAgICAgaWYgKGluZm9zICYmIGluZm9zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgZWRpdG9yLmNvbnRhaW5lci5hcHBlbmRDaGlsZChfdmlldy53cmFwKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGh0bWwgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgbiBpbiBpbmZvcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8ge25hbWUsIGtpbmQsIGtpbmRNb2RpZmllcnN9XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgaW5mbyA9IGluZm9zW25dO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5hbWUgPSAnPHNwYW4gY2xhc3M9XCJsYWJlbC1uYW1lXCI+JyArIGluZm8ubmFtZSArICc8L3NwYW4+JztcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBraW5kID0gJzxzcGFuIGNsYXNzPVwibGFiZWwta2luZCBsYWJlbC1raW5kLScgKyBpbmZvLmtpbmQgKyAnXCI+JyArIGluZm8ua2luZC5jaGFyQXQoMCkgKyAnPC9zcGFuPic7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGh0bWwgKz0gJzxsaSBkYXRhLW5hbWU9XCInICsgaW5mby5uYW1lICsgJ1wiPicgKyBraW5kICsgbmFtZSArICc8L2xpPic7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgICAgICAgICAgICBfdmlldy5zZXREYXRhKCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjb29yZHM6IHsgcGFnZVg6IG51bWJlcjsgcGFnZVk6IG51bWJlciB9ID0gZWRpdG9yLnJlbmRlcmVyLnRleHRUb1NjcmVlbkNvb3JkaW5hdGVzKGN1cnNvci5yb3csIGN1cnNvci5jb2x1bW4gLSB0ZXh0Lmxlbmd0aCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBsaW5lSGVpZ2h0ID0gOTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRvcGRvd25Pbmx5ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIF92aWV3LnNob3coY29vcmRzLyosIGxpbmVIZWlnaHQsIHRvcGRvd25Pbmx5Ki8pO1xuICAgICAgICAgICAgICAgICAgICBfdmlldy5saXN0RWxlbWVudC5pbm5lckhUTUwgPSBodG1sO1xuICAgICAgICAgICAgICAgICAgICBfdmlldy5lbnN1cmVGb2N1cygpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgX3ZpZXcuaGlkZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBMaXN0ZW5zIGZvciBjaGFuZ2VzIGluIHRoZSBlZGl0b3IgYW5kIG1heWJlIHNob3dzIHRoZSBjb21wbGV0aW9ucy5cbiAgICAgKi9cbiAgICBmdW5jdGlvbiBvbkVkaXRvckNoYW5nZShldmVudDogeyBkYXRhOiB7IGFjdGlvbjogc3RyaW5nOyB0ZXh0OiBzdHJpbmcgfSB9KTogdm9pZCB7XG4gICAgICAgIHZhciBjdXJzb3IgPSBlZGl0b3IuZ2V0Q3Vyc29yUG9zaXRpb24oKTtcbiAgICAgICAgaWYgKGV2ZW50LmRhdGEuYWN0aW9uID09IFwiaW5zZXJ0VGV4dFwiKSB7XG4gICAgICAgICAgICBhY3RpdmF0ZVVzaW5nQ3Vyc29yKHsgcm93OiBjdXJzb3Iucm93LCBjb2x1bW46IGN1cnNvci5jb2x1bW4gKyAxIH0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGV2ZW50LmRhdGEuYWN0aW9uID09IFwicmVtb3ZlVGV4dFwiKSB7XG4gICAgICAgICAgICBpZiAoZXZlbnQuZGF0YS50ZXh0ID09ICdcXG4nKSB7XG4gICAgICAgICAgICAgICAgZGVhY3RpdmF0ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgYWN0aXZhdGVVc2luZ0N1cnNvcihjdXJzb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgYWN0aXZhdGVVc2luZ0N1cnNvcihjdXJzb3IpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gYWN0aXZhdGUoKTogdm9pZCB7XG4gICAgICAgIGFjdGl2YXRlVXNpbmdDdXJzb3IoZWRpdG9yLmdldEN1cnNvclBvc2l0aW9uKCkpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGRlYWN0aXZhdGUoKSB7XG4gICAgICAgIGVkaXRvci5rZXlCaW5kaW5nLnJlbW92ZUtleWJvYXJkSGFuZGxlcihfaGFuZGxlcik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoYXQ7XG59Il19