import { HashHandler } from '../../keyboard/hash_handler';
import { EventEmitterClass } from '../../lib/event_emitter';
import AutoCompleteView from '../../mode/typescript/AutoCompleteView';
function makeCompareFn(text) {
    return function (a, b) {
        var matchFunc = function (entry) {
            return entry.name.indexOf(text) === 0 ? 1 : 0;
        };
        var matchCompare = function () {
            return matchFunc(b) - matchFunc(a);
        };
        var textCompare = function () {
            if (a.name === b.name) {
                return 0;
            }
            else {
                return (a.name > b.name) ? 1 : -1;
            }
        };
        var ret = matchCompare();
        return (ret !== 0) ? ret : textCompare();
    };
}
export default function autoComplete(editor, fileNameProvider, completionService) {
    var AutoComplete = function () {
    };
    var that = new AutoComplete();
    that.isActive = isActive;
    that.activate = activate;
    that.deactivate = deactivate;
    var _eventEmitter = new EventEmitterClass();
    var _active = false;
    var _handler = new HashHandler();
    var _view = new AutoCompleteView(editor, that);
    var _inputText = '';
    _handler.attach = function () {
        editor.addEventListener("change", onEditorChange);
        _eventEmitter._emit("attach", { 'sender': that });
        _active = true;
    };
    _handler.detach = function () {
        editor.removeEventListener("change", onEditorChange);
        _view.hide();
        _eventEmitter._emit("detach", { 'sender': that });
        _active = false;
    };
    _handler.handleKeyboard = function (data, hashId, key, keyCode) {
        if (hashId == -1) {
            if (" -=,[]_/()!';:<>".indexOf(key) != -1) {
                deactivate();
            }
            return null;
        }
        var command = _handler.findKeyCommand(hashId, key);
        if (!command) {
            var defaultCommand = editor.commands.findKeyCommand(hashId, key);
            if (defaultCommand) {
                if (defaultCommand.name == "backspace") {
                    return null;
                }
                deactivate();
            }
            return null;
        }
        if (typeof command !== "string") {
            var args = command.args;
            command = command.command;
        }
        if (typeof command === "string") {
            command = this.commands[command];
        }
        return { 'command': command, 'args': args };
    };
    _handler.bindKeys({ "Up|Ctrl-p": "moveprev", "Down|Ctrl-n": "movenext", "esc|Ctrl-g": "cancel", "Return|Tab": "insert" });
    _handler.addCommands({
        movenext: function (editor) { _view.focusNext(); },
        moveprev: function (editor) { _view.focusPrev(); },
        cancel: function (editor) { deactivate(); },
        insert: function (editor) {
            editor.removeEventListener("change", onEditorChange);
            for (var i = 0; i < _inputText.length; i++) {
                editor.remove("left");
            }
            var curr = _view.current();
            if (curr) {
                editor.insert($(curr).data("name"));
            }
            deactivate();
        }
    });
    function isActive() {
        return _active;
    }
    function activateUsingCursor(cursor) {
        completionService.getCompletionsAtCursor(fileNameProvider(), cursor, function (err, completionInfo) {
            if (!err) {
                var text = completionService.matchText;
                _inputText = text;
                var completions = completionInfo ? completionInfo.entries : null;
                if (completions && _inputText.length > 0) {
                    completions = completions.filter(function (elm) {
                        return elm.name.toLowerCase().indexOf(_inputText.toLowerCase()) === 0;
                    });
                }
                completions = completions ? completions.sort(makeCompareFn(_inputText)) : completions;
                showCompletions(completions);
                var count = completions ? completions.length : 0;
                if (count > 0) {
                    editor.keyBinding.addKeyboardHandler(_handler);
                }
            }
            function showCompletions(infos) {
                if (infos && infos.length > 0) {
                    editor.container.appendChild(_view.wrap);
                    var html = '';
                    for (var n in infos) {
                        var info = infos[n];
                        var name = '<span class="label-name">' + info.name + '</span>';
                        var kind = '<span class="label-kind label-kind-' + info.kind + '">' + info.kind.charAt(0) + '</span>';
                        html += '<li data-name="' + info.name + '">' + kind + name + '</li>';
                    }
                    var coords = editor.renderer.textToScreenCoordinates(cursor.row, cursor.column - text.length);
                    var lineHeight = 9;
                    var topdownOnly = false;
                    _view.show(coords);
                    _view.listElement.innerHTML = html;
                    _view.ensureFocus();
                }
                else {
                    _view.hide();
                }
            }
        });
    }
    function onEditorChange(event) {
        var cursor = editor.getCursorPosition();
        if (event.data.action == "insertText") {
            activateUsingCursor({ row: cursor.row, column: cursor.column + 1 });
        }
        else if (event.data.action == "removeText") {
            if (event.data.text == '\n') {
                deactivate();
            }
            else {
                activateUsingCursor(cursor);
            }
        }
        else {
            activateUsingCursor(cursor);
        }
    }
    function activate() {
        activateUsingCursor(editor.getCursorPosition());
    }
    function deactivate() {
        editor.keyBinding.removeKeyboardHandler(_handler);
    }
    return that;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0b0NvbXBsZXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL21vZGUvdHlwZXNjcmlwdC9hdXRvQ29tcGxldGUudHMiXSwibmFtZXMiOlsibWFrZUNvbXBhcmVGbiIsImF1dG9Db21wbGV0ZSIsImF1dG9Db21wbGV0ZS5pc0FjdGl2ZSIsImF1dG9Db21wbGV0ZS5hY3RpdmF0ZVVzaW5nQ3Vyc29yIiwic2hvd0NvbXBsZXRpb25zIiwiYXV0b0NvbXBsZXRlLm9uRWRpdG9yQ2hhbmdlIiwiYXV0b0NvbXBsZXRlLmFjdGl2YXRlIiwiYXV0b0NvbXBsZXRlLmRlYWN0aXZhdGUiXSwibWFwcGluZ3MiOiJPQUdPLEVBQUMsV0FBVyxFQUFDLE1BQU0sNkJBQTZCO09BRWhELEVBQUMsaUJBQWlCLEVBQUMsTUFBTSx5QkFBeUI7T0FHbEQsZ0JBQWdCLE1BQU0sd0NBQXdDO0FBTXJFLHVCQUF1QixJQUFZO0lBQy9CQSxNQUFNQSxDQUFDQSxVQUFTQSxDQUFxQkEsRUFBRUEsQ0FBcUJBO1FBQ3hELElBQUksU0FBUyxHQUFHLFVBQVMsS0FBeUI7WUFDOUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2xELENBQUMsQ0FBQztRQUNGLElBQUksWUFBWSxHQUFHO1lBQ2YsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDdkMsQ0FBQyxDQUFDO1FBQ0YsSUFBSSxXQUFXLEdBQUc7WUFDZCxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUNwQixNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ2IsQ0FBQztZQUNELElBQUksQ0FBQyxDQUFDO2dCQUNGLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUN0QyxDQUFDO1FBQ0wsQ0FBQyxDQUFDO1FBQ0YsSUFBSSxHQUFHLEdBQUcsWUFBWSxFQUFFLENBQUM7UUFDekIsTUFBTSxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxXQUFXLEVBQUUsQ0FBQztJQUM3QyxDQUFDLENBQUNBO0FBQ05BLENBQUNBO0FBT0QscUNBQXFDLE1BQWMsRUFBRSxnQkFBOEIsRUFBRSxpQkFBb0M7SUFJckhDLElBQUlBLFlBQVlBLEdBQUdBO0lBRW5CLENBQUMsQ0FBQ0E7SUFDRkEsSUFBSUEsSUFBSUEsR0FBOEVBLElBQUlBLFlBQVlBLEVBQUVBLENBQUNBO0lBQ3pHQSxJQUFJQSxDQUFDQSxRQUFRQSxHQUFHQSxRQUFRQSxDQUFDQTtJQUN6QkEsSUFBSUEsQ0FBQ0EsUUFBUUEsR0FBR0EsUUFBUUEsQ0FBQ0E7SUFDekJBLElBQUlBLENBQUNBLFVBQVVBLEdBQUdBLFVBQVVBLENBQUNBO0lBSzdCQSxJQUFJQSxhQUFhQSxHQUFHQSxJQUFJQSxpQkFBaUJBLEVBQUVBLENBQUNBO0lBSzVDQSxJQUFJQSxPQUFPQSxHQUFZQSxLQUFLQSxDQUFDQTtJQUs3QkEsSUFBSUEsUUFBUUEsR0FBUUEsSUFBSUEsV0FBV0EsRUFBRUEsQ0FBQ0E7SUFLdENBLElBQUlBLEtBQUtBLEdBQUdBLElBQUlBLGdCQUFnQkEsQ0FBQ0EsTUFBTUEsRUFBRUEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7SUFNL0NBLElBQUlBLFVBQVVBLEdBQUdBLEVBQUVBLENBQUNBO0lBRXBCQSxRQUFRQSxDQUFDQSxNQUFNQSxHQUFHQTtRQUVkLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsY0FBYyxDQUFDLENBQUM7UUFFbEQsYUFBYSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsRUFBRSxRQUFRLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUNsRCxPQUFPLEdBQUcsSUFBSSxDQUFDO0lBQ25CLENBQUMsQ0FBQ0E7SUFFRkEsUUFBUUEsQ0FBQ0EsTUFBTUEsR0FBR0E7UUFDZCxNQUFNLENBQUMsbUJBQW1CLENBQUMsUUFBUSxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBQ3JELEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNiLGFBQWEsQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFDbEQsT0FBTyxHQUFHLEtBQUssQ0FBQztJQUNwQixDQUFDLENBQUNBO0lBRUZBLFFBQVFBLENBQUNBLGNBQWNBLEdBQUdBLFVBQVNBLElBQUlBLEVBQUVBLE1BQU1BLEVBQUVBLEdBQUdBLEVBQUVBLE9BQU9BO1FBRXpELEVBQUUsQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDZixFQUFFLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN4QyxVQUFVLEVBQUUsQ0FBQztZQUNqQixDQUFDO1lBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQztRQUNoQixDQUFDO1FBRUQsSUFBSSxPQUFPLEdBQUcsUUFBUSxDQUFDLGNBQWMsQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFFbkQsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBRVgsSUFBSSxjQUFjLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ2pFLEVBQUUsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2pCLEVBQUUsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxJQUFJLElBQUksV0FBVyxDQUFDLENBQUMsQ0FBQztvQkFDckMsTUFBTSxDQUFDLElBQUksQ0FBQztnQkFDaEIsQ0FBQztnQkFDRCxVQUFVLEVBQUUsQ0FBQztZQUNqQixDQUFDO1lBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQztRQUNoQixDQUFDO1FBRUQsRUFBRSxDQUFDLENBQUMsT0FBTyxPQUFPLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQztZQUM5QixJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDO1lBQ3hCLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDO1FBQzlCLENBQUM7UUFFRCxFQUFFLENBQUMsQ0FBQyxPQUFPLE9BQU8sS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQzlCLE9BQU8sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3JDLENBQUM7UUFFRCxNQUFNLENBQUMsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQztJQUVoRCxDQUFDLENBQUNBO0lBRUZBLFFBQVFBLENBQUNBLFFBQVFBLENBQUNBLEVBQUVBLFdBQVdBLEVBQUVBLFVBQVVBLEVBQUVBLGFBQWFBLEVBQUVBLFVBQVVBLEVBQUVBLFlBQVlBLEVBQUVBLFFBQVFBLEVBQUVBLFlBQVlBLEVBQUVBLFFBQVFBLEVBQUVBLENBQUNBLENBQUNBO0lBRTFIQSxRQUFRQSxDQUFDQSxXQUFXQSxDQUFDQTtRQUNqQkEsUUFBUUEsRUFBRUEsVUFBU0EsTUFBTUEsSUFBSSxLQUFLLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ2pEQSxRQUFRQSxFQUFFQSxVQUFTQSxNQUFNQSxJQUFJLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDakRBLE1BQU1BLEVBQUVBLFVBQVNBLE1BQU1BLElBQUksVUFBVSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQzFDQSxNQUFNQSxFQUFFQSxVQUFTQSxNQUFjQTtZQUMzQixNQUFNLENBQUMsbUJBQW1CLENBQUMsUUFBUSxFQUFFLGNBQWMsQ0FBQyxDQUFDO1lBRXJELEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxVQUFVLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7Z0JBQ3pDLE1BQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDMUIsQ0FBQztZQUdELElBQUksSUFBSSxHQUFHLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUMzQixFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUNQLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ3hDLENBQUM7WUFDRCxVQUFVLEVBQUUsQ0FBQztRQUNqQixDQUFDO0tBQ0pBLENBQUNBLENBQUNBO0lBRUhBO1FBQ0lDLE1BQU1BLENBQUNBLE9BQU9BLENBQUNBO0lBQ25CQSxDQUFDQTtJQUtERCw2QkFBNkJBLE1BQXNCQTtRQUMvQ0UsaUJBQWlCQSxDQUFDQSxzQkFBc0JBLENBQUNBLGdCQUFnQkEsRUFBRUEsRUFBRUEsTUFBTUEsRUFBRUEsVUFBU0EsR0FBR0EsRUFBRUEsY0FBaUNBO1lBQ2hILEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztnQkFFUCxJQUFJLElBQUksR0FBRyxpQkFBaUIsQ0FBQyxTQUFTLENBQUM7Z0JBRXZDLFVBQVUsR0FBRyxJQUFJLENBQUM7Z0JBRWxCLElBQUksV0FBVyxHQUFHLGNBQWMsR0FBRyxjQUFjLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztnQkFFakUsRUFBRSxDQUFDLENBQUMsV0FBVyxJQUFJLFVBQVUsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDdkMsV0FBVyxHQUFHLFdBQVcsQ0FBQyxNQUFNLENBQUMsVUFBUyxHQUFHO3dCQUN6QyxNQUFNLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQyxPQUFPLENBQUMsVUFBVSxDQUFDLFdBQVcsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDO29CQUMxRSxDQUFDLENBQUMsQ0FBQztnQkFDUCxDQUFDO2dCQUVELFdBQVcsR0FBRyxXQUFXLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUMsR0FBRyxXQUFXLENBQUM7Z0JBRXRGLGVBQWUsQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFFN0IsSUFBSSxLQUFLLEdBQUcsV0FBVyxHQUFHLFdBQVcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO2dCQUNqRCxFQUFFLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztvQkFDWixNQUFNLENBQUMsVUFBVSxDQUFDLGtCQUFrQixDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUNuRCxDQUFDO1lBQ0wsQ0FBQztZQUNELHlCQUF5QixLQUEyQjtnQkFFaERDLEVBQUVBLENBQUNBLENBQUNBLEtBQUtBLElBQUlBLEtBQUtBLENBQUNBLE1BQU1BLEdBQUdBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO29CQUM1QkEsTUFBTUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsV0FBV0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7b0JBQ3pDQSxJQUFJQSxJQUFJQSxHQUFHQSxFQUFFQSxDQUFDQTtvQkFDZEEsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7d0JBRWxCQSxJQUFJQSxJQUFJQSxHQUFHQSxLQUFLQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTt3QkFDcEJBLElBQUlBLElBQUlBLEdBQUdBLDJCQUEyQkEsR0FBR0EsSUFBSUEsQ0FBQ0EsSUFBSUEsR0FBR0EsU0FBU0EsQ0FBQ0E7d0JBQy9EQSxJQUFJQSxJQUFJQSxHQUFHQSxxQ0FBcUNBLEdBQUdBLElBQUlBLENBQUNBLElBQUlBLEdBQUdBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLENBQUNBLENBQUNBLENBQUNBLEdBQUdBLFNBQVNBLENBQUNBO3dCQUV0R0EsSUFBSUEsSUFBSUEsaUJBQWlCQSxHQUFHQSxJQUFJQSxDQUFDQSxJQUFJQSxHQUFHQSxJQUFJQSxHQUFHQSxJQUFJQSxHQUFHQSxJQUFJQSxHQUFHQSxPQUFPQSxDQUFDQTtvQkFDekVBLENBQUNBO29CQUVEQSxJQUFJQSxNQUFNQSxHQUFxQ0EsTUFBTUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsdUJBQXVCQSxDQUFDQSxNQUFNQSxDQUFDQSxHQUFHQSxFQUFFQSxNQUFNQSxDQUFDQSxNQUFNQSxHQUFHQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQTtvQkFDaElBLElBQUlBLFVBQVVBLEdBQUdBLENBQUNBLENBQUNBO29CQUNuQkEsSUFBSUEsV0FBV0EsR0FBR0EsS0FBS0EsQ0FBQ0E7b0JBQ3hCQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUE4QkEsQ0FBQ0E7b0JBQ2hEQSxLQUFLQSxDQUFDQSxXQUFXQSxDQUFDQSxTQUFTQSxHQUFHQSxJQUFJQSxDQUFDQTtvQkFDbkNBLEtBQUtBLENBQUNBLFdBQVdBLEVBQUVBLENBQUNBO2dCQUN4QkEsQ0FBQ0E7Z0JBQ0RBLElBQUlBLENBQUNBLENBQUNBO29CQUNGQSxLQUFLQSxDQUFDQSxJQUFJQSxFQUFFQSxDQUFDQTtnQkFDakJBLENBQUNBO1lBQ0xBLENBQUNBO1FBQ0wsQ0FBQyxDQUFDRCxDQUFDQTtJQUVQQSxDQUFDQTtJQUtERix3QkFBd0JBLEtBQWlEQTtRQUNyRUksSUFBSUEsTUFBTUEsR0FBR0EsTUFBTUEsQ0FBQ0EsaUJBQWlCQSxFQUFFQSxDQUFDQTtRQUN4Q0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsSUFBSUEsWUFBWUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDcENBLG1CQUFtQkEsQ0FBQ0EsRUFBRUEsR0FBR0EsRUFBRUEsTUFBTUEsQ0FBQ0EsR0FBR0EsRUFBRUEsTUFBTUEsRUFBRUEsTUFBTUEsQ0FBQ0EsTUFBTUEsR0FBR0EsQ0FBQ0EsRUFBRUEsQ0FBQ0EsQ0FBQ0E7UUFDeEVBLENBQUNBO1FBQ0RBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLEtBQUtBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLElBQUlBLFlBQVlBLENBQUNBLENBQUNBLENBQUNBO1lBQ3pDQSxFQUFFQSxDQUFDQSxDQUFDQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxJQUFJQSxJQUFJQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDMUJBLFVBQVVBLEVBQUVBLENBQUNBO1lBQ2pCQSxDQUFDQTtZQUNEQSxJQUFJQSxDQUFDQSxDQUFDQTtnQkFDRkEsbUJBQW1CQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQTtZQUNoQ0EsQ0FBQ0E7UUFDTEEsQ0FBQ0E7UUFDREEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7WUFDRkEsbUJBQW1CQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQTtRQUNoQ0EsQ0FBQ0E7SUFDTEEsQ0FBQ0E7SUFFREo7UUFDSUssbUJBQW1CQSxDQUFDQSxNQUFNQSxDQUFDQSxpQkFBaUJBLEVBQUVBLENBQUNBLENBQUNBO0lBQ3BEQSxDQUFDQTtJQUVETDtRQUNJTSxNQUFNQSxDQUFDQSxVQUFVQSxDQUFDQSxxQkFBcUJBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBO0lBQ3REQSxDQUFDQTtJQUVETixNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQTtBQUNoQkEsQ0FBQ0EiLCJzb3VyY2VzQ29udGVudCI6WyJkZWNsYXJlIHZhciAkOiBhbnk7XG5cbmltcG9ydCBDdXJzb3JQb3NpdGlvbiBmcm9tICcuLi8uLi9DdXJzb3JQb3NpdGlvbic7XG5pbXBvcnQge0hhc2hIYW5kbGVyfSBmcm9tICcuLi8uLi9rZXlib2FyZC9oYXNoX2hhbmRsZXInO1xuaW1wb3J0IHt9IGZyb20gXCIuLi8uLi9saWIvb29wXCI7XG5pbXBvcnQge0V2ZW50RW1pdHRlckNsYXNzfSBmcm9tICcuLi8uLi9saWIvZXZlbnRfZW1pdHRlcic7XG5pbXBvcnQgRWRpdG9yIGZyb20gJy4uLy4uL0VkaXRvcic7XG5pbXBvcnQgQ29tcGxldGlvblNlcnZpY2UgZnJvbSAnLi9Db21wbGV0aW9uU2VydmljZSc7XG5pbXBvcnQgQXV0b0NvbXBsZXRlVmlldyBmcm9tICcuLi8uLi9tb2RlL3R5cGVzY3JpcHQvQXV0b0NvbXBsZXRlVmlldyc7XG4vL2ltcG9ydCBwb3B1cCA9IHJlcXVpcmUoJy4uLy4uL2F1dG9jb21wbGV0ZS9wb3B1cCcpO1xuXG4vKipcbiAqIE1ha2VzIGEgZnVuY3Rpb24gdGhhdCBjYW4gYmUgdXNlZCB0byBjb21wYXJlIGNvbXBsZXRpb24gZW50cmllcyBmb3Igc29ydGluZyBwdXJwb3Nlcy5cbiAqL1xuZnVuY3Rpb24gbWFrZUNvbXBhcmVGbih0ZXh0OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gZnVuY3Rpb24oYTogdHMuQ29tcGxldGlvbkVudHJ5LCBiOiB0cy5Db21wbGV0aW9uRW50cnkpIHtcbiAgICAgICAgdmFyIG1hdGNoRnVuYyA9IGZ1bmN0aW9uKGVudHJ5OiB0cy5Db21wbGV0aW9uRW50cnkpOiBudW1iZXIge1xuICAgICAgICAgICAgcmV0dXJuIGVudHJ5Lm5hbWUuaW5kZXhPZih0ZXh0KSA9PT0gMCA/IDEgOiAwO1xuICAgICAgICB9O1xuICAgICAgICB2YXIgbWF0Y2hDb21wYXJlID0gZnVuY3Rpb24oKTogbnVtYmVyIHtcbiAgICAgICAgICAgIHJldHVybiBtYXRjaEZ1bmMoYikgLSBtYXRjaEZ1bmMoYSk7XG4gICAgICAgIH07XG4gICAgICAgIHZhciB0ZXh0Q29tcGFyZSA9IGZ1bmN0aW9uKCk6IG51bWJlciB7XG4gICAgICAgICAgICBpZiAoYS5uYW1lID09PSBiLm5hbWUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiAoYS5uYW1lID4gYi5uYW1lKSA/IDEgOiAtMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgdmFyIHJldCA9IG1hdGNoQ29tcGFyZSgpO1xuICAgICAgICByZXR1cm4gKHJldCAhPT0gMCkgPyByZXQgOiB0ZXh0Q29tcGFyZSgpO1xuICAgIH07XG59XG5cbi8qKlxuICogVXNpbmcgdGhlIGZ1bmN0aW9uYWwgY29uc3RydWN0b3IgcGF0dGVybiBoZXJlIGJlY2F1c2UgJ3RoaXMnIGlzIHRvbyBlcnJvci1wcm9uZS5cbiAqXG4gKiBBY2NvcmRpbmdseSwgdGhlIGZ1bmN0aW9uIGlzIGNhbWVsQ2FzZSBhbmQgaXMgbm90IGNhbGxlZCB1c2luZyB0aGUgJ25ldycgb3BlcmF0b3IuXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGF1dG9Db21wbGV0ZShlZGl0b3I6IEVkaXRvciwgZmlsZU5hbWVQcm92aWRlcjogKCkgPT4gc3RyaW5nLCBjb21wbGV0aW9uU2VydmljZTogQ29tcGxldGlvblNlcnZpY2UpIHtcbiAgICAvKipcbiAgICAgKiBEZWNsYXJlIHRoZSByZXR1cm4gb2JqZWN0IG5vdyBiZWNhdXNlIHRoZSBBdXRvQ29tcGxldGVWaWV3IG5lZWRzIGEgcmVmZXJlbmNlLlxuICAgICAqL1xuICAgIHZhciBBdXRvQ29tcGxldGUgPSBmdW5jdGlvbigpIHtcblxuICAgIH07XG4gICAgdmFyIHRoYXQ6IHsgYWN0aXZhdGU6ICgpID0+IHZvaWQ7IGRlYWN0aXZhdGU6ICgpID0+IHZvaWQ7IGlzQWN0aXZlOiAoKSA9PiBib29sZWFuIH0gPSBuZXcgQXV0b0NvbXBsZXRlKCk7XG4gICAgdGhhdC5pc0FjdGl2ZSA9IGlzQWN0aXZlO1xuICAgIHRoYXQuYWN0aXZhdGUgPSBhY3RpdmF0ZTtcbiAgICB0aGF0LmRlYWN0aXZhdGUgPSBkZWFjdGl2YXRlO1xuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKi9cbiAgICB2YXIgX2V2ZW50RW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXJDbGFzcygpO1xuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKi9cbiAgICB2YXIgX2FjdGl2ZTogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKi9cbiAgICB2YXIgX2hhbmRsZXI6IGFueSA9IG5ldyBIYXNoSGFuZGxlcigpO1xuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKi9cbiAgICB2YXIgX3ZpZXcgPSBuZXcgQXV0b0NvbXBsZXRlVmlldyhlZGl0b3IsIHRoYXQpO1xuICAgIC8vIHZhciBfdmlldyA9IG5ldyBwb3B1cC5MaXN0Vmlld1BvcHVwKGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KTtcblxuICAgIC8qKlxuICAgICAqXG4gICAgICovXG4gICAgdmFyIF9pbnB1dFRleHQgPSAnJztcblxuICAgIF9oYW5kbGVyLmF0dGFjaCA9IGZ1bmN0aW9uKCkge1xuXG4gICAgICAgIGVkaXRvci5hZGRFdmVudExpc3RlbmVyKFwiY2hhbmdlXCIsIG9uRWRpdG9yQ2hhbmdlKTtcblxuICAgICAgICBfZXZlbnRFbWl0dGVyLl9lbWl0KFwiYXR0YWNoXCIsIHsgJ3NlbmRlcic6IHRoYXQgfSk7XG4gICAgICAgIF9hY3RpdmUgPSB0cnVlO1xuICAgIH07XG5cbiAgICBfaGFuZGxlci5kZXRhY2ggPSBmdW5jdGlvbigpIHtcbiAgICAgICAgZWRpdG9yLnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJjaGFuZ2VcIiwgb25FZGl0b3JDaGFuZ2UpO1xuICAgICAgICBfdmlldy5oaWRlKCk7XG4gICAgICAgIF9ldmVudEVtaXR0ZXIuX2VtaXQoXCJkZXRhY2hcIiwgeyAnc2VuZGVyJzogdGhhdCB9KTtcbiAgICAgICAgX2FjdGl2ZSA9IGZhbHNlO1xuICAgIH07XG5cbiAgICBfaGFuZGxlci5oYW5kbGVLZXlib2FyZCA9IGZ1bmN0aW9uKGRhdGEsIGhhc2hJZCwga2V5LCBrZXlDb2RlKSB7XG5cbiAgICAgICAgaWYgKGhhc2hJZCA9PSAtMSkge1xuICAgICAgICAgICAgaWYgKFwiIC09LFtdXy8oKSEnOzo8PlwiLmluZGV4T2Yoa2V5KSAhPSAtMSkge1xuICAgICAgICAgICAgICAgIGRlYWN0aXZhdGUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFyIGNvbW1hbmQgPSBfaGFuZGxlci5maW5kS2V5Q29tbWFuZChoYXNoSWQsIGtleSk7XG5cbiAgICAgICAgaWYgKCFjb21tYW5kKSB7XG5cbiAgICAgICAgICAgIHZhciBkZWZhdWx0Q29tbWFuZCA9IGVkaXRvci5jb21tYW5kcy5maW5kS2V5Q29tbWFuZChoYXNoSWQsIGtleSk7XG4gICAgICAgICAgICBpZiAoZGVmYXVsdENvbW1hbmQpIHtcbiAgICAgICAgICAgICAgICBpZiAoZGVmYXVsdENvbW1hbmQubmFtZSA9PSBcImJhY2tzcGFjZVwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBkZWFjdGl2YXRlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0eXBlb2YgY29tbWFuZCAhPT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgICAgdmFyIGFyZ3MgPSBjb21tYW5kLmFyZ3M7XG4gICAgICAgICAgICBjb21tYW5kID0gY29tbWFuZC5jb21tYW5kO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHR5cGVvZiBjb21tYW5kID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICBjb21tYW5kID0gdGhpcy5jb21tYW5kc1tjb21tYW5kXTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB7ICdjb21tYW5kJzogY29tbWFuZCwgJ2FyZ3MnOiBhcmdzIH07XG5cbiAgICB9O1xuXG4gICAgX2hhbmRsZXIuYmluZEtleXMoeyBcIlVwfEN0cmwtcFwiOiBcIm1vdmVwcmV2XCIsIFwiRG93bnxDdHJsLW5cIjogXCJtb3ZlbmV4dFwiLCBcImVzY3xDdHJsLWdcIjogXCJjYW5jZWxcIiwgXCJSZXR1cm58VGFiXCI6IFwiaW5zZXJ0XCIgfSk7XG5cbiAgICBfaGFuZGxlci5hZGRDb21tYW5kcyh7XG4gICAgICAgIG1vdmVuZXh0OiBmdW5jdGlvbihlZGl0b3IpIHsgX3ZpZXcuZm9jdXNOZXh0KCk7IH0sXG4gICAgICAgIG1vdmVwcmV2OiBmdW5jdGlvbihlZGl0b3IpIHsgX3ZpZXcuZm9jdXNQcmV2KCk7IH0sXG4gICAgICAgIGNhbmNlbDogZnVuY3Rpb24oZWRpdG9yKSB7IGRlYWN0aXZhdGUoKTsgfSxcbiAgICAgICAgaW5zZXJ0OiBmdW5jdGlvbihlZGl0b3I6IEVkaXRvcikge1xuICAgICAgICAgICAgZWRpdG9yLnJlbW92ZUV2ZW50TGlzdGVuZXIoXCJjaGFuZ2VcIiwgb25FZGl0b3JDaGFuZ2UpO1xuXG4gICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IF9pbnB1dFRleHQubGVuZ3RoOyBpKyspIHtcbiAgICAgICAgICAgICAgICBlZGl0b3IucmVtb3ZlKFwibGVmdFwiKTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgLy8gVE9ETzogVGhpcyBpcyB3aGVyZSB0aGUgaW5zZXJ0aW9uIGhhcHBlbnMuXG4gICAgICAgICAgICB2YXIgY3VyciA9IF92aWV3LmN1cnJlbnQoKTtcbiAgICAgICAgICAgIGlmIChjdXJyKSB7XG4gICAgICAgICAgICAgICAgZWRpdG9yLmluc2VydCgkKGN1cnIpLmRhdGEoXCJuYW1lXCIpKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGRlYWN0aXZhdGUoKTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgZnVuY3Rpb24gaXNBY3RpdmUoKTogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBfYWN0aXZlO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIFJldHVybnMgdGhlIG51bWJlciBvZiBjb21wbGV0aW9ucyBhc3luY2hyb25vdXNseSBpbiB0aGUgY2FsbGJhY2sgd2l0aCB0aGUgc2lkZSBlZmZlY3Qgb2Ygc2hvd2luZyB0aGUgY29tcGxldGlvbnMuXG4gICAgICovXG4gICAgZnVuY3Rpb24gYWN0aXZhdGVVc2luZ0N1cnNvcihjdXJzb3I6IEN1cnNvclBvc2l0aW9uKSB7XG4gICAgICAgIGNvbXBsZXRpb25TZXJ2aWNlLmdldENvbXBsZXRpb25zQXRDdXJzb3IoZmlsZU5hbWVQcm92aWRlcigpLCBjdXJzb3IsIGZ1bmN0aW9uKGVyciwgY29tcGxldGlvbkluZm86IHRzLkNvbXBsZXRpb25JbmZvKSB7XG4gICAgICAgICAgICBpZiAoIWVycikge1xuICAgICAgICAgICAgICAgIC8vIEZJWE1FOiBUaGUgbWF0Y2hUZXh0IHNob3VsZCBub3QgYmUgdmlzaXNibGUsIG9yIHJhdGhlciBwYXJ0IG9mIHRoZSBjYWxsYmFjay5cbiAgICAgICAgICAgICAgICB2YXIgdGV4dCA9IGNvbXBsZXRpb25TZXJ2aWNlLm1hdGNoVGV4dDtcblxuICAgICAgICAgICAgICAgIF9pbnB1dFRleHQgPSB0ZXh0O1xuXG4gICAgICAgICAgICAgICAgdmFyIGNvbXBsZXRpb25zID0gY29tcGxldGlvbkluZm8gPyBjb21wbGV0aW9uSW5mby5lbnRyaWVzIDogbnVsbDtcblxuICAgICAgICAgICAgICAgIGlmIChjb21wbGV0aW9ucyAmJiBfaW5wdXRUZXh0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgY29tcGxldGlvbnMgPSBjb21wbGV0aW9ucy5maWx0ZXIoZnVuY3Rpb24oZWxtKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZWxtLm5hbWUudG9Mb3dlckNhc2UoKS5pbmRleE9mKF9pbnB1dFRleHQudG9Mb3dlckNhc2UoKSkgPT09IDA7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgICAgIGNvbXBsZXRpb25zID0gY29tcGxldGlvbnMgPyBjb21wbGV0aW9ucy5zb3J0KG1ha2VDb21wYXJlRm4oX2lucHV0VGV4dCkpIDogY29tcGxldGlvbnM7XG5cbiAgICAgICAgICAgICAgICBzaG93Q29tcGxldGlvbnMoY29tcGxldGlvbnMpO1xuXG4gICAgICAgICAgICAgICAgdmFyIGNvdW50ID0gY29tcGxldGlvbnMgPyBjb21wbGV0aW9ucy5sZW5ndGggOiAwO1xuICAgICAgICAgICAgICAgIGlmIChjb3VudCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgZWRpdG9yLmtleUJpbmRpbmcuYWRkS2V5Ym9hcmRIYW5kbGVyKF9oYW5kbGVyKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBmdW5jdGlvbiBzaG93Q29tcGxldGlvbnMoaW5mb3M6IHRzLkNvbXBsZXRpb25FbnRyeVtdKSB7XG4gICAgICAgICAgICAgICAgLy8gRklYTUU6IFRoZSAndmlldycgZG9lcyBub3Qgc2VlbSB0byBiZSB2ZXJ5IHdlbGwgZW5jYXBzdWxhdGVkIGhlcmUuXG4gICAgICAgICAgICAgICAgaWYgKGluZm9zICYmIGluZm9zLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICAgICAgZWRpdG9yLmNvbnRhaW5lci5hcHBlbmRDaGlsZChfdmlldy53cmFwKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGh0bWwgPSAnJztcbiAgICAgICAgICAgICAgICAgICAgZm9yICh2YXIgbiBpbiBpbmZvcykge1xuICAgICAgICAgICAgICAgICAgICAgICAgLy8ge25hbWUsIGtpbmQsIGtpbmRNb2RpZmllcnN9XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgaW5mbyA9IGluZm9zW25dO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIG5hbWUgPSAnPHNwYW4gY2xhc3M9XCJsYWJlbC1uYW1lXCI+JyArIGluZm8ubmFtZSArICc8L3NwYW4+JztcbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBraW5kID0gJzxzcGFuIGNsYXNzPVwibGFiZWwta2luZCBsYWJlbC1raW5kLScgKyBpbmZvLmtpbmQgKyAnXCI+JyArIGluZm8ua2luZC5jaGFyQXQoMCkgKyAnPC9zcGFuPic7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIGh0bWwgKz0gJzxsaSBkYXRhLW5hbWU9XCInICsgaW5mby5uYW1lICsgJ1wiPicgKyBraW5kICsgbmFtZSArICc8L2xpPic7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgLy8gICAgICAgICAgICAgICAgICBfdmlldy5zZXREYXRhKCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBjb29yZHM6IHsgcGFnZVg6IG51bWJlcjsgcGFnZVk6IG51bWJlciB9ID0gZWRpdG9yLnJlbmRlcmVyLnRleHRUb1NjcmVlbkNvb3JkaW5hdGVzKGN1cnNvci5yb3csIGN1cnNvci5jb2x1bW4gLSB0ZXh0Lmxlbmd0aCk7XG4gICAgICAgICAgICAgICAgICAgIHZhciBsaW5lSGVpZ2h0ID0gOTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHRvcGRvd25Pbmx5ID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIF92aWV3LnNob3coY29vcmRzLyosIGxpbmVIZWlnaHQsIHRvcGRvd25Pbmx5Ki8pO1xuICAgICAgICAgICAgICAgICAgICBfdmlldy5saXN0RWxlbWVudC5pbm5lckhUTUwgPSBodG1sO1xuICAgICAgICAgICAgICAgICAgICBfdmlldy5lbnN1cmVGb2N1cygpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgX3ZpZXcuaGlkZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSk7XG5cbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBMaXN0ZW5zIGZvciBjaGFuZ2VzIGluIHRoZSBlZGl0b3IgYW5kIG1heWJlIHNob3dzIHRoZSBjb21wbGV0aW9ucy5cbiAgICAgKi9cbiAgICBmdW5jdGlvbiBvbkVkaXRvckNoYW5nZShldmVudDogeyBkYXRhOiB7IGFjdGlvbjogc3RyaW5nOyB0ZXh0OiBzdHJpbmcgfSB9KTogdm9pZCB7XG4gICAgICAgIHZhciBjdXJzb3IgPSBlZGl0b3IuZ2V0Q3Vyc29yUG9zaXRpb24oKTtcbiAgICAgICAgaWYgKGV2ZW50LmRhdGEuYWN0aW9uID09IFwiaW5zZXJ0VGV4dFwiKSB7XG4gICAgICAgICAgICBhY3RpdmF0ZVVzaW5nQ3Vyc29yKHsgcm93OiBjdXJzb3Iucm93LCBjb2x1bW46IGN1cnNvci5jb2x1bW4gKyAxIH0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2UgaWYgKGV2ZW50LmRhdGEuYWN0aW9uID09IFwicmVtb3ZlVGV4dFwiKSB7XG4gICAgICAgICAgICBpZiAoZXZlbnQuZGF0YS50ZXh0ID09ICdcXG4nKSB7XG4gICAgICAgICAgICAgICAgZGVhY3RpdmF0ZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgYWN0aXZhdGVVc2luZ0N1cnNvcihjdXJzb3IpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgYWN0aXZhdGVVc2luZ0N1cnNvcihjdXJzb3IpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gYWN0aXZhdGUoKTogdm9pZCB7XG4gICAgICAgIGFjdGl2YXRlVXNpbmdDdXJzb3IoZWRpdG9yLmdldEN1cnNvclBvc2l0aW9uKCkpO1xuICAgIH1cblxuICAgIGZ1bmN0aW9uIGRlYWN0aXZhdGUoKSB7XG4gICAgICAgIGVkaXRvci5rZXlCaW5kaW5nLnJlbW92ZUtleWJvYXJkSGFuZGxlcihfaGFuZGxlcik7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoYXQ7XG59Il19