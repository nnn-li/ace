import HashHandler from '../../keyboard/HashHandler';
import EventEmitterClass from '../../lib/event_emitter';
import AutoCompleteView from '../../mode/typescript/AutoCompleteView';
function makeCompareFn(text) {
    return function (a, b) {
        var matchFunc = function (entry) {
            return entry.name.indexOf(text) === 0 ? 1 : 0;
        };
        var matchCompare = function () {
            return matchFunc(b) - matchFunc(a);
        };
        var textCompare = function () {
            if (a.name === b.name) {
                return 0;
            }
            else {
                return (a.name > b.name) ? 1 : -1;
            }
        };
        var ret = matchCompare();
        return (ret !== 0) ? ret : textCompare();
    };
}
export default function autoComplete(editor, fileNameProvider, completionService) {
    var AutoComplete = function () {
    };
    var that = new AutoComplete();
    that.isActive = isActive;
    that.activate = activate;
    that.deactivate = deactivate;
    var _eventEmitter = new EventEmitterClass();
    var _active = false;
    var _handler = new HashHandler();
    var _view = new AutoCompleteView(editor, that);
    var _inputText = '';
    _handler.attach = function () {
        editor.on("change", onEditorChange);
        _eventEmitter._emit("attach", { 'sender': that });
        _active = true;
    };
    _handler.detach = function () {
        editor.off("change", onEditorChange);
        _view.hide();
        _eventEmitter._emit("detach", { 'sender': that });
        _active = false;
    };
    _handler.handleKeyboard = function (data, hashId, key, keyCode) {
        if (hashId == -1) {
            if (" -=,[]_/()!';:<>".indexOf(key) != -1) {
                deactivate();
            }
            return null;
        }
        var command = _handler.findKeyCommand(hashId, key);
        if (!command) {
            var defaultCommand = editor.commands.findKeyCommand(hashId, key);
            if (defaultCommand) {
                if (defaultCommand.name == "backspace") {
                    return null;
                }
                deactivate();
            }
            return null;
        }
        if (typeof command !== "string") {
            var args = command.args;
            command = command.command;
        }
        if (typeof command === "string") {
            command = this.commands[command];
        }
        return { 'command': command, 'args': args };
    };
    _handler.bindKeys({ "Up|Ctrl-p": "moveprev", "Down|Ctrl-n": "movenext", "esc|Ctrl-g": "cancel", "Return|Tab": "insert" });
    _handler.addCommands({
        movenext: function (editor) { _view.focusNext(); },
        moveprev: function (editor) { _view.focusPrev(); },
        cancel: function (editor) { deactivate(); },
        insert: function (editor) {
            editor.off("change", onEditorChange);
            for (var i = 0; i < _inputText.length; i++) {
                editor.remove("left");
            }
            var curr = _view.current();
            if (curr) {
                editor.insert($(curr).data("name"));
            }
            deactivate();
        }
    });
    function isActive() {
        return _active;
    }
    function activateUsingCursor(cursor) {
        completionService.getCompletionsAtCursor(fileNameProvider(), cursor, function (err, completionInfo) {
            if (!err) {
                var text = completionService.matchText;
                _inputText = text;
                var completions = completionInfo ? completionInfo.entries : null;
                if (completions && _inputText.length > 0) {
                    completions = completions.filter(function (elm) {
                        return elm.name.toLowerCase().indexOf(_inputText.toLowerCase()) === 0;
                    });
                }
                completions = completions ? completions.sort(makeCompareFn(_inputText)) : completions;
                showCompletions(completions);
                var count = completions ? completions.length : 0;
                if (count > 0) {
                    editor.keyBinding.addKeyboardHandler(_handler);
                }
            }
            function showCompletions(infos) {
                if (infos && infos.length > 0) {
                    editor.container.appendChild(_view.wrap);
                    var html = '';
                    for (var n in infos) {
                        var info = infos[n];
                        var name = '<span class="label-name">' + info.name + '</span>';
                        var kind = '<span class="label-kind label-kind-' + info.kind + '">' + info.kind.charAt(0) + '</span>';
                        html += '<li data-name="' + info.name + '">' + kind + name + '</li>';
                    }
                    var coords = editor.renderer.textToScreenCoordinates(cursor.row, cursor.column - text.length);
                    var lineHeight = 9;
                    var topdownOnly = false;
                    _view.show(coords);
                    _view.listElement.innerHTML = html;
                    _view.ensureFocus();
                }
                else {
                    _view.hide();
                }
            }
        });
    }
    function onEditorChange(event) {
        var cursor = editor.getCursorPosition();
        if (event.data.action == "insertText") {
            activateUsingCursor({ row: cursor.row, column: cursor.column + 1 });
        }
        else if (event.data.action == "removeText") {
            if (event.data.text == '\n') {
                deactivate();
            }
            else {
                activateUsingCursor(cursor);
            }
        }
        else {
            activateUsingCursor(cursor);
        }
    }
    function activate() {
        activateUsingCursor(editor.getCursorPosition());
    }
    function deactivate() {
        editor.keyBinding.removeKeyboardHandler(_handler);
    }
    return that;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXV0b0NvbXBsZXRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL21vZGUvdHlwZXNjcmlwdC9hdXRvQ29tcGxldGUudHMiXSwibmFtZXMiOlsibWFrZUNvbXBhcmVGbiIsImF1dG9Db21wbGV0ZSIsImF1dG9Db21wbGV0ZS5pc0FjdGl2ZSIsImF1dG9Db21wbGV0ZS5hY3RpdmF0ZVVzaW5nQ3Vyc29yIiwic2hvd0NvbXBsZXRpb25zIiwiYXV0b0NvbXBsZXRlLm9uRWRpdG9yQ2hhbmdlIiwiYXV0b0NvbXBsZXRlLmFjdGl2YXRlIiwiYXV0b0NvbXBsZXRlLmRlYWN0aXZhdGUiXSwibWFwcGluZ3MiOiJPQUdPLFdBQVcsTUFBTSw0QkFBNEI7T0FDN0MsaUJBQWlCLE1BQU0seUJBQXlCO09BR2hELGdCQUFnQixNQUFNLHdDQUF3QztBQU1yRSx1QkFBdUIsSUFBWTtJQUMvQkEsTUFBTUEsQ0FBQ0EsVUFBU0EsQ0FBcUJBLEVBQUVBLENBQXFCQTtRQUN4RCxJQUFJLFNBQVMsR0FBRyxVQUFTLEtBQXlCO1lBQzlDLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNsRCxDQUFDLENBQUM7UUFDRixJQUFJLFlBQVksR0FBRztZQUNmLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3ZDLENBQUMsQ0FBQztRQUNGLElBQUksV0FBVyxHQUFHO1lBQ2QsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFDcEIsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUNiLENBQUM7WUFDRCxJQUFJLENBQUMsQ0FBQztnQkFDRixNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDdEMsQ0FBQztRQUNMLENBQUMsQ0FBQztRQUNGLElBQUksR0FBRyxHQUFHLFlBQVksRUFBRSxDQUFDO1FBQ3pCLE1BQU0sQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLENBQUMsR0FBRyxHQUFHLEdBQUcsV0FBVyxFQUFFLENBQUM7SUFDN0MsQ0FBQyxDQUFDQTtBQUNOQSxDQUFDQTtBQU9ELHFDQUFxQyxNQUFjLEVBQUUsZ0JBQThCLEVBQUUsaUJBQW9DO0lBSXJIQyxJQUFJQSxZQUFZQSxHQUFHQTtJQUVuQixDQUFDLENBQUNBO0lBQ0ZBLElBQUlBLElBQUlBLEdBQThFQSxJQUFJQSxZQUFZQSxFQUFFQSxDQUFDQTtJQUN6R0EsSUFBSUEsQ0FBQ0EsUUFBUUEsR0FBR0EsUUFBUUEsQ0FBQ0E7SUFDekJBLElBQUlBLENBQUNBLFFBQVFBLEdBQUdBLFFBQVFBLENBQUNBO0lBQ3pCQSxJQUFJQSxDQUFDQSxVQUFVQSxHQUFHQSxVQUFVQSxDQUFDQTtJQUs3QkEsSUFBSUEsYUFBYUEsR0FBR0EsSUFBSUEsaUJBQWlCQSxFQUFFQSxDQUFDQTtJQUs1Q0EsSUFBSUEsT0FBT0EsR0FBWUEsS0FBS0EsQ0FBQ0E7SUFLN0JBLElBQUlBLFFBQVFBLEdBQVFBLElBQUlBLFdBQVdBLEVBQUVBLENBQUNBO0lBS3RDQSxJQUFJQSxLQUFLQSxHQUFHQSxJQUFJQSxnQkFBZ0JBLENBQUNBLE1BQU1BLEVBQUVBLElBQUlBLENBQUNBLENBQUNBO0lBTS9DQSxJQUFJQSxVQUFVQSxHQUFHQSxFQUFFQSxDQUFDQTtJQUVwQkEsUUFBUUEsQ0FBQ0EsTUFBTUEsR0FBR0E7UUFFZCxNQUFNLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRSxjQUFjLENBQUMsQ0FBQztRQUVwQyxhQUFhLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxFQUFFLFFBQVEsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQ2xELE9BQU8sR0FBRyxJQUFJLENBQUM7SUFDbkIsQ0FBQyxDQUFDQTtJQUVGQSxRQUFRQSxDQUFDQSxNQUFNQSxHQUFHQTtRQUNkLE1BQU0sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLGNBQWMsQ0FBQyxDQUFDO1FBQ3JDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNiLGFBQWEsQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUFFLEVBQUUsUUFBUSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7UUFDbEQsT0FBTyxHQUFHLEtBQUssQ0FBQztJQUNwQixDQUFDLENBQUNBO0lBRUZBLFFBQVFBLENBQUNBLGNBQWNBLEdBQUdBLFVBQVNBLElBQUlBLEVBQUVBLE1BQU1BLEVBQUVBLEdBQUdBLEVBQUVBLE9BQU9BO1FBRXpELEVBQUUsQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDZixFQUFFLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN4QyxVQUFVLEVBQUUsQ0FBQztZQUNqQixDQUFDO1lBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQztRQUNoQixDQUFDO1FBRUQsSUFBSSxPQUFPLEdBQUcsUUFBUSxDQUFDLGNBQWMsQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFFbkQsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBRVgsSUFBSSxjQUFjLEdBQUcsTUFBTSxDQUFDLFFBQVEsQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDO1lBQ2pFLEVBQUUsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2pCLEVBQUUsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxJQUFJLElBQUksV0FBVyxDQUFDLENBQUMsQ0FBQztvQkFDckMsTUFBTSxDQUFDLElBQUksQ0FBQztnQkFDaEIsQ0FBQztnQkFDRCxVQUFVLEVBQUUsQ0FBQztZQUNqQixDQUFDO1lBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQztRQUNoQixDQUFDO1FBRUQsRUFBRSxDQUFDLENBQUMsT0FBTyxPQUFPLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQztZQUM5QixJQUFJLElBQUksR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDO1lBQ3hCLE9BQU8sR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDO1FBQzlCLENBQUM7UUFFRCxFQUFFLENBQUMsQ0FBQyxPQUFPLE9BQU8sS0FBSyxRQUFRLENBQUMsQ0FBQyxDQUFDO1lBQzlCLE9BQU8sR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ3JDLENBQUM7UUFFRCxNQUFNLENBQUMsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsQ0FBQztJQUVoRCxDQUFDLENBQUNBO0lBRUZBLFFBQVFBLENBQUNBLFFBQVFBLENBQUNBLEVBQUVBLFdBQVdBLEVBQUVBLFVBQVVBLEVBQUVBLGFBQWFBLEVBQUVBLFVBQVVBLEVBQUVBLFlBQVlBLEVBQUVBLFFBQVFBLEVBQUVBLFlBQVlBLEVBQUVBLFFBQVFBLEVBQUVBLENBQUNBLENBQUNBO0lBRTFIQSxRQUFRQSxDQUFDQSxXQUFXQSxDQUFDQTtRQUNqQkEsUUFBUUEsRUFBRUEsVUFBU0EsTUFBTUEsSUFBSSxLQUFLLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQ2pEQSxRQUFRQSxFQUFFQSxVQUFTQSxNQUFNQSxJQUFJLEtBQUssQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDakRBLE1BQU1BLEVBQUVBLFVBQVNBLE1BQU1BLElBQUksVUFBVSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBQzFDQSxNQUFNQSxFQUFFQSxVQUFTQSxNQUFjQTtZQUMzQixNQUFNLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxjQUFjLENBQUMsQ0FBQztZQUVyQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsVUFBVSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO2dCQUN6QyxNQUFNLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQzFCLENBQUM7WUFHRCxJQUFJLElBQUksR0FBRyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDM0IsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFDUCxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUN4QyxDQUFDO1lBQ0QsVUFBVSxFQUFFLENBQUM7UUFDakIsQ0FBQztLQUNKQSxDQUFDQSxDQUFDQTtJQUVIQTtRQUNJQyxNQUFNQSxDQUFDQSxPQUFPQSxDQUFDQTtJQUNuQkEsQ0FBQ0E7SUFLREQsNkJBQTZCQSxNQUFnQkE7UUFDekNFLGlCQUFpQkEsQ0FBQ0Esc0JBQXNCQSxDQUFDQSxnQkFBZ0JBLEVBQUVBLEVBQUVBLE1BQU1BLEVBQUVBLFVBQVNBLEdBQUdBLEVBQUVBLGNBQWlDQTtZQUNoSCxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7Z0JBRVAsSUFBSSxJQUFJLEdBQUcsaUJBQWlCLENBQUMsU0FBUyxDQUFDO2dCQUV2QyxVQUFVLEdBQUcsSUFBSSxDQUFDO2dCQUVsQixJQUFJLFdBQVcsR0FBRyxjQUFjLEdBQUcsY0FBYyxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7Z0JBRWpFLEVBQUUsQ0FBQyxDQUFDLFdBQVcsSUFBSSxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3ZDLFdBQVcsR0FBRyxXQUFXLENBQUMsTUFBTSxDQUFDLFVBQVMsR0FBRzt3QkFDekMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQztvQkFDMUUsQ0FBQyxDQUFDLENBQUM7Z0JBQ1AsQ0FBQztnQkFFRCxXQUFXLEdBQUcsV0FBVyxHQUFHLFdBQVcsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEdBQUcsV0FBVyxDQUFDO2dCQUV0RixlQUFlLENBQUMsV0FBVyxDQUFDLENBQUM7Z0JBRTdCLElBQUksS0FBSyxHQUFHLFdBQVcsR0FBRyxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztnQkFDakQsRUFBRSxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ1osTUFBTSxDQUFDLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDbkQsQ0FBQztZQUNMLENBQUM7WUFDRCx5QkFBeUIsS0FBMkI7Z0JBRWhEQyxFQUFFQSxDQUFDQSxDQUFDQSxLQUFLQSxJQUFJQSxLQUFLQSxDQUFDQSxNQUFNQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtvQkFDNUJBLE1BQU1BLENBQUNBLFNBQVNBLENBQUNBLFdBQVdBLENBQUNBLEtBQUtBLENBQUNBLElBQUlBLENBQUNBLENBQUNBO29CQUN6Q0EsSUFBSUEsSUFBSUEsR0FBR0EsRUFBRUEsQ0FBQ0E7b0JBQ2RBLEdBQUdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLENBQUNBLElBQUlBLEtBQUtBLENBQUNBLENBQUNBLENBQUNBO3dCQUVsQkEsSUFBSUEsSUFBSUEsR0FBR0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7d0JBQ3BCQSxJQUFJQSxJQUFJQSxHQUFHQSwyQkFBMkJBLEdBQUdBLElBQUlBLENBQUNBLElBQUlBLEdBQUdBLFNBQVNBLENBQUNBO3dCQUMvREEsSUFBSUEsSUFBSUEsR0FBR0EscUNBQXFDQSxHQUFHQSxJQUFJQSxDQUFDQSxJQUFJQSxHQUFHQSxJQUFJQSxHQUFHQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxDQUFDQSxDQUFDQSxDQUFDQSxHQUFHQSxTQUFTQSxDQUFDQTt3QkFFdEdBLElBQUlBLElBQUlBLGlCQUFpQkEsR0FBR0EsSUFBSUEsQ0FBQ0EsSUFBSUEsR0FBR0EsSUFBSUEsR0FBR0EsSUFBSUEsR0FBR0EsSUFBSUEsR0FBR0EsT0FBT0EsQ0FBQ0E7b0JBQ3pFQSxDQUFDQTtvQkFFREEsSUFBSUEsTUFBTUEsR0FBcUNBLE1BQU1BLENBQUNBLFFBQVFBLENBQUNBLHVCQUF1QkEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsR0FBR0EsRUFBRUEsTUFBTUEsQ0FBQ0EsTUFBTUEsR0FBR0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7b0JBQ2hJQSxJQUFJQSxVQUFVQSxHQUFHQSxDQUFDQSxDQUFDQTtvQkFDbkJBLElBQUlBLFdBQVdBLEdBQUdBLEtBQUtBLENBQUNBO29CQUN4QkEsS0FBS0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsTUFBTUEsQ0FBOEJBLENBQUNBO29CQUNoREEsS0FBS0EsQ0FBQ0EsV0FBV0EsQ0FBQ0EsU0FBU0EsR0FBR0EsSUFBSUEsQ0FBQ0E7b0JBQ25DQSxLQUFLQSxDQUFDQSxXQUFXQSxFQUFFQSxDQUFDQTtnQkFDeEJBLENBQUNBO2dCQUNEQSxJQUFJQSxDQUFDQSxDQUFDQTtvQkFDRkEsS0FBS0EsQ0FBQ0EsSUFBSUEsRUFBRUEsQ0FBQ0E7Z0JBQ2pCQSxDQUFDQTtZQUNMQSxDQUFDQTtRQUNMLENBQUMsQ0FBQ0QsQ0FBQ0E7SUFFUEEsQ0FBQ0E7SUFLREYsd0JBQXdCQSxLQUFpREE7UUFDckVJLElBQUlBLE1BQU1BLEdBQUdBLE1BQU1BLENBQUNBLGlCQUFpQkEsRUFBRUEsQ0FBQ0E7UUFDeENBLEVBQUVBLENBQUNBLENBQUNBLEtBQUtBLENBQUNBLElBQUlBLENBQUNBLE1BQU1BLElBQUlBLFlBQVlBLENBQUNBLENBQUNBLENBQUNBO1lBQ3BDQSxtQkFBbUJBLENBQUNBLEVBQUVBLEdBQUdBLEVBQUVBLE1BQU1BLENBQUNBLEdBQUdBLEVBQUVBLE1BQU1BLEVBQUVBLE1BQU1BLENBQUNBLE1BQU1BLEdBQUdBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBO1FBQ3hFQSxDQUFDQTtRQUNEQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxLQUFLQSxDQUFDQSxJQUFJQSxDQUFDQSxNQUFNQSxJQUFJQSxZQUFZQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUN6Q0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsSUFBSUEsSUFBSUEsSUFBSUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQzFCQSxVQUFVQSxFQUFFQSxDQUFDQTtZQUNqQkEsQ0FBQ0E7WUFDREEsSUFBSUEsQ0FBQ0EsQ0FBQ0E7Z0JBQ0ZBLG1CQUFtQkEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7WUFDaENBLENBQUNBO1FBQ0xBLENBQUNBO1FBQ0RBLElBQUlBLENBQUNBLENBQUNBO1lBQ0ZBLG1CQUFtQkEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0E7UUFDaENBLENBQUNBO0lBQ0xBLENBQUNBO0lBRURKO1FBQ0lLLG1CQUFtQkEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsaUJBQWlCQSxFQUFFQSxDQUFDQSxDQUFDQTtJQUNwREEsQ0FBQ0E7SUFFREw7UUFDSU0sTUFBTUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EscUJBQXFCQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQTtJQUN0REEsQ0FBQ0E7SUFFRE4sTUFBTUEsQ0FBQ0EsSUFBSUEsQ0FBQ0E7QUFDaEJBLENBQUNBIiwic291cmNlc0NvbnRlbnQiOlsiZGVjbGFyZSB2YXIgJDogYW55O1xuXG5pbXBvcnQgUG9zaXRpb24gZnJvbSAnLi4vLi4vUG9zaXRpb24nO1xuaW1wb3J0IEhhc2hIYW5kbGVyIGZyb20gJy4uLy4uL2tleWJvYXJkL0hhc2hIYW5kbGVyJztcbmltcG9ydCBFdmVudEVtaXR0ZXJDbGFzcyBmcm9tICcuLi8uLi9saWIvZXZlbnRfZW1pdHRlcic7XG5pbXBvcnQgRWRpdG9yIGZyb20gJy4uLy4uL0VkaXRvcic7XG5pbXBvcnQgQ29tcGxldGlvblNlcnZpY2UgZnJvbSAnLi9Db21wbGV0aW9uU2VydmljZSc7XG5pbXBvcnQgQXV0b0NvbXBsZXRlVmlldyBmcm9tICcuLi8uLi9tb2RlL3R5cGVzY3JpcHQvQXV0b0NvbXBsZXRlVmlldyc7XG4vL2ltcG9ydCBwb3B1cCA9IHJlcXVpcmUoJy4uLy4uL2F1dG9jb21wbGV0ZS9wb3B1cCcpO1xuXG4vKipcbiAqIE1ha2VzIGEgZnVuY3Rpb24gdGhhdCBjYW4gYmUgdXNlZCB0byBjb21wYXJlIGNvbXBsZXRpb24gZW50cmllcyBmb3Igc29ydGluZyBwdXJwb3Nlcy5cbiAqL1xuZnVuY3Rpb24gbWFrZUNvbXBhcmVGbih0ZXh0OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gZnVuY3Rpb24oYTogdHMuQ29tcGxldGlvbkVudHJ5LCBiOiB0cy5Db21wbGV0aW9uRW50cnkpIHtcbiAgICAgICAgdmFyIG1hdGNoRnVuYyA9IGZ1bmN0aW9uKGVudHJ5OiB0cy5Db21wbGV0aW9uRW50cnkpOiBudW1iZXIge1xuICAgICAgICAgICAgcmV0dXJuIGVudHJ5Lm5hbWUuaW5kZXhPZih0ZXh0KSA9PT0gMCA/IDEgOiAwO1xuICAgICAgICB9O1xuICAgICAgICB2YXIgbWF0Y2hDb21wYXJlID0gZnVuY3Rpb24oKTogbnVtYmVyIHtcbiAgICAgICAgICAgIHJldHVybiBtYXRjaEZ1bmMoYikgLSBtYXRjaEZ1bmMoYSk7XG4gICAgICAgIH07XG4gICAgICAgIHZhciB0ZXh0Q29tcGFyZSA9IGZ1bmN0aW9uKCk6IG51bWJlciB7XG4gICAgICAgICAgICBpZiAoYS5uYW1lID09PSBiLm5hbWUpIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gMDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiAoYS5uYW1lID4gYi5uYW1lKSA/IDEgOiAtMTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgICAgdmFyIHJldCA9IG1hdGNoQ29tcGFyZSgpO1xuICAgICAgICByZXR1cm4gKHJldCAhPT0gMCkgPyByZXQgOiB0ZXh0Q29tcGFyZSgpO1xuICAgIH07XG59XG5cbi8qKlxuICogVXNpbmcgdGhlIGZ1bmN0aW9uYWwgY29uc3RydWN0b3IgcGF0dGVybiBoZXJlIGJlY2F1c2UgJ3RoaXMnIGlzIHRvbyBlcnJvci1wcm9uZS5cbiAqXG4gKiBBY2NvcmRpbmdseSwgdGhlIGZ1bmN0aW9uIGlzIGNhbWVsQ2FzZSBhbmQgaXMgbm90IGNhbGxlZCB1c2luZyB0aGUgJ25ldycgb3BlcmF0b3IuXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIGF1dG9Db21wbGV0ZShlZGl0b3I6IEVkaXRvciwgZmlsZU5hbWVQcm92aWRlcjogKCkgPT4gc3RyaW5nLCBjb21wbGV0aW9uU2VydmljZTogQ29tcGxldGlvblNlcnZpY2UpIHtcbiAgICAvKipcbiAgICAgKiBEZWNsYXJlIHRoZSByZXR1cm4gb2JqZWN0IG5vdyBiZWNhdXNlIHRoZSBBdXRvQ29tcGxldGVWaWV3IG5lZWRzIGEgcmVmZXJlbmNlLlxuICAgICAqL1xuICAgIHZhciBBdXRvQ29tcGxldGUgPSBmdW5jdGlvbigpIHtcblxuICAgIH07XG4gICAgdmFyIHRoYXQ6IHsgYWN0aXZhdGU6ICgpID0+IHZvaWQ7IGRlYWN0aXZhdGU6ICgpID0+IHZvaWQ7IGlzQWN0aXZlOiAoKSA9PiBib29sZWFuIH0gPSBuZXcgQXV0b0NvbXBsZXRlKCk7XG4gICAgdGhhdC5pc0FjdGl2ZSA9IGlzQWN0aXZlO1xuICAgIHRoYXQuYWN0aXZhdGUgPSBhY3RpdmF0ZTtcbiAgICB0aGF0LmRlYWN0aXZhdGUgPSBkZWFjdGl2YXRlO1xuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKi9cbiAgICB2YXIgX2V2ZW50RW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXJDbGFzcygpO1xuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKi9cbiAgICB2YXIgX2FjdGl2ZTogYm9vbGVhbiA9IGZhbHNlO1xuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKi9cbiAgICB2YXIgX2hhbmRsZXI6IGFueSA9IG5ldyBIYXNoSGFuZGxlcigpO1xuXG4gICAgLyoqXG4gICAgICpcbiAgICAgKi9cbiAgICB2YXIgX3ZpZXcgPSBuZXcgQXV0b0NvbXBsZXRlVmlldyhlZGl0b3IsIHRoYXQpO1xuICAgIC8vIHZhciBfdmlldyA9IG5ldyBwb3B1cC5MaXN0Vmlld1BvcHVwKGRvY3VtZW50LmJvZHkgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50KTtcblxuICAgIC8qKlxuICAgICAqXG4gICAgICovXG4gICAgdmFyIF9pbnB1dFRleHQgPSAnJztcblxuICAgIF9oYW5kbGVyLmF0dGFjaCA9IGZ1bmN0aW9uKCkge1xuXG4gICAgICAgIGVkaXRvci5vbihcImNoYW5nZVwiLCBvbkVkaXRvckNoYW5nZSk7XG5cbiAgICAgICAgX2V2ZW50RW1pdHRlci5fZW1pdChcImF0dGFjaFwiLCB7ICdzZW5kZXInOiB0aGF0IH0pO1xuICAgICAgICBfYWN0aXZlID0gdHJ1ZTtcbiAgICB9O1xuXG4gICAgX2hhbmRsZXIuZGV0YWNoID0gZnVuY3Rpb24oKSB7XG4gICAgICAgIGVkaXRvci5vZmYoXCJjaGFuZ2VcIiwgb25FZGl0b3JDaGFuZ2UpO1xuICAgICAgICBfdmlldy5oaWRlKCk7XG4gICAgICAgIF9ldmVudEVtaXR0ZXIuX2VtaXQoXCJkZXRhY2hcIiwgeyAnc2VuZGVyJzogdGhhdCB9KTtcbiAgICAgICAgX2FjdGl2ZSA9IGZhbHNlO1xuICAgIH07XG5cbiAgICBfaGFuZGxlci5oYW5kbGVLZXlib2FyZCA9IGZ1bmN0aW9uKGRhdGEsIGhhc2hJZCwga2V5LCBrZXlDb2RlKSB7XG5cbiAgICAgICAgaWYgKGhhc2hJZCA9PSAtMSkge1xuICAgICAgICAgICAgaWYgKFwiIC09LFtdXy8oKSEnOzo8PlwiLmluZGV4T2Yoa2V5KSAhPSAtMSkge1xuICAgICAgICAgICAgICAgIGRlYWN0aXZhdGUoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFyIGNvbW1hbmQgPSBfaGFuZGxlci5maW5kS2V5Q29tbWFuZChoYXNoSWQsIGtleSk7XG5cbiAgICAgICAgaWYgKCFjb21tYW5kKSB7XG5cbiAgICAgICAgICAgIHZhciBkZWZhdWx0Q29tbWFuZCA9IGVkaXRvci5jb21tYW5kcy5maW5kS2V5Q29tbWFuZChoYXNoSWQsIGtleSk7XG4gICAgICAgICAgICBpZiAoZGVmYXVsdENvbW1hbmQpIHtcbiAgICAgICAgICAgICAgICBpZiAoZGVmYXVsdENvbW1hbmQubmFtZSA9PSBcImJhY2tzcGFjZVwiKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBkZWFjdGl2YXRlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gbnVsbDtcbiAgICAgICAgfVxuXG4gICAgICAgIGlmICh0eXBlb2YgY29tbWFuZCAhPT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgICAgdmFyIGFyZ3MgPSBjb21tYW5kLmFyZ3M7XG4gICAgICAgICAgICBjb21tYW5kID0gY29tbWFuZC5jb21tYW5kO1xuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHR5cGVvZiBjb21tYW5kID09PSBcInN0cmluZ1wiKSB7XG4gICAgICAgICAgICBjb21tYW5kID0gdGhpcy5jb21tYW5kc1tjb21tYW5kXTtcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiB7ICdjb21tYW5kJzogY29tbWFuZCwgJ2FyZ3MnOiBhcmdzIH07XG5cbiAgICB9O1xuXG4gICAgX2hhbmRsZXIuYmluZEtleXMoeyBcIlVwfEN0cmwtcFwiOiBcIm1vdmVwcmV2XCIsIFwiRG93bnxDdHJsLW5cIjogXCJtb3ZlbmV4dFwiLCBcImVzY3xDdHJsLWdcIjogXCJjYW5jZWxcIiwgXCJSZXR1cm58VGFiXCI6IFwiaW5zZXJ0XCIgfSk7XG5cbiAgICBfaGFuZGxlci5hZGRDb21tYW5kcyh7XG4gICAgICAgIG1vdmVuZXh0OiBmdW5jdGlvbihlZGl0b3IpIHsgX3ZpZXcuZm9jdXNOZXh0KCk7IH0sXG4gICAgICAgIG1vdmVwcmV2OiBmdW5jdGlvbihlZGl0b3IpIHsgX3ZpZXcuZm9jdXNQcmV2KCk7IH0sXG4gICAgICAgIGNhbmNlbDogZnVuY3Rpb24oZWRpdG9yKSB7IGRlYWN0aXZhdGUoKTsgfSxcbiAgICAgICAgaW5zZXJ0OiBmdW5jdGlvbihlZGl0b3I6IEVkaXRvcikge1xuICAgICAgICAgICAgZWRpdG9yLm9mZihcImNoYW5nZVwiLCBvbkVkaXRvckNoYW5nZSk7XG5cbiAgICAgICAgICAgIGZvciAodmFyIGkgPSAwOyBpIDwgX2lucHV0VGV4dC5sZW5ndGg7IGkrKykge1xuICAgICAgICAgICAgICAgIGVkaXRvci5yZW1vdmUoXCJsZWZ0XCIpO1xuICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAvLyBUT0RPOiBUaGlzIGlzIHdoZXJlIHRoZSBpbnNlcnRpb24gaGFwcGVucy5cbiAgICAgICAgICAgIHZhciBjdXJyID0gX3ZpZXcuY3VycmVudCgpO1xuICAgICAgICAgICAgaWYgKGN1cnIpIHtcbiAgICAgICAgICAgICAgICBlZGl0b3IuaW5zZXJ0KCQoY3VycikuZGF0YShcIm5hbWVcIikpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZGVhY3RpdmF0ZSgpO1xuICAgICAgICB9XG4gICAgfSk7XG5cbiAgICBmdW5jdGlvbiBpc0FjdGl2ZSgpOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIF9hY3RpdmU7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogUmV0dXJucyB0aGUgbnVtYmVyIG9mIGNvbXBsZXRpb25zIGFzeW5jaHJvbm91c2x5IGluIHRoZSBjYWxsYmFjayB3aXRoIHRoZSBzaWRlIGVmZmVjdCBvZiBzaG93aW5nIHRoZSBjb21wbGV0aW9ucy5cbiAgICAgKi9cbiAgICBmdW5jdGlvbiBhY3RpdmF0ZVVzaW5nQ3Vyc29yKGN1cnNvcjogUG9zaXRpb24pIHtcbiAgICAgICAgY29tcGxldGlvblNlcnZpY2UuZ2V0Q29tcGxldGlvbnNBdEN1cnNvcihmaWxlTmFtZVByb3ZpZGVyKCksIGN1cnNvciwgZnVuY3Rpb24oZXJyLCBjb21wbGV0aW9uSW5mbzogdHMuQ29tcGxldGlvbkluZm8pIHtcbiAgICAgICAgICAgIGlmICghZXJyKSB7XG4gICAgICAgICAgICAgICAgLy8gRklYTUU6IFRoZSBtYXRjaFRleHQgc2hvdWxkIG5vdCBiZSB2aXNpc2JsZSwgb3IgcmF0aGVyIHBhcnQgb2YgdGhlIGNhbGxiYWNrLlxuICAgICAgICAgICAgICAgIHZhciB0ZXh0ID0gY29tcGxldGlvblNlcnZpY2UubWF0Y2hUZXh0O1xuXG4gICAgICAgICAgICAgICAgX2lucHV0VGV4dCA9IHRleHQ7XG5cbiAgICAgICAgICAgICAgICB2YXIgY29tcGxldGlvbnMgPSBjb21wbGV0aW9uSW5mbyA/IGNvbXBsZXRpb25JbmZvLmVudHJpZXMgOiBudWxsO1xuXG4gICAgICAgICAgICAgICAgaWYgKGNvbXBsZXRpb25zICYmIF9pbnB1dFRleHQubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBjb21wbGV0aW9ucyA9IGNvbXBsZXRpb25zLmZpbHRlcihmdW5jdGlvbihlbG0pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBlbG0ubmFtZS50b0xvd2VyQ2FzZSgpLmluZGV4T2YoX2lucHV0VGV4dC50b0xvd2VyQ2FzZSgpKSA9PT0gMDtcbiAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgfVxuXG4gICAgICAgICAgICAgICAgY29tcGxldGlvbnMgPSBjb21wbGV0aW9ucyA/IGNvbXBsZXRpb25zLnNvcnQobWFrZUNvbXBhcmVGbihfaW5wdXRUZXh0KSkgOiBjb21wbGV0aW9ucztcblxuICAgICAgICAgICAgICAgIHNob3dDb21wbGV0aW9ucyhjb21wbGV0aW9ucyk7XG5cbiAgICAgICAgICAgICAgICB2YXIgY291bnQgPSBjb21wbGV0aW9ucyA/IGNvbXBsZXRpb25zLmxlbmd0aCA6IDA7XG4gICAgICAgICAgICAgICAgaWYgKGNvdW50ID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBlZGl0b3Iua2V5QmluZGluZy5hZGRLZXlib2FyZEhhbmRsZXIoX2hhbmRsZXIpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGZ1bmN0aW9uIHNob3dDb21wbGV0aW9ucyhpbmZvczogdHMuQ29tcGxldGlvbkVudHJ5W10pIHtcbiAgICAgICAgICAgICAgICAvLyBGSVhNRTogVGhlICd2aWV3JyBkb2VzIG5vdCBzZWVtIHRvIGJlIHZlcnkgd2VsbCBlbmNhcHN1bGF0ZWQgaGVyZS5cbiAgICAgICAgICAgICAgICBpZiAoaW5mb3MgJiYgaW5mb3MubGVuZ3RoID4gMCkge1xuICAgICAgICAgICAgICAgICAgICBlZGl0b3IuY29udGFpbmVyLmFwcGVuZENoaWxkKF92aWV3LndyYXApO1xuICAgICAgICAgICAgICAgICAgICB2YXIgaHRtbCA9ICcnO1xuICAgICAgICAgICAgICAgICAgICBmb3IgKHZhciBuIGluIGluZm9zKSB7XG4gICAgICAgICAgICAgICAgICAgICAgICAvLyB7bmFtZSwga2luZCwga2luZE1vZGlmaWVyc31cbiAgICAgICAgICAgICAgICAgICAgICAgIHZhciBpbmZvID0gaW5mb3Nbbl07XG4gICAgICAgICAgICAgICAgICAgICAgICB2YXIgbmFtZSA9ICc8c3BhbiBjbGFzcz1cImxhYmVsLW5hbWVcIj4nICsgaW5mby5uYW1lICsgJzwvc3Bhbj4nO1xuICAgICAgICAgICAgICAgICAgICAgICAgdmFyIGtpbmQgPSAnPHNwYW4gY2xhc3M9XCJsYWJlbC1raW5kIGxhYmVsLWtpbmQtJyArIGluZm8ua2luZCArICdcIj4nICsgaW5mby5raW5kLmNoYXJBdCgwKSArICc8L3NwYW4+JztcblxuICAgICAgICAgICAgICAgICAgICAgICAgaHRtbCArPSAnPGxpIGRhdGEtbmFtZT1cIicgKyBpbmZvLm5hbWUgKyAnXCI+JyArIGtpbmQgKyBuYW1lICsgJzwvbGk+JztcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAvLyAgICAgICAgICAgICAgICAgIF92aWV3LnNldERhdGEoKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGNvb3JkczogeyBwYWdlWDogbnVtYmVyOyBwYWdlWTogbnVtYmVyIH0gPSBlZGl0b3IucmVuZGVyZXIudGV4dFRvU2NyZWVuQ29vcmRpbmF0ZXMoY3Vyc29yLnJvdywgY3Vyc29yLmNvbHVtbiAtIHRleHQubGVuZ3RoKTtcbiAgICAgICAgICAgICAgICAgICAgdmFyIGxpbmVIZWlnaHQgPSA5O1xuICAgICAgICAgICAgICAgICAgICB2YXIgdG9wZG93bk9ubHkgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICAgICAgX3ZpZXcuc2hvdyhjb29yZHMvKiwgbGluZUhlaWdodCwgdG9wZG93bk9ubHkqLyk7XG4gICAgICAgICAgICAgICAgICAgIF92aWV3Lmxpc3RFbGVtZW50LmlubmVySFRNTCA9IGh0bWw7XG4gICAgICAgICAgICAgICAgICAgIF92aWV3LmVuc3VyZUZvY3VzKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICBfdmlldy5oaWRlKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgIH1cblxuICAgIC8qKlxuICAgICAqIExpc3RlbnMgZm9yIGNoYW5nZXMgaW4gdGhlIGVkaXRvciBhbmQgbWF5YmUgc2hvd3MgdGhlIGNvbXBsZXRpb25zLlxuICAgICAqL1xuICAgIGZ1bmN0aW9uIG9uRWRpdG9yQ2hhbmdlKGV2ZW50OiB7IGRhdGE6IHsgYWN0aW9uOiBzdHJpbmc7IHRleHQ6IHN0cmluZyB9IH0pOiB2b2lkIHtcbiAgICAgICAgdmFyIGN1cnNvciA9IGVkaXRvci5nZXRDdXJzb3JQb3NpdGlvbigpO1xuICAgICAgICBpZiAoZXZlbnQuZGF0YS5hY3Rpb24gPT0gXCJpbnNlcnRUZXh0XCIpIHtcbiAgICAgICAgICAgIGFjdGl2YXRlVXNpbmdDdXJzb3IoeyByb3c6IGN1cnNvci5yb3csIGNvbHVtbjogY3Vyc29yLmNvbHVtbiArIDEgfSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSBpZiAoZXZlbnQuZGF0YS5hY3Rpb24gPT0gXCJyZW1vdmVUZXh0XCIpIHtcbiAgICAgICAgICAgIGlmIChldmVudC5kYXRhLnRleHQgPT0gJ1xcbicpIHtcbiAgICAgICAgICAgICAgICBkZWFjdGl2YXRlKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICBhY3RpdmF0ZVVzaW5nQ3Vyc29yKGN1cnNvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBhY3RpdmF0ZVVzaW5nQ3Vyc29yKGN1cnNvcik7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBmdW5jdGlvbiBhY3RpdmF0ZSgpOiB2b2lkIHtcbiAgICAgICAgYWN0aXZhdGVVc2luZ0N1cnNvcihlZGl0b3IuZ2V0Q3Vyc29yUG9zaXRpb24oKSk7XG4gICAgfVxuXG4gICAgZnVuY3Rpb24gZGVhY3RpdmF0ZSgpIHtcbiAgICAgICAgZWRpdG9yLmtleUJpbmRpbmcucmVtb3ZlS2V5Ym9hcmRIYW5kbGVyKF9oYW5kbGVyKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhhdDtcbn0iXX0=