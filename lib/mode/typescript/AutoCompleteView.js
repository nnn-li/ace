var hhm = require('../../keyboard/hash_handler');
var CLASSNAME = 'ace_autocomplete';
var CLASSNAME_SELECTED = 'ace_autocomplete_selected';
var AutoCompleteView = (function () {
    function AutoCompleteView(editor, autoComplete) {
        this.handler = new hhm.HashHandler();
        if (typeof editor === 'undefined') {
            throw new Error('editor must be defined');
        }
        if (typeof autoComplete === 'undefined') {
            throw new Error('autoComplete must be defined');
        }
        this.editor = editor;
        this.autoComplete = autoComplete;
        this.selectedClassName = CLASSNAME_SELECTED;
        this.wrap = document.createElement('div');
        this.listElement = document.createElement('ul');
        this.wrap.className = CLASSNAME;
        this.wrap.appendChild(this.listElement);
        this.editor.container.appendChild(this.wrap);
        this.wrap.style.display = 'none';
        this.listElement.style.listStyleType = 'none';
        this.wrap.style.position = 'fixed';
        this.wrap.style.zIndex = '1000';
    }
    AutoCompleteView.prototype.show = function (coords) {
        this.setPosition(coords);
        return this.wrap.style.display = 'block';
    };
    AutoCompleteView.prototype.hide = function () {
        return this.wrap.style.display = 'none';
    };
    AutoCompleteView.prototype.setPosition = function (coords) {
        var bottom, editorBottom, top;
        top = coords.pageY + 20;
        editorBottom = $(this.editor.container).offset().top + $(this.editor.container).height();
        bottom = top + $(this.wrap).height();
        if (bottom < editorBottom) {
            this.wrap.style.top = top + 'px';
            return this.wrap.style.left = coords.pageX + 'px';
        }
        else {
            this.wrap.style.top = (top - $(this.wrap).height() - 20) + 'px';
            return this.wrap.style.left = coords.pageX + 'px';
        }
    };
    AutoCompleteView.prototype.current = function () {
        var child, children, i;
        children = this.listElement.childNodes;
        for (i in children) {
            child = children[i];
            if (child.className === this.selectedClassName) {
                return child;
            }
        }
        return null;
    };
    AutoCompleteView.prototype.focusNext = function () {
        var curr, focus;
        curr = this.current();
        focus = curr.nextSibling;
        if (focus) {
            curr.className = '';
            focus.className = this.selectedClassName;
            return this.adjustPosition();
        }
    };
    AutoCompleteView.prototype.focusPrev = function () {
        var curr, focus;
        curr = this.current();
        focus = curr.previousSibling;
        if (focus) {
            curr.className = '';
            focus.className = this.selectedClassName;
            return this.adjustPosition();
        }
    };
    AutoCompleteView.prototype.ensureFocus = function () {
        if (!this.current()) {
            if (this.listElement.firstChild) {
                var firstChild = this.listElement.firstChild;
                firstChild.className = this.selectedClassName;
                return this.adjustPosition();
            }
        }
    };
    AutoCompleteView.prototype.adjustPosition = function () {
        var elm, elmOuterHeight, newMargin, pos, preMargin, wrapHeight;
        elm = this.current();
        if (elm) {
            newMargin = '';
            wrapHeight = $(this.wrap).height();
            elmOuterHeight = $(elm).outerHeight();
            preMargin = parseInt($(this.listElement).css("margin-top").replace('px', ''), 10);
            pos = $(elm).position();
            if (pos.top >= (wrapHeight - elmOuterHeight)) {
                newMargin = (preMargin - elmOuterHeight) + 'px';
                $(this.listElement).css("margin-top", newMargin);
            }
            if (pos.top < 0) {
                newMargin = (-pos.top + preMargin) + 'px';
                return $(this.listElement).css("margin-top", newMargin);
            }
        }
    };
    return AutoCompleteView;
})();
module.exports = AutoCompleteView;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQXV0b0NvbXBsZXRlVmlldy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9tb2RlL3R5cGVzY3JpcHQvQXV0b0NvbXBsZXRlVmlldy50cyJdLCJuYW1lcyI6WyJBdXRvQ29tcGxldGVWaWV3IiwiQXV0b0NvbXBsZXRlVmlldy5jb25zdHJ1Y3RvciIsIkF1dG9Db21wbGV0ZVZpZXcuc2hvdyIsIkF1dG9Db21wbGV0ZVZpZXcuaGlkZSIsIkF1dG9Db21wbGV0ZVZpZXcuc2V0UG9zaXRpb24iLCJBdXRvQ29tcGxldGVWaWV3LmN1cnJlbnQiLCJBdXRvQ29tcGxldGVWaWV3LmZvY3VzTmV4dCIsIkF1dG9Db21wbGV0ZVZpZXcuZm9jdXNQcmV2IiwiQXV0b0NvbXBsZXRlVmlldy5lbnN1cmVGb2N1cyIsIkF1dG9Db21wbGV0ZVZpZXcuYWRqdXN0UG9zaXRpb24iXSwibWFwcGluZ3MiOiJBQUlBLElBQU8sR0FBRyxXQUFXLDZCQUE2QixDQUFDLENBQUM7QUFFcEQsSUFBSSxTQUFTLEdBQUcsa0JBQWtCLENBQUM7QUFDbkMsSUFBSSxrQkFBa0IsR0FBRywyQkFBMkIsQ0FBQztBQUVyRDtJQU9JQSwwQkFBWUEsTUFBY0EsRUFBRUEsWUFBWUE7UUFEaENDLFlBQU9BLEdBQUdBLElBQUlBLEdBQUdBLENBQUNBLFdBQVdBLEVBQUVBLENBQUNBO1FBRXBDQSxFQUFFQSxDQUFDQSxDQUFDQSxPQUFPQSxNQUFNQSxLQUFLQSxXQUFXQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNoQ0EsTUFBTUEsSUFBSUEsS0FBS0EsQ0FBQ0Esd0JBQXdCQSxDQUFDQSxDQUFDQTtRQUM5Q0EsQ0FBQ0E7UUFDREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsT0FBT0EsWUFBWUEsS0FBS0EsV0FBV0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDdENBLE1BQU1BLElBQUlBLEtBQUtBLENBQUNBLDhCQUE4QkEsQ0FBQ0EsQ0FBQ0E7UUFDcERBLENBQUNBO1FBQ0RBLElBQUlBLENBQUNBLE1B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LElBQUlBLENBQUNBLElBQUlBLENBQUNBLENBQUNBLE1BQU1BLEVBQUVBLEdBQUdBLEVBQUVBLENBQUNBLEdBQUdBLElBQUlBLENBQUNBO1lBQ2hFQSxNQUFNQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxLQUFLQSxDQUFDQSxJQUFJQSxHQUFHQSxNQUFNQSxDQUFDQSxLQUFLQSxHQUFHQSxJQUFJQSxDQUFDQTtRQUN0REEsQ0FBQ0E7SUFDTEEsQ0FBQ0E7SUFDREosa0NBQU9BLEdBQVBBO1FBQ0lLLElBQUlBLEtBQUtBLEVBQUVBLFFBQVFBLEVBQUVBLENBQUNBLENBQUNBO1FBQ3ZCQSxRQUFRQSxHQUFHQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxVQUFVQSxDQUFDQTtRQUN2Q0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDakJBLEtBQUtBLEdBQUdBLFFBQVFBLENBQUNBLENBQUNBLENBQUNBLENBQUNBO1lBQ3BCQSxFQUFFQSxDQUFDQSxDQUFDQSxLQUFLQSxDQUFDQSxTQUFTQSxLQUFLQSxJQUFJQSxDQUFDQSxpQkFBaUJBLENBQUNBLENBQUNBLENBQUNBO2dCQUM3Q0EsTUFBTUEsQ0FBQ0EsS0FBS0EsQ0FBQ0E7WUFDakJBLENBQUNBO1FBQ0xBLENBQUNBO1FBQ0RBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBO0lBQ2hCQSxDQUFDQTtJQUNETCxvQ0FBU0EsR0FBVEE7UUFDSU0sSUFBSUEsSUFBSUEsRUFBRUEsS0FBS0EsQ0FBQ0E7UUFDaEJBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBLE9BQU9BLEVBQUVBLENBQUNBO1FBQ3RCQSxLQUFLQSxHQUFHQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQTtRQUN6QkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDUkEsSUFBSUEsQ0FBQ0EsU0FBU0EsR0FBR0EsRUFBRUEsQ0FBQ0E7WUFDcEJBLEtBQUtBLENBQUNBLFNBQVNBLEdBQUdBLElBQUlBLENBQUNBLGlCQUFpQkEsQ0FBQ0E7WUFDekNBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLGNBQWNBLEVBQUVBLENBQUNBO1FBQ2pDQSxDQUFDQTtJQUNMQSxDQUFDQTtJQUNETixvQ0FBU0EsR0FBVEE7UUFDSU8sSUFBSUEsSUFBSUEsRUFBRUEsS0FBS0EsQ0FBQ0E7UUFDaEJBLElBQUlBLEdBQUdBLElBQUlBLENBQUNBLE9BQU9BLEVBQUVBLENBQUNBO1FBQ3RCQSxLQUFLQSxHQUFHQSxJQUFJQSxDQUFDQSxlQUFlQSxDQUFDQTtRQUM3QkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsS0FBS0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDUkEsSUFBSUEsQ0FBQ0EsU0FBU0EsR0FBR0EsRUFBRUEsQ0FBQ0E7WUFDcEJBLEtBQUtBLENBQUNBLFNBQVNBLEdBQUdBLElBQUlBLENBQUNBLGlCQUFpQkEsQ0FBQ0E7WUFDekNBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLGNBQWNBLEVBQUVBLENBQUNBO1FBQ2pDQSxDQUFDQTtJQUNMQSxDQUFDQTtJQUNEUCxzQ0FBV0EsR0FBWEE7UUFDSVEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsT0FBT0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDbEJBLEVBQUVBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLFVBQVVBLENBQUNBLENBQUNBLENBQUNBO2dCQUM5QkEsSUFBSUEsVUFBVUEsR0FBNkJBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLFVBQVVBLENBQUNBO2dCQUN2RUEsVUFBVUEsQ0FBQ0EsU0FBU0EsR0FBR0EsSUFBSUEsQ0FBQ0EsaUJBQWlCQSxDQUFDQTtnQkFDOUNBLE1BQU1BLENBQUNBLElBQUlBLENBQUNBLGNBQWNBLEVBQUVBLENBQUNBO1lBQ2pDQSxDQUFDQTtRQUNMQSxDQUFDQTtJQUNMQSxDQUFDQTtJQUNEUix5Q0FBY0EsR0FBZEE7UUFDSVMsSUFBSUEsR0FBR0EsRUFBRUEsY0FBY0EsRUFBRUEsU0FBU0EsRUFBRUEsR0FBR0EsRUFBRUEsU0FBU0EsRUFBRUEsVUFBVUEsQ0FBQ0E7UUFDL0RBLEdBQUdBLEdBQUdBLElBQUlBLENBQUNBLE9BQU9BLEVBQUVBLENBQUNBO1FBQ3JCQSxFQUFFQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNOQSxTQUFTQSxHQUFHQSxFQUFFQSxDQUFDQTtZQUNmQSxVQUFVQSxHQUFHQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxJQUFJQSxDQUFDQSxDQUFDQSxNQUFNQSxFQUFFQSxDQUFDQTtZQUNuQ0EsY0FBY0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsV0FBV0EsRUFBRUEsQ0FBQ0E7WUFDdENBLFNBQVNBLEdBQUdBLFFBQVFBLENBQUNBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLFlBQVlBLENBQUNBLENBQUNBLE9BQU9BLENBQUNBLElBQUlBLEVBQUVBLEVBQUVBLENBQUNBLEVBQUVBLEVBQUVBLENBQUNBLENBQUNBO1lBQ2xGQSxHQUFHQSxHQUFHQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxDQUFDQSxRQUFRQSxFQUFFQSxDQUFDQTtZQUN4QkEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0EsVUFBVUEsR0FBR0EsY0FBY0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7Z0JBQzNDQSxTQUFTQSxHQUFHQSxDQUFDQSxTQUFTQSxHQUFHQSxjQUFjQSxDQUFDQSxHQUFHQSxJQUFJQSxDQUFDQTtnQkFDaERBLENBQUNBLENBQUNBLElBQUlBLENBQUNBLFdBQVdBLENBQUNBLENBQUNBLEdBQUdBLENBQUNBLFlBQVlBLEVBQUVBLFNBQVNBLENBQUNBLENBQUNBO1lBQ3JEQSxDQUFDQTtZQUNEQSxFQUFFQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxHQUFHQSxHQUFHQSxDQUFDQSxDQUFDQSxDQUFDQSxDQUFDQTtnQkFDZEEsU0FBU0EsR0FBR0EsQ0FBQ0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsR0FBR0EsR0FBR0EsU0FBU0EsQ0FBQ0EsR0FBR0EsSUFBSUEsQ0FBQ0E7Z0JBQzFDQSxNQUFNQSxDQUFDQSxDQUFDQSxDQUFDQSxJQUFJQSxDQUFDQSxXQUFXQSxDQUFDQSxDQUFDQSxHQUFHQSxDQUFDQSxZQUFZQSxFQUFFQSxTQUFTQSxDQUFDQSxDQUFDQTtZQUM1REEsQ0FBQ0E7UUFDTEEsQ0FBQ0E7SUFDTEEsQ0FBQ0E7SUFDTFQsdUJBQUNBO0FBQURBLENBQUNBLEFBN0dELElBNkdDO0FBQ0QsaUJBQVMsZ0JBQWdCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBUT0RPIGltcG9ydCBqcXVlcnlcbmRlY2xhcmUgdmFyICQ6IGFueTtcblxuaW1wb3J0IEVkaXRvciA9IHJlcXVpcmUoJy4uLy4uL0VkaXRvcicpO1xuaW1wb3J0IGhobSA9IHJlcXVpcmUoJy4uLy4uL2tleWJvYXJkL2hhc2hfaGFuZGxlcicpO1xuXG52YXIgQ0xBU1NOQU1FID0gJ2FjZV9hdXRvY29tcGxldGUnO1xudmFyIENMQVNTTkFNRV9TRUxFQ1RFRCA9ICdhY2VfYXV0b2NvbXBsZXRlX3NlbGVjdGVkJztcblxuY2xhc3MgQXV0b0NvbXBsZXRlVmlldyB7XG4gICAgcHJpdmF0ZSBlZGl0b3I6IEVkaXRvcjtcbiAgICBwcml2YXRlIGF1dG9Db21wbGV0ZTtcbiAgICBwcml2YXRlIHNlbGVjdGVkQ2xhc3NOYW1lO1xuICAgIHB1YmxpYyB3cmFwOiBIVE1MRGl2RWxlbWVudDsgICAgLy8gTXVzdCBiZSBhY2Nlc3NpYmxlLlxuICAgIHB1YmxpYyBsaXN0RWxlbWVudDogSFRNTFVMaXN0RWxlbWVudDsgLy8gTXVzdCBiZSBhY2Nlc3NpYmxlLlxuICAgIHByaXZhdGUgaGFuZGxlciA9IG5ldyBoaG0uSGFzaEhhbmRsZXIoKTtcbiAgICBjb25zdHJ1Y3RvcihlZGl0b3I6IEVkaXRvciwgYXV0b0NvbXBsZXRlKSB7XG4gICAgICAgIGlmICh0eXBlb2YgZWRpdG9yID09PSAndW5kZWZpbmVkJykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdlZGl0b3IgbXVzdCBiZSBkZWZpbmVkJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKHR5cGVvZiBhdXRvQ29tcGxldGUgPT09ICd1bmRlZmluZWQnKSB7XG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ2F1dG9Db21wbGV0ZSBtdXN0IGJlIGRlZmluZWQnKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmVkaXRvciA9IGVkaXRvcjtcbiAgICAgICAgdGhpcy5hdXRvQ29tcGxldGUgPSBhdXRvQ29tcGxldGU7XG4gICAgICAgIHRoaXMuc2VsZWN0ZWRDbGFzc05hbWUgPSBDTEFTU05BTUVfU0VMRUNURUQ7XG4gICAgICAgIC8vIGluaXRcbiAgICAgICAgdGhpcy53cmFwID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgIHRoaXMubGlzdEVsZW1lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCd1bCcpO1xuICAgICAgICB0aGlzLndyYXAuY2xhc3NOYW1lID0gQ0xBU1NOQU1FO1xuICAgICAgICB0aGlzLndyYXAuYXBwZW5kQ2hpbGQodGhpcy5saXN0RWxlbWVudCk7XG4gICAgICAgIFxuICAgICAgICB0aGlzLmVkaXRvci5jb250YWluZXIuYXBwZW5kQ2hpbGQodGhpcy53cmFwKTtcblxuICAgICAgICB0aGlzLndyYXAuc3R5bGUuZGlzcGxheSA9ICdub25lJztcbiAgICAgICAgdGhpcy5saXN0RWxlbWVudC5zdHlsZS5saXN0U3R5bGVUeXBlID0gJ25vbmUnO1xuICAgICAgICB0aGlzLndyYXAuc3R5bGUucG9zaXRpb24gPSAnZml4ZWQnO1xuICAgICAgICB0aGlzLndyYXAuc3R5bGUuekluZGV4ID0gJzEwMDAnO1xuICAgIH1cbiAgICBzaG93KGNvb3Jkczoge3BhZ2VYOiBudW1iZXI7IHBhZ2VZOiBudW1iZXJ9KSB7XG4gICAgICAgIHRoaXMuc2V0UG9zaXRpb24oY29vcmRzKTtcbiAgICAgICAgcmV0dXJuIHRoaXMud3JhcC5zdHlsZS5kaXNwbGF5ID0gJ2Jsb2NrJztcbiAgICB9XG4gICAgaGlkZSgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMud3JhcC5zdHlsZS5kaXNwbGF5ID0gJ25vbmUnO1xuICAgIH1cbiAgICBzZXRQb3NpdGlvbihjb29yZHM6IHtwYWdlWDogbnVtYmVyOyBwYWdlWTogbnVtYmVyfSkge1xuICAgICAgICB2YXIgYm90dG9tLCBlZGl0b3JCb3R0b20sIHRvcDtcbiAgICAgICAgdG9wID0gY29vcmRzLnBhZ2VZICsgMjA7XG4gICAgICAgIGVkaXRvckJvdHRvbSA9ICQodGhpcy5lZGl0b3IuY29udGFpbmVyKS5vZmZzZXQoKS50b3AgKyAkKHRoaXMuZWRpdG9yLmNvbnRhaW5lcikuaGVpZ2h0KCk7XG4gICAgICAgIGJvdHRvbSA9IHRvcCArICQodGhpcy53cmFwKS5oZWlnaHQoKTtcbiAgICAgICAgaWYgKGJvdHRvbSA8IGVkaXRvckJvdHRvbSkge1xuICAgICAgICAgICAgdGhpcy53cmFwLnN0eWxlLnRvcCA9IHRvcCArICdweCc7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy53cmFwLnN0eWxlLmxlZnQgPSBjb29yZHMucGFnZVggKyAncHgnO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy53cmFwLnN0eWxlLnRvcCA9ICh0b3AgLSAkKHRoaXMud3JhcCkuaGVpZ2h0KCkgLSAyMCkgKyAncHgnO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMud3JhcC5zdHlsZS5sZWZ0ID0gY29vcmRzLnBhZ2VYICsgJ3B4JztcbiAgICAgICAgfVxuICAgIH1cbiAgICBjdXJyZW50KCkge1xuICAgICAgICB2YXIgY2hpbGQsIGNoaWxkcmVuLCBpO1xuICAgICAgICBjaGlsZHJlbiA9IHRoaXMubGlzdEVsZW1lbnQuY2hpbGROb2RlcztcbiAgICAgICAgZm9yIChpIGluIGNoaWxkcmVuKSB7XG4gICAgICAgICAgICBjaGlsZCA9IGNoaWxkcmVuW2ldO1xuICAgICAgICAgICAgaWYgKGNoaWxkLmNsYXNzTmFtZSA9PT0gdGhpcy5zZWxlY3RlZENsYXNzTmFtZSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBjaGlsZDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgZm9jdXNOZXh0KCkge1xuICAgICAgICB2YXIgY3VyciwgZm9jdXM7XG4gICAgICAgIGN1cnIgPSB0aGlzLmN1cnJlbnQoKTtcbiAgICAgICAgZm9jdXMgPSBjdXJyLm5leHRTaWJsaW5nO1xuICAgICAgICBpZiAoZm9jdXMpIHtcbiAgICAgICAgICAgIGN1cnIuY2xhc3NOYW1lID0gJyc7XG4gICAgICAgICAgICBmb2N1cy5jbGFzc05hbWUgPSB0aGlzLnNlbGVjdGVkQ2xhc3NOYW1lO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRqdXN0UG9zaXRpb24oKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBmb2N1c1ByZXYoKSB7XG4gICAgICAgIHZhciBjdXJyLCBmb2N1cztcbiAgICAgICAgY3VyciA9IHRoaXMuY3VycmVudCgpO1xuICAgICAgICBmb2N1cyA9IGN1cnIucHJldmlvdXNTaWJsaW5nO1xuICAgICAgICBpZiAoZm9jdXMpIHtcbiAgICAgICAgICAgIGN1cnIuY2xhc3NOYW1lID0gJyc7XG4gICAgICAgICAgICBmb2N1cy5jbGFzc05hbWUgPSB0aGlzLnNlbGVjdGVkQ2xhc3NOYW1lO1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuYWRqdXN0UG9zaXRpb24oKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBlbnN1cmVGb2N1cygpIHtcbiAgICAgICAgaWYgKCF0aGlzLmN1cnJlbnQoKSkge1xuICAgICAgICAgICAgaWYgKHRoaXMubGlzdEVsZW1lbnQuZmlyc3RDaGlsZCkge1xuICAgICAgICAgICAgICAgIHZhciBmaXJzdENoaWxkOiBIVE1MRWxlbWVudCA9IDxIVE1MRWxlbWVudD50aGlzLmxpc3RFbGVtZW50LmZpcnN0Q2hpbGQ7XG4gICAgICAgICAgICAgICAgZmlyc3RDaGlsZC5jbGFzc05hbWUgPSB0aGlzLnNlbGVjdGVkQ2xhc3NOYW1lO1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLmFkanVzdFBvc2l0aW9uKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG4gICAgYWRqdXN0UG9zaXRpb24oKSB7XG4gICAgICAgIHZhciBlbG0sIGVsbU91dGVySGVpZ2h0LCBuZXdNYXJnaW4sIHBvcywgcHJlTWFyZ2luLCB3cmFwSGVpZ2h0O1xuICAgICAgICBlbG0gPSB0aGlzLmN1cnJlbnQoKTtcbiAgICAgICAgaWYgKGVsbSkge1xuICAgICAgICAgICAgbmV3TWFyZ2luID0gJyc7XG4gICAgICAgICAgICB3cmFwSGVpZ2h0ID0gJCh0aGlzLndyYXApLmhlaWdodCgpO1xuICAgICAgICAgICAgZWxtT3V0ZXJIZWlnaHQgPSAkKGVsbSkub3V0ZXJIZWlnaHQoKTtcbiAgICAgICAgICAgIHByZU1hcmdpbiA9IHBhcnNlSW50KCQodGhpcy5saXN0RWxlbWVudCkuY3NzKFwibWFyZ2luLXRvcFwiKS5yZXBsYWNlKCdweCcsICcnKSwgMTApO1xuICAgICAgICAgICAgcG9zID0gJChlbG0pLnBvc2l0aW9uKCk7XG4gICAgICAgICAgICBpZiAocG9zLnRvcCA+PSAod3JhcEhlaWdodCAtIGVsbU91dGVySGVpZ2h0KSkge1xuICAgICAgICAgICAgICAgIG5ld01hcmdpbiA9IChwcmVNYXJnaW4gLSBlbG1PdXRlckhlaWdodCkgKyAncHgnO1xuICAgICAgICAgICAgICAgICQodGhpcy5saXN0RWxlbWVudCkuY3NzKFwibWFyZ2luLXRvcFwiLCBuZXdNYXJnaW4pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHBvcy50b3AgPCAwKSB7XG4gICAgICAgICAgICAgICAgbmV3TWFyZ2luID0gKC1wb3MudG9wICsgcHJlTWFyZ2luKSArICdweCc7XG4gICAgICAgICAgICAgICAgcmV0dXJuICQodGhpcy5saXN0RWxlbWVudCkuY3NzKFwibWFyZ2luLXRvcFwiLCBuZXdNYXJnaW4pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxufVxuZXhwb3J0ID0gQXV0b0NvbXBsZXRlVmlldztcbiJdfQ==