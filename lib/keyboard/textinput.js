import { addCommandKeyListener, addListener, capture, preventDefault } from "../lib/event";
import { isChrome, isGecko, isIE, isMac, isOldIE, isTouchPad, isWebKit, isWin } from "../lib/useragent";
import { computedStyle, createElement } from "../lib/dom";
import { delayedCall } from "../lib/lang";
var BROKEN_SETDATA = isChrome < 18;
var USE_IE_MIME_TYPE = isIE;
export default class TextInput {
    constructor(parentNode, host) {
        var text = createElement("textarea");
        text.className = "ace_text-input";
        if (isTouchPad) {
            text.setAttribute("x-palm-disable-auto-cap", 'true');
        }
        text.wrap = "off";
        text['autocorrect'] = "off";
        text['autocapitalize'] = "off";
        text.spellcheck = false;
        text.style.opacity = "0";
        parentNode.insertBefore(text, parentNode.firstChild);
        var PLACEHOLDER = "\x01\x01";
        var copied = false;
        var pasted = false;
        var inComposition = false;
        var tempStyle = '';
        var isSelectionEmpty = true;
        try {
            var isFocused = document.activeElement === text;
        }
        catch (e) { }
        addListener(text, "blur", function () {
            host.onBlur();
            isFocused = false;
        });
        addListener(text, "focus", function () {
            isFocused = true;
            host.onFocus();
            resetSelection();
        });
        this.focus = function () { text.focus(); };
        this.blur = function () { text.blur(); };
        this.isFocused = function () {
            return isFocused;
        };
        var syncSelection = delayedCall(function () {
            isFocused && resetSelection(isSelectionEmpty);
        });
        var syncValue = delayedCall(function () {
            if (!inComposition) {
                text.value = PLACEHOLDER;
                isFocused && resetSelection();
            }
        });
        function resetSelection(isEmpty) {
            if (inComposition)
                return;
            if (inputHandler) {
                selectionStart = 0;
                selectionEnd = isEmpty ? 0 : text.value.length - 1;
            }
            else {
                var selectionStart = isEmpty ? 2 : 1;
                var selectionEnd = 2;
            }
            try {
                text.setSelectionRange(selectionStart, selectionEnd);
            }
            catch (e) { }
        }
        function resetValue() {
            if (inComposition)
                return;
            text.value = PLACEHOLDER;
            if (isWebKit)
                syncValue.schedule();
        }
        isWebKit || host.addEventListener('changeSelection', function () {
            if (host.selection.isEmpty() != isSelectionEmpty) {
                isSelectionEmpty = !isSelectionEmpty;
                syncSelection.schedule();
            }
        });
        resetValue();
        if (isFocused)
            host.onFocus();
        var isAllSelected = function (text) {
            return text.selectionStart === 0 && text.selectionEnd === text.value.length;
        };
        if (!text.setSelectionRange && text.createTextRange) {
            text.setSelectionRange = function (selectionStart, selectionEnd) {
                var range = this.createTextRange();
                range.collapse(true);
                range.moveStart('character', selectionStart);
                range.moveEnd('character', selectionEnd);
                range.select();
            };
            isAllSelected = function (text) {
                try {
                    var range = text.ownerDocument['selection'].createRange();
                }
                catch (e) {
                }
                if (!range || range.parentElement() != text)
                    return false;
                return range.text == text.value;
            };
        }
        if (isOldIE) {
            var inPropertyChange = false;
            var onPropertyChange = function (e) {
                if (inPropertyChange)
                    return;
                var data = text.value;
                if (inComposition || !data || data == PLACEHOLDER)
                    return;
                if (e && data == PLACEHOLDER[0])
                    return syncProperty.schedule();
                sendText(data);
                inPropertyChange = true;
                resetValue();
                inPropertyChange = false;
            };
            var syncProperty = delayedCall(onPropertyChange);
            addListener(text, "propertychange", onPropertyChange);
            var keytable = { 13: 1, 27: 1 };
            addListener(text, "keyup", function (e) {
                if (inComposition && (!text.value || keytable[e.keyCode]))
                    setTimeout(onCompositionEnd, 0);
                if ((text.value.charCodeAt(0) || 0) < 129) {
                    return syncProperty.call();
                }
                inComposition ? onCompositionUpdate() : onCompositionStart();
            });
            addListener(text, "keydown", function (e) {
                syncProperty.schedule(50);
            });
        }
        var onSelect = function (e) {
            if (copied) {
                copied = false;
            }
            else if (isAllSelected(text)) {
                host.selectAll();
                resetSelection();
            }
            else if (inputHandler) {
                resetSelection(host.selection.isEmpty());
            }
        };
        var inputHandler = null;
        this.setInputHandler = function (cb) { inputHandler = cb; };
        this.getInputHandler = function () { return inputHandler; };
        var afterContextMenu = false;
        var sendText = function (data) {
            if (inputHandler) {
                data = inputHandler(data);
                inputHandler = null;
            }
            if (pasted) {
                resetSelection();
                if (data)
                    host.onPaste(data);
                pasted = false;
            }
            else if (data == PLACEHOLDER.charAt(0)) {
                if (afterContextMenu)
                    host.execCommand("del", { source: "ace" });
                else
                    host.execCommand("backspace", { source: "ace" });
            }
            else {
                if (data.substring(0, 2) == PLACEHOLDER)
                    data = data.substr(2);
                else if (data.charAt(0) == PLACEHOLDER.charAt(0))
                    data = data.substr(1);
                else if (data.charAt(data.length - 1) == PLACEHOLDER.charAt(0))
                    data = data.slice(0, -1);
                if (data.charAt(data.length - 1) == PLACEHOLDER.charAt(0))
                    data = data.slice(0, -1);
                if (data)
                    host.onTextInput(data);
            }
            if (afterContextMenu)
                afterContextMenu = false;
        };
        var onInput = function (e) {
            if (inComposition)
                return;
            var data = text.value;
            sendText(data);
            resetValue();
        };
        var handleClipboardData = function (e, data) {
            var clipboardData = e.clipboardData || window['clipboardData'];
            if (!clipboardData || BROKEN_SETDATA)
                return;
            var mime = USE_IE_MIME_TYPE ? "Text" : "text/plain";
            if (data) {
                return clipboardData.setData(mime, data) !== false;
            }
            else {
                return clipboardData.getData(mime);
            }
        };
        var doCopy = function (e, isCut) {
            var data = host.getCopyText();
            if (!data)
                return preventDefault(e);
            if (handleClipboardData(e, data)) {
                isCut ? host.onCut() : host.onCopy();
                preventDefault(e);
            }
            else {
                copied = true;
                text.value = data;
                text.select();
                setTimeout(function () {
                    copied = false;
                    resetValue();
                    resetSelection();
                    isCut ? host.onCut() : host.onCopy();
                });
            }
        };
        var onCut = function (e) {
            doCopy(e, true);
        };
        var onCopy = function (e) {
            doCopy(e, false);
        };
        var onPaste = function (e) {
            var data = handleClipboardData(e);
            if (typeof data === "string") {
                if (data)
                    host.onPaste(data);
                if (isIE)
                    setTimeout(resetSelection);
                preventDefault(e);
            }
            else {
                text.value = "";
                pasted = true;
            }
        };
        addCommandKeyListener(text, host.onCommandKey.bind(host));
        addListener(text, "select", onSelect);
        addListener(text, "input", onInput);
        addListener(text, "cut", onCut);
        addListener(text, "copy", onCopy);
        addListener(text, "paste", onPaste);
        if (!('oncut' in text) || !('oncopy' in text) || !('onpaste' in text)) {
            addListener(parentNode, "keydown", function (e) {
                if ((isMac && !e.metaKey) || !e.ctrlKey)
                    return;
                switch (e.keyCode) {
                    case 67:
                        onCopy(e);
                        break;
                    case 86:
                        onPaste(e);
                        break;
                    case 88:
                        onCut(e);
                        break;
                }
            });
        }
        var onCompositionStart = function () {
            if (inComposition || !host.onCompositionStart || host.$readOnly)
                return;
            inComposition = {};
            host.onCompositionStart();
            setTimeout(onCompositionUpdate, 0);
            host.on("mousedown", onCompositionEnd);
            if (!host.selection.isEmpty()) {
                host.insert("");
                host.session.markUndoGroup();
                host.selection.clearSelection();
            }
            host.session.markUndoGroup();
        };
        var onCompositionUpdate = function () {
            if (!inComposition || !host.onCompositionUpdate || host.$readOnly)
                return;
            var val = text.value.replace(/\x01/g, "");
            if (inComposition.lastValue === val)
                return;
            host.onCompositionUpdate(val);
            if (inComposition.lastValue)
                host.undo();
            inComposition.lastValue = val;
            if (inComposition.lastValue) {
                var r = host.selection.getRange();
                host.insert(inComposition.lastValue);
                host.session.markUndoGroup();
                inComposition.range = host.selection.getRange();
                host.selection.setRange(r);
                host.selection.clearSelection();
            }
        };
        var onCompositionEnd = function (e) {
            if (!host.onCompositionEnd || host.$readOnly)
                return;
            var c = inComposition;
            inComposition = false;
            var timer = setTimeout(function () {
                timer = null;
                var str = text.value.replace(/\x01/g, "");
                if (inComposition)
                    return;
                else if (str == c.lastValue)
                    resetValue();
                else if (!c.lastValue && str) {
                    resetValue();
                    sendText(str);
                }
            });
            inputHandler = function compositionInputHandler(str) {
                if (timer)
                    clearTimeout(timer);
                str = str.replace(/\x01/g, "");
                if (str == c.lastValue)
                    return "";
                if (c.lastValue && timer)
                    host.undo();
                return str;
            };
            host.onCompositionEnd();
            host.removeListener("mousedown", onCompositionEnd);
            if (e.type == "compositionend" && c.range) {
                host.selection.setRange(c.range);
            }
        };
        var syncComposition = delayedCall(onCompositionUpdate, 50);
        addListener(text, "compositionstart", onCompositionStart);
        if (isGecko) {
            addListener(text, "text", function () { syncComposition.schedule(); });
        }
        else {
            addListener(text, "keyup", function () { syncComposition.schedule(); });
            addListener(text, "keydown", function () { syncComposition.schedule(); });
        }
        addListener(text, "compositionend", onCompositionEnd);
        this.getElement = function () {
            return text;
        };
        this.setReadOnly = function (readOnly) {
            text.readOnly = readOnly;
        };
        this.onContextMenu = function (e) {
            afterContextMenu = true;
            resetSelection(host.selection.isEmpty());
            host._emit("nativecontextmenu", { target: host, domEvent: e });
            this.moveToMouse(e, true);
        };
        this.moveToMouse = function (e, bringToFront) {
            if (!tempStyle)
                tempStyle = text.style.cssText;
            text.style.cssText = (bringToFront ? "z-index:100000;" : "")
                + "height:" + text.style.height + ";"
                + (isIE ? "opacity:0.1;" : "");
            var rect = host.container.getBoundingClientRect();
            var style = computedStyle(host.container);
            var top = rect.top + (parseInt(style.borderTopWidth) || 0);
            var left = rect.left + (parseInt(rect.borderLeftWidth) || 0);
            var maxTop = rect.bottom - top - text.clientHeight - 2;
            var move = function (e) {
                text.style.left = e.clientX - left - 2 + "px";
                text.style.top = Math.min(e.clientY - top - 2, maxTop) + "px";
            };
            move(e);
            if (e.type != "mousedown")
                return;
            if (host.renderer.$keepTextAreaAtCursor)
                host.renderer.$keepTextAreaAtCursor = null;
            if (isWin)
                capture(host.container, move, onContextMenuClose);
        };
        this.onContextMenuClose = onContextMenuClose;
        function onContextMenuClose() {
            setTimeout(function () {
                if (tempStyle) {
                    text.style.cssText = tempStyle;
                    tempStyle = '';
                }
                if (host.renderer.$keepTextAreaAtCursor == null) {
                    host.renderer.$keepTextAreaAtCursor = true;
                    host.renderer.$moveTextAreaToCursor();
                }
            }, 0);
        }
        var onContextMenu = function (e) {
            host.textInput.onContextMenu(e);
            onContextMenuClose();
        };
        addListener(host.renderer.scroller, "contextmenu", onContextMenu);
        addListener(text, "contextmenu", onContextMenu);
    }
    focus() { }
    ;
    blur() { }
    ;
    isFocused() { }
    ;
    setReadOnly(readOnly) { }
    ;
    onContextMenuClose() { }
    ;
    onContextMenu(e) { }
    ;
    moveToMouse(e, bringToFront) { }
    ;
    setInputHandler(cb) { }
    ;
    getInputHandler() { }
    ;
    getElement() {
    }
    ;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGV4dGlucHV0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2tleWJvYXJkL3RleHRpbnB1dC50cyJdLCJuYW1lcyI6WyJUZXh0SW5wdXQiLCJUZXh0SW5wdXQuY29uc3RydWN0b3IiLCJUZXh0SW5wdXQuY29uc3RydWN0b3IucmVzZXRTZWxlY3Rpb24iLCJUZXh0SW5wdXQuY29uc3RydWN0b3IucmVzZXRWYWx1ZSIsImNvbXBvc2l0aW9uSW5wdXRIYW5kbGVyIiwiVGV4dElucHV0LmNvbnN0cnVjdG9yLm9uQ29udGV4dE1lbnVDbG9zZSIsIlRleHRJbnB1dC5mb2N1cyIsIlRleHRJbnB1dC5ibHVyIiwiVGV4dElucHV0LmlzRm9jdXNlZCIsIlRleHRJbnB1dC5zZXRSZWFkT25seSIsIlRleHRJbnB1dC5vbkNvbnRleHRNZW51Q2xvc2UiLCJUZXh0SW5wdXQub25Db250ZXh0TWVudSIsIlRleHRJbnB1dC5tb3ZlVG9Nb3VzZSIsIlRleHRJbnB1dC5zZXRJbnB1dEhhbmRsZXIiLCJUZXh0SW5wdXQuZ2V0SW5wdXRIYW5kbGVyIiwiVGV4dElucHV0LmdldEVsZW1lbnQiXSwibWFwcGluZ3MiOiJPQThCTyxFQUFFLHFCQUFxQixFQUFFLFdBQVcsRUFBRSxPQUFPLEVBQUUsY0FBYyxFQUFFLE1BQU0sY0FBYztPQUNuRixFQUFFLFFBQVEsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxPQUFPLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxLQUFLLEVBQUUsTUFBTSxrQkFBa0I7T0FDaEcsRUFBRSxhQUFhLEVBQUUsYUFBYSxFQUFFLE1BQU0sWUFBWTtPQUNsRCxFQUFFLFdBQVcsRUFBRSxNQUFNLGFBQWE7QUFFekMsSUFBSSxjQUFjLEdBQUcsUUFBUSxHQUFHLEVBQUUsQ0FBQztBQUNuQyxJQUFJLGdCQUFnQixHQUFHLElBQUksQ0FBQztBQUU1QjtJQWFJQSxZQUFZQSxVQUFtQkEsRUFBRUEsSUFBSUE7UUFHakNDLElBQUlB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QSxDQUFDQTtRQUVESixJQUFJQSxhQUFhQSxHQUFHQSxVQUFTQSxDQUFDQTtZQUMxQixJQUFJLENBQUMsU0FBUyxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNoQyxrQkFBa0IsRUFBRSxDQUFDO1FBQ3pCLENBQUMsQ0FBQ0E7UUFDRkEsV0FBV0EsQ0FBQ0EsSUFBSUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsUUFBUUEsRUFBRUEsYUFBYUEsRUFBRUEsYUFBYUEsQ0FBQ0EsQ0FBQ0E7UUFDbEVBLFdBQVdBLENBQUNBLElBQUlBLEVBQUVBLGFBQWFBLEVBQUVBLGFBQWFBLENBQUNBLENBQUNBO0lBQ3BEQSxDQUFDQTtJQWpkREQsS0FBS0EsS0FBS00sQ0FBQ0E7O0lBQ1hOLElBQUlBLEtBQUtPLENBQUNBOztJQUNWUCxTQUFTQSxLQUFLUSxDQUFDQTs7SUFDZlIsV0FBV0EsQ0FBQ0EsUUFBaUJBLElBQUlTLENBQUNBOztJQUNsQ1Qsa0JBQWtCQSxLQUFLVSxDQUFDQTs7SUFDeEJWLGFBQWFBLENBQUNBLENBQUNBLElBQUlXLENBQUNBOztJQUNwQlgsV0FBV0EsQ0FBQ0EsQ0FBQ0EsRUFBRUEsWUFBWUEsSUFBSVksQ0FBQ0E7O0lBQ2hDWixlQUFlQSxDQUFDQSxFQUFFQSxJQUFJYSxDQUFDQTs7SUFDdkJiLGVBQWVBLEtBQUtjLENBQUNBOztJQUNyQmQsVUFBVUE7SUFFVmUsQ0FBQ0E7O0FBdWNMZixDQUFDQTtBQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLyogKioqKiogQkVHSU4gTElDRU5TRSBCTE9DSyAqKioqKlxuICogRGlzdHJpYnV0ZWQgdW5kZXIgdGhlIEJTRCBsaWNlbnNlOlxuICpcbiAqIENvcHlyaWdodCAoYykgMjAxMCwgQWpheC5vcmcgQi5WLlxuICogQWxsIHJpZ2h0cyByZXNlcnZlZC5cbiAqXG4gKiBSZWRpc3RyaWJ1dGlvbiBhbmQgdXNlIGluIHNvdXJjZSBhbmQgYmluYXJ5IGZvcm1zLCB3aXRoIG9yIHdpdGhvdXRcbiAqIG1vZGlmaWNhdGlvbiwgYXJlIHBlcm1pdHRlZCBwcm92aWRlZCB0aGF0IHRoZSBmb2xsb3dpbmcgY29uZGl0aW9ucyBhcmUgbWV0OlxuICogICAgICogUmVkaXN0cmlidXRpb25zIG9mIHNvdXJjZSBjb2RlIG11c3QgcmV0YWluIHRoZSBhYm92ZSBjb3B5cmlnaHRcbiAqICAgICAgIG5vdGljZSwgdGhpcyBsaXN0IG9mIGNvbmRpdGlvbnMgYW5kIHRoZSBmb2xsb3dpbmcgZGlzY2xhaW1lci5cbiAqICAgICAqIFJlZGlzdHJpYnV0aW9ucyBpbiBiaW5hcnkgZm9ybSBtdXN0IHJlcHJvZHVjZSB0aGUgYWJvdmUgY29weXJpZ2h0XG4gKiAgICAgICBub3RpY2UsIHRoaXMgbGlzdCBvZiBjb25kaXRpb25zIGFuZCB0aGUgZm9sbG93aW5nIGRpc2NsYWltZXIgaW4gdGhlXG4gKiAgICAgICBkb2N1bWVudGF0aW9uIGFuZC9vciBvdGhlciBtYXRlcmlhbHMgcHJvdmlkZWQgd2l0aCB0aGUgZGlzdHJpYnV0aW9uLlxuICogICAgICogTmVpdGhlciB0aGUgbmFtZSBvZiBBamF4Lm9yZyBCLlYuIG5vciB0aGVcbiAqICAgICAgIG5hbWVzIG9mIGl0cyBjb250cmlidXRvcnMgbWF5IGJlIHVzZWQgdG8gZW5kb3JzZSBvciBwcm9tb3RlIHByb2R1Y3RzXG4gKiAgICAgICBkZXJpdmVkIGZyb20gdGhpcyBzb2Z0d2FyZSB3aXRob3V0IHNwZWNpZmljIHByaW9yIHdyaXR0ZW4gcGVybWlzc2lvbi5cbiAqXG4gKiBUSElTIFNPRlRXQVJFIElTIFBST1ZJREVEIEJZIFRIRSBDT1BZUklHSFQgSE9MREVSUyBBTkQgQ09OVFJJQlVUT1JTIFwiQVMgSVNcIiBBTkRcbiAqIEFOWSBFWFBSRVNTIE9SIElNUExJRUQgV0FSUkFOVElFUywgSU5DTFVESU5HLCBCVVQgTk9UIExJTUlURUQgVE8sIFRIRSBJTVBMSUVEXG4gKiBXQVJSQU5USUVTIE9GIE1FUkNIQU5UQUJJTElUWSBBTkQgRklUTkVTUyBGT1IgQSBQQVJUSUNVTEFSIFBVUlBPU0UgQVJFXG4gKiBESVNDTEFJTUVELiBJTiBOTyBFVkVOVCBTSEFMTCBBSkFYLk9SRyBCLlYuIEJFIExJQUJMRSBGT1IgQU5ZXG4gKiBESVJFQ1QsIElORElSRUNULCBJTkNJREVOVEFMLCBTUEVDSUFMLCBFWEVNUExBUlksIE9SIENPTlNFUVVFTlRJQUwgREFNQUdFU1xuICogKElOQ0xVRElORywgQlVUIE5PVCBMSU1JVEVEIFRPLCBQUk9DVVJFTUVOVCBPRiBTVUJTVElUVVRFIEdPT0RTIE9SIFNFUlZJQ0VTO1xuICogTE9TUyBPRiBVU0UsIERBVEEsIE9SIFBST0ZJVFM7IE9SIEJVU0lORVNTIElOVEVSUlVQVElPTikgSE9XRVZFUiBDQVVTRUQgQU5EXG4gKiBPTiBBTlkgVEhFT1JZIE9GIExJQUJJTElUWSwgV0hFVEhFUiBJTiBDT05UUkFDVCwgU1RSSUNUIExJQUJJTElUWSwgT1IgVE9SVFxuICogKElOQ0xVRElORyBORUdMSUdFTkNFIE9SIE9USEVSV0lTRSkgQVJJU0lORyBJTiBBTlkgV0FZIE9VVCBPRiBUSEUgVVNFIE9GIFRISVNcbiAqIFNPRlRXQVJFLCBFVkVOIElGIEFEVklTRUQgT0YgVEhFIFBPU1NJQklMSVRZIE9GIFNVQ0ggREFNQUdFLlxuICpcbiAqICoqKioqIEVORCBMSUNFTlNFIEJMT0NLICoqKioqICovXG5cbmltcG9ydCB7IGFkZENvbW1hbmRLZXlMaXN0ZW5lciwgYWRkTGlzdGVuZXIsIGNhcHR1cmUsIHByZXZlbnREZWZhdWx0IH0gZnJvbSBcIi4uL2xpYi9ldmVudFwiXG5pbXBvcnQgeyBpc0Nocm9tZSwgaXNHZWNrbywgaXNJRSwgaXNNYWMsIGlzT2xkSUUsIGlzVG91Y2hQYWQsIGlzV2ViS2l0LCBpc1dpbiB9IGZyb20gXCIuLi9saWIvdXNlcmFnZW50XCJcbmltcG9ydCB7IGNvbXB1dGVkU3R5bGUsIGNyZWF0ZUVsZW1lbnQgfSBmcm9tIFwiLi4vbGliL2RvbVwiXG5pbXBvcnQgeyBkZWxheWVkQ2FsbCB9IGZyb20gXCIuLi9saWIvbGFuZ1wiO1xuXG52YXIgQlJPS0VOX1NFVERBVEEgPSBpc0Nocm9tZSA8IDE4O1xudmFyIFVTRV9JRV9NSU1FX1RZUEUgPSBpc0lFO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBUZXh0SW5wdXQge1xuICAgIGZvY3VzKCkgeyB9O1xuICAgIGJsdXIoKSB7IH07XG4gICAgaXNGb2N1c2VkKCkgeyB9O1xuICAgIHNldFJlYWRPbmx5KHJlYWRPbmx5OiBib29sZWFuKSB7IH07XG4gICAgb25Db250ZXh0TWVudUNsb3NlKCkgeyB9O1xuICAgIG9uQ29udGV4dE1lbnUoZSkgeyB9O1xuICAgIG1vdmVUb01vdXNlKGUsIGJyaW5nVG9Gcm9udCkgeyB9O1xuICAgIHNldElucHV0SGFuZGxlcihjYikgeyB9O1xuICAgIGdldElucHV0SGFuZGxlcigpIHsgfTtcbiAgICBnZXRFbGVtZW50KCkge1xuXG4gICAgfTtcbiAgICBjb25zdHJ1Y3RvcihwYXJlbnROb2RlOiBFbGVtZW50LCBob3N0KSB7XG4gICAgICAgIC8vIEZJWE1FOiBJJ20gc3VyZSB0aGlzIHNodWxkIGJlY29tZSBhIHByb3BlcnR5LlxuICAgICAgICAvLyBEb24ndCBrbm93IHdoeSB3ZSBoYXZlIGFsbCB0aGVzZSBtb25rZXkgcGF0Y2hlZCBtZXRob2RzPyEuXG4gICAgICAgIHZhciB0ZXh0ID0gPEhUTUxUZXh0QXJlYUVsZW1lbnQ+Y3JlYXRlRWxlbWVudChcInRleHRhcmVhXCIpO1xuICAgICAgICB0ZXh0LmNsYXNzTmFtZSA9IFwiYWNlX3RleHQtaW5wdXRcIjtcblxuICAgICAgICBpZiAoaXNUb3VjaFBhZCkge1xuICAgICAgICAgICAgdGV4dC5zZXRBdHRyaWJ1dGUoXCJ4LXBhbG0tZGlzYWJsZS1hdXRvLWNhcFwiLCAndHJ1ZScpO1xuICAgICAgICB9XG5cbiAgICAgICAgdGV4dC53cmFwID0gXCJvZmZcIjtcbiAgICAgICAgdGV4dFsnYXV0b2NvcnJlY3QnXSA9IFwib2ZmXCI7XG4gICAgICAgIHRleHRbJ2F1dG9jYXBpdGFsaXplJ10gPSBcIm9mZlwiO1xuICAgICAgICB0ZXh0LnNwZWxsY2hlY2sgPSBmYWxzZTtcblxuICAgICAgICB0ZXh0LnN0eWxlLm9wYWNpdHkgPSBcIjBcIjtcbiAgICAgICAgcGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUodGV4dCwgcGFyZW50Tm9kZS5maXJzdENoaWxkKTtcblxuICAgICAgICB2YXIgUExBQ0VIT0xERVIgPSBcIlxceDAxXFx4MDFcIjtcblxuICAgICAgICB2YXIgY29waWVkID0gZmFsc2U7XG4gICAgICAgIHZhciBwYXN0ZWQgPSBmYWxzZTtcbiAgICAgICAgdmFyIGluQ29tcG9zaXRpb246IGFueSA9IGZhbHNlO1xuICAgICAgICB2YXIgdGVtcFN0eWxlID0gJyc7XG4gICAgICAgIHZhciBpc1NlbGVjdGlvbkVtcHR5ID0gdHJ1ZTtcblxuICAgICAgICAvLyBGT0NVU1xuICAgICAgICAvLyBpZTkgdGhyb3dzIGVycm9yIGlmIGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgaXMgYWNjZXNzZWQgdG9vIHNvb25cbiAgICAgICAgdHJ5IHsgdmFyIGlzRm9jdXNlZCA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQgPT09IHRleHQ7IH0gY2F0Y2ggKGUpIHsgfVxuXG4gICAgICAgIGFkZExpc3RlbmVyKHRleHQsIFwiYmx1clwiLCBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIGhvc3Qub25CbHVyKCk7XG4gICAgICAgICAgICBpc0ZvY3VzZWQgPSBmYWxzZTtcbiAgICAgICAgfSk7XG4gICAgICAgIGFkZExpc3RlbmVyKHRleHQsIFwiZm9jdXNcIiwgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBpc0ZvY3VzZWQgPSB0cnVlO1xuICAgICAgICAgICAgaG9zdC5vbkZvY3VzKCk7XG4gICAgICAgICAgICByZXNldFNlbGVjdGlvbigpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5mb2N1cyA9IGZ1bmN0aW9uKCkgeyB0ZXh0LmZvY3VzKCk7IH07XG4gICAgICAgIHRoaXMuYmx1ciA9IGZ1bmN0aW9uKCkgeyB0ZXh0LmJsdXIoKTsgfTtcbiAgICAgICAgdGhpcy5pc0ZvY3VzZWQgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHJldHVybiBpc0ZvY3VzZWQ7XG4gICAgICAgIH07XG5cbiAgICAgICAgLy8gbW9kaWZ5aW5nIHNlbGVjdGlvbiBvZiBibHVyZWQgdGV4dGFyZWEgY2FuIGZvY3VzIGl0IChjaHJvbWUgbWFjL2xpbnV4KVxuICAgICAgICB2YXIgc3luY1NlbGVjdGlvbiA9IGRlbGF5ZWRDYWxsKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgaXNGb2N1c2VkICYmIHJlc2V0U2VsZWN0aW9uKGlzU2VsZWN0aW9uRW1wdHkpO1xuICAgICAgICB9KTtcbiAgICAgICAgdmFyIHN5bmNWYWx1ZSA9IGRlbGF5ZWRDYWxsKGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgaWYgKCFpbkNvbXBvc2l0aW9uKSB7XG4gICAgICAgICAgICAgICAgdGV4dC52YWx1ZSA9IFBMQUNFSE9MREVSO1xuICAgICAgICAgICAgICAgIGlzRm9jdXNlZCAmJiByZXNldFNlbGVjdGlvbigpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICBmdW5jdGlvbiByZXNldFNlbGVjdGlvbihpc0VtcHR5PzogYm9vbGVhbikge1xuICAgICAgICAgICAgaWYgKGluQ29tcG9zaXRpb24pXG4gICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgaWYgKGlucHV0SGFuZGxlcikge1xuICAgICAgICAgICAgICAgIHNlbGVjdGlvblN0YXJ0ID0gMDtcbiAgICAgICAgICAgICAgICBzZWxlY3Rpb25FbmQgPSBpc0VtcHR5ID8gMCA6IHRleHQudmFsdWUubGVuZ3RoIC0gMTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgdmFyIHNlbGVjdGlvblN0YXJ0ID0gaXNFbXB0eSA/IDIgOiAxO1xuICAgICAgICAgICAgICAgIHZhciBzZWxlY3Rpb25FbmQgPSAyO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgLy8gb24gZmlyZWZveCB0aGlzIHRocm93cyBpZiB0ZXh0YXJlYSBpcyBoaWRkZW5cbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgICAgdGV4dC5zZXRTZWxlY3Rpb25SYW5nZShzZWxlY3Rpb25TdGFydCwgc2VsZWN0aW9uRW5kKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsgfVxuICAgICAgICB9XG5cbiAgICAgICAgZnVuY3Rpb24gcmVzZXRWYWx1ZSgpIHtcbiAgICAgICAgICAgIGlmIChpbkNvbXBvc2l0aW9uKVxuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIHRleHQudmFsdWUgPSBQTEFDRUhPTERFUjtcbiAgICAgICAgICAgIC8vaHR0cDovL2NvZGUuZ29vZ2xlLmNvbS9wL2Nocm9taXVtL2lzc3Vlcy9kZXRhaWw/aWQ9NzY1MTZcbiAgICAgICAgICAgIGlmIChpc1dlYktpdClcbiAgICAgICAgICAgICAgICBzeW5jVmFsdWUuc2NoZWR1bGUoKTtcbiAgICAgICAgfVxuXG4gICAgICAgIGlzV2ViS2l0IHx8IGhvc3QuYWRkRXZlbnRMaXN0ZW5lcignY2hhbmdlU2VsZWN0aW9uJywgZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICBpZiAoaG9zdC5zZWxlY3Rpb24uaXNFbXB0eSgpICE9IGlzU2VsZWN0aW9uRW1wdHkpIHtcbiAgICAgICAgICAgICAgICBpc1NlbGVjdGlvbkVtcHR5ID0gIWlzU2VsZWN0aW9uRW1wdHk7XG4gICAgICAgICAgICAgICAgc3luY1NlbGVjdGlvbi5zY2hlZHVsZSgpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcblxuICAgICAgICByZXNldFZhbHVlKCk7XG4gICAgICAgIGlmIChpc0ZvY3VzZWQpXG4gICAgICAgICAgICBob3N0Lm9uRm9jdXMoKTtcblxuXG4gICAgICAgIHZhciBpc0FsbFNlbGVjdGVkID0gZnVuY3Rpb24odGV4dCkge1xuICAgICAgICAgICAgcmV0dXJuIHRleHQuc2VsZWN0aW9uU3RhcnQgPT09IDAgJiYgdGV4dC5zZWxlY3Rpb25FbmQgPT09IHRleHQudmFsdWUubGVuZ3RoO1xuICAgICAgICB9O1xuICAgICAgICAvLyBJRTggZG9lcyBub3Qgc3VwcG9ydCBzZXRTZWxlY3Rpb25SYW5nZVxuICAgICAgICBpZiAoIXRleHQuc2V0U2VsZWN0aW9uUmFuZ2UgJiYgdGV4dC5jcmVhdGVUZXh0UmFuZ2UpIHtcbiAgICAgICAgICAgIHRleHQuc2V0U2VsZWN0aW9uUmFuZ2UgPSBmdW5jdGlvbihzZWxlY3Rpb25TdGFydCwgc2VsZWN0aW9uRW5kKSB7XG4gICAgICAgICAgICAgICAgdmFyIHJhbmdlID0gdGhpcy5jcmVhdGVUZXh0UmFuZ2UoKTtcbiAgICAgICAgICAgICAgICByYW5nZS5jb2xsYXBzZSh0cnVlKTtcbiAgICAgICAgICAgICAgICByYW5nZS5tb3ZlU3RhcnQoJ2NoYXJhY3RlcicsIHNlbGVjdGlvblN0YXJ0KTtcbiAgICAgICAgICAgICAgICByYW5nZS5tb3ZlRW5kKCdjaGFyYWN0ZXInLCBzZWxlY3Rpb25FbmQpO1xuICAgICAgICAgICAgICAgIHJhbmdlLnNlbGVjdCgpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGlzQWxsU2VsZWN0ZWQgPSBmdW5jdGlvbih0ZXh0OiBIVE1MVGV4dEFyZWFFbGVtZW50KSB7XG4gICAgICAgICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgICAgICAgICAgdmFyIHJhbmdlID0gdGV4dC5vd25lckRvY3VtZW50WydzZWxlY3Rpb24nXS5jcmVhdGVSYW5nZSgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBjYXRjaCAoZSkge1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBpZiAoIXJhbmdlIHx8IHJhbmdlLnBhcmVudEVsZW1lbnQoKSAhPSB0ZXh0KSByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHJhbmdlLnRleHQgPT0gdGV4dC52YWx1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoaXNPbGRJRSkge1xuICAgICAgICAgICAgdmFyIGluUHJvcGVydHlDaGFuZ2UgPSBmYWxzZTtcbiAgICAgICAgICAgIHZhciBvblByb3BlcnR5Q2hhbmdlID0gZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgICAgIGlmIChpblByb3BlcnR5Q2hhbmdlKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgdmFyIGRhdGEgPSB0ZXh0LnZhbHVlO1xuICAgICAgICAgICAgICAgIGlmIChpbkNvbXBvc2l0aW9uIHx8ICFkYXRhIHx8IGRhdGEgPT0gUExBQ0VIT0xERVIpXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICAvLyBjYW4gaGFwcGVuIGVpdGhlciBhZnRlciBkZWxldGUgb3IgZHVyaW5nIGluc2VydCBvcGVyYXRpb25cbiAgICAgICAgICAgICAgICBpZiAoZSAmJiBkYXRhID09IFBMQUNFSE9MREVSWzBdKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gc3luY1Byb3BlcnR5LnNjaGVkdWxlKCk7XG5cbiAgICAgICAgICAgICAgICBzZW5kVGV4dChkYXRhKTtcbiAgICAgICAgICAgICAgICAvLyBpZTggY2FsbHMgcHJvcGVydHljaGFuZ2UgaGFuZGxlcnMgc3luY2hyb25vdXNseSFcbiAgICAgICAgICAgICAgICBpblByb3BlcnR5Q2hhbmdlID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICByZXNldFZhbHVlKCk7XG4gICAgICAgICAgICAgICAgaW5Qcm9wZXJ0eUNoYW5nZSA9IGZhbHNlO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIHZhciBzeW5jUHJvcGVydHkgPSBkZWxheWVkQ2FsbChvblByb3BlcnR5Q2hhbmdlKTtcbiAgICAgICAgICAgIGFkZExpc3RlbmVyKHRleHQsIFwicHJvcGVydHljaGFuZ2VcIiwgb25Qcm9wZXJ0eUNoYW5nZSk7XG5cbiAgICAgICAgICAgIHZhciBrZXl0YWJsZSA9IHsgMTM6IDEsIDI3OiAxIH07XG4gICAgICAgICAgICBhZGRMaXN0ZW5lcih0ZXh0LCBcImtleXVwXCIsIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoaW5Db21wb3NpdGlvbiAmJiAoIXRleHQudmFsdWUgfHwga2V5dGFibGVbZS5rZXlDb2RlXSkpXG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQob25Db21wb3NpdGlvbkVuZCwgMCk7XG4gICAgICAgICAgICAgICAgaWYgKCh0ZXh0LnZhbHVlLmNoYXJDb2RlQXQoMCkgfHwgMCkgPCAxMjkpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHN5bmNQcm9wZXJ0eS5jYWxsKCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGluQ29tcG9zaXRpb24gPyBvbkNvbXBvc2l0aW9uVXBkYXRlKCkgOiBvbkNvbXBvc2l0aW9uU3RhcnQoKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgLy8gd2hlbiB1c2VyIHByZXNzZXMgYmFja3NwYWNlIGFmdGVyIGZvY3VzaW5nIHRoZSBlZGl0b3IgXG4gICAgICAgICAgICAvLyBwcm9wZXJ0eWNoYW5nZSBpc24ndCBjYWxsZWQgZm9yIHRoZSBuZXh0IGNoYXJhY3RlclxuICAgICAgICAgICAgYWRkTGlzdGVuZXIodGV4dCwgXCJrZXlkb3duXCIsIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgICAgICBzeW5jUHJvcGVydHkuc2NoZWR1bGUoNTApO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuICAgICAgICB2YXIgb25TZWxlY3QgPSBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICBpZiAoY29waWVkKSB7XG4gICAgICAgICAgICAgICAgY29waWVkID0gZmFsc2U7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGlzQWxsU2VsZWN0ZWQodGV4dCkpIHtcbiAgICAgICAgICAgICAgICBob3N0LnNlbGVjdEFsbCgpO1xuICAgICAgICAgICAgICAgIHJlc2V0U2VsZWN0aW9uKCk7XG4gICAgICAgICAgICB9IGVsc2UgaWYgKGlucHV0SGFuZGxlcikge1xuICAgICAgICAgICAgICAgIHJlc2V0U2VsZWN0aW9uKGhvc3Quc2VsZWN0aW9uLmlzRW1wdHkoKSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIGlucHV0SGFuZGxlciA9IG51bGw7XG4gICAgICAgIHRoaXMuc2V0SW5wdXRIYW5kbGVyID0gZnVuY3Rpb24oY2IpIHsgaW5wdXRIYW5kbGVyID0gY2IgfTtcbiAgICAgICAgdGhpcy5nZXRJbnB1dEhhbmRsZXIgPSBmdW5jdGlvbigpIHsgcmV0dXJuIGlucHV0SGFuZGxlciB9O1xuICAgICAgICB2YXIgYWZ0ZXJDb250ZXh0TWVudSA9IGZhbHNlO1xuXG4gICAgICAgIHZhciBzZW5kVGV4dCA9IGZ1bmN0aW9uKGRhdGEpIHtcbiAgICAgICAgICAgIGlmIChpbnB1dEhhbmRsZXIpIHtcbiAgICAgICAgICAgICAgICBkYXRhID0gaW5wdXRIYW5kbGVyKGRhdGEpO1xuICAgICAgICAgICAgICAgIGlucHV0SGFuZGxlciA9IG51bGw7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAocGFzdGVkKSB7XG4gICAgICAgICAgICAgICAgcmVzZXRTZWxlY3Rpb24oKTtcbiAgICAgICAgICAgICAgICBpZiAoZGF0YSlcbiAgICAgICAgICAgICAgICAgICAgaG9zdC5vblBhc3RlKGRhdGEpO1xuICAgICAgICAgICAgICAgIHBhc3RlZCA9IGZhbHNlO1xuICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhID09IFBMQUNFSE9MREVSLmNoYXJBdCgwKSkge1xuICAgICAgICAgICAgICAgIGlmIChhZnRlckNvbnRleHRNZW51KVxuICAgICAgICAgICAgICAgICAgICBob3N0LmV4ZWNDb21tYW5kKFwiZGVsXCIsIHsgc291cmNlOiBcImFjZVwiIH0pO1xuICAgICAgICAgICAgICAgIGVsc2UgLy8gc29tZSB2ZXJzaW9ucyBvZiBhbmRyb2lkIGRvIG5vdCBmaXJlIGtleWRvd24gd2hlbiBwcmVzc2luZyBiYWNrc3BhY2VcbiAgICAgICAgICAgICAgICAgICAgaG9zdC5leGVjQ29tbWFuZChcImJhY2tzcGFjZVwiLCB7IHNvdXJjZTogXCJhY2VcIiB9KTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgICAgaWYgKGRhdGEuc3Vic3RyaW5nKDAsIDIpID09IFBMQUNFSE9MREVSKVxuICAgICAgICAgICAgICAgICAgICBkYXRhID0gZGF0YS5zdWJzdHIoMik7XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoZGF0YS5jaGFyQXQoMCkgPT0gUExBQ0VIT0xERVIuY2hhckF0KDApKVxuICAgICAgICAgICAgICAgICAgICBkYXRhID0gZGF0YS5zdWJzdHIoMSk7XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoZGF0YS5jaGFyQXQoZGF0YS5sZW5ndGggLSAxKSA9PSBQTEFDRUhPTERFUi5jaGFyQXQoMCkpXG4gICAgICAgICAgICAgICAgICAgIGRhdGEgPSBkYXRhLnNsaWNlKDAsIC0xKTtcbiAgICAgICAgICAgICAgICAvLyBjYW4gaGFwcGVuIGlmIHVuZG8gaW4gdGV4dGFyZWEgaXNuJ3Qgc3RvcHBlZFxuICAgICAgICAgICAgICAgIGlmIChkYXRhLmNoYXJBdChkYXRhLmxlbmd0aCAtIDEpID09IFBMQUNFSE9MREVSLmNoYXJBdCgwKSlcbiAgICAgICAgICAgICAgICAgICAgZGF0YSA9IGRhdGEuc2xpY2UoMCwgLTEpO1xuXG4gICAgICAgICAgICAgICAgaWYgKGRhdGEpXG4gICAgICAgICAgICAgICAgICAgIGhvc3Qub25UZXh0SW5wdXQoZGF0YSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoYWZ0ZXJDb250ZXh0TWVudSlcbiAgICAgICAgICAgICAgICBhZnRlckNvbnRleHRNZW51ID0gZmFsc2U7XG4gICAgICAgIH07XG4gICAgICAgIHZhciBvbklucHV0ID0gZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgLy8gY29uc29sZS5sb2coXCJvbklucHV0XCIsIGluQ29tcG9zaXRpb24pXG4gICAgICAgICAgICBpZiAoaW5Db21wb3NpdGlvbilcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICB2YXIgZGF0YSA9IHRleHQudmFsdWU7XG4gICAgICAgICAgICBzZW5kVGV4dChkYXRhKTtcbiAgICAgICAgICAgIHJlc2V0VmFsdWUoKTtcbiAgICAgICAgfTtcblxuICAgICAgICB2YXIgaGFuZGxlQ2xpcGJvYXJkRGF0YSA9IGZ1bmN0aW9uKGUsIGRhdGE/KSB7XG4gICAgICAgICAgICB2YXIgY2xpcGJvYXJkRGF0YSA9IGUuY2xpcGJvYXJkRGF0YSB8fCB3aW5kb3dbJ2NsaXBib2FyZERhdGEnXTtcbiAgICAgICAgICAgIGlmICghY2xpcGJvYXJkRGF0YSB8fCBCUk9LRU5fU0VUREFUQSlcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAvLyB1c2luZyBcIlRleHRcIiBkb2Vzbid0IHdvcmsgb24gb2xkIHdlYmtpdCBidXQgaWUgbmVlZHMgaXRcbiAgICAgICAgICAgIC8vIFRPRE8gYXJlIHRoZXJlIG90aGVyIGJyb3dzZXJzIHRoYXQgcmVxdWlyZSBcIlRleHRcIj9cbiAgICAgICAgICAgIHZhciBtaW1lID0gVVNFX0lFX01JTUVfVFlQRSA/IFwiVGV4dFwiIDogXCJ0ZXh0L3BsYWluXCI7XG4gICAgICAgICAgICBpZiAoZGF0YSkge1xuICAgICAgICAgICAgICAgIC8vIFNhZmFyaSA1IGhhcyBjbGlwYm9hcmREYXRhIG9iamVjdCwgYnV0IGRvZXMgbm90IGhhbmRsZSBzZXREYXRhKClcbiAgICAgICAgICAgICAgICByZXR1cm4gY2xpcGJvYXJkRGF0YS5zZXREYXRhKG1pbWUsIGRhdGEpICE9PSBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBjbGlwYm9hcmREYXRhLmdldERhdGEobWltZSk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG5cbiAgICAgICAgdmFyIGRvQ29weSA9IGZ1bmN0aW9uKGUsIGlzQ3V0KSB7XG4gICAgICAgICAgICB2YXIgZGF0YSA9IGhvc3QuZ2V0Q29weVRleHQoKTtcbiAgICAgICAgICAgIGlmICghZGF0YSlcbiAgICAgICAgICAgICAgICByZXR1cm4gcHJldmVudERlZmF1bHQoZSk7XG5cbiAgICAgICAgICAgIGlmIChoYW5kbGVDbGlwYm9hcmREYXRhKGUsIGRhdGEpKSB7XG4gICAgICAgICAgICAgICAgaXNDdXQgPyBob3N0Lm9uQ3V0KCkgOiBob3N0Lm9uQ29weSgpO1xuICAgICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0KGUpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBjb3BpZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIHRleHQudmFsdWUgPSBkYXRhO1xuICAgICAgICAgICAgICAgIHRleHQuc2VsZWN0KCk7XG4gICAgICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICAgICAgY29waWVkID0gZmFsc2U7XG4gICAgICAgICAgICAgICAgICAgIHJlc2V0VmFsdWUoKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzZXRTZWxlY3Rpb24oKTtcbiAgICAgICAgICAgICAgICAgICAgaXNDdXQgPyBob3N0Lm9uQ3V0KCkgOiBob3N0Lm9uQ29weSgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIHZhciBvbkN1dCA9IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgIGRvQ29weShlLCB0cnVlKTtcbiAgICAgICAgfTtcblxuICAgICAgICB2YXIgb25Db3B5ID0gZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgZG9Db3B5KGUsIGZhbHNlKTtcbiAgICAgICAgfTtcblxuICAgICAgICB2YXIgb25QYXN0ZSA9IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgIHZhciBkYXRhID0gaGFuZGxlQ2xpcGJvYXJkRGF0YShlKTtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgZGF0YSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgICAgICAgICAgIGlmIChkYXRhKVxuICAgICAgICAgICAgICAgICAgICBob3N0Lm9uUGFzdGUoZGF0YSk7XG4gICAgICAgICAgICAgICAgaWYgKGlzSUUpXG4gICAgICAgICAgICAgICAgICAgIHNldFRpbWVvdXQocmVzZXRTZWxlY3Rpb24pO1xuICAgICAgICAgICAgICAgIHByZXZlbnREZWZhdWx0KGUpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgdGV4dC52YWx1ZSA9IFwiXCI7XG4gICAgICAgICAgICAgICAgcGFzdGVkID0gdHJ1ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuICAgICAgICBhZGRDb21tYW5kS2V5TGlzdGVuZXIodGV4dCwgaG9zdC5vbkNvbW1hbmRLZXkuYmluZChob3N0KSk7XG5cbiAgICAgICAgYWRkTGlzdGVuZXIodGV4dCwgXCJzZWxlY3RcIiwgb25TZWxlY3QpO1xuXG4gICAgICAgIGFkZExpc3RlbmVyKHRleHQsIFwiaW5wdXRcIiwgb25JbnB1dCk7XG5cbiAgICAgICAgYWRkTGlzdGVuZXIodGV4dCwgXCJjdXRcIiwgb25DdXQpO1xuICAgICAgICBhZGRMaXN0ZW5lcih0ZXh0LCBcImNvcHlcIiwgb25Db3B5KTtcbiAgICAgICAgYWRkTGlzdGVuZXIodGV4dCwgXCJwYXN0ZVwiLCBvblBhc3RlKTtcblxuXG4gICAgICAgIC8vIE9wZXJhIGhhcyBubyBjbGlwYm9hcmQgZXZlbnRzXG4gICAgICAgIGlmICghKCdvbmN1dCcgaW4gdGV4dCkgfHwgISgnb25jb3B5JyBpbiB0ZXh0KSB8fCAhKCdvbnBhc3RlJyBpbiB0ZXh0KSkge1xuICAgICAgICAgICAgYWRkTGlzdGVuZXIocGFyZW50Tm9kZSwgXCJrZXlkb3duXCIsIGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgICAgICBpZiAoKGlzTWFjICYmICFlLm1ldGFLZXkpIHx8ICFlLmN0cmxLZXkpXG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICAgICAgICAgIHN3aXRjaCAoZS5rZXlDb2RlKSB7XG4gICAgICAgICAgICAgICAgICAgIGNhc2UgNjc6XG4gICAgICAgICAgICAgICAgICAgICAgICBvbkNvcHkoZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSA4NjpcbiAgICAgICAgICAgICAgICAgICAgICAgIG9uUGFzdGUoZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICBicmVhaztcbiAgICAgICAgICAgICAgICAgICAgY2FzZSA4ODpcbiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ3V0KGUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cblxuXG4gICAgICAgIC8vIENPTVBPU0lUSU9OXG4gICAgICAgIHZhciBvbkNvbXBvc2l0aW9uU3RhcnQgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIGlmIChpbkNvbXBvc2l0aW9uIHx8ICFob3N0Lm9uQ29tcG9zaXRpb25TdGFydCB8fCBob3N0LiRyZWFkT25seSlcbiAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcIm9uQ29tcG9zaXRpb25TdGFydFwiLCBpbkNvbXBvc2l0aW9uKVxuICAgICAgICAgICAgaW5Db21wb3NpdGlvbiA9IHt9O1xuICAgICAgICAgICAgaG9zdC5vbkNvbXBvc2l0aW9uU3RhcnQoKTtcbiAgICAgICAgICAgIHNldFRpbWVvdXQob25Db21wb3NpdGlvblVwZGF0ZSwgMCk7XG4gICAgICAgICAgICBob3N0Lm9uKFwibW91c2Vkb3duXCIsIG9uQ29tcG9zaXRpb25FbmQpO1xuICAgICAgICAgICAgaWYgKCFob3N0LnNlbGVjdGlvbi5pc0VtcHR5KCkpIHtcbiAgICAgICAgICAgICAgICBob3N0Lmluc2VydChcIlwiKTtcbiAgICAgICAgICAgICAgICBob3N0LnNlc3Npb24ubWFya1VuZG9Hcm91cCgpO1xuICAgICAgICAgICAgICAgIGhvc3Quc2VsZWN0aW9uLmNsZWFyU2VsZWN0aW9uKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBob3N0LnNlc3Npb24ubWFya1VuZG9Hcm91cCgpO1xuICAgICAgICB9O1xuXG4gICAgICAgIHZhciBvbkNvbXBvc2l0aW9uVXBkYXRlID0gZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhcIm9uQ29tcG9zaXRpb25VcGRhdGVcIiwgaW5Db21wb3NpdGlvbiAmJiBKU09OLnN0cmluZ2lmeSh0ZXh0LnZhbHVlKSlcbiAgICAgICAgICAgIGlmICghaW5Db21wb3NpdGlvbiB8fCAhaG9zdC5vbkNvbXBvc2l0aW9uVXBkYXRlIHx8IGhvc3QuJHJlYWRPbmx5KVxuICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgIHZhciB2YWwgPSB0ZXh0LnZhbHVlLnJlcGxhY2UoL1xceDAxL2csIFwiXCIpO1xuICAgICAgICAgICAgaWYgKGluQ29tcG9zaXRpb24ubGFzdFZhbHVlID09PSB2YWwpIHJldHVybjtcblxuICAgICAgICAgICAgaG9zdC5vbkNvbXBvc2l0aW9uVXBkYXRlKHZhbCk7XG4gICAgICAgICAgICBpZiAoaW5Db21wb3NpdGlvbi5sYXN0VmFsdWUpXG4gICAgICAgICAgICAgICAgaG9zdC51bmRvKCk7XG4gICAgICAgICAgICBpbkNvbXBvc2l0aW9uLmxhc3RWYWx1ZSA9IHZhbDtcbiAgICAgICAgICAgIGlmIChpbkNvbXBvc2l0aW9uLmxhc3RWYWx1ZSkge1xuICAgICAgICAgICAgICAgIHZhciByID0gaG9zdC5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcbiAgICAgICAgICAgICAgICBob3N0Lmluc2VydChpbkNvbXBvc2l0aW9uLmxhc3RWYWx1ZSk7XG4gICAgICAgICAgICAgICAgaG9zdC5zZXNzaW9uLm1hcmtVbmRvR3JvdXAoKTtcbiAgICAgICAgICAgICAgICBpbkNvbXBvc2l0aW9uLnJhbmdlID0gaG9zdC5zZWxlY3Rpb24uZ2V0UmFuZ2UoKTtcbiAgICAgICAgICAgICAgICBob3N0LnNlbGVjdGlvbi5zZXRSYW5nZShyKTtcbiAgICAgICAgICAgICAgICBob3N0LnNlbGVjdGlvbi5jbGVhclNlbGVjdGlvbigpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIHZhciBvbkNvbXBvc2l0aW9uRW5kID0gZnVuY3Rpb24oZSkge1xuICAgICAgICAgICAgaWYgKCFob3N0Lm9uQ29tcG9zaXRpb25FbmQgfHwgaG9zdC4kcmVhZE9ubHkpIHJldHVybjtcbiAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwib25Db21wb3NpdGlvbkVuZFwiLCBpbkNvbXBvc2l0aW9uICYmaW5Db21wb3NpdGlvbi5sYXN0VmFsdWUpXG4gICAgICAgICAgICB2YXIgYyA9IGluQ29tcG9zaXRpb247XG4gICAgICAgICAgICBpbkNvbXBvc2l0aW9uID0gZmFsc2U7XG4gICAgICAgICAgICB2YXIgdGltZXIgPSBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIHRpbWVyID0gbnVsbDtcbiAgICAgICAgICAgICAgICB2YXIgc3RyID0gdGV4dC52YWx1ZS5yZXBsYWNlKC9cXHgwMS9nLCBcIlwiKTtcbiAgICAgICAgICAgICAgICAvLyBjb25zb2xlLmxvZyhzdHIsIGMubGFzdFZhbHVlKVxuICAgICAgICAgICAgICAgIGlmIChpbkNvbXBvc2l0aW9uKVxuICAgICAgICAgICAgICAgICAgICByZXR1cm47XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoc3RyID09IGMubGFzdFZhbHVlKVxuICAgICAgICAgICAgICAgICAgICByZXNldFZhbHVlKCk7XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAoIWMubGFzdFZhbHVlICYmIHN0cikge1xuICAgICAgICAgICAgICAgICAgICByZXNldFZhbHVlKCk7XG4gICAgICAgICAgICAgICAgICAgIHNlbmRUZXh0KHN0cik7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBpbnB1dEhhbmRsZXIgPSBmdW5jdGlvbiBjb21wb3NpdGlvbklucHV0SGFuZGxlcihzdHI6IHN0cmluZykge1xuICAgICAgICAgICAgICAgIC8vIGNvbnNvbGUubG9nKFwib25Db21wb3NpdGlvbkVuZFwiLCBzdHIsIGMubGFzdFZhbHVlKVxuICAgICAgICAgICAgICAgIGlmICh0aW1lcilcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJUaW1lb3V0KHRpbWVyKTtcbiAgICAgICAgICAgICAgICBzdHIgPSBzdHIucmVwbGFjZSgvXFx4MDEvZywgXCJcIik7XG4gICAgICAgICAgICAgICAgaWYgKHN0ciA9PSBjLmxhc3RWYWx1ZSlcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFwiXCI7XG4gICAgICAgICAgICAgICAgaWYgKGMubGFzdFZhbHVlICYmIHRpbWVyKVxuICAgICAgICAgICAgICAgICAgICBob3N0LnVuZG8oKTtcbiAgICAgICAgICAgICAgICByZXR1cm4gc3RyO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgICAgIGhvc3Qub25Db21wb3NpdGlvbkVuZCgpO1xuICAgICAgICAgICAgaG9zdC5yZW1vdmVMaXN0ZW5lcihcIm1vdXNlZG93blwiLCBvbkNvbXBvc2l0aW9uRW5kKTtcbiAgICAgICAgICAgIGlmIChlLnR5cGUgPT0gXCJjb21wb3NpdGlvbmVuZFwiICYmIGMucmFuZ2UpIHtcbiAgICAgICAgICAgICAgICBob3N0LnNlbGVjdGlvbi5zZXRSYW5nZShjLnJhbmdlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfTtcblxuXG5cbiAgICAgICAgdmFyIHN5bmNDb21wb3NpdGlvbiA9IGRlbGF5ZWRDYWxsKG9uQ29tcG9zaXRpb25VcGRhdGUsIDUwKTtcblxuICAgICAgICBhZGRMaXN0ZW5lcih0ZXh0LCBcImNvbXBvc2l0aW9uc3RhcnRcIiwgb25Db21wb3NpdGlvblN0YXJ0KTtcbiAgICAgICAgaWYgKGlzR2Vja28pIHtcbiAgICAgICAgICAgIGFkZExpc3RlbmVyKHRleHQsIFwidGV4dFwiLCBmdW5jdGlvbigpIHsgc3luY0NvbXBvc2l0aW9uLnNjaGVkdWxlKCkgfSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBhZGRMaXN0ZW5lcih0ZXh0LCBcImtleXVwXCIsIGZ1bmN0aW9uKCkgeyBzeW5jQ29tcG9zaXRpb24uc2NoZWR1bGUoKSB9KTtcbiAgICAgICAgICAgIGFkZExpc3RlbmVyKHRleHQsIFwia2V5ZG93blwiLCBmdW5jdGlvbigpIHsgc3luY0NvbXBvc2l0aW9uLnNjaGVkdWxlKCkgfSk7XG4gICAgICAgIH1cbiAgICAgICAgYWRkTGlzdGVuZXIodGV4dCwgXCJjb21wb3NpdGlvbmVuZFwiLCBvbkNvbXBvc2l0aW9uRW5kKTtcblxuICAgICAgICB0aGlzLmdldEVsZW1lbnQgPSBmdW5jdGlvbigpIHtcbiAgICAgICAgICAgIHJldHVybiB0ZXh0O1xuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMuc2V0UmVhZE9ubHkgPSBmdW5jdGlvbihyZWFkT25seTogYm9vbGVhbikge1xuICAgICAgICAgICAgdGV4dC5yZWFkT25seSA9IHJlYWRPbmx5O1xuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMub25Db250ZXh0TWVudSA9IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgIGFmdGVyQ29udGV4dE1lbnUgPSB0cnVlO1xuICAgICAgICAgICAgcmVzZXRTZWxlY3Rpb24oaG9zdC5zZWxlY3Rpb24uaXNFbXB0eSgpKTtcbiAgICAgICAgICAgIGhvc3QuX2VtaXQoXCJuYXRpdmVjb250ZXh0bWVudVwiLCB7IHRhcmdldDogaG9zdCwgZG9tRXZlbnQ6IGUgfSk7XG4gICAgICAgICAgICB0aGlzLm1vdmVUb01vdXNlKGUsIHRydWUpO1xuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMubW92ZVRvTW91c2UgPSBmdW5jdGlvbihlLCBicmluZ1RvRnJvbnQpIHtcbiAgICAgICAgICAgIGlmICghdGVtcFN0eWxlKVxuICAgICAgICAgICAgICAgIHRlbXBTdHlsZSA9IHRleHQuc3R5bGUuY3NzVGV4dDtcbiAgICAgICAgICAgIHRleHQuc3R5bGUuY3NzVGV4dCA9IChicmluZ1RvRnJvbnQgPyBcInotaW5kZXg6MTAwMDAwO1wiIDogXCJcIilcbiAgICAgICAgICAgICAgICArIFwiaGVpZ2h0OlwiICsgdGV4dC5zdHlsZS5oZWlnaHQgKyBcIjtcIlxuICAgICAgICAgICAgICAgICsgKGlzSUUgPyBcIm9wYWNpdHk6MC4xO1wiIDogXCJcIik7XG5cbiAgICAgICAgICAgIHZhciByZWN0ID0gaG9zdC5jb250YWluZXIuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgICAgICAgICB2YXIgc3R5bGUgPSBjb21wdXRlZFN0eWxlKGhvc3QuY29udGFpbmVyKTtcbiAgICAgICAgICAgIHZhciB0b3AgPSByZWN0LnRvcCArIChwYXJzZUludChzdHlsZS5ib3JkZXJUb3BXaWR0aCkgfHwgMCk7XG4gICAgICAgICAgICB2YXIgbGVmdCA9IHJlY3QubGVmdCArIChwYXJzZUludChyZWN0LmJvcmRlckxlZnRXaWR0aCkgfHwgMCk7XG4gICAgICAgICAgICB2YXIgbWF4VG9wID0gcmVjdC5ib3R0b20gLSB0b3AgLSB0ZXh0LmNsaWVudEhlaWdodCAtIDI7XG4gICAgICAgICAgICB2YXIgbW92ZSA9IGZ1bmN0aW9uKGUpIHtcbiAgICAgICAgICAgICAgICB0ZXh0LnN0eWxlLmxlZnQgPSBlLmNsaWVudFggLSBsZWZ0IC0gMiArIFwicHhcIjtcbiAgICAgICAgICAgICAgICB0ZXh0LnN0eWxlLnRvcCA9IE1hdGgubWluKGUuY2xpZW50WSAtIHRvcCAtIDIsIG1heFRvcCkgKyBcInB4XCI7XG4gICAgICAgICAgICB9O1xuICAgICAgICAgICAgbW92ZShlKTtcblxuICAgICAgICAgICAgaWYgKGUudHlwZSAhPSBcIm1vdXNlZG93blwiKVxuICAgICAgICAgICAgICAgIHJldHVybjtcblxuICAgICAgICAgICAgaWYgKGhvc3QucmVuZGVyZXIuJGtlZXBUZXh0QXJlYUF0Q3Vyc29yKVxuICAgICAgICAgICAgICAgIGhvc3QucmVuZGVyZXIuJGtlZXBUZXh0QXJlYUF0Q3Vyc29yID0gbnVsbDtcblxuICAgICAgICAgICAgLy8gb24gd2luZG93cyBjb250ZXh0IG1lbnUgaXMgb3BlbmVkIGFmdGVyIG1vdXNldXBcbiAgICAgICAgICAgIGlmIChpc1dpbilcbiAgICAgICAgICAgICAgICBjYXB0dXJlKGhvc3QuY29udGFpbmVyLCBtb3ZlLCBvbkNvbnRleHRNZW51Q2xvc2UpO1xuICAgICAgICB9O1xuXG4gICAgICAgIHRoaXMub25Db250ZXh0TWVudUNsb3NlID0gb25Db250ZXh0TWVudUNsb3NlO1xuICAgICAgICBmdW5jdGlvbiBvbkNvbnRleHRNZW51Q2xvc2UoKSB7XG4gICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIGlmICh0ZW1wU3R5bGUpIHtcbiAgICAgICAgICAgICAgICAgICAgdGV4dC5zdHlsZS5jc3NUZXh0ID0gdGVtcFN0eWxlO1xuICAgICAgICAgICAgICAgICAgICB0ZW1wU3R5bGUgPSAnJztcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgaWYgKGhvc3QucmVuZGVyZXIuJGtlZXBUZXh0QXJlYUF0Q3Vyc29yID09IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgaG9zdC5yZW5kZXJlci4ka2VlcFRleHRBcmVhQXRDdXJzb3IgPSB0cnVlO1xuICAgICAgICAgICAgICAgICAgICBob3N0LnJlbmRlcmVyLiRtb3ZlVGV4dEFyZWFUb0N1cnNvcigpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sIDApO1xuICAgICAgICB9XG5cbiAgICAgICAgdmFyIG9uQ29udGV4dE1lbnUgPSBmdW5jdGlvbihlKSB7XG4gICAgICAgICAgICBob3N0LnRleHRJbnB1dC5vbkNvbnRleHRNZW51KGUpO1xuICAgICAgICAgICAgb25Db250ZXh0TWVudUNsb3NlKCk7XG4gICAgICAgIH07XG4gICAgICAgIGFkZExpc3RlbmVyKGhvc3QucmVuZGVyZXIuc2Nyb2xsZXIsIFwiY29udGV4dG1lbnVcIiwgb25Db250ZXh0TWVudSk7XG4gICAgICAgIGFkZExpc3RlbmVyKHRleHQsIFwiY29udGV4dG1lbnVcIiwgb25Db250ZXh0TWVudSk7XG4gICAgfVxufVxuIl19